var s2=Object.defineProperty,o2=Object.defineProperties;var r2=Object.getOwnPropertyDescriptors;var Tp=Object.getOwnPropertySymbols;var a2=Object.prototype.hasOwnProperty,l2=Object.prototype.propertyIsEnumerable;var Ed=(Pe,Ke,bi)=>Ke in Pe?s2(Pe,Ke,{enumerable:!0,configurable:!0,writable:!0,value:bi}):Pe[Ke]=bi,Vt=(Pe,Ke)=>{for(var bi in Ke||(Ke={}))a2.call(Ke,bi)&&Ed(Pe,bi,Ke[bi]);if(Tp)for(var bi of Tp(Ke))l2.call(Ke,bi)&&Ed(Pe,bi,Ke[bi]);return Pe},en=(Pe,Ke)=>o2(Pe,r2(Ke));var r=(Pe,Ke,bi)=>(Ed(Pe,typeof Ke!="symbol"?Ke+"":Ke,bi),bi);var Dt=(Pe,Ke,bi)=>new Promise((Zn,ro)=>{var mc=gs=>{try{ao(bi.next(gs))}catch(Vo){ro(Vo)}},Ba=gs=>{try{ao(bi.throw(gs))}catch(Vo){ro(Vo)}},ao=gs=>gs.done?Zn(gs.value):Promise.resolve(gs.value).then(mc,Ba);ao((bi=bi.apply(Pe,Ke)).next())});(function(){var Km,$m,vr;(function(){function s(R,G,q){return R.call.apply(R.bind,arguments)}function e(R,G,q){if(!R)throw Error();if(2<arguments.length){var $=Array.prototype.slice.call(arguments,2);return function(){var xe=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(xe,$),R.apply(G,xe)}}return function(){return R.apply(G,arguments)}}function t(R,G,q){return t=Function.prototype.bind&&Function.prototype.bind.toString().indexOf("native code")!=-1?s:e,t.apply(null,arguments)}var i=Date.now||function(){return+new Date};function n(R,G){this.a=R,this.m=G||R,this.c=this.m.document}var o=!!window.FontFace;function a(R,G,q,$){if(G=R.c.createElement(G),q)for(var xe in q)q.hasOwnProperty(xe)&&(xe=="style"?G.style.cssText=q[xe]:G.setAttribute(xe,q[xe]));return $&&G.appendChild(R.c.createTextNode($)),G}function l(R,G,q){R=R.c.getElementsByTagName(G)[0],R||(R=document.documentElement),R.insertBefore(q,R.lastChild)}function c(R){R.parentNode&&R.parentNode.removeChild(R)}function h(R,G,q){G=G||[],q=q||[];for(var $=R.className.split(/\s+/),xe=0;xe<G.length;xe+=1){for(var Ne=!1,De=0;De<$.length;De+=1)if(G[xe]===$[De]){Ne=!0;break}Ne||$.push(G[xe])}for(G=[],xe=0;xe<$.length;xe+=1){for(Ne=!1,De=0;De<q.length;De+=1)if($[xe]===q[De]){Ne=!0;break}Ne||G.push($[xe])}R.className=G.join(" ").replace(/\s+/g," ").replace(/^\s+|\s+$/,"")}function d(R,G){for(var q=R.className.split(/\s+/),$=0,xe=q.length;$<xe;$++)if(q[$]==G)return!0;return!1}function u(R){if(typeof R.f=="string")return R.f;var G=R.m.location.protocol;return G=="about:"&&(G=R.a.location.protocol),G=="https:"?"https:":"http:"}function m(R){return R.m.location.hostname||R.a.location.hostname}function g(R,G,q){function $(){Ct&&xe&&Ne&&(Ct(De),Ct=null)}G=a(R,"link",{rel:"stylesheet",href:G,media:"all"});var xe=!1,Ne=!0,De=null,Ct=q||null;o?(G.onload=function(){xe=!0,$()},G.onerror=function(){xe=!0,De=Error("Stylesheet failed to load"),$()}):setTimeout(function(){xe=!0,$()},0),l(R,"head",G)}function b(R,G,q,$){var xe=R.c.getElementsByTagName("head")[0];if(xe){var Ne=a(R,"script",{src:G}),De=!1;return Ne.onload=Ne.onreadystatechange=function(){De||this.readyState&&this.readyState!="loaded"&&this.readyState!="complete"||(De=!0,q&&q(null),Ne.onload=Ne.onreadystatechange=null,Ne.parentNode.tagName=="HEAD"&&xe.removeChild(Ne))},xe.appendChild(Ne),setTimeout(function(){De||(De=!0,q&&q(Error("Script load timeout")))},$||5e3),Ne}return null}function x(){this.a=0,this.c=null}function v(R){return R.a++,function(){R.a--,w(R)}}function E(R,G){R.c=G,w(R)}function w(R){R.a==0&&R.c&&(R.c(),R.c=null)}function C(R){this.a=R||"-"}C.prototype.c=function(R){for(var G=[],q=0;q<arguments.length;q++)G.push(arguments[q].replace(/[\W_]+/g,"").toLowerCase());return G.join(this.a)};function I(R,G){this.c=R,this.f=4,this.a="n";var q=(G||"n4").match(/^([nio])([1-9])$/i);q&&(this.a=q[1],this.f=parseInt(q[2],10))}function O(R){return ie(R)+" "+(R.f+"00")+" 300px "+U(R.c)}function U(R){var G=[];R=R.split(/,\s*/);for(var q=0;q<R.length;q++){var $=R[q].replace(/['"]/g,"");$.indexOf(" ")!=-1||/^\d/.test($)?G.push("'"+$+"'"):G.push($)}return G.join(",")}function z(R){return R.a+R.f}function ie(R){var G="normal";return R.a==="o"?G="oblique":R.a==="i"&&(G="italic"),G}function J(R){var G=4,q="n",$=null;return R&&(($=R.match(/(normal|oblique|italic)/i))&&$[1]&&(q=$[1].substr(0,1).toLowerCase()),($=R.match(/([1-9]00|normal|bold)/i))&&$[1]&&(/bold/i.test($[1])?G=7:/[1-9]00/.test($[1])&&(G=parseInt($[1].substr(0,1),10)))),q+G}function re(R,G){this.c=R,this.f=R.m.document.documentElement,this.h=G,this.a=new C("-"),this.j=G.events!==!1,this.g=G.classes!==!1}function Oe(R){R.g&&h(R.f,[R.a.c("wf","loading")]),Ve(R,"loading")}function We(R){if(R.g){var G=d(R.f,R.a.c("wf","active")),q=[],$=[R.a.c("wf","loading")];G||q.push(R.a.c("wf","inactive")),h(R.f,q,$)}Ve(R,"inactive")}function Ve(R,G,q){R.j&&R.h[G]&&(q?R.h[G](q.c,z(q)):R.h[G]())}function lt(){this.c={}}function k(R,G,q){var $=[],xe;for(xe in G)if(G.hasOwnProperty(xe)){var Ne=R.c[xe];Ne&&$.push(Ne(G[xe],q))}return $}function K(R,G){this.c=R,this.f=G,this.a=a(this.c,"span",{"aria-hidden":"true"},this.f)}function de(R){l(R.c,"body",R.a)}function ce(R){return"display:block;position:absolute;top:-9999px;left:-9999px;font-size:300px;width:auto;height:auto;line-height:normal;margin:0;padding:0;font-variant:normal;white-space:nowrap;font-family:"+U(R.c)+";"+("font-style:"+ie(R)+";font-weight:"+(R.f+"00")+";")}function Te(R,G,q,$,xe,Ne){this.g=R,this.j=G,this.a=$,this.c=q,this.f=xe||3e3,this.h=Ne||void 0}Te.prototype.start=function(){var R=this.c.m.document,G=this,q=i(),$=new Promise(function(Ne,De){function Ct(){i()-q>=G.f?De():R.fonts.load(O(G.a),G.h).then(function(Lt){1<=Lt.length?Ne():setTimeout(Ct,25)},function(){De()})}Ct()}),xe=new Promise(function(Ne,De){setTimeout(De,G.f)});Promise.race([xe,$]).then(function(){G.g(G.a)},function(){G.j(G.a)})};function pe(R,G,q,$,xe,Ne,De){this.v=R,this.B=G,this.c=q,this.a=$,this.s=De||"BESbswy",this.f={},this.w=xe||3e3,this.u=Ne||null,this.o=this.j=this.h=this.g=null,this.g=new K(this.c,this.s),this.h=new K(this.c,this.s),this.j=new K(this.c,this.s),this.o=new K(this.c,this.s),R=new I(this.a.c+",serif",z(this.a)),R=ce(R),this.g.a.style.cssText=R,R=new I(this.a.c+",sans-serif",z(this.a)),R=ce(R),this.h.a.style.cssText=R,R=new I("serif",z(this.a)),R=ce(R),this.j.a.style.cssText=R,R=new I("sans-serif",z(this.a)),R=ce(R),this.o.a.style.cssText=R,de(this.g),de(this.h),de(this.j),de(this.o)}var ye={D:"serif",C:"sans-serif"},Re=null;function he(){if(Re===null){var R=/AppleWebKit\/([0-9]+)(?:\.([0-9]+))/.exec(window.navigator.userAgent);Re=!!R&&(536>parseInt(R[1],10)||parseInt(R[1],10)===536&&11>=parseInt(R[2],10))}return Re}pe.prototype.start=function(){this.f.serif=this.j.a.offsetWidth,this.f["sans-serif"]=this.o.a.offsetWidth,this.A=i(),Xe(this)};function je(R,G,q){for(var $ in ye)if(ye.hasOwnProperty($)&&G===R.f[ye[$]]&&q===R.f[ye[$]])return!0;return!1}function Xe(R){var G=R.g.a.offsetWidth,q=R.h.a.offsetWidth,$;($=G===R.f.serif&&q===R.f["sans-serif"])||($=he()&&je(R,G,q)),$?i()-R.A>=R.w?he()&&je(R,G,q)&&(R.u===null||R.u.hasOwnProperty(R.a.c))?N(R,R.v):N(R,R.B):B(R):N(R,R.v)}function B(R){setTimeout(t(function(){Xe(this)},R),50)}function N(R,G){setTimeout(t(function(){c(this.g.a),c(this.h.a),c(this.j.a),c(this.o.a),G(this.a)},R),0)}function H(R,G,q){this.c=R,this.a=G,this.f=0,this.o=this.j=!1,this.s=q}var X=null;H.prototype.g=function(R){var G=this.a;G.g&&h(G.f,[G.a.c("wf",R.c,z(R).toString(),"active")],[G.a.c("wf",R.c,z(R).toString(),"loading"),G.a.c("wf",R.c,z(R).toString(),"inactive")]),Ve(G,"fontactive",R),this.o=!0,ve(this)},H.prototype.h=function(R){var G=this.a;if(G.g){var q=d(G.f,G.a.c("wf",R.c,z(R).toString(),"active")),$=[],xe=[G.a.c("wf",R.c,z(R).toString(),"loading")];q||$.push(G.a.c("wf",R.c,z(R).toString(),"inactive")),h(G.f,$,xe)}Ve(G,"fontinactive",R),ve(this)};function ve(R){--R.f==0&&R.j&&(R.o?(R=R.a,R.g&&h(R.f,[R.a.c("wf","active")],[R.a.c("wf","loading"),R.a.c("wf","inactive")]),Ve(R,"active")):We(R.a))}function we(R){this.j=R,this.a=new lt,this.h=0,this.f=this.g=!0}we.prototype.load=function(R){this.c=new n(this.j,R.context||this.j),this.g=R.events!==!1,this.f=R.classes!==!1,Le(this,new re(this.c,R),R)};function ze(R,G,q,$,xe){var Ne=--R.h==0;(R.f||R.g)&&setTimeout(function(){var De=xe||null,Ct=$||null||{};if(q.length===0&&Ne)We(G.a);else{G.f+=q.length,Ne&&(G.j=Ne);var Lt,li=[];for(Lt=0;Lt<q.length;Lt++){var Xt=q[Lt],pi=Ct[Xt.c],gn=G.a,zs=Xt;gn.g&&h(gn.f,[gn.a.c("wf",zs.c,z(zs).toString(),"loading")]),Ve(gn,"fontloading",zs),gn=null,X===null&&(X=window.FontFace?(zs=/Gecko.*Firefox\/(\d+)/.exec(window.navigator.userAgent))?42<parseInt(zs[1],10):!0:!1),X?gn=new Te(t(G.g,G),t(G.h,G),G.c,Xt,G.s,pi):gn=new pe(t(G.g,G),t(G.h,G),G.c,Xt,G.s,De,pi),li.push(gn)}for(Lt=0;Lt<li.length;Lt++)li[Lt].start()}},0)}function Le(R,G,q){var xe=[],$=q.timeout;Oe(G);var xe=k(R.a,q,R.c),Ne=new H(R.c,G,$);for(R.h=xe.length,G=0,q=xe.length;G<q;G++)xe[G].load(function(De,Ct,Lt){ze(R,Ne,De,Ct,Lt)})}function _e(R,G){this.c=R,this.a=G}function Ge(R,G,q){var $=u(R.c);return R=(R.a.api||"fast.fonts.net/jsapi").replace(/^.*http(s?):(\/\/)?/,""),$+"//"+R+"/"+G+".js"+(q?"?v="+q:"")}_e.prototype.load=function(R){function G(){if(Ne["__mti_fntLst"+$]){var De=Ne["__mti_fntLst"+$](),Ct=[],Lt;if(De)for(var li=0;li<De.length;li++){var Xt=De[li].fontfamily;De[li].fontStyle!=null&&De[li].fontWeight!=null?(Lt=De[li].fontStyle+De[li].fontWeight,Ct.push(new I(Xt,Lt))):Ct.push(new I(Xt))}R(Ct)}else setTimeout(function(){G()},50)}var q=this,$=q.a.projectId,xe=q.a.version;if($){var Ne=q.c.m;b(this.c,Ge(q,$,xe),function(De){De?R([]):(Ne["__MonotypeConfiguration__"+$]=function(){return q.a},G())}).id="__MonotypeAPIScript__"+$}else R([])};function ne(R,G){this.c=R,this.a=G}ne.prototype.load=function(R){var G,q,$=this.a.urls||[],xe=this.a.families||[],Ne=this.a.testStrings||{},De=new x;for(G=0,q=$.length;G<q;G++)g(this.c,$[G],v(De));var Ct=[];for(G=0,q=xe.length;G<q;G++)if($=xe[G].split(":"),$[1])for(var Lt=$[1].split(","),li=0;li<Lt.length;li+=1)Ct.push(new I($[0],Lt[li]));else Ct.push(new I($[0]));E(De,function(){R(Ct,Ne)})};function ue(R,G,q){R?this.c=R:this.c=G+Ue,this.a=[],this.f=[],this.g=q||""}var Ue="//fonts.googleapis.com/css";function et(R,G){for(var q=G.length,$=0;$<q;$++){var xe=G[$].split(":");xe.length==3&&R.f.push(xe.pop());var Ne="";xe.length==2&&xe[1]!=""&&(Ne=":"),R.a.push(xe.join(Ne))}}function ot(R){if(R.a.length==0)throw Error("No fonts to load!");if(R.c.indexOf("kit=")!=-1)return R.c;for(var G=R.a.length,q=[],$=0;$<G;$++)q.push(R.a[$].replace(/ /g,"+"));return G=R.c+"?family="+q.join("%7C"),0<R.f.length&&(G+="&subset="+R.f.join(",")),0<R.g.length&&(G+="&text="+encodeURIComponent(R.g)),G}function Tt(R){this.f=R,this.a=[],this.c={}}var ct={latin:"BESbswy","latin-ext":"çöüğş",cyrillic:"йяЖ",greek:"αβΣ",khmer:"កខគ",Hanuman:"កខគ"},L={thin:"1",extralight:"2","extra-light":"2",ultralight:"2","ultra-light":"2",light:"3",regular:"4",book:"4",medium:"5","semi-bold":"6",semibold:"6","demi-bold":"6",demibold:"6",bold:"7","extra-bold":"8",extrabold:"8","ultra-bold":"8",ultrabold:"8",black:"9",heavy:"9",l:"3",r:"4",b:"7"},te={i:"i",italic:"i",n:"n",normal:"n"},Fe=/^(thin|(?:(?:extra|ultra)-?)?light|regular|book|medium|(?:(?:semi|demi|extra|ultra)-?)?bold|black|heavy|l|r|b|[1-9]00)?(n|i|normal|italic)?$/;function xt(R){for(var G=R.f.length,q=0;q<G;q++){var $=R.f[q].split(":"),xe=$[0].replace(/\+/g," "),Ne=["n4"];if(2<=$.length){var De,Ct=$[1];if(De=[],Ct)for(var Ct=Ct.split(","),Lt=Ct.length,li=0;li<Lt;li++){var Xt;if(Xt=Ct[li],Xt.match(/^[\w-]+$/)){var pi=Fe.exec(Xt.toLowerCase());if(pi==null)Xt="";else{if(Xt=pi[2],Xt=Xt==null||Xt==""?"n":te[Xt],pi=pi[1],pi==null||pi=="")pi="4";else var gn=L[pi],pi=gn||(isNaN(pi)?"4":pi.substr(0,1));Xt=[Xt,pi].join("")}}else Xt="";Xt&&De.push(Xt)}0<De.length&&(Ne=De),$.length==3&&($=$[2],De=[],$=$?$.split(","):De,0<$.length&&($=ct[$[0]])&&(R.c[xe]=$))}for(R.c[xe]||($=ct[xe])&&(R.c[xe]=$),$=0;$<Ne.length;$+=1)R.a.push(new I(xe,Ne[$]))}}function Ut(R,G){this.c=R,this.a=G}var pt={Arimo:!0,Cousine:!0,Tinos:!0};Ut.prototype.load=function(R){var G=new x,q=this.c,$=new ue(this.a.api,u(q),this.a.text),xe=this.a.families;et($,xe);var Ne=new Tt(xe);xt(Ne),g(q,ot($),v(G)),E(G,function(){R(Ne.a,Ne.c,pt)})};function Ri(R,G){this.c=R,this.a=G}Ri.prototype.load=function(R){var G=this.a.id,q=this.c.m;G?b(this.c,(this.a.api||"https://use.typekit.net")+"/"+G+".js",function($){if($)R([]);else if(q.Typekit&&q.Typekit.config&&q.Typekit.config.fn){$=q.Typekit.config.fn;for(var xe=[],Ne=0;Ne<$.length;Ne+=2)for(var De=$[Ne],Ct=$[Ne+1],Lt=0;Lt<Ct.length;Lt++)xe.push(new I(De,Ct[Lt]));try{q.Typekit.load({events:!1,classes:!1,async:!0})}catch(li){}R(xe)}},2e3):R([])};function mi(R,G){this.c=R,this.f=G,this.a=[]}mi.prototype.load=function(R){var G=this.f.id,q=this.c.m,$=this;G?(q.__webfontfontdeckmodule__||(q.__webfontfontdeckmodule__={}),q.__webfontfontdeckmodule__[G]=function(xe,Ne){for(var De=0,Ct=Ne.fonts.length;De<Ct;++De){var Lt=Ne.fonts[De];$.a.push(new I(Lt.name,J("font-weight:"+Lt.weight+";font-style:"+Lt.style)))}R($.a)},b(this.c,u(this.c)+(this.f.api||"//f.fontdeck.com/s/css/js/")+m(this.c)+"/"+G+".js",function(xe){xe&&R([])})):R([])};var si=new we(window);si.a.c.custom=function(R,G){return new ne(G,R)},si.a.c.fontdeck=function(R,G){return new mi(G,R)},si.a.c.monotype=function(R,G){return new _e(G,R)},si.a.c.typekit=function(R,G){return new Ri(G,R)},si.a.c.google=function(R,G){return new Ut(G,R)};var vt={load:t(si.load,si)};typeof define=="function"&&define.amd?define(function(){return vt}):typeof module!="undefined"&&module.exports?module.exports=vt:(window.WebFont=vt,window.WebFontConfig&&si.load(window.WebFontConfig))})();/**
 * @license
 * webxr-polyfill
 * Copyright (c) 2017 Google
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *//**
 * @license
 * cardboard-vr-display
 * Copyright (c) 2015-2017 Google
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *//**
 * @license
 * webvr-polyfill-dpdb 
 * Copyright (c) 2017 Google
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *//**
 * @license
 * wglu-preserve-state
 * Copyright (c) 2016, Brandon Jones.
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 *//**
 * @license
 * nosleep.js
 * Copyright (c) 2017, Rich Tibbett
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */(function(s,e){typeof exports=="object"&&typeof module!="undefined"?module.exports=e():typeof define=="function"&&define.amd?define(e):s.WebXRPolyfill=e()})(this,function(){"use strict";const s=typeof global!="undefined"?global:typeof self!="undefined"?self:typeof window!="undefined"?window:{},e=Symbol("@@webxr-polyfill/EventTarget");class t{constructor(){this[e]={listeners:new Map}}addEventListener(f,T){if(typeof f!="string")throw new Error("`type` must be a string");if(typeof T!="function")throw new Error("`listener` must be a function");const P=this[e].listeners.get(f)||[];P.push(T),this[e].listeners.set(f,P)}removeEventListener(f,T){if(typeof f!="string")throw new Error("`type` must be a string");if(typeof T!="function")throw new Error("`listener` must be a function");const P=this[e].listeners.get(f)||[];for(let V=P.length;V>=0;V--)P[V]===T&&P.pop()}dispatchEvent(f,T){const P=this[e].listeners.get(f)||[],V=[];for(let Y=0;Y<P.length;Y++)V[Y]=P[Y];for(let Y of V)Y(T);typeof this[`on${f}`]=="function"&&this[`on${f}`](T)}}const i=1e-6;let n=typeof Float32Array!="undefined"?Float32Array:Array;const o=Math.PI/180;function a(){let y=new n(16);return n!=Float32Array&&(y[1]=0,y[2]=0,y[3]=0,y[4]=0,y[6]=0,y[7]=0,y[8]=0,y[9]=0,y[11]=0,y[12]=0,y[13]=0,y[14]=0),y[0]=1,y[5]=1,y[10]=1,y[15]=1,y}function l(y,f){return y[0]=f[0],y[1]=f[1],y[2]=f[2],y[3]=f[3],y[4]=f[4],y[5]=f[5],y[6]=f[6],y[7]=f[7],y[8]=f[8],y[9]=f[9],y[10]=f[10],y[11]=f[11],y[12]=f[12],y[13]=f[13],y[14]=f[14],y[15]=f[15],y}function c(y){return y[0]=1,y[1]=0,y[2]=0,y[3]=0,y[4]=0,y[5]=1,y[6]=0,y[7]=0,y[8]=0,y[9]=0,y[10]=1,y[11]=0,y[12]=0,y[13]=0,y[14]=0,y[15]=1,y}function h(y,f){let T=f[0],P=f[1],V=f[2],Y=f[3],ee=f[4],oe=f[5],Se=f[6],ge=f[7],He=f[8],it=f[9],Ft=f[10],kt=f[11],Zt=f[12],zt=f[13],Ot=f[14],ci=f[15],ki=T*oe-P*ee,bt=T*Se-V*ee,St=T*ge-Y*ee,It=P*Se-V*oe,_t=P*ge-Y*oe,Kn=V*ge-Y*Se,io=He*zt-it*Zt,no=He*Ot-Ft*Zt,Oo=He*ci-kt*Zt,Vs=it*Ot-Ft*zt,so=it*ci-kt*zt,Gs=Ft*ci-kt*Ot,_i=ki*Gs-bt*so+St*Vs+It*Oo-_t*no+Kn*io;return _i?(_i=1/_i,y[0]=(oe*Gs-Se*so+ge*Vs)*_i,y[1]=(V*so-P*Gs-Y*Vs)*_i,y[2]=(zt*Kn-Ot*_t+ci*It)*_i,y[3]=(Ft*_t-it*Kn-kt*It)*_i,y[4]=(Se*Oo-ee*Gs-ge*no)*_i,y[5]=(T*Gs-V*Oo+Y*no)*_i,y[6]=(Ot*St-Zt*Kn-ci*bt)*_i,y[7]=(He*Kn-Ft*St+kt*bt)*_i,y[8]=(ee*so-oe*Oo+ge*io)*_i,y[9]=(P*Oo-T*so-Y*io)*_i,y[10]=(Zt*_t-zt*St+ci*ki)*_i,y[11]=(it*St-He*_t-kt*ki)*_i,y[12]=(oe*no-ee*Vs-Se*io)*_i,y[13]=(T*Vs-P*no+V*io)*_i,y[14]=(zt*bt-Zt*It-Ot*ki)*_i,y[15]=(He*It-it*bt+Ft*ki)*_i,y):null}function d(y,f,T){let P=f[0],V=f[1],Y=f[2],ee=f[3],oe=f[4],Se=f[5],ge=f[6],He=f[7],it=f[8],Ft=f[9],kt=f[10],Zt=f[11],zt=f[12],Ot=f[13],ci=f[14],ki=f[15],bt=T[0],St=T[1],It=T[2],_t=T[3];return y[0]=bt*P+St*oe+It*it+_t*zt,y[1]=bt*V+St*Se+It*Ft+_t*Ot,y[2]=bt*Y+St*ge+It*kt+_t*ci,y[3]=bt*ee+St*He+It*Zt+_t*ki,bt=T[4],St=T[5],It=T[6],_t=T[7],y[4]=bt*P+St*oe+It*it+_t*zt,y[5]=bt*V+St*Se+It*Ft+_t*Ot,y[6]=bt*Y+St*ge+It*kt+_t*ci,y[7]=bt*ee+St*He+It*Zt+_t*ki,bt=T[8],St=T[9],It=T[10],_t=T[11],y[8]=bt*P+St*oe+It*it+_t*zt,y[9]=bt*V+St*Se+It*Ft+_t*Ot,y[10]=bt*Y+St*ge+It*kt+_t*ci,y[11]=bt*ee+St*He+It*Zt+_t*ki,bt=T[12],St=T[13],It=T[14],_t=T[15],y[12]=bt*P+St*oe+It*it+_t*zt,y[13]=bt*V+St*Se+It*Ft+_t*Ot,y[14]=bt*Y+St*ge+It*kt+_t*ci,y[15]=bt*ee+St*He+It*Zt+_t*ki,y}function u(y,f,T){let P=f[0],V=f[1],Y=f[2],ee=f[3],oe=P+P,Se=V+V,ge=Y+Y,He=P*oe,it=P*Se,Ft=P*ge,kt=V*Se,Zt=V*ge,zt=Y*ge,Ot=ee*oe,ci=ee*Se,ki=ee*ge;return y[0]=1-(kt+zt),y[1]=it+ki,y[2]=Ft-ci,y[3]=0,y[4]=it-ki,y[5]=1-(He+zt),y[6]=Zt+Ot,y[7]=0,y[8]=Ft+ci,y[9]=Zt-Ot,y[10]=1-(He+kt),y[11]=0,y[12]=T[0],y[13]=T[1],y[14]=T[2],y[15]=1,y}function m(y,f){return y[0]=f[12],y[1]=f[13],y[2]=f[14],y}function g(y,f){let T=f[0]+f[5]+f[10],P=0;return T>0?(P=Math.sqrt(T+1)*2,y[3]=.25*P,y[0]=(f[6]-f[9])/P,y[1]=(f[8]-f[2])/P,y[2]=(f[1]-f[4])/P):f[0]>f[5]&&f[0]>f[10]?(P=Math.sqrt(1+f[0]-f[5]-f[10])*2,y[3]=(f[6]-f[9])/P,y[0]=.25*P,y[1]=(f[1]+f[4])/P,y[2]=(f[8]+f[2])/P):f[5]>f[10]?(P=Math.sqrt(1+f[5]-f[0]-f[10])*2,y[3]=(f[8]-f[2])/P,y[0]=(f[1]+f[4])/P,y[1]=.25*P,y[2]=(f[6]+f[9])/P):(P=Math.sqrt(1+f[10]-f[0]-f[5])*2,y[3]=(f[1]-f[4])/P,y[0]=(f[8]+f[2])/P,y[1]=(f[6]+f[9])/P,y[2]=.25*P),y}function b(y,f,T,P,V){let Y=1/Math.tan(f/2),ee;return y[0]=Y/T,y[1]=0,y[2]=0,y[3]=0,y[4]=0,y[5]=Y,y[6]=0,y[7]=0,y[8]=0,y[9]=0,y[11]=-1,y[12]=0,y[13]=0,y[15]=0,V!=null&&V!==1/0?(ee=1/(P-V),y[10]=(V+P)*ee,y[14]=2*V*P*ee):(y[10]=-1,y[14]=-2*P),y}function x(){let y=new n(3);return n!=Float32Array&&(y[0]=0,y[1]=0,y[2]=0),y}function v(y){var f=new n(3);return f[0]=y[0],f[1]=y[1],f[2]=y[2],f}function E(y){let f=y[0],T=y[1],P=y[2];return Math.sqrt(f*f+T*T+P*P)}function w(y,f,T){let P=new n(3);return P[0]=y,P[1]=f,P[2]=T,P}function C(y,f){return y[0]=f[0],y[1]=f[1],y[2]=f[2],y}function I(y,f,T){return y[0]=f[0]+T[0],y[1]=f[1]+T[1],y[2]=f[2]+T[2],y}function O(y,f,T){return y[0]=f[0]*T,y[1]=f[1]*T,y[2]=f[2]*T,y}function U(y,f){let T=f[0],P=f[1],V=f[2],Y=T*T+P*P+V*V;return Y>0&&(Y=1/Math.sqrt(Y),y[0]=f[0]*Y,y[1]=f[1]*Y,y[2]=f[2]*Y),y}function z(y,f){return y[0]*f[0]+y[1]*f[1]+y[2]*f[2]}function ie(y,f,T){let P=f[0],V=f[1],Y=f[2],ee=T[0],oe=T[1],Se=T[2];return y[0]=V*Se-Y*oe,y[1]=Y*ee-P*Se,y[2]=P*oe-V*ee,y}function J(y,f,T){let P=T[0],V=T[1],Y=T[2],ee=T[3],oe=f[0],Se=f[1],ge=f[2],He=V*ge-Y*Se,it=Y*oe-P*ge,Ft=P*Se-V*oe,kt=V*Ft-Y*it,Zt=Y*He-P*Ft,zt=P*it-V*He,Ot=ee*2;return He*=Ot,it*=Ot,Ft*=Ot,kt*=2,Zt*=2,zt*=2,y[0]=oe+He+kt,y[1]=Se+it+Zt,y[2]=ge+Ft+zt,y}function re(y,f){let T=w(y[0],y[1],y[2]),P=w(f[0],f[1],f[2]);U(T,T),U(P,P);let V=z(T,P);return V>1?0:V<-1?Math.PI:Math.acos(V)}const Oe=E,We=function(){let y=x();return function(f,T,P,V,Y,ee){let oe,Se;for(T||(T=3),P||(P=0),V?Se=Math.min(V*T+P,f.length):Se=f.length,oe=P;oe<Se;oe+=T)y[0]=f[oe],y[1]=f[oe+1],y[2]=f[oe+2],Y(y,y,ee),f[oe]=y[0],f[oe+1]=y[1],f[oe+2]=y[2];return f}}();function Ve(){let y=new n(9);return n!=Float32Array&&(y[1]=0,y[2]=0,y[3]=0,y[5]=0,y[6]=0,y[7]=0),y[0]=1,y[4]=1,y[8]=1,y}function lt(){let y=new n(4);return n!=Float32Array&&(y[0]=0,y[1]=0,y[2]=0,y[3]=0),y}function k(y){let f=new n(4);return f[0]=y[0],f[1]=y[1],f[2]=y[2],f[3]=y[3],f}function K(y,f,T,P){let V=new n(4);return V[0]=y,V[1]=f,V[2]=T,V[3]=P,V}function de(y,f){return y[0]=f[0],y[1]=f[1],y[2]=f[2],y[3]=f[3],y}function ce(y,f){let T=f[0],P=f[1],V=f[2],Y=f[3],ee=T*T+P*P+V*V+Y*Y;return ee>0&&(ee=1/Math.sqrt(ee),y[0]=T*ee,y[1]=P*ee,y[2]=V*ee,y[3]=Y*ee),y}const Te=function(){let y=lt();return function(f,T,P,V,Y,ee){let oe,Se;for(T||(T=4),P||(P=0),V?Se=Math.min(V*T+P,f.length):Se=f.length,oe=P;oe<Se;oe+=T)y[0]=f[oe],y[1]=f[oe+1],y[2]=f[oe+2],y[3]=f[oe+3],Y(y,y,ee),f[oe]=y[0],f[oe+1]=y[1],f[oe+2]=y[2],f[oe+3]=y[3];return f}}();function pe(){let y=new n(4);return n!=Float32Array&&(y[0]=0,y[1]=0,y[2]=0),y[3]=1,y}function ye(y,f,T){T=T*.5;let P=Math.sin(T);return y[0]=P*f[0],y[1]=P*f[1],y[2]=P*f[2],y[3]=Math.cos(T),y}function Re(y,f,T){let P=f[0],V=f[1],Y=f[2],ee=f[3],oe=T[0],Se=T[1],ge=T[2],He=T[3];return y[0]=P*He+ee*oe+V*ge-Y*Se,y[1]=V*He+ee*Se+Y*oe-P*ge,y[2]=Y*He+ee*ge+P*Se-V*oe,y[3]=ee*He-P*oe-V*Se-Y*ge,y}function he(y,f,T,P){let V=f[0],Y=f[1],ee=f[2],oe=f[3],Se=T[0],ge=T[1],He=T[2],it=T[3],Ft,kt,Zt,zt,Ot;return kt=V*Se+Y*ge+ee*He+oe*it,kt<0&&(kt=-kt,Se=-Se,ge=-ge,He=-He,it=-it),1-kt>i?(Ft=Math.acos(kt),Zt=Math.sin(Ft),zt=Math.sin((1-P)*Ft)/Zt,Ot=Math.sin(P*Ft)/Zt):(zt=1-P,Ot=P),y[0]=zt*V+Ot*Se,y[1]=zt*Y+Ot*ge,y[2]=zt*ee+Ot*He,y[3]=zt*oe+Ot*it,y}function je(y,f){let T=f[0],P=f[1],V=f[2],Y=f[3],ee=T*T+P*P+V*V+Y*Y,oe=ee?1/ee:0;return y[0]=-T*oe,y[1]=-P*oe,y[2]=-V*oe,y[3]=Y*oe,y}function Xe(y,f){let T=f[0]+f[4]+f[8],P;if(T>0)P=Math.sqrt(T+1),y[3]=.5*P,P=.5/P,y[0]=(f[5]-f[7])*P,y[1]=(f[6]-f[2])*P,y[2]=(f[1]-f[3])*P;else{let V=0;f[4]>f[0]&&(V=1),f[8]>f[V*3+V]&&(V=2);let Y=(V+1)%3,ee=(V+2)%3;P=Math.sqrt(f[V*3+V]-f[Y*3+Y]-f[ee*3+ee]+1),y[V]=.5*P,P=.5/P,y[3]=(f[Y*3+ee]-f[ee*3+Y])*P,y[Y]=(f[Y*3+V]+f[V*3+Y])*P,y[ee]=(f[ee*3+V]+f[V*3+ee])*P}return y}function B(y,f,T,P){let V=.5*Math.PI/180;f*=V,T*=V,P*=V;let Y=Math.sin(f),ee=Math.cos(f),oe=Math.sin(T),Se=Math.cos(T),ge=Math.sin(P),He=Math.cos(P);return y[0]=Y*Se*He-ee*oe*ge,y[1]=ee*oe*He+Y*Se*ge,y[2]=ee*Se*ge-Y*oe*He,y[3]=ee*Se*He+Y*oe*ge,y}const N=k,H=K,X=de,ve=ce,we=function(){let y=x(),f=w(1,0,0),T=w(0,1,0);return function(P,V,Y){let ee=z(V,Y);return ee<-.999999?(ie(y,f,V),Oe(y)<1e-6&&ie(y,T,V),U(y,y),ye(P,y,Math.PI),P):ee>.999999?(P[0]=0,P[1]=0,P[2]=0,P[3]=1,P):(ie(y,V,Y),P[0]=y[0],P[1]=y[1],P[2]=y[2],P[3]=1+ee,ve(P,P))}}(),ze=function(){let y=pe(),f=pe();return function(T,P,V,Y,ee,oe){return he(y,P,ee,oe),he(f,V,Y,oe),he(T,y,f,2*oe*(1-oe)),T}}(),Le=function(){let y=Ve();return function(f,T,P,V){return y[0]=P[0],y[3]=P[1],y[6]=P[2],y[1]=V[0],y[4]=V[1],y[7]=V[2],y[2]=-T[0],y[5]=-T[1],y[8]=-T[2],ve(f,Xe(f,y))}}();if(!("DOMPointReadOnly"in window)){const y=Symbol("@@webxr-polyfill/DOMPointReadOnly");window.DOMPointReadOnly=class Sp{constructor(T,P,V,Y){if(arguments.length===1)this[y]={x:T.x,y:T.y,z:T.z,w:T.w};else if(arguments.length===4)this[y]={x:T,y:P,z:V,w:Y};else throw new TypeError("Must supply either 1 or 4 arguments")}get x(){return this[y].x}get y(){return this[y].y}get z(){return this[y].z}get w(){return this[y].w}static fromPoint(T){return new Sp(T.x,T.y,T.z,T.w)}}}const _e=Symbol("@@webxr-polyfill/XRRigidTransform");class Ge{constructor(){if(this[_e]={matrix:null,position:null,orientation:null,inverse:null},arguments.length===0)this[_e].matrix=c(new Float32Array(16));else if(arguments.length===1)arguments[0]instanceof Float32Array?this[_e].matrix=arguments[0]:(this[_e].position=this._getPoint(arguments[0]),this[_e].orientation=DOMPointReadOnly.fromPoint({x:0,y:0,z:0,w:1}));else if(arguments.length===2)this[_e].position=this._getPoint(arguments[0]),this[_e].orientation=this._getPoint(arguments[1]);else throw new Error("Too many arguments!");if(this[_e].matrix){let f=x();m(f,this[_e].matrix),this[_e].position=DOMPointReadOnly.fromPoint({x:f[0],y:f[1],z:f[2]});let T=pe();g(T,this[_e].matrix),this[_e].orientation=DOMPointReadOnly.fromPoint({x:T[0],y:T[1],z:T[2],w:T[3]})}else this[_e].matrix=c(new Float32Array(16)),u(this[_e].matrix,H(this[_e].orientation.x,this[_e].orientation.y,this[_e].orientation.z,this[_e].orientation.w),w(this[_e].position.x,this[_e].position.y,this[_e].position.z))}_getPoint(f){return f instanceof DOMPointReadOnly?f:DOMPointReadOnly.fromPoint(f)}get matrix(){return this[_e].matrix}get position(){return this[_e].position}get orientation(){return this[_e].orientation}get inverse(){if(this[_e].inverse===null){let f=c(new Float32Array(16));h(f,this[_e].matrix),this[_e].inverse=new Ge(f),this[_e].inverse[_e].inverse=this}return this[_e].inverse}}const ne=Symbol("@@webxr-polyfill/XRSpace");class ue{constructor(f=null,T=null){this[ne]={specialType:f,inputSource:T,baseMatrix:null,inverseBaseMatrix:null,lastFrameId:-1}}get _specialType(){return this[ne].specialType}get _inputSource(){return this[ne].inputSource}_ensurePoseUpdated(f,T){T!=this[ne].lastFrameId&&(this[ne].lastFrameId=T,this._onPoseUpdate(f))}_onPoseUpdate(f){this[ne].specialType=="viewer"&&(this._baseMatrix=f.getBasePoseMatrix())}set _baseMatrix(f){this[ne].baseMatrix=f,this[ne].inverseBaseMatrix=null}get _baseMatrix(){return this[ne].baseMatrix||this[ne].inverseBaseMatrix&&(this[ne].baseMatrix=new Float32Array(16),h(this[ne].baseMatrix,this[ne].inverseBaseMatrix)),this[ne].baseMatrix}set _inverseBaseMatrix(f){this[ne].inverseBaseMatrix=f,this[ne].baseMatrix=null}get _inverseBaseMatrix(){return this[ne].inverseBaseMatrix||this[ne].baseMatrix&&(this[ne].inverseBaseMatrix=new Float32Array(16),h(this[ne].inverseBaseMatrix,this[ne].baseMatrix)),this[ne].inverseBaseMatrix}_getSpaceRelativeTransform(f){if(!this._inverseBaseMatrix||!f._baseMatrix)return null;let T=new Float32Array(16);return d(T,this._inverseBaseMatrix,f._baseMatrix),new Ge(T)}}const Ue=1.6,et=Symbol("@@webxr-polyfill/XRReferenceSpace"),ot=["viewer","local","local-floor","bounded-floor","unbounded"];function Tt(y){return y==="bounded-floor"||y==="local-floor"}class ct extends ue{constructor(f,T=null){if(!ot.includes(f))throw new Error(`XRReferenceSpaceType must be one of ${ot}`);if(super(f),f==="bounded-floor"&&!T)throw new Error("XRReferenceSpace cannot use 'bounded-floor' type if the platform does not provide the floor level");Tt(f)&&!T&&(T=c(new Float32Array(16)),T[13]=Ue),this._inverseBaseMatrix=T||c(new Float32Array(16)),this[et]={type:f,transform:T,originOffset:c(new Float32Array(16))}}_transformBasePoseMatrix(f,T){d(f,this._inverseBaseMatrix,T)}_originOffsetMatrix(){return this[et].originOffset}_adjustForOriginOffset(f){let T=new Float32Array(16);h(T,this[et].originOffset),d(f,T,f)}_getSpaceRelativeTransform(f){let T=super._getSpaceRelativeTransform(f);return this._adjustForOriginOffset(T.matrix),new XRRigidTransform(T.matrix)}getOffsetReferenceSpace(f){let T=new ct(this[et].type,this[et].transform,this[et].bounds);return d(T[et].originOffset,this[et].originOffset,f.matrix),T}}const L=Symbol("@@webxr-polyfill/XR"),te=["inline","immersive-vr","immersive-ar"],Fe={inline:{requiredFeatures:["viewer"],optionalFeatures:[]},"immersive-vr":{requiredFeatures:["viewer","local"],optionalFeatures:[]},"immersive-ar":{requiredFeatures:["viewer","local"],optionalFeatures:[]}},xt=`Polyfill Error: Must call navigator.xr.isSessionSupported() with any XRSessionMode
  or navigator.xr.requestSession('inline') prior to requesting an immersive
  session. This is a limitation specific to the WebXR Polyfill and does not apply
  to native implementations of the API.`;class Ut extends t{constructor(f){super(),this[L]={device:null,devicePromise:f,immersiveSession:null,inlineSessions:new Set},f.then(T=>{this[L].device=T})}isSessionSupported(f){return Dt(this,null,function*(){return this[L].device||(yield this[L].devicePromise),f!="inline"?Promise.resolve(this[L].device.isSessionSupported(f)):Promise.resolve(!0)})}requestSession(f,T){return Dt(this,null,function*(){if(!this[L].device){if(f!="inline")throw new Error(xt);yield this[L].devicePromise}if(!te.includes(f))throw new TypeError(`The provided value '${f}' is not a valid enum value of type XRSessionMode`);const P=Fe[f],V=P.requiredFeatures.concat(T&&T.requiredFeatures?T.requiredFeatures:[]),Y=P.optionalFeatures.concat(T&&T.optionalFeatures?T.optionalFeatures:[]),ee=new Set;let oe=!1;for(let it of V)this[L].device.isFeatureSupported(it)?ee.add(it):(console.error(`The required feature '${it}' is not supported`),oe=!0);if(oe)throw new DOMException("Session does not support some required features","NotSupportedError");for(let it of Y)this[L].device.isFeatureSupported(it)?ee.add(it):console.log(`The optional feature '${it}' is not supported`);const Se=yield this[L].device.requestSession(f,ee),ge=new XRSession(this[L].device,f,Se);f=="inline"?this[L].inlineSessions.add(ge):this[L].immersiveSession=ge;const He=()=>{f=="inline"?this[L].inlineSessions.delete(ge):this[L].immersiveSession=null,ge.removeEventListener("end",He)};return ge.addEventListener("end",He),ge})}}let pt;if("performance"in s)pt=()=>performance.now();else{let y=Date.now();pt=()=>Date.now()-y}var Ri=pt;const mi=Symbol("@@webxr-polyfill/XRPose");class si{constructor(f,T){this[mi]={transform:f,emulatedPosition:T}}get transform(){return this[mi].transform}get emulatedPosition(){return this[mi].emulatedPosition}}const vt=Symbol("@@webxr-polyfill/XRViewerPose");class R extends si{constructor(f,T,P=!1){super(f,P),this[vt]={views:T}}get views(){return this[vt].views}}const G=Symbol("@@webxr-polyfill/XRViewport");class q{constructor(f){this[G]={target:f}}get x(){return this[G].target.x}get y(){return this[G].target.y}get width(){return this[G].target.width}get height(){return this[G].target.height}}const $=["left","right","none"],xe=Symbol("@@webxr-polyfill/XRView");class Ne{constructor(f,T,P,V){if(!$.includes(P))throw new Error(`XREye must be one of: ${$}`);const Y=Object.create(null),ee=new q(Y);this[xe]={device:f,eye:P,viewport:ee,temp:Y,sessionId:V,transform:T}}get eye(){return this[xe].eye}get projectionMatrix(){return this[xe].device.getProjectionMatrix(this.eye)}get transform(){return this[xe].transform}_getViewport(f){if(this[xe].device.getViewport(this[xe].sessionId,this.eye,f,this[xe].temp))return this[xe].viewport}}const De=Symbol("@@webxr-polyfill/XRFrame"),Ct="XRFrame access outside the callback that produced it is invalid.",Lt="getViewerPose can only be called on XRFrame objects passed to XRSession.requestAnimationFrame callbacks.";let li=0;class Xt{constructor(f,T,P){this[De]={id:++li,active:!1,animationFrame:!1,device:f,session:T,sessionId:P}}get session(){return this[De].session}getViewerPose(f){if(!this[De].animationFrame)throw new DOMException(Lt,"InvalidStateError");if(!this[De].active)throw new DOMException(Ct,"InvalidStateError");const T=this[De].device,P=this[De].session;P[ae].viewerSpace._ensurePoseUpdated(T,this[De].id),f._ensurePoseUpdated(T,this[De].id);let V=f._getSpaceRelativeTransform(P[ae].viewerSpace);const Y=[];for(let oe of P[ae].viewSpaces){oe._ensurePoseUpdated(T,this[De].id);let Se=f._getSpaceRelativeTransform(oe),ge=new Ne(T,Se,oe.eye,this[De].sessionId);Y.push(ge)}return new R(V,Y,!1)}getPose(f,T){if(!this[De].active)throw new DOMException(Ct,"InvalidStateError");const P=this[De].device;if(f._specialType==="target-ray"||f._specialType==="grip")return P.getInputPose(f._inputSource,T,f._specialType);{f._ensurePoseUpdated(P,this[De].id),T._ensurePoseUpdated(P,this[De].id);let V=T._getSpaceRelativeTransform(f);return V?new XRPose(V,!1):null}}}const pi=Symbol("@@webxr-polyfill/XRRenderState"),gn=Object.freeze({depthNear:.1,depthFar:1e3,inlineVerticalFieldOfView:null,baseLayer:null});class zs{constructor(f={}){const T=Object.assign({},gn,f);this[pi]={config:T}}get depthNear(){return this[pi].config.depthNear}get depthFar(){return this[pi].config.depthFar}get inlineVerticalFieldOfView(){return this[pi].config.inlineVerticalFieldOfView}get baseLayer(){return this[pi].config.baseLayer}}const Zm=Symbol("@@webxr-polyfill/polyfilled-xr-compatible"),rd=Symbol("@@webxr-polyfill/xr-compatible"),Fo=Symbol("@@webxr-polyfill/XRWebGLLayer"),ky=Object.freeze({antialias:!0,depth:!1,stencil:!1,alpha:!0,multiview:!1,ignoreDepthValues:!1,framebufferScaleFactor:1});class zy{constructor(f,T,P={}){const V=Object.assign({},ky,P);if(!(f instanceof ep))throw new Error("session must be a XRSession");if(f.ended)throw new Error("InvalidStateError");if(T[Zm]&&T[rd]!==!0)throw new Error("InvalidStateError");const Y=T.getParameter(T.FRAMEBUFFER_BINDING);this[Fo]={context:T,config:V,framebuffer:Y,session:f}}get context(){return this[Fo].context}get antialias(){return this[Fo].config.antialias}get ignoreDepthValues(){return!0}get framebuffer(){return this[Fo].framebuffer}get framebufferWidth(){return this[Fo].context.drawingBufferWidth}get framebufferHeight(){return this[Fo].context.drawingBufferHeight}get _session(){return this[Fo].session}getViewport(f){return f._getViewport(this)}static getNativeFramebufferScaleFactor(f){if(!f)throw new TypeError("getNativeFramebufferScaleFactor must be passed a session.");return f[ae].ended?0:1}}const ad=Symbol("@@webxr-polyfill/XRInputSourceEvent");function ld(y,f){const T=new Event(y,f);return T[ad]={frame:f.frame,inputSource:f.inputSource},Object.setPrototypeOf(T,ld.prototype),Object.defineProperty(T,"frame",{get(){return this[ad].frame}}),Object.defineProperty(T,"inputSource",{get(){return this[ad].inputSource}}),T}const Jm=Symbol("@@webxr-polyfill/XRSessionEvent");function cc(y,f){const T=new Event(y,f);return T[Jm]={session:f.session},Object.setPrototypeOf(T,cc.prototype),Object.defineProperty(T,"session",{get(){return this[Jm].session}}),T}const hc=Symbol("@@webxr-polyfill/XRInputSourcesChangeEvent");function cd(y,f){const T=new Event(y,f);return T[hc]={session:f.session,added:f.added,removed:f.removed},Object.setPrototypeOf(T,cd.prototype),Object.defineProperty(T,"session",{get(){return this[hc].session}}),Object.defineProperty(T,"added",{get(){return this[hc].added}}),Object.defineProperty(T,"removed",{get(){return this[hc].removed}}),T}const ae=Symbol("@@webxr-polyfill/XRSession");class hd extends ue{constructor(f){super(f)}get eye(){return this._specialType}_onPoseUpdate(f){this._inverseBaseMatrix=f.getBaseViewMatrix(this._specialType)}}class ep extends t{constructor(f,T,P){super();let V=T!="inline",Y=new zs({inlineVerticalFieldOfView:V?null:Math.PI*.5});this[ae]={device:f,mode:T,immersive:V,ended:!1,suspended:!1,frameCallbacks:[],currentFrameCallbacks:null,frameHandle:0,deviceFrameHandle:null,id:P,activeRenderState:Y,pendingRenderState:null,viewerSpace:new ct("viewer"),viewSpaces:[],currentInputSources:[]},V?this[ae].viewSpaces.push(new hd("left"),new hd("right")):this[ae].viewSpaces.push(new hd("none")),this[ae].onDeviceFrame=()=>{if(this[ae].ended||this[ae].suspended||(this[ae].deviceFrameHandle=null,this[ae].startDeviceFrameLoop(),this[ae].pendingRenderState!==null&&(this[ae].activeRenderState=new zs(this[ae].pendingRenderState),this[ae].pendingRenderState=null,this[ae].activeRenderState.baseLayer&&this[ae].device.onBaseLayerSet(this[ae].id,this[ae].activeRenderState.baseLayer)),this[ae].activeRenderState.baseLayer===null))return;const ee=new Xt(f,this,this[ae].id),oe=this[ae].currentFrameCallbacks=this[ae].frameCallbacks;this[ae].frameCallbacks=[],ee[De].active=!0,ee[De].animationFrame=!0,this[ae].device.onFrameStart(this[ae].id,this[ae].activeRenderState),this._checkInputSourcesChange();const Se=Ri();for(let ge=0;ge<oe.length;ge++)try{!oe[ge].cancelled&&typeof oe[ge].callback=="function"&&oe[ge].callback(Se,ee)}catch(He){console.error(He)}this[ae].currentFrameCallbacks=null,ee[De].active=!1,this[ae].device.onFrameEnd(this[ae].id)},this[ae].startDeviceFrameLoop=()=>{this[ae].deviceFrameHandle===null&&(this[ae].deviceFrameHandle=this[ae].device.requestAnimationFrame(this[ae].onDeviceFrame))},this[ae].stopDeviceFrameLoop=()=>{const ee=this[ae].deviceFrameHandle;ee!==null&&(this[ae].device.cancelAnimationFrame(ee),this[ae].deviceFrameHandle=null)},this[ae].onPresentationEnd=ee=>{if(ee!==this[ae].id){this[ae].suspended=!1,this[ae].startDeviceFrameLoop(),this.dispatchEvent("focus",{session:this});return}this[ae].ended=!0,this[ae].stopDeviceFrameLoop(),f.removeEventListener("@@webxr-polyfill/vr-present-end",this[ae].onPresentationEnd),f.removeEventListener("@@webxr-polyfill/vr-present-start",this[ae].onPresentationStart),f.removeEventListener("@@webxr-polyfill/input-select-start",this[ae].onSelectStart),f.removeEventListener("@@webxr-polyfill/input-select-end",this[ae].onSelectEnd),this.dispatchEvent("end",cc("end",{session:this}))},f.addEventListener("@@webxr-polyfill/vr-present-end",this[ae].onPresentationEnd),this[ae].onPresentationStart=ee=>{ee!==this[ae].id&&(this[ae].suspended=!0,this[ae].stopDeviceFrameLoop(),this.dispatchEvent("blur",{session:this}))},f.addEventListener("@@webxr-polyfill/vr-present-start",this[ae].onPresentationStart),this[ae].onSelectStart=ee=>{ee.sessionId===this[ae].id&&this[ae].dispatchInputSourceEvent("selectstart",ee.inputSource)},f.addEventListener("@@webxr-polyfill/input-select-start",this[ae].onSelectStart),this[ae].onSelectEnd=ee=>{ee.sessionId===this[ae].id&&(this[ae].dispatchInputSourceEvent("selectend",ee.inputSource),this[ae].dispatchInputSourceEvent("select",ee.inputSource))},f.addEventListener("@@webxr-polyfill/input-select-end",this[ae].onSelectEnd),this[ae].onSqueezeStart=ee=>{ee.sessionId===this[ae].id&&this[ae].dispatchInputSourceEvent("squeezestart",ee.inputSource)},f.addEventListener("@@webxr-polyfill/input-squeeze-start",this[ae].onSqueezeStart),this[ae].onSqueezeEnd=ee=>{ee.sessionId===this[ae].id&&(this[ae].dispatchInputSourceEvent("squeezeend",ee.inputSource),this[ae].dispatchInputSourceEvent("squeeze",ee.inputSource))},f.addEventListener("@@webxr-polyfill/input-squeeze-end",this[ae].onSqueezeEnd),this[ae].dispatchInputSourceEvent=(ee,oe)=>{const Se=new Xt(f,this,this[ae].id),ge=ld(ee,{frame:Se,inputSource:oe});Se[De].active=!0,this.dispatchEvent(ee,ge),Se[De].active=!1},this[ae].startDeviceFrameLoop(),this.onblur=void 0,this.onfocus=void 0,this.onresetpose=void 0,this.onend=void 0,this.onselect=void 0,this.onselectstart=void 0,this.onselectend=void 0}get renderState(){return this[ae].activeRenderState}get environmentBlendMode(){return this[ae].device.environmentBlendMode||"opaque"}requestReferenceSpace(f){return Dt(this,null,function*(){if(this[ae].ended)return;if(!ot.includes(f))throw new TypeError(`XRReferenceSpaceType must be one of ${ot}`);if(!this[ae].device.doesSessionSupportReferenceSpace(this[ae].id,f))throw new DOMException(`The ${f} reference space is not supported by this session.`,"NotSupportedError");if(f==="viewer")return this[ae].viewerSpace;let T=yield this[ae].device.requestFrameOfReferenceTransform(f);if(f==="bounded-floor")throw T?this[ae].device.requestStageBounds()?new DOMException(`The WebXR polyfill does not support the ${f} reference space yet.`,"NotSupportedError"):new DOMException(`${f} XRReferenceSpace not supported by this device.`,"NotSupportedError"):new DOMException(`${f} XRReferenceSpace not supported by this device.`,"NotSupportedError");return new ct(f,T)})}requestAnimationFrame(f){if(this[ae].ended)return;const T=++this[ae].frameHandle;return this[ae].frameCallbacks.push({handle:T,callback:f,cancelled:!1}),T}cancelAnimationFrame(f){let T=this[ae].frameCallbacks,P=T.findIndex(V=>V&&V.handle===f);P>-1&&(T[P].cancelled=!0,T.splice(P,1)),T=this[ae].currentFrameCallbacks,T&&(P=T.findIndex(V=>V&&V.handle===f),P>-1&&(T[P].cancelled=!0))}get inputSources(){return this[ae].device.getInputSources()}end(){return Dt(this,null,function*(){if(!this[ae].ended)return this[ae].immersive&&(this[ae].ended=!0,this[ae].device.removeEventListener("@@webxr-polyfill/vr-present-start",this[ae].onPresentationStart),this[ae].device.removeEventListener("@@webxr-polyfill/vr-present-end",this[ae].onPresentationEnd),this[ae].device.removeEventListener("@@webxr-polyfill/input-select-start",this[ae].onSelectStart),this[ae].device.removeEventListener("@@webxr-polyfill/input-select-end",this[ae].onSelectEnd),this.dispatchEvent("end",cc("end",{session:this}))),this[ae].stopDeviceFrameLoop(),this[ae].device.endSession(this[ae].id)})}updateRenderState(f){if(this[ae].ended){const P="Can't call updateRenderState on an XRSession that has already ended.";throw new Error(P)}if(f.baseLayer&&f.baseLayer._session!==this){const P="Called updateRenderState with a base layer that was created by a different session.";throw new Error(P)}if(f.inlineVerticalFieldOfView!==null&&f.inlineVerticalFieldOfView!==void 0)if(this[ae].immersive){const P="inlineVerticalFieldOfView must not be set for an XRRenderState passed to updateRenderState for an immersive session.";throw new Error(P)}else f.inlineVerticalFieldOfView=Math.min(3.13,Math.max(.01,f.inlineVerticalFieldOfView));if(this[ae].pendingRenderState===null){const P=this[ae].activeRenderState;this[ae].pendingRenderState={depthNear:P.depthNear,depthFar:P.depthFar,inlineVerticalFieldOfView:P.inlineVerticalFieldOfView,baseLayer:P.baseLayer}}Object.assign(this[ae].pendingRenderState,f)}_checkInputSourcesChange(){const f=[],T=[],P=this.inputSources,V=this[ae].currentInputSources;for(const Y of P)V.includes(Y)||f.push(Y);for(const Y of V)P.includes(Y)||T.push(Y);(f.length>0||T.length>0)&&this.dispatchEvent("inputsourceschange",cd("inputsourceschange",{session:this,added:f,removed:T})),this[ae].currentInputSources.length=0;for(const Y of P)this[ae].currentInputSources.push(Y)}}const to=Symbol("@@webxr-polyfill/XRInputSource");class tp{constructor(f){this[to]={impl:f,gripSpace:new ue("grip",this),targetRaySpace:new ue("target-ray",this)}}get handedness(){return this[to].impl.handedness}get targetRayMode(){return this[to].impl.targetRayMode}get gripSpace(){let f=this[to].impl.targetRayMode;return f==="gaze"||f==="screen"?null:this[to].gripSpace}get targetRaySpace(){return this[to].targetRaySpace}get profiles(){return this[to].impl.profiles}get gamepad(){return this[to].impl.gamepad}}const dd=Symbol("@@webxr-polyfill/XRReferenceSpaceEvent");function ip(y,f){const T=new Event(y,f);return T[dd]={referenceSpace:f.referenceSpace,transform:f.transform||null},Object.setPrototypeOf(T,ip.prototype),Object.defineProperty(T,"referenceSpace",{get(){return this[dd].referenceSpace}}),Object.defineProperty(T,"transform",{get(){return this[dd].transform}}),T}var ud={XRSystem:Ut,XRSession:ep,XRSessionEvent:cc,XRFrame:Xt,XRView:Ne,XRViewport:q,XRViewerPose:R,XRWebGLLayer:zy,XRSpace:ue,XRReferenceSpace:ct,XRReferenceSpaceEvent:ip,XRInputSource:tp,XRInputSourceEvent:ld,XRInputSourcesChangeEvent:cd,XRRenderState:zs,XRRigidTransform:Ge,XRPose:si};const np=y=>typeof y.prototype.makeXRCompatible=="function"?!1:(y.prototype.makeXRCompatible=function(){return this[rd]=!0,Promise.resolve()},!0),sp=y=>{const f=y.prototype.getContext;y.prototype.getContext=function(T,P){const V=f.call(this,T,P);return V&&(V[Zm]=!0,P&&"xrCompatible"in P&&(V[rd]=P.xrCompatible)),V}},Vy=y=>!!(y.ImageBitmapRenderingContext&&y.createImageBitmap),Gy=y=>{var f=!1;return function(T){(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(T)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(T.substr(0,4)))&&(f=!0)}(y.navigator.userAgent||y.navigator.vendor||y.opera),f},Hy=y=>{y.style.display="block",y.style.position="absolute",y.style.width=y.style.height="1px",y.style.top=y.style.left="0px"};var fd=typeof window!="undefined"?window:typeof global!="undefined"?global:typeof self!="undefined"?self:{};function Wy(y){return y&&y.__esModule&&Object.prototype.hasOwnProperty.call(y,"default")?y.default:y}function jy(y,f){return f={exports:{}},y(f,f.exports),f.exports}var Xy=jy(function(y,f){(function(T,P){y.exports=P()})(fd,function(){var T=function(p,_){if(!(p instanceof _))throw new TypeError("Cannot call a class as a function")},P=function(){function p(_,A){for(var S=0;S<A.length;S++){var D=A[S];D.enumerable=D.enumerable||!1,D.configurable=!0,"value"in D&&(D.writable=!0),Object.defineProperty(_,D.key,D)}}return function(_,A,S){return A&&p(_.prototype,A),S&&p(_,S),_}}(),V=function(){function p(_,A){var S=[],D=!0,W=!1,j=void 0;try{for(var fe=_[Symbol.iterator](),me;!(D=(me=fe.next()).done)&&(S.push(me.value),!(A&&S.length===A));D=!0);}catch(Q){W=!0,j=Q}finally{try{!D&&fe.return&&fe.return()}finally{if(W)throw j}}return S}return function(_,A){if(Array.isArray(_))return _;if(Symbol.iterator in Object(_))return p(_,A);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),Y=.001,ee=1,oe=function(_,A){return"data:"+_+","+encodeURIComponent(A)},Se=function(_,A,S){return _+(A-_)*S},ge=function(){var p=/iPad|iPhone|iPod/.test(navigator.platform);return function(){return p}}(),He=function(){var p=navigator.userAgent.indexOf("Version")!==-1&&navigator.userAgent.indexOf("Android")!==-1&&navigator.userAgent.indexOf("Chrome")!==-1;return function(){return p}}(),it=function(){var p=/^((?!chrome|android).)*safari/i.test(navigator.userAgent);return function(){return p}}(),Ft=function(){var p=navigator.userAgent.indexOf("Firefox")!==-1&&navigator.userAgent.indexOf("Android")!==-1;return function(){return p}}(),kt=function(){var p=navigator.userAgent.match(/.*Chrome\/([0-9]+)/),_=p?parseInt(p[1],10):null;return function(){return _}}(),Zt=function(){var p=!1;return p=ge()&&it()&&navigator.userAgent.indexOf("13_4")!==-1,function(){return p}}(),zt=function(){var p=!1;if(kt()===65){var _=navigator.userAgent.match(/.*Chrome\/([0-9\.]*)/);if(_){var A=_[1].split("."),S=V(A,4),D=S[0],W=S[1],j=S[2],fe=S[3];p=parseInt(j,10)===3325&&parseInt(fe,10)<148}}return function(){return p}}(),Ot=function(){var p=navigator.userAgent.indexOf("R7 Build")!==-1;return function(){return p}}(),ci=function(){var _=window.orientation==90||window.orientation==-90;return Ot()?!_:_},ki=function(_){return!(isNaN(_)||_<=Y||_>ee)},bt=function(){return Math.max(window.screen.width,window.screen.height)*window.devicePixelRatio},St=function(){return Math.min(window.screen.width,window.screen.height)*window.devicePixelRatio},It=function(_){if(He())return!1;if(_.requestFullscreen)_.requestFullscreen();else if(_.webkitRequestFullscreen)_.webkitRequestFullscreen();else if(_.mozRequestFullScreen)_.mozRequestFullScreen();else if(_.msRequestFullscreen)_.msRequestFullscreen();else return!1;return!0},_t=function(){if(document.exitFullscreen)document.exitFullscreen();else if(document.webkitExitFullscreen)document.webkitExitFullscreen();else if(document.mozCancelFullScreen)document.mozCancelFullScreen();else if(document.msExitFullscreen)document.msExitFullscreen();else return!1;return!0},Kn=function(){return document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement},io=function(_,A,S,D){var W=_.createShader(_.VERTEX_SHADER);_.shaderSource(W,A),_.compileShader(W);var j=_.createShader(_.FRAGMENT_SHADER);_.shaderSource(j,S),_.compileShader(j);var fe=_.createProgram();_.attachShader(fe,W),_.attachShader(fe,j);for(var me in D)_.bindAttribLocation(fe,D[me],me);return _.linkProgram(fe),_.deleteShader(W),_.deleteShader(j),fe},no=function(_,A){for(var S={},D=_.getProgramParameter(A,_.ACTIVE_UNIFORMS),W="",j=0;j<D;j++){var fe=_.getActiveUniform(A,j);W=fe.name.replace("[0]",""),S[W]=_.getUniformLocation(A,W)}return S},Oo=function(_,A,S,D,W,j,fe){var me=1/(A-S),Q=1/(D-W),se=1/(j-fe);return _[0]=-2*me,_[1]=0,_[2]=0,_[3]=0,_[4]=0,_[5]=-2*Q,_[6]=0,_[7]=0,_[8]=0,_[9]=0,_[10]=2*se,_[11]=0,_[12]=(A+S)*me,_[13]=(W+D)*Q,_[14]=(fe+j)*se,_[15]=1,_},Vs=function(){var _=!1;return function(A){(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(A)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(A.substr(0,4)))&&(_=!0)}(navigator.userAgent||navigator.vendor||window.opera),_},so=function(_,A){for(var S in A)A.hasOwnProperty(S)&&(_[S]=A[S]);return _},Gs=function(_){if(ge()){var A=_.style.width,S=_.style.height;_.style.width=parseInt(A)+1+"px",_.style.height=parseInt(S)+"px",setTimeout(function(){_.style.width=A,_.style.height=S},100)}window.canvas=_},_i=function(){var p=Math.PI/180,_=Math.PI*.25;function A(Q,se,Ae,qe){var Je=Math.tan(se?se.upDegrees*p:_),rt=Math.tan(se?se.downDegrees*p:_),yt=Math.tan(se?se.leftDegrees*p:_),ut=Math.tan(se?se.rightDegrees*p:_),ht=2/(yt+ut),Jt=2/(Je+rt);return Q[0]=ht,Q[1]=0,Q[2]=0,Q[3]=0,Q[4]=0,Q[5]=Jt,Q[6]=0,Q[7]=0,Q[8]=-((yt-ut)*ht*.5),Q[9]=(Je-rt)*Jt*.5,Q[10]=qe/(Ae-qe),Q[11]=-1,Q[12]=0,Q[13]=0,Q[14]=qe*Ae/(Ae-qe),Q[15]=0,Q}function S(Q,se,Ae){var qe=se[0],Je=se[1],rt=se[2],yt=se[3],ut=qe+qe,ht=Je+Je,Jt=rt+rt,vi=qe*ut,Ii=qe*ht,di=qe*Jt,Ji=Je*ht,vn=Je*Jt,bn=rt*Jt,xn=yt*ut,yn=yt*ht,oo=yt*Jt;return Q[0]=1-(Ji+bn),Q[1]=Ii+oo,Q[2]=di-yn,Q[3]=0,Q[4]=Ii-oo,Q[5]=1-(vi+bn),Q[6]=vn+xn,Q[7]=0,Q[8]=di+yn,Q[9]=vn-xn,Q[10]=1-(vi+Ji),Q[11]=0,Q[12]=Ae[0],Q[13]=Ae[1],Q[14]=Ae[2],Q[15]=1,Q}function D(Q,se,Ae){var qe=Ae[0],Je=Ae[1],rt=Ae[2],yt,ut,ht,Jt,vi,Ii,di,Ji,vn,bn,xn,yn;return se===Q?(Q[12]=se[0]*qe+se[4]*Je+se[8]*rt+se[12],Q[13]=se[1]*qe+se[5]*Je+se[9]*rt+se[13],Q[14]=se[2]*qe+se[6]*Je+se[10]*rt+se[14],Q[15]=se[3]*qe+se[7]*Je+se[11]*rt+se[15]):(yt=se[0],ut=se[1],ht=se[2],Jt=se[3],vi=se[4],Ii=se[5],di=se[6],Ji=se[7],vn=se[8],bn=se[9],xn=se[10],yn=se[11],Q[0]=yt,Q[1]=ut,Q[2]=ht,Q[3]=Jt,Q[4]=vi,Q[5]=Ii,Q[6]=di,Q[7]=Ji,Q[8]=vn,Q[9]=bn,Q[10]=xn,Q[11]=yn,Q[12]=yt*qe+vi*Je+vn*rt+se[12],Q[13]=ut*qe+Ii*Je+bn*rt+se[13],Q[14]=ht*qe+di*Je+xn*rt+se[14],Q[15]=Jt*qe+Ji*Je+yn*rt+se[15]),Q}function W(Q,se){var Ae=se[0],qe=se[1],Je=se[2],rt=se[3],yt=se[4],ut=se[5],ht=se[6],Jt=se[7],vi=se[8],Ii=se[9],di=se[10],Ji=se[11],vn=se[12],bn=se[13],xn=se[14],yn=se[15],oo=Ae*ut-qe*yt,Sa=Ae*ht-Je*yt,wa=Ae*Jt-rt*yt,Ma=qe*ht-Je*ut,Pa=qe*Jt-rt*ut,Ca=Je*Jt-rt*ht,Ra=vi*bn-Ii*vn,Ia=vi*xn-di*vn,Da=vi*yn-Ji*vn,La=Ii*xn-di*bn,Fa=Ii*yn-Ji*bn,Oa=di*yn-Ji*xn,Si=oo*Oa-Sa*Fa+wa*La+Ma*Da-Pa*Ia+Ca*Ra;return Si?(Si=1/Si,Q[0]=(ut*Oa-ht*Fa+Jt*La)*Si,Q[1]=(Je*Fa-qe*Oa-rt*La)*Si,Q[2]=(bn*Ca-xn*Pa+yn*Ma)*Si,Q[3]=(di*Pa-Ii*Ca-Ji*Ma)*Si,Q[4]=(ht*Da-yt*Oa-Jt*Ia)*Si,Q[5]=(Ae*Oa-Je*Da+rt*Ia)*Si,Q[6]=(xn*wa-vn*Ca-yn*Sa)*Si,Q[7]=(vi*Ca-di*wa+Ji*Sa)*Si,Q[8]=(yt*Fa-ut*Da+Jt*Ra)*Si,Q[9]=(qe*Da-Ae*Fa-rt*Ra)*Si,Q[10]=(vn*Pa-bn*wa+yn*oo)*Si,Q[11]=(Ii*wa-vi*Pa-Ji*oo)*Si,Q[12]=(ut*Ia-yt*La-ht*Ra)*Si,Q[13]=(Ae*La-qe*Ia+Je*Ra)*Si,Q[14]=(bn*Sa-vn*Ma-xn*oo)*Si,Q[15]=(vi*Ma-Ii*Sa+di*oo)*Si,Q):null}var j=new Float32Array([0,0,0,1]),fe=new Float32Array([0,0,0]);function me(Q,se,Ae,qe,Je,rt){A(Q,qe||null,rt.depthNear,rt.depthFar);var yt=Ae.orientation||j,ut=Ae.position||fe;S(se,yt,ut),Je&&D(se,se,Je),W(se,se)}return function(Q,se,Ae){return!Q||!se?!1:(Q.pose=se,Q.timestamp=se.timestamp,me(Q.leftProjectionMatrix,Q.leftViewMatrix,se,Ae._getFieldOfView("left"),Ae._getEyeOffset("left"),Ae),me(Q.rightProjectionMatrix,Q.rightViewMatrix,se,Ae._getFieldOfView("right"),Ae._getEyeOffset("right"),Ae),!0)}}(),TA=function(){var _=window.self!==window.top,A=pp(document.referrer),S=pp(window.location.href);return _&&A!==S},pp=function(_){var A,S=_.indexOf("://");S!==-1?A=S+3:A=0;var D=_.indexOf("/",A);return D===-1&&(D=_.length),_.substring(0,D)},SA=function(_){if(_.w>1)return console.warn("getQuaternionAngle: w > 1"),0;var A=2*Math.acos(_.w);return A},pd=function(){var p={};return function(_,A){p[_]===void 0&&(console.warn("webvr-polyfill: "+A),p[_]=!0)}}(),Bo=function(_,A){var S=A?"Please use "+A+" instead.":"";pd(_,_+" has been deprecated. This may not work on native WebVR displays. "+S)};function wA(p,_,A){if(!_){A(p);return}for(var S=[],D=null,W=0;W<_.length;++W){var j=_[W];switch(j){case p.TEXTURE_BINDING_2D:case p.TEXTURE_BINDING_CUBE_MAP:var fe=_[++W];if(fe<p.TEXTURE0||fe>p.TEXTURE31){console.error("TEXTURE_BINDING_2D or TEXTURE_BINDING_CUBE_MAP must be followed by a valid texture unit"),S.push(null,null);break}D||(D=p.getParameter(p.ACTIVE_TEXTURE)),p.activeTexture(fe),S.push(p.getParameter(j),null);break;case p.ACTIVE_TEXTURE:D=p.getParameter(p.ACTIVE_TEXTURE),S.push(null);break;default:S.push(p.getParameter(j));break}}A(p);for(var W=0;W<_.length;++W){var j=_[W],me=S[W];switch(j){case p.ACTIVE_TEXTURE:break;case p.ARRAY_BUFFER_BINDING:p.bindBuffer(p.ARRAY_BUFFER,me);break;case p.COLOR_CLEAR_VALUE:p.clearColor(me[0],me[1],me[2],me[3]);break;case p.COLOR_WRITEMASK:p.colorMask(me[0],me[1],me[2],me[3]);break;case p.CURRENT_PROGRAM:p.useProgram(me);break;case p.ELEMENT_ARRAY_BUFFER_BINDING:p.bindBuffer(p.ELEMENT_ARRAY_BUFFER,me);break;case p.FRAMEBUFFER_BINDING:p.bindFramebuffer(p.FRAMEBUFFER,me);break;case p.RENDERBUFFER_BINDING:p.bindRenderbuffer(p.RENDERBUFFER,me);break;case p.TEXTURE_BINDING_2D:var fe=_[++W];if(fe<p.TEXTURE0||fe>p.TEXTURE31)break;p.activeTexture(fe),p.bindTexture(p.TEXTURE_2D,me);break;case p.TEXTURE_BINDING_CUBE_MAP:var fe=_[++W];if(fe<p.TEXTURE0||fe>p.TEXTURE31)break;p.activeTexture(fe),p.bindTexture(p.TEXTURE_CUBE_MAP,me);break;case p.VIEWPORT:p.viewport(me[0],me[1],me[2],me[3]);break;case p.BLEND:case p.CULL_FACE:case p.DEPTH_TEST:case p.SCISSOR_TEST:case p.STENCIL_TEST:me?p.enable(j):p.disable(j);break;default:console.log("No GL restore behavior for 0x"+j.toString(16));break}D&&p.activeTexture(D)}}var Aa=wA,MA=["attribute vec2 position;","attribute vec3 texCoord;","varying vec2 vTexCoord;","uniform vec4 viewportOffsetScale[2];","void main() {","  vec4 viewport = viewportOffsetScale[int(texCoord.z)];","  vTexCoord = (texCoord.xy * viewport.zw) + viewport.xy;","  gl_Position = vec4( position, 1.0, 1.0 );","}"].join(`
`),PA=["precision mediump float;","uniform sampler2D diffuse;","varying vec2 vTexCoord;","void main() {","  gl_FragColor = texture2D(diffuse, vTexCoord);","}"].join(`
`);function $n(p,_,A,S){this.gl=p,this.cardboardUI=_,this.bufferScale=A,this.dirtySubmitFrameBindings=S,this.ctxAttribs=p.getContextAttributes(),this.instanceExt=p.getExtension("ANGLE_instanced_arrays"),this.meshWidth=20,this.meshHeight=20,this.bufferWidth=p.drawingBufferWidth,this.bufferHeight=p.drawingBufferHeight,this.realBindFramebuffer=p.bindFramebuffer,this.realEnable=p.enable,this.realDisable=p.disable,this.realColorMask=p.colorMask,this.realClearColor=p.clearColor,this.realViewport=p.viewport,ge()||(this.realCanvasWidth=Object.getOwnPropertyDescriptor(p.canvas.__proto__,"width"),this.realCanvasHeight=Object.getOwnPropertyDescriptor(p.canvas.__proto__,"height")),this.isPatched=!1,this.lastBoundFramebuffer=null,this.cullFace=!1,this.depthTest=!1,this.blend=!1,this.scissorTest=!1,this.stencilTest=!1,this.viewport=[0,0,0,0],this.colorMask=[!0,!0,!0,!0],this.clearColor=[0,0,0,0],this.attribs={position:0,texCoord:1},this.program=io(p,MA,PA,this.attribs),this.uniforms=no(p,this.program),this.viewportOffsetScale=new Float32Array(8),this.setTextureBounds(),this.vertexBuffer=p.createBuffer(),this.indexBuffer=p.createBuffer(),this.indexCount=0,this.renderTarget=p.createTexture(),this.framebuffer=p.createFramebuffer(),this.depthStencilBuffer=null,this.depthBuffer=null,this.stencilBuffer=null,this.ctxAttribs.depth&&this.ctxAttribs.stencil?this.depthStencilBuffer=p.createRenderbuffer():this.ctxAttribs.depth?this.depthBuffer=p.createRenderbuffer():this.ctxAttribs.stencil&&(this.stencilBuffer=p.createRenderbuffer()),this.patch(),this.onResize()}$n.prototype.destroy=function(){var p=this.gl;this.unpatch(),p.deleteProgram(this.program),p.deleteBuffer(this.vertexBuffer),p.deleteBuffer(this.indexBuffer),p.deleteTexture(this.renderTarget),p.deleteFramebuffer(this.framebuffer),this.depthStencilBuffer&&p.deleteRenderbuffer(this.depthStencilBuffer),this.depthBuffer&&p.deleteRenderbuffer(this.depthBuffer),this.stencilBuffer&&p.deleteRenderbuffer(this.stencilBuffer),this.cardboardUI&&this.cardboardUI.destroy()},$n.prototype.onResize=function(){var p=this.gl,_=this,A=[p.RENDERBUFFER_BINDING,p.TEXTURE_BINDING_2D,p.TEXTURE0];Aa(p,A,function(S){_.realBindFramebuffer.call(S,S.FRAMEBUFFER,null),_.scissorTest&&_.realDisable.call(S,S.SCISSOR_TEST),_.realColorMask.call(S,!0,!0,!0,!0),_.realViewport.call(S,0,0,S.drawingBufferWidth,S.drawingBufferHeight),_.realClearColor.call(S,0,0,0,1),S.clear(S.COLOR_BUFFER_BIT),_.realBindFramebuffer.call(S,S.FRAMEBUFFER,_.framebuffer),S.bindTexture(S.TEXTURE_2D,_.renderTarget),S.texImage2D(S.TEXTURE_2D,0,_.ctxAttribs.alpha?S.RGBA:S.RGB,_.bufferWidth,_.bufferHeight,0,_.ctxAttribs.alpha?S.RGBA:S.RGB,S.UNSIGNED_BYTE,null),S.texParameteri(S.TEXTURE_2D,S.TEXTURE_MAG_FILTER,S.LINEAR),S.texParameteri(S.TEXTURE_2D,S.TEXTURE_MIN_FILTER,S.LINEAR),S.texParameteri(S.TEXTURE_2D,S.TEXTURE_WRAP_S,S.CLAMP_TO_EDGE),S.texParameteri(S.TEXTURE_2D,S.TEXTURE_WRAP_T,S.CLAMP_TO_EDGE),S.framebufferTexture2D(S.FRAMEBUFFER,S.COLOR_ATTACHMENT0,S.TEXTURE_2D,_.renderTarget,0),_.ctxAttribs.depth&&_.ctxAttribs.stencil?(S.bindRenderbuffer(S.RENDERBUFFER,_.depthStencilBuffer),S.renderbufferStorage(S.RENDERBUFFER,S.DEPTH_STENCIL,_.bufferWidth,_.bufferHeight),S.framebufferRenderbuffer(S.FRAMEBUFFER,S.DEPTH_STENCIL_ATTACHMENT,S.RENDERBUFFER,_.depthStencilBuffer)):_.ctxAttribs.depth?(S.bindRenderbuffer(S.RENDERBUFFER,_.depthBuffer),S.renderbufferStorage(S.RENDERBUFFER,S.DEPTH_COMPONENT16,_.bufferWidth,_.bufferHeight),S.framebufferRenderbuffer(S.FRAMEBUFFER,S.DEPTH_ATTACHMENT,S.RENDERBUFFER,_.depthBuffer)):_.ctxAttribs.stencil&&(S.bindRenderbuffer(S.RENDERBUFFER,_.stencilBuffer),S.renderbufferStorage(S.RENDERBUFFER,S.STENCIL_INDEX8,_.bufferWidth,_.bufferHeight),S.framebufferRenderbuffer(S.FRAMEBUFFER,S.STENCIL_ATTACHMENT,S.RENDERBUFFER,_.stencilBuffer)),!S.checkFramebufferStatus(S.FRAMEBUFFER)===S.FRAMEBUFFER_COMPLETE&&console.error("Framebuffer incomplete!"),_.realBindFramebuffer.call(S,S.FRAMEBUFFER,_.lastBoundFramebuffer),_.scissorTest&&_.realEnable.call(S,S.SCISSOR_TEST),_.realColorMask.apply(S,_.colorMask),_.realViewport.apply(S,_.viewport),_.realClearColor.apply(S,_.clearColor)}),this.cardboardUI&&this.cardboardUI.onResize()},$n.prototype.patch=function(){if(!this.isPatched){var p=this,_=this.gl.canvas,A=this.gl;ge()||(_.width=bt()*this.bufferScale,_.height=St()*this.bufferScale,Object.defineProperty(_,"width",{configurable:!0,enumerable:!0,get:function(){return p.bufferWidth},set:function(D){p.bufferWidth=D,p.realCanvasWidth.set.call(_,D),p.onResize()}}),Object.defineProperty(_,"height",{configurable:!0,enumerable:!0,get:function(){return p.bufferHeight},set:function(D){p.bufferHeight=D,p.realCanvasHeight.set.call(_,D),p.onResize()}})),this.lastBoundFramebuffer=A.getParameter(A.FRAMEBUFFER_BINDING),this.lastBoundFramebuffer==null&&(this.lastBoundFramebuffer=this.framebuffer,this.gl.bindFramebuffer(A.FRAMEBUFFER,this.framebuffer)),this.gl.bindFramebuffer=function(S,D){p.lastBoundFramebuffer=D||p.framebuffer,p.realBindFramebuffer.call(A,S,p.lastBoundFramebuffer)},this.cullFace=A.getParameter(A.CULL_FACE),this.depthTest=A.getParameter(A.DEPTH_TEST),this.blend=A.getParameter(A.BLEND),this.scissorTest=A.getParameter(A.SCISSOR_TEST),this.stencilTest=A.getParameter(A.STENCIL_TEST),A.enable=function(S){switch(S){case A.CULL_FACE:p.cullFace=!0;break;case A.DEPTH_TEST:p.depthTest=!0;break;case A.BLEND:p.blend=!0;break;case A.SCISSOR_TEST:p.scissorTest=!0;break;case A.STENCIL_TEST:p.stencilTest=!0;break}p.realEnable.call(A,S)},A.disable=function(S){switch(S){case A.CULL_FACE:p.cullFace=!1;break;case A.DEPTH_TEST:p.depthTest=!1;break;case A.BLEND:p.blend=!1;break;case A.SCISSOR_TEST:p.scissorTest=!1;break;case A.STENCIL_TEST:p.stencilTest=!1;break}p.realDisable.call(A,S)},this.colorMask=A.getParameter(A.COLOR_WRITEMASK),A.colorMask=function(S,D,W,j){p.colorMask[0]=S,p.colorMask[1]=D,p.colorMask[2]=W,p.colorMask[3]=j,p.realColorMask.call(A,S,D,W,j)},this.clearColor=A.getParameter(A.COLOR_CLEAR_VALUE),A.clearColor=function(S,D,W,j){p.clearColor[0]=S,p.clearColor[1]=D,p.clearColor[2]=W,p.clearColor[3]=j,p.realClearColor.call(A,S,D,W,j)},this.viewport=A.getParameter(A.VIEWPORT),A.viewport=function(S,D,W,j){p.viewport[0]=S,p.viewport[1]=D,p.viewport[2]=W,p.viewport[3]=j,p.realViewport.call(A,S,D,W,j)},this.isPatched=!0,Gs(_)}},$n.prototype.unpatch=function(){if(this.isPatched){var p=this.gl,_=this.gl.canvas;ge()||(Object.defineProperty(_,"width",this.realCanvasWidth),Object.defineProperty(_,"height",this.realCanvasHeight)),_.width=this.bufferWidth,_.height=this.bufferHeight,p.bindFramebuffer=this.realBindFramebuffer,p.enable=this.realEnable,p.disable=this.realDisable,p.colorMask=this.realColorMask,p.clearColor=this.realClearColor,p.viewport=this.realViewport,this.lastBoundFramebuffer==this.framebuffer&&p.bindFramebuffer(p.FRAMEBUFFER,null),this.isPatched=!1,setTimeout(function(){Gs(_)},1)}},$n.prototype.setTextureBounds=function(p,_){p||(p=[0,0,.5,1]),_||(_=[.5,0,.5,1]),this.viewportOffsetScale[0]=p[0],this.viewportOffsetScale[1]=p[1],this.viewportOffsetScale[2]=p[2],this.viewportOffsetScale[3]=p[3],this.viewportOffsetScale[4]=_[0],this.viewportOffsetScale[5]=_[1],this.viewportOffsetScale[6]=_[2],this.viewportOffsetScale[7]=_[3]},$n.prototype.submitFrame=function(){var p=this.gl,_=this,A=[];if(this.dirtySubmitFrameBindings||A.push(p.CURRENT_PROGRAM,p.ARRAY_BUFFER_BINDING,p.ELEMENT_ARRAY_BUFFER_BINDING,p.TEXTURE_BINDING_2D,p.TEXTURE0),Aa(p,A,function(D){_.realBindFramebuffer.call(D,D.FRAMEBUFFER,null);var W=0,j=0;_.instanceExt&&(W=D.getVertexAttrib(_.attribs.position,_.instanceExt.VERTEX_ATTRIB_ARRAY_DIVISOR_ANGLE),j=D.getVertexAttrib(_.attribs.texCoord,_.instanceExt.VERTEX_ATTRIB_ARRAY_DIVISOR_ANGLE)),_.cullFace&&_.realDisable.call(D,D.CULL_FACE),_.depthTest&&_.realDisable.call(D,D.DEPTH_TEST),_.blend&&_.realDisable.call(D,D.BLEND),_.scissorTest&&_.realDisable.call(D,D.SCISSOR_TEST),_.stencilTest&&_.realDisable.call(D,D.STENCIL_TEST),_.realColorMask.call(D,!0,!0,!0,!0),_.realViewport.call(D,0,0,D.drawingBufferWidth,D.drawingBufferHeight),(_.ctxAttribs.alpha||ge())&&(_.realClearColor.call(D,0,0,0,1),D.clear(D.COLOR_BUFFER_BIT)),D.useProgram(_.program),D.bindBuffer(D.ELEMENT_ARRAY_BUFFER,_.indexBuffer),D.bindBuffer(D.ARRAY_BUFFER,_.vertexBuffer),D.enableVertexAttribArray(_.attribs.position),D.enableVertexAttribArray(_.attribs.texCoord),D.vertexAttribPointer(_.attribs.position,2,D.FLOAT,!1,20,0),D.vertexAttribPointer(_.attribs.texCoord,3,D.FLOAT,!1,20,8),_.instanceExt&&(W!=0&&_.instanceExt.vertexAttribDivisorANGLE(_.attribs.position,0),j!=0&&_.instanceExt.vertexAttribDivisorANGLE(_.attribs.texCoord,0)),D.activeTexture(D.TEXTURE0),D.uniform1i(_.uniforms.diffuse,0),D.bindTexture(D.TEXTURE_2D,_.renderTarget),D.uniform4fv(_.uniforms.viewportOffsetScale,_.viewportOffsetScale),D.drawElements(D.TRIANGLES,_.indexCount,D.UNSIGNED_SHORT,0),_.cardboardUI&&_.cardboardUI.renderNoState(),_.realBindFramebuffer.call(_.gl,D.FRAMEBUFFER,_.framebuffer),_.ctxAttribs.preserveDrawingBuffer||(_.realClearColor.call(D,0,0,0,0),D.clear(D.COLOR_BUFFER_BIT)),_.dirtySubmitFrameBindings||_.realBindFramebuffer.call(D,D.FRAMEBUFFER,_.lastBoundFramebuffer),_.cullFace&&_.realEnable.call(D,D.CULL_FACE),_.depthTest&&_.realEnable.call(D,D.DEPTH_TEST),_.blend&&_.realEnable.call(D,D.BLEND),_.scissorTest&&_.realEnable.call(D,D.SCISSOR_TEST),_.stencilTest&&_.realEnable.call(D,D.STENCIL_TEST),_.realColorMask.apply(D,_.colorMask),_.realViewport.apply(D,_.viewport),(_.ctxAttribs.alpha||!_.ctxAttribs.preserveDrawingBuffer)&&_.realClearColor.apply(D,_.clearColor),_.instanceExt&&(W!=0&&_.instanceExt.vertexAttribDivisorANGLE(_.attribs.position,W),j!=0&&_.instanceExt.vertexAttribDivisorANGLE(_.attribs.texCoord,j))}),ge()){var S=p.canvas;(S.width!=_.bufferWidth||S.height!=_.bufferHeight)&&(_.bufferWidth=S.width,_.bufferHeight=S.height,_.onResize())}},$n.prototype.updateDeviceInfo=function(p){var _=this.gl,A=this,S=[_.ARRAY_BUFFER_BINDING,_.ELEMENT_ARRAY_BUFFER_BINDING];Aa(_,S,function(D){var W=A.computeMeshVertices_(A.meshWidth,A.meshHeight,p);if(D.bindBuffer(D.ARRAY_BUFFER,A.vertexBuffer),D.bufferData(D.ARRAY_BUFFER,W,D.STATIC_DRAW),!A.indexCount){var j=A.computeMeshIndices_(A.meshWidth,A.meshHeight);D.bindBuffer(D.ELEMENT_ARRAY_BUFFER,A.indexBuffer),D.bufferData(D.ELEMENT_ARRAY_BUFFER,j,D.STATIC_DRAW),A.indexCount=j.length}})},$n.prototype.computeMeshVertices_=function(p,_,A){for(var S=new Float32Array(2*p*_*5),D=A.getLeftEyeVisibleTanAngles(),W=A.getLeftEyeNoLensTanAngles(),j=A.getLeftEyeVisibleScreenRect(W),fe=0,me=0;me<2;me++){for(var Q=0;Q<_;Q++)for(var se=0;se<p;se++,fe++){var Ae=se/(p-1),qe=Q/(_-1),Je=Ae,rt=qe,yt=Se(D[0],D[2],Ae),ut=Se(D[3],D[1],qe),ht=Math.sqrt(yt*yt+ut*ut),Jt=A.distortion.distortInverse(ht),vi=yt*Jt/ht,Ii=ut*Jt/ht;Ae=(vi-W[0])/(W[2]-W[0]),qe=(Ii-W[3])/(W[1]-W[3]),Ae=(j.x+Ae*j.width-.5)*2,qe=(j.y+qe*j.height-.5)*2,S[fe*5+0]=Ae,S[fe*5+1]=qe,S[fe*5+2]=Je,S[fe*5+3]=rt,S[fe*5+4]=me}var di=D[2]-D[0];D[0]=-(di+D[0]),D[2]=di-D[2],di=W[2]-W[0],W[0]=-(di+W[0]),W[2]=di-W[2],j.x=1-(j.x+j.width)}return S},$n.prototype.computeMeshIndices_=function(p,_){for(var A=new Uint16Array(2*(p-1)*(_-1)*6),S=p/2,D=_/2,W=0,j=0,fe=0;fe<2;fe++)for(var me=0;me<_;me++)for(var Q=0;Q<p;Q++,W++)Q==0||me==0||(Q<=S==me<=D?(A[j++]=W,A[j++]=W-p-1,A[j++]=W-p,A[j++]=W-p-1,A[j++]=W,A[j++]=W-1):(A[j++]=W-1,A[j++]=W-p,A[j++]=W,A[j++]=W-p,A[j++]=W-1,A[j++]=W-p-1));return A},$n.prototype.getOwnPropertyDescriptor_=function(p,_){var A=Object.getOwnPropertyDescriptor(p,_);return(A.get===void 0||A.set===void 0)&&(A.configurable=!0,A.enumerable=!0,A.get=function(){return this.getAttribute(_)},A.set=function(S){this.setAttribute(_,S)}),A};var CA=["attribute vec2 position;","uniform mat4 projectionMat;","void main() {","  gl_Position = projectionMat * vec4( position, -1.0, 1.0 );","}"].join(`
`),RA=["precision mediump float;","uniform vec4 color;","void main() {","  gl_FragColor = color;","}"].join(`
`),_p=Math.PI/180,_d=60,gp=12,vp=20,gd=1,bp=.75,xp=.3125,IA=4,Uo=28,vd=1.5;function No(p){this.gl=p,this.attribs={position:0},this.program=io(p,CA,RA,this.attribs),this.uniforms=no(p,this.program),this.vertexBuffer=p.createBuffer(),this.gearOffset=0,this.gearVertexCount=0,this.arrowOffset=0,this.arrowVertexCount=0,this.projMat=new Float32Array(16),this.listener=null,this.onResize()}No.prototype.destroy=function(){var p=this.gl;this.listener&&p.canvas.removeEventListener("click",this.listener,!1),p.deleteProgram(this.program),p.deleteBuffer(this.vertexBuffer)},No.prototype.listen=function(p,_){var A=this.gl.canvas;this.listener=function(S){var D=A.clientWidth/2,W=Uo*vd,j=S.touches?S.touches[0].clientX:S.clientX,fe=S.touches?S.touches[0].clientY:S.clientY;j>D-W&&j<D+W&&fe>A.clientHeight-W?p(S):j<W&&fe<W&&_(S)},A.addEventListener("click",this.listener,!1),A.addEventListener("touchstart",this.listener,!1)},No.prototype.onResize=function(){var p=this.gl,_=this,A=[p.ARRAY_BUFFER_BINDING];Aa(p,A,function(S){var D=[],W=S.drawingBufferWidth/2,j=Math.max(screen.width,screen.height)*window.devicePixelRatio,fe=S.drawingBufferWidth/j,me=fe*window.devicePixelRatio,Q=IA*me/2,se=Uo*vd*me,Ae=Uo*me/2,qe=(Uo*vd-Uo)*me;D.push(W-Q,se),D.push(W-Q,S.drawingBufferHeight),D.push(W+Q,se),D.push(W+Q,S.drawingBufferHeight),_.gearOffset=D.length/2;function Je(Jt,vi){var Ii=(90-Jt)*_p,di=Math.cos(Ii),Ji=Math.sin(Ii);D.push(xp*di*Ae+W,xp*Ji*Ae+Ae),D.push(vi*di*Ae+W,vi*Ji*Ae+Ae)}for(var rt=0;rt<=6;rt++){var yt=rt*_d;Je(yt,gd),Je(yt+gp,gd),Je(yt+vp,bp),Je(yt+(_d-vp),bp),Je(yt+(_d-gp),gd)}_.gearVertexCount=D.length/2-_.gearOffset,_.arrowOffset=D.length/2;function ut(Jt,vi){D.push(qe+Jt,S.drawingBufferHeight-qe-vi)}var ht=Q/Math.sin(45*_p);ut(0,Ae),ut(Ae,0),ut(Ae+ht,ht),ut(ht,Ae+ht),ut(ht,Ae-ht),ut(0,Ae),ut(Ae,Ae*2),ut(Ae+ht,Ae*2-ht),ut(ht,Ae-ht),ut(0,Ae),ut(ht,Ae-Q),ut(Uo*me,Ae-Q),ut(ht,Ae+Q),ut(Uo*me,Ae+Q),_.arrowVertexCount=D.length/2-_.arrowOffset,S.bindBuffer(S.ARRAY_BUFFER,_.vertexBuffer),S.bufferData(S.ARRAY_BUFFER,new Float32Array(D),S.STATIC_DRAW)})},No.prototype.render=function(){var p=this.gl,_=this,A=[p.CULL_FACE,p.DEPTH_TEST,p.BLEND,p.SCISSOR_TEST,p.STENCIL_TEST,p.COLOR_WRITEMASK,p.VIEWPORT,p.CURRENT_PROGRAM,p.ARRAY_BUFFER_BINDING];Aa(p,A,function(S){S.disable(S.CULL_FACE),S.disable(S.DEPTH_TEST),S.disable(S.BLEND),S.disable(S.SCISSOR_TEST),S.disable(S.STENCIL_TEST),S.colorMask(!0,!0,!0,!0),S.viewport(0,0,S.drawingBufferWidth,S.drawingBufferHeight),_.renderNoState()})},No.prototype.renderNoState=function(){var p=this.gl;p.useProgram(this.program),p.bindBuffer(p.ARRAY_BUFFER,this.vertexBuffer),p.enableVertexAttribArray(this.attribs.position),p.vertexAttribPointer(this.attribs.position,2,p.FLOAT,!1,8,0),p.uniform4f(this.uniforms.color,1,1,1,1),Oo(this.projMat,0,p.drawingBufferWidth,0,p.drawingBufferHeight,.1,1024),p.uniformMatrix4fv(this.uniforms.projectionMat,!1,this.projMat),p.drawArrays(p.TRIANGLE_STRIP,0,4),p.drawArrays(p.TRIANGLE_STRIP,this.gearOffset,this.gearVertexCount),p.drawArrays(p.TRIANGLE_STRIP,this.arrowOffset,this.arrowVertexCount)};function uc(p){this.coefficients=p}uc.prototype.distortInverse=function(p){for(var _=0,A=1,S=p-this.distort(_);Math.abs(A-_)>1e-4;){var D=p-this.distort(A),W=A-D*((A-_)/(D-S));_=A,A=W,S=D}return A},uc.prototype.distort=function(p){for(var _=p*p,A=0,S=0;S<this.coefficients.length;S++)A=_*(A+this.coefficients[S]);return(A+1)*p};var ps=Math.PI/180,_s=180/Math.PI,hi=function(_,A,S){this.x=_||0,this.y=A||0,this.z=S||0};hi.prototype={constructor:hi,set:function(_,A,S){return this.x=_,this.y=A,this.z=S,this},copy:function(_){return this.x=_.x,this.y=_.y,this.z=_.z,this},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},normalize:function(){var _=this.length();if(_!==0){var A=1/_;this.multiplyScalar(A)}else this.x=0,this.y=0,this.z=0;return this},multiplyScalar:function(_){this.x*=_,this.y*=_,this.z*=_},applyQuaternion:function(_){var A=this.x,S=this.y,D=this.z,W=_.x,j=_.y,fe=_.z,me=_.w,Q=me*A+j*D-fe*S,se=me*S+fe*A-W*D,Ae=me*D+W*S-j*A,qe=-W*A-j*S-fe*D;return this.x=Q*me+qe*-W+se*-fe-Ae*-j,this.y=se*me+qe*-j+Ae*-W-Q*-fe,this.z=Ae*me+qe*-fe+Q*-j-se*-W,this},dot:function(_){return this.x*_.x+this.y*_.y+this.z*_.z},crossVectors:function(_,A){var S=_.x,D=_.y,W=_.z,j=A.x,fe=A.y,me=A.z;return this.x=D*me-W*fe,this.y=W*j-S*me,this.z=S*fe-D*j,this}};var Bt=function(_,A,S,D){this.x=_||0,this.y=A||0,this.z=S||0,this.w=D!==void 0?D:1};Bt.prototype={constructor:Bt,set:function(_,A,S,D){return this.x=_,this.y=A,this.z=S,this.w=D,this},copy:function(_){return this.x=_.x,this.y=_.y,this.z=_.z,this.w=_.w,this},setFromEulerXYZ:function(_,A,S){var D=Math.cos(_/2),W=Math.cos(A/2),j=Math.cos(S/2),fe=Math.sin(_/2),me=Math.sin(A/2),Q=Math.sin(S/2);return this.x=fe*W*j+D*me*Q,this.y=D*me*j-fe*W*Q,this.z=D*W*Q+fe*me*j,this.w=D*W*j-fe*me*Q,this},setFromEulerYXZ:function(_,A,S){var D=Math.cos(_/2),W=Math.cos(A/2),j=Math.cos(S/2),fe=Math.sin(_/2),me=Math.sin(A/2),Q=Math.sin(S/2);return this.x=fe*W*j+D*me*Q,this.y=D*me*j-fe*W*Q,this.z=D*W*Q-fe*me*j,this.w=D*W*j+fe*me*Q,this},setFromAxisAngle:function(_,A){var S=A/2,D=Math.sin(S);return this.x=_.x*D,this.y=_.y*D,this.z=_.z*D,this.w=Math.cos(S),this},multiply:function(_){return this.multiplyQuaternions(this,_)},multiplyQuaternions:function(_,A){var S=_.x,D=_.y,W=_.z,j=_.w,fe=A.x,me=A.y,Q=A.z,se=A.w;return this.x=S*se+j*fe+D*Q-W*me,this.y=D*se+j*me+W*fe-S*Q,this.z=W*se+j*Q+S*me-D*fe,this.w=j*se-S*fe-D*me-W*Q,this},inverse:function(){return this.x*=-1,this.y*=-1,this.z*=-1,this.normalize(),this},normalize:function(){var _=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);return _===0?(this.x=0,this.y=0,this.z=0,this.w=1):(_=1/_,this.x=this.x*_,this.y=this.y*_,this.z=this.z*_,this.w=this.w*_),this},slerp:function(_,A){if(A===0)return this;if(A===1)return this.copy(_);var S=this.x,D=this.y,W=this.z,j=this.w,fe=j*_.w+S*_.x+D*_.y+W*_.z;if(fe<0?(this.w=-_.w,this.x=-_.x,this.y=-_.y,this.z=-_.z,fe=-fe):this.copy(_),fe>=1)return this.w=j,this.x=S,this.y=D,this.z=W,this;var me=Math.acos(fe),Q=Math.sqrt(1-fe*fe);if(Math.abs(Q)<.001)return this.w=.5*(j+this.w),this.x=.5*(S+this.x),this.y=.5*(D+this.y),this.z=.5*(W+this.z),this;var se=Math.sin((1-A)*me)/Q,Ae=Math.sin(A*me)/Q;return this.w=j*se+this.w*Ae,this.x=S*se+this.x*Ae,this.y=D*se+this.y*Ae,this.z=W*se+this.z*Ae,this},setFromUnitVectors:function(){var p,_,A=1e-6;return function(S,D){return p===void 0&&(p=new hi),_=S.dot(D)+1,_<A?(_=0,Math.abs(S.x)>Math.abs(S.z)?p.set(-S.y,S.x,0):p.set(0,-S.z,S.y)):p.crossVectors(S,D),this.x=p.x,this.y=p.y,this.z=p.z,this.w=_,this.normalize(),this}}()};function bd(p){this.width=p.width||bt(),this.height=p.height||St(),this.widthMeters=p.widthMeters,this.heightMeters=p.heightMeters,this.bevelMeters=p.bevelMeters}var DA=new bd({widthMeters:.11,heightMeters:.062,bevelMeters:.004}),LA=new bd({widthMeters:.1038,heightMeters:.0584,bevelMeters:.004}),xd={CardboardV1:new yd({id:"CardboardV1",label:"Cardboard I/O 2014",fov:40,interLensDistance:.06,baselineLensDistance:.035,screenLensDistance:.042,distortionCoefficients:[.441,.156],inverseCoefficients:[-.4410035,.42756155,-.4804439,.5460139,-.58821183,.5733938,-.48303202,.33299083,-.17573841,.0651772,-.01488963,.001559834]}),CardboardV2:new yd({id:"CardboardV2",label:"Cardboard I/O 2015",fov:60,interLensDistance:.064,baselineLensDistance:.035,screenLensDistance:.039,distortionCoefficients:[.34,.55],inverseCoefficients:[-.33836704,-.18162185,.862655,-1.2462051,1.0560602,-.58208317,.21609078,-.05444823,.009177956,-.0009904169,6183535e-11,-16981803e-13]})};function Ei(p,_){this.viewer=xd.CardboardV2,this.updateDeviceParams(p),this.distortion=new uc(this.viewer.distortionCoefficients);for(var A=0;A<_.length;A++){var S=_[A];xd[S.id]=new yd(S)}}Ei.prototype.updateDeviceParams=function(p){this.device=this.determineDevice_(p)||this.device},Ei.prototype.getDevice=function(){return this.device},Ei.prototype.setViewer=function(p){this.viewer=p,this.distortion=new uc(this.viewer.distortionCoefficients)},Ei.prototype.determineDevice_=function(p){if(!p)return ge()?(console.warn("Using fallback iOS device measurements."),LA):(console.warn("Using fallback Android device measurements."),DA);var _=.0254,A=_/p.xdpi,S=_/p.ydpi,D=bt(),W=St();return new bd({widthMeters:A*D,heightMeters:S*W,bevelMeters:p.bevelMm*.001})},Ei.prototype.getDistortedFieldOfViewLeftEye=function(){var p=this.viewer,_=this.device,A=this.distortion,S=p.screenLensDistance,D=(_.widthMeters-p.interLensDistance)/2,W=p.interLensDistance/2,j=p.baselineLensDistance-_.bevelMeters,fe=_.heightMeters-j,me=_s*Math.atan(A.distort(D/S)),Q=_s*Math.atan(A.distort(W/S)),se=_s*Math.atan(A.distort(j/S)),Ae=_s*Math.atan(A.distort(fe/S));return{leftDegrees:Math.min(me,p.fov),rightDegrees:Math.min(Q,p.fov),downDegrees:Math.min(se,p.fov),upDegrees:Math.min(Ae,p.fov)}},Ei.prototype.getLeftEyeVisibleTanAngles=function(){var p=this.viewer,_=this.device,A=this.distortion,S=Math.tan(-ps*p.fov),D=Math.tan(ps*p.fov),W=Math.tan(ps*p.fov),j=Math.tan(-ps*p.fov),fe=_.widthMeters/4,me=_.heightMeters/2,Q=p.baselineLensDistance-_.bevelMeters-me,se=p.interLensDistance/2-fe,Ae=-Q,qe=p.screenLensDistance,Je=A.distort((se-fe)/qe),rt=A.distort((Ae+me)/qe),yt=A.distort((se+fe)/qe),ut=A.distort((Ae-me)/qe),ht=new Float32Array(4);return ht[0]=Math.max(S,Je),ht[1]=Math.min(D,rt),ht[2]=Math.min(W,yt),ht[3]=Math.max(j,ut),ht},Ei.prototype.getLeftEyeNoLensTanAngles=function(){var p=this.viewer,_=this.device,A=this.distortion,S=new Float32Array(4),D=A.distortInverse(Math.tan(-ps*p.fov)),W=A.distortInverse(Math.tan(ps*p.fov)),j=A.distortInverse(Math.tan(ps*p.fov)),fe=A.distortInverse(Math.tan(-ps*p.fov)),me=_.widthMeters/4,Q=_.heightMeters/2,se=p.baselineLensDistance-_.bevelMeters-Q,Ae=p.interLensDistance/2-me,qe=-se,Je=p.screenLensDistance,rt=(Ae-me)/Je,yt=(qe+Q)/Je,ut=(Ae+me)/Je,ht=(qe-Q)/Je;return S[0]=Math.max(D,rt),S[1]=Math.min(W,yt),S[2]=Math.min(j,ut),S[3]=Math.max(fe,ht),S},Ei.prototype.getLeftEyeVisibleScreenRect=function(p){var _=this.viewer,A=this.device,S=_.screenLensDistance,D=(A.widthMeters-_.interLensDistance)/2,W=_.baselineLensDistance-A.bevelMeters,j=(p[0]*S+D)/A.widthMeters,fe=(p[1]*S+W)/A.heightMeters,me=(p[2]*S+D)/A.widthMeters,Q=(p[3]*S+W)/A.heightMeters;return{x:j,y:Q,width:me-j,height:fe-Q}},Ei.prototype.getFieldOfViewLeftEye=function(p){return p?this.getUndistortedFieldOfViewLeftEye():this.getDistortedFieldOfViewLeftEye()},Ei.prototype.getFieldOfViewRightEye=function(p){var _=this.getFieldOfViewLeftEye(p);return{leftDegrees:_.rightDegrees,rightDegrees:_.leftDegrees,upDegrees:_.upDegrees,downDegrees:_.downDegrees}},Ei.prototype.getUndistortedFieldOfViewLeftEye=function(){var p=this.getUndistortedParams_();return{leftDegrees:_s*Math.atan(p.outerDist),rightDegrees:_s*Math.atan(p.innerDist),downDegrees:_s*Math.atan(p.bottomDist),upDegrees:_s*Math.atan(p.topDist)}},Ei.prototype.getUndistortedViewportLeftEye=function(){var p=this.getUndistortedParams_(),_=this.viewer,A=this.device,S=_.screenLensDistance,D=A.widthMeters/S,W=A.heightMeters/S,j=A.width/D,fe=A.height/W,me=Math.round((p.eyePosX-p.outerDist)*j),Q=Math.round((p.eyePosY-p.bottomDist)*fe);return{x:me,y:Q,width:Math.round((p.eyePosX+p.innerDist)*j)-me,height:Math.round((p.eyePosY+p.topDist)*fe)-Q}},Ei.prototype.getUndistortedParams_=function(){var p=this.viewer,_=this.device,A=this.distortion,S=p.screenLensDistance,D=p.interLensDistance/2/S,W=_.widthMeters/S,j=_.heightMeters/S,fe=W/2-D,me=(p.baselineLensDistance-_.bevelMeters)/S,Q=p.fov,se=A.distortInverse(Math.tan(ps*Q)),Ae=Math.min(fe,se),qe=Math.min(D,se),Je=Math.min(me,se),rt=Math.min(j-me,se);return{outerDist:Ae,innerDist:qe,topDist:rt,bottomDist:Je,eyePosX:fe,eyePosY:me}};function yd(p){this.id=p.id,this.label=p.label,this.fov=p.fov,this.interLensDistance=p.interLensDistance,this.baselineLensDistance=p.baselineLensDistance,this.screenLensDistance=p.screenLensDistance,this.distortionCoefficients=p.distortionCoefficients,this.inverseCoefficients=p.inverseCoefficients}Ei.Viewers=xd;var FA=1,OA="2019-11-09T17:36:14Z",BA=[{type:"android",rules:[{mdmh:"asus/*/Nexus 7/*"},{ua:"Nexus 7"}],dpi:[320.8,323],bw:3,ac:500},{type:"android",rules:[{mdmh:"asus/*/ASUS_X00PD/*"},{ua:"ASUS_X00PD"}],dpi:245,bw:3,ac:500},{type:"android",rules:[{mdmh:"asus/*/ASUS_X008D/*"},{ua:"ASUS_X008D"}],dpi:282,bw:3,ac:500},{type:"android",rules:[{mdmh:"asus/*/ASUS_Z00AD/*"},{ua:"ASUS_Z00AD"}],dpi:[403,404.6],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"Google/*/Pixel 2 XL/*"},{ua:"Pixel 2 XL"}],dpi:537.9,bw:3,ac:1e3},{type:"android",rules:[{mdmh:"Google/*/Pixel 3 XL/*"},{ua:"Pixel 3 XL"}],dpi:[558.5,553.8],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"Google/*/Pixel XL/*"},{ua:"Pixel XL"}],dpi:[537.9,533],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"Google/*/Pixel 3/*"},{ua:"Pixel 3"}],dpi:442.4,bw:3,ac:1e3},{type:"android",rules:[{mdmh:"Google/*/Pixel 2/*"},{ua:"Pixel 2"}],dpi:441,bw:3,ac:500},{type:"android",rules:[{mdmh:"Google/*/Pixel/*"},{ua:"Pixel"}],dpi:[432.6,436.7],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"HTC/*/HTC6435LVW/*"},{ua:"HTC6435LVW"}],dpi:[449.7,443.3],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"HTC/*/HTC One XL/*"},{ua:"HTC One XL"}],dpi:[315.3,314.6],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"htc/*/Nexus 9/*"},{ua:"Nexus 9"}],dpi:289,bw:3,ac:500},{type:"android",rules:[{mdmh:"HTC/*/HTC One M9/*"},{ua:"HTC One M9"}],dpi:[442.5,443.3],bw:3,ac:500},{type:"android",rules:[{mdmh:"HTC/*/HTC One_M8/*"},{ua:"HTC One_M8"}],dpi:[449.7,447.4],bw:3,ac:500},{type:"android",rules:[{mdmh:"HTC/*/HTC One/*"},{ua:"HTC One"}],dpi:472.8,bw:3,ac:1e3},{type:"android",rules:[{mdmh:"Huawei/*/Nexus 6P/*"},{ua:"Nexus 6P"}],dpi:[515.1,518],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"Huawei/*/BLN-L24/*"},{ua:"HONORBLN-L24"}],dpi:480,bw:4,ac:500},{type:"android",rules:[{mdmh:"Huawei/*/BKL-L09/*"},{ua:"BKL-L09"}],dpi:403,bw:3.47,ac:500},{type:"android",rules:[{mdmh:"LENOVO/*/Lenovo PB2-690Y/*"},{ua:"Lenovo PB2-690Y"}],dpi:[457.2,454.713],bw:3,ac:500},{type:"android",rules:[{mdmh:"LGE/*/Nexus 5X/*"},{ua:"Nexus 5X"}],dpi:[422,419.9],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"LGE/*/LGMS345/*"},{ua:"LGMS345"}],dpi:[221.7,219.1],bw:3,ac:500},{type:"android",rules:[{mdmh:"LGE/*/LG-D800/*"},{ua:"LG-D800"}],dpi:[422,424.1],bw:3,ac:500},{type:"android",rules:[{mdmh:"LGE/*/LG-D850/*"},{ua:"LG-D850"}],dpi:[537.9,541.9],bw:3,ac:500},{type:"android",rules:[{mdmh:"LGE/*/VS985 4G/*"},{ua:"VS985 4G"}],dpi:[537.9,535.6],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"LGE/*/Nexus 5/*"},{ua:"Nexus 5 B"}],dpi:[442.4,444.8],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"LGE/*/Nexus 4/*"},{ua:"Nexus 4"}],dpi:[319.8,318.4],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"LGE/*/LG-P769/*"},{ua:"LG-P769"}],dpi:[240.6,247.5],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"LGE/*/LGMS323/*"},{ua:"LGMS323"}],dpi:[206.6,204.6],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"LGE/*/LGLS996/*"},{ua:"LGLS996"}],dpi:[403.4,401.5],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"Micromax/*/4560MMX/*"},{ua:"4560MMX"}],dpi:[240,219.4],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"Micromax/*/A250/*"},{ua:"Micromax A250"}],dpi:[480,446.4],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"Micromax/*/Micromax AQ4501/*"},{ua:"Micromax AQ4501"}],dpi:240,bw:3,ac:500},{type:"android",rules:[{mdmh:"motorola/*/G5/*"},{ua:"Moto G (5) Plus"}],dpi:[403.4,403],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"motorola/*/DROID RAZR/*"},{ua:"DROID RAZR"}],dpi:[368.1,256.7],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"motorola/*/XT830C/*"},{ua:"XT830C"}],dpi:[254,255.9],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"motorola/*/XT1021/*"},{ua:"XT1021"}],dpi:[254,256.7],bw:3,ac:500},{type:"android",rules:[{mdmh:"motorola/*/XT1023/*"},{ua:"XT1023"}],dpi:[254,256.7],bw:3,ac:500},{type:"android",rules:[{mdmh:"motorola/*/XT1028/*"},{ua:"XT1028"}],dpi:[326.6,327.6],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"motorola/*/XT1034/*"},{ua:"XT1034"}],dpi:[326.6,328.4],bw:3,ac:500},{type:"android",rules:[{mdmh:"motorola/*/XT1053/*"},{ua:"XT1053"}],dpi:[315.3,316.1],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"motorola/*/XT1562/*"},{ua:"XT1562"}],dpi:[403.4,402.7],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"motorola/*/Nexus 6/*"},{ua:"Nexus 6 B"}],dpi:[494.3,489.7],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"motorola/*/XT1063/*"},{ua:"XT1063"}],dpi:[295,296.6],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"motorola/*/XT1064/*"},{ua:"XT1064"}],dpi:[295,295.6],bw:3,ac:500},{type:"android",rules:[{mdmh:"motorola/*/XT1092/*"},{ua:"XT1092"}],dpi:[422,424.1],bw:3,ac:500},{type:"android",rules:[{mdmh:"motorola/*/XT1095/*"},{ua:"XT1095"}],dpi:[422,423.4],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"motorola/*/G4/*"},{ua:"Moto G (4)"}],dpi:401,bw:4,ac:1e3},{type:"android",rules:[{mdmh:"OnePlus/*/A0001/*"},{ua:"A0001"}],dpi:[403.4,401],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"OnePlus/*/ONE E1001/*"},{ua:"ONE E1001"}],dpi:[442.4,441.4],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"OnePlus/*/ONE E1003/*"},{ua:"ONE E1003"}],dpi:[442.4,441.4],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"OnePlus/*/ONE E1005/*"},{ua:"ONE E1005"}],dpi:[442.4,441.4],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"OnePlus/*/ONE A2001/*"},{ua:"ONE A2001"}],dpi:[391.9,405.4],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"OnePlus/*/ONE A2003/*"},{ua:"ONE A2003"}],dpi:[391.9,405.4],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"OnePlus/*/ONE A2005/*"},{ua:"ONE A2005"}],dpi:[391.9,405.4],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"OnePlus/*/ONEPLUS A3000/*"},{ua:"ONEPLUS A3000"}],dpi:401,bw:3,ac:500},{type:"android",rules:[{mdmh:"OnePlus/*/ONEPLUS A3003/*"},{ua:"ONEPLUS A3003"}],dpi:401,bw:3,ac:500},{type:"android",rules:[{mdmh:"OnePlus/*/ONEPLUS A3010/*"},{ua:"ONEPLUS A3010"}],dpi:401,bw:3,ac:500},{type:"android",rules:[{mdmh:"OnePlus/*/ONEPLUS A5000/*"},{ua:"ONEPLUS A5000 "}],dpi:[403.411,399.737],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"OnePlus/*/ONE A5010/*"},{ua:"ONEPLUS A5010"}],dpi:[403,400],bw:2,ac:1e3},{type:"android",rules:[{mdmh:"OnePlus/*/ONEPLUS A6000/*"},{ua:"ONEPLUS A6000"}],dpi:401,bw:3,ac:500},{type:"android",rules:[{mdmh:"OnePlus/*/ONEPLUS A6003/*"},{ua:"ONEPLUS A6003"}],dpi:401,bw:3,ac:500},{type:"android",rules:[{mdmh:"OnePlus/*/ONEPLUS A6010/*"},{ua:"ONEPLUS A6010"}],dpi:401,bw:2,ac:500},{type:"android",rules:[{mdmh:"OnePlus/*/ONEPLUS A6013/*"},{ua:"ONEPLUS A6013"}],dpi:401,bw:2,ac:500},{type:"android",rules:[{mdmh:"OPPO/*/X909/*"},{ua:"X909"}],dpi:[442.4,444.1],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/GT-I9082/*"},{ua:"GT-I9082"}],dpi:[184.7,185.4],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-G360P/*"},{ua:"SM-G360P"}],dpi:[196.7,205.4],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/Nexus S/*"},{ua:"Nexus S"}],dpi:[234.5,229.8],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/GT-I9300/*"},{ua:"GT-I9300"}],dpi:[304.8,303.9],bw:5,ac:500},{type:"android",rules:[{mdmh:"samsung/*/SM-T230NU/*"},{ua:"SM-T230NU"}],dpi:216,bw:3,ac:500},{type:"android",rules:[{mdmh:"samsung/*/SGH-T399/*"},{ua:"SGH-T399"}],dpi:[217.7,231.4],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SGH-M919/*"},{ua:"SGH-M919"}],dpi:[440.8,437.7],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-N9005/*"},{ua:"SM-N9005"}],dpi:[386.4,387],bw:3,ac:500},{type:"android",rules:[{mdmh:"samsung/*/SAMSUNG-SM-N900A/*"},{ua:"SAMSUNG-SM-N900A"}],dpi:[386.4,387.7],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/GT-I9500/*"},{ua:"GT-I9500"}],dpi:[442.5,443.3],bw:3,ac:500},{type:"android",rules:[{mdmh:"samsung/*/GT-I9505/*"},{ua:"GT-I9505"}],dpi:439.4,bw:4,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-G900F/*"},{ua:"SM-G900F"}],dpi:[415.6,431.6],bw:5,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-G900M/*"},{ua:"SM-G900M"}],dpi:[415.6,431.6],bw:5,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-G800F/*"},{ua:"SM-G800F"}],dpi:326.8,bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-G906S/*"},{ua:"SM-G906S"}],dpi:[562.7,572.4],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/GT-I9300/*"},{ua:"GT-I9300"}],dpi:[306.7,304.8],bw:5,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-T535/*"},{ua:"SM-T535"}],dpi:[142.6,136.4],bw:3,ac:500},{type:"android",rules:[{mdmh:"samsung/*/SM-N920C/*"},{ua:"SM-N920C"}],dpi:[515.1,518.4],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-N920P/*"},{ua:"SM-N920P"}],dpi:[386.3655,390.144],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-N920W8/*"},{ua:"SM-N920W8"}],dpi:[515.1,518.4],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/GT-I9300I/*"},{ua:"GT-I9300I"}],dpi:[304.8,305.8],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/GT-I9195/*"},{ua:"GT-I9195"}],dpi:[249.4,256.7],bw:3,ac:500},{type:"android",rules:[{mdmh:"samsung/*/SPH-L520/*"},{ua:"SPH-L520"}],dpi:[249.4,255.9],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SAMSUNG-SGH-I717/*"},{ua:"SAMSUNG-SGH-I717"}],dpi:285.8,bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SPH-D710/*"},{ua:"SPH-D710"}],dpi:[217.7,204.2],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/GT-N7100/*"},{ua:"GT-N7100"}],dpi:265.1,bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SCH-I605/*"},{ua:"SCH-I605"}],dpi:265.1,bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/Galaxy Nexus/*"},{ua:"Galaxy Nexus"}],dpi:[315.3,314.2],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-N910H/*"},{ua:"SM-N910H"}],dpi:[515.1,518],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-N910C/*"},{ua:"SM-N910C"}],dpi:[515.2,520.2],bw:3,ac:500},{type:"android",rules:[{mdmh:"samsung/*/SM-G130M/*"},{ua:"SM-G130M"}],dpi:[165.9,164.8],bw:3,ac:500},{type:"android",rules:[{mdmh:"samsung/*/SM-G928I/*"},{ua:"SM-G928I"}],dpi:[515.1,518.4],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-G920F/*"},{ua:"SM-G920F"}],dpi:580.6,bw:3,ac:500},{type:"android",rules:[{mdmh:"samsung/*/SM-G920P/*"},{ua:"SM-G920P"}],dpi:[522.5,577],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-G925F/*"},{ua:"SM-G925F"}],dpi:580.6,bw:3,ac:500},{type:"android",rules:[{mdmh:"samsung/*/SM-G925V/*"},{ua:"SM-G925V"}],dpi:[522.5,576.6],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-G930F/*"},{ua:"SM-G930F"}],dpi:576.6,bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-G935F/*"},{ua:"SM-G935F"}],dpi:533,bw:3,ac:500},{type:"android",rules:[{mdmh:"samsung/*/SM-G950F/*"},{ua:"SM-G950F"}],dpi:[562.707,565.293],bw:3,ac:500},{type:"android",rules:[{mdmh:"samsung/*/SM-G955U/*"},{ua:"SM-G955U"}],dpi:[522.514,525.762],bw:3,ac:500},{type:"android",rules:[{mdmh:"samsung/*/SM-G955F/*"},{ua:"SM-G955F"}],dpi:[522.514,525.762],bw:3,ac:500},{type:"android",rules:[{mdmh:"samsung/*/SM-G960F/*"},{ua:"SM-G960F"}],dpi:[569.575,571.5],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-G9600/*"},{ua:"SM-G9600"}],dpi:[569.575,571.5],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-G960T/*"},{ua:"SM-G960T"}],dpi:[569.575,571.5],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-G960N/*"},{ua:"SM-G960N"}],dpi:[569.575,571.5],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-G960U/*"},{ua:"SM-G960U"}],dpi:[569.575,571.5],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-G9608/*"},{ua:"SM-G9608"}],dpi:[569.575,571.5],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-G960FD/*"},{ua:"SM-G960FD"}],dpi:[569.575,571.5],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-G960W/*"},{ua:"SM-G960W"}],dpi:[569.575,571.5],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-G965F/*"},{ua:"SM-G965F"}],dpi:529,bw:2,ac:1e3},{type:"android",rules:[{mdmh:"Sony/*/C6903/*"},{ua:"C6903"}],dpi:[442.5,443.3],bw:3,ac:500},{type:"android",rules:[{mdmh:"Sony/*/D6653/*"},{ua:"D6653"}],dpi:[428.6,427.6],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"Sony/*/E6653/*"},{ua:"E6653"}],dpi:[428.6,425.7],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"Sony/*/E6853/*"},{ua:"E6853"}],dpi:[403.4,401.9],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"Sony/*/SGP321/*"},{ua:"SGP321"}],dpi:[224.7,224.1],bw:3,ac:500},{type:"android",rules:[{mdmh:"TCT/*/ALCATEL ONE TOUCH Fierce/*"},{ua:"ALCATEL ONE TOUCH Fierce"}],dpi:[240,247.5],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"THL/*/thl 5000/*"},{ua:"thl 5000"}],dpi:[480,443.3],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"Fly/*/IQ4412/*"},{ua:"IQ4412"}],dpi:307.9,bw:3,ac:1e3},{type:"android",rules:[{mdmh:"ZTE/*/ZTE Blade L2/*"},{ua:"ZTE Blade L2"}],dpi:240,bw:3,ac:500},{type:"android",rules:[{mdmh:"BENEVE/*/VR518/*"},{ua:"VR518"}],dpi:480,bw:3,ac:500},{type:"ios",rules:[{res:[640,960]}],dpi:[325.1,328.4],bw:4,ac:1e3},{type:"ios",rules:[{res:[640,1136]}],dpi:[317.1,320.2],bw:3,ac:1e3},{type:"ios",rules:[{res:[750,1334]}],dpi:326.4,bw:4,ac:1e3},{type:"ios",rules:[{res:[1242,2208]}],dpi:[453.6,458.4],bw:4,ac:1e3},{type:"ios",rules:[{res:[1125,2001]}],dpi:[410.9,415.4],bw:4,ac:1e3},{type:"ios",rules:[{res:[1125,2436]}],dpi:458,bw:4,ac:1e3},{type:"android",rules:[{mdmh:"Huawei/*/EML-L29/*"},{ua:"EML-L29"}],dpi:428,bw:3.45,ac:500},{type:"android",rules:[{mdmh:"Nokia/*/Nokia 7.1/*"},{ua:"Nokia 7.1"}],dpi:[432,431.9],bw:3,ac:500},{type:"ios",rules:[{res:[1242,2688]}],dpi:458,bw:4,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-G570M/*"},{ua:"SM-G570M"}],dpi:320,bw:3.684,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-G970F/*"},{ua:"SM-G970F"}],dpi:438,bw:2.281,ac:500},{type:"android",rules:[{mdmh:"samsung/*/SM-G973F/*"},{ua:"SM-G973F"}],dpi:550,bw:2.002,ac:500},{type:"android",rules:[{mdmh:"samsung/*/SM-G975F/*"},{ua:"SM-G975F"}],dpi:522,bw:2.054,ac:500},{type:"android",rules:[{mdmh:"samsung/*/SM-G977F/*"},{ua:"SM-G977F"}],dpi:505,bw:2.334,ac:500},{type:"ios",rules:[{res:[828,1792]}],dpi:326,bw:5,ac:500}],UA={format:FA,last_updated:OA,devices:BA};function Ea(p,_){if(this.dpdb=UA,this.recalculateDeviceParams_(),p){this.onDeviceParamsUpdated=_;var A=new XMLHttpRequest,S=this;A.open("GET",p,!0),A.addEventListener("load",function(){S.loading=!1,A.status>=200&&A.status<=299?(S.dpdb=JSON.parse(A.response),S.recalculateDeviceParams_()):console.error("Error loading online DPDB!")}),A.send()}}Ea.prototype.getDeviceParams=function(){return this.deviceParams},Ea.prototype.recalculateDeviceParams_=function(){var p=this.calcDeviceParams_();p?(this.deviceParams=p,this.onDeviceParamsUpdated&&this.onDeviceParamsUpdated(this.deviceParams)):console.error("Failed to recalculate device parameters.")},Ea.prototype.calcDeviceParams_=function(){var p=this.dpdb;if(!p)return console.error("DPDB not available."),null;if(p.format!=1)return console.error("DPDB has unexpected format version."),null;if(!p.devices||!p.devices.length)return console.error("DPDB does not have a devices section."),null;var _=navigator.userAgent||navigator.vendor||window.opera,A=bt(),S=St();if(!p.devices)return console.error("DPDB has no devices section."),null;for(var D=0;D<p.devices.length;D++){var W=p.devices[D];if(!W.rules){console.warn("Device["+D+"] has no rules section.");continue}if(W.type!="ios"&&W.type!="android"){console.warn("Device["+D+"] has invalid type.");continue}if(ge()==(W.type=="ios")){for(var j=!1,fe=0;fe<W.rules.length;fe++){var me=W.rules[fe];if(this.ruleMatches_(me,_,A,S)){j=!0;break}}if(j){var Q=W.dpi[0]||W.dpi,se=W.dpi[1]||W.dpi;return new NA({xdpi:Q,ydpi:se,bevelMm:W.bw})}}}return console.warn("No DPDB device match."),null},Ea.prototype.ruleMatches_=function(p,_,A,S){if(!p.ua&&!p.res||(p.ua&&p.ua.substring(0,2)==="SM"&&(p.ua=p.ua.substring(0,7)),p.ua&&_.indexOf(p.ua)<0))return!1;if(p.res){if(!p.res[0]||!p.res[1])return!1;var D=p.res[0],W=p.res[1];if(Math.min(A,S)!=Math.min(D,W)||Math.max(A,S)!=Math.max(D,W))return!1}return!0};function NA(p){this.xdpi=p.xdpi,this.ydpi=p.ydpi,this.bevelMm=p.bevelMm}function Ta(p,_){this.set(p,_)}Ta.prototype.set=function(p,_){this.sample=p,this.timestampS=_},Ta.prototype.copy=function(p){this.set(p.sample,p.timestampS)};function ko(p,_){this.kFilter=p,this.isDebug=_,this.currentAccelMeasurement=new Ta,this.currentGyroMeasurement=new Ta,this.previousGyroMeasurement=new Ta,ge()?this.filterQ=new Bt(-1,0,0,1):this.filterQ=new Bt(1,0,0,1),this.previousFilterQ=new Bt,this.previousFilterQ.copy(this.filterQ),this.accelQ=new Bt,this.isOrientationInitialized=!1,this.estimatedGravity=new hi,this.measuredGravity=new hi,this.gyroIntegralQ=new Bt}ko.prototype.addAccelMeasurement=function(p,_){this.currentAccelMeasurement.set(p,_)},ko.prototype.addGyroMeasurement=function(p,_){this.currentGyroMeasurement.set(p,_);var A=_-this.previousGyroMeasurement.timestampS;ki(A)&&this.run_(),this.previousGyroMeasurement.copy(this.currentGyroMeasurement)},ko.prototype.run_=function(){if(!this.isOrientationInitialized){this.accelQ=this.accelToQuaternion_(this.currentAccelMeasurement.sample),this.previousFilterQ.copy(this.accelQ),this.isOrientationInitialized=!0;return}var p=this.currentGyroMeasurement.timestampS-this.previousGyroMeasurement.timestampS,_=this.gyroToQuaternionDelta_(this.currentGyroMeasurement.sample,p);this.gyroIntegralQ.multiply(_),this.filterQ.copy(this.previousFilterQ),this.filterQ.multiply(_);var A=new Bt;A.copy(this.filterQ),A.inverse(),this.estimatedGravity.set(0,0,-1),this.estimatedGravity.applyQuaternion(A),this.estimatedGravity.normalize(),this.measuredGravity.copy(this.currentAccelMeasurement.sample),this.measuredGravity.normalize();var S=new Bt;S.setFromUnitVectors(this.estimatedGravity,this.measuredGravity),S.inverse(),this.isDebug&&console.log("Delta: %d deg, G_est: (%s, %s, %s), G_meas: (%s, %s, %s)",_s*SA(S),this.estimatedGravity.x.toFixed(1),this.estimatedGravity.y.toFixed(1),this.estimatedGravity.z.toFixed(1),this.measuredGravity.x.toFixed(1),this.measuredGravity.y.toFixed(1),this.measuredGravity.z.toFixed(1));var D=new Bt;D.copy(this.filterQ),D.multiply(S),this.filterQ.slerp(D,1-this.kFilter),this.previousFilterQ.copy(this.filterQ)},ko.prototype.getOrientation=function(){return this.filterQ},ko.prototype.accelToQuaternion_=function(p){var _=new hi;_.copy(p),_.normalize();var A=new Bt;return A.setFromUnitVectors(new hi(0,0,-1),_),A.inverse(),A},ko.prototype.gyroToQuaternionDelta_=function(p,_){var A=new Bt,S=new hi;return S.copy(p),S.normalize(),A.setFromAxisAngle(S,p.length()*_),A};function yp(p,_){this.predictionTimeS=p,this.isDebug=_,this.previousQ=new Bt,this.previousTimestampS=null,this.deltaQ=new Bt,this.outQ=new Bt}yp.prototype.getPrediction=function(p,_,A){if(!this.previousTimestampS)return this.previousQ.copy(p),this.previousTimestampS=A,p;var S=new hi;S.copy(_),S.normalize();var D=_.length();if(D<ps*20)return this.isDebug&&console.log("Moving slowly, at %s deg/s: no prediction",(_s*D).toFixed(1)),this.outQ.copy(p),this.previousQ.copy(p),this.outQ;var W=D*this.predictionTimeS;return this.deltaQ.setFromAxisAngle(S,W),this.outQ.copy(this.previousQ),this.outQ.multiply(this.deltaQ),this.previousQ.copy(p),this.previousTimestampS=A,this.outQ};function In(p,_,A,S){this.yawOnly=A,this.accelerometer=new hi,this.gyroscope=new hi,this.filter=new ko(p,S),this.posePredictor=new yp(_,S),this.isFirefoxAndroid=Ft(),this.isIOS=ge();var D=kt();this.isDeviceMotionInRadians=!this.isIOS&&D&&D<66,this.isWithoutDeviceMotion=zt()||Zt(),this.filterToWorldQ=new Bt,ge()?this.filterToWorldQ.setFromAxisAngle(new hi(1,0,0),Math.PI/2):this.filterToWorldQ.setFromAxisAngle(new hi(1,0,0),-Math.PI/2),this.inverseWorldToScreenQ=new Bt,this.worldToScreenQ=new Bt,this.originalPoseAdjustQ=new Bt,this.originalPoseAdjustQ.setFromAxisAngle(new hi(0,0,1),-window.orientation*Math.PI/180),this.setScreenTransform_(),ci()&&this.filterToWorldQ.multiply(this.inverseWorldToScreenQ),this.resetQ=new Bt,this.orientationOut_=new Float32Array(4),this.start()}In.prototype.getPosition=function(){return null},In.prototype.getOrientation=function(){var p=void 0;if(this.isWithoutDeviceMotion&&this._deviceOrientationQ){this.deviceOrientationFixQ=this.deviceOrientationFixQ||function(){var D=new Bt().setFromAxisAngle(new hi(0,0,-1),0),W=new Bt;return window.orientation===-90?W.setFromAxisAngle(new hi(0,1,0),Math.PI/-2):W.setFromAxisAngle(new hi(0,1,0),Math.PI/2),D.multiply(W)}(),this.deviceOrientationFilterToWorldQ=this.deviceOrientationFilterToWorldQ||function(){var D=new Bt;return D.setFromAxisAngle(new hi(1,0,0),-Math.PI/2),D}(),p=this._deviceOrientationQ;var A=new Bt;return A.copy(p),A.multiply(this.deviceOrientationFilterToWorldQ),A.multiply(this.resetQ),A.multiply(this.worldToScreenQ),A.multiplyQuaternions(this.deviceOrientationFixQ,A),this.yawOnly&&(A.x=0,A.z=0,A.normalize()),this.orientationOut_[0]=A.x,this.orientationOut_[1]=A.y,this.orientationOut_[2]=A.z,this.orientationOut_[3]=A.w,this.orientationOut_}else{var _=this.filter.getOrientation();p=this.posePredictor.getPrediction(_,this.gyroscope,this.previousTimestampS)}var A=new Bt;return A.copy(this.filterToWorldQ),A.multiply(this.resetQ),A.multiply(p),A.multiply(this.worldToScreenQ),this.yawOnly&&(A.x=0,A.z=0,A.normalize()),this.orientationOut_[0]=A.x,this.orientationOut_[1]=A.y,this.orientationOut_[2]=A.z,this.orientationOut_[3]=A.w,this.orientationOut_},In.prototype.resetPose=function(){this.resetQ.copy(this.filter.getOrientation()),this.resetQ.x=0,this.resetQ.y=0,this.resetQ.z*=-1,this.resetQ.normalize(),ci()&&this.resetQ.multiply(this.inverseWorldToScreenQ),this.resetQ.multiply(this.originalPoseAdjustQ)},In.prototype.onDeviceOrientation_=function(p){this._deviceOrientationQ=this._deviceOrientationQ||new Bt;var _=p.alpha,A=p.beta,S=p.gamma;_=(_||0)*Math.PI/180,A=(A||0)*Math.PI/180,S=(S||0)*Math.PI/180,this._deviceOrientationQ.setFromEulerYXZ(A,_,-S)},In.prototype.onDeviceMotion_=function(p){this.updateDeviceMotion_(p)},In.prototype.updateDeviceMotion_=function(p){var _=p.accelerationIncludingGravity,A=p.rotationRate,S=p.timeStamp/1e3,D=S-this.previousTimestampS;if(D<0){pd("fusion-pose-sensor:invalid:non-monotonic","Invalid timestamps detected: non-monotonic timestamp from devicemotion"),this.previousTimestampS=S;return}else if(D<=Y||D>ee){pd("fusion-pose-sensor:invalid:outside-threshold","Invalid timestamps detected: Timestamp from devicemotion outside expected range."),this.previousTimestampS=S;return}this.accelerometer.set(-_.x,-_.y,-_.z),A&&(Ot()?this.gyroscope.set(-A.beta,A.alpha,A.gamma):this.gyroscope.set(A.alpha,A.beta,A.gamma),this.isDeviceMotionInRadians||this.gyroscope.multiplyScalar(Math.PI/180),this.filter.addGyroMeasurement(this.gyroscope,S)),this.filter.addAccelMeasurement(this.accelerometer,S),this.previousTimestampS=S},In.prototype.onOrientationChange_=function(p){this.setScreenTransform_()},In.prototype.onMessage_=function(p){var _=p.data;if(!(!_||!_.type)){var A=_.type.toLowerCase();A==="devicemotion"&&this.updateDeviceMotion_(_.deviceMotionEvent)}},In.prototype.setScreenTransform_=function(){switch(this.worldToScreenQ.set(0,0,0,1),window.orientation){case 0:break;case 90:this.worldToScreenQ.setFromAxisAngle(new hi(0,0,1),-Math.PI/2);break;case-90:this.worldToScreenQ.setFromAxisAngle(new hi(0,0,1),Math.PI/2);break;case 180:break}this.inverseWorldToScreenQ.copy(this.worldToScreenQ),this.inverseWorldToScreenQ.inverse()},In.prototype.start=function(){this.onDeviceMotionCallback_=this.onDeviceMotion_.bind(this),this.onOrientationChangeCallback_=this.onOrientationChange_.bind(this),this.onMessageCallback_=this.onMessage_.bind(this),this.onDeviceOrientationCallback_=this.onDeviceOrientation_.bind(this),ge()&&TA()&&window.addEventListener("message",this.onMessageCallback_),window.addEventListener("orientationchange",this.onOrientationChangeCallback_),this.isWithoutDeviceMotion?window.addEventListener("deviceorientation",this.onDeviceOrientationCallback_):window.addEventListener("devicemotion",this.onDeviceMotionCallback_)},In.prototype.stop=function(){window.removeEventListener("devicemotion",this.onDeviceMotionCallback_),window.removeEventListener("deviceorientation",this.onDeviceOrientationCallback_),window.removeEventListener("orientationchange",this.onOrientationChangeCallback_),window.removeEventListener("message",this.onMessageCallback_)};var kA=60,zA=new hi(1,0,0),VA=new hi(0,0,1),Ad=new Bt;Ad.setFromAxisAngle(zA,-Math.PI/2),Ad.multiply(new Bt().setFromAxisAngle(VA,Math.PI/2));var GA=function(){function p(_){T(this,p),this.config=_,this.sensor=null,this.fusionSensor=null,this._out=new Float32Array(4),this.api=null,this.errors=[],this._sensorQ=new Bt,this._outQ=new Bt,this._onSensorRead=this._onSensorRead.bind(this),this._onSensorError=this._onSensorError.bind(this),this.init()}return P(p,[{key:"init",value:function(){var A=null;try{A=new RelativeOrientationSensor({frequency:kA,referenceFrame:"screen"}),A.addEventListener("error",this._onSensorError)}catch(S){this.errors.push(S),S.name==="SecurityError"?(console.error("Cannot construct sensors due to the Feature Policy"),console.warn('Attempting to fall back using "devicemotion"; however this will fail in the future without correct permissions.'),this.useDeviceMotion()):S.name==="ReferenceError"?this.useDeviceMotion():console.error(S)}A&&(this.api="sensor",this.sensor=A,this.sensor.addEventListener("reading",this._onSensorRead),this.sensor.start())}},{key:"useDeviceMotion",value:function(){this.api="devicemotion",this.fusionSensor=new In(this.config.K_FILTER,this.config.PREDICTION_TIME_S,this.config.YAW_ONLY,this.config.DEBUG),this.sensor&&(this.sensor.removeEventListener("reading",this._onSensorRead),this.sensor.removeEventListener("error",this._onSensorError),this.sensor=null)}},{key:"getOrientation",value:function(){if(this.fusionSensor)return this.fusionSensor.getOrientation();if(!this.sensor||!this.sensor.quaternion)return this._out[0]=this._out[1]=this._out[2]=0,this._out[3]=1,this._out;var A=this.sensor.quaternion;this._sensorQ.set(A[0],A[1],A[2],A[3]);var S=this._outQ;return S.copy(Ad),S.multiply(this._sensorQ),this.config.YAW_ONLY&&(S.x=S.z=0,S.normalize()),this._out[0]=S.x,this._out[1]=S.y,this._out[2]=S.z,this._out[3]=S.w,this._out}},{key:"_onSensorError",value:function(A){this.errors.push(A.error),A.error.name==="NotAllowedError"?console.error("Permission to access sensor was denied"):A.error.name==="NotReadableError"?console.error("Sensor could not be read"):console.error(A.error),this.useDeviceMotion()}},{key:"_onSensorRead",value:function(){}}]),p}(),HA="<svg width='198' height='240' viewBox='0 0 198 240' xmlns='http://www.w3.org/2000/svg'><g fill='none' fill-rule='evenodd'><path d='M149.625 109.527l6.737 3.891v.886c0 .177.013.36.038.549.01.081.02.162.027.242.14 1.415.974 2.998 2.105 3.999l5.72 5.062.081-.09s4.382-2.53 5.235-3.024l25.97 14.993v54.001c0 .771-.386 1.217-.948 1.217-.233 0-.495-.076-.772-.236l-23.967-13.838-.014.024-27.322 15.775-.85-1.323c-4.731-1.529-9.748-2.74-14.951-3.61a.27.27 0 0 0-.007.024l-5.067 16.961-7.891 4.556-.037-.063v27.59c0 .772-.386 1.217-.948 1.217-.232 0-.495-.076-.772-.236l-42.473-24.522c-.95-.549-1.72-1.877-1.72-2.967v-1.035l-.021.047a5.111 5.111 0 0 0-1.816-.399 5.682 5.682 0 0 0-.546.001 13.724 13.724 0 0 1-1.918-.041c-1.655-.153-3.2-.6-4.404-1.296l-46.576-26.89.005.012-10.278-18.75c-1.001-1.827-.241-4.216 1.698-5.336l56.011-32.345a4.194 4.194 0 0 1 2.099-.572c1.326 0 2.572.659 3.227 1.853l.005-.003.227.413-.006.004a9.63 9.63 0 0 0 1.477 2.018l.277.27c1.914 1.85 4.468 2.801 7.113 2.801 1.949 0 3.948-.517 5.775-1.572.013 0 7.319-4.219 7.319-4.219a4.194 4.194 0 0 1 2.099-.572c1.326 0 2.572.658 3.226 1.853l3.25 5.928.022-.018 6.785 3.917-.105-.182 46.881-26.965m0-1.635c-.282 0-.563.073-.815.218l-46.169 26.556-5.41-3.124-3.005-5.481c-.913-1.667-2.699-2.702-4.66-2.703-1.011 0-2.02.274-2.917.792a3825 3825 0 0 1-7.275 4.195l-.044.024a9.937 9.937 0 0 1-4.957 1.353c-2.292 0-4.414-.832-5.976-2.342l-.252-.245a7.992 7.992 0 0 1-1.139-1.534 1.379 1.379 0 0 0-.06-.122l-.227-.414a1.718 1.718 0 0 0-.095-.154c-.938-1.574-2.673-2.545-4.571-2.545-1.011 0-2.02.274-2.917.792L3.125 155.502c-2.699 1.559-3.738 4.94-2.314 7.538l10.278 18.75c.177.323.448.563.761.704l46.426 26.804c1.403.81 3.157 1.332 5.072 1.508a15.661 15.661 0 0 0 2.146.046 4.766 4.766 0 0 1 .396 0c.096.004.19.011.283.022.109 1.593 1.159 3.323 2.529 4.114l42.472 24.522c.524.302 1.058.455 1.59.455 1.497 0 2.583-1.2 2.583-2.852v-26.562l7.111-4.105a1.64 1.64 0 0 0 .749-.948l4.658-15.593c4.414.797 8.692 1.848 12.742 3.128l.533.829a1.634 1.634 0 0 0 2.193.531l26.532-15.317L193 192.433c.523.302 1.058.455 1.59.455 1.497 0 2.583-1.199 2.583-2.852v-54.001c0-.584-.312-1.124-.818-1.416l-25.97-14.993a1.633 1.633 0 0 0-1.636.001c-.606.351-2.993 1.73-4.325 2.498l-4.809-4.255c-.819-.725-1.461-1.933-1.561-2.936a7.776 7.776 0 0 0-.033-.294 2.487 2.487 0 0 1-.023-.336v-.886c0-.584-.312-1.123-.817-1.416l-6.739-3.891a1.633 1.633 0 0 0-.817-.219' fill='#455A64'/><path d='M96.027 132.636l46.576 26.891c1.204.695 1.979 1.587 2.242 2.541l-.01.007-81.374 46.982h-.001c-1.654-.152-3.199-.6-4.403-1.295l-46.576-26.891 83.546-48.235' fill='#FAFAFA'/><path d='M63.461 209.174c-.008 0-.015 0-.022-.002-1.693-.156-3.228-.609-4.441-1.309l-46.576-26.89a.118.118 0 0 1 0-.203l83.546-48.235a.117.117 0 0 1 .117 0l46.576 26.891c1.227.708 2.021 1.612 2.296 2.611a.116.116 0 0 1-.042.124l-.021.016-81.375 46.981a.11.11 0 0 1-.058.016zm-50.747-28.303l46.401 26.79c1.178.68 2.671 1.121 4.32 1.276l81.272-46.922c-.279-.907-1.025-1.73-2.163-2.387l-46.517-26.857-83.313 48.1z' fill='#607D8B'/><path d='M148.327 165.471a5.85 5.85 0 0 1-.546.001c-1.894-.083-3.302-1.038-3.145-2.132a2.693 2.693 0 0 0-.072-1.105l-81.103 46.822c.628.058 1.272.073 1.918.042.182-.009.364-.009.546-.001 1.894.083 3.302 1.038 3.145 2.132l79.257-45.759' fill='#FFF'/><path d='M69.07 211.347a.118.118 0 0 1-.115-.134c.045-.317-.057-.637-.297-.925-.505-.61-1.555-1.022-2.738-1.074a5.966 5.966 0 0 0-.535.001 14.03 14.03 0 0 1-1.935-.041.117.117 0 0 1-.103-.092.116.116 0 0 1 .055-.126l81.104-46.822a.117.117 0 0 1 .171.07c.104.381.129.768.074 1.153-.045.316.057.637.296.925.506.61 1.555 1.021 2.739 1.073.178.008.357.008.535-.001a.117.117 0 0 1 .064.218l-79.256 45.759a.114.114 0 0 1-.059.016zm-3.405-2.372c.089 0 .177.002.265.006 1.266.056 2.353.488 2.908 1.158.227.274.35.575.36.882l78.685-45.429c-.036 0-.072-.001-.107-.003-1.267-.056-2.354-.489-2.909-1.158-.282-.34-.402-.724-.347-1.107a2.604 2.604 0 0 0-.032-.91L63.846 208.97a13.91 13.91 0 0 0 1.528.012c.097-.005.194-.007.291-.007z' fill='#607D8B'/><path d='M2.208 162.134c-1.001-1.827-.241-4.217 1.698-5.337l56.011-32.344c1.939-1.12 4.324-.546 5.326 1.281l.232.41a9.344 9.344 0 0 0 1.47 2.021l.278.27c3.325 3.214 8.583 3.716 12.888 1.23l7.319-4.22c1.94-1.119 4.324-.546 5.325 1.282l3.25 5.928-83.519 48.229-10.278-18.75z' fill='#FAFAFA'/><path d='M12.486 181.001a.112.112 0 0 1-.031-.005.114.114 0 0 1-.071-.056L2.106 162.19c-1.031-1.88-.249-4.345 1.742-5.494l56.01-32.344a4.328 4.328 0 0 1 2.158-.588c1.415 0 2.65.702 3.311 1.882.01.008.018.017.024.028l.227.414a.122.122 0 0 1 .013.038 9.508 9.508 0 0 0 1.439 1.959l.275.266c1.846 1.786 4.344 2.769 7.031 2.769 1.977 0 3.954-.538 5.717-1.557a.148.148 0 0 1 .035-.013l7.284-4.206a4.321 4.321 0 0 1 2.157-.588c1.427 0 2.672.716 3.329 1.914l3.249 5.929a.116.116 0 0 1-.044.157l-83.518 48.229a.116.116 0 0 1-.059.016zm49.53-57.004c-.704 0-1.41.193-2.041.557l-56.01 32.345c-1.882 1.086-2.624 3.409-1.655 5.179l10.221 18.645 83.317-48.112-3.195-5.829c-.615-1.122-1.783-1.792-3.124-1.792a4.08 4.08 0 0 0-2.04.557l-7.317 4.225a.148.148 0 0 1-.035.013 11.7 11.7 0 0 1-5.801 1.569c-2.748 0-5.303-1.007-7.194-2.835l-.278-.27a9.716 9.716 0 0 1-1.497-2.046.096.096 0 0 1-.013-.037l-.191-.347a.11.11 0 0 1-.023-.029c-.615-1.123-1.783-1.793-3.124-1.793z' fill='#607D8B'/><path d='M42.434 155.808c-2.51-.001-4.697-1.258-5.852-3.365-1.811-3.304-.438-7.634 3.059-9.654l12.291-7.098a7.599 7.599 0 0 1 3.789-1.033c2.51 0 4.697 1.258 5.852 3.365 1.811 3.304.439 7.634-3.059 9.654l-12.291 7.098a7.606 7.606 0 0 1-3.789 1.033zm13.287-20.683a7.128 7.128 0 0 0-3.555.971l-12.291 7.098c-3.279 1.893-4.573 5.942-2.883 9.024 1.071 1.955 3.106 3.122 5.442 3.122a7.13 7.13 0 0 0 3.556-.97l12.291-7.098c3.279-1.893 4.572-5.942 2.883-9.024-1.072-1.955-3.106-3.123-5.443-3.123z' fill='#607D8B'/><path d='M149.588 109.407l6.737 3.89v.887c0 .176.013.36.037.549.011.081.02.161.028.242.14 1.415.973 2.998 2.105 3.999l7.396 6.545c.177.156.358.295.541.415 1.579 1.04 2.95.466 3.062-1.282.049-.784.057-1.595.023-2.429l-.003-.16v-1.151l25.987 15.003v54c0 1.09-.77 1.53-1.72.982l-42.473-24.523c-.95-.548-1.72-1.877-1.72-2.966v-34.033' fill='#FAFAFA'/><path d='M194.553 191.25c-.257 0-.54-.085-.831-.253l-42.472-24.521c-.981-.567-1.779-1.943-1.779-3.068v-34.033h.234v34.033c0 1.051.745 2.336 1.661 2.866l42.473 24.521c.424.245.816.288 1.103.122.285-.164.442-.52.442-1.002v-53.933l-25.753-14.868.003 1.106c.034.832.026 1.654-.024 2.439-.054.844-.396 1.464-.963 1.746-.619.309-1.45.173-2.28-.373a5.023 5.023 0 0 1-.553-.426l-7.397-6.544c-1.158-1.026-1.999-2.625-2.143-4.076a9.624 9.624 0 0 0-.027-.238 4.241 4.241 0 0 1-.038-.564v-.82l-6.68-3.856.117-.202 6.738 3.89.058.034v.954c0 .171.012.351.036.533.011.083.021.165.029.246.138 1.395.948 2.935 2.065 3.923l7.397 6.545c.173.153.35.289.527.406.758.499 1.504.63 2.047.359.49-.243.786-.795.834-1.551.05-.778.057-1.591.024-2.417l-.004-.163v-1.355l.175.1 25.987 15.004.059.033v54.068c0 .569-.198.996-.559 1.204a1.002 1.002 0 0 1-.506.131' fill='#607D8B'/><path d='M145.685 163.161l24.115 13.922-25.978 14.998-1.462-.307c-6.534-2.17-13.628-3.728-21.019-4.616-4.365-.524-8.663 1.096-9.598 3.62a2.746 2.746 0 0 0-.011 1.928c1.538 4.267 4.236 8.363 7.995 12.135l.532.845-25.977 14.997-24.115-13.922 75.518-43.6' fill='#FFF'/><path d='M94.282 220.818l-.059-.033-24.29-14.024.175-.101 75.577-43.634.058.033 24.29 14.024-26.191 15.122-.045-.01-1.461-.307c-6.549-2.174-13.613-3.725-21.009-4.614a13.744 13.744 0 0 0-1.638-.097c-3.758 0-7.054 1.531-7.837 3.642a2.62 2.62 0 0 0-.01 1.848c1.535 4.258 4.216 8.326 7.968 12.091l.016.021.526.835.006.01.064.102-.105.061-25.977 14.998-.058.033zm-23.881-14.057l23.881 13.788 24.802-14.32c.546-.315.846-.489 1.017-.575l-.466-.74c-3.771-3.787-6.467-7.881-8.013-12.168a2.851 2.851 0 0 1 .011-2.008c.815-2.199 4.203-3.795 8.056-3.795.557 0 1.117.033 1.666.099 7.412.891 14.491 2.445 21.041 4.621.836.175 1.215.254 1.39.304l25.78-14.884-23.881-13.788-75.284 43.466z' fill='#607D8B'/><path d='M167.23 125.979v50.871l-27.321 15.773-6.461-14.167c-.91-1.996-3.428-1.738-5.624.574a10.238 10.238 0 0 0-2.33 4.018l-6.46 21.628-27.322 15.774v-50.871l75.518-43.6' fill='#FFF'/><path d='M91.712 220.567a.127.127 0 0 1-.059-.016.118.118 0 0 1-.058-.101v-50.871c0-.042.023-.08.058-.101l75.519-43.6a.117.117 0 0 1 .175.101v50.871c0 .041-.023.08-.059.1l-27.321 15.775a.118.118 0 0 1-.094.01.12.12 0 0 1-.071-.063l-6.46-14.168c-.375-.822-1.062-1.275-1.934-1.275-1.089 0-2.364.686-3.5 1.881a10.206 10.206 0 0 0-2.302 3.972l-6.46 21.627a.118.118 0 0 1-.054.068L91.77 220.551a.12.12 0 0 1-.058.016zm.117-50.92v50.601l27.106-15.65 6.447-21.583a10.286 10.286 0 0 1 2.357-4.065c1.18-1.242 2.517-1.954 3.669-1.954.969 0 1.731.501 2.146 1.411l6.407 14.051 27.152-15.676v-50.601l-75.284 43.466z' fill='#607D8B'/><path d='M168.543 126.213v50.87l-27.322 15.774-6.46-14.168c-.91-1.995-3.428-1.738-5.624.574a10.248 10.248 0 0 0-2.33 4.019l-6.461 21.627-27.321 15.774v-50.87l75.518-43.6' fill='#FFF'/><path d='M93.025 220.8a.123.123 0 0 1-.059-.015.12.12 0 0 1-.058-.101v-50.871c0-.042.023-.08.058-.101l75.518-43.6a.112.112 0 0 1 .117 0c.036.02.059.059.059.1v50.871a.116.116 0 0 1-.059.101l-27.321 15.774a.111.111 0 0 1-.094.01.115.115 0 0 1-.071-.062l-6.46-14.168c-.375-.823-1.062-1.275-1.935-1.275-1.088 0-2.363.685-3.499 1.881a10.19 10.19 0 0 0-2.302 3.971l-6.461 21.628a.108.108 0 0 1-.053.067l-27.322 15.775a.12.12 0 0 1-.058.015zm.117-50.919v50.6l27.106-15.649 6.447-21.584a10.293 10.293 0 0 1 2.357-4.065c1.179-1.241 2.516-1.954 3.668-1.954.969 0 1.732.502 2.147 1.412l6.407 14.051 27.152-15.676v-50.601l-75.284 43.466z' fill='#607D8B'/><path d='M169.8 177.083l-27.322 15.774-6.46-14.168c-.91-1.995-3.428-1.738-5.625.574a10.246 10.246 0 0 0-2.329 4.019l-6.461 21.627-27.321 15.774v-50.87l75.518-43.6v50.87z' fill='#FAFAFA'/><path d='M94.282 220.917a.234.234 0 0 1-.234-.233v-50.871c0-.083.045-.161.117-.202l75.518-43.601a.234.234 0 1 1 .35.202v50.871a.233.233 0 0 1-.116.202l-27.322 15.775a.232.232 0 0 1-.329-.106l-6.461-14.168c-.36-.789-.992-1.206-1.828-1.206-1.056 0-2.301.672-3.415 1.844a10.099 10.099 0 0 0-2.275 3.924l-6.46 21.628a.235.235 0 0 1-.107.136l-27.322 15.774a.23.23 0 0 1-.116.031zm.233-50.969v50.331l26.891-15.525 6.434-21.539a10.41 10.41 0 0 1 2.384-4.112c1.201-1.265 2.569-1.991 3.753-1.991 1.018 0 1.818.526 2.253 1.48l6.354 13.934 26.982-15.578v-50.331l-75.051 43.331z' fill='#607D8B'/><path d='M109.894 199.943c-1.774 0-3.241-.725-4.244-2.12a.224.224 0 0 1 .023-.294.233.233 0 0 1 .301-.023c.78.547 1.705.827 2.75.827 1.323 0 2.754-.439 4.256-1.306 5.311-3.067 9.631-10.518 9.631-16.611 0-1.927-.442-3.56-1.278-4.724a.232.232 0 0 1 .323-.327c1.671 1.172 2.591 3.381 2.591 6.219 0 6.242-4.426 13.863-9.865 17.003-1.574.908-3.084 1.356-4.488 1.356zm-2.969-1.542c.813.651 1.82.877 2.968.877h.001c1.321 0 2.753-.327 4.254-1.194 5.311-3.067 9.632-10.463 9.632-16.556 0-1.979-.463-3.599-1.326-4.761.411 1.035.625 2.275.625 3.635 0 6.243-4.426 13.883-9.865 17.023-1.574.909-3.084 1.317-4.49 1.317-.641 0-1.243-.149-1.799-.341z' fill='#607D8B'/><path d='M113.097 197.23c5.384-3.108 9.748-10.636 9.748-16.814 0-2.051-.483-3.692-1.323-4.86-1.784-1.252-4.374-1.194-7.257.47-5.384 3.108-9.748 10.636-9.748 16.814 0 2.051.483 3.692 1.323 4.86 1.784 1.252 4.374 1.194 7.257-.47' fill='#FAFAFA'/><path d='M108.724 198.614c-1.142 0-2.158-.213-3.019-.817-.021-.014-.04.014-.055-.007-.894-1.244-1.367-2.948-1.367-4.973 0-6.242 4.426-13.864 9.865-17.005 1.574-.908 3.084-1.363 4.49-1.363 1.142 0 2.158.309 3.018.913a.23.23 0 0 1 .056.056c.894 1.244 1.367 2.972 1.367 4.997 0 6.243-4.426 13.783-9.865 16.923-1.574.909-3.084 1.276-4.49 1.276zm-2.718-1.109c.774.532 1.688.776 2.718.776 1.323 0 2.754-.413 4.256-1.28 5.311-3.066 9.631-10.505 9.631-16.598 0-1.909-.434-3.523-1.255-4.685-.774-.533-1.688-.799-2.718-.799-1.323 0-2.755.441-4.256 1.308-5.311 3.066-9.631 10.506-9.631 16.599 0 1.909.434 3.517 1.255 4.679z' fill='#607D8B'/><path d='M149.318 114.262l-9.984 8.878 15.893 11.031 5.589-6.112-11.498-13.797' fill='#FAFAFA'/><path d='M169.676 120.84l-9.748 5.627c-3.642 2.103-9.528 2.113-13.147.024-3.62-2.089-3.601-5.488.041-7.591l9.495-5.608-6.729-3.885-81.836 47.071 45.923 26.514 3.081-1.779c.631-.365.869-.898.618-1.39-2.357-4.632-2.593-9.546-.683-14.262 5.638-13.92 24.509-24.815 48.618-28.07 8.169-1.103 16.68-.967 24.704.394.852.145 1.776.008 2.407-.357l3.081-1.778-25.825-14.91' fill='#FAFAFA'/><path d='M113.675 183.459a.47.47 0 0 1-.233-.062l-45.924-26.515a.468.468 0 0 1 .001-.809l81.836-47.071a.467.467 0 0 1 .466 0l6.729 3.885a.467.467 0 0 1-.467.809l-6.496-3.75-80.9 46.533 44.988 25.973 2.848-1.644c.192-.111.62-.409.435-.773-2.416-4.748-2.658-9.814-.7-14.65 2.806-6.927 8.885-13.242 17.582-18.263 8.657-4.998 19.518-8.489 31.407-10.094 8.198-1.107 16.79-.97 24.844.397.739.125 1.561.007 2.095-.301l2.381-1.374-25.125-14.506a.467.467 0 0 1 .467-.809l25.825 14.91a.467.467 0 0 1 0 .809l-3.081 1.779c-.721.417-1.763.575-2.718.413-7.963-1.351-16.457-1.486-24.563-.392-11.77 1.589-22.512 5.039-31.065 9.977-8.514 4.916-14.456 11.073-17.183 17.805-1.854 4.578-1.623 9.376.666 13.875.37.725.055 1.513-.8 2.006l-3.081 1.78a.476.476 0 0 1-.234.062' fill='#455A64'/><path d='M153.316 128.279c-2.413 0-4.821-.528-6.652-1.586-1.818-1.049-2.82-2.461-2.82-3.975 0-1.527 1.016-2.955 2.861-4.02l9.493-5.607a.233.233 0 1 1 .238.402l-9.496 5.609c-1.696.979-2.628 2.263-2.628 3.616 0 1.34.918 2.608 2.585 3.571 3.549 2.049 9.343 2.038 12.914-.024l9.748-5.628a.234.234 0 0 1 .234.405l-9.748 5.628c-1.858 1.072-4.296 1.609-6.729 1.609' fill='#607D8B'/><path d='M113.675 182.992l-45.913-26.508M113.675 183.342a.346.346 0 0 1-.175-.047l-45.913-26.508a.35.35 0 1 1 .35-.607l45.913 26.508a.35.35 0 0 1-.175.654' fill='#455A64'/><path d='M67.762 156.484v54.001c0 1.09.77 2.418 1.72 2.967l42.473 24.521c.95.549 1.72.11 1.72-.98v-54.001' fill='#FAFAFA'/><path d='M112.727 238.561c-.297 0-.62-.095-.947-.285l-42.473-24.521c-1.063-.613-1.895-2.05-1.895-3.27v-54.001a.35.35 0 1 1 .701 0v54.001c0 .96.707 2.18 1.544 2.663l42.473 24.522c.344.198.661.243.87.122.206-.119.325-.411.325-.799v-54.001a.35.35 0 1 1 .7 0v54.001c0 .655-.239 1.154-.675 1.406a1.235 1.235 0 0 1-.623.162' fill='#455A64'/><path d='M112.86 147.512h-.001c-2.318 0-4.499-.522-6.142-1.471-1.705-.984-2.643-2.315-2.643-3.749 0-1.445.952-2.791 2.68-3.788l12.041-6.953c1.668-.962 3.874-1.493 6.212-1.493 2.318 0 4.499.523 6.143 1.472 1.704.984 2.643 2.315 2.643 3.748 0 1.446-.952 2.791-2.68 3.789l-12.042 6.952c-1.668.963-3.874 1.493-6.211 1.493zm12.147-16.753c-2.217 0-4.298.497-5.861 1.399l-12.042 6.952c-1.502.868-2.33 1.998-2.33 3.182 0 1.173.815 2.289 2.293 3.142 1.538.889 3.596 1.378 5.792 1.378h.001c2.216 0 4.298-.497 5.861-1.399l12.041-6.953c1.502-.867 2.33-1.997 2.33-3.182 0-1.172-.814-2.288-2.292-3.142-1.539-.888-3.596-1.377-5.793-1.377z' fill='#607D8B'/><path d='M165.63 123.219l-5.734 3.311c-3.167 1.828-8.286 1.837-11.433.02-3.147-1.817-3.131-4.772.036-6.601l5.734-3.31 11.397 6.58' fill='#FAFAFA'/><path d='M154.233 117.448l9.995 5.771-4.682 2.704c-1.434.827-3.352 1.283-5.399 1.283-2.029 0-3.923-.449-5.333-1.263-1.29-.744-2-1.694-2-2.674 0-.991.723-1.955 2.036-2.713l5.383-3.108m0-.809l-5.734 3.31c-3.167 1.829-3.183 4.784-.036 6.601 1.568.905 3.623 1.357 5.684 1.357 2.077 0 4.159-.46 5.749-1.377l5.734-3.311-11.397-6.58M145.445 179.667c-1.773 0-3.241-.85-4.243-2.245-.067-.092-.057-.275.023-.356.08-.081.207-.12.3-.055.781.548 1.706.812 2.751.811 1.322 0 2.754-.446 4.256-1.313 5.31-3.066 9.631-10.522 9.631-16.615 0-1.927-.442-3.562-1.279-4.726a.235.235 0 0 1 .024-.301.232.232 0 0 1 .3-.027c1.67 1.172 2.59 3.38 2.59 6.219 0 6.242-4.425 13.987-9.865 17.127-1.573.908-3.083 1.481-4.488 1.481zM142.476 178c.814.651 1.82 1.002 2.969 1.002 1.322 0 2.753-.452 4.255-1.32 5.31-3.065 9.631-10.523 9.631-16.617 0-1.98-.463-3.63-1.325-4.793.411 1.035.624 2.26.624 3.62 0 6.242-4.425 13.875-9.865 17.015-1.573.909-3.084 1.376-4.489 1.376a5.49 5.49 0 0 1-1.8-.283z' fill='#607D8B'/><path d='M148.648 176.704c5.384-3.108 9.748-10.636 9.748-16.813 0-2.052-.483-3.693-1.322-4.861-1.785-1.252-4.375-1.194-7.258.471-5.383 3.108-9.748 10.636-9.748 16.813 0 2.051.484 3.692 1.323 4.86 1.785 1.253 4.374 1.195 7.257-.47' fill='#FAFAFA'/><path d='M144.276 178.276c-1.143 0-2.158-.307-3.019-.911a.217.217 0 0 1-.055-.054c-.895-1.244-1.367-2.972-1.367-4.997 0-6.241 4.425-13.875 9.865-17.016 1.573-.908 3.084-1.369 4.489-1.369 1.143 0 2.158.307 3.019.91a.24.24 0 0 1 .055.055c.894 1.244 1.367 2.971 1.367 4.997 0 6.241-4.425 13.875-9.865 17.016-1.573.908-3.084 1.369-4.489 1.369zm-2.718-1.172c.773.533 1.687.901 2.718.901 1.322 0 2.754-.538 4.256-1.405 5.31-3.066 9.631-10.567 9.631-16.661 0-1.908-.434-3.554-1.256-4.716-.774-.532-1.688-.814-2.718-.814-1.322 0-2.754.433-4.256 1.3-5.31 3.066-9.631 10.564-9.631 16.657 0 1.91.434 3.576 1.256 4.738z' fill='#607D8B'/><path d='M150.72 172.361l-.363-.295a24.105 24.105 0 0 0 2.148-3.128 24.05 24.05 0 0 0 1.977-4.375l.443.149a24.54 24.54 0 0 1-2.015 4.46 24.61 24.61 0 0 1-2.19 3.189M115.917 191.514l-.363-.294a24.174 24.174 0 0 0 2.148-3.128 24.038 24.038 0 0 0 1.976-4.375l.443.148a24.48 24.48 0 0 1-2.015 4.461 24.662 24.662 0 0 1-2.189 3.188M114 237.476V182.584 237.476' fill='#607D8B'/><g><path d='M81.822 37.474c.017-.135-.075-.28-.267-.392-.327-.188-.826-.21-1.109-.045l-6.012 3.471c-.131.076-.194.178-.191.285.002.132.002.461.002.578v.043l-.007.128-6.591 3.779c-.001 0-2.077 1.046-2.787 5.192 0 0-.912 6.961-.898 19.745.015 12.57.606 17.07 1.167 21.351.22 1.684 3.001 2.125 3.001 2.125.331.04.698-.027 1.08-.248l75.273-43.551c1.808-1.069 2.667-3.719 3.056-6.284 1.213-7.99 1.675-32.978-.275-39.878-.196-.693-.51-1.083-.868-1.282l-2.086-.79c-.727.028-1.416.467-1.534.535L82.032 37.072l-.21.402' fill='#FFF'/><path d='M144.311 1.701l2.085.79c.358.199.672.589.868 1.282 1.949 6.9 1.487 31.887.275 39.878-.39 2.565-1.249 5.215-3.056 6.284L69.21 93.486a1.78 1.78 0 0 1-.896.258l-.183-.011c0 .001-2.782-.44-3.003-2.124-.56-4.282-1.151-8.781-1.165-21.351-.015-12.784.897-19.745.897-19.745.71-4.146 2.787-5.192 2.787-5.192l6.591-3.779.007-.128v-.043c0-.117 0-.446-.002-.578-.003-.107.059-.21.191-.285l6.012-3.472a.98.98 0 0 1 .481-.11c.218 0 .449.053.627.156.193.112.285.258.268.392l.211-.402 60.744-34.836c.117-.068.806-.507 1.534-.535m0-.997l-.039.001c-.618.023-1.283.244-1.974.656l-.021.012-60.519 34.706a2.358 2.358 0 0 0-.831-.15c-.365 0-.704.084-.98.244l-6.012 3.471c-.442.255-.699.69-.689 1.166l.001.15-6.08 3.487c-.373.199-2.542 1.531-3.29 5.898l-.006.039c-.009.07-.92 7.173-.906 19.875.014 12.62.603 17.116 1.172 21.465l.002.015c.308 2.355 3.475 2.923 3.836 2.98l.034.004c.101.013.204.019.305.019a2.77 2.77 0 0 0 1.396-.392l75.273-43.552c1.811-1.071 2.999-3.423 3.542-6.997 1.186-7.814 1.734-33.096-.301-40.299-.253-.893-.704-1.527-1.343-1.882l-.132-.062-2.085-.789a.973.973 0 0 0-.353-.065' fill='#455A64'/><path d='M128.267 11.565l1.495.434-56.339 32.326' fill='#FFF'/><path d='M74.202 90.545a.5.5 0 0 1-.25-.931l18.437-10.645a.499.499 0 1 1 .499.864L74.451 90.478l-.249.067M75.764 42.654l-.108-.062.046-.171 5.135-2.964.17.045-.045.171-5.135 2.964-.063.017M70.52 90.375V46.421l.063-.036L137.84 7.554v43.954l-.062.036L70.52 90.375zm.25-43.811v43.38l66.821-38.579V7.985L70.77 46.564z' fill='#607D8B'/><path d='M86.986 83.182c-.23.149-.612.384-.849.523l-11.505 6.701c-.237.139-.206.252.068.252h.565c.275 0 .693-.113.93-.252L87.7 83.705c.237-.139.428-.253.425-.256a11.29 11.29 0 0 1-.006-.503c0-.274-.188-.377-.418-.227l-.715.463' fill='#607D8B'/><path d='M75.266 90.782H74.7c-.2 0-.316-.056-.346-.166-.03-.11.043-.217.215-.317l11.505-6.702c.236-.138.615-.371.844-.519l.715-.464a.488.488 0 0 1 .266-.089c.172 0 .345.13.345.421 0 .214.001.363.003.437l.006.004-.004.069c-.003.075-.003.075-.486.356l-11.505 6.702a2.282 2.282 0 0 1-.992.268zm-.6-.25l.034.001h.566c.252 0 .649-.108.866-.234l11.505-6.702c.168-.098.294-.173.361-.214-.004-.084-.004-.218-.004-.437l-.095-.171-.131.049-.714.463c-.232.15-.616.386-.854.525l-11.505 6.702-.029.018z' fill='#607D8B'/><path d='M75.266 89.871H74.7c-.2 0-.316-.056-.346-.166-.03-.11.043-.217.215-.317l11.505-6.702c.258-.151.694-.268.993-.268h.565c.2 0 .316.056.346.166.03.11-.043.217-.215.317l-11.505 6.702a2.282 2.282 0 0 1-.992.268zm-.6-.25l.034.001h.566c.252 0 .649-.107.866-.234l11.505-6.702.03-.018-.035-.001h-.565c-.252 0-.649.108-.867.234l-11.505 6.702-.029.018zM74.37 90.801v-1.247 1.247' fill='#607D8B'/><path d='M68.13 93.901c-.751-.093-1.314-.737-1.439-1.376-.831-4.238-1.151-8.782-1.165-21.352-.015-12.784.897-19.745.897-19.745.711-4.146 2.787-5.192 2.787-5.192l74.859-43.219c.223-.129 2.487-1.584 3.195.923 1.95 6.9 1.488 31.887.275 39.878-.389 2.565-1.248 5.215-3.056 6.283L69.21 93.653c-.382.221-.749.288-1.08.248 0 0-2.781-.441-3.001-2.125-.561-4.281-1.152-8.781-1.167-21.351-.014-12.784.898-19.745.898-19.745.71-4.146 2.787-5.191 2.787-5.191l6.598-3.81.871-.119 6.599-3.83.046-.461L68.13 93.901' fill='#FAFAFA'/><path d='M68.317 94.161l-.215-.013h-.001l-.244-.047c-.719-.156-2.772-.736-2.976-2.292-.568-4.34-1.154-8.813-1.168-21.384-.014-12.654.891-19.707.9-19.777.725-4.231 2.832-5.338 2.922-5.382l6.628-3.827.87-.119 6.446-3.742.034-.334a.248.248 0 0 1 .273-.223.248.248 0 0 1 .223.272l-.059.589-6.752 3.919-.87.118-6.556 3.785c-.031.016-1.99 1.068-2.666 5.018-.007.06-.908 7.086-.894 19.702.014 12.539.597 16.996 1.161 21.305.091.691.689 1.154 1.309 1.452a1.95 1.95 0 0 1-.236-.609c-.781-3.984-1.155-8.202-1.17-21.399-.014-12.653.891-19.707.9-19.777.725-4.231 2.832-5.337 2.922-5.382-.004.001 74.444-42.98 74.846-43.212l.028-.017c.904-.538 1.72-.688 2.36-.433.555.221.949.733 1.172 1.52 2.014 7.128 1.46 32.219.281 39.983-.507 3.341-1.575 5.515-3.175 6.462L69.335 93.869a2.023 2.023 0 0 1-1.018.292zm-.147-.507c.293.036.604-.037.915-.217l75.273-43.551c1.823-1.078 2.602-3.915 2.934-6.106 1.174-7.731 1.731-32.695-.268-39.772-.178-.631-.473-1.032-.876-1.192-.484-.193-1.166-.052-1.921.397l-.034.021-74.858 43.218c-.031.017-1.989 1.069-2.666 5.019-.007.059-.908 7.085-.894 19.702.015 13.155.386 17.351 1.161 21.303.09.461.476.983 1.037 1.139.114.025.185.037.196.039h.001z' fill='#455A64'/><path d='M69.317 68.982c.489-.281.885-.056.885.505 0 .56-.396 1.243-.885 1.525-.488.282-.884.057-.884-.504 0-.56.396-1.243.884-1.526' fill='#FFF'/><path d='M68.92 71.133c-.289 0-.487-.228-.487-.625 0-.56.396-1.243.884-1.526a.812.812 0 0 1 .397-.121c.289 0 .488.229.488.626 0 .56-.396 1.243-.885 1.525a.812.812 0 0 1-.397.121m.794-2.459a.976.976 0 0 0-.49.147c-.548.317-.978 1.058-.978 1.687 0 .486.271.812.674.812a.985.985 0 0 0 .491-.146c.548-.317.978-1.057.978-1.687 0-.486-.272-.813-.675-.813' fill='#8097A2'/><path d='M68.92 70.947c-.271 0-.299-.307-.299-.439 0-.491.361-1.116.79-1.363a.632.632 0 0 1 .303-.096c.272 0 .301.306.301.438 0 .491-.363 1.116-.791 1.364a.629.629 0 0 1-.304.096m.794-2.086a.812.812 0 0 0-.397.121c-.488.283-.884.966-.884 1.526 0 .397.198.625.487.625a.812.812 0 0 0 .397-.121c.489-.282.885-.965.885-1.525 0-.397-.199-.626-.488-.626' fill='#8097A2'/><path d='M69.444 85.35c.264-.152.477-.031.477.272 0 .303-.213.67-.477.822-.263.153-.477.031-.477-.271 0-.302.214-.671.477-.823' fill='#FFF'/><path d='M69.23 86.51c-.156 0-.263-.123-.263-.337 0-.302.214-.671.477-.823a.431.431 0 0 1 .214-.066c.156 0 .263.124.263.338 0 .303-.213.67-.477.822a.431.431 0 0 1-.214.066m.428-1.412c-.1 0-.203.029-.307.09-.32.185-.57.618-.57.985 0 .309.185.524.449.524a.63.63 0 0 0 .308-.09c.32-.185.57-.618.57-.985 0-.309-.185-.524-.45-.524' fill='#8097A2'/><path d='M69.23 86.322l-.076-.149c0-.235.179-.544.384-.661l.12-.041.076.151c0 .234-.179.542-.383.66l-.121.04m.428-1.038a.431.431 0 0 0-.214.066c-.263.152-.477.521-.477.823 0 .214.107.337.263.337a.431.431 0 0 0 .214-.066c.264-.152.477-.519.477-.822 0-.214-.107-.338-.263-.338' fill='#8097A2'/><path d='M139.278 7.769v43.667L72.208 90.16V46.493l67.07-38.724' fill='#455A64'/><path d='M72.083 90.375V46.421l.063-.036 67.257-38.831v43.954l-.062.036-67.258 38.831zm.25-43.811v43.38l66.821-38.579V7.985L72.333 46.564z' fill='#607D8B'/></g><path d='M125.737 88.647l-7.639 3.334V84l-11.459 4.713v8.269L99 100.315l13.369 3.646 13.368-15.314' fill='#455A64'/></g></svg>";function zo(){this.loadIcon_();var p=document.createElement("div"),j=p.style;j.position="fixed",j.top=0,j.right=0,j.bottom=0,j.left=0,j.backgroundColor="gray",j.fontFamily="sans-serif",j.zIndex=1e6;var _=document.createElement("img");_.src=this.icon;var j=_.style;j.marginLeft="25%",j.marginTop="25%",j.width="50%",p.appendChild(_);var A=document.createElement("div"),j=A.style;j.textAlign="center",j.fontSize="16px",j.lineHeight="24px",j.margin="24px 25%",j.width="50%",A.innerHTML="Place your phone into your Cardboard viewer.",p.appendChild(A);var S=document.createElement("div"),j=S.style;j.backgroundColor="#CFD8DC",j.position="fixed",j.bottom=0,j.width="100%",j.height="48px",j.padding="14px 24px",j.boxSizing="border-box",j.color="#656A6B",p.appendChild(S);var D=document.createElement("div");D.style.float="left",D.innerHTML="No Cardboard viewer?";var W=document.createElement("a");W.href="https://www.google.com/get/cardboard/get-cardboard/",W.innerHTML="get one",W.target="_blank";var j=W.style;j.float="right",j.fontWeight=600,j.textTransform="uppercase",j.borderLeft="1px solid gray",j.paddingLeft="24px",j.textDecoration="none",j.color="#656A6B",S.appendChild(D),S.appendChild(W),this.overlay=p,this.text=A,this.hide()}zo.prototype.show=function(p){!p&&!this.overlay.parentElement?document.body.appendChild(this.overlay):p&&(this.overlay.parentElement&&this.overlay.parentElement!=p&&this.overlay.parentElement.removeChild(this.overlay),p.appendChild(this.overlay)),this.overlay.style.display="block";var _=this.overlay.querySelector("img"),A=_.style;ci()?(A.width="20%",A.marginLeft="40%",A.marginTop="3%"):(A.width="50%",A.marginLeft="25%",A.marginTop="25%")},zo.prototype.hide=function(){this.overlay.style.display="none"},zo.prototype.showTemporarily=function(p,_){this.show(_),this.timer=setTimeout(this.hide.bind(this),p)},zo.prototype.disableShowTemporarily=function(){clearTimeout(this.timer)},zo.prototype.update=function(){this.disableShowTemporarily(),!ci()&&Vs()?this.show():this.hide()},zo.prototype.loadIcon_=function(){this.icon=oe("image/svg+xml",HA)};var WA="CardboardV1",Ap="WEBVR_CARDBOARD_VIEWER",jA="webvr-polyfill-viewer-selector";function Dn(p){try{this.selectedKey=localStorage.getItem(Ap)}catch(_){console.error("Failed to load viewer profile: %s",_)}this.selectedKey||(this.selectedKey=p||WA),this.dialog=this.createDialog_(Ei.Viewers),this.root=null,this.onChangeCallbacks_=[]}Dn.prototype.show=function(p){this.root=p,p.appendChild(this.dialog);var _=this.dialog.querySelector("#"+this.selectedKey);_.checked=!0,this.dialog.style.display="block"},Dn.prototype.hide=function(){this.root&&this.root.contains(this.dialog)&&this.root.removeChild(this.dialog),this.dialog.style.display="none"},Dn.prototype.getCurrentViewer=function(){return Ei.Viewers[this.selectedKey]},Dn.prototype.getSelectedKey_=function(){var p=this.dialog.querySelector("input[name=field]:checked");return p?p.id:null},Dn.prototype.onChange=function(p){this.onChangeCallbacks_.push(p)},Dn.prototype.fireOnChange_=function(p){for(var _=0;_<this.onChangeCallbacks_.length;_++)this.onChangeCallbacks_[_](p)},Dn.prototype.onSave_=function(){if(this.selectedKey=this.getSelectedKey_(),!this.selectedKey||!Ei.Viewers[this.selectedKey]){console.error("ViewerSelector.onSave_: this should never happen!");return}this.fireOnChange_(Ei.Viewers[this.selectedKey]);try{localStorage.setItem(Ap,this.selectedKey)}catch(p){console.error("Failed to save viewer profile: %s",p)}this.hide()},Dn.prototype.createDialog_=function(p){var _=document.createElement("div");_.classList.add(jA),_.style.display="none";var A=document.createElement("div"),W=A.style;W.position="fixed",W.left=0,W.top=0,W.width="100%",W.height="100%",W.background="rgba(0, 0, 0, 0.3)",A.addEventListener("click",this.hide.bind(this));var S=280,D=document.createElement("div"),W=D.style;W.boxSizing="border-box",W.position="fixed",W.top="24px",W.left="50%",W.marginLeft=-S/2+"px",W.width=S+"px",W.padding="24px",W.overflow="hidden",W.background="#fafafa",W.fontFamily="'Roboto', sans-serif",W.boxShadow="0px 5px 20px #666",D.appendChild(this.createH1_("Select your viewer"));for(var j in p)D.appendChild(this.createChoice_(j,p[j].label));return D.appendChild(this.createButton_("Save",this.onSave_.bind(this))),_.appendChild(A),_.appendChild(D),_},Dn.prototype.createH1_=function(p){var _=document.createElement("h1"),A=_.style;return A.color="black",A.fontSize="20px",A.fontWeight="bold",A.marginTop=0,A.marginBottom="24px",_.innerHTML=p,_},Dn.prototype.createChoice_=function(p,_){var A=document.createElement("div");A.style.marginTop="8px",A.style.color="black";var S=document.createElement("input");S.style.fontSize="30px",S.setAttribute("id",p),S.setAttribute("type","radio"),S.setAttribute("value",p),S.setAttribute("name","field");var D=document.createElement("label");return D.style.marginLeft="4px",D.setAttribute("for",p),D.innerHTML=_,A.appendChild(S),A.appendChild(D),A},Dn.prototype.createButton_=function(p,_){var A=document.createElement("button");A.innerHTML=p;var S=A.style;return S.float="right",S.textTransform="uppercase",S.color="#1094f7",S.fontSize="14px",S.letterSpacing=0,S.border=0,S.background="none",S.marginTop="16px",A.addEventListener("click",_),A};var XA=typeof window!="undefined"?window:typeof fd!="undefined"?fd:typeof self!="undefined"?self:{};function qA(p){return p&&p.__esModule&&Object.prototype.hasOwnProperty.call(p,"default")?p.default:p}function YA(p,_){return _={exports:{}},p(_,_.exports),_.exports}var QA=YA(function(p,_){(function(S,D){p.exports=D()})(XA,function(){return function(A){var S={};function D(W){if(S[W])return S[W].exports;var j=S[W]={i:W,l:!1,exports:{}};return A[W].call(j.exports,j,j.exports,D),j.l=!0,j.exports}return D.m=A,D.c=S,D.d=function(W,j,fe){D.o(W,j)||Object.defineProperty(W,j,{configurable:!1,enumerable:!0,get:fe})},D.n=function(W){var j=W&&W.__esModule?function(){return W.default}:function(){return W};return D.d(j,"a",j),j},D.o=function(W,j){return Object.prototype.hasOwnProperty.call(W,j)},D.p="",D(D.s=0)}([function(A,S,D){var W=function(){function se(Ae,qe){for(var Je=0;Je<qe.length;Je++){var rt=qe[Je];rt.enumerable=rt.enumerable||!1,rt.configurable=!0,"value"in rt&&(rt.writable=!0),Object.defineProperty(Ae,rt.key,rt)}}return function(Ae,qe,Je){return qe&&se(Ae.prototype,qe),Je&&se(Ae,Je),Ae}}();function j(se,Ae){if(!(se instanceof Ae))throw new TypeError("Cannot call a class as a function")}var fe=D(1),me=typeof navigator!="undefined"&&parseFloat((""+(/CPU.*OS ([0-9_]{3,4})[0-9_]{0,1}|(CPU like).*AppleWebKit.*Mobile/i.exec(navigator.userAgent)||[0,""])[1]).replace("undefined","3_2").replace("_",".").replace("_",""))<10&&!window.MSStream,Q=function(){function se(){j(this,se),me?this.noSleepTimer=null:(this.noSleepVideo=document.createElement("video"),this.noSleepVideo.setAttribute("playsinline",""),this.noSleepVideo.setAttribute("src",fe),this.noSleepVideo.addEventListener("timeupdate",function(Ae){this.noSleepVideo.currentTime>.5&&(this.noSleepVideo.currentTime=Math.random())}.bind(this)))}return W(se,[{key:"enable",value:function(){me?(this.disable(),this.noSleepTimer=window.setInterval(function(){window.location.href="/",window.setTimeout(window.stop,0)},15e3)):this.noSleepVideo.play()}},{key:"disable",value:function(){me?this.noSleepTimer&&(window.clearInterval(this.noSleepTimer),this.noSleepTimer=null):this.noSleepVideo.pause()}}]),se}();A.exports=Q},function(A,S,D){A.exports="data:video/mp4;base64,AAAAIGZ0eXBtcDQyAAACAGlzb21pc28yYXZjMW1wNDEAAAAIZnJlZQAACKBtZGF0AAAC8wYF///v3EXpvebZSLeWLNgg2SPu73gyNjQgLSBjb3JlIDE0MiByMjQ3OSBkZDc5YTYxIC0gSC4yNjQvTVBFRy00IEFWQyBjb2RlYyAtIENvcHlsZWZ0IDIwMDMtMjAxNCAtIGh0dHA6Ly93d3cudmlkZW9sYW4ub3JnL3gyNjQuaHRtbCAtIG9wdGlvbnM6IGNhYmFjPTEgcmVmPTEgZGVibG9jaz0xOjA6MCBhbmFseXNlPTB4MToweDExMSBtZT1oZXggc3VibWU9MiBwc3k9MSBwc3lfcmQ9MS4wMDowLjAwIG1peGVkX3JlZj0wIG1lX3JhbmdlPTE2IGNocm9tYV9tZT0xIHRyZWxsaXM9MCA4eDhkY3Q9MCBjcW09MCBkZWFkem9uZT0yMSwxMSBmYXN0X3Bza2lwPTEgY2hyb21hX3FwX29mZnNldD0wIHRocmVhZHM9NiBsb29rYWhlYWRfdGhyZWFkcz0xIHNsaWNlZF90aHJlYWRzPTAgbnI9MCBkZWNpbWF0ZT0xIGludGVybGFjZWQ9MCBibHVyYXlfY29tcGF0PTAgY29uc3RyYWluZWRfaW50cmE9MCBiZnJhbWVzPTMgYl9weXJhbWlkPTIgYl9hZGFwdD0xIGJfYmlhcz0wIGRpcmVjdD0xIHdlaWdodGI9MSBvcGVuX2dvcD0wIHdlaWdodHA9MSBrZXlpbnQ9MzAwIGtleWludF9taW49MzAgc2NlbmVjdXQ9NDAgaW50cmFfcmVmcmVzaD0wIHJjX2xvb2thaGVhZD0xMCByYz1jcmYgbWJ0cmVlPTEgY3JmPTIwLjAgcWNvbXA9MC42MCBxcG1pbj0wIHFwbWF4PTY5IHFwc3RlcD00IHZidl9tYXhyYXRlPTIwMDAwIHZidl9idWZzaXplPTI1MDAwIGNyZl9tYXg9MC4wIG5hbF9ocmQ9bm9uZSBmaWxsZXI9MCBpcF9yYXRpbz0xLjQwIGFxPTE6MS4wMACAAAAAOWWIhAA3//p+C7v8tDDSTjf97w55i3SbRPO4ZY+hkjD5hbkAkL3zpJ6h/LR1CAABzgB1kqqzUorlhQAAAAxBmiQYhn/+qZYADLgAAAAJQZ5CQhX/AAj5IQADQGgcIQADQGgcAAAACQGeYUQn/wALKCEAA0BoHAAAAAkBnmNEJ/8ACykhAANAaBwhAANAaBwAAAANQZpoNExDP/6plgAMuSEAA0BoHAAAAAtBnoZFESwr/wAI+SEAA0BoHCEAA0BoHAAAAAkBnqVEJ/8ACykhAANAaBwAAAAJAZ6nRCf/AAsoIQADQGgcIQADQGgcAAAADUGarDRMQz/+qZYADLghAANAaBwAAAALQZ7KRRUsK/8ACPkhAANAaBwAAAAJAZ7pRCf/AAsoIQADQGgcIQADQGgcAAAACQGe60Qn/wALKCEAA0BoHAAAAA1BmvA0TEM//qmWAAy5IQADQGgcIQADQGgcAAAAC0GfDkUVLCv/AAj5IQADQGgcAAAACQGfLUQn/wALKSEAA0BoHCEAA0BoHAAAAAkBny9EJ/8ACyghAANAaBwAAAANQZs0NExDP/6plgAMuCEAA0BoHAAAAAtBn1JFFSwr/wAI+SEAA0BoHCEAA0BoHAAAAAkBn3FEJ/8ACyghAANAaBwAAAAJAZ9zRCf/AAsoIQADQGgcIQADQGgcAAAADUGbeDRMQz/+qZYADLkhAANAaBwAAAALQZ+WRRUsK/8ACPghAANAaBwhAANAaBwAAAAJAZ+1RCf/AAspIQADQGgcAAAACQGft0Qn/wALKSEAA0BoHCEAA0BoHAAAAA1Bm7w0TEM//qmWAAy4IQADQGgcAAAAC0Gf2kUVLCv/AAj5IQADQGgcAAAACQGf+UQn/wALKCEAA0BoHCEAA0BoHAAAAAkBn/tEJ/8ACykhAANAaBwAAAANQZvgNExDP/6plgAMuSEAA0BoHCEAA0BoHAAAAAtBnh5FFSwr/wAI+CEAA0BoHAAAAAkBnj1EJ/8ACyghAANAaBwhAANAaBwAAAAJAZ4/RCf/AAspIQADQGgcAAAADUGaJDRMQz/+qZYADLghAANAaBwAAAALQZ5CRRUsK/8ACPkhAANAaBwhAANAaBwAAAAJAZ5hRCf/AAsoIQADQGgcAAAACQGeY0Qn/wALKSEAA0BoHCEAA0BoHAAAAA1Bmmg0TEM//qmWAAy5IQADQGgcAAAAC0GehkUVLCv/AAj5IQADQGgcIQADQGgcAAAACQGepUQn/wALKSEAA0BoHAAAAAkBnqdEJ/8ACyghAANAaBwAAAANQZqsNExDP/6plgAMuCEAA0BoHCEAA0BoHAAAAAtBnspFFSwr/wAI+SEAA0BoHAAAAAkBnulEJ/8ACyghAANAaBwhAANAaBwAAAAJAZ7rRCf/AAsoIQADQGgcAAAADUGa8DRMQz/+qZYADLkhAANAaBwhAANAaBwAAAALQZ8ORRUsK/8ACPkhAANAaBwAAAAJAZ8tRCf/AAspIQADQGgcIQADQGgcAAAACQGfL0Qn/wALKCEAA0BoHAAAAA1BmzQ0TEM//qmWAAy4IQADQGgcAAAAC0GfUkUVLCv/AAj5IQADQGgcIQADQGgcAAAACQGfcUQn/wALKCEAA0BoHAAAAAkBn3NEJ/8ACyghAANAaBwhAANAaBwAAAANQZt4NExC//6plgAMuSEAA0BoHAAAAAtBn5ZFFSwr/wAI+CEAA0BoHCEAA0BoHAAAAAkBn7VEJ/8ACykhAANAaBwAAAAJAZ+3RCf/AAspIQADQGgcAAAADUGbuzRMQn/+nhAAYsAhAANAaBwhAANAaBwAAAAJQZ/aQhP/AAspIQADQGgcAAAACQGf+UQn/wALKCEAA0BoHCEAA0BoHCEAA0BoHCEAA0BoHCEAA0BoHCEAA0BoHAAACiFtb292AAAAbG12aGQAAAAA1YCCX9WAgl8AAAPoAAAH/AABAAABAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADAAAAGGlvZHMAAAAAEICAgAcAT////v7/AAAF+XRyYWsAAABcdGtoZAAAAAPVgIJf1YCCXwAAAAEAAAAAAAAH0AAAAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAEAAAAAAygAAAMoAAAAAACRlZHRzAAAAHGVsc3QAAAAAAAAAAQAAB9AAABdwAAEAAAAABXFtZGlhAAAAIG1kaGQAAAAA1YCCX9WAgl8AAV+QAAK/IFXEAAAAAAAtaGRscgAAAAAAAAAAdmlkZQAAAAAAAAAAAAAAAFZpZGVvSGFuZGxlcgAAAAUcbWluZgAAABR2bWhkAAAAAQAAAAAAAAAAAAAAJGRpbmYAAAAcZHJlZgAAAAAAAAABAAAADHVybCAAAAABAAAE3HN0YmwAAACYc3RzZAAAAAAAAAABAAAAiGF2YzEAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAygDKAEgAAABIAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAY//8AAAAyYXZjQwFNQCj/4QAbZ01AKOyho3ySTUBAQFAAAAMAEAAr8gDxgxlgAQAEaO+G8gAAABhzdHRzAAAAAAAAAAEAAAA8AAALuAAAABRzdHNzAAAAAAAAAAEAAAABAAAB8GN0dHMAAAAAAAAAPAAAAAEAABdwAAAAAQAAOpgAAAABAAAXcAAAAAEAAAAAAAAAAQAAC7gAAAABAAA6mAAAAAEAABdwAAAAAQAAAAAAAAABAAALuAAAAAEAADqYAAAAAQAAF3AAAAABAAAAAAAAAAEAAAu4AAAAAQAAOpgAAAABAAAXcAAAAAEAAAAAAAAAAQAAC7gAAAABAAA6mAAAAAEAABdwAAAAAQAAAAAAAAABAAALuAAAAAEAADqYAAAAAQAAF3AAAAABAAAAAAAAAAEAAAu4AAAAAQAAOpgAAAABAAAXcAAAAAEAAAAAAAAAAQAAC7gAAAABAAA6mAAAAAEAABdwAAAAAQAAAAAAAAABAAALuAAAAAEAADqYAAAAAQAAF3AAAAABAAAAAAAAAAEAAAu4AAAAAQAAOpgAAAABAAAXcAAAAAEAAAAAAAAAAQAAC7gAAAABAAA6mAAAAAEAABdwAAAAAQAAAAAAAAABAAALuAAAAAEAADqYAAAAAQAAF3AAAAABAAAAAAAAAAEAAAu4AAAAAQAAOpgAAAABAAAXcAAAAAEAAAAAAAAAAQAAC7gAAAABAAA6mAAAAAEAABdwAAAAAQAAAAAAAAABAAALuAAAAAEAAC7gAAAAAQAAF3AAAAABAAAAAAAAABxzdHNjAAAAAAAAAAEAAAABAAAAAQAAAAEAAAEEc3RzegAAAAAAAAAAAAAAPAAAAzQAAAAQAAAADQAAAA0AAAANAAAAEQAAAA8AAAANAAAADQAAABEAAAAPAAAADQAAAA0AAAARAAAADwAAAA0AAAANAAAAEQAAAA8AAAANAAAADQAAABEAAAAPAAAADQAAAA0AAAARAAAADwAAAA0AAAANAAAAEQAAAA8AAAANAAAADQAAABEAAAAPAAAADQAAAA0AAAARAAAADwAAAA0AAAANAAAAEQAAAA8AAAANAAAADQAAABEAAAAPAAAADQAAAA0AAAARAAAADwAAAA0AAAANAAAAEQAAAA8AAAANAAAADQAAABEAAAANAAAADQAAAQBzdGNvAAAAAAAAADwAAAAwAAADZAAAA3QAAAONAAADoAAAA7kAAAPQAAAD6wAAA/4AAAQXAAAELgAABEMAAARcAAAEbwAABIwAAAShAAAEugAABM0AAATkAAAE/wAABRIAAAUrAAAFQgAABV0AAAVwAAAFiQAABaAAAAW1AAAFzgAABeEAAAX+AAAGEwAABiwAAAY/AAAGVgAABnEAAAaEAAAGnQAABrQAAAbPAAAG4gAABvUAAAcSAAAHJwAAB0AAAAdTAAAHcAAAB4UAAAeeAAAHsQAAB8gAAAfjAAAH9gAACA8AAAgmAAAIQQAACFQAAAhnAAAIhAAACJcAAAMsdHJhawAAAFx0a2hkAAAAA9WAgl/VgIJfAAAAAgAAAAAAAAf8AAAAAAAAAAAAAAABAQAAAAABAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAACsm1kaWEAAAAgbWRoZAAAAADVgIJf1YCCXwAArEQAAWAAVcQAAAAAACdoZGxyAAAAAAAAAABzb3VuAAAAAAAAAAAAAAAAU3RlcmVvAAAAAmNtaW5mAAAAEHNtaGQAAAAAAAAAAAAAACRkaW5mAAAAHGRyZWYAAAAAAAAAAQAAAAx1cmwgAAAAAQAAAidzdGJsAAAAZ3N0c2QAAAAAAAAAAQAAAFdtcDRhAAAAAAAAAAEAAAAAAAAAAAACABAAAAAArEQAAAAAADNlc2RzAAAAAAOAgIAiAAIABICAgBRAFQAAAAADDUAAAAAABYCAgAISEAaAgIABAgAAABhzdHRzAAAAAAAAAAEAAABYAAAEAAAAABxzdHNjAAAAAAAAAAEAAAABAAAAAQAAAAEAAAAUc3RzegAAAAAAAAAGAAAAWAAAAXBzdGNvAAAAAAAAAFgAAAOBAAADhwAAA5oAAAOtAAADswAAA8oAAAPfAAAD5QAAA/gAAAQLAAAEEQAABCgAAAQ9AAAEUAAABFYAAARpAAAEgAAABIYAAASbAAAErgAABLQAAATHAAAE3gAABPMAAAT5AAAFDAAABR8AAAUlAAAFPAAABVEAAAVXAAAFagAABX0AAAWDAAAFmgAABa8AAAXCAAAFyAAABdsAAAXyAAAF+AAABg0AAAYgAAAGJgAABjkAAAZQAAAGZQAABmsAAAZ+AAAGkQAABpcAAAauAAAGwwAABskAAAbcAAAG7wAABwYAAAcMAAAHIQAABzQAAAc6AAAHTQAAB2QAAAdqAAAHfwAAB5IAAAeYAAAHqwAAB8IAAAfXAAAH3QAAB/AAAAgDAAAICQAACCAAAAg1AAAIOwAACE4AAAhhAAAIeAAACH4AAAiRAAAIpAAACKoAAAiwAAAItgAACLwAAAjCAAAAFnVkdGEAAAAObmFtZVN0ZXJlbwAAAHB1ZHRhAAAAaG1ldGEAAAAAAAAAIWhkbHIAAAAAAAAAAG1kaXJhcHBsAAAAAAAAAAAAAAAAO2lsc3QAAAAzqXRvbwAAACtkYXRhAAAAAQAAAABIYW5kQnJha2UgMC4xMC4yIDIwMTUwNjExMDA="}])})}),KA=qA(QA),$A=1e3,ZA=[0,0,.5,1],JA=[.5,0,.5,1],e2=window.requestAnimationFrame,t2=window.cancelAnimationFrame;function i2(){this.leftProjectionMatrix=new Float32Array(16),this.leftViewMatrix=new Float32Array(16),this.rightProjectionMatrix=new Float32Array(16),this.rightViewMatrix=new Float32Array(16),this.pose=null}function Ep(p){Object.defineProperties(this,{hasPosition:{writable:!1,enumerable:!0,value:p.hasPosition},hasExternalDisplay:{writable:!1,enumerable:!0,value:p.hasExternalDisplay},canPresent:{writable:!1,enumerable:!0,value:p.canPresent},maxLayers:{writable:!1,enumerable:!0,value:p.maxLayers},hasOrientation:{enumerable:!0,get:function(){return Bo("VRDisplayCapabilities.prototype.hasOrientation","VRDisplay.prototype.getFrameData"),p.hasOrientation}}})}function oi(p){p=p||{};var _="wakelock"in p?p.wakelock:!0;this.isPolyfilled=!0,this.displayId=$A++,this.displayName="",this.depthNear=.01,this.depthFar=1e4,this.isPresenting=!1,Object.defineProperty(this,"isConnected",{get:function(){return Bo("VRDisplay.prototype.isConnected","VRDisplayCapabilities.prototype.hasExternalDisplay"),!1}}),this.capabilities=new Ep({hasPosition:!1,hasOrientation:!1,hasExternalDisplay:!1,canPresent:!1,maxLayers:1}),this.stageParameters=null,this.waitingForPresent_=!1,this.layer_=null,this.originalParent_=null,this.fullscreenElement_=null,this.fullscreenWrapper_=null,this.fullscreenElementCachedStyle_=null,this.fullscreenEventTarget_=null,this.fullscreenChangeHandler_=null,this.fullscreenErrorHandler_=null,_&&Vs()&&(this.wakelock_=new KA)}oi.prototype.getFrameData=function(p){return _i(p,this._getPose(),this)},oi.prototype.getPose=function(){return Bo("VRDisplay.prototype.getPose","VRDisplay.prototype.getFrameData"),this._getPose()},oi.prototype.resetPose=function(){return Bo("VRDisplay.prototype.resetPose"),this._resetPose()},oi.prototype.getImmediatePose=function(){return Bo("VRDisplay.prototype.getImmediatePose","VRDisplay.prototype.getFrameData"),this._getPose()},oi.prototype.requestAnimationFrame=function(p){return e2(p)},oi.prototype.cancelAnimationFrame=function(p){return t2(p)},oi.prototype.wrapForFullscreen=function(p){if(ge())return p;if(!this.fullscreenWrapper_){this.fullscreenWrapper_=document.createElement("div");var _=["height: "+Math.min(screen.height,screen.width)+"px !important","top: 0 !important","left: 0 !important","right: 0 !important","border: 0","margin: 0","padding: 0","z-index: 999999 !important","position: fixed"];this.fullscreenWrapper_.setAttribute("style",_.join("; ")+";"),this.fullscreenWrapper_.classList.add("webvr-polyfill-fullscreen-wrapper")}if(this.fullscreenElement_==p)return this.fullscreenWrapper_;if(this.fullscreenElement_&&(this.originalParent_?this.originalParent_.appendChild(this.fullscreenElement_):this.fullscreenElement_.parentElement.removeChild(this.fullscreenElement_)),this.fullscreenElement_=p,this.originalParent_=p.parentElement,this.originalParent_||document.body.appendChild(p),!this.fullscreenWrapper_.parentElement){var A=this.fullscreenElement_.parentElement;A.insertBefore(this.fullscreenWrapper_,this.fullscreenElement_),A.removeChild(this.fullscreenElement_)}this.fullscreenWrapper_.insertBefore(this.fullscreenElement_,this.fullscreenWrapper_.firstChild),this.fullscreenElementCachedStyle_=this.fullscreenElement_.getAttribute("style");var S=this;function D(){if(S.fullscreenElement_){var W=["position: absolute","top: 0","left: 0","width: "+Math.max(screen.width,screen.height)+"px","height: "+Math.min(screen.height,screen.width)+"px","border: 0","margin: 0","padding: 0"];S.fullscreenElement_.setAttribute("style",W.join("; ")+";")}}return D(),this.fullscreenWrapper_},oi.prototype.removeFullscreenWrapper=function(){if(this.fullscreenElement_){var p=this.fullscreenElement_;this.fullscreenElementCachedStyle_?p.setAttribute("style",this.fullscreenElementCachedStyle_):p.removeAttribute("style"),this.fullscreenElement_=null,this.fullscreenElementCachedStyle_=null;var _=this.fullscreenWrapper_.parentElement;return this.fullscreenWrapper_.removeChild(p),this.originalParent_===_?_.insertBefore(p,this.fullscreenWrapper_):this.originalParent_&&this.originalParent_.appendChild(p),_.removeChild(this.fullscreenWrapper_),p}},oi.prototype.requestPresent=function(p){var _=this.isPresenting,A=this;return p instanceof Array||(Bo("VRDisplay.prototype.requestPresent with non-array argument","an array of VRLayers as the first argument"),p=[p]),new Promise(function(S,D){if(!A.capabilities.canPresent){D(new Error("VRDisplay is not capable of presenting."));return}if(p.length==0||p.length>A.capabilities.maxLayers){D(new Error("Invalid number of layers."));return}var W=p[0];if(!W.source){S();return}var j=W.leftBounds||ZA,fe=W.rightBounds||JA;if(_){var me=A.layer_;me.source!==W.source&&(me.source=W.source);for(var Q=0;Q<4;Q++)me.leftBounds[Q]=j[Q],me.rightBounds[Q]=fe[Q];A.wrapForFullscreen(A.layer_.source),A.updatePresent_(),S();return}if(A.layer_={predistorted:W.predistorted,source:W.source,leftBounds:j.slice(0),rightBounds:fe.slice(0)},A.waitingForPresent_=!1,A.layer_&&A.layer_.source){var se=A.wrapForFullscreen(A.layer_.source),Ae=function(){var rt=Kn();A.isPresenting=se===rt,A.isPresenting?(screen.orientation&&screen.orientation.lock&&screen.orientation.lock("landscape-primary").catch(function(yt){console.error("screen.orientation.lock() failed due to",yt.message)}),A.waitingForPresent_=!1,A.beginPresent_(),S()):(screen.orientation&&screen.orientation.unlock&&screen.orientation.unlock(),A.removeFullscreenWrapper(),A.disableWakeLock(),A.endPresent_(),A.removeFullscreenListeners_()),A.fireVRDisplayPresentChange_()},qe=function(){A.waitingForPresent_&&(A.removeFullscreenWrapper(),A.removeFullscreenListeners_(),A.disableWakeLock(),A.waitingForPresent_=!1,A.isPresenting=!1,D(new Error("Unable to present.")))};A.addFullscreenListeners_(se,Ae,qe),It(se)?(A.enableWakeLock(),A.waitingForPresent_=!0):(ge()||He())&&(A.enableWakeLock(),A.isPresenting=!0,A.beginPresent_(),A.fireVRDisplayPresentChange_(),S())}!A.waitingForPresent_&&!ge()&&(_t(),D(new Error("Unable to present.")))})},oi.prototype.exitPresent=function(){var p=this.isPresenting,_=this;return this.isPresenting=!1,this.layer_=null,this.disableWakeLock(),new Promise(function(A,S){p?(!_t()&&ge()&&(_.endPresent_(),_.fireVRDisplayPresentChange_()),He()&&(_.removeFullscreenWrapper(),_.removeFullscreenListeners_(),_.endPresent_(),_.fireVRDisplayPresentChange_()),A()):S(new Error("Was not presenting to VRDisplay."))})},oi.prototype.getLayers=function(){return this.layer_?[this.layer_]:[]},oi.prototype.fireVRDisplayPresentChange_=function(){var p=new CustomEvent("vrdisplaypresentchange",{detail:{display:this}});window.dispatchEvent(p)},oi.prototype.fireVRDisplayConnect_=function(){var p=new CustomEvent("vrdisplayconnect",{detail:{display:this}});window.dispatchEvent(p)},oi.prototype.addFullscreenListeners_=function(p,_,A){this.removeFullscreenListeners_(),this.fullscreenEventTarget_=p,this.fullscreenChangeHandler_=_,this.fullscreenErrorHandler_=A,_&&(document.fullscreenEnabled?p.addEventListener("fullscreenchange",_,!1):document.webkitFullscreenEnabled?p.addEventListener("webkitfullscreenchange",_,!1):document.mozFullScreenEnabled?document.addEventListener("mozfullscreenchange",_,!1):document.msFullscreenEnabled&&p.addEventListener("msfullscreenchange",_,!1)),A&&(document.fullscreenEnabled?p.addEventListener("fullscreenerror",A,!1):document.webkitFullscreenEnabled?p.addEventListener("webkitfullscreenerror",A,!1):document.mozFullScreenEnabled?document.addEventListener("mozfullscreenerror",A,!1):document.msFullscreenEnabled&&p.addEventListener("msfullscreenerror",A,!1))},oi.prototype.removeFullscreenListeners_=function(){if(this.fullscreenEventTarget_){var p=this.fullscreenEventTarget_;if(this.fullscreenChangeHandler_){var _=this.fullscreenChangeHandler_;p.removeEventListener("fullscreenchange",_,!1),p.removeEventListener("webkitfullscreenchange",_,!1),document.removeEventListener("mozfullscreenchange",_,!1),p.removeEventListener("msfullscreenchange",_,!1)}if(this.fullscreenErrorHandler_){var A=this.fullscreenErrorHandler_;p.removeEventListener("fullscreenerror",A,!1),p.removeEventListener("webkitfullscreenerror",A,!1),document.removeEventListener("mozfullscreenerror",A,!1),p.removeEventListener("msfullscreenerror",A,!1)}this.fullscreenEventTarget_=null,this.fullscreenChangeHandler_=null,this.fullscreenErrorHandler_=null}},oi.prototype.enableWakeLock=function(){this.wakelock_&&this.wakelock_.enable()},oi.prototype.disableWakeLock=function(){this.wakelock_&&this.wakelock_.disable()},oi.prototype.beginPresent_=function(){},oi.prototype.endPresent_=function(){},oi.prototype.submitFrame=function(p){},oi.prototype.getEyeParameters=function(p){return null};var n2={ADDITIONAL_VIEWERS:[],DEFAULT_VIEWER:"",MOBILE_WAKE_LOCK:!0,DEBUG:!1,DPDB_URL:"https://dpdb.webvr.rocks/dpdb.json",K_FILTER:.98,PREDICTION_TIME_S:.04,CARDBOARD_UI_DISABLED:!1,ROTATE_INSTRUCTIONS_DISABLED:!1,YAW_ONLY:!1,BUFFER_SCALE:.5,DIRTY_SUBMIT_FRAME_BINDINGS:!1},fc={LEFT:"left",RIGHT:"right"};function Ti(p){var _=so({},n2);p=so(_,p||{}),oi.call(this,{wakelock:p.MOBILE_WAKE_LOCK}),this.config=p,this.displayName="Cardboard VRDisplay",this.capabilities=new Ep({hasPosition:!1,hasOrientation:!0,hasExternalDisplay:!1,canPresent:!0,maxLayers:1}),this.stageParameters=null,this.bufferScale_=this.config.BUFFER_SCALE,this.poseSensor_=new GA(this.config),this.distorter_=null,this.cardboardUI_=null,this.dpdb_=new Ea(this.config.DPDB_URL,this.onDeviceParamsUpdated_.bind(this)),this.deviceInfo_=new Ei(this.dpdb_.getDeviceParams(),p.ADDITIONAL_VIEWERS),this.viewerSelector_=new Dn(p.DEFAULT_VIEWER),this.viewerSelector_.onChange(this.onViewerChanged_.bind(this)),this.deviceInfo_.setViewer(this.viewerSelector_.getCurrentViewer()),this.config.ROTATE_INSTRUCTIONS_DISABLED||(this.rotateInstructions_=new zo),ge()&&window.addEventListener("resize",this.onResize_.bind(this))}return Ti.prototype=Object.create(oi.prototype),Ti.prototype._getPose=function(){return{position:null,orientation:this.poseSensor_.getOrientation(),linearVelocity:null,linearAcceleration:null,angularVelocity:null,angularAcceleration:null}},Ti.prototype._resetPose=function(){this.poseSensor_.resetPose&&this.poseSensor_.resetPose()},Ti.prototype._getFieldOfView=function(p){var _;if(p==fc.LEFT)_=this.deviceInfo_.getFieldOfViewLeftEye();else if(p==fc.RIGHT)_=this.deviceInfo_.getFieldOfViewRightEye();else return console.error("Invalid eye provided: %s",p),null;return _},Ti.prototype._getEyeOffset=function(p){var _;if(p==fc.LEFT)_=[-this.deviceInfo_.viewer.interLensDistance*.5,0,0];else if(p==fc.RIGHT)_=[this.deviceInfo_.viewer.interLensDistance*.5,0,0];else return console.error("Invalid eye provided: %s",p),null;return _},Ti.prototype.getEyeParameters=function(p){var _=this._getEyeOffset(p),A=this._getFieldOfView(p),S={offset:_,renderWidth:this.deviceInfo_.device.width*.5*this.bufferScale_,renderHeight:this.deviceInfo_.device.height*this.bufferScale_};return Object.defineProperty(S,"fieldOfView",{enumerable:!0,get:function(){return Bo("VRFieldOfView","VRFrameData's projection matrices"),A}}),S},Ti.prototype.onDeviceParamsUpdated_=function(p){this.config.DEBUG&&console.log("DPDB reported that device params were updated."),this.deviceInfo_.updateDeviceParams(p),this.distorter_&&this.distorter_.updateDeviceInfo(this.deviceInfo_)},Ti.prototype.updateBounds_=function(){this.layer_&&this.distorter_&&(this.layer_.leftBounds||this.layer_.rightBounds)&&this.distorter_.setTextureBounds(this.layer_.leftBounds,this.layer_.rightBounds)},Ti.prototype.beginPresent_=function(){var p=this.layer_.source.getContext("webgl");p||(p=this.layer_.source.getContext("experimental-webgl")),p||(p=this.layer_.source.getContext("webgl2")),p&&(this.layer_.predistorted?this.config.CARDBOARD_UI_DISABLED||(p.canvas.width=bt()*this.bufferScale_,p.canvas.height=St()*this.bufferScale_,this.cardboardUI_=new No(p)):(this.config.CARDBOARD_UI_DISABLED||(this.cardboardUI_=new No(p)),this.distorter_=new $n(p,this.cardboardUI_,this.config.BUFFER_SCALE,this.config.DIRTY_SUBMIT_FRAME_BINDINGS),this.distorter_.updateDeviceInfo(this.deviceInfo_)),this.cardboardUI_&&this.cardboardUI_.listen(function(_){this.viewerSelector_.show(this.layer_.source.parentElement),_.stopPropagation(),_.preventDefault()}.bind(this),function(_){this.exitPresent(),_.stopPropagation(),_.preventDefault()}.bind(this)),this.rotateInstructions_&&(ci()&&Vs()?this.rotateInstructions_.showTemporarily(3e3,this.layer_.source.parentElement):this.rotateInstructions_.update()),this.orientationHandler=this.onOrientationChange_.bind(this),window.addEventListener("orientationchange",this.orientationHandler),this.vrdisplaypresentchangeHandler=this.updateBounds_.bind(this),window.addEventListener("vrdisplaypresentchange",this.vrdisplaypresentchangeHandler),this.fireVRDisplayDeviceParamsChange_())},Ti.prototype.endPresent_=function(){this.distorter_&&(this.distorter_.destroy(),this.distorter_=null),this.cardboardUI_&&(this.cardboardUI_.destroy(),this.cardboardUI_=null),this.rotateInstructions_&&this.rotateInstructions_.hide(),this.viewerSelector_.hide(),window.removeEventListener("orientationchange",this.orientationHandler),window.removeEventListener("vrdisplaypresentchange",this.vrdisplaypresentchangeHandler)},Ti.prototype.updatePresent_=function(){this.endPresent_(),this.beginPresent_()},Ti.prototype.submitFrame=function(p){if(this.distorter_)this.updateBounds_(),this.distorter_.submitFrame();else if(this.cardboardUI_&&this.layer_){var _=this.layer_.source.getContext("webgl");_||(_=this.layer_.source.getContext("experimental-webgl")),_||(_=this.layer_.source.getContext("webgl2"));var A=_.canvas;(A.width!=this.lastWidth||A.height!=this.lastHeight)&&this.cardboardUI_.onResize(),this.lastWidth=A.width,this.lastHeight=A.height,this.cardboardUI_.render()}},Ti.prototype.onOrientationChange_=function(p){this.viewerSelector_.hide(),this.rotateInstructions_&&this.rotateInstructions_.update(),this.onResize_()},Ti.prototype.onResize_=function(p){if(this.layer_){var _=this.layer_.source.getContext("webgl");_||(_=this.layer_.source.getContext("experimental-webgl")),_||(_=this.layer_.source.getContext("webgl2"));var A=["position: absolute","top: 0","left: 0","width: 100vw","height: 100vh","border: 0","margin: 0","padding: 0px","box-sizing: content-box"];_.canvas.setAttribute("style",A.join("; ")+";"),Gs(_.canvas)}},Ti.prototype.onViewerChanged_=function(p){this.deviceInfo_.setViewer(p),this.distorter_&&this.distorter_.updateDeviceInfo(this.deviceInfo_),this.fireVRDisplayDeviceParamsChange_()},Ti.prototype.fireVRDisplayDeviceParamsChange_=function(){var p=new CustomEvent("vrdisplaydeviceparamschange",{detail:{vrdisplay:this,deviceInfo:this.deviceInfo_}});window.dispatchEvent(p)},Ti.VRFrameData=i2,Ti.VRDisplay=oi,Ti})}),qy=Wy(Xy);class op extends t{constructor(f){super(),this.global=f,this.onWindowResize=this.onWindowResize.bind(this),this.global.window.addEventListener("resize",this.onWindowResize),this.environmentBlendMode="opaque"}onBaseLayerSet(f,T){throw new Error("Not implemented")}isSessionSupported(f){throw new Error("Not implemented")}isFeatureSupported(f){throw new Error("Not implemented")}requestSession(f,T){return Dt(this,null,function*(){throw new Error("Not implemented")})}requestAnimationFrame(f){throw new Error("Not implemented")}onFrameStart(f){throw new Error("Not implemented")}onFrameEnd(f){throw new Error("Not implemented")}doesSessionSupportReferenceSpace(f,T){throw new Error("Not implemented")}requestStageBounds(){throw new Error("Not implemented")}requestFrameOfReferenceTransform(f,T){return Dt(this,null,function*(){})}cancelAnimationFrame(f){throw new Error("Not implemented")}endSession(f){throw new Error("Not implemented")}getViewport(f,T,P,V){throw new Error("Not implemented")}getProjectionMatrix(f){throw new Error("Not implemented")}getBasePoseMatrix(){throw new Error("Not implemented")}getBaseViewMatrix(f){throw new Error("Not implemented")}getInputSources(){throw new Error("Not implemented")}getInputPose(f,T,P){throw new Error("Not implemented")}onWindowResize(){this.onWindowResize()}}let Yy={mapping:"",profiles:["google-daydream","generic-trigger-touchpad"],buttons:{length:3,0:null,1:null,2:0}},Qy={mapping:"xr-standard",profiles:["htc-vive-focus","generic-trigger-touchpad"],buttons:{length:3,0:1,1:null,2:0}},Ky={mapping:"xr-standard",profiles:["oculus-go","generic-trigger-touchpad"],buttons:{length:3,0:1,1:null,2:0},gripTransform:{orientation:[Math.PI*.11,0,0,1]}},rp={mapping:"xr-standard",displayProfiles:{"Oculus Quest":["oculus-touch-v2","oculus-touch","generic-trigger-squeeze-thumbstick"]},profiles:["oculus-touch","generic-trigger-squeeze-thumbstick"],axes:{length:4,0:null,1:null,2:0,3:1},buttons:{length:7,0:1,1:2,2:null,3:0,4:3,5:4,6:null},gripTransform:{position:[0,-.02,.04,1],orientation:[Math.PI*.11,0,0,1]}},$y={mapping:"xr-standard",profiles:["htc-vive","generic-trigger-squeeze-touchpad"],displayProfiles:{"HTC Vive":["htc-vive","generic-trigger-squeeze-touchpad"],"HTC Vive DVT":["htc-vive","generic-trigger-squeeze-touchpad"],"Valve Index":["valve-index","generic-trigger-squeeze-touchpad-thumbstick"]},buttons:{length:3,0:1,1:2,2:0},gripTransform:{position:[0,0,.05,1]},targetRayTransform:{orientation:[Math.PI*-.08,0,0,1]},userAgentOverrides:{Firefox:{axes:{invert:[1,3]}}}},Zy={mapping:"xr-standard",profiles:["samsung-gearvr","generic-trigger-touchpad"],buttons:{length:3,0:1,1:null,2:0},gripTransform:{orientation:[Math.PI*.11,0,0,1]}},Jy={mapping:"xr-standard",profiles:["samsung-odyssey","microsoft-mixed-reality","generic-trigger-squeeze-touchpad-thumbstick"],buttons:{length:4,0:1,1:0,2:2,3:4},gripTransform:{position:[0,-.02,.04,1],orientation:[Math.PI*.11,0,0,1]}},md={mapping:"xr-standard",profiles:["microsoft-mixed-reality","generic-trigger-squeeze-touchpad-thumbstick"],buttons:{length:4,0:1,1:0,2:2,3:4},gripTransform:{position:[0,-.02,.04,1],orientation:[Math.PI*.11,0,0,1]}},eA={"Daydream Controller":Yy,"Gear VR Controller":Zy,"HTC Vive Focus Controller":Qy,"Oculus Go Controller":Ky,"Oculus Touch (Right)":rp,"Oculus Touch (Left)":rp,"OpenVR Gamepad":$y,"Spatial Controller (Spatial Interaction Source) 045E-065A":md,"Spatial Controller (Spatial Interaction Source) 045E-065D":Jy,"Windows Mixed Reality (Right)":md,"Windows Mixed Reality (Left)":md};const ap=w(.155,-.465,-.15),tA=w(-.155,-.465,-.15),iA=w(0,0,-.25),nA=w(0,0,.05),lp=w(-.08,.14,.08),cp=.4,sA=.4,oA=.61,rA=.175,aA=.12,lA=.87,hp=180/Math.PI;function cA(y,f,T){function P(Se,ge,He){return Se<ge?ge:Se>He?He:Se}var V=f[0]*f[0],Y=f[1]*f[1],ee=f[2]*f[2],oe=f[3]*f[3];if(T==="XYZ")y[0]=Math.atan2(2*(f[0]*f[3]-f[1]*f[2]),oe-V-Y+ee),y[1]=Math.asin(P(2*(f[0]*f[2]+f[1]*f[3]),-1,1)),y[2]=Math.atan2(2*(f[2]*f[3]-f[0]*f[1]),oe+V-Y-ee);else if(T==="YXZ")y[0]=Math.asin(P(2*(f[0]*f[3]-f[1]*f[2]),-1,1)),y[1]=Math.atan2(2*(f[0]*f[2]+f[1]*f[3]),oe-V-Y+ee),y[2]=Math.atan2(2*(f[0]*f[1]+f[2]*f[3]),oe-V+Y-ee);else if(T==="ZXY")y[0]=Math.asin(P(2*(f[0]*f[3]+f[1]*f[2]),-1,1)),y[1]=Math.atan2(2*(f[1]*f[3]-f[2]*f[0]),oe-V-Y+ee),y[2]=Math.atan2(2*(f[2]*f[3]-f[0]*f[1]),oe-V+Y-ee);else if(T==="ZYX")y[0]=Math.atan2(2*(f[0]*f[3]+f[2]*f[1]),oe-V-Y+ee),y[1]=Math.asin(P(2*(f[1]*f[3]-f[0]*f[2]),-1,1)),y[2]=Math.atan2(2*(f[0]*f[1]+f[2]*f[3]),oe+V-Y-ee);else if(T==="YZX")y[0]=Math.atan2(2*(f[0]*f[3]-f[2]*f[1]),oe-V+Y-ee),y[1]=Math.atan2(2*(f[1]*f[3]-f[0]*f[2]),oe+V-Y-ee),y[2]=Math.asin(P(2*(f[0]*f[1]+f[2]*f[3]),-1,1));else if(T==="XZY")y[0]=Math.atan2(2*(f[0]*f[3]+f[1]*f[2]),oe-V+Y-ee),y[1]=Math.atan2(2*(f[0]*f[2]+f[1]*f[3]),oe+V-Y-ee),y[2]=Math.asin(P(2*(f[2]*f[3]-f[0]*f[1]),-1,1));else{console.log("No order given for quaternion to euler conversion.");return}}class hA{constructor(){this.hand="right",this.headElbowOffset=ap,this.controllerQ=pe(),this.lastControllerQ=pe(),this.headQ=pe(),this.headPos=x(),this.elbowPos=x(),this.wristPos=x(),this.time=null,this.lastTime=null,this.rootQ=pe(),this.position=x()}setHandedness(f){this.hand!=f&&(this.hand=f,this.hand=="left"?this.headElbowOffset=tA:this.headElbowOffset=ap)}update(f,T){this.time=Ri(),f&&(X(this.lastControllerQ,this.controllerQ),X(this.controllerQ,f)),T&&(m(this.headPos,T),g(this.headQ,T));let P=this.getHeadYawOrientation_(),V=this.quatAngle_(this.lastControllerQ,this.controllerQ),Y=(this.time-this.lastTime)/1e3;V/Y>oA?he(this.rootQ,this.rootQ,P,Math.min(V/rA,1)):X(this.rootQ,P);let oe=w(0,0,-1);J(oe,oe,this.controllerQ);let Se=z(oe,[0,1,0]),ge=this.clamp_((Se-aA)/lA,0,1),He=N(this.rootQ);je(He,He),Re(He,He,this.controllerQ);let it=this.elbowPos;C(it,this.headPos),I(it,it,this.headElbowOffset);let Ft=v(lp);O(Ft,Ft,ge),I(it,it,Ft);let Zt=this.quatAngle_(He,pe())*hp,zt=1-Math.pow(Zt/180,4),Ot=cp,ci=1-cp,ki=zt*(Ot+ci*ge*sA),bt=pe();he(bt,bt,He,ki);let St=je(pe(),bt),It=N(He);Re(It,It,St);let _t=this.wristPos;C(_t,nA),J(_t,_t,bt),I(_t,_t,iA),J(_t,_t,It),I(_t,_t,it);let Kn=v(lp);O(Kn,Kn,ge),I(this.position,this.wristPos,Kn),J(this.position,this.position,this.rootQ),this.lastTime=this.time}getPosition(){return this.position}getHeadYawOrientation_(){let f=x();return cA(f,this.headQ,"YXZ"),B(pe(),0,f[1]*hp,0)}clamp_(f,T,P){return Math.min(Math.max(f,T),P)}quatAngle_(f,T){let P=[0,0,-1],V=[0,0,-1];return J(P,P,f),J(V,V,T),re(P,V)}}const Zi=Symbol("@@webxr-polyfill/XRRemappedGamepad"),dp={pressed:!1,touched:!1,value:0};Object.freeze(dp);class dA{constructor(f,T,P){if(P||(P={}),P.userAgentOverrides){for(let ge in P.userAgentOverrides)if(navigator.userAgent.includes(ge)){let He=P.userAgentOverrides[ge];for(let it in He)it in P?Object.assign(P[it],He[it]):P[it]=He[it];break}}let V=new Array(P.axes&&P.axes.length?P.axes.length:f.axes.length),Y=new Array(P.buttons&&P.buttons.length?P.buttons.length:f.buttons.length),ee=null;if(P.gripTransform){let ge=P.gripTransform.orientation||[0,0,0,1];ee=a(),u(ee,ve(ge,ge),P.gripTransform.position||[0,0,0])}let oe=null;if(P.targetRayTransform){let ge=P.targetRayTransform.orientation||[0,0,0,1];oe=a(),u(oe,ve(ge,ge),P.targetRayTransform.position||[0,0,0])}let Se=P.profiles;P.displayProfiles&&T.displayName in P.displayProfiles&&(Se=P.displayProfiles[T.displayName]),this[Zi]={gamepad:f,map:P,profiles:Se||[f.id],mapping:P.mapping||f.mapping,axes:V,buttons:Y,gripTransform:ee,targetRayTransform:oe},this._update()}_update(){let f=this[Zi].gamepad,T=this[Zi].map,P=this[Zi].axes;for(let Y=0;Y<P.length;++Y)T.axes&&Y in T.axes?T.axes[Y]===null?P[Y]=0:P[Y]=f.axes[T.axes[Y]]:P[Y]=f.axes[Y];if(T.axes&&T.axes.invert)for(let Y of T.axes.invert)Y<P.length&&(P[Y]*=-1);let V=this[Zi].buttons;for(let Y=0;Y<V.length;++Y)T.buttons&&Y in T.buttons?T.buttons[Y]===null?V[Y]=dp:V[Y]=f.buttons[T.buttons[Y]]:V[Y]=f.buttons[Y]}get id(){return""}get _profiles(){return this[Zi].profiles}get index(){return-1}get connected(){return this[Zi].gamepad.connected}get timestamp(){return this[Zi].gamepad.timestamp}get mapping(){return this[Zi].mapping}get axes(){return this[Zi].axes}get buttons(){return this[Zi].buttons}get hapticActuators(){return this[Zi].gamepad.hapticActuators}}class uA{constructor(f,T,P=0,V=-1){this.polyfill=f,this.display=T,this.nativeGamepad=null,this.gamepad=null,this.inputSource=new tp(this),this.lastPosition=x(),this.emulatedPosition=!1,this.basePoseMatrix=a(),this.outputMatrix=a(),this.primaryButtonIndex=P,this.primaryActionPressed=!1,this.primarySqueezeButtonIndex=V,this.primarySqueezeActionPressed=!1,this.handedness="",this.targetRayMode="gaze",this.armModel=null}get profiles(){return this.gamepad?this.gamepad._profiles:[]}updateFromGamepad(f){this.nativeGamepad!==f&&(this.nativeGamepad=f,f?this.gamepad=new dA(f,this.display,eA[f.id]):this.gamepad=null),this.handedness=f.hand===""?"none":f.hand,this.gamepad&&this.gamepad._update(),f.pose?(this.targetRayMode="tracked-pointer",this.emulatedPosition=!f.pose.hasPosition):f.hand===""&&(this.targetRayMode="gaze",this.emulatedPosition=!1)}updateBasePoseMatrix(){if(this.nativeGamepad&&this.nativeGamepad.pose){let f=this.nativeGamepad.pose,T=f.position,P=f.orientation;if(!T&&!P)return;T?(this.lastPosition[0]=T[0],this.lastPosition[1]=T[1],this.lastPosition[2]=T[2]):f.hasPosition?T=this.lastPosition:(this.armModel||(this.armModel=new hA),this.armModel.setHandedness(this.nativeGamepad.hand),this.armModel.update(P,this.polyfill.getBasePoseMatrix()),T=this.armModel.getPosition()),u(this.basePoseMatrix,P,T)}else l(this.basePoseMatrix,this.polyfill.getBasePoseMatrix());return this.basePoseMatrix}getXRPose(f,T){switch(this.updateBasePoseMatrix(),T){case"target-ray":f._transformBasePoseMatrix(this.outputMatrix,this.basePoseMatrix),this.gamepad&&this.gamepad[Zi].targetRayTransform&&d(this.outputMatrix,this.outputMatrix,this.gamepad[Zi].targetRayTransform);break;case"grip":if(!this.nativeGamepad||!this.nativeGamepad.pose)return null;f._transformBasePoseMatrix(this.outputMatrix,this.basePoseMatrix),this.gamepad&&this.gamepad[Zi].gripTransform&&d(this.outputMatrix,this.outputMatrix,this.gamepad[Zi].gripTransform);break;default:return null}return f._adjustForOriginOffset(this.outputMatrix),new XRPose(new XRRigidTransform(this.outputMatrix),this.emulatedPosition)}}const ya=!1,up={highRefreshRate:!0},fp={oculus:1,openvr:1,"spatial controller (spatial interaction source)":1};let fA=0;class mA{constructor(f,T,P={}){if(this.mode=f,this.enabledFeatures=T,this.outputContext=null,this.immersive=f=="immersive-vr"||f=="immersive-ar",this.ended=null,this.baseLayer=null,this.id=++fA,this.modifiedCanvasLayer=!1,this.outputContext&&!ya){const V=P.renderContextType||"2d";this.renderContext=this.outputContext.canvas.getContext(V)}}}class mp extends op{constructor(f,T){const{canPresent:P}=T.capabilities;super(f),this.display=T,this.frame=new f.VRFrameData,this.sessions=new Map,this.immersiveSession=null,this.canPresent=P,this.baseModelMatrix=a(),this.gamepadInputSources={},this.tempVec3=new Float32Array(3),this.onVRDisplayPresentChange=this.onVRDisplayPresentChange.bind(this),f.window.addEventListener("vrdisplaypresentchange",this.onVRDisplayPresentChange),this.CAN_USE_GAMEPAD=f.navigator&&"getGamepads"in f.navigator,this.HAS_BITMAP_SUPPORT=Vy(f)}get depthNear(){return this.display.depthNear}set depthNear(f){this.display.depthNear=f}get depthFar(){return this.display.depthFar}set depthFar(f){this.display.depthFar=f}onBaseLayerSet(f,T){const P=this.sessions.get(f),V=T.context.canvas;if(P.immersive){const Y=this.display.getEyeParameters("left"),ee=this.display.getEyeParameters("right");V.width=Math.max(Y.renderWidth,ee.renderWidth)*2,V.height=Math.max(Y.renderHeight,ee.renderHeight),this.display.requestPresent([{source:V,attributes:up}]).then(()=>{!ya&&!this.global.document.body.contains(V)&&(P.modifiedCanvasLayer=!0,this.global.document.body.appendChild(V),Hy(V)),P.baseLayer=T})}else P.baseLayer=T}isSessionSupported(f){return!(f=="immersive-ar"||f=="immersive-vr"&&this.canPresent===!1)}isFeatureSupported(f){switch(f){case"viewer":return!0;case"local":return!0;case"local-floor":return!0;case"bounded":return!1;case"unbounded":return!1;default:return!1}}requestSession(f,T){return Dt(this,null,function*(){if(!this.isSessionSupported(f))return Promise.reject();let P=f=="immersive-vr";if(P){const Y=this.global.document.createElement("canvas");if(!ya){const ee=Y.getContext("webgl")}yield this.display.requestPresent([{source:Y,attributes:up}])}const V=new mA(f,T,{renderContextType:this.HAS_BITMAP_SUPPORT?"bitmaprenderer":"2d"});return this.sessions.set(V.id,V),P&&(this.immersiveSession=V,this.dispatchEvent("@@webxr-polyfill/vr-present-start",V.id)),Promise.resolve(V.id)})}requestAnimationFrame(f){return this.display.requestAnimationFrame(f)}getPrimaryButtonIndex(f){let T=0,P=f.id.toLowerCase();for(let V in fp)if(P.includes(V)){T=fp[V];break}return Math.min(T,f.buttons.length-1)}onFrameStart(f,T){this.display.depthNear=T.depthNear,this.display.depthFar=T.depthFar,this.display.getFrameData(this.frame);const P=this.sessions.get(f);if(P.immersive&&this.CAN_USE_GAMEPAD){let V=this.gamepadInputSources;this.gamepadInputSources={};let Y=this.global.navigator.getGamepads();for(let ee=0;ee<Y.length;++ee){let oe=Y[ee];if(oe&&oe.displayId>0){let Se=V[ee];if(Se||(Se=new uA(this,this.display,this.getPrimaryButtonIndex(oe))),Se.updateFromGamepad(oe),this.gamepadInputSources[ee]=Se,Se.primaryButtonIndex!=-1){let ge=oe.buttons[Se.primaryButtonIndex].pressed;ge&&!Se.primaryActionPressed?this.dispatchEvent("@@webxr-polyfill/input-select-start",{sessionId:P.id,inputSource:Se.inputSource}):!ge&&Se.primaryActionPressed&&this.dispatchEvent("@@webxr-polyfill/input-select-end",{sessionId:P.id,inputSource:Se.inputSource}),Se.primaryActionPressed=ge}if(Se.primarySqueezeButtonIndex!=-1){let ge=oe.buttons[Se.primarySqueezeButtonIndex].pressed;ge&&!Se.primarySqueezeActionPressed?this.dispatchEvent("@@webxr-polyfill/input-squeeze-start",{sessionId:P.id,inputSource:Se.inputSource}):!ge&&Se.primarySqueezeActionPressed&&this.dispatchEvent("@@webxr-polyfill/input-squeeze-end",{sessionId:P.id,inputSource:Se.inputSource}),Se.primarySqueezeActionPressed=ge}}}}if(!ya&&!P.immersive&&P.baseLayer){const V=P.baseLayer.context.canvas;b(this.frame.leftProjectionMatrix,T.inlineVerticalFieldOfView,V.width/V.height,T.depthNear,T.depthFar)}}onFrameEnd(f){const T=this.sessions.get(f);if(!(T.ended||!T.baseLayer)){if(T.outputContext&&!(T.immersive&&!this.display.capabilities.hasExternalDisplay)){const P=T.immersive&&this.display.capabilities.hasExternalDisplay,V=T.baseLayer.context.canvas,Y=P?V.width/2:V.width,ee=V.height;if(!ya){const oe=T.outputContext.canvas,Se=oe.width,ge=oe.height,He=T.renderContext;this.HAS_BITMAP_SUPPORT?V.transferToImageBitmap?He.transferFromImageBitmap(V.transferToImageBitmap()):this.global.createImageBitmap(V,0,0,Y,ee,{resizeWidth:Se,resizeHeight:ge}).then(it=>He.transferFromImageBitmap(it)):He.drawImage(V,0,0,Y,ee,0,0,Se,ge)}}T.immersive&&T.baseLayer&&this.display.submitFrame()}}cancelAnimationFrame(f){this.display.cancelAnimationFrame(f)}endSession(f){return Dt(this,null,function*(){const T=this.sessions.get(f);if(!T.ended){if(T.immersive)return this.display.exitPresent();T.ended=!0}})}doesSessionSupportReferenceSpace(f,T){const P=this.sessions.get(f);return P.ended?!1:P.enabledFeatures.has(T)}requestStageBounds(){if(this.display.stageParameters){const f=this.display.stageParameters.sizeX,T=this.display.stageParameters.sizeZ,P=[];return P.push(-f/2),P.push(-T/2),P.push(f/2),P.push(-T/2),P.push(f/2),P.push(T/2),P.push(-f/2),P.push(T/2),P}return null}requestFrameOfReferenceTransform(f,T){return Dt(this,null,function*(){return(f==="local-floor"||f==="bounded-floor")&&this.display.stageParameters&&this.display.stageParameters.sittingToStandingTransform?this.display.stageParameters.sittingToStandingTransform:null})}getProjectionMatrix(f){if(f==="left")return this.frame.leftProjectionMatrix;if(f==="right")return this.frame.rightProjectionMatrix;if(f==="none")return this.frame.leftProjectionMatrix;throw new Error("eye must be of type 'left' or 'right'")}getViewport(f,T,P,V){const Y=this.sessions.get(f),{width:ee,height:oe}=P.context.canvas;if(!Y.immersive)return V.x=V.y=0,V.width=ee,V.height=oe,!0;if(T==="left"||T==="none")V.x=0;else if(T==="right")V.x=ee/2;else return!1;return V.y=0,V.width=ee/2,V.height=oe,!0}getBasePoseMatrix(){let{position:f,orientation:T}=this.frame.pose;return!f&&!T?this.baseModelMatrix:(f||(f=this.tempVec3,f[0]=f[1]=f[2]=0),u(this.baseModelMatrix,T,f),this.baseModelMatrix)}getBaseViewMatrix(f){if(f==="left"||f==="none")return this.frame.leftViewMatrix;if(f==="right")return this.frame.rightViewMatrix;throw new Error("eye must be of type 'left' or 'right'")}getInputSources(){let f=[];for(let T in this.gamepadInputSources)f.push(this.gamepadInputSources[T].inputSource);return f}getInputPose(f,T,P){if(!T)return null;for(let V in this.gamepadInputSources){let Y=this.gamepadInputSources[V];if(Y.inputSource===f)return Y.getXRPose(T,P)}return null}onWindowResize(){}onVRDisplayPresentChange(f){this.display.isPresenting||this.sessions.forEach(T=>{if(T.immersive&&!T.ended){if(T.modifiedCanvasLayer){const P=T.baseLayer.context.canvas;document.body.removeChild(P),P.setAttribute("style","")}this.immersiveSession===T&&(this.immersiveSession=null),this.dispatchEvent("@@webxr-polyfill/vr-present-end",T.id)}})}}class pA extends mp{constructor(f,T){const P=new qy(T||{});super(f,P),this.display=P,this.frame={rightViewMatrix:new Float32Array(16),leftViewMatrix:new Float32Array(16),rightProjectionMatrix:new Float32Array(16),leftProjectionMatrix:new Float32Array(16),pose:null,timestamp:null}}}const _A=!1;let gA=0;class vA{constructor(f,T){this.mode=f,this.enabledFeatures=T,this.ended=null,this.baseLayer=null,this.id=++gA}}class bA extends op{constructor(f){super(f),this.sessions=new Map,this.projectionMatrix=a(),this.identityMatrix=a()}onBaseLayerSet(f,T){const P=this.sessions.get(f);P.baseLayer=T}isSessionSupported(f){return f=="inline"}isFeatureSupported(f){switch(f){case"viewer":return!0;default:return!1}}requestSession(f,T){return Dt(this,null,function*(){if(!this.isSessionSupported(f))return Promise.reject();const P=new vA(f,T);return this.sessions.set(P.id,P),Promise.resolve(P.id)})}requestAnimationFrame(f){return window.requestAnimationFrame(f)}cancelAnimationFrame(f){window.cancelAnimationFrame(f)}onFrameStart(f,T){if(_A)return;const P=this.sessions.get(f);if(P.baseLayer){const V=P.baseLayer.context.canvas;b(this.projectionMatrix,T.inlineVerticalFieldOfView,V.width/V.height,T.depthNear,T.depthFar)}}onFrameEnd(f){}endSession(f){return Dt(this,null,function*(){const T=this.sessions.get(f);T.ended=!0})}doesSessionSupportReferenceSpace(f,T){const P=this.sessions.get(f);return P.ended?!1:P.enabledFeatures.has(T)}requestStageBounds(){return null}requestFrameOfReferenceTransform(f,T){return Dt(this,null,function*(){return null})}getProjectionMatrix(f){return this.projectionMatrix}getViewport(f,T,P,V){const Y=this.sessions.get(f),{width:ee,height:oe}=P.context.canvas;return V.x=V.y=0,V.width=ee,V.height=oe,!0}getBasePoseMatrix(){return this.identityMatrix}getBaseViewMatrix(f){return this.identityMatrix}getInputSources(){return[]}getInputPose(f,T,P){return null}onWindowResize(){}}const xA=function(y){return Dt(this,null,function*(){let f=null;if("getVRDisplays"in y.navigator)try{const T=yield y.navigator.getVRDisplays();T&&T.length&&(f=new mp(y,T[0]))}catch(T){}return f})},yA=function(y,f){return Dt(this,null,function*(){if(f.webvr){let P=yield xA(y);if(P)return P}let T=Gy(y);return T&&f.cardboard||!T&&f.allowCardboardOnDesktop?(y.VRFrameData||(y.VRFrameData=function(){this.rightViewMatrix=new Float32Array(16),this.leftViewMatrix=new Float32Array(16),this.rightProjectionMatrix=new Float32Array(16),this.leftProjectionMatrix=new Float32Array(16),this.pose=null}),new pA(y,f.cardboardConfig)):new bA(y)})},AA={global:s,webvr:!0,cardboard:!0,cardboardConfig:null,allowCardboardOnDesktop:!1},dc=["navigator","HTMLCanvasElement","WebGLRenderingContext"];class EA{constructor(f={}){this.config=Object.freeze(Object.assign({},AA,f)),this.global=this.config.global,this.nativeWebXR="xr"in this.global.navigator,this.injected=!1,this.nativeWebXR?this._injectCompatibilityShims(this.global):this._injectPolyfill(this.global)}_injectPolyfill(f){if(!dc.every(T=>!!f[T]))throw new Error(`Global must have the following attributes : ${dc}`);for(const T of Object.keys(ud))f[T]!==void 0?console.warn(`${T} already defined on global.`):f[T]=ud[T];np(f.WebGLRenderingContext)&&(sp(f.HTMLCanvasElement),f.OffscreenCanvas&&sp(f.OffscreenCanvas),f.WebGL2RenderingContext&&np(f.WebGL2RenderingContext),window.isSecureContext||console.warn(`WebXR Polyfill Warning:
  This page is not running in a secure context (https:// or localhost)!
  This means that although the page may be able to use the WebXR Polyfill it will
  not be able to use native WebXR implementations, and as such will not be able to
  access dedicated VR or AR hardware, and will not be able to take advantage of
  any performance improvements a native WebXR implementation may offer. Please
  host this content on a secure origin for the best user experience.
  `)),this.injected=!0,this._patchNavigatorXR()}_patchNavigatorXR(){let f=yA(this.global,this.config);this.xr=new ud.XRSystem(f),Object.defineProperty(this.global.navigator,"xr",{value:this.xr,configurable:!0})}_injectCompatibilityShims(f){if(!dc.every(T=>!!f[T]))throw new Error(`Global must have the following attributes : ${dc}`);if(f.navigator.xr&&"supportsSession"in f.navigator.xr&&!("isSessionSupported"in f.navigator.xr)){let T=f.navigator.xr.supportsSession;f.navigator.xr.isSessionSupported=function(P){return T.call(this,P).then(()=>!0).catch(()=>!1)},f.navigator.xr.supportsSession=function(P){return console.warn("navigator.xr.supportsSession() is deprecated. Please call navigator.xr.isSessionSupported() instead and check the boolean value returned when the promise resolves."),T.call(this,P)}}}}return EA});/*!
 * Copyright (C) 2024-present unreal engine
 */function Pe(s,e){if(!s)throw new Error(e)}function Ke(s,e){console.assert(!!s,e)}function bi(s,e){}function Zn(s,e){throw new Error(`Unreachable code reached: ${e}`)}function ro(s,e){return(s&e)===e}function mc(s,e){return s[e]}function Ba(s,e,t){s[e]=t}function ao(s){if(!s)return{};const e={};return s.includes("#")&&s.includes("?"),s.substring(1).split("&").forEach(function(t){const i=t.indexOf("=");i>=0?e[t.substring(0,i)]=t.substring(i+1):e[t]=void 0}),e}function gs(s){if(!s.includes("#"))return[s,""];const e=s.indexOf("#");return[s.substring(0,e),s.substring(e)]}function Vo(s,e){const t=document.createElement("a");t.href=s,t.download=e,document.body.appendChild(t),t.style.cssText="display: none",t.click(),t.remove(),window.URL.revokeObjectURL(s)}function wp(s,e,t="application/octet-stream"){const i=new Blob([s],{type:t}),n=window.URL.createObjectURL(i);Vo(n,e)}class pc{constructor(e){r(this,"base");r(this,"hashParts",{});const[t,i]=gs(e);this.base=t,this.hashParts=ao(i)}removeHash(e){Object.prototype.hasOwnProperty.call(this.hashParts,e),delete this.hashParts[e]}addHash(e,t=void 0){this.hashParts[e]=t}hasHash(e){return Object.prototype.hasOwnProperty.call(this.hashParts,e)}getHashValue(e){return this.hashParts[e]}getFullUrl(){let e="";for(const[t,i]of Object.entries(this.hashParts))e+=(e.length?"&":"#")+t+(i!==void 0?`=${i}`:"");return this.base.concat(e)}}function Hs(s,...e){return e.includes(s)}function Ua(s,e,t){return!s.some(i=>Object.prototype.hasOwnProperty.call(i,t)&&i[t]===e)}function Go(s,e,t){return s.find(i=>i[t]===e)}function Na(s){return Math.round(xi(s,-1,1)*127)}function ka(s){return s<=127?1:s<=32767?2:4}function _c(s,e,t){return s+t*(e-s)}function Ln(s,e){const t=Math.pow(10,e);return Math.round(s*t)/t}function gc(s){return Math.log(s)/Math.log(2)}function Mp(s,e){return gc(e)-gc(s)+1}function xi(s,e,t){return s<e?e:s>t?t:s}function Di(s,e,t,i,n){return i+(s-e)*(n-i)/(t-e)}function qt(s){const e=Math.PI/180;return s*e}function mn(s){const e=180/Math.PI;return s*e}function Ws(s,e,t){return Math.abs(s-e)<=t}function Pp(s){return s<=.0031308?s*12.92:Math.pow(s,1/2.4)*1.055-.055}function za(s){return s<=.04045?s/12.92:Math.pow((s+.055)/1.055,2.4)}class Cp{constructor(){r(this,"h",0);r(this,"s",0);r(this,"l",0)}}const Qi=class Qi{constructor(e,t,i){r(this,"r",0);r(this,"g",0);r(this,"b",0);return typeof e=="number"&&t!==void 0&&i!==void 0?this.setRGB(e,t,i):e!==void 0?this.set(e):this}set(e){return e instanceof Qi?this.copyFrom(e):typeof e=="number"?this.setHex(e):typeof e=="string"&&this.setStyle(e),this}setHex(e){return e=Math.floor(e),this.r=(e>>16&255)/255,this.g=(e>>8&255)/255,this.b=(e&255)/255,this}setRGB(e,t,i){return this.r=e,this.g=t,this.b=i,this}setHSL(e){const t=e.h,i=e.s,n=e.l;if(i===0)this.r=this.g=this.b=n;else{const o=function(c,h,d){return d<0&&(d+=1),d>1&&(d-=1),d<.16666666666666666?c+(h-c)*6*d:d<.5?h:d<.6666666666666666?c+(h-c)*6*(.6666666666666666-d):c},a=n<=.5?n*(1+i):n+i-n*i,l=2*n-a;this.r=o(l,a,t+1/3),this.g=o(l,a,t),this.b=o(l,a,t-1/3)}return this}setStyle(e){if(/^rgb\((\d+), ?(\d+), ?(\d+)\)$/i.test(e)){const t=/^rgb\((\d+), ?(\d+), ?(\d+)\)$/i.exec(e);this.r=Math.min(255,parseInt(t[1],10))/255,this.g=Math.min(255,parseInt(t[2],10))/255,this.b=Math.min(255,parseInt(t[3],10))/255}else if(/^rgb\((\d+)%, ?(\d+)%, ?(\d+)%\)$/i.test(e)){const t=/^rgb\((\d+)%, ?(\d+)%, ?(\d+)%\)$/i.exec(e);this.r=Math.min(100,parseInt(t[1],10))/100,this.g=Math.min(100,parseInt(t[2],10))/100,this.b=Math.min(100,parseInt(t[3],10))/100}else if(/^#([0-9a-f]{6})$/i.test(e)){const t=/^#([0-9a-f]{6})$/i.exec(e);this.setHex(parseInt(t[1],16))}else if(/^#([0-9a-f])([0-9a-f])([0-9a-f])$/i.test(e)){const t=/^#([0-9a-f])([0-9a-f])([0-9a-f])$/i.exec(e);this.setHex(parseInt(t[1]+t[1]+t[2]+t[2]+t[3]+t[3],16))}else/^(\w+)$/i.test(e)&&this.setHex(Jn[e]);return this}copyFrom(e){return this.r=e.r,this.g=e.g,this.b=e.b,this}convertGammaToLinear(){return this.r=za(this.r),this.g=za(this.g),this.b=za(this.b),this}roundChannels(){return this.r=Ln(this.r,3),this.g=Ln(this.g,3),this.b=Ln(this.b,3),this}getHex(){return this.r*255<<16^this.g*255<<8^this.b*255<<0}getHexString(){return("000000"+this.getHex().toString(16)).slice(-6)}getHSL(){const e=new Cp,t=this.r,i=this.g,n=this.b,o=Math.max(t,i,n),a=Math.min(t,i,n);let l,c;const h=(a+o)/2;if(a===o)l=0,c=0;else{const d=o-a;c=h<=.5?d/(o+a):d/(2-o-a),l=o==t?(i-n)/d+(i<n?6:0):o==i?(n-t)/d+2:(t-i)/d+4,l/=6}return e.h=l,e.s=c,e.l=h,e}getStyle(){return"rgb("+(this.r*255|0)+","+(this.g*255|0)+","+(this.b*255|0)+")"}offsetHSL(e,t,i){const n=this.getHSL();return n.h+=e,n.s+=t,n.l+=i,this.setHSL(n),this}add(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this}addColors(e,t){return this.r=e.r+t.r,this.g=e.g+t.g,this.b=e.b+t.b,this}addScalar(e){return this.r+=e,this.g+=e,this.b+=e,this}multiply(e){return this.r*=e.r,this.g*=e.g,this.b*=e.b,this}multiplyScalar(e){return this.r*=e,this.g*=e,this.b*=e,this}lerp(e,t){return this.r+=(e.r-this.r)*t,this.g+=(e.g-this.g)*t,this.b+=(e.b-this.b)*t,this}lerpColors(e,t,i){return this.r=_c(e.r,t.r,i),this.g=_c(e.g,t.g,i),this.b=_c(e.b,t.b,i),this}equals(e){return e.r===this.r&&e.g===this.g&&e.b===this.b}fromArray(e){return this.r=e[0],this.g=e[1],this.b=e[2],this}toArray(){return[this.r,this.g,this.b]}clone(){return new Qi().setRGB(this.r,this.g,this.b)}};r(Qi,"BLACK",new Qi(0)),r(Qi,"WHITE",new Qi(16777215)),r(Qi,"RED",new Qi(16711680)),r(Qi,"GREEN",new Qi(65280)),r(Qi,"BLUE",new Qi(255)),r(Qi,"ORANGE",new Qi(16753920));let be=Qi;const Jn={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074};function vc(){return ao(window.location.hash)}function $e(s){return s in vc()}function bc(s){const e=vc();if(!(s in e))return null;const t=e[s];return t!==void 0?decodeURI(t):null}function xr(s){const e=bc(s);if(e===null)return null;const t=parseInt(e);return isNaN(t)?null:t}function Rp(s){const e=vc();return Object.keys(e).filter(t=>t!==s).map(function(t){const i=e[t];return t+(i===void 0?"":"="+i)}).join("&")}function Ip(s){return s in ao(window.location.search)}var Td=(s=>(s.EDIT_MODE="editor",s.NO_SCREENSHOTS="noscreenshots",s.NO_COLLISIONS="no_collisions",s.DEBUG="debug",s.DEBUG_WEBGL="debugwebgl",s.DEBUG_WEBGL_ERROR="debugwebgl_error",s.DEBUG_WEBGL_CALL="debugwebgl_call",s.DEBUG_SPECTOR="debugspector",s.DEBUG_UI="debugui",s.BENCHMARK="benchmark",s.BENCHMARK_OUTPUT="benchmark_output",s.BENCHMARK_MEASUREMENTS="benchmark_measurements",s.BENCHMARK_LIST_ALL="benchmark_list_all",s.DEBUG_SHARED_BUFFERS="debugbuffers",s.DEBUG_CAMERA_PATH="debugcamerapath",s.DEBUG_GEOMETRY_MERGING="debugmerge",s.FORCE_AUTO_EXPOSURE="force_auto_exposure",s.PUPPETEER_TEST="puppeteer_test",s.SHOW_INTERNAL_VIEWS="internalviews",s.UNIVERSAL_MATERIAL_GLTF_PBR="gltf_pbr",s.ALWAYS_RENDER="alwaysrender",s.WEAK_REFLECTION_SHADOW="weak_reflection_shadow",s.LOG_INFO="log",s.LOG_TO_SERVER="savelog",s.LOG_FPS="log_fps",s.LOG_FPS_SKIP_INITIAL_SEC="log_fps_skip",s.FORCE_FXAA="fxaa",s.FORCE_MOTION_BLUR="motionblur",s.NO_MOVE_TARGET="nomovetarget",s.REFLECTION_PROBES_RES="reflection_probes_res",s.CUBEMAP_FILTER_SAMPLES="cubemap_filter_samples",s.NO_MERGE_TRANSPARENT="nomergetransparent",s.FLIP_MOUSE="flipmouse",s.AUTO_PLAY="autoplay",s.HIDE_PLAY="hideplay",s.SHOW_HELP_ON_LOAD="help",s.GAZE_IN_POINTER_LOCK="gazeinpointerlock",s.NO_GAZE_TELEPORT="nogazeteleport",s.VR_LO="vrlo",s.VR_HI="vrhi",s.MOBILE_HI="mobilehi",s.NO_BASIS="nobasis",s.NO_BRDFLUT="nobrdflut",s.NO_REFLECTION_PROBES="no_reflection_probes",s.NO_REFLECTION_PROBE_BOXES="no_reflection_probe_boxes",s.AUTO_EXPOSURE="autoexposure",s.NO_BUILTIN_AA="no_builtin_aa",s.NO_GPU_INFO="no_gpu_info",s.HIGH_PERFORMANCE_POWER_PREFERENCE="high_performance_power_preference",s.DEV_NEW_SCENE="dev_new_scene",s.DEV_MATERIALX="dev_materialx",s.DEV_SHADOWMAP="dev_shadowmap",s.DEV_SSAO="dev_ssao",s.PROFILER="profiler",s.PROFILER_EXPANDED_LOG="profiler_expanded_log",s.PROFILER_ID_TO_LOG="profiler_id_to_log",s.COLLIDER_DEBUG="collider_debug",s.COLLIDER_DEBUG_TREE="collider_debug_tree",s.COLLIDER_DEBUG_POINTS="collider_debug_points",s))(Td||{});(()=>{const s=Object.values(Td),e={};for(const t of s)e[t]=!0;return t=>{var i;return(i=e[t])!=null?i:!1}})();const M={ASSETS_URL:"./",EDIT_MODE:Ip("editor"),NO_SCREENSHOTS:$e("noscreenshots"),NO_COLLISIONS:$e("no_collisions"),DEBUG:$e("debug")||$e("benchmark"),DEBUG_WEBGL:$e("debugwebgl"),DEBUG_WEBGL_ERROR:$e("debugwebgl_error"),DEBUG_WEBGL_CALL:$e("debugwebgl_call"),DEBUG_SPECTOR:$e("debugspector"),DEBUG_UI:$e("debugui"),BENCHMARK:$e("benchmark"),BENCHMARK_OUTPUT:bc("benchmark_output"),BENCHMARK_MEASUREMENTS:xr("benchmark_measurements"),BENCHMARK_LIST_ALL:$e("benchmark_list_all"),DEBUG_SHARED_BUFFERS:$e("debugbuffers"),DEBUG_CAMERA_PATH:$e("debugcamerapath"),DEBUG_GEOMETRY_MERGING:$e("debugmerge"),FORCE_AUTO_EXPOSURE:$e("force_auto_exposure"),DEBUG_VIEW_MODES:!1,PUPPETEER_TEST:$e("puppeteer_test"),SHOW_INTERNAL_VIEWS:$e("internalviews"),UNIVERSAL_MATERIAL_GLTF_PBR:$e("gltf_pbr"),ALWAYS_RENDER:$e("alwaysrender"),WEAK_REFLECTION_SHADOW:$e("weak_reflection_shadow"),LOG_INFO:$e("log")||$e("savelog"),LOG_TO_SERVER:$e("savelog"),LOG_TIME:!1,LOG_FPS:$e("log_fps"),LOG_FPS_SKIP_INITIAL_SEC:xr("log_fps_skip"),PROGRESSIVE_LOADER_AFTER_SEC:30,CONTEXT_LOST_RESTORE_LIMIT:4,RETRIES_ON_LOAD_ERROR:3,FORCE_FXAA:$e("fxaa"),FORCE_MOTION_BLUR:$e("motionblur"),FONT_FAMILIES_TO_LOAD:[],MAX_TWO_POINTERS_IN_LINE_DIFF:40,CAMERA_WALK_NEAR:.01,CAMERA_ORBIT_NEAR_FROM_1M:.01,CAMERA_MIN_FAR:100,SKY_DISTANCE_TO_SCENE:100,CAMERA_DEFAULT_FOV:70,CAMERA_ORTHO_FRUSTUM_SIZE:20,CAMERA_DEFAULT_MOVE_MAX_SPEED:1.11,CAMERA_MOVE_MAX_SPEED_SHIFT_FACTOR:2,CAMERA_LOOK_SPEED:Math.PI/1500,CAMERA_LOOK_SMOOTHING:.1,CAMERA_ARROWS_TURN_SPEED:Math.PI/2,CAMERA_SCROLL_SPEED:.5,CAMERA_FULL_ACCELERATION_TIME:.5,CAMERA_FULL_DECELERATION_TIME:.166,CAMERA_MAX_PER_FRAME_LINEAR_DISTANCE:1,CAMERA_FIXED_HEIGHT:null,MAX_GROUND_SEARCH_DEPTH:5.5,MATERIAL_PICKER_BALL_MAX_SIZE:.1,COVER_JSON_URL:"./cover.json",AUTO_TOUR_IN_VIEW_STILL_TIME_MS:3e3,CLICK_MOVE_MIN_DISTANCE_TO_OBSTACLE:.7,CLICK_MOVE_SHOW_TARGET_INDICATOR:!$e("nomovetarget"),KEY_MOVE_MIN_DISTANCE_TO_OBSTACLE:.1,MIN_DISTANCE_TO_CEILING:.1,LIGHT_PROBE_MIRROR_SIZE:512,CUSTOM_LIGHT_PROBE_MAX_MIP_SIZE:$e("reflection_probes_res"),CUBEMAP_FILTER_SHADER_SAMPLES_COUNT:(Km=xr("cubemap_filter_samples"))!=null?Km:128,LIGHT_PROBE_MAX_MIP_SIZE:($m=xr("reflection_probes_res"))!=null?$m:128,LIGHT_PROBE_MIN_MIP_SIZE:4,DEBUG_LIGHT_PROBE_MIPS:!1,EDITOR_COVER_WIDTH:1920,EDITOR_COVER_HEIGHT:1080,MAX_PANORAMA_SIZE:8192,OBJECT_VISIBILITY_TARGET_SIZE:128,DEFAULT_SKY_NAME:"default",EDITOR_CONTROLLED_SKY_NAME:"sky0",EDITOR_SELECTION_COLOR:new be(5021401).convertGammaToLinear(),ALLOW_MOBILE_VR:!0,FALLBACK_CAMERA_HEIGHT:1.6,LOAD_PRIORITY:{CORE_RESOURCE:0,COLORMAP:1,UV0:1,DIFFUSE:2,LIGHTMAP:3,SKY:4,SPECULARITY:5,VIDEO:6},MERGE_TRANSPARENT_DISABLED:$e("nomergetransparent"),urlHashContains:$e,urlHashGetArgument:bc,urlHashRemoveArgument:Rp,TELEPORT_TO_VIEW_MAX_TIME:3,TELEPORT_TO_POINT_MAX_TIME:4.5,TELEPORT_PATH_MAX_TIME:6,TELEPORT_TO_VIEW_ACCELERATION:4,TELEPORT_TO_POINT_ACCELERATION:2,TELEPORT_PATH_ACCELERATION:2,GAZE_POINTER_SHOW_LOADING_AFTER_S:2.5,GAZE_POINTER_ACTIVATE_AFTER_S:4.5,SPRITE_ANCHOR_FONT_SIZE:128,POINTER_PRIORITY:{TRANSFORM_CONTROLS:1,EDITOR_SELECTOR:2,INTERACTION_DISPATCHER:3},AVATAR_COLORS:["#f44336","#e81e63","#9c27b0","#673ab7","#3f51b5","#2196f3","#03a9f4","#00bcd4","#009688","#4caf50","#8bc34a","#cddc39","#ffeb3b","#ffc107","#ff9800","#ff5722","#795548","#9e9e9e","#607d8b","#ff5084"],STRINGS:{},DEFAULT_LANGUAGE:"English",ENABLE_MINIMAP:!0,FLIP_MOUSE:$e("flipmouse"),AUTO_PLAY:$e("autoplay"),HIDE_PLAY:$e("hideplay"),SHOW_HELP_ON_LOAD:$e("help"),GAZE_IN_POINTER_LOCK:$e("gazeinpointerlock"),NO_GAZE_TELEPORT:$e("nogazeteleport"),VR_LO:$e("vrlo"),VR_HI:$e("vrhi"),MOBILE_HI:$e("mobilehi"),NO_BASIS:$e("nobasis"),NO_BRDFLUT:$e("nobrdflut"),NO_REFLECTION_PROBES:$e("no_reflection_probes"),NO_REFLECTION_PROBE_BOXES:$e("no_reflection_probe_boxes"),ENABLE_REFLECTION_PROBES_BLENDING:!0,MAX_BLENDED_REFLECTION_PROBES:3,AUTO_EXPOSURE:$e("autoexposure"),NO_BUILTIN_AA:$e("no_builtin_aa"),NO_GPU_INFO:$e("no_gpu_info"),HIGH_PERFORMANCE_POWER_PREFERENCE:$e("high_performance_power_preference"),DEV_DISABLE_UNIFORM_BUFFERS:!0,DEV_NEW_SCENE:$e("dev_new_scene"),DEV_MATERIALX:$e("dev_materialx"),DEV_SHADOWMAP:$e("dev_shadowmap"),DEV_SSAO:$e("dev_ssao"),PROFILER:$e("profiler"),PROFILER_EXPANDED_LOG:$e("profiler_expanded_log"),PROFILER_ID_TO_LOG:xr("profiler_id_to_log"),LIGHT_PROBE_MIPS_COUNT:0,COLLIDER_DEBUG:$e("collider_debug"),COLLIDER_DEBUG_TREE:$e("collider_debug_tree"),COLLIDER_DEBUG_POINTS:$e("collider_debug_points")};M.LIGHT_PROBE_MIPS_COUNT=Mp(M.LIGHT_PROBE_MIN_MIP_SIZE,M.LIGHT_PROBE_MAX_MIP_SIZE);class Dp{constructor(e=!0){r(this,"_startTime",0);r(this,"_oldTime",0);r(this,"_elapsedTime",0);r(this,"_running",!1);r(this,"_autoStart");r(this,"_timer");this._autoStart=e,this._timer=self.performance!==void 0&&self.performance.now!==void 0?self.performance:Date}isRunning(){return this._running}start(){this._startTime=this._timer.now(),this._oldTime=this._startTime,this._running=!0}stop(){this.getElapsedTime(),this._running=!1}getElapsedTime(){return this.getDelta(),this._elapsedTime}getDelta(){let e=0;if(this._autoStart&&!this._running&&this.start(),this._running){const t=this._timer.now();e=.001*(t-this._oldTime),this._oldTime=t,this._elapsedTime+=e}return e}}const Lp=1383;function Fp(){const s=new Date,e=(t,i)=>t.toString().padStart(i,"0");return`${e(s.getHours(),2)}:${e(s.getMinutes(),2)}:${e(s.getSeconds(),2)},${e(s.getMilliseconds(),3)}`}const mr=class mr{constructor(){r(this,"log",(...e)=>{});r(this,"_logsToSend",new Array);r(this,"_logLinesRemovedCount",0);r(this,"_lastMessage");r(this,"_lastMessageDuplicates",0);M.LOG_INFO&&(this.log=(...e)=>{console.log(...e)}),M.LOG_TO_SERVER&&this.initLoggingToServer(!0)}_handleLastMessageDuplicates(){this._lastMessageDuplicates!==0&&(this._logsToSend[this._logsToSend.length-1]+=` [${this._lastMessageDuplicates+1} copies]`,this._lastMessageDuplicates=0)}_addLogToSendQueue(e,t,i){if(this._lastMessage===i){this._lastMessageDuplicates+=1;return}if(this._logsToSend.length>=mr.maxLogsToSend-1){this._logLinesRemovedCount+=1;return}this._handleLastMessageDuplicates(),this._lastMessage=i;const n=e+t.toUpperCase()+" "+i;this._logsToSend.push(n),this._logsToSend.length==1&&setTimeout(this._sendLogs.bind(this),mr.sendIntervalMs)}_sendLogs(){this._handleLastMessageDuplicates(),this._logLinesRemovedCount>0&&this._logsToSend.push(`[truncated, removed lines ${this._logLinesRemovedCount}]`),Pr("./logs",{logs:this._logsToSend}),this._logsToSend.length=0,this._lastMessage=void 0,this._logLinesRemovedCount=0,this._lastMessageDuplicates=0}_wrapConsole(e){const t=console[e].bind(console);console[e]=(...i)=>{const n=i.join(" "),o=M.LOG_TIME?Fp()+" ":"";this._addLogToSendQueue(o,e,n),t(o+n)}}_addOnErrorHandler(){window.onerror=(e,t,i,n,o)=>{const a=i?i.toString():"?",l=n?n.toString():"?";return console.error(`Error occured: ${e} (${t}#${a}:${l}/${o})`),!1}}initLoggingToServer(e){e&&(this._wrapConsole("log"),this._wrapConsole("info")),this._wrapConsole("warn"),this._wrapConsole("error"),this._addOnErrorHandler()}};r(mr,"maxLogsToSend",500),r(mr,"sendIntervalMs",5e3);let xc=mr;const Me=new xc;class Op{constructor(){r(this,"https");r(this,"localhost");r(this,"ipad");r(this,"mobile");r(this,"ios");r(this,"android");r(this,"facebookApp");r(this,"whatsApp");r(this,"inCrossOriginIframe");r(this,"firefox");r(this,"opera");r(this,"ie");r(this,"edge");r(this,"safari");r(this,"mac");r(this,"chromeVersion");r(this,"browserName");r(this,"basisDecodeWorkers");r(this,"webp",!0);r(this,"screenCaptureApi");r(this,"_gl");r(this,"_gpuInfo",null);var a;this._asyncDetectGpuSupport(),this._asyncDetectWebpSupport(),this.https=window.location.protocol==="https:",this.localhost=window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1",this.ipad=/iPad/.test(navigator.userAgent)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1,this.mobile=/mobile|ip(hone|od)|android|silk/i.test(navigator.userAgent)||this.ipad||M.urlHashContains("mobile"),this.ios=/iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream||this.ipad,this.android=/Android/.test(navigator.userAgent),this.facebookApp=/FBAN|FBAV/.test(navigator.userAgent),this.whatsApp=/WhatsApp/.test(navigator.userAgent);function e(l){const c=document.createElement("a");return c.href=l,c.protocol+"//"+c.host}this.inCrossOriginIframe=function(){const l=window.self!==window.top,c=e(document.referrer),h=e(window.location.href);return l&&c!==h}();function t(l,c){const h=l.toLowerCase(),d=c.toLowerCase();return h.indexOf(d)!==-1}function i(l){return!navigator||!navigator.userAgent?!1:t(navigator.userAgent,l)}function n(l){return!navigator||!navigator.appVersion?!1:t(navigator.appVersion,l)}this.firefox=i("firefox"),this.opera=i("opera")||i("OPR/"),this.ie=i("msie")||n("trident/"),this.edge=i("edge/"),this.safari=i("safari/")&&!(i("chrome/")||i("chromium/")),this.mac=i("macintosh")&&!this.ipad;const o=navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./);this.chromeVersion=o?parseInt(o[2],10):void 0,this.browserName=this.firefox?"firefox":this.opera?"opera":this.ie?"ie":"chrome",this.browserName=this.edge?"edge":this.safari?"safari":this.browserName,this.basisDecodeWorkers=this.safari||this.ios?0:Math.min(4,navigator.hardwareConcurrency||4),this.screenCaptureApi=!!((a=navigator.mediaDevices)!=null&&a.getDisplayMedia)}get gl(){return this._gl,this._gl}_asyncDetectGpuSupport(){const e=navigator.gpu;if(M.NO_GPU_INFO||!e)return;const t=i=>{if(i){if("requestAdapterInfo"in i)i.requestAdapterInfo().then(n=>this._gpuInfo=n);else if("info"in i){const n=i;this._gpuInfo=n.info}}};e.requestAdapter({powerPreference:"high-performance"}).then(t)}_asyncDetectWebpSupport(){const e="UklGRkoAAABXRUJQVlA4WAoAAAAQAAAAAAAAAAAAQUxQSAwAAAARBxAR/Q9ERP8DAABWUDggGAAAABQBAJ0BKgEAAQAAAP4AAA3AAP7mtQAAAA==",t=new Image;t.onload=()=>this.webp=t.width>0&&t.height>0,t.onerror=()=>this.webp=!1,t.src="data:image/webp;base64,"+e}isLongShaderExecutionProblematicDevice(){if(!this.ios)return!1;if(this.ipad)return!0;const t=navigator.userAgent.match(/OS (\d+)_/);if(!t||t.length===0||parseInt(t[1])<18)return!1;const n=window.devicePixelRatio||1,o=Math.min(window.screen.width,window.screen.height),a=Math.max(window.screen.width,window.screen.height),l=`${o}x${a}x${n}`,c={"390x844x3":"iPhone 12/12 Pro/13/13 Pro/14/15","428x926x3":"iPhone 12 Pro Max/13 Pro Max/14 Plus","393x852x3":"iPhone 14 Pro/15 Pro/16","430x932x3":"iPhone 14 Pro Max/15 Plus/15 Pro Max/16 Plus","402x874x3":"iPhone 16 Pro","440x956x3":"iPhone 16 Pro Max"};return!Object.prototype.hasOwnProperty.call(c,l)}fullScreenSupported(){const e=document;if(e.fullscreenEnabled!==void 0||e.webkitFullscreenEnabled!==void 0||e.mozFullScreenEnabled!==void 0||e.msFullscreenEnabled!==void 0)return!!(e.fullscreenEnabled||e.webkitFullscreenEnabled||e.mozFullScreenEnabled||e.msFullscreenEnabled);const t=document.body;return t.mozRequestFullScreen!==void 0||t.webkitRequestFullscreen!==void 0||t.msRequestFullscreen!==void 0||t.requestFullscreen!==void 0}pointerLockSupported(){const e=document;return!this.mobile&&!this.opera&&(document.pointerLockElement!==void 0||e.mozPointerLockElement!==void 0||e.webkitPointerLockElement!==void 0)}resetGlDetector(e){this._gl=new Bp(e,this)}getPlatformInfo(){const t=function(o,a){return o.length>a&&(o=o.substring(0,a)),o=o.replace(/[^0-9a-zA-Z() .]/gi,""),encodeURI(o)},i=navigator.connection,n=this._gpuInfo;return{renderApi:n?3:this.gl.webgl2?2:1,webglVendor:this.gl.vendor?t(this.gl.vendor,32):"",webglRenderer:this.gl.renderer?t(this.gl.renderer,128):"",webgpuVendor:n?t(n.vendor,32):"",webgpuArch:n?t(n.architecture,64):"",width:Math.round(window.innerWidth/10)*10,height:Math.round(window.innerHeight/10)*10,dpr:window.devicePixelRatio,cpuCores:navigator.hardwareConcurrency,webp:this.webp?1:0,version:Lp,browser:this.browserName,chromeVersion:this.chromeVersion,downloadSpeed:i==null?void 0:i.downlink,roundTripTime:i==null?void 0:i.rtt}}missingCapabilities(){this._gl;let e=null;const t=i=>{e=e?e+", "+i:i};return this._gl.webgl2||t("WebGL2 is not supported"),this._gl.maxTextureSize<4096&&t("4096x4096 textures are not supported"),this.webp||t("WebP format is not supported"),e?`Your GPU/browser does not have sufficient capabilities: ${e}.<br>Try opening this page on a different device.`:null}}class Bp{constructor(e,t){r(this,"webgl2");r(this,"antialiasNative");r(this,"antialiasSamples");r(this,"antialiasPostprocess");r(this,"maxAnisotropy");r(this,"fragmentPrecision");r(this,"maxTextureSize");r(this,"maxRenderBufferSize");r(this,"vendor");r(this,"renderer");r(this,"dxtTextures");r(this,"pvrtcTextures");r(this,"etc1Textures");r(this,"astcTextures");r(this,"disableTextureSlotReuse");r(this,"_extensionCache",new Map);r(this,"_glCtx");var o;this._glCtx=e;const i=typeof WebGL2RenderingContext!="undefined"&&e instanceof WebGL2RenderingContext;this.webgl2=i,this.antialiasNative=!!((o=e.getContextAttributes())!=null&&o.antialias&&e.getParameter(e.SAMPLES)>1),this.antialiasSamples=e.getParameter(e.SAMPLES),this.antialiasPostprocess=!t.mobile;const n=this.extension("EXT_texture_filter_anisotropic");if(this.maxAnisotropy=n!==void 0?e.getParameter(n.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,this.maxTextureSize=e.getParameter(e.MAX_TEXTURE_SIZE),this.fragmentPrecision=(()=>{if(e.getShaderPrecisionFormat===void 0)return"highp";const a=e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.HIGH_FLOAT);if(a&&a.precision>0)return"highp";const l=e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.MEDIUM_FLOAT);return l&&l.precision>0?"mediump":"lowp"})(),this.maxRenderBufferSize=e.getParameter(e.MAX_RENDERBUFFER_SIZE),this.vendor=e.getParameter(e.VENDOR),this.renderer=e.getParameter(e.RENDERER),!t.firefox){const a=e.getExtension("WEBGL_debug_renderer_info");a&&(this.vendor=e.getParameter(a.UNMASKED_VENDOR_WEBGL),this.renderer=e.getParameter(a.UNMASKED_RENDERER_WEBGL))}this.dxtTextures=(()=>{if(M.urlHashContains("nodxt"))return!1;const a=this.extension("WEBGL_compressed_texture_s3tc"),l=e.getParameter(e.COMPRESSED_TEXTURE_FORMATS);let c=!1,h=!1;if(a)for(let d=0;d<l.length;d+=1)c=c||l[d]===a.COMPRESSED_RGB_S3TC_DXT1_EXT,h=h||l[d]===a.COMPRESSED_RGBA_S3TC_DXT5_EXT;return c&&h})(),this.pvrtcTextures=(()=>M.urlHashContains("nopvr")?!1:!!this.extension("WEBGL_compressed_texture_pvrtc"))(),this.etc1Textures=(()=>M.urlHashContains("noetc1")?!1:!!this.extension("WEBGL_compressed_texture_etc1")&&t.mobile)(),this.astcTextures=(()=>!1)(),this.disableTextureSlotReuse=t.mac||t.chromeVersion===83}extension(e){let t=this._extensionCache.get(e);if(t!==void 0)return t;switch(e){case"EXT_texture_filter_anisotropic":t=this._glCtx.getExtension("EXT_texture_filter_anisotropic")||this._glCtx.getExtension("MOZ_EXT_texture_filter_anisotropic")||this._glCtx.getExtension("WEBKIT_EXT_texture_filter_anisotropic");break;case"WEBGL_compressed_texture_s3tc":t=this._glCtx.getExtension("WEBGL_compressed_texture_s3tc")||this._glCtx.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||this._glCtx.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc");break;case"WEBGL_compressed_texture_pvrtc":t=this._glCtx.getExtension("WEBGL_compressed_texture_pvrtc")||this._glCtx.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc");break;default:t=this._glCtx.getExtension(e)}return t===null&&(t=void 0),t!==void 0&&this._extensionCache.set(e,t),t}reportToConsole(){const e="WebGL"+(this.webgl2?"2":"");Me.log(e+"; "+this.fragmentPrecision+" fragment precision."),this.dxtTextures||Me.log("DXT textures not supported."),this.antialiasNative?Me.log("Native anti-aliasing supported with "+this.antialiasSamples+" samples."):Me.log("Native anti-aliasing not supported"),this.disableTextureSlotReuse&&Me.log("WebGL texture slot reuse disabled.")}}const Qe=new Op;class ei{constructor(){r(this,"_typeToListeners",new Map)}addEventListener(e,t){this._typeToListeners.has(e)||this._typeToListeners.set(e,[]);const i=this._typeToListeners.get(e);i.indexOf(t)===-1&&i.push(t)}hasEventListener(e,t){const i=this._typeToListeners.get(e);return i!==void 0&&i.includes(t)}removeEventListener(e,t){const i=this._typeToListeners.get(e);if(i!==void 0){const n=i.indexOf(t);n!==-1&&i.splice(n,1)}}dispatchEvent(e){const t=this._typeToListeners.get(e.type);if(t===void 0)return;e.target=this;const i=[],n=t.length;for(let o=0;o<n;o++)i[o]=t[o];for(let o=0;o<n;o++)i[o].call(this,e)}}class Ce{constructor(e=0,t=0){r(this,"x");r(this,"y");this.x=e,this.y=t}set(e,t){return this.x=e,this.y=t,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;default:throw new Error("index is out of range: "+e)}}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+e)}}copyFrom(e){return this.x=e.x,this.y=e.y,this}add(e){return this.x+=e.x,this.y+=e.y,this}addScalar(e){return this.x+=e,this.y+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this}sub(e){return this.x-=e.x,this.y-=e.y,this}subScalar(e){return this.x-=e,this.y-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this}multiply(e){return this.x*=e.x,this.y*=e.y,this}multiplyScalar(e){return this.x*=e,this.y*=e,this}divide(e){return this.x/=e.x,this.y/=e.y,this}divideScalar(e){if(e!==0){const t=1/e;this.x*=t,this.y*=t}else this.x=0,this.y=0;return this}min(e){return this.x>e.x&&(this.x=e.x),this.y>e.y&&(this.y=e.y),this}max(e){return this.x<e.x&&(this.x=e.x),this.y<e.y&&(this.y=e.y),this}clamp(e,t){return this.x=this.x<e.x?e.x:this.x>t.x?t.x:this.x,this.y=this.y<e.y?e.y:this.y>t.y?t.y:this.y,this}clampScalar(e,t){return this.x=this.x<e?e:this.x>t?t:this.x,this.y=this.y<e?e:this.y>t?t:this.y,this}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}roundToZero(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this}negate(){return this.x=-this.x,this.y=-this.y,this}dot(e){return this.x*e.x+this.y*e.y}lengthSq(){return this.x*this.x+this.y*this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}normalize(){return this.divideScalar(this.length())}distanceTo(e){return Math.sqrt(this.distanceToSquared(e))}distanceToSquared(e){const t=this.x-e.x,i=this.y-e.y;return t*t+i*i}setLength(e){const t=this.length();return t!==0&&e!==t&&this.multiplyScalar(e/t),this}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this}lerpVectors(e,t,i){return this.subVectors(t,e).multiplyScalar(i).add(e),this}static crossVectors(e,t){return e.x*t.y-e.y*t.x}equals(e){return e.x===this.x&&e.y===this.y}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this}fillArray(e,t=0){return e[t]=this.x,e[t+1]=this.y,e}toArray(){return[this.x,this.y]}clone(){return new Ce(this.x,this.y)}}const ha=class ha{constructor(e=new Ce(1/0,1/0),t=new Ce(-1/0,-1/0)){r(this,"min");r(this,"max");this.min=e,this.max=t}set(e,t){return this.min.copyFrom(e),this.max.copyFrom(t),this}setFromPoints(e){this.makeEmpty();for(const t of e)this.expandByPoint(t);return this}copyFrom(e){return this.min.copyFrom(e.min),this.max.copyFrom(e.max),this}makeEmpty(){return this.min.x=this.min.y=1/0,this.max.x=this.max.y=-1/0,this}empty(){return this.max.x<this.min.x||this.max.y<this.min.y}center(e=new Ce){return e.addVectors(this.min,this.max).multiplyScalar(.5)}size(e=new Ce){return e.subVectors(this.max,this.min)}expandByPoint(e){return this.min.min(e),this.max.max(e),this}expandByVector(e){return this.min.sub(e),this.max.add(e),this}expandByScalar(e){return this.min.addScalar(-e),this.max.addScalar(e),this}containsPoint(e){return!(e.x<this.min.x||e.x>this.max.x||e.y<this.min.y||e.y>this.max.y)}containsBox(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y}getParameter(e,t=new Ce){return t.set((e.x-this.min.x)/(this.max.x-this.min.x),(e.y-this.min.y)/(this.max.y-this.min.y))}isIntersectionBox(e){return!(e.max.x<this.min.x||e.min.x>this.max.x||e.max.y<this.min.y||e.min.y>this.max.y)}clampPoint(e,t=new Ce){return t.copyFrom(e).clamp(this.min,this.max)}distanceToPoint(e){return ha._tempVec2.copyFrom(e).clamp(this.min,this.max).sub(e).length()}intersect(e){return this.min.max(e.min),this.max.min(e.max),this}union(e){return this.min.min(e.min),this.max.max(e.max),this}translate(e){return this.min.add(e),this.max.add(e),this}equals(e){return e.min.equals(this.min)&&e.max.equals(this.max)}clone(){return new ha().copyFrom(this)}};r(ha,"_tempVec2",new Ce);let yr=ha;const qn=class qn{constructor(e=0,t=0,i=0){r(this,"x");r(this,"y");r(this,"z");this.x=e,this.y=t,this.z=i}set(e,t,i){return this.x=e,this.y=t,this.z=i,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setZ(e){return this.z=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;default:throw new Error("index is out of range: "+e)}}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+e)}}copyFrom(e){return this.x=e.x,this.y=e.y,this.z=e.z,this}add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this}multiply(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this}multiplyScalar(e){return this.x*=e,this.y*=e,this.z*=e,this}multiplyVectors(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this}divide(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this}divideScalar(e){if(e!==0){const t=1/e;this.x*=t,this.y*=t,this.z*=t}else this.x=0,this.y=0,this.z=0;return this}min(e){return this.x>e.x&&(this.x=e.x),this.y>e.y&&(this.y=e.y),this.z>e.z&&(this.z=e.z),this}max(e){return this.x<e.x&&(this.x=e.x),this.y<e.y&&(this.y=e.y),this.z<e.z&&(this.z=e.z),this}minScalar(e){return this.x>e&&(this.x=e),this.y>e&&(this.y=e),this.z>e&&(this.z=e),this}maxScalar(e){return this.x<e&&(this.x=e),this.y<e&&(this.y=e),this.z<e&&(this.z=e),this}clamp(e,t){return this.x=this.x<e.x?e.x:this.x>t.x?t.x:this.x,this.y=this.y<e.y?e.y:this.y>t.y?t.y:this.y,this.z=this.z<e.z?e.z:this.z>t.z?t.z:this.z,this}clampScalar(e,t){return this.x=this.x<e?e:this.x>t?t:this.x,this.y=this.y<e?e:this.y>t?t:this.y,this.z=this.z<e?e:this.z>t?t:this.z,this}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}roundToZero(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}lengthManhattan(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}normalize(){return this.divideScalar(this.length())}setLength(e){const t=this.length();return t!==0&&e!==t&&this.multiplyScalar(e/t),this}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this}lerpVectors(e,t,i){return this.subVectors(t,e).multiplyScalar(i).add(e),this}cross(e){const t=this.x,i=this.y,n=this.z;return this.x=i*e.z-n*e.y,this.y=n*e.x-t*e.z,this.z=t*e.y-i*e.x,this}crossVectors(e,t){return this.x=e.y*t.z-e.z*t.y,this.y=e.z*t.x-e.x*t.z,this.z=e.x*t.y-e.y*t.x,this}projectOnVector(e){qn._tempVec3.copyFrom(e).normalize();const t=this.dot(qn._tempVec3);return this.copyFrom(qn._tempVec3).multiplyScalar(t)}projectOnPlane(e){return qn._tempVec3.copyFrom(this).projectOnVector(e),this.sub(qn._tempVec3)}reflect(e){return this.sub(qn._tempVec3.copyFrom(e).multiplyScalar(2*this.dot(e)))}angleTo(e){const t=this.dot(e)/(this.length()*e.length());return Math.acos(xi(t,-1,1))}distanceTo(e){return Math.sqrt(this.distanceToSquared(e))}distanceToSquared(e){const t=this.x-e.x,i=this.y-e.y,n=this.z-e.z;return t*t+i*i+n*n}approxEquals(e,t=1e-4){return Ws(this.x,e.x,t)&&Ws(this.y,e.y,t)&&Ws(this.z,e.z,t)}equals(e){return e.x===this.x&&e.y===this.y&&e.z===this.z}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this.z=e[t+2],this}fillArray(e,t=0){e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z}addToArray(e,t=0){e[t]+=this.x,e[t+1]+=this.y,e[t+2]+=this.z}toArray(){return[this.x,this.y,this.z]}clone(){return new qn(this.x,this.y,this.z)}};r(qn,"_tempVec3",new qn);let F=qn;const Co=class Co{constructor(e=new F,t=0){r(this,"center");r(this,"radius");this.center=e,this.radius=t}set(e,t){return this.center.copyFrom(e),this.radius=t,this}setFromBox(e){return e.center(this.center),this.radius=Co._tempVec3.subVectors(this.center,e.min).length(),this}setFromPoints(e,t){const i=this.center,n=new ti;t!==void 0?i.copyFrom(t):n.setFromPoints(e).center(i);let o=0;for(const a of e)o=Math.max(o,i.distanceToSquared(a));return this.radius=Math.sqrt(o),this}copyFrom(e){return this.center.copyFrom(e.center),this.radius=e.radius,this}empty(){return this.radius<=0}containsPoint(e){return e.distanceToSquared(this.center)<=this.radius*this.radius}distanceToPoint(e){return e.distanceTo(this.center)-this.radius}intersectsSphere(e){const t=this.radius+e.radius;return e.center.distanceToSquared(this.center)<=t*t}clampPoint(e,t){const i=this.center.distanceToSquared(e),n=t||new F;return n.copyFrom(e),i>this.radius*this.radius&&(n.sub(this.center).normalize(),n.multiplyScalar(this.radius).add(this.center)),n}getBoundingBox(){const e=new ti;return e.set(this.center,this.center),e.expandByScalar(this.radius),e}applyMatrix4(e){return e.affineTransformPoint3(this.center),this.radius=this.radius*e.getMaxScaleOnAxis(),this}translate(e){return this.center.add(e),this}equals(e){return e.center.equals(this.center)&&e.radius===this.radius}clone(){return new Co().copyFrom(this)}static union(e,t){if(t.empty()){t.copyFrom(e);return}const i=t.center.distanceTo(e.center);let n,o;e.radius>t.radius?(n=e,o=t):(n=t,o=e);const a=(n.radius+o.radius+i)/2;if(a<=n.radius){t.copyFrom(n);return}const l=(a-n.radius)/i;console.assert(l>0),Co._tempVec3.copyFrom(o.center).sub(n.center).multiplyScalar(l),t.center.copyFrom(n.center).add(Co._tempVec3),t.radius=a}};r(Co,"_tempVec3",new F);let Fn=Co;const Zs=class Zs{constructor(e,t){r(this,"min",new F(1/0,1/0,1/0));r(this,"max",new F(-1/0,-1/0,-1/0));e&&t?this.set(e,t):Pe(!e&&!t)}set(e,t){return this.min.copyFrom(e),this.max.copyFrom(t),this}setFromPoints(e){this.makeEmpty();for(const t of e)this.expandByPoint(t);return this}setFromArray(e,t=0,i=e.length/3){this.makeEmpty();const n=new F,o=t*3,a=(t+i)*3;o<=e.length&&a<=e.length;for(let l=o;l<a;l+=3)n.set(e[l],e[l+1],e[l+2]),this.expandByPoint(n);return this}copyFrom(e){return this.min.copyFrom(e.min),this.max.copyFrom(e.max),this}makeEmpty(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this}empty(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z}center(e){return(e!=null?e:new F).addVectors(this.min,this.max).multiplyScalar(.5)}size(e){return(e!=null?e:new F).subVectors(this.max,this.min)}volume(){return this.empty()?0:(this.max.x-this.min.x)*(this.max.y-this.min.y)*(this.max.z-this.min.z)}expandByPoint(e){return this.min.min(e),this.max.max(e),this}expandByVector(e){return this.min.sub(e),this.max.add(e),this}expandByScalar(e){return this.min.addScalar(-e),this.max.addScalar(e),this}containsPoint(e){return!(e.x<this.min.x||e.x>this.max.x||e.y<this.min.y||e.y>this.max.y||e.z<this.min.z||e.z>this.max.z)}containsBox(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y&&this.min.z<=e.min.z&&e.max.z<=this.max.z}getParameter(e,t){return(t!=null?t:new F).set((e.x-this.min.x)/(this.max.x-this.min.x),(e.y-this.min.y)/(this.max.y-this.min.y),(e.z-this.min.z)/(this.max.z-this.min.z))}isIntersectionBox(e){return!(e.max.x<this.min.x||e.min.x>this.max.x||e.max.y<this.min.y||e.min.y>this.max.y||e.max.z<this.min.z||e.min.z>this.max.z)}clampPoint(e,t){return(t!=null?t:new F).copyFrom(e).clamp(this.min,this.max)}distanceToPoint(e){return Zs._tempVec3.copyFrom(e).clamp(this.min,this.max).sub(e).length()}getBoundingSphere(e){const t=e!=null?e:new Fn;return t.center=this.center(),t.radius=this.size(Zs._tempVec3).length()*.5,t}intersect(e){return this.min.max(e.min),this.max.min(e.max),this}union(e){return this.min.min(e.min),this.max.max(e.max),this}applyMatrix4(e){const t=(i,n,o)=>{Zs._tempVec3.set(i,n,o),this.expandByPoint(e.affineTransformPoint3(Zs._tempVec3))};return t(this.min.x,this.min.y,this.min.z),t(this.min.x,this.min.y,this.max.z),t(this.min.x,this.max.y,this.min.z),t(this.min.x,this.max.y,this.max.z),t(this.max.x,this.min.y,this.min.z),t(this.max.x,this.min.y,this.max.z),t(this.max.x,this.max.y,this.min.z),t(this.max.x,this.max.y,this.max.z),this}translate(e){return this.min.add(e),this.max.add(e),this}equals(e){return e.min.equals(this.min)&&e.max.equals(this.max)}clone(){return new Zs(this.min,this.max)}};r(Zs,"_tempVec3",new F);let ti=Zs;const Zl=class Zl{static linearToGamma(e){return Pp(e)}static gammaToLinear(e){return za(e)}static rgbmEncode(e,t){const i=2.82842712,n=Math.sqrt(e.r)/i,o=Math.sqrt(e.g)/i,a=Math.sqrt(e.b)/i;let l=Math.max(Math.max(n,o),a);l=xi(l,1/255,1),l=Math.ceil(l*255)/255,t.set(n/l,o/l,a/l,1-l)}static ycocgmEncode(e,t,i){const a=(x,v)=>{const E=Math.max(Math.abs(x),Math.abs(v));return E<.03125?16:E<.0625?8:E<.125?4:E<.25?2:1};let l=.25*e.r+.5*e.g+.25*e.b,c=.5*e.r-.5*e.b,h=-.25*e.r+.5*e.g-.25*e.b;l*=1/8,c*=1/8,h*=1/8;const d=a(c,h);l=Math.sqrt(l),c=c*d+.5,h=h*d+.5;let u,m;if(l<i)u=l*(1/i),m=16-1;else{u=(l-i)*(1/(1-i));const x=u*(16-3);m=x|0,u=x-m,m++}const b=(16-16/d|0)+m*16;t.set(u,c,h,b*(1/255))}static combineColorWithOpacity(e,t){if(t>=1)return e;const i=Zl._tempColor;i.setStyle(e);const n=o=>o*255|0;return"rgba("+n(i.r)+","+n(i.g)+","+n(i.b)+","+t+")"}};r(Zl,"_tempColor",new be);let vs=Zl;const Ki=class Ki{constructor(){r(this,"elements",new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]))}set(e,t,i,n,o,a,l,c,h,d,u,m,g,b,x,v){const E=this.elements;return E[0]=e,E[4]=t,E[8]=i,E[12]=n,E[1]=o,E[5]=a,E[9]=l,E[13]=c,E[2]=h,E[6]=d,E[10]=u,E[14]=m,E[3]=g,E[7]=b,E[11]=x,E[15]=v,this}setZero(){return this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),this}identity(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}copyFrom(e){return this.elements.set(e.elements),this}copyPosition(e){const t=this.elements,i=e.elements;return t[12]=i[12],t[13]=i[13],t[14]=i[14],this}extractBasis(e,t,i){const n=this.elements;return e.set(n[0],n[1],n[2]),t.set(n[4],n[5],n[6]),i.set(n[8],n[9],n[10]),this}makeBasis(e,t,i){return this.set(e.x,t.x,i.x,0,e.y,t.y,i.y,0,e.z,t.z,i.z,0,0,0,0,1),this}extractRotation(e){const t=Ki._tempVec3A,i=this.elements,n=e.elements,o=1/t.set(n[0],n[1],n[2]).length(),a=1/t.set(n[4],n[5],n[6]).length(),l=1/t.set(n[8],n[9],n[10]).length();return i[0]=n[0]*o,i[1]=n[1]*o,i[2]=n[2]*o,i[4]=n[4]*a,i[5]=n[5]*a,i[6]=n[6]*a,i[8]=n[8]*l,i[9]=n[9]*l,i[10]=n[10]*l,this}makeRotationFromQuaternion(e){const t=this.elements,i=e.x,n=e.y,o=e.z,a=e.w,l=i+i,c=n+n,h=o+o,d=i*l,u=i*c,m=i*h,g=n*c,b=n*h,x=o*h,v=a*l,E=a*c,w=a*h;return t[0]=1-(g+x),t[4]=u-w,t[8]=m+E,t[1]=u+w,t[5]=1-(d+x),t[9]=b-v,t[2]=m-E,t[6]=b+v,t[10]=1-(d+g),t[3]=0,t[7]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this}lookAt(e,t,i){const n=Ki._tempVec3A,o=Ki._tempVec3B,a=Ki._tempVec3C,l=this.elements;return a.subVectors(e,t).normalize(),a.length()===0&&(a.z=1),n.crossVectors(i,a).normalize(),n.length()===0&&(a.x+=1e-4,n.crossVectors(i,a).normalize()),o.crossVectors(a,n),l[0]=n.x,l[4]=o.x,l[8]=a.x,l[1]=n.y,l[5]=o.y,l[9]=a.y,l[2]=n.z,l[6]=o.z,l[10]=a.z,this}multiply(e){return this.multiplyMatrices(this,e)}multiplyMatrices(e,t){const i=e.elements,n=t.elements,o=this.elements,a=i[0],l=i[4],c=i[8],h=i[12],d=i[1],u=i[5],m=i[9],g=i[13],b=i[2],x=i[6],v=i[10],E=i[14],w=i[3],C=i[7],I=i[11],O=i[15],U=n[0],z=n[4],ie=n[8],J=n[12],re=n[1],Oe=n[5],We=n[9],Ve=n[13],lt=n[2],k=n[6],K=n[10],de=n[14],ce=n[3],Te=n[7],pe=n[11],ye=n[15];return o[0]=a*U+l*re+c*lt+h*ce,o[4]=a*z+l*Oe+c*k+h*Te,o[8]=a*ie+l*We+c*K+h*pe,o[12]=a*J+l*Ve+c*de+h*ye,o[1]=d*U+u*re+m*lt+g*ce,o[5]=d*z+u*Oe+m*k+g*Te,o[9]=d*ie+u*We+m*K+g*pe,o[13]=d*J+u*Ve+m*de+g*ye,o[2]=b*U+x*re+v*lt+E*ce,o[6]=b*z+x*Oe+v*k+E*Te,o[10]=b*ie+x*We+v*K+E*pe,o[14]=b*J+x*Ve+v*de+E*ye,o[3]=w*U+C*re+I*lt+O*ce,o[7]=w*z+C*Oe+I*k+O*Te,o[11]=w*ie+C*We+I*K+O*pe,o[15]=w*J+C*Ve+I*de+O*ye,this}multiplyScalar(e){const t=this.elements;return t[0]*=e,t[4]*=e,t[8]*=e,t[12]*=e,t[1]*=e,t[5]*=e,t[9]*=e,t[13]*=e,t[2]*=e,t[6]*=e,t[10]*=e,t[14]*=e,t[3]*=e,t[7]*=e,t[11]*=e,t[15]*=e,this}getTranslation(e=new F){return e.x=this.elements[12],e.y=this.elements[13],e.z=this.elements[14],e}affineTransformPoint3(e){this.isApproxAffine();const t=e.x,i=e.y,n=e.z,o=this.elements;return e.x=o[0]*t+o[4]*i+o[8]*n+o[12],e.y=o[1]*t+o[5]*i+o[9]*n+o[13],e.z=o[2]*t+o[6]*i+o[10]*n+o[14],e}transformPoint3(e){const t=e.x,i=e.y,n=e.z,o=this.elements,a=1/(o[3]*t+o[7]*i+o[11]*n+o[15]);return e.x=(o[0]*t+o[4]*i+o[8]*n+o[12])*a,e.y=(o[1]*t+o[5]*i+o[9]*n+o[13])*a,e.z=(o[2]*t+o[6]*i+o[10]*n+o[14])*a,e}transformVector3(e){this.isApproxAffine();const t=e.x,i=e.y,n=e.z,o=this.elements;return e.x=o[0]*t+o[4]*i+o[8]*n,e.y=o[1]*t+o[5]*i+o[9]*n,e.z=o[2]*t+o[6]*i+o[10]*n,e.normalize(),e}affineTransformPoint3Array(e,t=0,i=e.length){const n=Ki._tempVec3A;for(let o=0,a=t;o<i;o+=3,a+=3)n.x=e[a],n.y=e[a+1],n.z=e[a+2],this.affineTransformPoint3(n),e[a]=n.x,e[a+1]=n.y,e[a+2]=n.z}determinant(){const e=this.elements,t=e[0],i=e[4],n=e[8],o=e[12],a=e[1],l=e[5],c=e[9],h=e[13],d=e[2],u=e[6],m=e[10],g=e[14],b=e[3],x=e[7],v=e[11],E=e[15];return b*(+o*c*u-n*h*u-o*l*m+i*h*m+n*l*g-i*c*g)+x*(+t*c*g-t*h*m+o*a*m-n*a*g+n*h*d-o*c*d)+v*(+t*h*u-t*l*g-o*a*u+i*a*g+o*l*d-i*h*d)+E*(-n*l*d-t*c*u+t*l*m+n*a*u-i*a*m+i*c*d)}transpose(){const e=this.elements;let t;return t=e[1],e[1]=e[4],e[4]=t,t=e[2],e[2]=e[8],e[8]=t,t=e[6],e[6]=e[9],e[9]=t,t=e[3],e[3]=e[12],e[12]=t,t=e[7],e[7]=e[13],e[13]=t,t=e[11],e[11]=e[14],e[14]=t,this}setPosition(e){const t=this.elements;return t[12]=e.x,t[13]=e.y,t[14]=e.z,this}invert(){const e=Ki._tempMatrix4;return e.getInverse(this),this.copyFrom(e),this}getInverse(e,t=!1){const i=this.elements,n=e.elements,o=n[0],a=n[4],l=n[8],c=n[12],h=n[1],d=n[5],u=n[9],m=n[13],g=n[2],b=n[6],x=n[10],v=n[14],E=n[3],w=n[7],C=n[11],I=n[15];i[0]=u*v*w-m*x*w+m*b*C-d*v*C-u*b*I+d*x*I,i[4]=c*x*w-l*v*w-c*b*C+a*v*C+l*b*I-a*x*I,i[8]=l*m*w-c*u*w+c*d*C-a*m*C-l*d*I+a*u*I,i[12]=c*u*b-l*m*b-c*d*x+a*m*x+l*d*v-a*u*v,i[1]=m*x*E-u*v*E-m*g*C+h*v*C+u*g*I-h*x*I,i[5]=l*v*E-c*x*E+c*g*C-o*v*C-l*g*I+o*x*I,i[9]=c*u*E-l*m*E-c*h*C+o*m*C+l*h*I-o*u*I,i[13]=l*m*g-c*u*g+c*h*x-o*m*x-l*h*v+o*u*v,i[2]=d*v*E-m*b*E+m*g*w-h*v*w-d*g*I+h*b*I,i[6]=c*b*E-a*v*E-c*g*w+o*v*w+a*g*I-o*b*I,i[10]=a*m*E-c*d*E+c*h*w-o*m*w-a*h*I+o*d*I,i[14]=c*d*g-a*m*g-c*h*b+o*m*b+a*h*v-o*d*v,i[3]=u*b*E-d*x*E-u*g*w+h*x*w+d*g*C-h*b*C,i[7]=a*x*E-l*b*E+l*g*w-o*x*w-a*g*C+o*b*C,i[11]=l*d*E-a*u*E-l*h*w+o*u*w+a*h*C-o*d*C,i[15]=a*u*g-l*d*g+l*h*b-o*u*b-a*h*x+o*d*x;const O=o*i[0]+h*i[4]+g*i[8]+E*i[12];if(O==0){const U="Matrix4.getInverse(): can't invert matrix, determinant is 0";if(t)throw new Error(U);return console.warn(U),this.identity(),this}return this.multiplyScalar(1/O),this}scale(e){const t=this.elements,i=e.x,n=e.y,o=e.z;return t[0]*=i,t[4]*=n,t[8]*=o,t[1]*=i,t[5]*=n,t[9]*=o,t[2]*=i,t[6]*=n,t[10]*=o,t[3]*=i,t[7]*=n,t[11]*=o,this}getMaxScaleOnAxis(){const e=this.elements,t=e[0]*e[0]+e[1]*e[1]+e[2]*e[2],i=e[4]*e[4]+e[5]*e[5]+e[6]*e[6],n=e[8]*e[8]+e[9]*e[9]+e[10]*e[10];return Math.sqrt(Math.max(t,Math.max(i,n)))}makeTranslation(e,t,i){return this.set(1,0,0,e,0,1,0,t,0,0,1,i,0,0,0,1),this}makeRotationX(e){const t=Math.cos(e),i=Math.sin(e);return this.set(1,0,0,0,0,t,-i,0,0,i,t,0,0,0,0,1),this}makeRotationY(e){const t=Math.cos(e),i=Math.sin(e);return this.set(t,0,i,0,0,1,0,0,-i,0,t,0,0,0,0,1),this}makeRotationZ(e){const t=Math.cos(e),i=Math.sin(e);return this.set(t,-i,0,0,i,t,0,0,0,0,1,0,0,0,0,1),this}makeRotationAxis(e,t){const i=Math.cos(t),n=Math.sin(t),o=1-i,a=e.x,l=e.y,c=e.z,h=o*a,d=o*l;return this.set(h*a+i,h*l-n*c,h*c+n*l,0,h*l+n*c,d*l+i,d*c-n*a,0,h*c-n*l,d*c+n*a,o*c*c+i,0,0,0,0,1),this}makeScale(e,t,i){return this.set(e,0,0,0,0,t,0,0,0,0,i,0,0,0,0,1),this}compose(e,t,i){return this.makeRotationFromQuaternion(t),this.scale(i),this.setPosition(e),this}decompose(e,t,i){const n=Ki._tempVec3A,o=Ki._tempMatrix4,a=this.elements;let l=n.set(a[0],a[1],a[2]).length();const c=n.set(a[4],a[5],a[6]).length(),h=n.set(a[8],a[9],a[10]).length();this.determinant()<0&&(l=-l),e.x=a[12],e.y=a[13],e.z=a[14],o.elements.set(this.elements);const u=1/l,m=1/c,g=1/h;return o.elements[0]*=u,o.elements[1]*=u,o.elements[2]*=u,o.elements[4]*=m,o.elements[5]*=m,o.elements[6]*=m,o.elements[8]*=g,o.elements[9]*=g,o.elements[10]*=g,t.setFromRotationMatrix(o),i.x=l,i.y=c,i.z=h,this}makeFrustum(e,t,i,n,o,a){const l=this.elements,c=2*o/(t-e),h=2*o/(n-i),d=(t+e)/(t-e),u=(n+i)/(n-i),m=-(a+o)/(a-o),g=-2*a*o/(a-o);return l[0]=c,l[4]=0,l[8]=d,l[12]=0,l[1]=0,l[5]=h,l[9]=u,l[13]=0,l[2]=0,l[6]=0,l[10]=m,l[14]=g,l[3]=0,l[7]=0,l[11]=-1,l[15]=0,this}makePerspective(e,t,i,n){const o=i*Math.tan(qt(e*.5)),a=-o,l=a*t,c=o*t;return this.makeFrustum(l,c,a,o,i,n)}makeOrthographic(e,t,i,n,o,a){const l=this.elements,c=t-e,h=i-n,d=a-o,u=(t+e)/c,m=(i+n)/h,g=(a+o)/d;return l[0]=2/c,l[4]=0,l[8]=0,l[12]=-u,l[1]=0,l[5]=2/h,l[9]=0,l[13]=-m,l[2]=0,l[6]=0,l[10]=-2/d,l[14]=-g,l[3]=0,l[7]=0,l[11]=0,l[15]=1,this}fromArray(e){return this.elements.set(e),this}toArray(){return Array.from(this.elements)}clone(){return new Ki().fromArray(this.elements)}approxEquals(e,t=1e-4){for(let i=0;i<16;i++)if(!Ws(this.elements[i],e.elements[i],t))return!1;return!0}isApproxAffine(e=1e-4){const t=this.elements;return Ws(t[3],0,e)&&Ws(t[7],0,e)&&Ws(t[11],0,e)&&Ws(t[15],1,e)}hasNaNs(){for(let e=0;e<this.elements.length;e++)if(isNaN(this.elements[e]))return!0;return!1}};r(Ki,"_tempVec3A",new F),r(Ki,"_tempVec3B",new F),r(Ki,"_tempVec3C",new F),r(Ki,"_tempMatrix4",new Ki);let at=Ki;const da=class da{constructor(e=0,t=0,i=0,n=1){r(this,"x");r(this,"y");r(this,"z");r(this,"w");this.x=e,this.y=t,this.z=i,this.w=n}set(e,t,i,n){return this.x=e,this.y=t,this.z=i,this.w=n,this}copyFrom(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this}setFromAxisAngle(e,t){const i=t/2,n=Math.sin(i);return this.x=e.x*n,this.y=e.y*n,this.z=e.z*n,this.w=Math.cos(i),this}setFromRotationMatrix(e){const t=e.elements,i=t[0],n=t[4],o=t[8],a=t[1],l=t[5],c=t[9],h=t[2],d=t[6],u=t[10],m=i+l+u;let g;return m>0?(g=.5/Math.sqrt(m+1),this.w=.25/g,this.x=(d-c)*g,this.y=(o-h)*g,this.z=(a-n)*g):i>l&&i>u?(g=2*Math.sqrt(1+i-l-u),this.w=(d-c)/g,this.x=.25*g,this.y=(n+a)/g,this.z=(o+h)/g):l>u?(g=2*Math.sqrt(1+l-i-u),this.w=(o-h)/g,this.x=(n+a)/g,this.y=.25*g,this.z=(c+d)/g):(g=2*Math.sqrt(1+u-i-l),this.w=(a-n)/g,this.x=(o+h)/g,this.y=(c+d)/g,this.z=.25*g),this}setFromUnitVectors(e,t){const n=da._tempVec3;let o=e.dot(t)+1;return o<1e-6?(o=0,Math.abs(e.x)>Math.abs(e.z)?n.set(-e.y,e.x,0):n.set(0,-e.z,e.y)):n.crossVectors(e,t),this.x=n.x,this.y=n.y,this.z=n.z,this.w=o,this.normalize(),this}inverse(){return this.conjugate().normalize(),this}conjugate(){return this.x*=-1,this.y*=-1,this.z*=-1,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}normalize(){let e=this.length();return e===0?(this.x=0,this.y=0,this.z=0,this.w=1):(e=1/e,this.x=this.x*e,this.y=this.y*e,this.z=this.z*e,this.w=this.w*e),this}multiply(e){return this.multiplyQuaternions(this,e)}multiplyQuaternions(e,t){const i=e.x,n=e.y,o=e.z,a=e.w,l=t.x,c=t.y,h=t.z,d=t.w;return this.x=i*d+a*l+n*h-o*c,this.y=n*d+a*c+o*l-i*h,this.z=o*d+a*h+i*c-n*l,this.w=a*d-i*l-n*c-o*h,this}slerp(e,t){if(t===0)return this;if(t===1)return this.copyFrom(e);const i=this.x,n=this.y,o=this.z,a=this.w;let l=a*e.w+i*e.x+n*e.y+o*e.z;if(l<0?(this.w=-e.w,this.x=-e.x,this.y=-e.y,this.z=-e.z,l=-l):this.copyFrom(e),l>=1)return this.w=a,this.x=i,this.y=n,this.z=o,this;const c=Math.acos(l),h=Math.sqrt(1-l*l);if(Math.abs(h)<.001)return this.w=.5*(a+this.w),this.x=.5*(i+this.x),this.y=.5*(n+this.y),this.z=.5*(o+this.z),this;const d=Math.sin((1-t)*c)/h,u=Math.sin(t*c)/h;return this.w=a*d+this.w*u,this.x=i*d+this.x*u,this.y=n*d+this.y*u,this.z=o*d+this.z*u,this}static slerp(e,t,i,n){return i.copyFrom(e).slerp(t,n)}equals(e){return e.x===this.x&&e.y===this.y&&e.z===this.z&&e.w===this.w}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this.z=e[t+2],this.w=e[t+3],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w,e}applyToVector3(e){const t=e.x,i=e.y,n=e.z,o=this.x,a=this.y,l=this.z,c=this.w,h=c*t+a*n-l*i,d=c*i+l*t-o*n,u=c*n+o*i-a*t,m=-o*t-a*i-l*n;return e.x=h*c+m*-o+d*-l-u*-a,e.y=d*c+m*-a+u*-o-h*-l,e.z=u*c+m*-l+h*-a-d*-o,e}clone(){return new da(this.x,this.y,this.z,this.w)}};r(da,"_tempVec3");let wi=da;var On=(s=>(s[s.XYZ=0]="XYZ",s[s.YZX=1]="YZX",s[s.ZXY=2]="ZXY",s[s.XZY=3]="XZY",s[s.YXZ=4]="YXZ",s[s.ZYX=5]="ZYX",s))(On||{});const Fs=class Fs{constructor(e=0,t=0,i=0,n=2){r(this,"x");r(this,"y");r(this,"z");r(this,"order");this.x=t,this.y=i,this.z=e,this.order=n}set(e,t,i,n){return this.x=e,this.y=t,this.z=i,n!==void 0&&(this.order=n),this}copyFrom(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.order=e.order,this}setFromRotationMatrix(e,t){const i=e.elements,n=i[0],o=i[4],a=i[8],l=i[1],c=i[5],h=i[9],d=i[2],u=i[6],m=i[10];return t=t||this.order,t===0?(this.y=Math.asin(xi(a,-1,1)),Math.abs(a)<.99999?(this.x=Math.atan2(-h,m),this.z=Math.atan2(-o,n)):(this.x=Math.atan2(u,c),this.z=0)):t===4?(this.x=Math.asin(-xi(h,-1,1)),Math.abs(h)<.99999?(this.y=Math.atan2(a,m),this.z=Math.atan2(l,c)):(this.y=Math.atan2(-d,n),this.z=0)):t===2?(this.x=Math.asin(xi(u,-1,1)),Math.abs(u)<.99999?(this.y=Math.atan2(-d,m),this.z=Math.atan2(-o,c)):(this.y=0,this.z=Math.atan2(l,n))):t===5?(this.y=Math.asin(-xi(d,-1,1)),Math.abs(d)<.99999?(this.x=Math.atan2(u,m),this.z=Math.atan2(l,n)):(this.x=0,this.z=Math.atan2(-o,c))):t===1?(this.z=Math.asin(xi(l,-1,1)),Math.abs(l)<.99999?(this.x=Math.atan2(-h,c),this.y=Math.atan2(-d,n)):(this.x=0,this.y=Math.atan2(a,m))):t===3&&(this.z=Math.asin(-xi(o,-1,1)),Math.abs(o)<.99999?(this.x=Math.atan2(u,c),this.y=Math.atan2(a,n)):(this.x=Math.atan2(-h,m),this.y=0)),this.order=t,this}setFromQuaternion(e,t){return Fs._tempMatrix4.makeRotationFromQuaternion(e),this.setFromRotationMatrix(Fs._tempMatrix4,t),this}setFromVector3(e,t){return this.set(e.x,e.y,e.z,t!=null?t:this.order)}equals(e){return e.x===this.x&&e.y===this.y&&e.z===this.z&&e.order===this.order}fromArray(e){return this.x=e[0],this.y=e[1],this.z=e[2],e[3]!==void 0&&(this.order=e[3]),this}toArray(e,t=0){return e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.order,e}toVector3(){return new F(this.x,this.y,this.z)}applyToVector3(e){return this.toQuaternion(Fs._tempQuat),Fs._tempQuat.applyToVector3(e)}clone(){return new Fs(this.x,this.y,this.z,this.order)}get pitch(){return this.x}set pitch(e){this.x=e}get roll(){return this.y}set roll(e){this.y=e}get yaw(){return this.z}set yaw(e){this.z=e}get pitchDeg(){return mn(this.pitch)}set pitchDeg(e){this.pitch=qt(e)}get rollDeg(){return mn(this.roll)}set rollDeg(e){this.roll=qt(e)}get yawDeg(){return mn(this.yaw)}set yawDeg(e){this.yaw=qt(e)}setFromDegTriple(e){const t=qt(e[0]),i=qt(e[1]),n=qt(e[2]);return this.set(i,n,t),this}toDegTriple(){return[this.yawDeg,this.pitchDeg,this.rollDeg]}setFromDirection(e){const t=Math.atan2(-e.x,e.y),i=Math.asin(e.z),n=0;return this.set(i,n,t),this}toQuaternion(e=new wi){const t=Math.cos(this.x/2),i=Math.cos(this.y/2),n=Math.cos(this.z/2),o=Math.sin(this.x/2),a=Math.sin(this.y/2),l=Math.sin(this.z/2);return this.order===0?e.set(o*i*n+t*a*l,t*a*n-o*i*l,t*i*l+o*a*n,t*i*n-o*a*l):this.order===4?e.set(o*i*n+t*a*l,t*a*n-o*i*l,t*i*l-o*a*n,t*i*n+o*a*l):this.order===2?e.set(o*i*n-t*a*l,t*a*n+o*i*l,t*i*l+o*a*n,t*i*n-o*a*l):this.order===5?e.set(o*i*n-t*a*l,t*a*n+o*i*l,t*i*l-o*a*n,t*i*n+o*a*l):this.order===1?e.set(o*i*n+t*a*l,t*a*n+o*i*l,t*i*l-o*a*n,t*i*n-o*a*l):this.order===3&&e.set(o*i*n-t*a*l,t*a*n-o*i*l,t*i*l+o*a*n,t*i*n+o*a*l),e}toRotationMatrix(e=new at){const t=e.elements,i=Math.cos(this.x),n=Math.sin(this.x),o=Math.cos(this.y),a=Math.sin(this.y),l=Math.cos(this.z),c=Math.sin(this.z);if(this.order===0){const h=i*l,d=i*c,u=n*l,m=n*c;t[0]=o*l,t[4]=-o*c,t[8]=a,t[1]=d+u*a,t[5]=h-m*a,t[9]=-n*o,t[2]=m-h*a,t[6]=u+d*a,t[10]=i*o}else if(this.order===4){const h=o*l,d=o*c,u=a*l,m=a*c;t[0]=h+m*n,t[4]=u*n-d,t[8]=i*a,t[1]=i*c,t[5]=i*l,t[9]=-n,t[2]=d*n-u,t[6]=m+h*n,t[10]=i*o}else if(this.order===2){const h=o*l,d=o*c,u=a*l,m=a*c;t[0]=h-m*n,t[4]=-i*c,t[8]=u+d*n,t[1]=d+u*n,t[5]=i*l,t[9]=m-h*n,t[2]=-i*a,t[6]=n,t[10]=i*o}else if(this.order===5){const h=i*l,d=i*c,u=n*l,m=n*c;t[0]=o*l,t[4]=u*a-d,t[8]=h*a+m,t[1]=o*c,t[5]=m*a+h,t[9]=d*a-u,t[2]=-a,t[6]=n*o,t[10]=i*o}else if(this.order===1){const h=i*o,d=i*a,u=n*o,m=n*a;t[0]=o*l,t[4]=m-h*c,t[8]=u*c+d,t[1]=c,t[5]=i*l,t[9]=-n*l,t[2]=-a*l,t[6]=d*c+u,t[10]=h-m*c}else if(this.order===3){const h=i*o,d=i*a,u=n*o,m=n*a;t[0]=o*l,t[4]=-c,t[8]=a*l,t[1]=h*c+m,t[5]=i*l,t[9]=d*c-u,t[2]=u*c-d,t[6]=n*l,t[10]=m*c+h}return t[3]=0,t[7]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,e}};r(Fs,"_tempQuat",new wi),r(Fs,"_tempMatrix4",new at);let ui=Fs;const ua=class ua{constructor(){r(this,"elements",new Float32Array([1,0,0,0,1,0,0,0,1]))}set(e,t,i,n,o,a,l,c,h){const d=this.elements;return d[0]=e,d[3]=t,d[6]=i,d[1]=n,d[4]=o,d[7]=a,d[2]=l,d[5]=c,d[8]=h,this}identity(){return this.set(1,0,0,0,1,0,0,0,1),this}copyFrom(e){const t=e.elements;return this.set(t[0],t[3],t[6],t[1],t[4],t[7],t[2],t[5],t[8]),this}transformVector3(e){const t=e.x,i=e.y,n=e.z,o=this.elements;return e.x=o[0]*t+o[3]*i+o[6]*n,e.y=o[1]*t+o[4]*i+o[7]*n,e.z=o[2]*t+o[5]*i+o[8]*n,e}transformVector3Array(e,t=0,i=e.length){const n=ua._tempVec3;for(let o=0,a=t;o<i;o+=3,a+=3)n.x=e[a+0],n.y=e[a+1],n.z=e[a+2],this.transformVector3(n),e[a+0]=n.x,e[a+1]=n.y,e[a+2]=n.z}multiplyScalar(e){const t=this.elements;return t[0]*=e,t[3]*=e,t[6]*=e,t[1]*=e,t[4]*=e,t[7]*=e,t[2]*=e,t[5]*=e,t[8]*=e,this}determinant(){const e=this.elements;return e[0]*e[4]*e[8]-e[0]*e[5]*e[7]-e[1]*e[3]*e[8]+e[1]*e[5]*e[6]+e[2]*e[3]*e[7]-e[2]*e[4]*e[6]}getInverse(e,t=!1){const i=e.elements,n=this.elements;n[0]=+i[10]*i[5]-i[6]*i[9],n[1]=-i[10]*i[1]+i[2]*i[9],n[2]=+i[6]*i[1]-i[2]*i[5],n[3]=-i[10]*i[4]+i[6]*i[8],n[4]=+i[10]*i[0]-i[2]*i[8],n[5]=-i[6]*i[0]+i[2]*i[4],n[6]=+i[9]*i[4]-i[5]*i[8],n[7]=-i[9]*i[0]+i[1]*i[8],n[8]=+i[5]*i[0]-i[1]*i[4];const o=i[0]*n[0]+i[1]*n[3]+i[2]*n[6];if(o===0){const a="Matrix3.getInverse(): can't invert matrix, determinant is 0";if(t)throw new Error(a);return console.warn(a),this.identity(),this}return this.multiplyScalar(1/o),this}transpose(){const e=this.elements;let t=e[1];return e[1]=e[3],e[3]=t,t=e[2],e[2]=e[6],e[6]=t,t=e[5],e[5]=e[7],e[7]=t,this}getNormalMatrix(e){return this.getInverse(e).transpose(),this}fromArray(e){return this.elements.set(e),this}toArray(){const e=this.elements;return[e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8]]}fromMatrix4(e){const t=e.elements;return this.set(t[0],t[4],t[8],t[1],t[5],t[9],t[2],t[6],t[10]),this}toMatrix4(e=void 0){const t=this.elements;return e===void 0&&(e=new at),e.set(t[0],t[3],t[6],0,t[1],t[4],t[7],0,t[2],t[5],t[8],0,0,0,0,1),e}clone(){return new ua().fromArray(this.elements)}};r(ua,"_tempVec3",new F);let Ho=ua;const Pn=class Pn{constructor(e=new F,t=0){r(this,"normal");r(this,"constant");this.normal=e,this.constant=t}set(e,t){return this.normal.copyFrom(e),this.constant=t,this}setComponents(e,t,i,n){return this.normal.set(e,t,i),this.constant=n,this}setFromNormalAndCoplanarPoint(e,t){return this.normal.copyFrom(e),this.constant=-t.dot(this.normal),this}setFromCoplanarPoints(e,t,i){const n=Pn._tempVec3A,o=Pn._tempVec3B,a=n.subVectors(i,t).cross(o.subVectors(e,t)).normalize();return this.setFromNormalAndCoplanarPoint(a,e),this}copyFrom(e){return this.normal.copyFrom(e.normal),this.constant=e.constant,this}normalize(){const e=1/this.normal.length();return this.normal.multiplyScalar(e),this.constant*=e,this}negate(){return this.constant*=-1,this.normal.negate(),this}distanceToPoint(e){return this.normal.dot(e)+this.constant}distanceToSphere(e){return this.distanceToPoint(e.center)-e.radius}projectPoint(e,t=new F){return this.orthoPoint(e,t).sub(e).negate()}orthoPoint(e,t=new F){const i=this.distanceToPoint(e);return t.copyFrom(this.normal).multiplyScalar(i)}isIntersectionLine(e){const t=this.distanceToPoint(e.start),i=this.distanceToPoint(e.end);return t<0&&i>0||i<0&&t>0}intersectLine(e,t=new F){const i=Pn._tempVec3A,n=t,o=e.delta(i),a=this.normal.dot(o);if(a==0)return this.distanceToPoint(e.start)==0?n.copyFrom(e.start):void 0;const l=-(e.start.dot(this.normal)+this.constant)/a;if(!(l<0||l>1))return n.copyFrom(o).multiplyScalar(l).add(e.start)}coplanarPoint(e=new F){return e.copyFrom(this.normal).multiplyScalar(-this.constant)}applyMatrix4(e,t){const i=Pn._tempVec3A,n=Pn._tempVec3B,o=Pn._tempMatrix3,l=(t!=null?t:o.getNormalMatrix(e)).transformVector3(i.copyFrom(this.normal)),c=this.coplanarPoint(n);return e.affineTransformPoint3(c),this.setFromNormalAndCoplanarPoint(l,c),this}translate(e){return this.constant=this.constant-e.dot(this.normal),this}equals(e){return e.normal.equals(this.normal)&&e.constant===this.constant}clone(){return new Pn().copyFrom(this)}};r(Pn,"_tempVec3A",new F),r(Pn,"_tempVec3B",new F),r(Pn,"_tempMatrix3",new Ho);let js=Pn;const Os=class Os{constructor(){r(this,"planes",[new js,new js,new js,new js,new js,new js])}setFromMatrix(e){const t=e.elements,i=this.planes;return i[0].setComponents(t[3]-t[0],t[7]-t[4],t[11]-t[8],t[15]-t[12]).normalize(),i[1].setComponents(t[3]+t[0],t[7]+t[4],t[11]+t[8],t[15]+t[12]).normalize(),i[2].setComponents(t[3]+t[1],t[7]+t[5],t[11]+t[9],t[15]+t[13]).normalize(),i[3].setComponents(t[3]-t[1],t[7]-t[5],t[11]-t[9],t[15]-t[13]).normalize(),i[4].setComponents(t[3]-t[2],t[7]-t[6],t[11]-t[10],t[15]-t[14]).normalize(),i[5].setComponents(t[3]+t[2],t[7]+t[6],t[11]+t[10],t[15]+t[14]).normalize(),this}intersectsObject(e){const t=e.geometry;let i;return t.boundingSphere===null&&t.computeBoundingSphere(),e.matrixWorld?(i=Os._tempSphere,i.copyFrom(t.boundingSphere),i.applyMatrix4(e.matrixWorld)):i=t.boundingSphere,this.intersectsSphere(i)}nearPlaneDistanceToCenter(e){const t=e.geometry;let i;const n=this.planes[5];return e.matrixWorld?(i=Os._tempSphere,i.copyFrom(t.boundingSphere),i.applyMatrix4(e.matrixWorld)):i=t.boundingSphere,n.distanceToPoint(i.center)}nearPlaneDistanceToPoint(e){return this.planes[5].distanceToPoint(e)}intersectsSphere(e){const t=this.planes,i=e.center,n=-e.radius;for(let o=0;o<6;o+=1)if(t[o].distanceToPoint(i)<n)return!1;return!0}intersectsBox(e){const t=Os._tempVec3A,i=Os._tempVec3B,n=this.planes;for(const o of n){t.x=o.normal.x>0?e.min.x:e.max.x,i.x=o.normal.x>0?e.max.x:e.min.x,t.y=o.normal.y>0?e.min.y:e.max.y,i.y=o.normal.y>0?e.max.y:e.min.y,t.z=o.normal.z>0?e.min.z:e.max.z,i.z=o.normal.z>0?e.max.z:e.min.z;const a=o.distanceToPoint(t),l=o.distanceToPoint(i);if(a<0&&l<0)return!1}return!0}containsPoint(e){return this.planes.every(t=>t.distanceToPoint(e)>=0)}};r(Os,"_tempSphere",new Fn),r(Os,"_tempVec3A",new F),r(Os,"_tempVec3B",new F);let Ar=Os;const Ro=class Ro{constructor(e=new F,t=new F){r(this,"start");r(this,"end");this.start=e,this.end=t}set(e,t){return this.start.copyFrom(e),this.end.copyFrom(t),this}copyFrom(e){return this.start.copyFrom(e.start),this.end.copyFrom(e.end),this}center(e=new F){return e.addVectors(this.start,this.end).multiplyScalar(.5)}delta(e=new F){return e.subVectors(this.end,this.start)}distanceSq(){return this.start.distanceToSquared(this.end)}distance(){return this.start.distanceTo(this.end)}at(e,t=new F){const i=t;return this.delta(i).multiplyScalar(e).add(this.start)}closestPointToPointParameter(e,t=!1){const i=Ro._tempVec3A,n=Ro._tempVec3B;i.subVectors(e,this.start),n.subVectors(this.end,this.start);const o=n.dot(n);let l=n.dot(i)/o;return t&&(l=xi(l,0,1)),l}closestPointToPoint(e,t=!1,i=new F){const n=this.closestPointToPointParameter(e,t),o=i;return this.delta(o).multiplyScalar(n).add(this.start)}applyMatrix4(e){return e.affineTransformPoint3(this.start),e.affineTransformPoint3(this.end),this}equals(e){return e.start.equals(this.start)&&e.end.equals(this.end)}clone(){return new Ro().copyFrom(this)}};r(Ro,"_tempVec3A",new F),r(Ro,"_tempVec3B",new F);let yc=Ro;const an=class an{constructor(e=new F,t=new F){r(this,"origin");r(this,"direction");this.origin=e,this.direction=t}set(e,t){return this.origin.copyFrom(e),this.direction.copyFrom(t),this}copyFrom(e){return this.origin.copyFrom(e.origin),this.direction.copyFrom(e.direction),this}at(e,t=new F){return t.copyFrom(this.direction).multiplyScalar(e).add(this.origin)}recast(e){const t=an._tempVec3A;return this.origin.copyFrom(this.at(e,t)),this}closestPointToPoint(e,t=new F){const i=t;i.subVectors(e,this.origin);const n=i.dot(this.direction);return n<0?i.copyFrom(this.origin):i.copyFrom(this.direction).multiplyScalar(n).add(this.origin)}distanceToPoint(e){const t=an._tempVec3A,i=t.subVectors(e,this.origin).dot(this.direction);return i<0?this.origin.distanceTo(e):(t.copyFrom(this.direction).multiplyScalar(i).add(this.origin),t.distanceTo(e))}isIntersectionSphere(e){return this.distanceToPoint(e.center)<=e.radius}intersectSphere(e,t=new F){const i=an._tempVec3A;i.subVectors(e.center,this.origin);const n=i.dot(this.direction),o=i.dot(i)-n*n,a=e.radius*e.radius;if(o>a)return;const l=Math.sqrt(a-o),c=n-l,h=n+l;if(!(c<0&&h<0))return c<0?this.at(h,t):this.at(c,t)}isIntersectionPlane(e){const t=e.distanceToPoint(this.origin);return t===0||e.normal.dot(this.direction)*t<0}distanceToPlane(e){const t=e.normal.dot(this.direction);if(t==0)return e.distanceToPoint(this.origin)==0?0:void 0;const i=-(this.origin.dot(e.normal)+e.constant)/t;return i>=0?i:void 0}intersectPlane(e,t=new F){const i=this.distanceToPlane(e);if(i!==void 0)return this.at(i,t)}isIntersectionBox(e){const t=an._tempVec3A;return this.intersectBox(e,t)!==void 0}intersectBox(e,t=new F){let i,n,o,a,l,c;const h=1/this.direction.x,d=1/this.direction.y,u=1/this.direction.z,m=this.origin;if(h>=0?(i=(e.min.x-m.x)*h,n=(e.max.x-m.x)*h):(i=(e.max.x-m.x)*h,n=(e.min.x-m.x)*h),d>=0?(o=(e.min.y-m.y)*d,a=(e.max.y-m.y)*d):(o=(e.max.y-m.y)*d,a=(e.min.y-m.y)*d),!(i>a||o>n)&&((o>i||i!==i)&&(i=o),(a<n||n!==n)&&(n=a),u>=0?(l=(e.min.z-m.z)*u,c=(e.max.z-m.z)*u):(l=(e.max.z-m.z)*u,c=(e.min.z-m.z)*u),!(i>c||l>n)&&((l>i||i!==i)&&(i=l),(c<n||n!==n)&&(n=c),!(n<0))))return this.at(i>=0?i:n,t)}intersectTriangle(e,t,i,n=!1,o=new F){const a=an._tempVec3A,l=an._tempVec3B,c=an._tempVec3C,h=an._tempVec3D;l.subVectors(t,e),c.subVectors(i,e),h.crossVectors(l,c);let d=this.direction.dot(h),u;if(d>0){if(n)return;u=1}else if(d<0)u=-1,d=-d;else return;a.subVectors(this.origin,e);const m=u*this.direction.dot(c.crossVectors(a,c));if(m<0)return;const g=u*this.direction.dot(l.cross(a));if(g<0||m+g>d)return;const b=-u*a.dot(h);if(!(b<0))return this.at(b/d,o)}applyMatrix4(e){return e.affineTransformPoint3(this.direction.add(this.origin)),e.affineTransformPoint3(this.origin),this.direction.sub(this.origin),this.direction.normalize(),this}equals(e){return e.origin.equals(this.origin)&&e.direction.equals(this.direction)}clone(){return new an().copyFrom(this)}};r(an,"_tempVec3A",new F),r(an,"_tempVec3B",new F),r(an,"_tempVec3C",new F),r(an,"_tempVec3D",new F);let Ac=an;class tt{constructor(e=0,t=0,i=0,n=1){r(this,"x");r(this,"y");r(this,"z");r(this,"w");this.x=e,this.y=t,this.z=i,this.w=n}set(e,t,i,n){return this.x=e,this.y=t,this.z=i,this.w=n,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setZ(e){return this.z=e,this}setW(e){return this.w=e,this}setComponent(e,t){e==0?this.x=t:e==1?this.y=t:e==2?this.z=t:this.w=t}getComponent(e){return e==0?this.x:e==1?this.y:e==2?this.z:this.w}copyFrom(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w!==void 0?e.w:1,this}add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this.w+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this.w=e.w+t.w,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this.w-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this.w=e.w-t.w,this}multiplyScalar(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this}applyMatrix4(e){const t=this.x,i=this.y,n=this.z,o=this.w,a=e.elements;return this.x=a[0]*t+a[4]*i+a[8]*n+a[12]*o,this.y=a[1]*t+a[5]*i+a[9]*n+a[13]*o,this.z=a[2]*t+a[6]*i+a[10]*n+a[14]*o,this.w=a[3]*t+a[7]*i+a[11]*n+a[15]*o,this}divideScalar(e){if(e!==0){const t=1/e;this.x*=t,this.y*=t,this.z*=t,this.w*=t}else this.x=0,this.y=0,this.z=0,this.w=1;return this}min(e){return this.x=this.x>e.x?e.x:this.x,this.y=this.y>e.y?e.y:this.y,this.z=this.z>e.z?e.z:this.z,this.w=this.w>e.w?e.w:this.w,this}max(e){return this.x=this.x<e.x?e.x:this.x,this.y=this.y<e.y?e.y:this.y,this.z=this.z<e.z?e.z:this.z,this.w=this.w<e.w?e.w:this.w,this}clamp(e,t){return this.x=this.x<e.x?e.x:this.x>t.x?t.x:this.x,this.y=this.y<e.y?e.y:this.y>t.y?t.y:this.y,this.z=this.z<e.z?e.z:this.z>t.z?t.z:this.z,this.w=this.w<e.w?e.w:this.w>t.w?t.w:this.w,this}clampScalar(e,t){return this.x=this.x<e?e:this.x>t?t:this.x,this.y=this.y<e?e:this.y>t?t:this.y,this.z=this.z<e?e:this.z>t?t:this.z,this.w=this.w<e?e:this.w>t?t:this.w,this}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this.w=Math.floor(this.w),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this.w=Math.ceil(this.w),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this.w=Math.round(this.w),this}roundToZero(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this.w=this.w<0?Math.ceil(this.w):Math.floor(this.w),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthManhattan(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)}normalize(){return this.divideScalar(this.length())}setLength(e){const t=this.length();return t!==0&&e!==t&&this.multiplyScalar(e/t),this}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this.w+=(e.w-this.w)*t,this}lerpVectors(e,t,i){return this.subVectors(t,e).multiplyScalar(i).add(e),this}equals(e){return e.x===this.x&&e.y===this.y&&e.z===this.z&&e.w===this.w}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this.z=e[t+2],this.w=e[t+3],this}toArray(){return[this.x,this.y,this.z,this.w]}clone(){return new tt(this.x,this.y,this.z,this.w)}}class Er{static vertexNormals(e,t){e.length%3;const i=e.length/3;t?t.length%3:i%3;const n=t?t.length/3:i/3,o=new Float32Array(e.length),a=new F,l=new F,c=new F,h=new F,d=new F;for(let u=0;u<n;u++){const m=t?t[u*3+0]*3:u*9+0,g=t?t[u*3+1]*3:u*9+3,b=t?t[u*3+2]*3:u*9+6;a.fromArray(e,m),l.fromArray(e,g),c.fromArray(e,b),h.subVectors(a,l),d.subVectors(c,l),d.cross(h),d.addToArray(o,m),d.addToArray(o,g),d.addToArray(o,b)}return Er.normalizeVectors(o),o}static normalizeVectors(e){const t=new F;for(let i=0;i<e.length;i+=3)t.fromArray(e,i),t.normalize(),t.fillArray(e,i)}static normalsToSpherical(e,t=!1){e.length%3;const i=e.length/3,n=t?new Int16Array(i*2):new Int8Array(i*2);for(let o=0;o<i;o+=1){const a=e[o*3+0],l=e[o*3+1],c=e[o*3+2],h=(Math.acos(c)/Math.PI-.5)*2,d=Math.atan2(l,a)/Math.PI;n[o*2+0]=Na(h),n[o*2+1]=Na(d)}return n}}/*!
 * Copyright (C) 2014-present unreal engine
 */function Va(s,e){if(s.length!==e.length)return!1;for(let t=0;t<s.length;t+=1)if(s[t]!==e[t])return!1;return!0}function Ga(s){setTimeout(s,0)}function Ec(s,e){if(s.length===0)return;let t=0,i=e(s[0]);for(let n=1;n<s.length;n+=1){const o=e(s[n]);o>i&&(t=n,i=o)}return t}function zi(s,e){const t=e.indexOf(s);return console.assert(t!==-1),e.splice(t,1)}function Up(s,e){const t=e.indexOf(s);return t!==-1?e.splice(t,1):[]}function Ha(s,e,t){const i=s.indexOf(e),n=t>i?1:-1;for(let o=i;o!==t;o+=n)s[o]=s[o+n];s[t]=e}function Tc(s,e,t){for(let i=0;i<e.length;i+=1){const n=e[i],o=s[n];o!==void 0&&(t[n]=o)}}const Sc=Math.PI*2;function Nt(s){return s%=Sc,s>Math.PI?-Sc+s:s<-Math.PI?Sc+s:s}function Sd(s,e){return Math.atan2(-(e.x-s.x),e.y-s.y)}function Wo(s,e){s.textContent!==void 0?s.textContent=e:console.warn("textContent and innerText properties are missing")}function wd(s){return s.ctrlKey||s.altKey||s.metaKey}function Wa(s){const e=new Image;return e.src=s,e}function Md(s,e){if(s.readyState>=s.HAVE_CURRENT_DATA){e(s);return}function t(){s.readyState>=s.HAVE_CURRENT_DATA&&(s.removeEventListener("playing",t),s.removeEventListener("timeupdate",t),e(s))}s.addEventListener("playing",t),s.addEventListener("timeupdate",t)}function An(s){return JSON.parse(JSON.stringify(s))}function Tr(s){return typeof s=="object"?Object.freeze(An(s)):s}function Sr(s,e){if(s===e)return!0;if(typeof s!="object"||s===null||typeof e!="object"||e===null||Object.keys(s).length!==Object.keys(e).length)return!1;for(const t of Object.keys(s))if(!Object.prototype.hasOwnProperty.call(e,t)||!Sr(s[t],e[t]))return!1;return!0}function Np(){const s=document.getElementsByTagName("script");for(const e of s)if(e.src.includes("walk.min.js"))return e.src.split("/").slice(0,-1).join("/")+"/";return console.error("Cannot determine webwalk URL."),"/webwalk/"}function ii(s){return Np()+s}const wc={FontAwesomeSolid:"",FontAwesomeRegular:"",FontAwesomeBrands:""};function Pd(s,e,t){if(s.length===0){e();return}const i={};s.forEach(l=>{Ke(wc[l],"Font "+JSON.stringify(l)+" is not supported."),i[l]=wc[l]});let n=0,o=0;function a(l){l?++n:++o,n+o===s.length&&(o===0?e():t&&t())}WebFont.load({custom:{families:s,testStrings:i},timeout:1e4,fontactive:function(){a(!0)},fontinactive:function(l){console.error("Cannot load font: "+l),a(!1)}})}function wr(s){return s.startsWith("extra-assets/")?M.ASSETS_URL+s:M.ASSETS_URL+"extra-assets/"+s}function ja(...s){}const Mc=()=>({lineColor:new be(0),highlightColor:M.EDITOR_SELECTION_COLOR,lightmapResolutionLineColor:new be(170),autoLightmapResolutionLineColor:new be(43690),meshSelectedLineColor:new be(47872),meshSelectedSecondaryLineColor:new be(13404160),wireframeModeClearColor:new be(16777215)});function bs(s){return window.TouchEvent&&s instanceof TouchEvent}function kp(s){return s.length===0?s:s.charAt(0).toUpperCase()+s.slice(1)}/*!
 * Copyright (C) 2021-present unreal engine
 */const fi={help:{basic:"BASIC",advanced:"ADVANCED",mouse:"Mouse",or:"or",keyboard:"Keyboard",vrTeleport:"VR teleport",holdLeftButton:"Hold the left button",clickLeftButton:"Click the left button",lookAround:"Look around",walkToClickedPlace:"Walk to the clicked place",selectMaterialLightObject:"Select material, light, object",scroll:"Scroll",walkStraight:"Walk straight",walkStraightAndLookAround:"Walk straight and look around",walkStraightAndSideways:"Walk straight and sideways",changeHeight:"Change height",switchView:"Switch view",screenshot:"Screenshot",illuminationPreview:"Illumination preview",hideShowMenu:"Hide/show menu",hideShowMousePointer:"Hide/show mouse pointer",vrMode:"VR Mode",gazeAtFixedPlace:"Gaze at a fixed place",clickControllerButton:"Click a controller button",teleport:"Teleport",touch:"Touch",interactiveDesktop:"Click and drag to look around",interactiveMobile:"Drag to look around"},meetings:{and:"and",close:"Close",cancel:"Cancel",error:"Error",join3dMeeting:"Join 3D meeting",name:"Name",camera:"Camera",microphone:"Microphone",networkIssuesDetected:"Network issues detected.",diagnoseConnection:"Diagnose your connection.",byJoiningYouAgreeTo:"By joining, you agree to the",termsOfService:"Terms of Service",privacyPolicy:"Privacy Policy",infrastructureProvidedUnderTos:"The 3D meeting infrastructure is provided by unreal engine under the following Terms of Service",infrastructureProvidedUnderPp:"The 3D meeting infrastructure is provided by unreal engine under the following Privacy Policy",testCamera:"Test camera",join:"Join",devicesNotFound:{microphone:"Microphone not found",camera:"Camera not found",microphoneAndCamera:"Microphone and camera not found"},devicesBlocked:{microphone:"Microphone blocked",camera:"Camera blocked",microphoneAndCamera:"Microphone and camera blocked"},devicesNotAvailable:{microphone:"Microphone not available",camera:"Camera not available",microphoneAndCamera:"Microphone and camera not available"},checkIfDevicesConnected:{microphone:"Check if your microphone is properly connected.",camera:"Check if your camera is properly connected.",microphoneAndCamera:"Check if your microphone and camera are properly connected."},unblockDevices:{byButtons:{oneDevice:{beforeIcons:"Unblock it by clicking the",afterIcons:"button."},twoDevices:{beforeIcons:"Unblock them by clicking",afterIcons:"buttons."}},inBrowserSettings:{oneDevice:"Unblock it in the browser settings for this webpage.",twoDevices:"Unblock them in the browser settings for this webpage."},byButtonInAddressBar:{oneDevice:{beforeIcon:"Unblock it by clicking the",afterIcon:"button in the browser's address bar and refresh the webpage."},twoDevices:{beforeIcon:"Unblock them by clicking the",afterIcon:"button in the browser's address bar and refresh the webpage."}}},browserDoesNotSupportMeetings:"Your browser doesn't support video meetings. Open the meeting link in another browser.",ifConnectedCloseAppsAndRefresh:{oneDevice:"If it is connected, close all other applications using it and refresh the webpage.",twoDevices:"If they are connected, close all other applications using them and refresh the webpage."},me:"me",pointPlace:"Point a place by clicking.",doYouWantToLeaveMeeting:"Do you want to leave this meeting?",leaveMeeting:"Leave meeting",youHaveLeftMeeting:"You have left the meeting",joinAgain:"Join again",connectionLost:"Meeting connection lost.",code:"Code",meetingEnded:"The meeting has ended.",meetingEndedMaximumDurationReached:"The meeting has ended. Maximum duration of meeting reached.",failedToLoadMeeting:"Failed to load the meeting",failedToJoinMeeting:"Failed to join the meeting. Is your link valid?"}};/*!
 * Copyright (C) 2021-present unreal engine
 */const zp={help:en(Vt({},fi.help),{basic:"基本",advanced:"高级",mouse:"滑鼠",or:"或",keyboard:"键盘",vrTeleport:"VR 传送",holdLeftButton:"按住左键",clickLeftButton:"单按左键",lookAround:"调整视角",walkToClickedPlace:"走去指定地点",selectMaterialLightObject:"选择材质，灯光，物体",scroll:"滑轮",walkStraight:"直走",walkStraightAndLookAround:"调整视角",walkStraightAndSideways:"移动",changeHeight:"调整高度",switchView:"移动至指定视角",screenshot:"截图",illuminationPreview:"照明预览",hideShowMenu:"隐藏/显示菜单",hideShowMousePointer:"隐藏/显示鼠标",vrMode:"VR 模式",gazeAtFixedPlace:"凝视一个固定的地方",clickControllerButton:"单击控制器按钮",teleport:"传送",touch:"触碰"}),meetings:Vt({},fi.meetings)};/*!
 * Copyright (C) 2021-present unreal engine
 */const Vp={help:en(Vt({},fi.help),{basic:"GRUNDLAGEN",advanced:"ERWEITERT",mouse:"Maus",or:"oder",keyboard:"Tastatur",vrTeleport:"VR-Teleport",holdLeftButton:"Linke Maustaste gedrückt halten",clickLeftButton:"Klick auf die linke Maustaste",lookAround:"Umschauen",walkToClickedPlace:"Zum angeklickten Punkt bewegen",selectMaterialLightObject:"Material, Licht, Objekt auswählen",scroll:"Mausrad",walkStraight:"Geradeaus gehen",walkStraightAndLookAround:"Geradeaus gehen und umsehen",walkStraightAndSideways:"Geradeaus und seitwärts gehen",changeHeight:"Höhe ändern",switchView:"Ansicht wechseln",screenshot:"Bildschirmfoto",illuminationPreview:"Beleuchtungsvorschau",hideShowMenu:"Menü aus- / einblenden",hideShowMousePointer:"Mauszeiger aus-/einblenden",vrMode:"VR-Modus",gazeAtFixedPlace:"Blick auf einem Punkt fixieren",clickControllerButton:"Controller Taste drücken",teleport:"Teleportieren",touch:"Tippen"}),meetings:Vt({},fi.meetings)};/*!
 * Copyright (C) 2021-present unreal engine
 */const Gp={help:en(Vt({},fi.help),{basic:"BÁSICO",advanced:"AVANZADO",mouse:"Ratón",or:"o",keyboard:"Teclado",vrTeleport:"Teletransporte VR",holdLeftButton:"Mantén presionado el botón izquierdo",clickLeftButton:"Haz clic en el botón izquierdo",lookAround:"Mira a tu alrededor",walkToClickedPlace:"Camina hasta el lugar donde hiciste clic",selectMaterialLightObject:"Selecciona material, luz, objeto",scroll:"Desplázate",walkStraight:"Camina en línea recta",walkStraightAndLookAround:"Camina en línea recta y mira a tu alrededor",walkStraightAndSideways:"Camina recto y de lado",changeHeight:"Cambiar altura",switchView:"Cambiar vista",screenshot:"Captura de pantalla",illuminationPreview:"Vista previa de iluminación",hideShowMenu:"Ocultar / mostrar menú",hideShowMousePointer:"Ocultar / mostrar el puntero del ratón",vrMode:"Modo VR",gazeAtFixedPlace:"Mira a un punto fijo",clickControllerButton:"Pulsa un botón del mando",teleport:"Teletransporte",touch:"Tocar"}),meetings:Vt({},fi.meetings)};/*!
 * Copyright (C) 2023-present unreal engine
 */const Hp={help:en(Vt({},fi.help),{basic:"PERUS",advanced:"EDISTYNYT",mouse:"Hiiri",or:"tai",keyboard:"Näppäimistö",vrTeleport:"VR-teleportti",holdLeftButton:"Pidä vasenta painiketta alhaalla",clickLeftButton:"Klikkaa vasenta painiketta",lookAround:"Katso ympärillesi",walkToClickedPlace:"Kävele klikattuun paikkaan",selectMaterialLightObject:"Valitse materiaali, valo, objekti",scroll:"Vieritä",walkStraight:"Kävele suoraan",walkStraightAndLookAround:"Kävele suoraan ja katso ympärillesi",walkStraightAndSideways:"Kävele suoraan ja sivuttain",changeHeight:"Muuta korkeutta",switchView:"Vaihda näkymää",screenshot:"Kuvankaappaus",illuminationPreview:"Valaistuksen esikatselu",hideShowMenu:"Piilota/näytä valikko",hideShowMousePointer:"Piilota/näytä hiiren osoitin",vrMode:"VR-tila",gazeAtFixedPlace:"Tuijota kiinteään paikkaan",clickControllerButton:"Klikkaa ohjaimen painiketta",teleport:"Teleporttaus",touch:"Kosketa",interactiveDesktop:"Klikkaa ja raahaa katsellaksesi ympäri",interactiveMobile:"Raahaa katsellaksesi ympäri"}),meetings:en(Vt({},fi.meetings),{and:"ja",close:"Sulje",cancel:"Peruuta",error:"Virhe",join3dMeeting:"Astu sisään virtuaalitilaan",name:"Nimi",camera:"Kamera",microphone:"Mikrofoni",networkIssuesDetected:"Verkkoyhteysongelmia havaittu.",diagnoseConnection:"Diagnosoi yhteytesi.",byJoiningYouAgreeTo:"Astuessasi sisään hyväksyt seuraavat:",termsOfService:"Käyttöehdot",privacyPolicy:"Tietosuojakäytäntö",infrastructureProvidedUnderTos:"3D-kokousinfrastruktuurin tarjoaa unreal engine seuraavien käyttöehtojen mukaisesti",infrastructureProvidedUnderPp:"3D-kokousinfrastruktuurin tarjoaa unreal engine tietosuojakäytännön mukaisesti",testCamera:"Testaa kamera",join:"Astu sisään",devicesNotFound:{microphone:"Mikrofonia ei löytynyt",camera:"Kameraa ei löytynyt",microphoneAndCamera:"Mikrofonia ja kameraa ei löytynyt"},devicesBlocked:{microphone:"Mikrofoni on estetty",camera:"Kamera on estetty",microphoneAndCamera:"Mikrofoni ja kamera ovat estetty"},devicesNotAvailable:{microphone:"Mikrofoni ei ole käytettävissä",camera:"Kamera ei ole käytettävissä",microphoneAndCamera:"Mikrofoni ja kamera eivät ole käytettävissä"},checkIfDevicesConnected:{microphone:"Varmista, että mikrofoni on kytketty oikein.",camera:"Varmista, että kamera on kytketty oikein.",microphoneAndCamera:"Varmista, että mikrofoni ja kamera ovat kytketty oikein."},unblockDevices:{byButtons:{oneDevice:{beforeIcons:"Poista esto napsauttamalla",afterIcons:"-painiketta."},twoDevices:{beforeIcons:"Poista niiden estot napsauttamalla",afterIcons:"-painikkeita."}},inBrowserSettings:{oneDevice:"Salli se selaimen asetuksista tälle verkkosivulle.",twoDevices:"Salli ne selaimen asetuksista tälle verkkosivulle."},byButtonInAddressBar:{oneDevice:{beforeIcon:"Salli se napsauttamalla",afterIcon:"-painiketta selaimen osoiterivillä ja päivitä verkkosivu."},twoDevices:{beforeIcon:"Salli ne napsauttamalla",afterIcon:"-painiketta selaimen osoiterivillä ja päivitä verkkosivu."}}},browserDoesNotSupportMeetings:"Selaimesi ei tue videotilaisuuksia. Avaa tilaisuuden linkki toisessa selaimessa.",ifConnectedCloseAppsAndRefresh:{oneDevice:"Jos se on käytössä, sulje kaikki muut sitä käyttävät sovellukset ja päivitä verkkosivu.",twoDevices:"Jos ne ovat käytössä, sulje kaikki muut niitä käyttävät sovellukset ja päivitä verkkosivu."},me:"minä",pointPlace:"Valitse paikka napsauttamalla.",doYouWantToLeaveMeeting:"Haluatko poistua tästä tilaisuudesta?",leaveMeeting:"Poistu tilaisuudesta",youHaveLeftMeeting:"Olet poistunut tilaisuudesta",joinAgain:"Liity uudelleen",connectionLost:"Yhteys tilaisuuteen katkesi.",code:"Koodi",meetingEnded:"Tilaisuus on päättynyt.",meetingEndedMaximumDurationReached:"Tilaisuus on päättynyt. Tilaisuuden enimmäiskesto on saavutettu.",failedToLoadMeeting:"Tilaisuuden lataaminen epäonnistui",failedToJoinMeeting:"Tilaisuuteen liittyminen epäonnistui. Onko linkkisi voimassa?"})};/*!
 * Copyright (C) 2021-present unreal engine
 */const Wp={help:en(Vt({},fi.help),{basic:"BASIQUES",advanced:"AVANCÉS",mouse:"Souris",or:"ou",keyboard:"Clavier",vrTeleport:"Téléportation VR",holdLeftButton:"Maintenez le bouton gauche",clickLeftButton:"Cliquez sur le bouton gauche",lookAround:"Regardez autour",walkToClickedPlace:"Déplacez-vous jusqu’à l’endroit cliqué",selectMaterialLightObject:"Sélectionnez le matériel, la lumière, l’objet",scroll:"Défilement",walkStraight:"Allez tout droit",walkStraightAndLookAround:"Allez tout droit et regardez autour",walkStraightAndSideways:"Allez tout droit et de côté",changeHeight:"Changez la hauteur",switchView:"Changez de vue",screenshot:"Capture d’écran",illuminationPreview:"Aperçu de l’éclairage",hideShowMenu:"Masquer / Afficher le menu",hideShowMousePointer:"Masquer / Afficher le pointeur de la souris",vrMode:"Mode RV",gazeAtFixedPlace:"Fixez un endroit précis",clickControllerButton:"Appuyez sur un bouton du contrôleur",teleport:"Téléportation",touch:"Touchez"}),meetings:Vt({},fi.meetings)};/*!
 * Copyright (C) 2022-present unreal engine
 */const jp={help:en(Vt({},fi.help),{basic:"基本操作",advanced:"詳細操作",mouse:"マウス",or:"or",keyboard:"キーボード",vrTeleport:"VR テレポート",holdLeftButton:"左ボタンを長押し",lookAround:"見回す",clickLeftButton:"左ボタン",walkToClickedPlace:"クリックした場所に移動する",selectMaterialLightObject:"マテリアル、ライト、オブジェクトを選択",scroll:"スクロール",walkStraight:"前後移動",walkStraightAndLookAround:"前後移動して見回す",walkStraightAndSideways:"前後左右移動",changeHeight:"高さ調整",switchView:"ビュー切り替え",screenshot:"スクリーンショット",illuminationPreview:"イルミネーションプレビュー",hideShowMenu:"メニュー 表示/非表示",hideShowMousePointer:"マウスカーソル 表示/非表示",vrMode:"VR モード",gazeAtFixedPlace:"特定の場所を見る",clickControllerButton:"コントローラーボタンをクリックする",teleport:"テレポート",touch:"触る",interactiveDesktop:"クリック＆ドラッグして見回す",interactiveMobile:"ドラッグして見回す"}),meetings:Vt({},fi.meetings)};/*!
 * Copyright (C) 2022-present unreal engine
 */const Xp={help:en(Vt({},fi.help),{basic:"기본 조작법",advanced:"상세 조작법",mouse:"마우스",or:"혹은",keyboard:"키보드",vrTeleport:"VR 이동",holdLeftButton:"좌측 버튼 드래그",clickLeftButton:"좌측 버튼 클릭",lookAround:"주변 둘러보기",walkToClickedPlace:"클릭한 곳으로 이동",selectMaterialLightObject:"재질, 조명, 사물 선택",scroll:"스크롤",walkStraight:"직진 이동",walkStraightAndLookAround:"직진 이동 / 주변 둘러보기",walkStraightAndSideways:"직진 이동 / 옆으로 이동",changeHeight:"높이 조절",switchView:"뷰 선택",screenshot:"스크린샷",illuminationPreview:"일루미네이션 프리뷰",hideShowMenu:"메뉴 On/Off",hideShowMousePointer:"마우스 포인터 On/Off",vrMode:"VR 모드",gazeAtFixedPlace:"특정 장소 바라보기",clickControllerButton:"컨트롤러 버튼 클릭",teleport:"텔레포트",touch:"터치"}),meetings:Vt({},fi.meetings)};/*!
 * Copyright (C) 2021-present unreal engine
 */const qp={help:en(Vt({},fi.help),{basic:"PODSTAWOWE",advanced:"ZAAWANSOWANE",mouse:"Myszka",or:"lub",keyboard:"Klawiatura",vrTeleport:"Teleportacja VR",holdLeftButton:"Przytrzymaj lewy przycisk",clickLeftButton:"Naciśnij lewy przycisk",lookAround:"Rozglądaj się",walkToClickedPlace:"Idź do naciśniętego miejsca",selectMaterialLightObject:"Wybierz materiał, światło, obiekt",scroll:"Przewiń",walkStraight:"Idź prosto",walkStraightAndLookAround:"Idź prosto i rozglądaj się",walkStraightAndSideways:"Idź prosto i na boki",changeHeight:"Zmień wysokość",switchView:"Zmień widok",screenshot:"Zrzut ekranu",illuminationPreview:"Podgląd oświetlenia",hideShowMenu:"Schowaj/pokaż menu",hideShowMousePointer:"Schowaj/pokaż kursor myszki",vrMode:"Tryb VR",gazeAtFixedPlace:"Patrz w ustalone miejsce",clickControllerButton:"Naciśnij przycisk kontrolera",teleport:"Teleportacja",touch:"Dotyk",interactiveDesktop:"Klikaj i przeciągaj, aby się rozglądać",interactiveMobile:"Przeciągaj, aby się rozglądać"}),meetings:Vt({},fi.meetings)};/*!
 * Copyright (C) 2021-present unreal engine
 */const Yp={help:en(Vt({},fi.help),{basic:"BÁSICO",advanced:"AVANÇADO",mouse:"Mouse",or:"ou",keyboard:"Teclado",vrTeleport:"Teletransporte VR",holdLeftButton:"Mantenha pressionado o botão esquerdo",clickLeftButton:"Clique com o botão esquerdo",lookAround:"Olhe ao redor",walkToClickedPlace:"Ande até o lugar que foi clicado",selectMaterialLightObject:"Selecione material, luz, objeto",scroll:"Rolagem",walkStraight:"Ande em frente",walkStraightAndLookAround:"Ande em frente e olhe ao redor",walkStraightAndSideways:"Ande em frente e para os lados",changeHeight:"Variar altura",switchView:"Alternar entre cenas",screenshot:"Captura de imagem",illuminationPreview:"Visualização de iluminação",hideShowMenu:"Ocultar/mostrar menu",hideShowMousePointer:"Ocultar/mostrar a seta do mouse",vrMode:"Modo VR",gazeAtFixedPlace:"Olhe para um lugar fixo",clickControllerButton:"Clique num botão controlador",teleport:"Teletransporte",touch:"Toque",interactiveDesktop:"Clique e arraste para olhar ao redor",interactiveMobile:"Arraste para olhar ao redor"}),meetings:Vt({},fi.meetings)};/*!
 * Copyright (C) 2021-present unreal engine
 */const Qp={help:en(Vt({},fi.help),{basic:"Basit",advanced:"İleri Düzey",mouse:"Fare",or:"veya",keyboard:"Klavye",vrTeleport:"VR Işınlanma",holdLeftButton:"Sol tuşa basılı tut",clickLeftButton:"Sol tuşa tıkla",lookAround:"Çevrene bak",walkToClickedPlace:"Tıkladığın alana yürü",selectMaterialLightObject:"Materyal, ışık veya obje seç",scroll:"Aşağı kaydır",walkStraight:"Düz yürü",walkStraightAndLookAround:"Düz yürü ve çevrene bakın",walkStraightAndSideways:"Düz ve yanlana doğru yürü",changeHeight:"Yükseklik değiştir",switchView:"Görünüm değiştir",screenshot:"Ekran Görüntüsü",illuminationPreview:"Aydınlatma önizlemesi",hideShowMenu:"Menüyü göster/gizle",hideShowMousePointer:"İmleci göster/gizle",vrMode:"VR Modu",gazeAtFixedPlace:"Bir noktaya kitlenerek bak",clickControllerButton:"Kumanda butonuna tıkla",teleport:"Işınlan",touch:"Dokun"}),meetings:Vt({},fi.meetings)};/*!
 * Copyright (C) 2023-present unreal engine
 */const Pc={Chinese:zp,German:Vp,English:fi,Finnish:Hp,French:Wp,Japanese:jp,Korean:Xp,Polish:qp,Portuguese:Yp,Spanish:Gp,Turkish:Qp};/*!
 * Copyright (C) 2021-present unreal engine
 */const Cc=An(Pc[M.DEFAULT_LANGUAGE]);function wt(s){return`<span data-strings="${s}"></span>`}function Kp(s){const e=s.split(".");let t=Cc;for(const i of e){if(!t||typeof t=="string")return;t=t[i]}if(typeof t=="string")return t}function Rc(s){const e=s.querySelectorAll("[data-strings]");for(let t=0;t<e.length;++t){const i=e.item(t),n=i.getAttribute("data-strings");if(!n)return;const o=Kp(n);o&&(i.textContent=o)}}function lo(s,e){s.innerHTML=e,Rc(s)}function Cd(s){function e(t,i,n){Object.entries(i).forEach(([o,a])=>{const l=n===""?o:`${n}.${o}`,c=t[o];if(c===void 0){console.warn(`Viewer string ${l} doesn’t exist`);return}if(a==null){console.error(`${l} must be defined`);return}if(typeof c!=typeof a){console.error(`${l} should be ${typeof c}`);return}switch(typeof a){case"string":t[o]=a;break;case"object":e(t[o],a,l);break}})}e(Cc,s,""),Rc(document)}Rc(document);function $p(){return Tr(Cc)}/*!
 * Copyright (C) 2014-present unreal engine
 */const Zp=15*1e3;class Jp{constructor(){}hideInfo(){const e=document.getElementById("info-message");e.style.display="none"}info(e,t){const i=document.getElementById("info-message");lo(i,e),i.style.display="",setTimeout(this.hideInfo,t||Zp),console.info(e)}error(e,t){const i=document.getElementById("error-message"),n=t?`
      <p>${e}</p>
      <button id="toggle-error-details" style="background: none; cursor: pointer;
        border: none; text-decoration: underline;" onclick="
        const details = document.getElementById('error-details');
        if (details.style.display === 'none') {
          details.style.display = 'block';
          this.textContent = '▲ Hide Details';
        } else {
          details.style.display = 'none';
          this.textContent = '▼ Show Details';
        }
        ">
        ▼ Show Details
      </button>
      <div id="error-details" style="display: none; margin-top: 10px; padding: 10px;
        word-wrap: break-word; font-size: smaller; overflow-wrap: break-word;">
        ${t}
      </div>`:e;lo(i,n),i.style.display="",console.error(e)}errorWithQr(e){const t=document.getElementById("error-message");t.innerHTML=e+'<div><canvas id="qr-code-inner-canvas" height="180" width="180"></canvas></div>';const i=()=>{const n=document.getElementById("qr-code-inner-canvas");QRCode.toCanvas(n,window.location.toString()),t.style.display="",console.error(e)};ho(ii("lib/qrcode.js"),i,()=>Gt.error(e))}sceneLoadError(e){const t=Qe.missingCapabilities();if(t){Gt.errorWithQr(t);return}let i="Scene failed to load. Reload the page to retry.";const n=Qe.whatsApp?"WhatsApp":Qe.facebookApp?"Facebook app":void 0;n&&(i=`Scene failed to load. Open the scene outside of ${n} by copying the link to the native web browser: <div class='message-scrollable-line'><a href='${window.location}' target='_blank'>${window.location}</a></div>`),this.error(i,e)}}const Gt=new Jp;let Ic=!1,Rd=!1;function e0(){Rd=!0}const co={NOT_NEEDED:0,TEST_NEEDED:1,NEEDED:2};function t0(){const s=new Set,e=new Map;function t(a){try{a()}catch(l){console.log(l)}}function i(a,l,c){const h=document.createElement("script");h.onload=l,h.onerror=c,h.src=a,h.type="text/javascript",h.crossOrigin="anonymous",document.body.appendChild(h)}function n(a){s.add(a);const l=e.get(a);e.delete(a),l.forEach(c=>t(c.onSuccess))}function o(a){const l=e.get(a);e.delete(a),console.error("Can't load script : "+a),l.forEach(function(c){c.onError!==void 0&&t(c.onError.bind(null,a))})}return function(a,l,c){s.has(a)?l():e.has(a)?e.get(a).push({onSuccess:l,onError:c}):(e.set(a,[{onSuccess:l,onError:c}]),i(a,n.bind(this,a),o.bind(this,a)))}}const ho=t0();function i0(){const s=[],e=[];let t=1/0;function i(){let a=0;for(let l in M.LOAD_PRIORITY)M.LOAD_PRIORITY.hasOwnProperty(l)&&(a=Math.max(a,M.LOAD_PRIORITY[l]));for(let l=0;l<=a;l+=1)s[l]=[],e[l]=0}i();function n(a){Ga(a)}function o(){for(t=t+1;t<s.length;t+=1){const a=s[t];if(a.length>0){for(let l=0;l<a.length;l+=1)e[t]+=1,n(a[l]);a.length=0;break}}}this.add=function(a,l){a<=t?(e[a]+=1,t=a,n(l)):(s[a].push(l),e[t]===0&&o())},this.finished=function(a){e[a]-=1;const l=e[a];console.assert(l>=0),a===t&&l===0&&o()}}const Xa=new i0;function n0(s){const e={"https://cdn0.unreal engine.com/":"https://cdn0-jsbr.unreal engine.com/","https://cdn0.dev.unreal engine.com/":"https://cdn0-jsbr.dev.unreal engine.com/","https://cdn0-unreal engine-cn-dev.oss-accelerate.aliyuncs.com/":"https://cdn0-jsbr-cn-dev.unreal engine.com.cn/","https://cdn0-unreal engine-cn.oss-accelerate.aliyuncs.com/":"https://cdn0-jsbr.unreal engine.com.cn/","https://cdncn0-unreal engine.oss-accelerate.aliyuncs.com/":"https://cdncn0-jsbr.unreal engine.com.cn/"};for(let[t,i]of Object.entries(e))if(s.startsWith(t))return s.replace(t,i);return s}function s0(){let s=[],e=[],t,i=!1,n=new XMLHttpRequest;function o(d){const u=new Int8Array(d);return new BrotliDecode(u).buffer}function a(d){t=d;for(let u=0;u<s.length;u+=1)s[u](d);s=null}function l(d){if(i){d();return}e.push(d),e.length===1&&ho(ii("lib/brotli.min.js"),()=>{i=!0;for(let u=0;u<e.length;u+=1)e[u]();e=null},()=>Gt.error("Cannot load required library"))}function c(){200<=n.status&&n.status<300||n.status===0?a(n.responseText==="SSSSSS"):(console.error("br.buf response",n.status),a(!0))}function h(d){if(t!==void 0){d(t);return}s.push(d),s.length===1&&(n.addEventListener("load",c,!1),n.open("GET",ii("3dassets/br.buf"),!0),n.send())}this.decode=function(d,u,m){u?l(()=>{m(o(d))}):h(g=>{g?m(d):l(()=>{m(o(d))})})}}const o0=new s0;function jo(s,e){return function(t){Xa.finished(s),e(t)}}function Xo(s){this.method=s,this.binaryResult=!1,this.data=null,this.dataContentType=null,s==="GET"?(this.retriesLeft=M.RETRIES_ON_LOAD_ERROR,this.retryDelayMs=1e3+Math.random()*1e3):(this.retriesLeft=0,this.retryDelayMs=0)}Xo.prototype={constructor:Xo,retryScheduled:function(){console.assert(this.retriesLeft>0),this.retriesLeft-=1,this.retryDelayMs*=2}};function r0(s,e,t,i,n,o){setTimeout(function(){Dc(s,e,t,i,n,o)},e.retryDelayMs),e.retryScheduled()}function Dc(s,e,t,i,n,o){let a=new XMLHttpRequest;function l(){const g=a.status||0;return e.method==="GET"&&(g>=500||g===0)?e.retriesLeft!==0:!1}function c(){return!o||Rd!==!0?co.NOT_NEEDED:a.getAllResponseHeaders().toLowerCase().indexOf("js-content-encoding:")>=0?co.NEEDED:a.getResponseHeader("content-encoding")==="br"?co.TEST_NEEDED:co.NOT_NEEDED}function h(g,b){const x=c();x===co.NOT_NEEDED?b(g):o0.decode(g,x===co.NEEDED,b)}function d(){const g=l();if(console.warn("Failed to "+e.method+": "+s+" ("+a.status+")"+(g?", retrying in "+e.retryDelayMs/1e3+"s":"")),g)o&&!Ic&&(console.warn("Switch to jsbr hosts."),Ic=!0),r0(s,e,t,i,n,o);else if(i!==void 0){let b;try{b=JSON.parse(a.responseText).message}catch(x){b=void 0}i(a.status,b)}a=null,e=null}function u(){const g=(b,x)=>{let v;if(x===null){let E="application/json";try{v=JSON.parse(b)}catch(w){v=b,E="text/plain"}console.warn(`content-type not defined for ${s} request's response. Assuming it's ${E}`)}else v=x.includes("text/plain")?b:JSON.parse(b);t(v)};if(t!==void 0)if(e.binaryResult)h(a.response,t);else{const b=a.getResponseHeader("content-type"),x=a.responseText;x?h(x,v=>g(v,b)):t()}a=null,e=null}function m(){200<=a.status&&a.status<300||a.status===0?u():d()}n!==void 0&&a.addEventListener("progress",n,!1),a.addEventListener("load",m,!1),a.addEventListener("error",d,!1),a.addEventListener("abort",d,!1),o&&Ic&&(s=n0(s)),a.open(e.method,s,!0),e.binaryResult&&(a.responseType="arraybuffer"),e.dataContentType&&a.setRequestHeader("Content-Type",e.dataContentType),e.method==="POST"&&a.setRequestHeader("X-Requested-By","unreal engine"),a.send(e.data)}function qa(s,e,t,i,n,o=!1){const a=new Xo("GET");a.binaryResult=e,Dc(s,a,t,i,n,o)}function uo(s,e,t,i,n,o,a=!1){Xa.add(s,function(){qa(e,t,jo(s,i),jo(s,n),o,a)})}function Mr(s,e,t,i,n,o){const a=new Xo("POST");a.data=t,a.dataContentType=e,Dc(s,a,i,n,o)}function Pr(s,e,t,i,n){Mr(s,"application/json",JSON.stringify(e),t,i,n)}function Id(s,e,t,i,n){function o(){s(e,t,i,n)}return function(){console.warn("Failed to get: "+e+(o?", retrying in "+t.retryDelayMs/1e3+"s":"")),t.retriesLeft>0?(setTimeout(o,t.retryDelayMs),t.retryScheduled()):n()}}function Dd(s,e,t,i){let n=new Image;n.onload=function(){t(n),n=null},n.onerror=Id(Dd,s,e,t,i),n.crossOrigin="anonymous",n.src=s}function Ld(s,e,t,i){Xa.add(s,function(){const n=new Xo("GET");Dd(e,n,jo(s,t),jo(s,i))})}function Fd(s,e,t,i){let n=document.createElement("video");n.muted=!0,n.loop=!0,n.setAttribute("playsinline",""),n.setAttribute("webkit-playsinline",""),n.crossOrigin="anonymous",n.onerror=Id(Fd,s,e,t,i),Md(n,function(){n.onerror=void 0,t(n),n=null}),n.src=s,n.play().catch(function(a){a.message.includes("video-only background media was paused to save power.")||i()})}function a0(s,e,t,i){Xa.add(s,function(){const n=new Xo("GET");Fd(e,n,jo(s,t),jo(s,i))})}function l0(s,e,t){function i(a){return new Promise((l,c)=>{ho(a,l,c)})}function n(a){t!==void 0&&t(a)}const o=s.map(a=>i(a));Promise.all(o).then(e).catch(n)}function Od(s){return new Promise((e,t)=>{ho(s,e,t)})}const c0=new Event("debugUi"),Io=class Io extends EventTarget{constructor(){super();r(this,"_registeredUiCallbacks",new Map)}static instance(){return Io._instance||(Io._instance=new Io),Io._instance}loadImGui(){return Dt(this,null,function*(){yield ImGui.default(),ImGui.CreateContext(),ImGui.StyleColorsDark();const t=document.getElementById("walk-canvas");Pe(t instanceof HTMLCanvasElement),ImGui_Impl.Init(t);const i=o=>{ImGui.GetIO().WantCaptureMouse&&o.stopPropagation()},n=o=>{ImGui.GetIO().WantCaptureKeyboard&&o.stopPropagation()};for(const o of["mousedown","mouseup","mousemove","wheel"])t.addEventListener(o,i,!0);for(const o of["keydown","keyup"])t.addEventListener(o,n)})}beginFrame(t){if(ImGui_Impl.NewFrame(t),ImGui.NewFrame(),this._registeredUiCallbacks.size>1){if(ImGui.BeginMainMenuBar()){for(const[i,n]of this._registeredUiCallbacks)ImGui.MenuItem(i,null,n.enabled)&&(n.enabled=!n.enabled,n.enabled?this.addEventListener("debugUi",n.func):this.removeEventListener("debugUi",n.func));ImGui.EndMainMenuBar()}}else if(this._registeredUiCallbacks.size===1){const i=this._registeredUiCallbacks.values().next().value;i.enabled||(i.enabled=!0,this.addEventListener("debugUi",i.func))}this.dispatchEvent(c0)}endFrame(){ImGui.EndFrame()}registerCallback(t,i){M.DEBUG_UI&&this._registeredUiCallbacks.set(t,{func:i,enabled:!1})}};r(Io,"_instance");let Ya=Io,En;class Xs{static setDebugMarker(e){En&&En.setMarker(e)}static clearDebugMarker(){En&&En.clearMarker()}static captureNextFrame(e){En&&En.captureNextFrame(e)}static startCapture(e,t=5e4){En&&En.startCapture(e,t)}static stopCapture(){En&&En.stopCapture()}static loadSpector(){return Dt(this,null,function*(){try{yield Od(ii("lib/spector.bundle.js"))}catch(e){console.error("Cannot load SpectorJS library");return}console.info("SpectorJS loaded"),En=new SPECTOR.Spector,En.displayUI()})}static loadWebglDebug(){return Dt(this,null,function*(){try{yield Od(ii("lib/webgl-debug.js")),console.info("WebGLDebugUtils loaded")}catch(e){console.error("Cannot load WebGLDebugUtils library")}})}static throwOnGLError(e,t){throw new Error(`${WebGLDebugUtils.glEnumToString(e)} was caused by call to: ${t}`)}static logGLCall(e,t){e!=="shaderSource"&&console.log(`gl.${e}(${WebGLDebugUtils.glFunctionArgsToString(e,t)})`)}static validateNoneOfTheArgsAreUndefined(e,t){Array.from(t).filter(i=>i===void 0).forEach(i=>{const n=WebGLDebugUtils.glFunctionArgToString(e,i);console.error(`undefined passed to gl.${e}(${n})`)})}static logAndValidate(e,t){Xs.logGLCall(e,t),Xs.validateNoneOfTheArgsAreUndefined(e,t)}static wrapWebglDebug(e){const t=M.DEBUG_WEBGL_ERROR?Xs.throwOnGLError:void 0,i=M.DEBUG_WEBGL_CALL?Xs.logAndValidate:void 0;try{return WebGLDebugUtils.makeDebugContext(e,t,i,void 0)}catch(n){return console.error("WebGLDebugUtils library not loaded"),e}}}function h0(){return Dt(this,null,function*(){M.DEBUG_UI&&(yield Ya.instance().loadImGui()),M.DEBUG_SPECTOR&&(yield Xs.loadSpector()),M.DEBUG_WEBGL&&(yield Xs.loadWebglDebug())})}function d0(s,e,t){const i=new Uint8Array(18);i[2]=2,i[7]=32,i[12]=s&255,i[13]=s>>8,i[14]=e&255,i[15]=e>>8,i[16]=32,i[17]=8;const n=new Uint8Array(i.length+t.length);n.set(i);for(let o=0;o<e;o++)for(let a=0;a<s;a++){const l=(o*s+a)*4,c=l+i.length;n[c+0]=t[l+2],n[c+1]=t[l+1],n[c+2]=t[l+0],n[c+3]=t[l+3]}return n}const Z={REPEAT:10497,CLAMP_TO_EDGE:33071,MIRRORED_REPEAT:33648,NEAREST:9728,LINEAR:9729,NEAREST_MIPMAP_NEAREST:9984,LINEAR_MIPMAP_NEAREST:9985,NEAREST_MIPMAP_LINEAR:9986,LINEAR_MIPMAP_LINEAR:9987,BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,INT:5124,UNSIGNED_INT:5125,FLOAT:5126,HALF_FLOAT:5131,UNSIGNED_SHORT_4_4_4_4:32819,UNSIGNED_SHORT_5_5_5_1:32820,UNSIGNED_SHORT_5_6_5:33635,INT_2_10_10_10_REV:36255,DEPTH_COMPONENT:6402,RED:6403,RG:33319,RGB:6407,RGBA:6408,R8:33321,RG8:33323,RGB8:32849,RGBA8:32856,RGB10_A2:32857,R32F:33326,RG32F:33328,RGB32F:34837,RGBA32F:34836,R16F:33325,RG16F:33327,RGB16F:34843,RGBA16F:34842,DEPTH_COMPONENT24:33190,DEPTH24_STENCIL8:35056,DEPTH_COMPONENT32F:36012,FUNC_ADD:32774,FUNC_SUBTRACT:32778,FUNC_REVERSE_SUBTRACT:32779,NONE:0,COMPARE_REF_TO_TEXTURE:34894,NEVER:512,LESS:513,EQUAL:514,LEQUAL:515,GREATER:516,NOTEQUAL:517,GEQUAL:518,ALWAYS:519,ZERO:0,ONE:1,SRC_COLOR:768,ONE_MINUS_SRC_COLOR:769,SRC_ALPHA:770,ONE_MINUS_SRC_ALPHA:771,DST_ALPHA:772,ONE_MINUS_DST_ALPHA:773,DST_COLOR:774,ONE_MINUS_DST_COLOR:775,SRC_ALPHA_SATURATE:776,CONSTANT_COLOR:32769,ONE_MINUS_CONSTANT_COLOR:32770,CONSTANT_ALPHA:32771,ONE_MINUS_CONSTANT_ALPHA:32772,COMPRESSED_RGB_S3TC_DXT1_EXT:33776,COMPRESSED_RGBA_S3TC_DXT1_EXT:33777,COMPRESSED_RGBA_S3TC_DXT3_EXT:33778,COMPRESSED_RGBA_S3TC_DXT5_EXT:33779,COMPRESSED_RGB_PVRTC_4BPPV1_IMG:35840,COMPRESSED_RGBA_PVRTC_4BPPV1_IMG:35842,COMPRESSED_RGB_PVRTC_2BPPV1_IMG:35841,COMPRESSED_RGBA_PVRTC_2BPPV1_IMG:35843,COMPRESSED_RGB_ETC1_WEBGL:36196,COMPRESSED_RGBA_ASTC_4x4_KHR:37808,SAMPLER_2D:35678,SAMPLER_3D:35679,SAMPLER_CUBE:35680,SAMPLER_2D_SHADOW:35682,SAMPLER_2D_ARRAY:36289,SAMPLER_2D_ARRAY_SHADOW:36292,SAMPLER_CUBE_SHADOW:36293,INT_SAMPLER_2D:36298,INT_SAMPLER_3D:36299,INT_SAMPLER_CUBE:36300,INT_SAMPLER_2D_ARRAY:36303,UNSIGNED_INT_SAMPLER_2D:36306,UNSIGNED_INT_SAMPLER_3D:36307,UNSIGNED_INT_SAMPLER_CUBE:36308,UNSIGNED_INT_SAMPLER_2D_ARRAY:36311,MAX_SAMPLES:36183,SAMPLER_BINDING:35097,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,INT_VEC2:35667,INT_VEC3:35668,INT_VEC4:35669,BOOL:35670,BOOL_VEC2:35671,BOOL_VEC3:35672,BOOL_VEC4:35673,FLOAT_MAT2:35674,FLOAT_MAT3:35675,FLOAT_MAT4:35676,TEXTURE_2D:3553,TEXTURE_CUBE_MAP:34067,ARRAY_BUFFER:34962,ELEMENT_ARRAY_BUFFER:34963,FRAMEBUFFER:36160,KEEP:7680,REPLACE:7681,INCR:7682,DECR:7683,INVERT:5386,INCR_WRAP:34055,DECR_WRAP:34056};/*!
 * Copyright (C) 2024-present unreal engine
 */class tn{constructor(e){r(this,"_object");this._object=e||{}}hasChild(e){const t=this._object[e];return tn._isObject(t)}child(e){const t=this._object[e],i=typeof t=="object"&&!Array.isArray(t)&&t!==null?t:void 0;return new tn(i)}keys(){return Object.keys(this._object)}parseBoolean(e,t){if(Object.hasOwn(this._object,e)){const i=this._object[e];if(i===!0||i==="true"||i===1)return!0;if(i===!1||i==="false"||i===0)return!1}return t}parseNumber(e,t){if(Object.hasOwn(this._object,e)){const i=this._object[e];if(typeof i=="number"&&isFinite(i))return i}return t}parseString(e,t){if(Object.hasOwn(this._object,e)){const i=this._object[e];if(typeof i=="string")return i}return t}parseEnum(e,t,i){if(Object.hasOwn(this._object,e)){const n=this._object[e];if(typeof n=="string"&&Object.values(t).includes(n))return n}return i}parseObject(e,t){if(Object.hasOwn(this._object,e)){const i=this._object[e];if(tn._isObject(i))return i}return t}parseStrings(e){if(Object.hasOwn(this._object,e)){const t=this._object[e];if(Array.isArray(t)&&t.every(i=>typeof i=="string"))return t}return[]}parseNumbers(e){if(Object.hasOwn(this._object,e)){const t=this._object[e];if(Array.isArray(t)&&t.every(i=>typeof i=="number"))return t}return[]}parseObjects(e){if(Object.hasOwn(this._object,e)){const t=this._object[e];if(Array.isArray(t)&&t.every(i=>tn._isObject(i)))return t}return[]}static _isObject(e){return typeof e=="object"&&!Array.isArray(e)&&e!==null}}var Be=(s=>(s[s.R8=Z.R8]="R8",s[s.RG8=Z.RG8]="RG8",s[s.RGB8=Z.RGB8]="RGB8",s[s.RGBA8=Z.RGBA8]="RGBA8",s[s.RGB10_A2=Z.RGB10_A2]="RGB10_A2",s[s.R32F=Z.R32F]="R32F",s[s.RG32F=Z.RG32F]="RG32F",s[s.RGB32F=Z.RGB32F]="RGB32F",s[s.RGBA32F=Z.RGBA32F]="RGBA32F",s[s.R16F=Z.R16F]="R16F",s[s.RG16F=Z.RG16F]="RG16F",s[s.RGB16F=Z.RGB16F]="RGB16F",s[s.RGBA16F=Z.RGBA16F]="RGBA16F",s[s.DEPTH24=Z.DEPTH_COMPONENT24]="DEPTH24",s[s.DEPTH24_STENCIL8=Z.DEPTH24_STENCIL8]="DEPTH24_STENCIL8",s[s.DEPTH32F=Z.DEPTH_COMPONENT32F]="DEPTH32F",s[s.RGB_DXT1=Z.COMPRESSED_RGB_S3TC_DXT1_EXT]="RGB_DXT1",s[s.RGBA_DXT1=Z.COMPRESSED_RGBA_S3TC_DXT1_EXT]="RGBA_DXT1",s[s.RGBA_DXT3=Z.COMPRESSED_RGBA_S3TC_DXT3_EXT]="RGBA_DXT3",s[s.RGBA_DXT5=Z.COMPRESSED_RGBA_S3TC_DXT5_EXT]="RGBA_DXT5",s[s.RGB_PVRTC_4BPPV1=Z.COMPRESSED_RGB_PVRTC_4BPPV1_IMG]="RGB_PVRTC_4BPPV1",s[s.RGBA_PVRTC_4BPPV1=Z.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG]="RGBA_PVRTC_4BPPV1",s[s.RGB_PVRTC_2BPPV1=Z.COMPRESSED_RGB_PVRTC_2BPPV1_IMG]="RGB_PVRTC_2BPPV1",s[s.RGBA_PVRTC_2BPPV1=Z.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG]="RGBA_PVRTC_2BPPV1",s[s.RGB_ETC1=Z.COMPRESSED_RGB_ETC1_WEBGL]="RGB_ETC1",s[s.RGBA_ASTC_4X4=Z.COMPRESSED_RGBA_ASTC_4x4_KHR]="RGBA_ASTC_4X4",s))(Be||{});function Cr(s){return s>=Be.RGB_DXT1&&s<=Be.RGBA_DXT5||s>=Be.RGB_PVRTC_4BPPV1&&s<=Be.RGBA_PVRTC_2BPPV1||s==Be.RGB_ETC1||s==Be.RGBA_ASTC_4X4}function u0(s){return Hs(s,Be.DEPTH24,Be.DEPTH24_STENCIL8,Be.DEPTH32F)}function Qa(s){return Cr(s),Hs(s,Be.R8,Be.R32F,Be.R16F)?Z.RED:Hs(s,Be.RG8,Be.RG32F,Be.RG16F)?Z.RG:Hs(s,Be.RGB8,Be.RGB32F,Be.RGB16F)?Z.RGB:Hs(s,Be.RGBA8,Be.RGBA32F,Be.RGBA16F,Be.RGB10_A2)?Z.RGBA:u0(s)?Z.DEPTH_COMPONENT:s}function Ka(s){return Cr(s),Hs(s,Be.R32F,Be.RG32F,Be.RGB32F,Be.RGBA32F)?Z.FLOAT:Hs(s,Be.R16F,Be.RG16F,Be.RGB16F,Be.RGBA16F)?Z.HALF_FLOAT:Hs(s,Be.DEPTH24,Be.DEPTH24_STENCIL8)?Z.UNSIGNED_INT:s==Be.DEPTH32F?Z.FLOAT:s==Be.RGB10_A2?Z.INT_2_10_10_10_REV:Z.UNSIGNED_BYTE}var xs=(s=>(s.RGBM="rgbm",s.YCOCGM="ycocgm",s))(xs||{}),nn=(s=>(s[s.NONE=0]="NONE",s[s.GENERATE_MIPS=1]="GENERATE_MIPS",s[s.PAUSE_LOADED_VIDEO=2]="PAUSE_LOADED_VIDEO",s[s.REPEAT_WRAPPING=4]="REPEAT_WRAPPING",s[s.DEFAULT=3]="DEFAULT",s))(nn||{}),ys=(s=>(s[s.NOT_LOADED=0]="NOT_LOADED",s[s.POSTPONED=1]="POSTPONED",s[s.IN_PROGRESS=2]="IN_PROGRESS",s[s.COMPLETED=3]="COMPLETED",s))(ys||{});class qs{constructor(){r(this,"id");r(this,"name");r(this,"url");r(this,"stdExt");r(this,"rawExt");r(this,"webFormats",new Array);r(this,"alpha");r(this,"encoding");r(this,"passphrase");r(this,"video");r(this,"importGpuCompress");r(this,"importAutoScale")}static parse(e,t=new qs){const i=new tn(e);return t.id=i.parseString("id"),t.name=i.parseString("name"),t.url=i.parseString("url"),t.stdExt=i.parseString("stdExt"),t.rawExt=i.parseString("rawExt"),t.webFormats=i.parseStrings("webFormats"),t.alpha=i.parseBoolean("alpha"),t.encoding=i.parseEnum("encoding",xs),!t.encoding&&i.parseBoolean("rgbm")==!0&&(t.encoding="rgbm"),t.passphrase=i.parseString("passphrase"),t.video=i.parseBoolean("video"),t.importGpuCompress=i.parseBoolean("importGpuCompress"),t.importAutoScale=i.parseBoolean("importAutoScale"),t}}class $a extends qs{constructor(){super(...arguments);r(this,"atlasId");r(this,"atlasScale");r(this,"atlasOffset")}static parse(t){const i=new $a,n=new tn(t);qs.parse(t,i),i.atlasId=n.parseString("atlasId");const o=n.parseNumbers("atlasScale"),a=n.parseNumbers("atlasOffset");return o.length==2&&a.length==2&&(i.atlasScale=o,i.atlasOffset=a),i}}class Za{constructor(e,t,i,n,o,a,l){r(this,"id");r(this,"name");r(this,"parentTexture");r(this,"rawExt");r(this,"stdExt");r(this,"uvOffsetScale");r(this,"isCutout",!1);r(this,"importGpuCompress",!0);r(this,"importAutoScale",!0);this.id=e,this.name=t,this.parentTexture=i,this.uvOffsetScale=new tt(n,o,a,l)}addLoadedListener(e){this.parentTexture.addLoadedListener(e)}get loaded(){return this.parentTexture&&this.parentTexture.loaded}get hasAlpha(){return this.parentTexture.hasAlpha}serialize(){return{id:this.id,name:this.name,atlasId:this.parentTexture.id,atlasOffset:[this.uvOffsetScale.x,this.uvOffsetScale.y],atlasScale:[this.uvOffsetScale.z,this.uvOffsetScale.w],rawExt:this.rawExt,stdExt:this.stdExt,webFormats:[],alpha:this.hasAlpha,importGpuCompress:this.importGpuCompress,importAutoScale:this.importAutoScale}}}class fo{constructor(e,t=0,i=0){r(this,"data");r(this,"width");r(this,"height");this.data=e,this.width=t,this.height=i}}var Bd=(s=>(s.DISPOSED="textureDisposed",s.NEEDS_UPDATE="needsUpdate",s))(Bd||{});const Cn=class Cn extends ei{constructor(t=void 0,i=Z.CLAMP_TO_EDGE,n=Z.CLAMP_TO_EDGE,o=Z.LINEAR,a=Z.LINEAR_MIPMAP_LINEAR,l=Be.RGBA8,c=Cn.DEFAULT_ANISOTROPY){super();r(this,"id");r(this,"name");r(this,"url");r(this,"rawExt");r(this,"stdExt");r(this,"webFormats",[]);r(this,"isCube",!1);r(this,"image");r(this,"width");r(this,"height");r(this,"mipmaps",new Array);r(this,"wrapS");r(this,"wrapT");r(this,"magFilter");r(this,"minFilter");r(this,"anisotropy",Cn.DEFAULT_ANISOTROPY);r(this,"isAnimated",!1);r(this,"hasAlpha",!1);r(this,"isCutout",!1);r(this,"encoding");r(this,"ycocgmThreshold",0);r(this,"format");r(this,"generateMipmaps",!0);r(this,"premultiplyAlpha",!1);r(this,"flipY",!0);r(this,"unpackAlignment",4);r(this,"releaseOnLoadedToGpu",!0);r(this,"loadingStatus",0);r(this,"importGpuCompress",!0);r(this,"importAutoScale",!0);r(this,"passphrase");r(this,"_atlasEntries");r(this,"_needsUpdate",!1);r(this,"_loadedListeners",new Array);r(this,"_isDisposed",!1);r(this,"webglTexture",null);r(this,"webglSlot",null);this.image=t,this.width=t?t.width:0,this.height=t?t.height:0,this.wrapS=i,this.wrapT=n,this.magFilter=o,this.minFilter=a,this.anisotropy=c,this.format=l}get loaded(){return this.loadingStatus==3}initFromJson(t,i){Pe(t.id&&t.name),this.hasAlpha=!!t.alpha,this.encoding=t.encoding,ro(i,4)&&(this.wrapS=Z.REPEAT,this.wrapT=Z.REPEAT),ro(i,1)&&!t.video?(this.minFilter=Z.LINEAR_MIPMAP_LINEAR,this.generateMipmaps=!0):(this.minFilter=Z.LINEAR,this.generateMipmaps=!1),this.id=t.id,this.name=t.name,this.url=t.url,this.webFormats=t.webFormats,this.passphrase=t.passphrase,this.rawExt=t.rawExt,this.stdExt=t.stdExt,this.importGpuCompress=t.importGpuCompress!==!1,this.importAutoScale=t.importAutoScale!==!1}static newDataTexture(t=void 0,i=0,n=0,o=Be.RGBA8,a=Z.CLAMP_TO_EDGE,l=Z.CLAMP_TO_EDGE,c=Z.LINEAR,h=Z.LINEAR_MIPMAP_LINEAR,d=Cn.NO_ANISOTROPY){const u=new fo(t,i,n),m=new Cn(u,a,l,c,h,o,d);return m.loadingStatus=3,m}get isPlaying(){return Pe(!1),!1}play(){Pe(!1)}pause(){Pe(!1)}rewind(){Pe(!1)}sleepAnimation(){Ke(!1)}wakeAnimation(){Ke(!1)}get needsUpdate(){return this._needsUpdate}set needsUpdate(t){this._needsUpdate=t,this._needsUpdate&&this.dispatchEvent({type:Cn.eventType.NEEDS_UPDATE})}isAtlas(){return this._atlasEntries!==void 0}enableAtlas(){console.assert(!this.isAtlas()),this._atlasEntries={}}getAtlasEntry(t,i,n,o,a,l){Pe(this._atlasEntries);let c=this._atlasEntries[i];return c||(Pe(this.loadingStatus!=3),c=new Za(t,i,this,n,o,a,l),this._atlasEntries[i]=c,c)}forEachAtlasEntry(t){Pe(this._atlasEntries);for(const i in this._atlasEntries)Object.prototype.hasOwnProperty.call(this._atlasEntries,i)&&t(this._atlasEntries[i])}clone(t){return t===void 0&&(t=new Cn),t.isCube=this.isCube,t.image=this.image,this.mipmaps&&(t.mipmaps=this.mipmaps.slice(0)),t.wrapS=this.wrapS,t.wrapT=this.wrapT,t.magFilter=this.magFilter,t.minFilter=this.minFilter,t.anisotropy=this.anisotropy,t.isCutout=this.isCutout,t.isAnimated=this.isAnimated,t.hasAlpha=this.hasAlpha,t.format=this.format,t.generateMipmaps=this.generateMipmaps,t.premultiplyAlpha=this.premultiplyAlpha,t.flipY=this.flipY,t.unpackAlignment=this.unpackAlignment,t.passphrase=this.passphrase,t}serialize(){return{id:this.id,name:this.name,stdExt:this.stdExt,webFormats:this.webFormats,alpha:this.hasAlpha,importGpuCompress:this.importGpuCompress,importAutoScale:this.importAutoScale,passphrase:this.passphrase,rawExt:this.rawExt,encoding:this.encoding}}dispose(){this._loadedListeners=[],this.dispatchEvent({type:Cn.eventType.DISPOSED}),this._isDisposed=!0}isDisposed(){return this._isDisposed}addLoadedListener(t){this.loaded?t():this._loadedListeners.push(t)}notifyLoaded(){this.loadingStatus=3;for(const t of this._loadedListeners)t();this._loadedListeners=[]}};r(Cn,"eventType",Bd),r(Cn,"DEFAULT_ANISOTROPY",4),r(Cn,"NO_ANISOTROPY",1);let dt=Cn;const pr=class pr{static createSingleColorLightmap(e,t,i=0){const n=pr._tempVector4;t===xs.RGBM?vs.rgbmEncode(e,n):t===xs.YCOCGM?vs.ycocgmEncode(e,n,i):Zn();const o=new Uint8Array(4);o[0]=Math.round(n.x*255),o[1]=Math.round(n.y*255),o[2]=Math.round(n.z*255),o[3]=Math.round(n.w*255);const a=dt.newDataTexture(o,1,1);return a.magFilter=Z.NEAREST,a.minFilter=Z.NEAREST,a.anisotropy=dt.NO_ANISOTROPY,a.hasAlpha=!0,a.encoding=t,a.ycocgmThreshold=i,a.needsUpdate=!0,a}static createSphereLightmapTexture(e,t,i,n=new be(1,1,1),o=0,a=new F(.577,.577,.577).normalize()){const l=new Uint8Array(e*t*4),c=new be(0,0,0),h=new F,d=pr._tempVector4;for(let m=0;m<t;m++){const b=(1-m/(t-1))*Math.PI;for(let x=0;x<e;x++){const E=x/(e-1)*Math.PI*2;h.x=Math.sin(b)*Math.cos(E),h.y=Math.cos(b),h.z=Math.sin(b)*Math.sin(E);const w=Math.max(0,h.dot(a));c.r=n.r*w,c.g=n.g*w,c.b=n.b*w,i===xs.RGBM?vs.rgbmEncode(c,d):i===xs.YCOCGM?vs.ycocgmEncode(c,d,o):Zn();const C=(m*e+x)*4;for(const I of[0,1,2,3])l[C+I]=Math.round(d.getComponent(I)*255)}}const u=dt.newDataTexture(l,e,t);return u.magFilter=Z.LINEAR,u.minFilter=Z.LINEAR_MIPMAP_LINEAR,u.anisotropy=dt.NO_ANISOTROPY,u.hasAlpha=!0,u.encoding=i,u.ycocgmThreshold=o,u.needsUpdate=!0,u}static createSingleColorCubemap(e){const t=pr._tempVector4;vs.rgbmEncode(e,t);const i=new Uint8Array(4);i[0]=Math.round(t.x*255),i[1]=Math.round(t.y*255),i[2]=Math.round(t.z*255),i[3]=Math.round(t.w*255);const n=new fo(i,1,1),o=dt.newDataTexture(i,1,1);return o.isCube=!0,o.image=[n,n,n,n,n,n],o.magFilter=Z.NEAREST,o.minFilter=Z.NEAREST,o.anisotropy=dt.NO_ANISOTROPY,o.hasAlpha=!0,o.needsUpdate=!0,o}};r(pr,"_tempVector4",new tt);let qo=pr;class Yo extends dt{constructor(){super();r(this,"_isPlaying",!0);r(this,"_isSleeping",!1);r(this,"_pauseRequested",!1);r(this,"_videoSrc",new pc(""));r(this,"_pausedTime",0);r(this,"_interruptible",!0);r(this,"_resizedListeners",new Array);r(this,"pauseWhenLoaded",!1);r(this,"_handlePaused",()=>{this._pauseRequested?this._pauseRequested=!1:this._isSleeping=!0,!this._isPlaying&&this._interruptible&&(Pe(this.video instanceof HTMLVideoElement),this.video.src="")});r(this,"_handleEnded",()=>{this._isPlaying=!1,this._isSleeping=!1});r(this,"_notifyResized",()=>{Pe(this.video instanceof HTMLVideoElement),this.width=this.video.videoWidth,this.height=this.video.videoHeight;for(let t=0;t<this._resizedListeners.length;t+=1)this._resizedListeners[t]()});this.generateMipmaps=!1,this.isAnimated=!0,this.releaseOnLoadedToGpu=!1}initFromJson(t,i){super.initFromJson(t,i),this.pauseWhenLoaded=ro(i,nn.PAUSE_LOADED_VIDEO)}_srcAtPausedPosition(){return this._videoSrc.addHash("t",this._pausedTime.toString()),this._videoSrc.getFullUrl()}_pauseVideo(){Pe(this.video instanceof HTMLVideoElement),this._pausedTime=this.video.currentTime,this.video.pause()}rewind(){Pe(this.video instanceof HTMLVideoElement),this._pausedTime=0,this.video.currentTime=0}get video(){return Pe(this.image instanceof HTMLVideoElement||this.image==null),this.image}set video(t){Pe(this.image===void 0,"Video already attached to texture."),Pe(t instanceof HTMLVideoElement),this.image=t,this._videoSrc=new pc(t.src);const i=this._videoSrc.getHashValue("t");this._pausedTime=i?Number.parseFloat(i):0,(isNaN(this._pausedTime)||!isFinite(this._pausedTime))&&(this._pausedTime=0),this._isPlaying=!t.paused&&!t.ended,t.addEventListener("pause",this._handlePaused),t.addEventListener("ended",this._handleEnded),t.addEventListener("resize",this._notifyResized),this._isSleeping&&this._isPlaying&&this._pauseVideo()}get volume(){return Pe(this.video instanceof HTMLVideoElement),this.video.volume}set volume(t){Pe(this.video instanceof HTMLVideoElement),this.video.volume=t}get muted(){return Pe(this.video instanceof HTMLVideoElement),this.video.muted}set muted(t){Pe(this.video instanceof HTMLVideoElement),this.video.muted=t}get loop(){return Pe(this.video instanceof HTMLVideoElement),this.video.loop}set loop(t){Pe(this.video instanceof HTMLVideoElement),this.video.loop=t}get isPlaying(){return!this._isSleeping&&this._isPlaying}play(){if(this._isPlaying)return;if(this._isSleeping){this._isPlaying=!0;return}Pe(this.video instanceof HTMLVideoElement);const t=this.video;this._interruptible&&(t.src=this._srcAtPausedPosition());const i=t.play();this._isPlaying=!0,i.catch(n=>{console.log("Can't play video texture: "+n),this._isPlaying=!1})}pause(){!this._isPlaying||!this.video||(this._isPlaying=!1,this._isSleeping||(this._pauseRequested=!0,this._pauseVideo()))}sleepAnimation(){this._isSleeping||(this._isPlaying&&this.video&&this._pauseVideo(),this._isSleeping=!0)}wakeAnimation(){this._isSleeping&&(this._isPlaying&&this.video&&(this._interruptible&&(this.video.src=this._srcAtPausedPosition()),this.video.play().catch(i=>{})),this._isSleeping=!1)}dispose(){dt.prototype.dispose.call(this),this._isPlaying&&this.pause(),Pe(this.video instanceof HTMLVideoElement);const t=this.video;this.image=void 0,this._videoSrc=new pc(""),this._isPlaying=!1,t.src="",t.removeEventListener("pause",this._handlePaused),t.removeEventListener("ended",this._handleEnded),t.removeEventListener("resize",this._notifyResized),this._resizedListeners.length=0}addResizedListener(t){this._resizedListeners.push(t)}serialize(){const t=dt.prototype.serialize.call(this);return t.video=!0,t}get needsUpdate(){return this._needsUpdate||!!(this.isPlaying&&this.video&&this.video.seeking!==!0&&this.video.readyState>=this.video.HAVE_CURRENT_DATA)}set needsUpdate(t){super.needsUpdate=t}}var Ja=(s=>(s[s.LIVE=1]="LIVE",s[s.BAKED=0]="BAKED",s[s.BASIC=-1]="BASIC",s))(Ja||{}),Ud=(s=>(s.UPDATED="liveLightmapUpdated",s.UPDATE_NEEDED="liveLightmapUpdateNeeded",s))(Ud||{});const fa=class fa extends ei{constructor(){super();r(this,"_texture");r(this,"_mode",-1)}get mode(){return this._mode}set mode(t){this._mode!==t&&(this._mode=t,this.dispatchEvent({type:fa.eventType.UPDATED}))}get texture(){return this._texture}set(t){if(t===void 0){this._texture=void 0,this.mode=0;return}const i=new Float32Array(t,0,t.byteLength/4),n=i[1],o=i[2],a=i.subarray(3);n*o,a.length/3;const l=new fo(a,n,o);this._texture?(this._texture.image=l,this._texture.needsUpdate=!0):(this._texture=new dt(l,Z.CLAMP_TO_EDGE,Z.CLAMP_TO_EDGE,Z.NEAREST,Z.NEAREST,Be.RGB32F,0),this._texture.loadingStatus=ys.COMPLETED,this._texture.generateMipmaps=!1,this._texture.flipY=!1),this.mode=1,this.dispatchEvent({type:fa.eventType.UPDATED})}};r(fa,"eventType",Ud);let Qo=fa;class el{constructor(e,t,i){r(this,"light");r(this,"position");r(this,"rotation");this.light=e,this.position=t,this.rotation=i}get index(){const e=this.light.instances.indexOf(this);return console.assert(e!==-1,"Light instance not found"),e}setPosition(e,t,i){this.position.set(e,t,i),this.light.updated()}setRotation(e,t,i){this.rotation.yaw=Nt(e),this.rotation.pitch=Nt(t),this.rotation.roll=Nt(i),this.light.updated()}setRotationDeg(e,t,i){const n=qt(e),o=qt(t);this.setRotation(n,o,qt(i))}serialize(){return{position:this.position.toArray(),rotation:this.rotation.toDegTriple()}}}var sn=(s=>(s.POINT="point",s.SPOT="spot",s.AREA="area",s.SUN="sun",s))(sn||{});const f0=["angle","color","height","photometricProfile","strength","size","type","width"];function m0(s){switch(s){case"point":case"spot":case"area":return 25;case"sun":return 8}Zn(s,"Unknown LightType")}function p0(s){switch(s){case"point":case"spot":case"area":return new be(1,.88,.799);case"sun":return new be(1,.799,.658)}Zn(s,"Unknown LightType")}function _0(s){switch(s){case"point":case"spot":case"area":return .1;case"sun":return .02}Zn(s,"Unknown LightType")}var Nd=(s=>(s.UPDATED="lightUpdated",s.INSTANCE_ADDED="instanceAdded",s.INSTANCE_REMOVED="instanceRemoved",s))(Nd||{});const Js=class Js extends ei{constructor(t){var i,n,o,a,l,c,h;super();r(this,"_name");r(this,"_enabled");r(this,"_type");r(this,"_strength");r(this,"_color");r(this,"_size");r(this,"_width");r(this,"_height");r(this,"_angle");r(this,"_photometricProfile");r(this,"instances",new Array);r(this,"doNotImport");this._name=t.name,this._type=(i=t.type)!=null?i:"spot",this._strength=(n=t.strength)!=null?n:m0(this._type),this._color=t.color!==void 0?new be().fromArray(t.color):p0(this._type),this._size=(o=t.size)!=null?o:_0(this._type),this._width=(a=t.width)!=null?a:.2,this._height=(l=t.height)!=null?l:.2,this._angle=(c=t.angle)!=null?c:140,this._photometricProfile=t.photometricProfile,this._enabled=(h=t.enabled)!=null?h:!0,t.doNotImport===!0?this.doNotImport=!0:(this.doNotImport={},t.doNotImport&&Tc(t.doNotImport,f0,this.doNotImport))}get fromEditor(){return this.doNotImport===!0}forEachLightInstance(t){for(let i=0;i<this.instances.length;i+=1)t(this.instances[i])}get name(){return this._name}set name(t){this._name=t,this.updated()}get enabled(){return this._enabled}set enabled(t){this._enabled=t,this.updated()}get type(){return this._type}set type(t){this._type=t,this.updated()}get size(){return this._size}set size(t){this._size=t,this.updated()}get width(){return this._width}set width(t){this._width=t,this.updated()}get height(){return this._height}set height(t){this._height=t,this.updated()}get angle(){return this._angle}set angle(t){this._angle=t,this.updated()}get color(){return this._color}setColorRGB(t,i,n){this._color.setRGB(t,i,n),this.updated()}get strength(){return this._strength}set strength(t){this._strength=t,this.updated()}get photometricProfile(){return this._photometricProfile}set photometricProfile(t){this._photometricProfile=t,this.updated()}setDoNotImport(t,i){this.doNotImport,this.doNotImport[t]=i,this.updated()}addCreatedInstance(t){Pe(t.light===this),this.instances.push(t),this.dispatchEvent({type:Js.eventType.INSTANCE_ADDED,instance:t})}addInstance(t,i=[0,-90,0]){const n=new F().fromArray(t),o=new ui().setFromDegTriple(i);this.addCreatedInstance(new el(this,n,o))}removeInstance(t){zi(t,this.instances),this.dispatchEvent({type:Js.eventType.INSTANCE_REMOVED,instance:t})}serialize(){return{name:this.name,type:this.type,angle:this.angle,strength:this.strength,photometricProfile:this.photometricProfile,size:this.size,width:this.width,height:this.height,color:this.color.roundChannels().toArray(),enabled:this.enabled,doNotImport:this.doNotImport,instances:this.instances.map(t=>t.serialize())}}updated(){this.dispatchEvent({type:Js.eventType.UPDATED,target:this})}static iterateLightInstances(t,i){let n=1;for(const o of t)for(const a of o.instances)i(o,a,n++)}static loadInstances(t,i){t.forEach(n=>i.addInstance(n.position,n.rotation))}static loadLights(t){const i=new Array;return t==null||t.forEach(function(n){const o=new Js(n);Js.loadInstances(n.instances,o),i.push(o)}),i}};r(Js,"eventType",Nd);let es=Js;var kd=(s=>(s.LIGHTING_UPDATED="lightingUpdated",s.LIGHT_ADDED="lightAdded",s.LIGHT_REMOVED="lightRemoved",s))(kd||{});const Jl=class Jl extends ei{constructor(t){super();r(this,"lights",new Array);r(this,"_sharedMaterialState");r(this,"_updated",()=>{this.dispatchEvent({type:Jl.eventType.LIGHTING_UPDATED})});this._sharedMaterialState=t}addLight(t){Ke(Ua(this.lights,t.name,"name")),this.lights.push(t),t.addEventListener(es.eventType.UPDATED,this._updated),t.addEventListener(es.eventType.INSTANCE_ADDED,this._updated),t.addEventListener(es.eventType.INSTANCE_REMOVED,this._updated),this._updated(),this.dispatchEvent({type:"lightAdded",light:t})}removeLight(t){zi(t,this.lights),this._updated(),this.dispatchEvent({type:"lightRemoved",light:t})}getSunLight(){let t;for(const i of this.lights)if(i.type===sn.SUN&&i.instances.length>0&&i.enabled){t=i;break}return t}get emissiveMaterialsLightEnabled(){return this._sharedMaterialState.emissiveMaterialsLightEnabled}set emissiveMaterialsLightEnabled(t){this._sharedMaterialState.emissiveMaterialsLightEnabled=t,this._updated()}serialize(){return{emissiveMaterialsLightEnabled:this.emissiveMaterialsLightEnabled,lights:this.lights.map(t=>t.serialize())}}load(t){var i,n;this.emissiveMaterialsLightEnabled=!!((i=t.emissiveMaterialsLightEnabled)==null||i);for(const o of this.lights.slice())this.removeLight(o);for(const o of es.loadLights((n=t.lights)!=null?n:[]))this.addLight(o)}};r(Jl,"eventType",kd);let mo=Jl;/*!
 * Copyright (C) 2025-present unreal engine
 */var le=(s=>(s[s.GLOBAL=0]="GLOBAL",s[s.CAMERA=1]="CAMERA",s[s.MATERIAL=2]="MATERIAL",s[s.LIGHT=3]="LIGHT",s[s.OBJECT=4]="OBJECT",s))(le||{});class tl{constructor(e){r(this,"value",0);this.value=e}}class At{constructor(e,t,i,n=!1){r(this,"array");r(this,"itemSize");r(this,"needsUpdate",!1);r(this,"length");r(this,"releaseOnLoadedToGpu",!1);r(this,"divisor");r(this,"buffer");r(this,"glType");r(this,"glTypeSize",0);this.array=e,this.itemSize=t,this.length=e.length,this.divisor=i||0,this.releaseOnLoadedToGpu=n,this.buffer=null,this.glType=null}set(e,t=0){return this.array.set(e,t),this}}class zd{constructor(){r(this,"uv0");r(this,"uv1");r(this,"uv1Mod");r(this,"t0");r(this,"t1");r(this,"t2");r(this,"sphericalNormal")}}class g0{constructor(){r(this,"index");r(this,"position");r(this,"uv0");r(this,"uv1");r(this,"uv1Mod");r(this,"t0");r(this,"t1");r(this,"t2");r(this,"normal");r(this,"sphericalNormal")}}const st=class st extends ei{constructor(){super();r(this,"id");r(this,"name","");r(this,"parent");r(this,"children",new Array);r(this,"up",st.DEFAULT_UP);r(this,"position",new F);r(this,"rotation",new ui(0,0,0,On.XYZ));r(this,"scale",new F(1,1,1));r(this,"matrix",new at);r(this,"_matrixWorld",new at);r(this,"matrixAutoUpdate",!0);r(this,"matrixWorldNeedsUpdate",!1);r(this,"_visible",!0);r(this,"castShadow",!1);r(this,"receiveShadow",!1);r(this,"frustumCulled",!0);r(this,"userData",{});this.id=st._idCount++}get matrixWorld(){return this._matrixWorld}set matrixWorld(t){this._matrixWorld=t}get visible(){return this._visible}set visible(t){this._visible!==t&&(this._visible=t)}applyMatrix(t){this.matrix.multiplyMatrices(t,this.matrix),this.matrix.decompose(this.position,st._tempQuatA,this.scale),this.rotation.setFromQuaternion(st._tempQuatA)}setRotationFromAxisAngle(t,i){st._tempQuatA.setFromAxisAngle(t,i),this.rotation.setFromQuaternion(st._tempQuatA)}setRotationFromEuler(t){this.rotation.copyFrom(t)}setRotationFromMatrix(t){this.rotation.setFromRotationMatrix(t)}setRotationFromQuaternion(t){this.rotation.setFromQuaternion(t)}rotateOnAxis(t,i){return st._tempQuatA.setFromAxisAngle(t,i),this.rotation.toQuaternion(st._tempQuatB),st._tempQuatB.multiply(st._tempQuatA),this.rotation.setFromQuaternion(st._tempQuatB),this}rotateX(t){return this.rotateOnAxis(st._tempVec3A.set(1,0,0),t)}rotateY(t){return this.rotateOnAxis(st._tempVec3A.set(0,1,0),t)}rotateZ(t){return this.rotateOnAxis(st._tempVec3A.set(0,0,1),t)}translateOnAxis(t,i){return this.rotation.toQuaternion(st._tempQuatA),st._tempVec3A.copyFrom(t),st._tempQuatA.applyToVector3(st._tempVec3A),this.position.add(st._tempVec3A.multiplyScalar(i)),this}translateX(t){return this.translateOnAxis(st._tempVec3B.set(1,0,0),t)}translateY(t){return this.translateOnAxis(st._tempVec3B.set(0,1,0),t)}translateZ(t){return this.translateOnAxis(st._tempVec3B.set(0,0,1),t)}localToWorld(t){return this.matrixWorld.affineTransformPoint3(t)}worldToLocal(t){return st._tempMatrix4.getInverse(this.matrixWorld),st._tempMatrix4.affineTransformPoint3(t)}lookAt(t){const i=st._tempMatrix4;i.lookAt(t,this.position,this.up),this.rotation.setFromRotationMatrix(i)}add(t){return Ke(t!==this),t.parent!==void 0&&t.parent.remove(t),t.parent=this,t.dispatchEvent({type:"added"}),this.children.push(t),st.onAdd(t),this}remove(t){const i=this.children.indexOf(t);i!==-1&&(t.parent=void 0,t.dispatchEvent({type:"removed"}),this.children.splice(i,1))}getObjectById(t){return this.getObjectByProperty("id",t)}getObjectByName(t){return this.getObjectByProperty("name",t)}getObjectByProperty(t,i){if(this[t]===i)return this;for(const n of this.children){const o=n.getObjectByProperty(t,i);if(o!==void 0)return o}}getWorldPosition(t=new F){return this.updateMatrixWorld(!0),this.matrixWorld.getTranslation(t)}getWorldQuaternion(t=new wi){return this.updateMatrixWorld(!0),this.matrixWorld.decompose(st._tempVec3A,t,st._tempVec3B),t}getWorldRotation(t=new ui(0,0,0,On.XYZ)){return this.getWorldQuaternion(st._tempQuatA),t.setFromQuaternion(st._tempQuatA,this.rotation.order)}getWorldScale(t=new F){return this.updateMatrixWorld(!0),this.matrixWorld.decompose(st._tempVec3A,st._tempQuatA,t),t}getWorldDirection(t=new F){return this.getWorldQuaternion(st._tempQuatA),t.set(0,0,1),st._tempQuatA.applyToVector3(t)}traverse(t){t(this);for(const i of this.children)i.traverse(t)}traverseVisible(t){if(this.visible){t(this);for(const i of this.children)i.traverseVisible(t)}}traverseAncestors(t){this.parent&&(t(this.parent),this.parent.traverseAncestors(t))}updateMatrix(){this.rotation.toQuaternion(st._tempQuatA),this.matrix.compose(this.position,st._tempQuatA,this.scale),this.matrixWorldNeedsUpdate=!0}updateMatrixWorld(t=!1){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||t)&&(this.parent===void 0?this.matrixWorld.copyFrom(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1,t=!0);for(const i of this.children)i.updateMatrixWorld(t)}clone(t=new st,i=!0){if(t.name=this.name,t.up.copyFrom(this.up),t.position.copyFrom(this.position),t.scale.copyFrom(this.scale),t.matrix.copyFrom(this.matrix),t.matrixWorld.copyFrom(this.matrixWorld),t.matrixAutoUpdate=this.matrixAutoUpdate,t.matrixWorldNeedsUpdate=this.matrixWorldNeedsUpdate,t.visible=this.visible,t.castShadow=this.castShadow,t.receiveShadow=this.receiveShadow,t.frustumCulled=this.frustumCulled,t.userData=JSON.parse(JSON.stringify(this.userData)),i)for(const n of this.children)t.add(n.clone());return t}};r(st,"DEFAULT_UP",new F(0,1,0)),r(st,"_idCount",0),r(st,"onAdd",t=>{}),r(st,"_tempQuatA",new wi),r(st,"_tempQuatB",new wi),r(st,"_tempVec3A",new F),r(st,"_tempVec3B",new F),r(st,"_tempMatrix4",new at);let ft=st;const Yn=class Yn extends ft{constructor(){super();r(this,"matrixWorldInverse",new at);r(this,"projectionMatrix",new at)}getWorldDirection(){const t=new F(0,0,-1);return this.getWorldQuaternion(Yn._tempQuat),Yn._tempQuat.applyToVector3(t)}lookAt(t){Yn._tempMatrix4A.lookAt(this.position,t,this.up),this.setRotationFromMatrix(Yn._tempMatrix4A)}clone(t=new Yn){return ft.prototype.clone.call(this,t),t.matrixWorldInverse.copyFrom(this.matrixWorldInverse),t.projectionMatrix.copyFrom(this.projectionMatrix),t}projectVector(t){const i=Yn._tempMatrix4A;return i.multiplyMatrices(this.projectionMatrix,i.getInverse(this.matrixWorld)),i.transformPoint3(t)}unprojectVector(t){const i=Yn._tempMatrix4A;return i.multiplyMatrices(this.matrixWorld,i.getInverse(this.projectionMatrix)),i.transformPoint3(t)}};r(Yn,"_tempQuat",new wi),r(Yn,"_tempMatrix4A",new at);let po=Yn;function Vd(s){const e=new F;s[0].up.set(0,-1,0),e.set(1,0,0),s[0].lookAt(e),s[1].up.set(0,-1,0),e.set(-1,0,0),s[1].lookAt(e),s[2].up.set(0,0,1),e.set(0,1,0),s[2].lookAt(e),s[3].up.set(0,0,-1),e.set(0,-1,0),s[3].lookAt(e),s[4].up.set(0,-1,0),e.set(0,0,1),s[4].lookAt(e),s[5].up.set(0,-1,0),e.set(0,0,-1),s[5].lookAt(e)}class Lc extends ft{constructor(t,i){super();r(this,"sideCameras",[]);for(let n=0;n<6;n++){const o=new As(90,1,t,i);this.add(o),this.sideCameras.push(o)}Vd(this.sideCameras)}}class v0 extends ft{constructor(t,i){super();r(this,"sideCameras",[]);for(let n=0;n<6;n++){const o=new Li(-1,1,1,-1,t,i);this.add(o),this.sideCameras.push(o)}Vd(this.sideCameras)}}class Li extends po{constructor(t,i,n,o,a=.1,l=2e3){super();r(this,"zoom",1);r(this,"left");r(this,"right");r(this,"top");r(this,"bottom");r(this,"near");r(this,"far");this.left=t,this.right=i,this.top=n,this.bottom=o,this.near=a,this.far=l,this.updateProjectionMatrix()}static createNDC(t=0,i=1){return new Li(-1,1,1,-1,t,i)}updateProjectionMatrix(){const t=(this.right-this.left)/(2*this.zoom),i=(this.top-this.bottom)/(2*this.zoom),n=(this.right+this.left)/2,o=(this.top+this.bottom)/2;this.projectionMatrix.makeOrthographic(n-t,n+t,o+i,o-i,this.near,this.far)}clone(t=new Li(0,0,0,0)){return po.prototype.clone.call(this,t),t.zoom=this.zoom,t.left=this.left,t.right=this.right,t.top=this.top,t.bottom=this.bottom,t.near=this.near,t.far=this.far,t.projectionMatrix.copyFrom(this.projectionMatrix),t}}class As extends po{constructor(t=50,i=1,n=.1,o=2e3){super();r(this,"zoom",1);r(this,"fov");r(this,"aspectRatio");r(this,"near");r(this,"far");this.fov=t,this.aspectRatio=i,this.near=n,this.far=o,this.updateProjectionMatrix()}setLens(t,i=24){this.fov=2*mn(Math.atan(i/(t*2))),this.updateProjectionMatrix()}updateProjectionMatrix(){const t=mn(2*Math.atan(Math.tan(qt(this.fov)*.5)/this.zoom));this.projectionMatrix.makePerspective(t,this.aspectRatio,this.near,this.far)}clone(t=new As){return po.prototype.clone.call(this,t),t.zoom=this.zoom,t.fov=this.fov,t.aspectRatio=this.aspectRatio,t.near=this.near,t.far=this.far,t.projectionMatrix.copyFrom(this.projectionMatrix),t}}const Rr={HABLE:1,UNREAL:2,UCHIMURA:3},Gd=Rr.UNREAL;var Hd=(s=>(s.UPDATED="cameraUpdated",s.PHYSICAL_DIMENSIONS_CHANGED="physicalDimensionsChanged",s.EXPOSURE_UPDATED="exposureUpdated",s.GAMMA_UPDATED="gammaUpdated",s.COLOR_MAP_UPDATED="colorMapUpdated",s.TONE_MAPPING_UPDATED="toneMappingUpdated",s.MOTION_BLUR_UPDATED="motionBlurUpdated",s.PROJECTION_TYPE_UPDATED="projectionTypeUpdated",s.POSITION_CHANGED="positionChanged",s.ROTATION_CHANGED="rotationChanged",s))(Hd||{});class b0{constructor(){r(this,"enabled",M.FORCE_MOTION_BLUR);r(this,"intensity",.5)}copyFrom(e){this.enabled=e.enabled,this.intensity=e.intensity}}const ec=class ec{constructor(){r(this,"defaultExposure",0);r(this,"exposure",0);r(this,"defaultGamma",1);r(this,"gamma",1);r(this,"autoExposure",!1);r(this,"autoExposureLumaTarget",ec.defaultAutoExposureLumaTarget);r(this,"colorMap");r(this,"toneMapping");r(this,"colorMapIntensity",1)}copyFrom(e){this.defaultExposure=e.defaultExposure,this.exposure=e.exposure,this.defaultGamma=e.defaultGamma,this.gamma=e.gamma,this.autoExposure=e.autoExposure,this.autoExposureLumaTarget=e.autoExposureLumaTarget,this.colorMap=e.colorMap,this.toneMapping=e.toneMapping,this.colorMapIntensity=e.colorMapIntensity}};r(ec,"defaultAutoExposureLumaTarget",.65);let Fc=ec;class x0{constructor(){r(this,"motionBlurConfig",new b0);r(this,"filmicConfig",new Fc)}copyFrom(e){this.motionBlurConfig.copyFrom(e.motionBlurConfig),this.filmicConfig.copyFrom(e.filmicConfig)}}const Ci=class Ci extends po{constructor(){super();r(this,"perspectiveCamera");r(this,"orthographicCamera");r(this,"current");r(this,"_physicalWidth",1);r(this,"_physicalHeight",1);r(this,"_defaultFov",M.CAMERA_DEFAULT_FOV);r(this,"_orthoFrustumSize",M.CAMERA_ORTHO_FRUSTUM_SIZE);r(this,"_postprocessComp",new x0);r(this,"_moveMaxSpeed",M.CAMERA_DEFAULT_MOVE_MAX_SPEED);r(this,"_autoPath",!1);r(this,"_autoClimb",!1);r(this,"_fixedHeight",M.CAMERA_FIXED_HEIGHT);r(this,"_updated");this.perspectiveCamera=new As(this._defaultFov,this.aspectRatio,M.CAMERA_WALK_NEAR,M.CAMERA_MIN_FAR),this.orthographicCamera=Li.createNDC(M.CAMERA_WALK_NEAR,M.CAMERA_MIN_FAR),this.adjustProjectionProperties(),this.add(this.perspectiveCamera),this.add(this.orthographicCamera),this.current=this.perspectiveCamera,this._updated=()=>this.dispatchEvent({type:Ci.eventType.UPDATED})}onNewPosition(t){this.dispatchEvent({type:Ci.eventType.POSITION_CHANGED,newPosition:t})}onNewRotation(t){this.dispatchEvent({type:Ci.eventType.ROTATION_CHANGED,newRotation:t})}adjustProjectionProperties(){this.perspectiveCamera.aspectRatio=this.aspectRatio,this.orthographicCamera.left=this._orthoFrustumSize*this.aspectRatio/-2,this.orthographicCamera.right=this._orthoFrustumSize*this.aspectRatio/2,this.orthographicCamera.top=this._orthoFrustumSize/2,this.orthographicCamera.bottom=this._orthoFrustumSize/-2}updateProjectionMatrix(){this.perspectiveCamera.updateProjectionMatrix(),this.orthographicCamera.updateProjectionMatrix(),this.projectionMatrix=this.current.projectionMatrix,this._updated()}isPerspective(){return this.current===this.perspectiveCamera}isOrthographic(){return this.current===this.orthographicCamera}setPerspective(){this.current=this.perspectiveCamera,this.updateProjectionMatrix(),this.dispatchEvent({type:Ci.eventType.PROJECTION_TYPE_UPDATED})}setOrthographic(){this.current=this.orthographicCamera,this.updateProjectionMatrix(),this.dispatchEvent({type:Ci.eventType.PROJECTION_TYPE_UPDATED})}createProjectionMatrix(t,i){const n=new at;return t?n.makeOrthographic(i*this.aspectRatio/-2,i*this.aspectRatio/2,i/2,i/-2,this.near,this.far):n.makePerspective(this.fov,this.aspectRatio,this.near,this.far),n}getCurrent(){return this.current}get aspectRatio(){return this._physicalWidth/this._physicalHeight}get physicalWidth(){return this._physicalWidth}get physicalHeight(){return this._physicalHeight}set physicalWidth(t){this._physicalWidth=t,this.adjustProjectionProperties(),this.dispatchEvent({type:Ci.eventType.PHYSICAL_DIMENSIONS_CHANGED}),this._updated()}set physicalHeight(t){this._physicalHeight=t,this.adjustProjectionProperties(),this.dispatchEvent({type:Ci.eventType.PHYSICAL_DIMENSIONS_CHANGED}),this._updated()}get orthoFrustumSize(){return this._orthoFrustumSize}set orthoFrustumSize(t){this._orthoFrustumSize=t,this.adjustProjectionProperties(),this._updated()}get near(){return this.current.near}set near(t){this.perspectiveCamera.near=t,this.orthographicCamera.near=t,this.updateProjectionMatrix(),this._updated()}get far(){return this.current.far}set far(t){this.perspectiveCamera.far=t,this.orthographicCamera.far=t,this.updateProjectionMatrix(),this._updated()}get fov(){return this.perspectiveCamera.fov}set fov(t){this.perspectiveCamera.fov=t,this._updated()}get left(){return Pe(this.current instanceof Li),this.current.left}get right(){return Pe(this.current instanceof Li),this.current.right}get top(){return Pe(this.current instanceof Li),this.current.top}get bottom(){return Pe(this.current instanceof Li),this.current.bottom}get defaultFov(){return this._defaultFov}set defaultFov(t){this._defaultFov=t,this.perspectiveCamera.fov=t,this._updated()}get colorMap(){var t;return(t=this._postprocessComp.filmicConfig.colorMap)!=null?t:null}set colorMap(t){this._postprocessComp.filmicConfig.colorMap=t!=null?t:void 0,t&&!t.loaded&&t.addLoadedListener(()=>this.dispatchEvent({type:Ci.eventType.COLOR_MAP_UPDATED})),this.dispatchEvent({type:Ci.eventType.COLOR_MAP_UPDATED})}get colorMapIntensity(){return this._postprocessComp.filmicConfig.colorMapIntensity}set colorMapIntensity(t){this._postprocessComp.filmicConfig.colorMapIntensity=t,this.dispatchEvent({type:Ci.eventType.COLOR_MAP_UPDATED})}get toneMapping(){return this._postprocessComp.filmicConfig.toneMapping}set toneMapping(t){const i=this._postprocessComp.filmicConfig;i.toneMapping!==t&&(i.toneMapping=t,this.dispatchEvent({type:Ci.eventType.TONE_MAPPING_UPDATED}))}get toneMappingModes(){return Rr}get motionBlurEnabled(){return this._postprocessComp.motionBlurConfig.enabled}set motionBlurEnabled(t){const i=this._postprocessComp.motionBlurConfig;i.enabled!==t&&(i.enabled=t,this.dispatchEvent({type:Ci.eventType.MOTION_BLUR_UPDATED}))}get motionBlurIntensity(){return this._postprocessComp.motionBlurConfig.intensity}set motionBlurIntensity(t){const i=this._postprocessComp.motionBlurConfig;i.intensity!==t&&(i.intensity=t,this.dispatchEvent({type:Ci.eventType.MOTION_BLUR_UPDATED}))}colorMapReady(){const t=this._postprocessComp.filmicConfig.colorMap;return!!(t&&t.loaded)}get defaultExposure(){return this._postprocessComp.filmicConfig.defaultExposure}set defaultExposure(t){const i=this._postprocessComp.filmicConfig;i.defaultExposure=t,this._updated()}get exposure(){return this._postprocessComp.filmicConfig.exposure}set exposure(t){const i=this._postprocessComp.filmicConfig;i.exposure!==t&&(i.exposure=t,this.dispatchEvent({type:Ci.eventType.EXPOSURE_UPDATED}))}get defaultGamma(){return this._postprocessComp.filmicConfig.defaultGamma}set defaultGamma(t){const i=this._postprocessComp.filmicConfig;i.defaultGamma=t,this._updated()}get gamma(){return this._postprocessComp.filmicConfig.gamma}set gamma(t){const i=this._postprocessComp.filmicConfig;i.gamma!==t&&(i.gamma=t,this.dispatchEvent({type:Ci.eventType.GAMMA_UPDATED}))}get autoExposure(){return this._postprocessComp.filmicConfig.autoExposure}set autoExposure(t){const i=this._postprocessComp.filmicConfig;i.autoExposure!==t&&(i.autoExposure=t,this.exposure=i.defaultExposure,this._updated())}get moveMaxSpeed(){return this._moveMaxSpeed}set moveMaxSpeed(t){this._moveMaxSpeed=t,this._updated()}get autoPath(){return this._autoPath}set autoPath(t){this._autoPath=t,this._updated()}get autoClimb(){return this._autoClimb}set autoClimb(t){this._autoClimb=t,this._updated()}get autoExposureLumaTarget(){return this._postprocessComp.filmicConfig.autoExposureLumaTarget}set autoExposureLumaTarget(t){const i=this._postprocessComp.filmicConfig;i.autoExposureLumaTarget=t,this._updated()}get fixedHeight(){return this._fixedHeight}set fixedHeight(t){this._fixedHeight=t,this._updated()}get postprocessComp(){return this._postprocessComp}serialize(){return{fov:this.defaultFov,autoExposure:this.autoExposure,autoExposureLumaTarget:this.autoExposureLumaTarget,exposure:this.defaultExposure,gamma:this.defaultGamma,lutTexture:this.colorMap?this.colorMap.serialize():null,lutIntensity:this.colorMapIntensity,toneMapping:this.toneMapping,autoPath:this.autoPath,autoClimb:this.autoClimb,moveMaxSpeed:this.moveMaxSpeed,fixedHeight:this._fixedHeight,motionBlurEnabled:this.motionBlurEnabled||null,motionBlurIntensity:this.motionBlurEnabled?this.motionBlurIntensity:null}}setFromJson(t){if(!t)return;const i=new tn(t);this.defaultFov=i.parseNumber("fov",this.defaultFov),this.defaultExposure=i.parseNumber("exposure",this.defaultExposure),this.defaultGamma=i.parseNumber("gamma",this.defaultGamma),this.colorMapIntensity=i.parseNumber("lutIntensity",this.colorMapIntensity);const n=i.parseNumber("toneMapping");n!==void 0&&(this.toneMapping=n),this.autoPath=i.parseBoolean("autoPath",this.autoPath),this.autoClimb=i.parseBoolean("autoClimb",this.autoClimb),this.autoExposure=M.AUTO_EXPOSURE||i.parseBoolean("autoExposure",this.autoExposure);const o=i.parseNumber("fixedHeight");o!==void 0&&(this.fixedHeight=o),this.motionBlurEnabled=i.parseBoolean("motionBlurEnabled",this.motionBlurEnabled),this.motionBlurIntensity=i.parseNumber("motionBlurIntensity",this.motionBlurIntensity),this.autoExposureLumaTarget=i.parseNumber("autoExposureLumaTarget",this.autoExposureLumaTarget),this.moveMaxSpeed=i.parseNumber("moveMaxSpeed",this.moveMaxSpeed),this.updateProjectionMatrix()}};r(Ci,"eventType",Hd);let gi=Ci;var Wd=(s=>(s.UPDATED="fogUpdated",s))(Wd||{});const tc=class tc extends ei{constructor(t={}){var i,n,o,a,l,c,h;super();r(this,"_distanceEnabled");r(this,"_distanceDensity");r(this,"_distanceStart");r(this,"_heightEnabled");r(this,"_heightDensity");r(this,"_heightStart");r(this,"_color");r(this,"_updated");this._distanceEnabled=(i=t.distanceEnabled)!=null?i:!1,this._distanceDensity=(n=t.distanceDensity)!=null?n:.01,this._distanceStart=(o=t.distanceStart)!=null?o:0,this._heightEnabled=(a=t.heightEnabled)!=null?a:!1,this._heightDensity=(l=t.heightDensity)!=null?l:.01,this._heightStart=(c=t.heightStart)!=null?c:0,this._color=new be().fromArray((h=t.color)!=null?h:[.5,.5,.5]),this._updated=()=>this.dispatchEvent({type:tc.eventType.UPDATED,target:this})}get distanceEnabled(){return this._distanceEnabled}set distanceEnabled(t){this._distanceEnabled=t,this._updated()}get distanceDensity(){return this._distanceDensity}set distanceDensity(t){this._distanceDensity=t,this._updated()}get distanceStart(){return this._distanceStart}set distanceStart(t){this._distanceStart=t,this._updated()}get heightEnabled(){return this._heightEnabled}set heightEnabled(t){this._heightEnabled=t,this._updated()}get heightDensity(){return this._heightDensity}set heightDensity(t){this._heightDensity=t,this._updated()}get heightStart(){return this._heightStart}set heightStart(t){this._heightStart=t,this._updated()}get color(){return this._color}get colorArray(){return this._color.toArray()}set colorArray(t){this._color.fromArray(t),this._updated()}enabled(){return this._distanceEnabled||this.heightEnabled}serialize(){return{distanceEnabled:this._distanceEnabled,distanceDensity:this._distanceDensity,distanceStart:this._distanceStart,heightEnabled:this._heightEnabled,heightDensity:this._heightDensity,heightStart:this._heightStart,color:this._color.toArray()}}};r(tc,"eventType",Wd);let Ir=tc;var jd=(s=>(s.UPDATED="sharedMaterialStateUpdated",s))(jd||{});class y0{constructor(e,t,i,n,o,a){this.ssaoTexture=e,this.depthTexture=t,this.normalsTexture=i,this.viewportSize=n,this.invViewportSize=o,this.debugMode=a}}class A0{constructor(e,t,i,n){this.shadowmapTexture=e,this.shadowmapSize=t,this.shadowmapMatrix=i,this.sunLightDirection=n}}class il extends ei{constructor(t,i){super();r(this,"weakReflectionShadow");r(this,"_ssaoInfo");r(this,"_shadowmapInfo");r(this,"_emissiveMaterialsLightEnabled",!0);r(this,"_liveLightmap");r(this,"_fog");r(this,"_camera");r(this,"_hdrOutput",!1);r(this,"_brdfLUT");r(this,"_lightmapEncoding");r(this,"_defaultLightmaps",new Array);r(this,"_defaultCubemap");r(this,"_updated",()=>this.dispatchEvent({type:"sharedMaterialStateUpdated"}));r(this,"builtinLightProbe");r(this,"builtinSkyMesh");this.weakReflectionShadow=M.WEAK_REFLECTION_SHADOW,this._camera=t,this._liveLightmap=i,this._liveLightmap.addEventListener(Qo.eventType.UPDATED,this._updated),t.addEventListener(gi.eventType.TONE_MAPPING_UPDATED,this._updated),t.addEventListener(gi.eventType.COLOR_MAP_UPDATED,this._updated),t.addEventListener(gi.eventType.EXPOSURE_UPDATED,this._updated),t.addEventListener(gi.eventType.GAMMA_UPDATED,this._updated)}set shadowmapInfo(t){this._shadowmapInfo=t,this._updated()}get shadowmapInfo(){return this._shadowmapInfo}set ssaoInfo(t){this._ssaoInfo=t,this._updated()}get ssaoInfo(){return this._ssaoInfo}get physicalWidth(){return this._camera.physicalWidth}get physicalHeight(){return this._camera.physicalHeight}get liveLightmap(){return this._liveLightmap}get fog(){return this._fog}set fog(t){this._fog=t,this._fog.addEventListener(Ir.eventType.UPDATED,this._updated),this._updated()}get hdrOutput(){return this._hdrOutput}set hdrOutput(t){this._hdrOutput!==t&&(this._hdrOutput=t,this._updated())}get toneMapping(){var t;return(t=this._camera.toneMapping)!=null?t:null}get colorMap(){return this._camera.colorMapReady()?this._camera.colorMap:null}get colorMapIntensity(){return this._camera.colorMapIntensity}get cameraExposure(){return this._camera.exposure}get cameraGamma(){return this._camera.gamma}set brdfLUT(t){this._brdfLUT=t,this._updated()}get brdfLUT(){return this._brdfLUT}set lightmapEncoding(t){this._lightmapEncoding=t,this._updated()}get lightmapEncoding(){return this._lightmapEncoding}get lightmapEnabled(){return!!this._lightmapEncoding}get emissiveMaterialsLightEnabled(){return this._emissiveMaterialsLightEnabled}set emissiveMaterialsLightEnabled(t){this._emissiveMaterialsLightEnabled=t,this._updated()}getDefaultLightmap(t){let i=this._defaultLightmaps.find(n=>n.ycocgmThreshold===t);return i||(this._lightmapEncoding,i=qo.createSingleColorLightmap(new be(.8,.8,.8),this._lightmapEncoding,t),this._defaultLightmaps.push(i)),i}getDefaultCubemap(){return this._defaultCubemap||(this._defaultCubemap=qo.createSingleColorCubemap(new be(0,0,0))),this._defaultCubemap}clearDefaultLightmaps(){this._defaultLightmaps.length=0}}r(il,"eventType",jd);/*!
 * Copyright (C) 2024-present unreal engine
 */var Dr=(s=>(s[s.OPAQUE=0]="OPAQUE",s[s.MASK=1]="MASK",s[s.BLEND=2]="BLEND",s))(Dr||{}),yi=(s=>(s[s.DISABLED=0]="DISABLED",s[s.NORMAL=1]="NORMAL",s[s.ADDITIVE=2]="ADDITIVE",s[s.SUBTRACTIVE=3]="SUBTRACTIVE",s[s.MULTIPLY=4]="MULTIPLY",s[s.CUSTOM=5]="CUSTOM",s))(yi||{}),Fi=(s=>(s[s.FRONT=0]="FRONT",s[s.BACK=1]="BACK",s[s.DOUBLE=2]="DOUBLE",s))(Fi||{}),Tn=(s=>(s.UNIVERSAL="universal",s.STANDARD="standard",s.WATER="water",s.GRASS="grass",s))(Tn||{});const Xd={"aabb_query_fragment.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform CameraBuffer {
mat4 projectionMatrix;
mat4 viewProjMatrix;
mat4 viewMatrix;
mat4 invViewMatrix;
vec4 cameraPosition_pad;
};
#define uCameraPosition cameraPosition_pad.xyz
#endif
in vec3 vPositionW;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform int axis;
#endif
vec4 encodeFloat(in float x) {
float xabs = abs(x);
float r = floor(xabs);
float g = fract(xabs);
return vec4(r / 255.0, g, 0.0, 0.0);
}
void main() {
vec3 viewW = uCameraPosition - vPositionW;
if (axis == 0) {
fragColor = encodeFloat(viewW.x);
} else if (axis == 1) {
fragColor = encodeFloat(viewW.y);
} else if (axis == 2) {
fragColor = encodeFloat(viewW.z);
}
}
`,"aabb_query_vertex.glsl":`vec4 transformPosition() {
return vec4(t0.x * position.x + t0.y * position.y + t0.z * position.z + t0.w,
t1.x * position.x + t1.y * position.y + t1.z * position.z + t1.w,
t2.x * position.x + t2.y * position.y + t2.z * position.z + t2.w, 1.0);
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform CameraBuffer {
mat4 projectionMatrix;
mat4 viewProjMatrix;
mat4 viewMatrix;
mat4 invViewMatrix;
vec4 cameraPosition_pad;
};
#define uCameraPosition cameraPosition_pad.xyz
#endif
mat4 getModelViewMatrix() {
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
return modelViewMatrix;
#else
#ifdef MODEL_MATRIX
return viewMatrix * modelMatrix;
#else
return viewMatrix;
#endif
#endif
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#define MODEL_MATRIX
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = projectionMatrix * modelViewMatrix * worldPos;
}
#else  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec4 worldPos) {
#ifdef MODEL_MATRIX
gl_Position = viewProjMatrix * modelMatrix * worldPos;
#else
gl_Position = viewProjMatrix * worldPos;
#endif  // MODEL_MATRIX
}
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec3 worldPos) {
setClipPositionFromWorldPos(vec4(worldPos, 1.0));
}
void setClipPositionFromViewPos(in vec4 viewPos) {
gl_Position = projectionMatrix * viewPos;
}
void setClipPositionFromViewPos(in vec3 viewPos) {
setClipPositionFromViewPos(vec4(viewPos, 1.0));
}
vec3 multiplyPositionByModelMatrix(in vec4 position) {
#ifdef MODEL_MATRIX
return (modelMatrix * position).xyz;
#else
return position.xyz;
#endif
}
vec3 multiplyPositionByModelMatrix(in vec3 position) {
return multiplyPositionByModelMatrix(vec4(position, 1.0));
}
vec3 multiplyDirectionByModelMatrix(in vec3 direction) {
#ifdef MODEL_MATRIX
return (modelMatrix * vec4(direction, 0.0)).xyz;
#else
return direction;
#endif
}
out vec3 vPositionW;
void main() {
vec4 transformedPosition = transformPosition();
vPositionW = multiplyPositionByModelMatrix(transformedPosition);
setClipPositionFromWorldPos(transformedPosition);
}
`,"accumulate_fragment.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform float weight;
#endif
uniform sampler2D inputBuffer;
in vec2 vUv0;
void main() {
vec3 inputColor = texture(inputBuffer, vUv0).rgb;
fragColor = vec4(inputColor, weight);
}
`,"accumulate_vertex.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform CameraBuffer {
mat4 projectionMatrix;
mat4 viewProjMatrix;
mat4 viewMatrix;
mat4 invViewMatrix;
vec4 cameraPosition_pad;
};
#define uCameraPosition cameraPosition_pad.xyz
#endif
mat4 getModelViewMatrix() {
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
return modelViewMatrix;
#else
#ifdef MODEL_MATRIX
return viewMatrix * modelMatrix;
#else
return viewMatrix;
#endif
#endif
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#define MODEL_MATRIX
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = projectionMatrix * modelViewMatrix * worldPos;
}
#else  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec4 worldPos) {
#ifdef MODEL_MATRIX
gl_Position = viewProjMatrix * modelMatrix * worldPos;
#else
gl_Position = viewProjMatrix * worldPos;
#endif  // MODEL_MATRIX
}
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec3 worldPos) {
setClipPositionFromWorldPos(vec4(worldPos, 1.0));
}
void setClipPositionFromViewPos(in vec4 viewPos) {
gl_Position = projectionMatrix * viewPos;
}
void setClipPositionFromViewPos(in vec3 viewPos) {
setClipPositionFromViewPos(vec4(viewPos, 1.0));
}
vec3 multiplyPositionByModelMatrix(in vec4 position) {
#ifdef MODEL_MATRIX
return (modelMatrix * position).xyz;
#else
return position.xyz;
#endif
}
vec3 multiplyPositionByModelMatrix(in vec3 position) {
return multiplyPositionByModelMatrix(vec4(position, 1.0));
}
vec3 multiplyDirectionByModelMatrix(in vec3 direction) {
#ifdef MODEL_MATRIX
return (modelMatrix * vec4(direction, 0.0)).xyz;
#else
return direction;
#endif
}
out vec2 vUv0;
void main() {
vUv0 = uv0;
setClipPositionFromWorldPos(position);
}
`,"alpha_stats_combine_fragment.glsl":`uniform sampler2D map;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec2 mapUvStep;
uniform vec2 mapUvScale;
#endif
in vec2 vUv0;
void main() {
vec2 corner = vUv0 * mapUvScale - mapUvStep;
vec2 uv = corner + 0.5 * mapUvStep;
vec4 p0 = texture(map, uv);
vec4 p1 = texture(map, uv + vec2(0.0, mapUvStep.y));
vec4 p2 = texture(map, uv + vec2(mapUvStep.x, 0.0));
vec4 p3 = texture(map, uv + vec2(mapUvStep.x, mapUvStep.y));
fragColor = vec4((p0.r + p1.r + p2.r + p3.r) / 4.0, (p0.g + p1.g + p2.g + p3.g) / 4.0, 0.0, 1.0);
return;
}
`,"alpha_stats_fragment.glsl":`uniform sampler2D map;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec2 mapUvStep;
uniform vec4 mapUvOffsetScale;
#endif
in vec2 vUv0;
void main() {
vec2 corner = vUv0 * mapUvOffsetScale.zw + mapUvOffsetScale.xy - mapUvStep;
vec2 uv = corner + 0.5 * mapUvStep;
const float bias = -1.0;
float a0 = texture(map, uv, bias).a;
float a1 = texture(map, uv + vec2(0.0, mapUvStep.y), bias).a;
float a2 = texture(map, uv + vec2(mapUvStep.x, 0.0), bias).a;
float a3 = texture(map, uv + vec2(mapUvStep.x, mapUvStep.y), bias).a;
float fully_transparent_count = step(0.0, -a0) + step(0.0, -a1) + step(0.0, -a2) + step(0.0, -a3);
float partialy_transparent_count =
step(0.0, -abs(clamp(a0, 0.05, 0.95) - a0)) + step(0.0, -abs(clamp(a1, 0.05, 0.95) - a1)) +
step(0.0, -abs(clamp(a2, 0.05, 0.95) - a2)) + step(0.0, -abs(clamp(a3, 0.05, 0.95) - a3));
fragColor = vec4(step(4.0, partialy_transparent_count), fully_transparent_count / 4.0, 0.0, 1.0);
return;
}
`,"alpha_stats_vertex.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform CameraBuffer {
mat4 projectionMatrix;
mat4 viewProjMatrix;
mat4 viewMatrix;
mat4 invViewMatrix;
vec4 cameraPosition_pad;
};
#define uCameraPosition cameraPosition_pad.xyz
#endif
mat4 getModelViewMatrix() {
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
return modelViewMatrix;
#else
#ifdef MODEL_MATRIX
return viewMatrix * modelMatrix;
#else
return viewMatrix;
#endif
#endif
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#define MODEL_MATRIX
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = projectionMatrix * modelViewMatrix * worldPos;
}
#else  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec4 worldPos) {
#ifdef MODEL_MATRIX
gl_Position = viewProjMatrix * modelMatrix * worldPos;
#else
gl_Position = viewProjMatrix * worldPos;
#endif  // MODEL_MATRIX
}
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec3 worldPos) {
setClipPositionFromWorldPos(vec4(worldPos, 1.0));
}
void setClipPositionFromViewPos(in vec4 viewPos) {
gl_Position = projectionMatrix * viewPos;
}
void setClipPositionFromViewPos(in vec3 viewPos) {
setClipPositionFromViewPos(vec4(viewPos, 1.0));
}
vec3 multiplyPositionByModelMatrix(in vec4 position) {
#ifdef MODEL_MATRIX
return (modelMatrix * position).xyz;
#else
return position.xyz;
#endif
}
vec3 multiplyPositionByModelMatrix(in vec3 position) {
return multiplyPositionByModelMatrix(vec4(position, 1.0));
}
vec3 multiplyDirectionByModelMatrix(in vec3 direction) {
#ifdef MODEL_MATRIX
return (modelMatrix * vec4(direction, 0.0)).xyz;
#else
return direction;
#endif
}
out vec2 vUv0;
void main() {
vUv0 = uv0;
setClipPositionFromWorldPos(position);
}
`,"anchor_vertex.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform CameraBuffer {
mat4 projectionMatrix;
mat4 viewProjMatrix;
mat4 viewMatrix;
mat4 invViewMatrix;
vec4 cameraPosition_pad;
};
#define uCameraPosition cameraPosition_pad.xyz
#endif
const float PI = 3.14159265358979;
const float RECIPROCAL_PI2 = 0.15915494;
float saturate(in float a) {
return clamp(a, 0.0, 1.0);
}
vec3 inverseTransformDirection(in vec3 normal, in mat4 matrix) {
return normalize((vec4(normal, 0.0) * matrix).xyz);
}
vec3 sphericalDecode(in vec2 spNormal) {
float theta = (spNormal.x / 254.0 + 0.5) * PI;
float phi = spNormal.y * (PI / 127.0);
float sinTheta = sin(theta);
return vec3(sinTheta * cos(phi), sinTheta * sin(phi), cos(theta));
}
mat4 getModelViewMatrix() {
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
return modelViewMatrix;
#else
#ifdef MODEL_MATRIX
return viewMatrix * modelMatrix;
#else
return viewMatrix;
#endif
#endif
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#define MODEL_MATRIX
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = projectionMatrix * modelViewMatrix * worldPos;
}
#else  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec4 worldPos) {
#ifdef MODEL_MATRIX
gl_Position = viewProjMatrix * modelMatrix * worldPos;
#else
gl_Position = viewProjMatrix * worldPos;
#endif  // MODEL_MATRIX
}
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec3 worldPos) {
setClipPositionFromWorldPos(vec4(worldPos, 1.0));
}
void setClipPositionFromViewPos(in vec4 viewPos) {
gl_Position = projectionMatrix * viewPos;
}
void setClipPositionFromViewPos(in vec3 viewPos) {
setClipPositionFromViewPos(vec4(viewPos, 1.0));
}
vec3 multiplyPositionByModelMatrix(in vec4 position) {
#ifdef MODEL_MATRIX
return (modelMatrix * position).xyz;
#else
return position.xyz;
#endif
}
vec3 multiplyPositionByModelMatrix(in vec3 position) {
return multiplyPositionByModelMatrix(vec4(position, 1.0));
}
vec3 multiplyDirectionByModelMatrix(in vec3 direction) {
#ifdef MODEL_MATRIX
return (modelMatrix * vec4(direction, 0.0)).xyz;
#else
return direction;
#endif
}
#if defined(USE_BASE_COLOR_TEXTURE) || defined(USE_ROUGHNESS_TEXTURE) || \\
defined(USE_METALLIC_TEXTURE) || defined(USE_BUMP_TEXTURE)
out vec2 vUv0;
#endif
#if defined(USE_BUMP_TEXTURE) || defined(USE_FOG)
out vec3 vPositionV;
#endif
#ifdef USE_BUMP_TEXTURE
out vec3 vNormalV;
#endif
#if defined(USE_ENVMAP) || defined(USE_HEADLIGHT) || defined(USE_FOG) || defined(LIVE_LIGHTMAP)
out vec3 vPositionW;
#endif
#if defined(USE_ENVMAP) || defined(USE_HEADLIGHT) || defined(LIVE_LIGHTMAP)
out vec3 vNormalW;
#endif
void main() {
#if defined(USE_BASE_COLOR_TEXTURE) || defined(USE_ROUGHNESS_TEXTURE) || \\
defined(USE_METALLIC_TEXTURE) || defined(USE_ENVMAP) || defined(USE_HEADLIGHT)
vec3 positionW = multiplyPositionByModelMatrix(position);
vec3 normal = sphericalDecode(sphericalNormal);
vec3 normalW = multiplyDirectionByModelMatrix(normal);
normalW = normalize(normalW);
#endif
mat4 modelViewMatrix = getModelViewMatrix();
#if defined(USE_BASE_COLOR_TEXTURE) || defined(USE_ROUGHNESS_TEXTURE) || \\
defined(USE_METALLIC_TEXTURE)
#ifdef MODEL_MATRIX
vec3 anchorCenterW = vec3(modelMatrix[3].xyz);
#else
vec3 anchorCenterW = vec3(0.0);
#endif
vec3 cameraUpW = vec3(modelViewMatrix[0].y, modelViewMatrix[1].y, modelViewMatrix[2].y);
vec3 forwardW = normalize(anchorCenterW - uCameraPosition);
vec3 rightW = cross(forwardW, cameraUpW);
rightW.z = 0.0;
rightW = normalize(rightW);
vec3 upW = cross(rightW, forwardW);
vUv0 = vec2(dot(normalW, rightW) * 0.5 + 0.5, dot(normalW, upW) * 0.5 + 0.5);
#endif
vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);
#if defined(USE_BUMP_TEXTURE) || defined(USE_FOG)
vPositionV = -mvPosition.xyz;
#endif
#if defined(USE_BUMP_TEXTURE)
#if defined(NON_UNIFORM_SCALE)
vNormalV = normalize(mat3(normalMatrix) * normal);
#else
vNormalV = normalize(mat3(modelViewMatrix) * normal);
#endif
#endif
#if defined(USE_ENVMAP) || defined(USE_HEADLIGHT) || defined(USE_FOG) || defined(LIVE_LIGHTMAP)
vPositionW = positionW;
#endif
#if defined(USE_ENVMAP) || defined(USE_HEADLIGHT) || defined(LIVE_LIGHTMAP)
vNormalW = normalW;
#endif
setClipPositionFromViewPos(mvPosition);
}
`,"brdf_fragment.glsl":`vec4 encodeNormalizedFloatsToRGBA8(float value1, float value2) {
float scaledValue1 = value1 * 65535.0;
float scaledValue2 = value2 * 65535.0;
vec4 encoded;
encoded.r = floor(scaledValue1 / 256.0) / 255.0;                 // High byte
encoded.g = floor(fract(scaledValue1 / 256.0) * 256.0) / 255.0;  // Low byte
encoded.b = floor(scaledValue2 / 256.0) / 255.0;                 // High byte
encoded.a = floor(fract(scaledValue2 / 256.0) * 256.0) / 255.0;  // Low byte
return encoded;
}
precision highp float;
in vec2 vUv0;
uniform float integrateBrdfNumSamples;
const float PI = 3.1415926;
float radicalInverseVDC(int n) {
float base = 2.0;
float invBase = 1.0 / base;
float result = 0.0;
float denom;
for (int i = 0; i < 32; i++) {
if (n > 0) {
denom = mod(float(n), base);
result += denom * invBase;
invBase = invBase / base;
n = int(float(n) / base);
}
}
return result;
}
vec2 hammersley(int i, int N) {
return vec2(float(i) / float(N), radicalInverseVDC(i));
}
vec3 importanceSampleGGX(vec2 xi, vec3 N, float roughness) {
float a = roughness * roughness;
float phi = 2.0 * PI * xi.x;
float cosTheta = sqrt((1.0 - xi.y) / (1.0 + (a * a - 1.0) * xi.y));
float sinTheta = sqrt(1.0 - cosTheta * cosTheta);
vec3 H = vec3(sinTheta * cos(phi), sinTheta * sin(phi), cosTheta);
vec3 upVector = abs(N.z) < 0.999 ? vec3(0.0, 0.0, 1.0) : vec3(1.0, 0.0, 0.0);
vec3 tangentX = normalize(cross(upVector, N));
vec3 tangentY = cross(N, tangentX);
return tangentX * H.x + tangentY * H.y + N * H.z;
}
float geometrySchlickGGX(float NdotV, float roughness) {
float k = (roughness * roughness) / 2.0;
float nom = NdotV;
float denom = NdotV * (1.0 - k) + k;
return nom / denom;
}
float geometrySmith(vec3 N, vec3 V, vec3 L, float roughness) {
float NdotV = max(dot(N, V), 0.0);
float NdotL = max(dot(N, L), 0.0);
float ggx2 = geometrySchlickGGX(NdotV, roughness);
float ggx1 = geometrySchlickGGX(NdotL, roughness);
return ggx1 * ggx2;
}
vec2 integrateBrdf(float roughness, float NdotV) {
vec3 V = vec3(sqrt(1.0 - NdotV * NdotV), 0.0, NdotV);
vec3 N = vec3(0.0, 0.0, 1.0);
float A = 0.0;
float B = 0.0;
int NumSamples = int(integrateBrdfNumSamples);
for (int i = 0; i < NumSamples; i++) {
vec2 xi = hammersley(i, NumSamples);
vec3 H = importanceSampleGGX(xi, N, roughness);
vec3 L = 2.0 * dot(V, H) * H - V;
float NdotL = clamp(L.z, 0.0, 1.0);
float NdotH = clamp(H.z, 0.0, 1.0);
float VdotH = clamp(dot(V, H), 0.0, 1.0);
if (NdotL > 0.0) {
float G = geometrySmith(N, V, L, roughness);
float G_Vis = G * VdotH / (NdotH * NdotV);
float Fc = pow(1.0 - VdotH, 5.0);
A += (1.0 - Fc) * G_Vis;
B += Fc * G_Vis;
}
}
return vec2(A, B) / float(NumSamples);
}
void main() {
vec2 brdf = integrateBrdf(vUv0.y, vUv0.x);
fragColor = encodeNormalizedFloatsToRGBA8(brdf.x, brdf.y);
}
`,"brdf_vertex.glsl":`out vec2 vUv0;
void main() {
vUv0 = uv0;
gl_Position = vec4(position, 1.0);
}
`,"copy_texture_fragment.glsl":`uniform sampler2D tDiffuse;
in vec2 vUv0;
void main() {
#ifdef COPY_ALPHA
fragColor = texture(tDiffuse, vUv0);
#else
fragColor = vec4(texture(tDiffuse, vUv0).rgb, 1.0);
#endif
}
`,"copy_texture_vertex.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform CameraBuffer {
mat4 projectionMatrix;
mat4 viewProjMatrix;
mat4 viewMatrix;
mat4 invViewMatrix;
vec4 cameraPosition_pad;
};
#define uCameraPosition cameraPosition_pad.xyz
#endif
mat4 getModelViewMatrix() {
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
return modelViewMatrix;
#else
#ifdef MODEL_MATRIX
return viewMatrix * modelMatrix;
#else
return viewMatrix;
#endif
#endif
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#define MODEL_MATRIX
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = projectionMatrix * modelViewMatrix * worldPos;
}
#else  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec4 worldPos) {
#ifdef MODEL_MATRIX
gl_Position = viewProjMatrix * modelMatrix * worldPos;
#else
gl_Position = viewProjMatrix * worldPos;
#endif  // MODEL_MATRIX
}
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec3 worldPos) {
setClipPositionFromWorldPos(vec4(worldPos, 1.0));
}
void setClipPositionFromViewPos(in vec4 viewPos) {
gl_Position = projectionMatrix * viewPos;
}
void setClipPositionFromViewPos(in vec3 viewPos) {
setClipPositionFromViewPos(vec4(viewPos, 1.0));
}
vec3 multiplyPositionByModelMatrix(in vec4 position) {
#ifdef MODEL_MATRIX
return (modelMatrix * position).xyz;
#else
return position.xyz;
#endif
}
vec3 multiplyPositionByModelMatrix(in vec3 position) {
return multiplyPositionByModelMatrix(vec4(position, 1.0));
}
vec3 multiplyDirectionByModelMatrix(in vec3 direction) {
#ifdef MODEL_MATRIX
return (modelMatrix * vec4(direction, 0.0)).xyz;
#else
return direction;
#endif
}
out vec2 vUv0;
void main() {
vUv0 = uv0;
setClipPositionFromWorldPos(position);
}
`,"cubemap_filter_fragment.glsl":`const float PI = 3.14159265358979;
const float RECIPROCAL_PI2 = 0.15915494;
float saturate(in float a) {
return clamp(a, 0.0, 1.0);
}
vec3 inverseTransformDirection(in vec3 normal, in mat4 matrix) {
return normalize((vec4(normal, 0.0) * matrix).xyz);
}
float rnd(vec2 uv) {
return fract(sin(dot(uv, vec2(12.9898, 78.233) * 2.0)) * 43758.5453);
}
mat3 matrixFromVector(vec3 n) {  // frisvad
float a = 1.0 / (1.0 + n.z);
float b = -n.x * n.y * a;
vec3 b1 = vec3(1.0 - n.x * n.x * a, b, -n.x);
vec3 b2 = vec3(b, 1.0 - n.y * n.y * a, -n.y);
return mat3(b1, b2, n);
}
float distributionGGX(vec3 N, vec3 H, float roughness) {
const float PI = 3.14159265359;
float a = roughness * roughness;
float a2 = a * a;
float NdotH = max(dot(N, H), 0.0);
float NdotH2 = NdotH * NdotH;
float nom = a2;
float denom = (NdotH2 * (a2 - 1.0) + 1.0);
denom = PI * denom * denom;
return nom / denom;
}
float radicalInverseVDC(int n) {
float base = 2.0;
float invBase = 1.0 / base;
float result = 0.0;
float denom;
for (int i = 0; i < 32; i++) {
if (n > 0) {
denom = mod(float(n), base);
result += denom * invBase;
invBase = invBase / base;
n = int(float(n) / base);
}
}
return result;
}
vec2 hammersley(int i, int N) {
return vec2(float(i) / float(N), radicalInverseVDC(i));
}
vec3 importanceSampleGGX(vec2 Xi, vec3 N, float roughness) {
float a = roughness * roughness;
float phi = 2.0 * PI * Xi.x;
float cosTheta = sqrt((1.0 - Xi.y) / (1.0 + (a * a - 1.0) * Xi.y));
float sinTheta = sqrt(1.0 - cosTheta * cosTheta);
vec3 H;
H.x = cos(phi) * sinTheta;
H.y = sin(phi) * sinTheta;
H.z = cosTheta;
vec3 up = abs(N.z) < 0.999 ? vec3(0.0, 0.0, 1.0) : vec3(1.0, 0.0, 0.0);
vec3 tangent = normalize(cross(up, N));
vec3 bitangent = cross(N, tangent);
vec3 sampleVec = tangent * H.x + bitangent * H.y + N * H.z;
return normalize(sampleVec);
}
vec4 cubic(in float v) {
vec4 n = vec4(1.0, 2.0, 3.0, 4.0) - v;
vec4 s = n * n * n;
float x = s.x;
float y = s.y - 4.0 * s.x;
float z = s.z - 4.0 * s.y + 6.0 * s.x;
float w = 6.0 - x - y - z;
return vec4(x, y, z, w) * (1.0 / 6.0);
}
vec3 hdrDecodeRgbm(in vec4 rgbm) {
const float rgbmScale = 2.82842712;  // sqrt(8)
float m = 1.0 - rgbm.a;
vec3 r = rgbm.rgb * (rgbmScale * m);
return r * r;
}
vec3 hdrDecodeYcocgm(in vec4 ycocgm, in vec2 threshold) {
const float ycocgmLumaRange = 16.0;
float m = ycocgm.w * (16.0 * 255.0 / 256.0) - 1.0;
float chroma_scale_factor = fract(m);
float y_factor = m - chroma_scale_factor;
chroma_scale_factor = 1.0 - chroma_scale_factor;
float factor = y_factor == ycocgmLumaRange - 2.0 ? 0.0 : 1.0;
float y = mix(ycocgm.x * threshold.x, (y_factor + ycocgm.x) * threshold.y + threshold.x, factor);
float co = (ycocgm.y - 0.5) * chroma_scale_factor;
float cg = (ycocgm.z - 0.5) * chroma_scale_factor;
return vec3(y, co, cg);
}
vec3 ycocgToRgb(in vec3 ycocg) {
float y = ycocg.x, co = ycocg.y, cg = ycocg.z;
y = y * y;
float r = saturate(y + co - cg);
float g = saturate(y + cg);
float b = saturate(y - co - cg);
return vec3(r, g, b) * 8.0;
}
/*vec3 hdrDecodeYcocgmBicubic(in sampler2D ycocgmSampler, in vec2 texSize, in vec2 invTexSize,
in vec2 threshold, in vec2 texCoords) {
vec2 texCoordsScaled = texCoords * texSize - 0.5;
vec2 fxy = fract(texCoordsScaled);
texCoordsScaled -= fxy;
vec4 xcubic = cubic(fxy.x), ycubic = cubic(fxy.y);
vec4 c = texCoordsScaled.xxyy + vec2(-0.5, +1.5).xyxy;
vec4 s = vec4(xcubic.xz + xcubic.yw, ycubic.xz + ycubic.yw);
vec4 offset = (c + vec4 (xcubic.yw, ycubic.yw) / s) * invTexSize.xxyy;
vec3 sample0 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.xz), threshold);
vec3 sample1 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.yz), threshold);
vec3 sample2 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.xw), threshold);
vec3 sample3 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.yw), threshold);
float sx = s.x / (s.x + s.y), sy = s.z / (s.z + s.w);
return mix(mix(sample3, sample2, sx), mix(sample1, sample0, sx), sy);
}*/
vec3 hdrDecodeYcocgmBilinear(in sampler2D ycocgmSampler, in vec2 texSize, in vec2 invTexSize,
in vec2 threshold, in vec2 texCoords) {
vec2 texCoordsScaled = texCoords * texSize - 0.5;
vec2 fxy = fract(texCoordsScaled);
texCoordsScaled -= fxy;
vec4 c = texCoordsScaled.xxyy + vec2(-0.5, +0.5).xyxy;
vec4 offset = c + vec4(1.0);
float sx = 1.0 - fxy.x;
float sy = 1.0 - fxy.y;
offset *= invTexSize.xxyy;
vec3 sample0 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.xz), threshold);
vec3 sample1 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.yz), threshold);
vec3 sample2 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.xw), threshold);
vec3 sample3 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.yw), threshold);
return mix(mix(sample3, sample2, sx), mix(sample1, sample0, sx), sy);
}
/*vec3 hdrDecodeRgbmBicubic(in sampler2D rgbmSampler, in vec2 texSize,
in vec2 invTexSize, in vec2 texCoords) {
vec2 texCoordsScaled = texCoords * texSize - 0.5;
vec2 fxy = fract(texCoordsScaled);
texCoordsScaled -= fxy;
vec4 xcubic = cubic(fxy.x), ycubic = cubic(fxy.y);
vec4 c = texCoordsScaled.xxyy + vec2(-0.5, +1.5).xyxy;
vec4 s = vec4(xcubic.xz + xcubic.yw, ycubic.xz + ycubic.yw);
vec4 offset = (c + vec4 (xcubic.yw, ycubic.yw) / s) * invTexSize.xxyy;
vec3 sample0 = hdrDecodeRgbm(texture(rgbmSampler, offset.xz));
vec3 sample1 = hdrDecodeRgbm(texture(rgbmSampler, offset.yz));
vec3 sample2 = hdrDecodeRgbm(texture(rgbmSampler, offset.xw));
vec3 sample3 = hdrDecodeRgbm(texture(rgbmSampler, offset.yw));
float sx = s.x / (s.x + s.y), sy = s.z / (s.z + s.w);
return mix(mix(sample3, sample2, sx), mix(sample1, sample0, sx), sy);
}*/
vec3 hdrDecodeRgbmBilinear(in sampler2D rgbmSampler, in vec2 texSize, in vec2 invTexSize,
in vec2 texCoords) {
vec2 texCoordsScaled = texCoords * texSize - 0.5;
vec2 fxy = fract(texCoordsScaled);
texCoordsScaled -= fxy;
vec4 c = texCoordsScaled.xxyy + vec2(-0.5, +0.5).xyxy;
vec4 offset = c + vec4(1.0);
float sx = 1.0 - fxy.x;
float sy = 1.0 - fxy.y;
offset *= invTexSize.xxyy;
vec3 sample0 = hdrDecodeRgbm(texture(rgbmSampler, offset.xz));
vec3 sample1 = hdrDecodeRgbm(texture(rgbmSampler, offset.yz));
vec3 sample2 = hdrDecodeRgbm(texture(rgbmSampler, offset.xw));
vec3 sample3 = hdrDecodeRgbm(texture(rgbmSampler, offset.yw));
return mix(mix(sample3, sample2, sx), mix(sample1, sample0, sx), sy);
}
vec4 hdrEncode(in vec3 rgb) {
const float rgbmScale = 2.82842712;  // sqrt(8)
vec3 r = sqrt(rgb) / rgbmScale;
float m = max(max(r.r, r.g), r.b);
m = clamp(m, 1.0 / 255.0, 1.0);
m = ceil(m * 255.0) / 255.0;
r /= m;
return vec4(r.r, r.g, r.b, (1.0 - m));
}
uniform samplerCube envMap;
uniform samplerCube envMapFiltered;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform float mipSize;
uniform float face;
uniform float roughness;
uniform int integrationNumSamples;
#endif
void main(void) {
vec2 st = 2.0 * floor(gl_FragCoord.xy) / (mipSize - 1.0) - 1.0;
vec3 vec;
if (face == 0.0) {
vec = vec3(1, -st.y, -st.x);
} else if (face == 1.0) {
vec = vec3(-1, -st.y, st.x);
} else if (face == 2.0) {
vec = vec3(st.x, 1, st.y);
} else if (face == 3.0) {
vec = vec3(st.x, -1, -st.y);
} else if (face == 4.0) {
vec = vec3(st.x, -st.y, 1);
} else {
vec = vec3(-st.x, -st.y, -1);
}
mat3 vecSpace = matrixFromVector(normalize(vec));
vec3 color = vec3(0.0);
float totalWeight = 0.0;
vec3 N = normalize(vec);
vec3 R = N;
vec3 V = R;
for (int i = 0; i < integrationNumSamples; i++) {
vec2 xi = hammersley(i, integrationNumSamples);
vec3 H = importanceSampleGGX(xi, N, roughness);
vec3 L = normalize(2.0 * dot(V, H) * H - V);
float NdotL = max(dot(N, L), 0.0);
if (NdotL > 0.0) {
color += hdrDecodeRgbm(texture(envMap, L)) * NdotL;
totalWeight += NdotL;
}
}
color /= totalWeight;
fragColor = hdrEncode(color);
}
`,"cubemap_filter_vertex.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform CameraBuffer {
mat4 projectionMatrix;
mat4 viewProjMatrix;
mat4 viewMatrix;
mat4 invViewMatrix;
vec4 cameraPosition_pad;
};
#define uCameraPosition cameraPosition_pad.xyz
#endif
mat4 getModelViewMatrix() {
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
return modelViewMatrix;
#else
#ifdef MODEL_MATRIX
return viewMatrix * modelMatrix;
#else
return viewMatrix;
#endif
#endif
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#define MODEL_MATRIX
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = projectionMatrix * modelViewMatrix * worldPos;
}
#else  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec4 worldPos) {
#ifdef MODEL_MATRIX
gl_Position = viewProjMatrix * modelMatrix * worldPos;
#else
gl_Position = viewProjMatrix * worldPos;
#endif  // MODEL_MATRIX
}
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec3 worldPos) {
setClipPositionFromWorldPos(vec4(worldPos, 1.0));
}
void setClipPositionFromViewPos(in vec4 viewPos) {
gl_Position = projectionMatrix * viewPos;
}
void setClipPositionFromViewPos(in vec3 viewPos) {
setClipPositionFromViewPos(vec4(viewPos, 1.0));
}
vec3 multiplyPositionByModelMatrix(in vec4 position) {
#ifdef MODEL_MATRIX
return (modelMatrix * position).xyz;
#else
return position.xyz;
#endif
}
vec3 multiplyPositionByModelMatrix(in vec3 position) {
return multiplyPositionByModelMatrix(vec4(position, 1.0));
}
vec3 multiplyDirectionByModelMatrix(in vec3 direction) {
#ifdef MODEL_MATRIX
return (modelMatrix * vec4(direction, 0.0)).xyz;
#else
return direction;
#endif
}
void main() {
setClipPositionFromWorldPos(position);
}
`,"cube_to_equirect_fragment.glsl":`const float PI = 3.14159265358979;
const float RECIPROCAL_PI2 = 0.15915494;
float saturate(in float a) {
return clamp(a, 0.0, 1.0);
}
vec3 inverseTransformDirection(in vec3 normal, in mat4 matrix) {
return normalize((vec4(normal, 0.0) * matrix).xyz);
}
uniform samplerCube panoramaCube;
in vec2 vUv0;
void main() {
vec2 uv = vUv0;
float longitude = uv.x * 2. * PI;
float latitude = uv.y * PI;
vec3 dir = vec3(sin(longitude) * sin(latitude), cos(longitude) * sin(latitude), cos(latitude));
fragColor = texture(panoramaCube, normalize(dir));
}
`,"cube_to_equirect_vertex.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform CameraBuffer {
mat4 projectionMatrix;
mat4 viewProjMatrix;
mat4 viewMatrix;
mat4 invViewMatrix;
vec4 cameraPosition_pad;
};
#define uCameraPosition cameraPosition_pad.xyz
#endif
mat4 getModelViewMatrix() {
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
return modelViewMatrix;
#else
#ifdef MODEL_MATRIX
return viewMatrix * modelMatrix;
#else
return viewMatrix;
#endif
#endif
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#define MODEL_MATRIX
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = projectionMatrix * modelViewMatrix * worldPos;
}
#else  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec4 worldPos) {
#ifdef MODEL_MATRIX
gl_Position = viewProjMatrix * modelMatrix * worldPos;
#else
gl_Position = viewProjMatrix * worldPos;
#endif  // MODEL_MATRIX
}
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec3 worldPos) {
setClipPositionFromWorldPos(vec4(worldPos, 1.0));
}
void setClipPositionFromViewPos(in vec4 viewPos) {
gl_Position = projectionMatrix * viewPos;
}
void setClipPositionFromViewPos(in vec3 viewPos) {
setClipPositionFromViewPos(vec4(viewPos, 1.0));
}
vec3 multiplyPositionByModelMatrix(in vec4 position) {
#ifdef MODEL_MATRIX
return (modelMatrix * position).xyz;
#else
return position.xyz;
#endif
}
vec3 multiplyPositionByModelMatrix(in vec3 position) {
return multiplyPositionByModelMatrix(vec4(position, 1.0));
}
vec3 multiplyDirectionByModelMatrix(in vec3 direction) {
#ifdef MODEL_MATRIX
return (modelMatrix * vec4(direction, 0.0)).xyz;
#else
return direction;
#endif
}
out vec2 vUv0;
void main() {
vUv0 = vec2(uv0.x, uv0.y - 1.0);
setClipPositionFromWorldPos(position);
}
`,"debug_fragment.glsl":`vec2 decodeNormalizedFloatsFromRGBA8(vec4 encoded) {
float value1 = (encoded.r * 255.0 * 256.0) + (encoded.g * 255.0);
float value2 = (encoded.b * 255.0 * 256.0) + (encoded.a * 255.0);
value1 /= 65535.0;
value2 /= 65535.0;
return vec2(value1, value2);
}
in vec2 vUv0;
void main() {
vec4 encodedUv = texture(tReprojectedUvResult, vUv0);
vec2 reprojectedUv = decodeNormalizedFloatsFromRGBA8(encodedUv);
vec4 sceneColor = texture(tColorResult, vUv0);
fragColor = mix(sceneColor, vec4(reprojectedUv, 0.0, 0.0), 0.0);
}
`,"editor_light_fragment.glsl":`float _l2g(in float x) {
return (x <= 0.0031308) ? x * 12.92 : pow(x, 1.0 / 2.4) * 1.055 - 0.055;
}
vec3 linearToGamma(in vec3 rgb) {
return vec3(_l2g(rgb.r), _l2g(rgb.g), _l2g(rgb.b));
}
vec3 hable(in vec3 rgb) {
float A = 0.15;  // shoulderStrength
float B = 0.50;  // linearStrength
float C = 0.10;  // linearAngle
float D = 0.20;  // toeStrength
float E = 0.02;  // toeNumerator
float F = 0.30;  // toeDenominator
return ((rgb * (A * rgb + C * B) + D * E) / (rgb * (A * rgb + B) + D * F)) - E / F;
}
vec3 toneMappingHable(in vec3 rgb) {
float exposure = 11.2;
float exposureBias = 2.0;
vec3 current = hable(exposureBias * rgb);
vec3 whiteScale = 1.0 / hable(vec3(exposure));
return pow(current * whiteScale, vec3(1.0 / 2.2));
}
vec3 uchimura(in vec3 x, in float P, in float a, in float m, in float l, in float c, in float b) {
float l0 = ((P - m) * l) / a;
float L0 = m - m / a;
float L1 = m + (1.0 - m) / a;
float S0 = m + l0;
float S1 = m + a * l0;
float C2 = (a * P) / (P - S1);
float CP = -C2 / P;
vec3 w0 = vec3(1.0 - smoothstep(0.0, m, x));
vec3 w2 = vec3(step(m + l0, x));
vec3 w1 = vec3(1.0 - w0 - w2);
vec3 T = vec3(m * pow(x / m, vec3(c)) + b);
vec3 S = vec3(P - (P - S1) * exp(CP * (x - S0)));
vec3 L = vec3(m + a * (x - m));
return T * w0 + L * w1 + S * w2;
}
vec3 toneMappingUchimura(in vec3 rgb) {
float P = 1.0;   // max display brightness
float a = 1.0;   // contrast
float m = 0.22;  // linear section start
float l = 0.4;   // linear section length
float c = 1.45;  // black
float b = 0.0;   // pedestal
return pow(uchimura(rgb, P, a, m, l, c, b), vec3(1.0 / 2.2));
}
vec3 toneMappingUnreal(in vec3 rgb) {
return rgb / (rgb + 0.187) * 1.035;
}
vec3 linearToGammaToneMapped(in vec3 rgb) {
#ifdef TONE_MAPPING_UNREAL
return toneMappingUnreal(rgb);
#endif
#ifdef TONE_MAPPING_HABLE
return toneMappingHable(rgb);
#endif
#ifdef TONE_MAPPING_UCHIMURA
return toneMappingUchimura(rgb);
#endif
return toneMappingUnreal(rgb);
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec3 uColor;
uniform vec3 uHighlight;
uniform float highlightMix;
#endif
in vec3 vNormal;
in vec3 vViewPosition;
void main() {
vec3 lVector = normalize(vViewPosition.xyz);
float pointDiffuse = max(dot(normalize(vNormal), lVector), 0.0);
vec3 lightColor = uColor * pointDiffuse;
lightColor = mix(lightColor, uHighlight, highlightMix);
fragColor = vec4(min(linearToGamma(lightColor), 1.0), 1.0);
}
`,"editor_light_vertex.glsl":`const float PI = 3.14159265358979;
const float RECIPROCAL_PI2 = 0.15915494;
float saturate(in float a) {
return clamp(a, 0.0, 1.0);
}
vec3 inverseTransformDirection(in vec3 normal, in mat4 matrix) {
return normalize((vec4(normal, 0.0) * matrix).xyz);
}
vec3 sphericalDecode(in vec2 spNormal) {
float theta = (spNormal.x / 254.0 + 0.5) * PI;
float phi = spNormal.y * (PI / 127.0);
float sinTheta = sin(theta);
return vec3(sinTheta * cos(phi), sinTheta * sin(phi), cos(theta));
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform CameraBuffer {
mat4 projectionMatrix;
mat4 viewProjMatrix;
mat4 viewMatrix;
mat4 invViewMatrix;
vec4 cameraPosition_pad;
};
#define uCameraPosition cameraPosition_pad.xyz
#endif
mat4 getModelViewMatrix() {
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
return modelViewMatrix;
#else
#ifdef MODEL_MATRIX
return viewMatrix * modelMatrix;
#else
return viewMatrix;
#endif
#endif
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#define MODEL_MATRIX
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = projectionMatrix * modelViewMatrix * worldPos;
}
#else  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec4 worldPos) {
#ifdef MODEL_MATRIX
gl_Position = viewProjMatrix * modelMatrix * worldPos;
#else
gl_Position = viewProjMatrix * worldPos;
#endif  // MODEL_MATRIX
}
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec3 worldPos) {
setClipPositionFromWorldPos(vec4(worldPos, 1.0));
}
void setClipPositionFromViewPos(in vec4 viewPos) {
gl_Position = projectionMatrix * viewPos;
}
void setClipPositionFromViewPos(in vec3 viewPos) {
setClipPositionFromViewPos(vec4(viewPos, 1.0));
}
vec3 multiplyPositionByModelMatrix(in vec4 position) {
#ifdef MODEL_MATRIX
return (modelMatrix * position).xyz;
#else
return position.xyz;
#endif
}
vec3 multiplyPositionByModelMatrix(in vec3 position) {
return multiplyPositionByModelMatrix(vec4(position, 1.0));
}
vec3 multiplyDirectionByModelMatrix(in vec3 direction) {
#ifdef MODEL_MATRIX
return (modelMatrix * vec4(direction, 0.0)).xyz;
#else
return direction;
#endif
}
out vec3 vNormal;
out vec3 vViewPosition;
void main() {
mat4 modelViewMatrix = getModelViewMatrix();
vec3 normal = sphericalDecode(sphericalNormal);
#if defined(NON_UNIFORM_SCALE)
vNormal = normalize(mat3(normalMatrix) * normal);
#else
vNormal = normalize(mat3(modelViewMatrix) * normal);
#endif
vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);
vViewPosition = -mvPosition.xyz;
setClipPositionFromViewPos(mvPosition);
}
`,"equirect_sky_fragment.glsl":`const float PI = 3.14159265358979;
const float RECIPROCAL_PI2 = 0.15915494;
float saturate(in float a) {
return clamp(a, 0.0, 1.0);
}
vec3 inverseTransformDirection(in vec3 normal, in mat4 matrix) {
return normalize((vec4(normal, 0.0) * matrix).xyz);
}
float _g2l(in float x) {
return (x <= 0.04045) ? x / 12.92 : pow((x + 0.055) / 1.055, 2.4);
}
vec3 gammaToLinear(in vec3 rgb) {
return vec3(_g2l(rgb.r), _g2l(rgb.g), _g2l(rgb.b));
}
float _l2g(in float x) {
return (x <= 0.0031308) ? x * 12.92 : pow(x, 1.0 / 2.4) * 1.055 - 0.055;
}
vec3 linearToGamma(in vec3 rgb) {
return vec3(_l2g(rgb.r), _l2g(rgb.g), _l2g(rgb.b));
}
vec3 hable(in vec3 rgb) {
float A = 0.15;  // shoulderStrength
float B = 0.50;  // linearStrength
float C = 0.10;  // linearAngle
float D = 0.20;  // toeStrength
float E = 0.02;  // toeNumerator
float F = 0.30;  // toeDenominator
return ((rgb * (A * rgb + C * B) + D * E) / (rgb * (A * rgb + B) + D * F)) - E / F;
}
vec3 toneMappingHable(in vec3 rgb) {
float exposure = 11.2;
float exposureBias = 2.0;
vec3 current = hable(exposureBias * rgb);
vec3 whiteScale = 1.0 / hable(vec3(exposure));
return pow(current * whiteScale, vec3(1.0 / 2.2));
}
vec3 uchimura(in vec3 x, in float P, in float a, in float m, in float l, in float c, in float b) {
float l0 = ((P - m) * l) / a;
float L0 = m - m / a;
float L1 = m + (1.0 - m) / a;
float S0 = m + l0;
float S1 = m + a * l0;
float C2 = (a * P) / (P - S1);
float CP = -C2 / P;
vec3 w0 = vec3(1.0 - smoothstep(0.0, m, x));
vec3 w2 = vec3(step(m + l0, x));
vec3 w1 = vec3(1.0 - w0 - w2);
vec3 T = vec3(m * pow(x / m, vec3(c)) + b);
vec3 S = vec3(P - (P - S1) * exp(CP * (x - S0)));
vec3 L = vec3(m + a * (x - m));
return T * w0 + L * w1 + S * w2;
}
vec3 toneMappingUchimura(in vec3 rgb) {
float P = 1.0;   // max display brightness
float a = 1.0;   // contrast
float m = 0.22;  // linear section start
float l = 0.4;   // linear section length
float c = 1.45;  // black
float b = 0.0;   // pedestal
return pow(uchimura(rgb, P, a, m, l, c, b), vec3(1.0 / 2.2));
}
vec3 toneMappingUnreal(in vec3 rgb) {
return rgb / (rgb + 0.187) * 1.035;
}
vec3 linearToGammaToneMapped(in vec3 rgb) {
#ifdef TONE_MAPPING_UNREAL
return toneMappingUnreal(rgb);
#endif
#ifdef TONE_MAPPING_HABLE
return toneMappingHable(rgb);
#endif
#ifdef TONE_MAPPING_UCHIMURA
return toneMappingUchimura(rgb);
#endif
return toneMappingUnreal(rgb);
}
vec4 cubic(in float v) {
vec4 n = vec4(1.0, 2.0, 3.0, 4.0) - v;
vec4 s = n * n * n;
float x = s.x;
float y = s.y - 4.0 * s.x;
float z = s.z - 4.0 * s.y + 6.0 * s.x;
float w = 6.0 - x - y - z;
return vec4(x, y, z, w) * (1.0 / 6.0);
}
vec3 hdrDecodeRgbm(in vec4 rgbm) {
const float rgbmScale = 2.82842712;  // sqrt(8)
float m = 1.0 - rgbm.a;
vec3 r = rgbm.rgb * (rgbmScale * m);
return r * r;
}
vec3 hdrDecodeYcocgm(in vec4 ycocgm, in vec2 threshold) {
const float ycocgmLumaRange = 16.0;
float m = ycocgm.w * (16.0 * 255.0 / 256.0) - 1.0;
float chroma_scale_factor = fract(m);
float y_factor = m - chroma_scale_factor;
chroma_scale_factor = 1.0 - chroma_scale_factor;
float factor = y_factor == ycocgmLumaRange - 2.0 ? 0.0 : 1.0;
float y = mix(ycocgm.x * threshold.x, (y_factor + ycocgm.x) * threshold.y + threshold.x, factor);
float co = (ycocgm.y - 0.5) * chroma_scale_factor;
float cg = (ycocgm.z - 0.5) * chroma_scale_factor;
return vec3(y, co, cg);
}
vec3 ycocgToRgb(in vec3 ycocg) {
float y = ycocg.x, co = ycocg.y, cg = ycocg.z;
y = y * y;
float r = saturate(y + co - cg);
float g = saturate(y + cg);
float b = saturate(y - co - cg);
return vec3(r, g, b) * 8.0;
}
/*vec3 hdrDecodeYcocgmBicubic(in sampler2D ycocgmSampler, in vec2 texSize, in vec2 invTexSize,
in vec2 threshold, in vec2 texCoords) {
vec2 texCoordsScaled = texCoords * texSize - 0.5;
vec2 fxy = fract(texCoordsScaled);
texCoordsScaled -= fxy;
vec4 xcubic = cubic(fxy.x), ycubic = cubic(fxy.y);
vec4 c = texCoordsScaled.xxyy + vec2(-0.5, +1.5).xyxy;
vec4 s = vec4(xcubic.xz + xcubic.yw, ycubic.xz + ycubic.yw);
vec4 offset = (c + vec4 (xcubic.yw, ycubic.yw) / s) * invTexSize.xxyy;
vec3 sample0 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.xz), threshold);
vec3 sample1 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.yz), threshold);
vec3 sample2 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.xw), threshold);
vec3 sample3 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.yw), threshold);
float sx = s.x / (s.x + s.y), sy = s.z / (s.z + s.w);
return mix(mix(sample3, sample2, sx), mix(sample1, sample0, sx), sy);
}*/
vec3 hdrDecodeYcocgmBilinear(in sampler2D ycocgmSampler, in vec2 texSize, in vec2 invTexSize,
in vec2 threshold, in vec2 texCoords) {
vec2 texCoordsScaled = texCoords * texSize - 0.5;
vec2 fxy = fract(texCoordsScaled);
texCoordsScaled -= fxy;
vec4 c = texCoordsScaled.xxyy + vec2(-0.5, +0.5).xyxy;
vec4 offset = c + vec4(1.0);
float sx = 1.0 - fxy.x;
float sy = 1.0 - fxy.y;
offset *= invTexSize.xxyy;
vec3 sample0 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.xz), threshold);
vec3 sample1 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.yz), threshold);
vec3 sample2 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.xw), threshold);
vec3 sample3 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.yw), threshold);
return mix(mix(sample3, sample2, sx), mix(sample1, sample0, sx), sy);
}
/*vec3 hdrDecodeRgbmBicubic(in sampler2D rgbmSampler, in vec2 texSize,
in vec2 invTexSize, in vec2 texCoords) {
vec2 texCoordsScaled = texCoords * texSize - 0.5;
vec2 fxy = fract(texCoordsScaled);
texCoordsScaled -= fxy;
vec4 xcubic = cubic(fxy.x), ycubic = cubic(fxy.y);
vec4 c = texCoordsScaled.xxyy + vec2(-0.5, +1.5).xyxy;
vec4 s = vec4(xcubic.xz + xcubic.yw, ycubic.xz + ycubic.yw);
vec4 offset = (c + vec4 (xcubic.yw, ycubic.yw) / s) * invTexSize.xxyy;
vec3 sample0 = hdrDecodeRgbm(texture(rgbmSampler, offset.xz));
vec3 sample1 = hdrDecodeRgbm(texture(rgbmSampler, offset.yz));
vec3 sample2 = hdrDecodeRgbm(texture(rgbmSampler, offset.xw));
vec3 sample3 = hdrDecodeRgbm(texture(rgbmSampler, offset.yw));
float sx = s.x / (s.x + s.y), sy = s.z / (s.z + s.w);
return mix(mix(sample3, sample2, sx), mix(sample1, sample0, sx), sy);
}*/
vec3 hdrDecodeRgbmBilinear(in sampler2D rgbmSampler, in vec2 texSize, in vec2 invTexSize,
in vec2 texCoords) {
vec2 texCoordsScaled = texCoords * texSize - 0.5;
vec2 fxy = fract(texCoordsScaled);
texCoordsScaled -= fxy;
vec4 c = texCoordsScaled.xxyy + vec2(-0.5, +0.5).xyxy;
vec4 offset = c + vec4(1.0);
float sx = 1.0 - fxy.x;
float sy = 1.0 - fxy.y;
offset *= invTexSize.xxyy;
vec3 sample0 = hdrDecodeRgbm(texture(rgbmSampler, offset.xz));
vec3 sample1 = hdrDecodeRgbm(texture(rgbmSampler, offset.yz));
vec3 sample2 = hdrDecodeRgbm(texture(rgbmSampler, offset.xw));
vec3 sample3 = hdrDecodeRgbm(texture(rgbmSampler, offset.yw));
return mix(mix(sample3, sample2, sx), mix(sample1, sample0, sx), sy);
}
vec4 hdrEncode(in vec3 rgb) {
const float rgbmScale = 2.82842712;  // sqrt(8)
vec3 r = sqrt(rgb) / rgbmScale;
float m = max(max(r.r, r.g), r.b);
m = clamp(m, 1.0 / 255.0, 1.0);
m = ceil(m * 255.0) / 255.0;
r /= m;
return vec4(r.r, r.g, r.b, (1.0 - m));
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform GlobalBuffer {
mat4 unjitteredInvProjMatrix;
mat4 unjitteredPrevViewProjMatrix;
vec4 viewSpaceFrustumRayDirections[4];
vec4 viewSpaceFrustumRayOrigins[4];
vec2 zNear_zFar;
vec4 fogDistStart_DistDensity_HeightStart_HeightDensity;
vec4 fogColor;
vec4 camera_exposure_gamma;
float colorMapIntensity;
float time;
vec2 texelSize;
vec2 renderTargetSize;
float deltaTime;
float velocityFactor;
vec2 jitterOffset;
float temporalAaHistoryWeight;
bool allTaaSamplesAccumulated;
vec2 neighbourhoodTexelOffsets[8];
float accumulatedStaticTaaSamples;
vec4 screenResolution;
float lightmapMode;
float dynamicTaaHistoryMultiplier;
};
#define uFogColor fogColor.xyz
#endif
#ifdef USE_FOG
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec4 fogDistStart_DistDensity_HeightStart_HeightDensity;
uniform vec3 uFogColor;
#endif
const float LOG2 = 1.442695;
vec3 addFog(in vec3 colorIn, in float distance, in vec3 positionW) {
float distanceValue = max(0.0, distance - fogDistStart_DistDensity_HeightStart_HeightDensity.x);
float distanceDensity = fogDistStart_DistDensity_HeightStart_HeightDensity.y;
float distanceFogExp =
1.0 - exp2(-distanceDensity * distanceDensity * distanceValue * distanceValue * LOG2);
float heightValue = max(0.0, -positionW.z + fogDistStart_DistDensity_HeightStart_HeightDensity.z);
float heightDensity = fogDistStart_DistDensity_HeightStart_HeightDensity.w;
float heightFogExp =
1.0 - exp2(-heightDensity * heightDensity * heightValue * heightValue * LOG2);
float fogAmount = min(1.0, distanceFogExp + heightFogExp);
return mix(colorIn, uFogColor.xyz, fogAmount);
}
#endif
uniform sampler2D map;
in vec2 vUv0;
#ifdef USE_FOG
in vec3 vPositionW;
in vec3 vPositionV;
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec4 camera_exposure_gamma;
#endif
#ifdef USE_COLORMAP
vec3 colormap(in sampler2D lut, in vec3 color, in float intensity) {
const float resolution = 16.0;
const float maxValueIndex = resolution - 1.0;
const float sliceWidth = 1.0 / resolution;
const float slicePixelWidth = sliceWidth / resolution;
const float sliceMarginWidth = 0.5 * slicePixelWidth;
const float sliceInnerWidth = sliceWidth - slicePixelWidth;
const float slicePixelHeight = 1.0 / resolution;
const float sliceMarginHeight = 0.5 * slicePixelHeight;
const float sliceInnerHeight = 1.0 - slicePixelHeight;
float bSlice0 = min(floor(color.b * maxValueIndex), maxValueIndex - 1.0);
float bSlice1 = bSlice0 + 1.0;
float bOffset = color.b * maxValueIndex - bSlice0;
float rSlicePos = sliceMarginWidth + color.r * sliceInnerWidth;
float gSlicePos = sliceMarginHeight + color.g * sliceInnerHeight;
float rPos0 = rSlicePos + (bSlice0 * sliceWidth);
float rPos1 = rSlicePos + (bSlice1 * sliceWidth);
vec3 color0 = texture(lut, vec2(rPos0, gSlicePos)).rgb;
vec3 color1 = texture(lut, vec2(rPos1, gSlicePos)).rgb;
return mix(color, mix(color0, color1, bOffset), intensity);
}
uniform sampler2D colorMap;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform float colorMapIntensity;
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
#endif    // USE_COLORMAP
void main() {
#ifdef USE_RGBM_MAP
vec4 colorRgbm = texture(map, vUv0);
vec3 colorLinear = hdrDecodeRgbm(colorRgbm);
#else
vec3 colorLinear = gammaToLinear(texture(map, vUv0).xyz);
#endif
#ifdef USE_FOG
float distance = length(vPositionV);
colorLinear = addFog(colorLinear, distance, vPositionW);
#endif
#ifdef HDR_OUTPUT
#ifdef USE_RGBM_MAP
fragColor = colorRgbm;
#else
fragColor = hdrEncode(10.0 * colorLinear);
#endif
#else
vec3 colorExposed = pow(camera_exposure_gamma.x * colorLinear, vec3(camera_exposure_gamma.y));
vec3 colorGamma = linearToGammaToneMapped(colorExposed);
#ifdef USE_COLORMAP
fragColor = vec4(colormap(colorMap, colorGamma, colorMapIntensity), 1.0);
#else
fragColor = vec4(colorGamma, 1.0);
#endif
#endif
}
`,"equirect_sky_vertex.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform CameraBuffer {
mat4 projectionMatrix;
mat4 viewProjMatrix;
mat4 viewMatrix;
mat4 invViewMatrix;
vec4 cameraPosition_pad;
};
#define uCameraPosition cameraPosition_pad.xyz
#endif
mat4 getModelViewMatrix() {
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
return modelViewMatrix;
#else
#ifdef MODEL_MATRIX
return viewMatrix * modelMatrix;
#else
return viewMatrix;
#endif
#endif
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#define MODEL_MATRIX
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = projectionMatrix * modelViewMatrix * worldPos;
}
#else  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec4 worldPos) {
#ifdef MODEL_MATRIX
gl_Position = viewProjMatrix * modelMatrix * worldPos;
#else
gl_Position = viewProjMatrix * worldPos;
#endif  // MODEL_MATRIX
}
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec3 worldPos) {
setClipPositionFromWorldPos(vec4(worldPos, 1.0));
}
void setClipPositionFromViewPos(in vec4 viewPos) {
gl_Position = projectionMatrix * viewPos;
}
void setClipPositionFromViewPos(in vec3 viewPos) {
setClipPositionFromViewPos(vec4(viewPos, 1.0));
}
vec3 multiplyPositionByModelMatrix(in vec4 position) {
#ifdef MODEL_MATRIX
return (modelMatrix * position).xyz;
#else
return position.xyz;
#endif
}
vec3 multiplyPositionByModelMatrix(in vec3 position) {
return multiplyPositionByModelMatrix(vec4(position, 1.0));
}
vec3 multiplyDirectionByModelMatrix(in vec3 direction) {
#ifdef MODEL_MATRIX
return (modelMatrix * vec4(direction, 0.0)).xyz;
#else
return direction;
#endif
}
out vec2 vUv0;
#ifdef USE_FOG
out vec3 vPositionW;
out vec3 vPositionV;
#endif
void main() {
vUv0 = uv0;
vec3 vPos = (getModelViewMatrix() * vec4(position, 1.0)).xyz;
#ifdef USE_FOG
vPositionW = multiplyPositionByModelMatrix(position);
vPositionV = -vPos;
#endif
setClipPositionFromViewPos(vPos);
}
`,"fxaa_fragment.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform GlobalBuffer {
mat4 unjitteredInvProjMatrix;
mat4 unjitteredPrevViewProjMatrix;
vec4 viewSpaceFrustumRayDirections[4];
vec4 viewSpaceFrustumRayOrigins[4];
vec2 zNear_zFar;
vec4 fogDistStart_DistDensity_HeightStart_HeightDensity;
vec4 fogColor;
vec4 camera_exposure_gamma;
float colorMapIntensity;
float time;
vec2 texelSize;
vec2 renderTargetSize;
float deltaTime;
float velocityFactor;
vec2 jitterOffset;
float temporalAaHistoryWeight;
bool allTaaSamplesAccumulated;
vec2 neighbourhoodTexelOffsets[8];
float accumulatedStaticTaaSamples;
vec4 screenResolution;
float lightmapMode;
float dynamicTaaHistoryMultiplier;
};
#define uFogColor fogColor.xyz
#endif
uniform sampler2D tDiffuse;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec2 texelSize;
#endif
#define FXAA_REDUCE_MIN (1.0 / 128.0)
#define FXAA_REDUCE_MUL (1.0 / 8.0)
#define FXAA_SPAN_MAX 8.0
void main() {
vec3 rgbNW = texture(tDiffuse, (gl_FragCoord.xy + vec2(-1.0, -1.0)) * texelSize).xyz;
vec3 rgbNE = texture(tDiffuse, (gl_FragCoord.xy + vec2(1.0, -1.0)) * texelSize).xyz;
vec3 rgbSW = texture(tDiffuse, (gl_FragCoord.xy + vec2(-1.0, 1.0)) * texelSize).xyz;
vec3 rgbSE = texture(tDiffuse, (gl_FragCoord.xy + vec2(1.0, 1.0)) * texelSize).xyz;
vec4 rgbaM = texture(tDiffuse, gl_FragCoord.xy * texelSize);
vec3 rgbM = rgbaM.xyz;
vec3 luma = vec3(0.299, 0.587, 0.114);
float lumaNW = dot(rgbNW, luma);
float lumaNE = dot(rgbNE, luma);
float lumaSW = dot(rgbSW, luma);
float lumaSE = dot(rgbSE, luma);
float lumaM = dot(rgbM, luma);
float lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));
float lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));
vec2 dir;
dir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));
dir.y = ((lumaNW + lumaSW) - (lumaNE + lumaSE));
float dirReduce =
max((lumaNW + lumaNE + lumaSW + lumaSE) * (0.25 * FXAA_REDUCE_MUL), FXAA_REDUCE_MIN);
float rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);
dir = min(vec2(FXAA_SPAN_MAX, FXAA_SPAN_MAX),
max(vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX), dir * rcpDirMin)) *
texelSize;
vec4 rgbA =
(1.0 / 2.0) * (texture(tDiffuse, gl_FragCoord.xy * texelSize + dir * (1.0 / 3.0 - 0.5)) +
texture(tDiffuse, gl_FragCoord.xy * texelSize + dir * (2.0 / 3.0 - 0.5)));
vec4 rgbB =
rgbA * (1.0 / 2.0) +
(1.0 / 4.0) * (texture(tDiffuse, gl_FragCoord.xy * texelSize + dir * (0.0 / 3.0 - 0.5)) +
texture(tDiffuse, gl_FragCoord.xy * texelSize + dir * (3.0 / 3.0 - 0.5)));
float lumaB = dot(rgbB, vec4(luma, 0.0));
if ((lumaB < lumaMin) || (lumaB > lumaMax)) {
fragColor = rgbA;
} else {
fragColor = rgbB;
}
}
`,"fxaa_vertex.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform CameraBuffer {
mat4 projectionMatrix;
mat4 viewProjMatrix;
mat4 viewMatrix;
mat4 invViewMatrix;
vec4 cameraPosition_pad;
};
#define uCameraPosition cameraPosition_pad.xyz
#endif
void main() {
gl_Position = vec4(position, 1.0);
}
`,"gaze_pointer_fragment.glsl":`const float PI = 3.14159265358979;
const float RECIPROCAL_PI2 = 0.15915494;
float saturate(in float a) {
return clamp(a, 0.0, 1.0);
}
vec3 inverseTransformDirection(in vec3 normal, in mat4 matrix) {
return normalize((vec4(normal, 0.0) * matrix).xyz);
}
const float pointRadius = 0.01;
const float pointBorder = 0.005;
const float timerRadius = 0.04;
const float timerBorder = 0.02;
const vec3 timerColor = vec3(0.298, 0.619, 0.851);
in vec2 coords;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform float circleSpan;
#endif
void main() {
float dist = sqrt(dot(coords, coords));
if (dist < pointRadius) {
float a = 1.0 - smoothstep(pointRadius - pointBorder, pointRadius, dist);
fragColor = vec4(1.0, 1.0, 1.0, a);
} else if (-atan(coords.x, -coords.y) < circleSpan) {
float a2 = smoothstep(timerRadius - timerBorder, timerRadius, dist) -
smoothstep(timerRadius, timerRadius + timerBorder, dist);
fragColor = vec4(timerColor, a2);
} else {
discard;
}
}
`,"gaze_pointer_vertex.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform CameraBuffer {
mat4 projectionMatrix;
mat4 viewProjMatrix;
mat4 viewMatrix;
mat4 invViewMatrix;
vec4 cameraPosition_pad;
};
#define uCameraPosition cameraPosition_pad.xyz
#endif
mat4 getModelViewMatrix() {
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
return modelViewMatrix;
#else
#ifdef MODEL_MATRIX
return viewMatrix * modelMatrix;
#else
return viewMatrix;
#endif
#endif
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#define MODEL_MATRIX
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = projectionMatrix * modelViewMatrix * worldPos;
}
#else  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec4 worldPos) {
#ifdef MODEL_MATRIX
gl_Position = viewProjMatrix * modelMatrix * worldPos;
#else
gl_Position = viewProjMatrix * worldPos;
#endif  // MODEL_MATRIX
}
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec3 worldPos) {
setClipPositionFromWorldPos(vec4(worldPos, 1.0));
}
void setClipPositionFromViewPos(in vec4 viewPos) {
gl_Position = projectionMatrix * viewPos;
}
void setClipPositionFromViewPos(in vec3 viewPos) {
setClipPositionFromViewPos(vec4(viewPos, 1.0));
}
vec3 multiplyPositionByModelMatrix(in vec4 position) {
#ifdef MODEL_MATRIX
return (modelMatrix * position).xyz;
#else
return position.xyz;
#endif
}
vec3 multiplyPositionByModelMatrix(in vec3 position) {
return multiplyPositionByModelMatrix(vec4(position, 1.0));
}
vec3 multiplyDirectionByModelMatrix(in vec3 direction) {
#ifdef MODEL_MATRIX
return (modelMatrix * vec4(direction, 0.0)).xyz;
#else
return direction;
#endif
}
out vec2 coords;
void main() {
coords = vec2(position.x, position.y);
setClipPositionFromWorldPos(position);
gl_Position.z = -0.1;
}
`,"grass_fragment.glsl":`#ifdef USE_HEIGHT_TEXTURE
uniform sampler2D heightTexture;
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform float currentStep;
uniform float renderSteps;
#endif
vec3 addSpecularHook(in vec3 baseColor, in vec3 totalIntensity, inout float opacity) {
return baseColor * totalIntensity;
}
float easeOutCubic(in float x) {
return 1.0 - pow(1.0 - x, 3.0);
}
vec3 getBaseColorHook(out float alpha) {
float alphaDiscard = 0.5;
#ifdef USE_HEIGHT_TEXTURE
float heightAmount = textureWithOptionalAntiTiling(heightTexture, vUv0).r;
alpha = currentStep > 0.0 ? easeOutCubic(heightAmount) : 1.0;
alphaDiscard = (1.0 / renderSteps) * currentStep;
if (alpha < alphaDiscard) {
discard;
}
#endif
#ifdef USE_BASE_COLOR_TEXTURE
vec2 uv = vUv0;
#ifdef USE_BASE_COLOR_TEXTURE_ATLAS_REPEAT
vec2 uvScaled = uv * baseColorAtlasUvMod.zw;
vec2 dfdx = dFdx(uvScaled);
vec2 dfdy = dFdy(uvScaled);
uv = fract(uv) * baseColorAtlasUvMod.zw + baseColorAtlasUvMod.xy;
vec4 baseColorGamma = textureGrad(baseColorTexture, uv, dfdx, dfdy);
#else
vec4 baseColorGamma = textureWithOptionalAntiTiling(baseColorTexture, uv);
#endif
vec3 resultColor =
applyBaseColorCorrection(gammaToLinear(baseColorGamma.rgb), baseColorCorrection);
#else
vec3 resultColor = uBaseColor;
#endif
float offset = min(0.35, 0.35 * (renderSteps - 1.0));
float baseColorMultiplier = mix(1.0 - offset, 1.0 + offset, alphaDiscard);
return resultColor * baseColorMultiplier;
}
`,"grass_vertex.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform float grassOffsetScaled;
uniform float grassDirectionality;
#endif
void modifyMvPositionHook(inout vec4 mvPosition, in vec3 mvNormal) {
vec3 vector = mix(vec3(0, 1, 0), mvNormal, grassDirectionality);
mvPosition.xyz += vector * grassOffsetScaled;
}
`,"luma_fragment.glsl":`const float PI = 3.14159265358979;
const float RECIPROCAL_PI2 = 0.15915494;
float saturate(in float a) {
return clamp(a, 0.0, 1.0);
}
vec3 inverseTransformDirection(in vec3 normal, in mat4 matrix) {
return normalize((vec4(normal, 0.0) * matrix).xyz);
}
vec4 cubic(in float v) {
vec4 n = vec4(1.0, 2.0, 3.0, 4.0) - v;
vec4 s = n * n * n;
float x = s.x;
float y = s.y - 4.0 * s.x;
float z = s.z - 4.0 * s.y + 6.0 * s.x;
float w = 6.0 - x - y - z;
return vec4(x, y, z, w) * (1.0 / 6.0);
}
vec3 hdrDecodeRgbm(in vec4 rgbm) {
const float rgbmScale = 2.82842712;  // sqrt(8)
float m = 1.0 - rgbm.a;
vec3 r = rgbm.rgb * (rgbmScale * m);
return r * r;
}
vec3 hdrDecodeYcocgm(in vec4 ycocgm, in vec2 threshold) {
const float ycocgmLumaRange = 16.0;
float m = ycocgm.w * (16.0 * 255.0 / 256.0) - 1.0;
float chroma_scale_factor = fract(m);
float y_factor = m - chroma_scale_factor;
chroma_scale_factor = 1.0 - chroma_scale_factor;
float factor = y_factor == ycocgmLumaRange - 2.0 ? 0.0 : 1.0;
float y = mix(ycocgm.x * threshold.x, (y_factor + ycocgm.x) * threshold.y + threshold.x, factor);
float co = (ycocgm.y - 0.5) * chroma_scale_factor;
float cg = (ycocgm.z - 0.5) * chroma_scale_factor;
return vec3(y, co, cg);
}
vec3 ycocgToRgb(in vec3 ycocg) {
float y = ycocg.x, co = ycocg.y, cg = ycocg.z;
y = y * y;
float r = saturate(y + co - cg);
float g = saturate(y + cg);
float b = saturate(y - co - cg);
return vec3(r, g, b) * 8.0;
}
/*vec3 hdrDecodeYcocgmBicubic(in sampler2D ycocgmSampler, in vec2 texSize, in vec2 invTexSize,
in vec2 threshold, in vec2 texCoords) {
vec2 texCoordsScaled = texCoords * texSize - 0.5;
vec2 fxy = fract(texCoordsScaled);
texCoordsScaled -= fxy;
vec4 xcubic = cubic(fxy.x), ycubic = cubic(fxy.y);
vec4 c = texCoordsScaled.xxyy + vec2(-0.5, +1.5).xyxy;
vec4 s = vec4(xcubic.xz + xcubic.yw, ycubic.xz + ycubic.yw);
vec4 offset = (c + vec4 (xcubic.yw, ycubic.yw) / s) * invTexSize.xxyy;
vec3 sample0 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.xz), threshold);
vec3 sample1 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.yz), threshold);
vec3 sample2 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.xw), threshold);
vec3 sample3 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.yw), threshold);
float sx = s.x / (s.x + s.y), sy = s.z / (s.z + s.w);
return mix(mix(sample3, sample2, sx), mix(sample1, sample0, sx), sy);
}*/
vec3 hdrDecodeYcocgmBilinear(in sampler2D ycocgmSampler, in vec2 texSize, in vec2 invTexSize,
in vec2 threshold, in vec2 texCoords) {
vec2 texCoordsScaled = texCoords * texSize - 0.5;
vec2 fxy = fract(texCoordsScaled);
texCoordsScaled -= fxy;
vec4 c = texCoordsScaled.xxyy + vec2(-0.5, +0.5).xyxy;
vec4 offset = c + vec4(1.0);
float sx = 1.0 - fxy.x;
float sy = 1.0 - fxy.y;
offset *= invTexSize.xxyy;
vec3 sample0 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.xz), threshold);
vec3 sample1 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.yz), threshold);
vec3 sample2 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.xw), threshold);
vec3 sample3 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.yw), threshold);
return mix(mix(sample3, sample2, sx), mix(sample1, sample0, sx), sy);
}
/*vec3 hdrDecodeRgbmBicubic(in sampler2D rgbmSampler, in vec2 texSize,
in vec2 invTexSize, in vec2 texCoords) {
vec2 texCoordsScaled = texCoords * texSize - 0.5;
vec2 fxy = fract(texCoordsScaled);
texCoordsScaled -= fxy;
vec4 xcubic = cubic(fxy.x), ycubic = cubic(fxy.y);
vec4 c = texCoordsScaled.xxyy + vec2(-0.5, +1.5).xyxy;
vec4 s = vec4(xcubic.xz + xcubic.yw, ycubic.xz + ycubic.yw);
vec4 offset = (c + vec4 (xcubic.yw, ycubic.yw) / s) * invTexSize.xxyy;
vec3 sample0 = hdrDecodeRgbm(texture(rgbmSampler, offset.xz));
vec3 sample1 = hdrDecodeRgbm(texture(rgbmSampler, offset.yz));
vec3 sample2 = hdrDecodeRgbm(texture(rgbmSampler, offset.xw));
vec3 sample3 = hdrDecodeRgbm(texture(rgbmSampler, offset.yw));
float sx = s.x / (s.x + s.y), sy = s.z / (s.z + s.w);
return mix(mix(sample3, sample2, sx), mix(sample1, sample0, sx), sy);
}*/
vec3 hdrDecodeRgbmBilinear(in sampler2D rgbmSampler, in vec2 texSize, in vec2 invTexSize,
in vec2 texCoords) {
vec2 texCoordsScaled = texCoords * texSize - 0.5;
vec2 fxy = fract(texCoordsScaled);
texCoordsScaled -= fxy;
vec4 c = texCoordsScaled.xxyy + vec2(-0.5, +0.5).xyxy;
vec4 offset = c + vec4(1.0);
float sx = 1.0 - fxy.x;
float sy = 1.0 - fxy.y;
offset *= invTexSize.xxyy;
vec3 sample0 = hdrDecodeRgbm(texture(rgbmSampler, offset.xz));
vec3 sample1 = hdrDecodeRgbm(texture(rgbmSampler, offset.yz));
vec3 sample2 = hdrDecodeRgbm(texture(rgbmSampler, offset.xw));
vec3 sample3 = hdrDecodeRgbm(texture(rgbmSampler, offset.yw));
return mix(mix(sample3, sample2, sx), mix(sample1, sample0, sx), sy);
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform GlobalBuffer {
mat4 unjitteredInvProjMatrix;
mat4 unjitteredPrevViewProjMatrix;
vec4 viewSpaceFrustumRayDirections[4];
vec4 viewSpaceFrustumRayOrigins[4];
vec2 zNear_zFar;
vec4 fogDistStart_DistDensity_HeightStart_HeightDensity;
vec4 fogColor;
vec4 camera_exposure_gamma;
float colorMapIntensity;
float time;
vec2 texelSize;
vec2 renderTargetSize;
float deltaTime;
float velocityFactor;
vec2 jitterOffset;
float temporalAaHistoryWeight;
bool allTaaSamplesAccumulated;
vec2 neighbourhoodTexelOffsets[8];
float accumulatedStaticTaaSamples;
vec4 screenResolution;
float lightmapMode;
float dynamicTaaHistoryMultiplier;
};
#define uFogColor fogColor.xyz
#endif
struct ReflectionProbe {
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
vec3 boxMin;
vec3 boxMax;
vec3 posW;
#else
vec4 boxMin;
vec4 boxMax;
vec4 posW;
#endif
};
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform LightBuffer {
vec4 lightmapSize;
vec4 lightmapThreshold;
ReflectionProbe reflectionProbes[3];
int reflectionProbesCount;
};
#endif
#ifdef LIVE_LIGHTMAP
uniform sampler2D liveLightmap;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform float lightmapMode;
uniform vec4 screenResolution;
#endif
#endif
#ifdef USE_LIGHTMAP
centroid in vec2 vUv1;
uniform sampler2D lightmap;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec4 lightmapSize;
uniform vec2 lightmapThreshold;
#endif
#endif  // NOT USE_LIGHTMAP
vec3 getLightIntensity() {
#ifdef LIVE_LIGHTMAP
if (lightmapMode == 1.0)
return texture(liveLightmap, gl_FragCoord.xy / screenResolution.xy).xyz;
if (lightmapMode == -1.0)
return vec3(1.0);
#endif
#ifdef USE_LIGHTMAP
vec2 uv = vec2(vUv1.x, vUv1.y);
#ifdef LIGHTMAP_YCOCGM
return ycocgToRgb(hdrDecodeYcocgmBilinear(lightmap, lightmapSize.xy, lightmapSize.zw,
lightmapThreshold.xy, uv));
#else  // LIGHTMAP_RGBM
return hdrDecodeRgbmBilinear(lightmap, lightmapSize.xy, lightmapSize.zw, uv);
#endif
#else  // ifndef USE_LIGHTMAP
return vec3(1.0);
#endif
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec3 uObjectBaseColor;
#endif
const float maxLuminance = 8.0;
const float rangeScale = 256.0 / maxLuminance;
const float fltMin = uintBitsToFloat(0x2F800000u);
void main() {
vec3 receivedLight = getLightIntensity();
const vec3 weights = vec3(0.299, 0.587, 0.114);
float incidentLuma = dot(receivedLight, weights);
vec3 reflectedLight = receivedLight * uObjectBaseColor;
float reflectedLuma = dot(reflectedLight, weights);
fragColor.r = max(fract(incidentLuma * rangeScale), fltMin);
fragColor.g = floor(incidentLuma * rangeScale) / 255.0;
fragColor.b = max(fract(reflectedLuma * rangeScale), fltMin);
fragColor.a = floor(reflectedLuma * rangeScale) / 255.0;
}
`,"minimap_add_alpha_fragment.glsl":`uniform sampler2D tColor;
#ifdef USE_ALPHA_FROM_COLOR
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec3 uColorFill;
#endif
#else
uniform sampler2D tAlpha;
#endif
in vec2 vUv0;
void main() {
vec4 color = texture(tColor, vUv0);
#ifdef USE_ALPHA_FROM_COLOR
float alphaFromColor = (color.r + color.g + color.b) / 3.0;
fragColor = vec4(uColorFill, alphaFromColor);
#else
float alpha = vec4(texture(tAlpha, vUv0)).a;
fragColor = vec4(color.rgb, alpha);
#endif
}
`,"minimap_add_alpha_vertex.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform CameraBuffer {
mat4 projectionMatrix;
mat4 viewProjMatrix;
mat4 viewMatrix;
mat4 invViewMatrix;
vec4 cameraPosition_pad;
};
#define uCameraPosition cameraPosition_pad.xyz
#endif
mat4 getModelViewMatrix() {
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
return modelViewMatrix;
#else
#ifdef MODEL_MATRIX
return viewMatrix * modelMatrix;
#else
return viewMatrix;
#endif
#endif
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#define MODEL_MATRIX
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = projectionMatrix * modelViewMatrix * worldPos;
}
#else  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec4 worldPos) {
#ifdef MODEL_MATRIX
gl_Position = viewProjMatrix * modelMatrix * worldPos;
#else
gl_Position = viewProjMatrix * worldPos;
#endif  // MODEL_MATRIX
}
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec3 worldPos) {
setClipPositionFromWorldPos(vec4(worldPos, 1.0));
}
void setClipPositionFromViewPos(in vec4 viewPos) {
gl_Position = projectionMatrix * viewPos;
}
void setClipPositionFromViewPos(in vec3 viewPos) {
setClipPositionFromViewPos(vec4(viewPos, 1.0));
}
vec3 multiplyPositionByModelMatrix(in vec4 position) {
#ifdef MODEL_MATRIX
return (modelMatrix * position).xyz;
#else
return position.xyz;
#endif
}
vec3 multiplyPositionByModelMatrix(in vec3 position) {
return multiplyPositionByModelMatrix(vec4(position, 1.0));
}
vec3 multiplyDirectionByModelMatrix(in vec3 direction) {
#ifdef MODEL_MATRIX
return (modelMatrix * vec4(direction, 0.0)).xyz;
#else
return direction;
#endif
}
out vec2 vUv0;
void main() {
vUv0 = uv0;
setClipPositionFromWorldPos(position);
}
`,"motion_blur_fragment.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform GlobalBuffer {
mat4 unjitteredInvProjMatrix;
mat4 unjitteredPrevViewProjMatrix;
vec4 viewSpaceFrustumRayDirections[4];
vec4 viewSpaceFrustumRayOrigins[4];
vec2 zNear_zFar;
vec4 fogDistStart_DistDensity_HeightStart_HeightDensity;
vec4 fogColor;
vec4 camera_exposure_gamma;
float colorMapIntensity;
float time;
vec2 texelSize;
vec2 renderTargetSize;
float deltaTime;
float velocityFactor;
vec2 jitterOffset;
float temporalAaHistoryWeight;
bool allTaaSamplesAccumulated;
vec2 neighbourhoodTexelOffsets[8];
float accumulatedStaticTaaSamples;
vec4 screenResolution;
float lightmapMode;
float dynamicTaaHistoryMultiplier;
};
#define uFogColor fogColor.xyz
#endif
uniform sampler2D tDepth;
uniform sampler2D tDiffuse;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform float velocityFactor;
uniform vec2 texelSize;
uniform mat4 invViewProjMatrix;
uniform mat4 prevViewProjMatrix;
#endif
void main() {
vec2 coord = gl_FragCoord.xy * texelSize;
float zOverW = texture(tDepth, coord).r;
vec4 H = vec4(coord.x * 2.0 - 1.0, (1.0 - coord.y) * 2.0 - 1.0, zOverW * 2.0 - 1.0, 1.0);
vec4 D = invViewProjMatrix * H;
vec4 worldPos = D / D.w;
vec4 currentPos = H;
vec4 previousPos = prevViewProjMatrix * worldPos;
previousPos /= previousPos.w;
vec2 velocity = velocityFactor * ((currentPos.xy - previousPos.xy) / 2.0);
const float maxLen = 0.02;
if (length(velocity) > maxLen) {
velocity = normalize(velocity) * maxLen;
}
vec4 color = texture(tDiffuse, coord);
const int samples = 12;
vec2 offset = vec2(0.0);
vec4 finalColor = color;
if (length(velocity) > 0.001) {
for (int i = 1; i < samples; i++) {
offset = velocity * (float(i) / (float(samples) - 1.0) - 0.5);
vec2 sampleUV = clamp(coord + offset, vec2(0.0), vec2(1.0));
vec4 currentColor = texture(tDiffuse, sampleUV);
color += currentColor;
}
finalColor = color / float(samples);
}
fragColor = vec4(finalColor.rgb, 1.0);
}
`,"motion_blur_vertex.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform CameraBuffer {
mat4 projectionMatrix;
mat4 viewProjMatrix;
mat4 viewMatrix;
mat4 invViewMatrix;
vec4 cameraPosition_pad;
};
#define uCameraPosition cameraPosition_pad.xyz
#endif
mat4 getModelViewMatrix() {
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
return modelViewMatrix;
#else
#ifdef MODEL_MATRIX
return viewMatrix * modelMatrix;
#else
return viewMatrix;
#endif
#endif
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#define MODEL_MATRIX
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = projectionMatrix * modelViewMatrix * worldPos;
}
#else  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec4 worldPos) {
#ifdef MODEL_MATRIX
gl_Position = viewProjMatrix * modelMatrix * worldPos;
#else
gl_Position = viewProjMatrix * worldPos;
#endif  // MODEL_MATRIX
}
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec3 worldPos) {
setClipPositionFromWorldPos(vec4(worldPos, 1.0));
}
void setClipPositionFromViewPos(in vec4 viewPos) {
gl_Position = projectionMatrix * viewPos;
}
void setClipPositionFromViewPos(in vec3 viewPos) {
setClipPositionFromViewPos(vec4(viewPos, 1.0));
}
vec3 multiplyPositionByModelMatrix(in vec4 position) {
#ifdef MODEL_MATRIX
return (modelMatrix * position).xyz;
#else
return position.xyz;
#endif
}
vec3 multiplyPositionByModelMatrix(in vec3 position) {
return multiplyPositionByModelMatrix(vec4(position, 1.0));
}
vec3 multiplyDirectionByModelMatrix(in vec3 direction) {
#ifdef MODEL_MATRIX
return (modelMatrix * vec4(direction, 0.0)).xyz;
#else
return direction;
#endif
}
void main() {
setClipPositionFromWorldPos(position);
}
`,"object_distance_vertex.glsl":`vec4 transformPosition() {
return vec4(t0.x * position.x + t0.y * position.y + t0.z * position.z + t0.w,
t1.x * position.x + t1.y * position.y + t1.z * position.z + t1.w,
t2.x * position.x + t2.y * position.y + t2.z * position.z + t2.w, 1.0);
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform CameraBuffer {
mat4 projectionMatrix;
mat4 viewProjMatrix;
mat4 viewMatrix;
mat4 invViewMatrix;
vec4 cameraPosition_pad;
};
#define uCameraPosition cameraPosition_pad.xyz
#endif
mat4 getModelViewMatrix() {
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
return modelViewMatrix;
#else
#ifdef MODEL_MATRIX
return viewMatrix * modelMatrix;
#else
return viewMatrix;
#endif
#endif
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#define MODEL_MATRIX
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = projectionMatrix * modelViewMatrix * worldPos;
}
#else  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec4 worldPos) {
#ifdef MODEL_MATRIX
gl_Position = viewProjMatrix * modelMatrix * worldPos;
#else
gl_Position = viewProjMatrix * worldPos;
#endif  // MODEL_MATRIX
}
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec3 worldPos) {
setClipPositionFromWorldPos(vec4(worldPos, 1.0));
}
void setClipPositionFromViewPos(in vec4 viewPos) {
gl_Position = projectionMatrix * viewPos;
}
void setClipPositionFromViewPos(in vec3 viewPos) {
setClipPositionFromViewPos(vec4(viewPos, 1.0));
}
vec3 multiplyPositionByModelMatrix(in vec4 position) {
#ifdef MODEL_MATRIX
return (modelMatrix * position).xyz;
#else
return position.xyz;
#endif
}
vec3 multiplyPositionByModelMatrix(in vec3 position) {
return multiplyPositionByModelMatrix(vec4(position, 1.0));
}
vec3 multiplyDirectionByModelMatrix(in vec3 direction) {
#ifdef MODEL_MATRIX
return (modelMatrix * vec4(direction, 0.0)).xyz;
#else
return direction;
#endif
}
out vec3 vPositionW;
void main() {
vec4 transformedPosition = transformPosition();
vPositionW = multiplyPositionByModelMatrix(transformedPosition);
setClipPositionFromWorldPos(transformedPosition);
}
`,"object_id_distance_fragment.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform CameraBuffer {
mat4 projectionMatrix;
mat4 viewProjMatrix;
mat4 viewMatrix;
mat4 invViewMatrix;
vec4 cameraPosition_pad;
};
#define uCameraPosition cameraPosition_pad.xyz
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform int objectId;
#endif
in vec3 vPositionW;
void main(void) {
float cameraDistance = min(distance(uCameraPosition, vPositionW), 255.0);
int x = objectId / 256;
int y = objectId - 256 * x;
float z = floor(cameraDistance);
float a = fract(cameraDistance);
fragColor = vec4(float(x) / 255.0, float(y) / 255.0, z / 255.0, a);
}
`,"object_id_fragment.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform int objectId;
#endif
in vec3 vPositionW;
void main(void) {
int x = objectId / (256 * 256);
int y = (objectId - 256 * 256 * x) / 256;
int z = (objectId - 256 * 256 * x - 256 * y);
fragColor = vec4(float(x) / 255.0, float(y) / 255.0, float(z) / 255.0, 0);
}
`,"outline_fragment.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec3 uColor;
#endif
void main() {
fragColor = vec4(uColor, 1.0);
}
`,"outline_vertex.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform CameraBuffer {
mat4 projectionMatrix;
mat4 viewProjMatrix;
mat4 viewMatrix;
mat4 invViewMatrix;
vec4 cameraPosition_pad;
};
#define uCameraPosition cameraPosition_pad.xyz
#endif
vec4 transformPosition() {
return vec4(t0.x * position.x + t0.y * position.y + t0.z * position.z + t0.w,
t1.x * position.x + t1.y * position.y + t1.z * position.z + t1.w,
t2.x * position.x + t2.y * position.y + t2.z * position.z + t2.w, 1.0);
}
const float PI = 3.14159265358979;
const float RECIPROCAL_PI2 = 0.15915494;
float saturate(in float a) {
return clamp(a, 0.0, 1.0);
}
vec3 inverseTransformDirection(in vec3 normal, in mat4 matrix) {
return normalize((vec4(normal, 0.0) * matrix).xyz);
}
vec3 sphericalDecode(in vec2 spNormal) {
float theta = (spNormal.x / 254.0 + 0.5) * PI;
float phi = spNormal.y * (PI / 127.0);
float sinTheta = sin(theta);
return vec3(sinTheta * cos(phi), sinTheta * sin(phi), cos(theta));
}
mat4 getModelViewMatrix() {
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
return modelViewMatrix;
#else
#ifdef MODEL_MATRIX
return viewMatrix * modelMatrix;
#else
return viewMatrix;
#endif
#endif
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#define MODEL_MATRIX
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = projectionMatrix * modelViewMatrix * worldPos;
}
#else  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec4 worldPos) {
#ifdef MODEL_MATRIX
gl_Position = viewProjMatrix * modelMatrix * worldPos;
#else
gl_Position = viewProjMatrix * worldPos;
#endif  // MODEL_MATRIX
}
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec3 worldPos) {
setClipPositionFromWorldPos(vec4(worldPos, 1.0));
}
void setClipPositionFromViewPos(in vec4 viewPos) {
gl_Position = projectionMatrix * viewPos;
}
void setClipPositionFromViewPos(in vec3 viewPos) {
setClipPositionFromViewPos(vec4(viewPos, 1.0));
}
vec3 multiplyPositionByModelMatrix(in vec4 position) {
#ifdef MODEL_MATRIX
return (modelMatrix * position).xyz;
#else
return position.xyz;
#endif
}
vec3 multiplyPositionByModelMatrix(in vec3 position) {
return multiplyPositionByModelMatrix(vec4(position, 1.0));
}
vec3 multiplyDirectionByModelMatrix(in vec3 direction) {
#ifdef MODEL_MATRIX
return (modelMatrix * vec4(direction, 0.0)).xyz;
#else
return direction;
#endif
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform float thickness;
#endif
void main() {
vec3 n = sphericalDecode(sphericalNormal);
vec3 normal = vec3(t0.x * n.x + t0.y * n.y + t0.z * n.z, t1.x * n.x + t1.y * n.y + t1.z * n.z,
t2.x * n.x + t2.y * n.y + t2.z * n.z);
vec4 transformedPosition = transformPosition();
float distToCamera = uCameraPosition.z - transformedPosition.z;
vec4 movedPosition = vec4(transformedPosition.x - distToCamera * thickness * normal.x,
transformedPosition.y - distToCamera * thickness * normal.y,
transformedPosition.z, transformedPosition.w);
setClipPositionFromWorldPos(movedPosition);
}
`,"position_only_vertex.glsl":`vec4 transformPosition() {
return vec4(t0.x * position.x + t0.y * position.y + t0.z * position.z + t0.w,
t1.x * position.x + t1.y * position.y + t1.z * position.z + t1.w,
t2.x * position.x + t2.y * position.y + t2.z * position.z + t2.w, 1.0);
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform CameraBuffer {
mat4 projectionMatrix;
mat4 viewProjMatrix;
mat4 viewMatrix;
mat4 invViewMatrix;
vec4 cameraPosition_pad;
};
#define uCameraPosition cameraPosition_pad.xyz
#endif
mat4 getModelViewMatrix() {
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
return modelViewMatrix;
#else
#ifdef MODEL_MATRIX
return viewMatrix * modelMatrix;
#else
return viewMatrix;
#endif
#endif
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#define MODEL_MATRIX
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = projectionMatrix * modelViewMatrix * worldPos;
}
#else  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec4 worldPos) {
#ifdef MODEL_MATRIX
gl_Position = viewProjMatrix * modelMatrix * worldPos;
#else
gl_Position = viewProjMatrix * worldPos;
#endif  // MODEL_MATRIX
}
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec3 worldPos) {
setClipPositionFromWorldPos(vec4(worldPos, 1.0));
}
void setClipPositionFromViewPos(in vec4 viewPos) {
gl_Position = projectionMatrix * viewPos;
}
void setClipPositionFromViewPos(in vec3 viewPos) {
setClipPositionFromViewPos(vec4(viewPos, 1.0));
}
vec3 multiplyPositionByModelMatrix(in vec4 position) {
#ifdef MODEL_MATRIX
return (modelMatrix * position).xyz;
#else
return position.xyz;
#endif
}
vec3 multiplyPositionByModelMatrix(in vec3 position) {
return multiplyPositionByModelMatrix(vec4(position, 1.0));
}
vec3 multiplyDirectionByModelMatrix(in vec3 direction) {
#ifdef MODEL_MATRIX
return (modelMatrix * vec4(direction, 0.0)).xyz;
#else
return direction;
#endif
}
void main() {
setClipPositionFromWorldPos(transformPosition());
}
`,"postprocess_vertex.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform GlobalBuffer {
mat4 unjitteredInvProjMatrix;
mat4 unjitteredPrevViewProjMatrix;
vec4 viewSpaceFrustumRayDirections[4];
vec4 viewSpaceFrustumRayOrigins[4];
vec2 zNear_zFar;
vec4 fogDistStart_DistDensity_HeightStart_HeightDensity;
vec4 fogColor;
vec4 camera_exposure_gamma;
float colorMapIntensity;
float time;
vec2 texelSize;
vec2 renderTargetSize;
float deltaTime;
float velocityFactor;
vec2 jitterOffset;
float temporalAaHistoryWeight;
bool allTaaSamplesAccumulated;
vec2 neighbourhoodTexelOffsets[8];
float accumulatedStaticTaaSamples;
vec4 screenResolution;
float lightmapMode;
float dynamicTaaHistoryMultiplier;
};
#define uFogColor fogColor.xyz
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform CameraBuffer {
mat4 projectionMatrix;
mat4 viewProjMatrix;
mat4 viewMatrix;
mat4 invViewMatrix;
vec4 cameraPosition_pad;
};
#define uCameraPosition cameraPosition_pad.xyz
#endif
out vec2 vUv0;
out vec3 vWorldRayDir;
out vec3 vWorldRayOrigin;
void main() {
gl_Position = vec4(position, 1.0);
vUv0 = uv0;
vec4 nearHomogenousCorner = vec4(position.x, position.y, -1.0, 1.0);
vec4 farHomogenousCorner = vec4(position.x, position.y, 1.0, 1.0);
vec4 nearPos = unjitteredInvProjMatrix * nearHomogenousCorner;
vec4 farPos = unjitteredInvProjMatrix * farHomogenousCorner;
nearPos /= nearPos.w;
farPos /= farPos.w;
vWorldRayDir = vec3(farPos - nearPos);
vWorldRayDir /= vWorldRayDir.z;
vWorldRayOrigin = nearPos.xyz - vWorldRayDir * nearPos.z;
vWorldRayDir = vec3(invViewMatrix * vec4(vWorldRayDir, 0.0));
vWorldRayOrigin = vec3(invViewMatrix * vec4(vWorldRayOrigin, 1.0));
}
`,"procedural_sky_fragment.glsl":`const float PI = 3.14159265358979;
const float RECIPROCAL_PI2 = 0.15915494;
float saturate(in float a) {
return clamp(a, 0.0, 1.0);
}
vec3 inverseTransformDirection(in vec3 normal, in mat4 matrix) {
return normalize((vec4(normal, 0.0) * matrix).xyz);
}
float _g2l(in float x) {
return (x <= 0.04045) ? x / 12.92 : pow((x + 0.055) / 1.055, 2.4);
}
vec3 gammaToLinear(in vec3 rgb) {
return vec3(_g2l(rgb.r), _g2l(rgb.g), _g2l(rgb.b));
}
float _l2g(in float x) {
return (x <= 0.0031308) ? x * 12.92 : pow(x, 1.0 / 2.4) * 1.055 - 0.055;
}
vec3 linearToGamma(in vec3 rgb) {
return vec3(_l2g(rgb.r), _l2g(rgb.g), _l2g(rgb.b));
}
vec3 hable(in vec3 rgb) {
float A = 0.15;  // shoulderStrength
float B = 0.50;  // linearStrength
float C = 0.10;  // linearAngle
float D = 0.20;  // toeStrength
float E = 0.02;  // toeNumerator
float F = 0.30;  // toeDenominator
return ((rgb * (A * rgb + C * B) + D * E) / (rgb * (A * rgb + B) + D * F)) - E / F;
}
vec3 toneMappingHable(in vec3 rgb) {
float exposure = 11.2;
float exposureBias = 2.0;
vec3 current = hable(exposureBias * rgb);
vec3 whiteScale = 1.0 / hable(vec3(exposure));
return pow(current * whiteScale, vec3(1.0 / 2.2));
}
vec3 uchimura(in vec3 x, in float P, in float a, in float m, in float l, in float c, in float b) {
float l0 = ((P - m) * l) / a;
float L0 = m - m / a;
float L1 = m + (1.0 - m) / a;
float S0 = m + l0;
float S1 = m + a * l0;
float C2 = (a * P) / (P - S1);
float CP = -C2 / P;
vec3 w0 = vec3(1.0 - smoothstep(0.0, m, x));
vec3 w2 = vec3(step(m + l0, x));
vec3 w1 = vec3(1.0 - w0 - w2);
vec3 T = vec3(m * pow(x / m, vec3(c)) + b);
vec3 S = vec3(P - (P - S1) * exp(CP * (x - S0)));
vec3 L = vec3(m + a * (x - m));
return T * w0 + L * w1 + S * w2;
}
vec3 toneMappingUchimura(in vec3 rgb) {
float P = 1.0;   // max display brightness
float a = 1.0;   // contrast
float m = 0.22;  // linear section start
float l = 0.4;   // linear section length
float c = 1.45;  // black
float b = 0.0;   // pedestal
return pow(uchimura(rgb, P, a, m, l, c, b), vec3(1.0 / 2.2));
}
vec3 toneMappingUnreal(in vec3 rgb) {
return rgb / (rgb + 0.187) * 1.035;
}
vec3 linearToGammaToneMapped(in vec3 rgb) {
#ifdef TONE_MAPPING_UNREAL
return toneMappingUnreal(rgb);
#endif
#ifdef TONE_MAPPING_HABLE
return toneMappingHable(rgb);
#endif
#ifdef TONE_MAPPING_UCHIMURA
return toneMappingUchimura(rgb);
#endif
return toneMappingUnreal(rgb);
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform GlobalBuffer {
mat4 unjitteredInvProjMatrix;
mat4 unjitteredPrevViewProjMatrix;
vec4 viewSpaceFrustumRayDirections[4];
vec4 viewSpaceFrustumRayOrigins[4];
vec2 zNear_zFar;
vec4 fogDistStart_DistDensity_HeightStart_HeightDensity;
vec4 fogColor;
vec4 camera_exposure_gamma;
float colorMapIntensity;
float time;
vec2 texelSize;
vec2 renderTargetSize;
float deltaTime;
float velocityFactor;
vec2 jitterOffset;
float temporalAaHistoryWeight;
bool allTaaSamplesAccumulated;
vec2 neighbourhoodTexelOffsets[8];
float accumulatedStaticTaaSamples;
vec4 screenResolution;
float lightmapMode;
float dynamicTaaHistoryMultiplier;
};
#define uFogColor fogColor.xyz
#endif
#ifdef USE_FOG
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec4 fogDistStart_DistDensity_HeightStart_HeightDensity;
uniform vec3 uFogColor;
#endif
const float LOG2 = 1.442695;
vec3 addFog(in vec3 colorIn, in float distance, in vec3 positionW) {
float distanceValue = max(0.0, distance - fogDistStart_DistDensity_HeightStart_HeightDensity.x);
float distanceDensity = fogDistStart_DistDensity_HeightStart_HeightDensity.y;
float distanceFogExp =
1.0 - exp2(-distanceDensity * distanceDensity * distanceValue * distanceValue * LOG2);
float heightValue = max(0.0, -positionW.z + fogDistStart_DistDensity_HeightStart_HeightDensity.z);
float heightDensity = fogDistStart_DistDensity_HeightStart_HeightDensity.w;
float heightFogExp =
1.0 - exp2(-heightDensity * heightDensity * heightValue * heightValue * LOG2);
float fogAmount = min(1.0, distanceFogExp + heightFogExp);
return mix(colorIn, uFogColor.xyz, fogAmount);
}
#endif
in vec3 vWorldDirection;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#ifdef SKY_MODEL_HOSEK_WILKIE
uniform vec3 uHosekWilkieParams[9];
uniform vec3 uRadiance;
uniform vec3 uSunDirection;
uniform vec3 uGroundTint;
#endif  // SKY_MODEL_HOSEK_WILKIE
#ifdef SKY_MODEL_SIMPLE
uniform vec3 uTopColor;
#ifdef SIMPLE_USE_BOTTOM_GRADIENT
uniform vec3 uBottomColor;
uniform float uSinBottomAngle;
uniform float uExponent;
#endif  // SIMPLE_USE_BOTTOM_GRADIENT
#endif    // SKY_MODEL_SIMPLE
uniform vec4 camera_exposure_gamma;
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
#ifdef USE_FOG
in vec3 vPositionW;
in vec3 vPositionV;
#endif  // USE_FOG
#ifdef HDR_OUTPUT
vec4 hdrEncode(in vec3 rgb) {
const float rgbmScale = 2.82842712;  // sqrt(8)
vec3 r = sqrt(rgb) / rgbmScale;
float m = max(max(r.r, r.g), r.b);
m = clamp(m, 1.0 / 255.0, 1.0);
m = ceil(m * 255.0) / 255.0;
r /= m;
return vec4(r.r, r.g, r.b, (1.0 - m));
}
#endif  // HDR_OUTPUT
#ifdef USE_COLORMAP
vec3 colormap(in sampler2D lut, in vec3 color, in float intensity) {
const float resolution = 16.0;
const float maxValueIndex = resolution - 1.0;
const float sliceWidth = 1.0 / resolution;
const float slicePixelWidth = sliceWidth / resolution;
const float sliceMarginWidth = 0.5 * slicePixelWidth;
const float sliceInnerWidth = sliceWidth - slicePixelWidth;
const float slicePixelHeight = 1.0 / resolution;
const float sliceMarginHeight = 0.5 * slicePixelHeight;
const float sliceInnerHeight = 1.0 - slicePixelHeight;
float bSlice0 = min(floor(color.b * maxValueIndex), maxValueIndex - 1.0);
float bSlice1 = bSlice0 + 1.0;
float bOffset = color.b * maxValueIndex - bSlice0;
float rSlicePos = sliceMarginWidth + color.r * sliceInnerWidth;
float gSlicePos = sliceMarginHeight + color.g * sliceInnerHeight;
float rPos0 = rSlicePos + (bSlice0 * sliceWidth);
float rPos1 = rSlicePos + (bSlice1 * sliceWidth);
vec3 color0 = texture(lut, vec2(rPos0, gSlicePos)).rgb;
vec3 color1 = texture(lut, vec2(rPos1, gSlicePos)).rgb;
return mix(color, mix(color0, color1, bOffset), intensity);
}
uniform sampler2D colorMap;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform float uColorMapIntensity;
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
#endif    // USE_COLORMAP
#ifdef SKY_MODEL_HOSEK_WILKIE
vec3 hosekWilkie(float cosZenithAngle, float sunAngle, float cosSunAngle) {
vec3 A = uHosekWilkieParams[0];
vec3 B = uHosekWilkieParams[1];
vec3 C = uHosekWilkieParams[2];
vec3 D = uHosekWilkieParams[3];
vec3 E = uHosekWilkieParams[4];
vec3 F = uHosekWilkieParams[5];
vec3 G = uHosekWilkieParams[6];
vec3 H = uHosekWilkieParams[7];
vec3 I = uHosekWilkieParams[8];
vec3 denominator = 1.0 + H * H - 2.0 * cosSunAngle * H;
vec3 chi = (1.0 + cosSunAngle * cosSunAngle) / (sqrt(denominator) * denominator);
return (1.0 + A * exp(B / (max(cosZenithAngle, 0.05)))) *
(C + D * exp(E * sunAngle) + F * cosSunAngle * cosSunAngle + G * chi +
I * sqrt(cosZenithAngle));
}
#endif  // SKY_MODEL_HOSEK_WILKIE
void main() {
vec3 modelOutColorGamma = vec3(0.0);
vec3 modelOutColorLinear = vec3(0.0);
vec3 vWorldDirectionNormalized = normalize(vWorldDirection);
#ifdef SKY_MODEL_HOSEK_WILKIE
float cosZenithAngle = clamp(vWorldDirectionNormalized.z, 0.0, 1.0);
float cosSunAngle = max(0.0, dot(vWorldDirectionNormalized, uSunDirection));
float sunAngle = acos(cosSunAngle);
vec3 luminance = hosekWilkie(cosZenithAngle, sunAngle, cosSunAngle);
luminance *= uRadiance;
const float mixZStart = -0.01;
const float mixZEnd = 0.01;
luminance = mix(luminance * uGroundTint, luminance,
smoothstep(mixZStart, mixZEnd, vWorldDirectionNormalized.z));
if (cosSunAngle > 0.0) {
const float sunHighlightExponent = 512.0;
const float sunHighlightIntensity = 0.6;
luminance += vec3(pow(cosSunAngle, sunHighlightExponent) * sunHighlightIntensity);
}
modelOutColorGamma = luminance;
#endif  // SKY_MODEL_HOSEK_WILKIE
#ifdef SKY_MODEL_SIMPLE
#ifdef SIMPLE_USE_BOTTOM_GRADIENT
float sinDirection = vWorldDirectionNormalized.z;
float w = max(0.0, (sinDirection - uSinBottomAngle) / (1.0 - uSinBottomAngle));
vec3 gradientColor = mix(uBottomColor, uTopColor, pow(w, uExponent));
modelOutColorGamma = gradientColor;
#else
modelOutColorGamma = uTopColor;
#endif  // SIMPLE_USE_BOTTOM_GRADIENT
#endif    // SKY_MODEL_SIMPLE
modelOutColorLinear = gammaToLinear(modelOutColorGamma);
#ifdef USE_FOG
float distance = length(vPositionV);
modelOutColorLinear = addFog(modelOutColorLinear, distance, vPositionW);
#endif  // USE_FOG
#ifdef HDR_OUTPUT
fragColor = hdrEncode(10.0 * modelOutColorLinear);
#else
#ifdef USE_FOG
vec3 colorExposed =
pow(camera_exposure_gamma.x * modelOutColorLinear, vec3(camera_exposure_gamma.y));
modelOutColorGamma = linearToGammaToneMapped(colorExposed);
#endif  // USE_FOG
#ifdef USE_COLORMAP
fragColor = vec4(colormap(colorMap, modelOutColorGamma, uColorMapIntensity), 1.0);
#else
fragColor = vec4(modelOutColorGamma, 1.0);
#endif  // USE_COLORMAP
#endif    // HDR_OUTPUT
}
`,"procedural_sky_vertex.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform CameraBuffer {
mat4 projectionMatrix;
mat4 viewProjMatrix;
mat4 viewMatrix;
mat4 invViewMatrix;
vec4 cameraPosition_pad;
};
#define uCameraPosition cameraPosition_pad.xyz
#endif
mat4 getModelViewMatrix() {
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
return modelViewMatrix;
#else
#ifdef MODEL_MATRIX
return viewMatrix * modelMatrix;
#else
return viewMatrix;
#endif
#endif
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#define MODEL_MATRIX
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = projectionMatrix * modelViewMatrix * worldPos;
}
#else  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec4 worldPos) {
#ifdef MODEL_MATRIX
gl_Position = viewProjMatrix * modelMatrix * worldPos;
#else
gl_Position = viewProjMatrix * worldPos;
#endif  // MODEL_MATRIX
}
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec3 worldPos) {
setClipPositionFromWorldPos(vec4(worldPos, 1.0));
}
void setClipPositionFromViewPos(in vec4 viewPos) {
gl_Position = projectionMatrix * viewPos;
}
void setClipPositionFromViewPos(in vec3 viewPos) {
setClipPositionFromViewPos(vec4(viewPos, 1.0));
}
vec3 multiplyPositionByModelMatrix(in vec4 position) {
#ifdef MODEL_MATRIX
return (modelMatrix * position).xyz;
#else
return position.xyz;
#endif
}
vec3 multiplyPositionByModelMatrix(in vec3 position) {
return multiplyPositionByModelMatrix(vec4(position, 1.0));
}
vec3 multiplyDirectionByModelMatrix(in vec3 direction) {
#ifdef MODEL_MATRIX
return (modelMatrix * vec4(direction, 0.0)).xyz;
#else
return direction;
#endif
}
#ifdef USE_FOG
out vec3 vPositionW;
out vec3 vPositionV;
#endif
out vec3 vWorldDirection;
void main() {
vec3 positionW = multiplyPositionByModelMatrix(position);
vWorldDirection = positionW - uCameraPosition;
#ifdef USE_FOG
vPositionW = positionW;
vPositionV = -(getModelViewMatrix() * vec4(position, 1.0)).xyz;
setClipPositionFromViewPos(-vPositionV);
#else
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
gl_Position = projectionMatrix * getModelViewMatrix() * vec4(position, 1.0);
#else
gl_Position = viewProjMatrix * vec4(positionW, 1.0);
#endif
#endif
}
`,"reprojected_position_fragment.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform GlobalBuffer {
mat4 unjitteredInvProjMatrix;
mat4 unjitteredPrevViewProjMatrix;
vec4 viewSpaceFrustumRayDirections[4];
vec4 viewSpaceFrustumRayOrigins[4];
vec2 zNear_zFar;
vec4 fogDistStart_DistDensity_HeightStart_HeightDensity;
vec4 fogColor;
vec4 camera_exposure_gamma;
float colorMapIntensity;
float time;
vec2 texelSize;
vec2 renderTargetSize;
float deltaTime;
float velocityFactor;
vec2 jitterOffset;
float temporalAaHistoryWeight;
bool allTaaSamplesAccumulated;
vec2 neighbourhoodTexelOffsets[8];
float accumulatedStaticTaaSamples;
vec4 screenResolution;
float lightmapMode;
float dynamicTaaHistoryMultiplier;
};
#define uFogColor fogColor.xyz
#endif
vec4 encodeNormalizedFloatsToRGBA8(float value1, float value2) {
float scaledValue1 = value1 * 65535.0;
float scaledValue2 = value2 * 65535.0;
vec4 encoded;
encoded.r = floor(scaledValue1 / 256.0) / 255.0;                 // High byte
encoded.g = floor(fract(scaledValue1 / 256.0) * 256.0) / 255.0;  // Low byte
encoded.b = floor(scaledValue2 / 256.0) / 255.0;                 // High byte
encoded.a = floor(fract(scaledValue2 / 256.0) * 256.0) / 255.0;  // Low byte
return encoded;
}
in vec4 vPrevPosition;
void main() {
vec2 prevPos = vPrevPosition.xy / vPrevPosition.w;
prevPos = prevPos * 0.5 + vec2(0.5, 0.5);
reprojectedUvResult = encodeNormalizedFloatsToRGBA8(prevPos.x, prevPos.y);
}
`,"reprojected_position_vertex.glsl":`vec4 transformPosition() {
return vec4(t0.x * position.x + t0.y * position.y + t0.z * position.z + t0.w,
t1.x * position.x + t1.y * position.y + t1.z * position.z + t1.w,
t2.x * position.x + t2.y * position.y + t2.z * position.z + t2.w, 1.0);
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform CameraBuffer {
mat4 projectionMatrix;
mat4 viewProjMatrix;
mat4 viewMatrix;
mat4 invViewMatrix;
vec4 cameraPosition_pad;
};
#define uCameraPosition cameraPosition_pad.xyz
#endif
mat4 getModelViewMatrix() {
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
return modelViewMatrix;
#else
#ifdef MODEL_MATRIX
return viewMatrix * modelMatrix;
#else
return viewMatrix;
#endif
#endif
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#define MODEL_MATRIX
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = projectionMatrix * modelViewMatrix * worldPos;
}
#else  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec4 worldPos) {
#ifdef MODEL_MATRIX
gl_Position = viewProjMatrix * modelMatrix * worldPos;
#else
gl_Position = viewProjMatrix * worldPos;
#endif  // MODEL_MATRIX
}
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec3 worldPos) {
setClipPositionFromWorldPos(vec4(worldPos, 1.0));
}
void setClipPositionFromViewPos(in vec4 viewPos) {
gl_Position = projectionMatrix * viewPos;
}
void setClipPositionFromViewPos(in vec3 viewPos) {
setClipPositionFromViewPos(vec4(viewPos, 1.0));
}
vec3 multiplyPositionByModelMatrix(in vec4 position) {
#ifdef MODEL_MATRIX
return (modelMatrix * position).xyz;
#else
return position.xyz;
#endif
}
vec3 multiplyPositionByModelMatrix(in vec3 position) {
return multiplyPositionByModelMatrix(vec4(position, 1.0));
}
vec3 multiplyDirectionByModelMatrix(in vec3 direction) {
#ifdef MODEL_MATRIX
return (modelMatrix * vec4(direction, 0.0)).xyz;
#else
return direction;
#endif
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform GlobalBuffer {
mat4 unjitteredInvProjMatrix;
mat4 unjitteredPrevViewProjMatrix;
vec4 viewSpaceFrustumRayDirections[4];
vec4 viewSpaceFrustumRayOrigins[4];
vec2 zNear_zFar;
vec4 fogDistStart_DistDensity_HeightStart_HeightDensity;
vec4 fogColor;
vec4 camera_exposure_gamma;
float colorMapIntensity;
float time;
vec2 texelSize;
vec2 renderTargetSize;
float deltaTime;
float velocityFactor;
vec2 jitterOffset;
float temporalAaHistoryWeight;
bool allTaaSamplesAccumulated;
vec2 neighbourhoodTexelOffsets[8];
float accumulatedStaticTaaSamples;
vec4 screenResolution;
float lightmapMode;
float dynamicTaaHistoryMultiplier;
};
#define uFogColor fogColor.xyz
#endif
out vec4 vPrevPosition;
void main() {
vec4 worldPos = transformPosition();
setClipPositionFromWorldPos(worldPos);
vPrevPosition = unjitteredPrevViewProjMatrix * prevModelMatrix * worldPos;
}
`,"reprojected_uv_fragment.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform GlobalBuffer {
mat4 unjitteredInvProjMatrix;
mat4 unjitteredPrevViewProjMatrix;
vec4 viewSpaceFrustumRayDirections[4];
vec4 viewSpaceFrustumRayOrigins[4];
vec2 zNear_zFar;
vec4 fogDistStart_DistDensity_HeightStart_HeightDensity;
vec4 fogColor;
vec4 camera_exposure_gamma;
float colorMapIntensity;
float time;
vec2 texelSize;
vec2 renderTargetSize;
float deltaTime;
float velocityFactor;
vec2 jitterOffset;
float temporalAaHistoryWeight;
bool allTaaSamplesAccumulated;
vec2 neighbourhoodTexelOffsets[8];
float accumulatedStaticTaaSamples;
vec4 screenResolution;
float lightmapMode;
float dynamicTaaHistoryMultiplier;
};
#define uFogColor fogColor.xyz
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform CameraBuffer {
mat4 projectionMatrix;
mat4 viewProjMatrix;
mat4 viewMatrix;
mat4 invViewMatrix;
vec4 cameraPosition_pad;
};
#define uCameraPosition cameraPosition_pad.xyz
#endif
in vec2 vUv0;
in vec3 vWorldRayDir;
in vec3 vWorldRayOrigin;
float getLinearDepth(float depth) {
float zNdc = depth * 2.0 - 1.0;
float m22 = projectionMatrix[2][2];
float m23 = projectionMatrix[2][3];
float m32 = projectionMatrix[3][2];
float m33 = projectionMatrix[3][3];
return -(zNdc * m33 - m32) / (zNdc * m23 - m22);
}
vec3 getWorldPosFromDepth(float depth) {
float linearDepth = getLinearDepth(depth);
return vWorldRayOrigin + vWorldRayDir * linearDepth;
}
vec2 getPrevFrameReprojectedUv(float depth) {
vec3 worldPos = getWorldPosFromDepth(depth);
vec4 prevPos = unjitteredPrevViewProjMatrix * vec4(worldPos, 1.0);
return vec2(prevPos.xy / prevPos.w) * 0.5 + 0.5;
}
vec4 encodeNormalizedFloatsToRGBA8(float value1, float value2) {
float scaledValue1 = value1 * 65535.0;
float scaledValue2 = value2 * 65535.0;
vec4 encoded;
encoded.r = floor(scaledValue1 / 256.0) / 255.0;                 // High byte
encoded.g = floor(fract(scaledValue1 / 256.0) * 256.0) / 255.0;  // Low byte
encoded.b = floor(scaledValue2 / 256.0) / 255.0;                 // High byte
encoded.a = floor(fract(scaledValue2 / 256.0) * 256.0) / 255.0;  // Low byte
return encoded;
}
vec2 getReprojectedUv(vec2 uv) {
float currentDepth = texture(tDepth, uv).r;
vec2 reprojectedUv = getPrevFrameReprojectedUv(currentDepth);
return reprojectedUv;
}
void main() {
vec2 reprojectedUv = getReprojectedUv(vUv0);
vec4 encodedUv = encodeNormalizedFloatsToRGBA8(reprojectedUv.x, reprojectedUv.y);
reprojectedUvResult = encodedUv;
}
`,"rotate_gizmo_material_fragment.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform CameraBuffer {
mat4 projectionMatrix;
mat4 viewProjMatrix;
mat4 viewMatrix;
mat4 invViewMatrix;
vec4 cameraPosition_pad;
};
#define uCameraPosition cameraPosition_pad.xyz
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec3 uColor;
uniform float opacity;
uniform vec3 uGizmoPosition;
uniform float sphereRadius;
#endif
in vec4 mPosition;
void discardIfRayIntersectsSphere(vec3 r0, vec3 rd, vec3 s0, float sr) {
float a = dot(rd, rd);
vec3 s0_r0 = r0 - s0;
float b = 2.0 * dot(rd, s0_r0);
float c = dot(s0_r0, s0_r0) - (sr * sr);
float delta = b * b - 4.0 * a * c;
if (delta >= 0.0 && -b - sqrt(delta) > 0.0) {
discard;
}
}
void main() {
vec4 outColor;
outColor.rgb = uColor;
outColor.a = opacity;
vec3 toCamera = normalize(uCameraPosition - uGizmoPosition);
discardIfRayIntersectsSphere(mPosition.xyz, toCamera, uGizmoPosition, sphereRadius);
fragColor = outColor;
}
`,"rotate_gizmo_material_vertex.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform CameraBuffer {
mat4 projectionMatrix;
mat4 viewProjMatrix;
mat4 viewMatrix;
mat4 invViewMatrix;
vec4 cameraPosition_pad;
};
#define uCameraPosition cameraPosition_pad.xyz
#endif
vec4 transformPosition() {
return vec4(t0.x * position.x + t0.y * position.y + t0.z * position.z + t0.w,
t1.x * position.x + t1.y * position.y + t1.z * position.z + t1.w,
t2.x * position.x + t2.y * position.y + t2.z * position.z + t2.w, 1.0);
}
mat4 getModelViewMatrix() {
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
return modelViewMatrix;
#else
#ifdef MODEL_MATRIX
return viewMatrix * modelMatrix;
#else
return viewMatrix;
#endif
#endif
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#define MODEL_MATRIX
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = projectionMatrix * modelViewMatrix * worldPos;
}
#else  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec4 worldPos) {
#ifdef MODEL_MATRIX
gl_Position = viewProjMatrix * modelMatrix * worldPos;
#else
gl_Position = viewProjMatrix * worldPos;
#endif  // MODEL_MATRIX
}
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec3 worldPos) {
setClipPositionFromWorldPos(vec4(worldPos, 1.0));
}
void setClipPositionFromViewPos(in vec4 viewPos) {
gl_Position = projectionMatrix * viewPos;
}
void setClipPositionFromViewPos(in vec3 viewPos) {
setClipPositionFromViewPos(vec4(viewPos, 1.0));
}
vec3 multiplyPositionByModelMatrix(in vec4 position) {
#ifdef MODEL_MATRIX
return (modelMatrix * position).xyz;
#else
return position.xyz;
#endif
}
vec3 multiplyPositionByModelMatrix(in vec3 position) {
return multiplyPositionByModelMatrix(vec4(position, 1.0));
}
vec3 multiplyDirectionByModelMatrix(in vec3 direction) {
#ifdef MODEL_MATRIX
return (modelMatrix * vec4(direction, 0.0)).xyz;
#else
return direction;
#endif
}
out vec4 mPosition;
void main() {
mPosition = vec4(multiplyPositionByModelMatrix(position), 1.0);
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);
gl_Position = projectionMatrix * mvPosition;
#else
gl_Position = viewProjMatrix * mPosition;
#endif
}
`,"shadowmap_fragment.glsl":`const float PI = 3.14159265358979;
const float RECIPROCAL_PI2 = 0.15915494;
float saturate(in float a) {
return clamp(a, 0.0, 1.0);
}
vec3 inverseTransformDirection(in vec3 normal, in mat4 matrix) {
return normalize((vec4(normal, 0.0) * matrix).xyz);
}
#ifdef USE_CUTOUT
vec3 rgbToHsl(vec3 rgb) {
vec3 hsl = vec3(0.0);
float fMin = min(min(rgb.r, rgb.g), rgb.b);
float fMax = max(max(rgb.r, rgb.g), rgb.b);
float delta = fMax - fMin;
hsl.z = (fMax + fMin) / 2.0;  // Luminance
if (delta == 0.0) {
return hsl;
}
hsl.y = delta / ((hsl.z <= 0.5) ? (fMax + fMin) : (2.0 - fMax - fMin));
float denom = 6.0 * delta;
if (rgb.r == fMax) {
hsl.x = (rgb.g - rgb.b) / denom;
} else if (rgb.g == fMax) {
hsl.x = (rgb.b - rgb.r) / denom + (1.0 / 3.0);
} else if (rgb.b == fMax) {
hsl.x = (rgb.r - rgb.g) / denom + (2.0 / 3.0);
}
if (hsl.x < 0.0) {
hsl.x += 1.0;
}
if (hsl.x > 1.0) {
hsl.x -= 1.0;
}
return hsl;
}
float hueToRgb(float p, float q, float hue) {
if (hue < 0.0) {
hue += 1.0;
}
if (hue > 1.0) {
hue -= 1.0;
}
float res;
if (6.0 * hue < 1.0) {
res = p + (q - p) * 6.0 * hue;
} else if (2.0 * hue < 1.0) {
res = q;
} else if (3.0 * hue < 2.0) {
res = p + (q - p) * ((2.0 / 3.0) - hue) * 6.0;
} else {
res = p;
}
return res;
}
vec3 hslToRgb(vec3 hsl) {
vec3 rgb;
if (hsl.y == 0.0) {
return vec3(hsl.z);
}
float q = hsl.z < 0.5 ? hsl.z * (1.0 + hsl.y) : (hsl.z + hsl.y) - (hsl.y * hsl.z);
float p = 2.0 * hsl.z - q;
rgb.r = hueToRgb(p, q, hsl.x + (1.0 / 3.0));
rgb.g = hueToRgb(p, q, hsl.x);
rgb.b = hueToRgb(p, q, hsl.x - (1.0 / 3.0));
return rgb;
}
vec3 adjustContrast(vec3 col, float contrast) {
float factor = (1.0 + contrast);
return clamp(vec3(factor * (col.r - 0.5) + 0.5, factor * (col.g - 0.5) + 0.5,
factor * (col.b - 0.5) + 0.5),
vec3(0.0), vec3(1.0));
}
float modOne(float x) {
if (x < 0.0) {
return 1.0 - (float(int(x)) - x);
}
return x - float(int(x));
}
float adjustComponent(float component, float adjustment) {
return clamp(component * (1.0 + adjustment), 0.0, 1.0);
}
float adjustContrastInComponent(float component, float contrast) {
return clamp((1.0 + contrast) * (component - 0.5) + 0.5, 0.0, 1.0);
}
vec3 applyBaseColorCorrection(vec3 color, vec4 colorCorrection) {
if (colorCorrection.x != 0.0 || colorCorrection.y != 0.0 || colorCorrection.z != 0.0) {
vec3 colorInHSL = rgbToHsl(color);
colorInHSL = vec3(modOne(colorInHSL.x + colorCorrection.x),
adjustComponent(colorInHSL.y, colorCorrection.y),
adjustComponent(colorInHSL.z, colorCorrection.z));
color = hslToRgb(colorInHSL);
}
if (colorCorrection.a == 0.0)
return color;
return adjustContrast(color, colorCorrection.a);
}
float desaturate(vec4 color) {
float minComp = min(min(color.r, color.g), color.b);
float maxComp = max(max(color.r, color.g), color.b);
return minComp * 0.5 + maxComp * 0.5;
}
float applyMapCorrection(vec4 color, vec4 correction) {
float value = desaturate(color);
float inversion = correction.r;
float scale = correction.g;
float contrast = correction.b;
value = clamp(scale * value + inversion, 0.0, 1.0);
if (contrast == 0.0)
return value;
value = adjustContrastInComponent(value, contrast);
return value;
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#ifdef ANTI_TILING_REGULAR
uniform float antiTilingRegularStepX;
uniform float antiTilingRegularStepY;
uniform float antiTilingRegularMaxOffsetX;
uniform float antiTilingRegularMaxOffsetY;
#endif
#endif
float hash(vec2 p) {
vec3 p3 = fract(vec3(p.xyx) * 0.13);
p3 += dot(p3, p3.yzx + 3.333);
return fract((p3.x + p3.y) * p3.z);
}
float noise2d(vec2 x) {
vec2 i = floor(x);
vec2 f = fract(x);
float a = hash(i);
float b = hash(i + vec2(1.0, 0.0));
float c = hash(i + vec2(0.0, 1.0));
float d = hash(i + vec2(1.0, 1.0));
vec2 u = f * f * (3.0 - 2.0 * f);
return mix(a, b, u.x) + (c - a) * u.y * (1.0 - u.x) + (d - b) * u.x * u.y;
}
float sum(vec3 v) {
return v.x + v.y + v.z;
}
vec4 textureNoTileOrganic(sampler2D sampler, in vec2 x) {
float k = noise2d(x);
vec2 duvdx = dFdx(x);
vec2 duvdy = dFdy(x);
float l = k * 8.0;
float f = fract(l);
float ia = floor(l + 0.5);
float ib = floor(l);
f = min(f, 1.0 - f) * 2.0;
vec2 offa = sin(vec2(3.0, 7.0) * ia);
vec2 offb = sin(vec2(3.0, 7.0) * ib);
vec3 cola = textureGrad(sampler, x + offa, duvdx, duvdy).xyz;
vec3 colb = textureGrad(sampler, x + offb, duvdx, duvdy).xyz;
vec3 res = mix(cola, colb, smoothstep(0.1, 0.9, f - 0.1 * sum(cola - colb)));
return vec4(res.x, res.y, res.z, texture(sampler, x).a);
}
float toStepX(float x) {
#ifdef ANTI_TILING_REGULAR
float stepVal = antiTilingRegularStepX;
return floor(x * antiTilingRegularMaxOffsetX / stepVal) * stepVal;
#else
return floor(x);
#endif
}
float toStepY(float x) {
#ifdef ANTI_TILING_REGULAR
float stepVal = antiTilingRegularStepY;
return floor(x * antiTilingRegularMaxOffsetY / stepVal) * stepVal;
#else
return floor(x);
#endif
}
vec4 hash4(vec2 p) {
return fract(tan(vec4(1.0 + dot(p, vec2(37.0, 17.0)), 2.0 + dot(p, vec2(11.0, 47.0)),
3.0 + dot(p, vec2(41.0, 29.0)), 4.0 + dot(p, vec2(23.0, 31.0)))) *
103.0);
}
vec4 textureNoTilerRegular(sampler2D samp, in vec2 uv) {
vec2 iuv = floor(uv);
vec2 fuv = fract(uv);
vec4 ofa = hash4(iuv + vec2(0.0, 0.0));
vec4 ofb = hash4(iuv + vec2(1.0, 0.0));
vec4 ofc = hash4(iuv + vec2(0.0, 1.0));
vec4 ofd = hash4(iuv + vec2(1.0, 1.0));
vec2 ddx = dFdx(uv);
vec2 ddy = dFdy(uv);
#ifdef ANTI_TILING_REGULAR_MIRROR_X
ofa.z = sign(ofa.z - 0.5);
ofb.z = sign(ofb.z - 0.5);
ofc.z = sign(ofc.z - 0.5);
ofd.z = sign(ofd.z - 0.5);
#else
ofa.z = 1.0;
ofb.z = 1.0;
ofc.z = 1.0;
ofd.z = 1.0;
#endif
#ifdef ANTI_TILING_REGULAR_MIRROR_Y
ofa.w = sign(ofa.w - 0.5);
ofb.w = sign(ofb.w - 0.5);
ofc.w = sign(ofc.w - 0.5);
ofd.w = sign(ofd.w - 0.5);
#else
ofa.w = 1.0;
ofb.w = 1.0;
ofc.w = 1.0;
ofd.w = 1.0;
#endif
vec2 uva = uv * ofa.zw + vec2(toStepX(ofa.x), toStepY(ofa.y));
vec2 ddxa = ddx * ofa.zw;
vec2 ddya = ddy * ofa.zw;
vec2 uvb = uv * ofb.zw + vec2(toStepX(ofb.x), toStepY(ofb.y));
vec2 ddxb = ddx * ofb.zw;
vec2 ddyb = ddy * ofb.zw;
vec2 uvc = uv * ofc.zw + vec2(toStepX(ofc.x), toStepY(ofc.y));
vec2 ddxc = ddx * ofc.zw;
vec2 ddyc = ddy * ofc.zw;
vec2 uvd = uv * ofd.zw + vec2(toStepX(ofd.x), toStepY(ofd.y));
vec2 ddxd = ddx * ofd.zw;
vec2 ddyd = ddy * ofd.zw;
vec2 b = smoothstep(0.45, 0.55, fuv);
return mix(mix(textureGrad(samp, uva, ddxa, ddya), textureGrad(samp, uvb, ddxb, ddyb), b.x),
mix(textureGrad(samp, uvc, ddxc, ddyc), textureGrad(samp, uvd, ddxd, ddyd), b.x), b.y);
}
vec4 textureWithOptionalAntiTiling(sampler2D text, in vec2 uv) {
#ifdef ANTI_TILING_ORGANIC
return textureNoTileOrganic(text, uv);
#else
#ifdef ANTI_TILING_REGULAR
return textureNoTilerRegular(text, uv);
#else
return texture(text, uv);
#endif
#endif
}
#ifdef USE_BASE_COLOR_TEXTURE
uniform sampler2D baseColorTexture;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec4 baseColorAtlasUvMod;
uniform float alphaDiscardThreshold;
#endif
#else
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec3 uBaseColor;
#endif
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform float opacity;
#ifdef USE_CUTOUT_MASK
uniform float cutoutMaskThreshold;
#endif
uniform vec4 baseColorCorrection;
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
vec3 getBaseColorHook(out float alpha);
vec3 getBaseColor(out float alpha) {
#ifdef USE_BASE_COLOR_TEXTURE
vec2 uv = vUv0;
#ifdef USE_BASE_COLOR_TEXTURE_ATLAS_REPEAT
vec2 uvScaled = uv * baseColorAtlasUvMod.zw;
vec2 dfdx = dFdx(uvScaled);
vec2 dfdy = dFdy(uvScaled);
uv = fract(uv) * baseColorAtlasUvMod.zw + baseColorAtlasUvMod.xy;
vec4 baseColorGamma = textureGrad(baseColorTexture, uv, dfdx, dfdy);
float textureAlpha = baseColorGamma.a;
#else
uv = uv * baseColorAtlasUvMod.zw + baseColorAtlasUvMod.xy;
#ifdef USE_ALPHA_IN_LOWER_HALF
vec4 baseColorGamma = textureWithOptionalAntiTiling(baseColorTexture, vec2(uv.x, .5 + .5 * uv.y));
float textureAlpha = texture(baseColorTexture, vec2(uv.x, .5 * uv.y)).r;
#else
vec4 baseColorGamma = textureWithOptionalAntiTiling(baseColorTexture, uv);
float textureAlpha = baseColorGamma.a;
#endif
#endif
vec3 baseColor = gammaToLinear(baseColorGamma.rgb);
#ifdef USE_CUTOUT_MASK
alpha = step(cutoutMaskThreshold, textureAlpha);
if (alpha == 0.0)
discard;
#else
alpha = opacity * textureAlpha;
#endif
vec3 resultBaseColor = applyBaseColorCorrection(baseColor, baseColorCorrection);
#else  // NOT USE_BASE_COLOR_TEXTURE
alpha = opacity;
vec3 resultBaseColor = uBaseColor;
#endif
return resultBaseColor;
}
in vec2 vUv0;
#endif
void main() {
#ifdef USE_CUTOUT
float alpha;
getBaseColor(alpha);
#endif
}
`,"sprite_vertex.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform CameraBuffer {
mat4 projectionMatrix;
mat4 viewProjMatrix;
mat4 viewMatrix;
mat4 invViewMatrix;
vec4 cameraPosition_pad;
};
#define uCameraPosition cameraPosition_pad.xyz
#endif
mat4 getModelViewMatrix() {
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
return modelViewMatrix;
#else
#ifdef MODEL_MATRIX
return viewMatrix * modelMatrix;
#else
return viewMatrix;
#endif
#endif
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#define MODEL_MATRIX
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = projectionMatrix * modelViewMatrix * worldPos;
}
#else  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec4 worldPos) {
#ifdef MODEL_MATRIX
gl_Position = viewProjMatrix * modelMatrix * worldPos;
#else
gl_Position = viewProjMatrix * worldPos;
#endif  // MODEL_MATRIX
}
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec3 worldPos) {
setClipPositionFromWorldPos(vec4(worldPos, 1.0));
}
void setClipPositionFromViewPos(in vec4 viewPos) {
gl_Position = projectionMatrix * viewPos;
}
void setClipPositionFromViewPos(in vec3 viewPos) {
setClipPositionFromViewPos(vec4(viewPos, 1.0));
}
vec3 multiplyPositionByModelMatrix(in vec4 position) {
#ifdef MODEL_MATRIX
return (modelMatrix * position).xyz;
#else
return position.xyz;
#endif
}
vec3 multiplyPositionByModelMatrix(in vec3 position) {
return multiplyPositionByModelMatrix(vec4(position, 1.0));
}
vec3 multiplyDirectionByModelMatrix(in vec3 direction) {
#ifdef MODEL_MATRIX
return (modelMatrix * vec4(direction, 0.0)).xyz;
#else
return direction;
#endif
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec3 uOffset;
#endif
#ifdef USE_FOG
out vec3 vPositionW;
out vec3 vPositionV;
#endif
out vec2 vUv0;
void main() {
vUv0 = uv0;
vec4 mvPosition = getModelViewMatrix() * vec4(uOffset, 1.0);
vec2 scale;
#ifdef USE_FOG
vPositionW = multiplyPositionByModelMatrix(uOffset);
vPositionV = -mvPosition.xyz;
#endif
#ifdef MODEL_MATRIX
scale.x = length(modelMatrix[0].xyz);
scale.y = length(modelMatrix[1].xyz);
#else
scale = vec2(1.0);
#endif
vec2 alignedPosition = position.xy * scale;
mvPosition.xy += alignedPosition;
gl_Position = projectionMatrix * mvPosition;
}
`,"ssao_back_depth_fragment.glsl":`const float PI = 3.14159265358979;
const float RECIPROCAL_PI2 = 0.15915494;
float saturate(in float a) {
return clamp(a, 0.0, 1.0);
}
vec3 inverseTransformDirection(in vec3 normal, in mat4 matrix) {
return normalize((vec4(normal, 0.0) * matrix).xyz);
}
#ifdef USE_CUTOUT
vec3 rgbToHsl(vec3 rgb) {
vec3 hsl = vec3(0.0);
float fMin = min(min(rgb.r, rgb.g), rgb.b);
float fMax = max(max(rgb.r, rgb.g), rgb.b);
float delta = fMax - fMin;
hsl.z = (fMax + fMin) / 2.0;  // Luminance
if (delta == 0.0) {
return hsl;
}
hsl.y = delta / ((hsl.z <= 0.5) ? (fMax + fMin) : (2.0 - fMax - fMin));
float denom = 6.0 * delta;
if (rgb.r == fMax) {
hsl.x = (rgb.g - rgb.b) / denom;
} else if (rgb.g == fMax) {
hsl.x = (rgb.b - rgb.r) / denom + (1.0 / 3.0);
} else if (rgb.b == fMax) {
hsl.x = (rgb.r - rgb.g) / denom + (2.0 / 3.0);
}
if (hsl.x < 0.0) {
hsl.x += 1.0;
}
if (hsl.x > 1.0) {
hsl.x -= 1.0;
}
return hsl;
}
float hueToRgb(float p, float q, float hue) {
if (hue < 0.0) {
hue += 1.0;
}
if (hue > 1.0) {
hue -= 1.0;
}
float res;
if (6.0 * hue < 1.0) {
res = p + (q - p) * 6.0 * hue;
} else if (2.0 * hue < 1.0) {
res = q;
} else if (3.0 * hue < 2.0) {
res = p + (q - p) * ((2.0 / 3.0) - hue) * 6.0;
} else {
res = p;
}
return res;
}
vec3 hslToRgb(vec3 hsl) {
vec3 rgb;
if (hsl.y == 0.0) {
return vec3(hsl.z);
}
float q = hsl.z < 0.5 ? hsl.z * (1.0 + hsl.y) : (hsl.z + hsl.y) - (hsl.y * hsl.z);
float p = 2.0 * hsl.z - q;
rgb.r = hueToRgb(p, q, hsl.x + (1.0 / 3.0));
rgb.g = hueToRgb(p, q, hsl.x);
rgb.b = hueToRgb(p, q, hsl.x - (1.0 / 3.0));
return rgb;
}
vec3 adjustContrast(vec3 col, float contrast) {
float factor = (1.0 + contrast);
return clamp(vec3(factor * (col.r - 0.5) + 0.5, factor * (col.g - 0.5) + 0.5,
factor * (col.b - 0.5) + 0.5),
vec3(0.0), vec3(1.0));
}
float modOne(float x) {
if (x < 0.0) {
return 1.0 - (float(int(x)) - x);
}
return x - float(int(x));
}
float adjustComponent(float component, float adjustment) {
return clamp(component * (1.0 + adjustment), 0.0, 1.0);
}
float adjustContrastInComponent(float component, float contrast) {
return clamp((1.0 + contrast) * (component - 0.5) + 0.5, 0.0, 1.0);
}
vec3 applyBaseColorCorrection(vec3 color, vec4 colorCorrection) {
if (colorCorrection.x != 0.0 || colorCorrection.y != 0.0 || colorCorrection.z != 0.0) {
vec3 colorInHSL = rgbToHsl(color);
colorInHSL = vec3(modOne(colorInHSL.x + colorCorrection.x),
adjustComponent(colorInHSL.y, colorCorrection.y),
adjustComponent(colorInHSL.z, colorCorrection.z));
color = hslToRgb(colorInHSL);
}
if (colorCorrection.a == 0.0)
return color;
return adjustContrast(color, colorCorrection.a);
}
float desaturate(vec4 color) {
float minComp = min(min(color.r, color.g), color.b);
float maxComp = max(max(color.r, color.g), color.b);
return minComp * 0.5 + maxComp * 0.5;
}
float applyMapCorrection(vec4 color, vec4 correction) {
float value = desaturate(color);
float inversion = correction.r;
float scale = correction.g;
float contrast = correction.b;
value = clamp(scale * value + inversion, 0.0, 1.0);
if (contrast == 0.0)
return value;
value = adjustContrastInComponent(value, contrast);
return value;
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#ifdef ANTI_TILING_REGULAR
uniform float antiTilingRegularStepX;
uniform float antiTilingRegularStepY;
uniform float antiTilingRegularMaxOffsetX;
uniform float antiTilingRegularMaxOffsetY;
#endif
#endif
float hash(vec2 p) {
vec3 p3 = fract(vec3(p.xyx) * 0.13);
p3 += dot(p3, p3.yzx + 3.333);
return fract((p3.x + p3.y) * p3.z);
}
float noise2d(vec2 x) {
vec2 i = floor(x);
vec2 f = fract(x);
float a = hash(i);
float b = hash(i + vec2(1.0, 0.0));
float c = hash(i + vec2(0.0, 1.0));
float d = hash(i + vec2(1.0, 1.0));
vec2 u = f * f * (3.0 - 2.0 * f);
return mix(a, b, u.x) + (c - a) * u.y * (1.0 - u.x) + (d - b) * u.x * u.y;
}
float sum(vec3 v) {
return v.x + v.y + v.z;
}
vec4 textureNoTileOrganic(sampler2D sampler, in vec2 x) {
float k = noise2d(x);
vec2 duvdx = dFdx(x);
vec2 duvdy = dFdy(x);
float l = k * 8.0;
float f = fract(l);
float ia = floor(l + 0.5);
float ib = floor(l);
f = min(f, 1.0 - f) * 2.0;
vec2 offa = sin(vec2(3.0, 7.0) * ia);
vec2 offb = sin(vec2(3.0, 7.0) * ib);
vec3 cola = textureGrad(sampler, x + offa, duvdx, duvdy).xyz;
vec3 colb = textureGrad(sampler, x + offb, duvdx, duvdy).xyz;
vec3 res = mix(cola, colb, smoothstep(0.1, 0.9, f - 0.1 * sum(cola - colb)));
return vec4(res.x, res.y, res.z, texture(sampler, x).a);
}
float toStepX(float x) {
#ifdef ANTI_TILING_REGULAR
float stepVal = antiTilingRegularStepX;
return floor(x * antiTilingRegularMaxOffsetX / stepVal) * stepVal;
#else
return floor(x);
#endif
}
float toStepY(float x) {
#ifdef ANTI_TILING_REGULAR
float stepVal = antiTilingRegularStepY;
return floor(x * antiTilingRegularMaxOffsetY / stepVal) * stepVal;
#else
return floor(x);
#endif
}
vec4 hash4(vec2 p) {
return fract(tan(vec4(1.0 + dot(p, vec2(37.0, 17.0)), 2.0 + dot(p, vec2(11.0, 47.0)),
3.0 + dot(p, vec2(41.0, 29.0)), 4.0 + dot(p, vec2(23.0, 31.0)))) *
103.0);
}
vec4 textureNoTilerRegular(sampler2D samp, in vec2 uv) {
vec2 iuv = floor(uv);
vec2 fuv = fract(uv);
vec4 ofa = hash4(iuv + vec2(0.0, 0.0));
vec4 ofb = hash4(iuv + vec2(1.0, 0.0));
vec4 ofc = hash4(iuv + vec2(0.0, 1.0));
vec4 ofd = hash4(iuv + vec2(1.0, 1.0));
vec2 ddx = dFdx(uv);
vec2 ddy = dFdy(uv);
#ifdef ANTI_TILING_REGULAR_MIRROR_X
ofa.z = sign(ofa.z - 0.5);
ofb.z = sign(ofb.z - 0.5);
ofc.z = sign(ofc.z - 0.5);
ofd.z = sign(ofd.z - 0.5);
#else
ofa.z = 1.0;
ofb.z = 1.0;
ofc.z = 1.0;
ofd.z = 1.0;
#endif
#ifdef ANTI_TILING_REGULAR_MIRROR_Y
ofa.w = sign(ofa.w - 0.5);
ofb.w = sign(ofb.w - 0.5);
ofc.w = sign(ofc.w - 0.5);
ofd.w = sign(ofd.w - 0.5);
#else
ofa.w = 1.0;
ofb.w = 1.0;
ofc.w = 1.0;
ofd.w = 1.0;
#endif
vec2 uva = uv * ofa.zw + vec2(toStepX(ofa.x), toStepY(ofa.y));
vec2 ddxa = ddx * ofa.zw;
vec2 ddya = ddy * ofa.zw;
vec2 uvb = uv * ofb.zw + vec2(toStepX(ofb.x), toStepY(ofb.y));
vec2 ddxb = ddx * ofb.zw;
vec2 ddyb = ddy * ofb.zw;
vec2 uvc = uv * ofc.zw + vec2(toStepX(ofc.x), toStepY(ofc.y));
vec2 ddxc = ddx * ofc.zw;
vec2 ddyc = ddy * ofc.zw;
vec2 uvd = uv * ofd.zw + vec2(toStepX(ofd.x), toStepY(ofd.y));
vec2 ddxd = ddx * ofd.zw;
vec2 ddyd = ddy * ofd.zw;
vec2 b = smoothstep(0.45, 0.55, fuv);
return mix(mix(textureGrad(samp, uva, ddxa, ddya), textureGrad(samp, uvb, ddxb, ddyb), b.x),
mix(textureGrad(samp, uvc, ddxc, ddyc), textureGrad(samp, uvd, ddxd, ddyd), b.x), b.y);
}
vec4 textureWithOptionalAntiTiling(sampler2D text, in vec2 uv) {
#ifdef ANTI_TILING_ORGANIC
return textureNoTileOrganic(text, uv);
#else
#ifdef ANTI_TILING_REGULAR
return textureNoTilerRegular(text, uv);
#else
return texture(text, uv);
#endif
#endif
}
#ifdef USE_BASE_COLOR_TEXTURE
uniform sampler2D baseColorTexture;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec4 baseColorAtlasUvMod;
uniform float alphaDiscardThreshold;
#endif
#else
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec3 uBaseColor;
#endif
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform float opacity;
#ifdef USE_CUTOUT_MASK
uniform float cutoutMaskThreshold;
#endif
uniform vec4 baseColorCorrection;
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
vec3 getBaseColorHook(out float alpha);
vec3 getBaseColor(out float alpha) {
#ifdef USE_BASE_COLOR_TEXTURE
vec2 uv = vUv0;
#ifdef USE_BASE_COLOR_TEXTURE_ATLAS_REPEAT
vec2 uvScaled = uv * baseColorAtlasUvMod.zw;
vec2 dfdx = dFdx(uvScaled);
vec2 dfdy = dFdy(uvScaled);
uv = fract(uv) * baseColorAtlasUvMod.zw + baseColorAtlasUvMod.xy;
vec4 baseColorGamma = textureGrad(baseColorTexture, uv, dfdx, dfdy);
float textureAlpha = baseColorGamma.a;
#else
uv = uv * baseColorAtlasUvMod.zw + baseColorAtlasUvMod.xy;
#ifdef USE_ALPHA_IN_LOWER_HALF
vec4 baseColorGamma = textureWithOptionalAntiTiling(baseColorTexture, vec2(uv.x, .5 + .5 * uv.y));
float textureAlpha = texture(baseColorTexture, vec2(uv.x, .5 * uv.y)).r;
#else
vec4 baseColorGamma = textureWithOptionalAntiTiling(baseColorTexture, uv);
float textureAlpha = baseColorGamma.a;
#endif
#endif
vec3 baseColor = gammaToLinear(baseColorGamma.rgb);
#ifdef USE_CUTOUT_MASK
alpha = step(cutoutMaskThreshold, textureAlpha);
if (alpha == 0.0)
discard;
#else
alpha = opacity * textureAlpha;
#endif
vec3 resultBaseColor = applyBaseColorCorrection(baseColor, baseColorCorrection);
#else  // NOT USE_BASE_COLOR_TEXTURE
alpha = opacity;
vec3 resultBaseColor = uBaseColor;
#endif
return resultBaseColor;
}
in vec2 vUv0;
#endif
in vec3 vNormalV;
in vec3 vPositionV;
uniform mat4 uProjectionMatrix;
uniform vec2 uViewportSize;
uniform vec2 uInvViewportSize;
uniform sampler2D tDepthTex;
const float minDiff = 0.2;
float depthToZView(float depthValue) {
float zndc = depthValue * 2.0 - 1.0;
return -(zndc * uProjectionMatrix[3][3] - uProjectionMatrix[3][2]) /
(zndc * uProjectionMatrix[2][3] - uProjectionMatrix[2][2]);
}
void main() {
#ifdef USE_CUTOUT
float alpha;
getBaseColor(alpha);
#endif
vec2 texCoord = gl_FragCoord.xy * uInvViewportSize;
float currentZView = depthToZView(gl_FragCoord.z);
float frontZView = depthToZView(texture(tDepthTex, texCoord).x);
if (currentZView + minDiff > frontZView)
discard;
fragColor = vec4(0.0);
}
`,"ssao_fragment.glsl":`const float PI = 3.14159265358979;
const float RECIPROCAL_PI2 = 0.15915494;
float saturate(in float a) {
return clamp(a, 0.0, 1.0);
}
vec3 inverseTransformDirection(in vec3 normal, in mat4 matrix) {
return normalize((vec4(normal, 0.0) * matrix).xyz);
}
uniform sampler2D tNormalsTex;
uniform sampler2D tDepthTex;
uniform sampler2D tBackDepthTex;
uniform mat4 uProjectionMatrix;
uniform mat4 uInvProjectionMatrix;
uniform vec2 uViewportSize;
uniform vec2 uInvViewportSize;
uniform vec2 uViewportSizeMinusOne;
uniform vec2 uInvViewportSizeMinusOne;
uniform vec4 uViewFrustumVectors[4];
uniform vec4 uSsaoConfig;
#define NUM_DIRECTIONS 8
#define NUM_STEPS 8
#define ENABLE_FALLOFF 1
const float directionOffset = 0.0;
const float stepOffset = 0.0;
float depthToZView(float depthValue) {
float zndc = depthValue * 2.0 - 1.0;
return -(zndc * uProjectionMatrix[3][3] - uProjectionMatrix[3][2]) /
(zndc * uProjectionMatrix[2][3] - uProjectionMatrix[2][2]);
}
vec3 getPositionVS(vec4 frustumVectorBaseDiff, vec2 texCoord) {
float z = depthToZView(texture(tDepthTex, texCoord).x);
return vec3((frustumVectorBaseDiff.xy + frustumVectorBaseDiff.zw * texCoord) * z, z);
}
vec3 getPositionBackVS(vec4 frustumVectorBaseDiff, vec2 texCoord) {
float z = depthToZView(texture(tBackDepthTex, texCoord).x);
return vec3((frustumVectorBaseDiff.xy + frustumVectorBaseDiff.zw * texCoord) * z, z);
}
vec2 angleToDir(float angle) {
float s = sin(angle), c = cos(angle);
return vec2(c, s);
}
vec2 snapToTexel(vec2 uv) {
return round(uv * uViewportSizeMinusOne) * uInvViewportSizeMinusOne;
}
float random1D(vec2 xy) {
return fract(sin(dot(xy, vec2(12.9898, 78.233))) * 43758.5453);
}
vec3 random3D(vec2 xy) {
return vec3(random1D(xy), random1D(xy * vec2(1.31231, -2.24231)),
random1D(xy * vec2(-1.97489, 1.6786785)));
}
float _round(float f) {
return f < 0.5 ? floor(f) : ceil(f);
}
vec2 _round(vec2 v) {
v.x = _round(v.x);
v.y = _round(v.y);
return v;
}
float falloff(float dist2) {
#if ENABLE_FALLOFF
float start2 = uSsaoConfig.z, end2 = uSsaoConfig.w;
return 2.0 * clamp((dist2 - start2) / (end2 - start2), 0.0, 1.0);
#else
return 0.0;
#endif
}
void main() {
vec2 screenCoord = gl_FragCoord.xy;
vec2 texCoord = gl_FragCoord.xy * uInvViewportSize;
vec2 frustumVectorBase = vec2(uViewFrustumVectors[0].xy);
vec2 frustumVectorDiff = vec2(uViewFrustumVectors[1].x - uViewFrustumVectors[0].x,
uViewFrustumVectors[2].y - uViewFrustumVectors[0].y);
vec4 frustumVectorBaseDiff = vec4(frustumVectorBase, frustumVectorDiff);
if (texture(tDepthTex, texCoord).x == 1.0) {
fragColor = vec4(1.0);
return;
}
vec3 positionV = getPositionVS(frustumVectorBaseDiff, texCoord);
vec3 normalV = normalize(texture(tNormalsTex, texCoord).xyz * 2.0 - 1.0);
vec3 random = random3D(texCoord);
vec3 vpos = positionV;
vec3 vnorm = normalV;
vec3 vdir = normalize(-vpos.xyz);
vec2 noises = vec2(0.0);
vec2 horizons = vec2(-1.0, -1.0);
float rotJitterOffset = PI * random.x;
float radiusJitterOffset = random.y - 0.5;
float radiusBase = uSsaoConfig.x, radiusScale = uSsaoConfig.y;
float radius = ((radiusBase + radiusJitterOffset) * radiusScale) / -vpos.z;
radius = max(float(NUM_STEPS), radius);
float stepSize = radius / float(NUM_STEPS);
float phi = 0.0, ao = 0.0;
float division = noises.y * stepSize;
float currStep = 1.0 + division + 0.25 * stepSize * stepOffset;
float dist2, invdist, cosh;
for (int i = 0; i < NUM_DIRECTIONS; i++) {
phi = float(i) * (PI / float(NUM_DIRECTIONS)) + directionOffset * PI + rotJitterOffset;
currStep = 1.0 + 0.25 * stepSize * stepOffset;
vec3 dir = vec3(cos(phi), sin(phi), 0.0);
horizons = vec2(-1.0);
for (int j = 0; j < NUM_STEPS; ++j) {
vec2 offset = _round(dir.xy * currStep);
vec3 s = getPositionVS(frustumVectorBaseDiff, (screenCoord + offset) * uInvViewportSize);
vec3 ws = s.xyz - vpos.xyz;
dist2 = dot(ws, ws);
invdist = inversesqrt(dist2);
cosh = invdist * dot(ws, vdir);
horizons.x = max(horizons.x, cosh - falloff(dist2));
s = getPositionVS(frustumVectorBaseDiff, (screenCoord - offset) * uInvViewportSize);
ws = s.xyz - vpos.xyz;
dist2 = dot(ws, ws);
invdist = inversesqrt(dist2);
cosh = invdist * dot(ws, vdir);
horizons.y = max(horizons.y, cosh - falloff(dist2));
currStep += stepSize;
}
horizons = acos(horizons);
vec3 bitangent = normalize(cross(dir, vdir));
vec3 tangent = cross(vdir, bitangent);
vec3 nx = vnorm - bitangent * dot(vnorm, bitangent);
float nnx = length(nx);
float invnnx = 1.0 / (nnx + 1e-6);        // to avoid division with zero
float cosxi = dot(nx, tangent) * invnnx;  // xi = gamma + PI * 0.5
float gamma = acos(cosxi) - PI * 0.5;
float cosgamma = dot(nx, vdir) * invnnx;
float singamma2 = -2.0 * cosxi;  // cos(x + PI * 0.5) = -sin(x)
horizons.x = gamma + max(-horizons.x - gamma, -PI * 0.5);
horizons.y = gamma + min(horizons.y - gamma, PI * 0.5);
ao += nnx * 0.25 *
((horizons.x * singamma2 + cosgamma - cos(2.0 * horizons.x - gamma)) +
(horizons.y * singamma2 + cosgamma - cos(2.0 * horizons.y - gamma)));
}
ao = ao / float(NUM_DIRECTIONS);
fragColor = vec4(vec3(ao), 1.0);
}
`,"ssao_input_fragment.glsl":`const float PI = 3.14159265358979;
const float RECIPROCAL_PI2 = 0.15915494;
float saturate(in float a) {
return clamp(a, 0.0, 1.0);
}
vec3 inverseTransformDirection(in vec3 normal, in mat4 matrix) {
return normalize((vec4(normal, 0.0) * matrix).xyz);
}
#ifdef USE_CUTOUT
vec3 rgbToHsl(vec3 rgb) {
vec3 hsl = vec3(0.0);
float fMin = min(min(rgb.r, rgb.g), rgb.b);
float fMax = max(max(rgb.r, rgb.g), rgb.b);
float delta = fMax - fMin;
hsl.z = (fMax + fMin) / 2.0;  // Luminance
if (delta == 0.0) {
return hsl;
}
hsl.y = delta / ((hsl.z <= 0.5) ? (fMax + fMin) : (2.0 - fMax - fMin));
float denom = 6.0 * delta;
if (rgb.r == fMax) {
hsl.x = (rgb.g - rgb.b) / denom;
} else if (rgb.g == fMax) {
hsl.x = (rgb.b - rgb.r) / denom + (1.0 / 3.0);
} else if (rgb.b == fMax) {
hsl.x = (rgb.r - rgb.g) / denom + (2.0 / 3.0);
}
if (hsl.x < 0.0) {
hsl.x += 1.0;
}
if (hsl.x > 1.0) {
hsl.x -= 1.0;
}
return hsl;
}
float hueToRgb(float p, float q, float hue) {
if (hue < 0.0) {
hue += 1.0;
}
if (hue > 1.0) {
hue -= 1.0;
}
float res;
if (6.0 * hue < 1.0) {
res = p + (q - p) * 6.0 * hue;
} else if (2.0 * hue < 1.0) {
res = q;
} else if (3.0 * hue < 2.0) {
res = p + (q - p) * ((2.0 / 3.0) - hue) * 6.0;
} else {
res = p;
}
return res;
}
vec3 hslToRgb(vec3 hsl) {
vec3 rgb;
if (hsl.y == 0.0) {
return vec3(hsl.z);
}
float q = hsl.z < 0.5 ? hsl.z * (1.0 + hsl.y) : (hsl.z + hsl.y) - (hsl.y * hsl.z);
float p = 2.0 * hsl.z - q;
rgb.r = hueToRgb(p, q, hsl.x + (1.0 / 3.0));
rgb.g = hueToRgb(p, q, hsl.x);
rgb.b = hueToRgb(p, q, hsl.x - (1.0 / 3.0));
return rgb;
}
vec3 adjustContrast(vec3 col, float contrast) {
float factor = (1.0 + contrast);
return clamp(vec3(factor * (col.r - 0.5) + 0.5, factor * (col.g - 0.5) + 0.5,
factor * (col.b - 0.5) + 0.5),
vec3(0.0), vec3(1.0));
}
float modOne(float x) {
if (x < 0.0) {
return 1.0 - (float(int(x)) - x);
}
return x - float(int(x));
}
float adjustComponent(float component, float adjustment) {
return clamp(component * (1.0 + adjustment), 0.0, 1.0);
}
float adjustContrastInComponent(float component, float contrast) {
return clamp((1.0 + contrast) * (component - 0.5) + 0.5, 0.0, 1.0);
}
vec3 applyBaseColorCorrection(vec3 color, vec4 colorCorrection) {
if (colorCorrection.x != 0.0 || colorCorrection.y != 0.0 || colorCorrection.z != 0.0) {
vec3 colorInHSL = rgbToHsl(color);
colorInHSL = vec3(modOne(colorInHSL.x + colorCorrection.x),
adjustComponent(colorInHSL.y, colorCorrection.y),
adjustComponent(colorInHSL.z, colorCorrection.z));
color = hslToRgb(colorInHSL);
}
if (colorCorrection.a == 0.0)
return color;
return adjustContrast(color, colorCorrection.a);
}
float desaturate(vec4 color) {
float minComp = min(min(color.r, color.g), color.b);
float maxComp = max(max(color.r, color.g), color.b);
return minComp * 0.5 + maxComp * 0.5;
}
float applyMapCorrection(vec4 color, vec4 correction) {
float value = desaturate(color);
float inversion = correction.r;
float scale = correction.g;
float contrast = correction.b;
value = clamp(scale * value + inversion, 0.0, 1.0);
if (contrast == 0.0)
return value;
value = adjustContrastInComponent(value, contrast);
return value;
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#ifdef ANTI_TILING_REGULAR
uniform float antiTilingRegularStepX;
uniform float antiTilingRegularStepY;
uniform float antiTilingRegularMaxOffsetX;
uniform float antiTilingRegularMaxOffsetY;
#endif
#endif
float hash(vec2 p) {
vec3 p3 = fract(vec3(p.xyx) * 0.13);
p3 += dot(p3, p3.yzx + 3.333);
return fract((p3.x + p3.y) * p3.z);
}
float noise2d(vec2 x) {
vec2 i = floor(x);
vec2 f = fract(x);
float a = hash(i);
float b = hash(i + vec2(1.0, 0.0));
float c = hash(i + vec2(0.0, 1.0));
float d = hash(i + vec2(1.0, 1.0));
vec2 u = f * f * (3.0 - 2.0 * f);
return mix(a, b, u.x) + (c - a) * u.y * (1.0 - u.x) + (d - b) * u.x * u.y;
}
float sum(vec3 v) {
return v.x + v.y + v.z;
}
vec4 textureNoTileOrganic(sampler2D sampler, in vec2 x) {
float k = noise2d(x);
vec2 duvdx = dFdx(x);
vec2 duvdy = dFdy(x);
float l = k * 8.0;
float f = fract(l);
float ia = floor(l + 0.5);
float ib = floor(l);
f = min(f, 1.0 - f) * 2.0;
vec2 offa = sin(vec2(3.0, 7.0) * ia);
vec2 offb = sin(vec2(3.0, 7.0) * ib);
vec3 cola = textureGrad(sampler, x + offa, duvdx, duvdy).xyz;
vec3 colb = textureGrad(sampler, x + offb, duvdx, duvdy).xyz;
vec3 res = mix(cola, colb, smoothstep(0.1, 0.9, f - 0.1 * sum(cola - colb)));
return vec4(res.x, res.y, res.z, texture(sampler, x).a);
}
float toStepX(float x) {
#ifdef ANTI_TILING_REGULAR
float stepVal = antiTilingRegularStepX;
return floor(x * antiTilingRegularMaxOffsetX / stepVal) * stepVal;
#else
return floor(x);
#endif
}
float toStepY(float x) {
#ifdef ANTI_TILING_REGULAR
float stepVal = antiTilingRegularStepY;
return floor(x * antiTilingRegularMaxOffsetY / stepVal) * stepVal;
#else
return floor(x);
#endif
}
vec4 hash4(vec2 p) {
return fract(tan(vec4(1.0 + dot(p, vec2(37.0, 17.0)), 2.0 + dot(p, vec2(11.0, 47.0)),
3.0 + dot(p, vec2(41.0, 29.0)), 4.0 + dot(p, vec2(23.0, 31.0)))) *
103.0);
}
vec4 textureNoTilerRegular(sampler2D samp, in vec2 uv) {
vec2 iuv = floor(uv);
vec2 fuv = fract(uv);
vec4 ofa = hash4(iuv + vec2(0.0, 0.0));
vec4 ofb = hash4(iuv + vec2(1.0, 0.0));
vec4 ofc = hash4(iuv + vec2(0.0, 1.0));
vec4 ofd = hash4(iuv + vec2(1.0, 1.0));
vec2 ddx = dFdx(uv);
vec2 ddy = dFdy(uv);
#ifdef ANTI_TILING_REGULAR_MIRROR_X
ofa.z = sign(ofa.z - 0.5);
ofb.z = sign(ofb.z - 0.5);
ofc.z = sign(ofc.z - 0.5);
ofd.z = sign(ofd.z - 0.5);
#else
ofa.z = 1.0;
ofb.z = 1.0;
ofc.z = 1.0;
ofd.z = 1.0;
#endif
#ifdef ANTI_TILING_REGULAR_MIRROR_Y
ofa.w = sign(ofa.w - 0.5);
ofb.w = sign(ofb.w - 0.5);
ofc.w = sign(ofc.w - 0.5);
ofd.w = sign(ofd.w - 0.5);
#else
ofa.w = 1.0;
ofb.w = 1.0;
ofc.w = 1.0;
ofd.w = 1.0;
#endif
vec2 uva = uv * ofa.zw + vec2(toStepX(ofa.x), toStepY(ofa.y));
vec2 ddxa = ddx * ofa.zw;
vec2 ddya = ddy * ofa.zw;
vec2 uvb = uv * ofb.zw + vec2(toStepX(ofb.x), toStepY(ofb.y));
vec2 ddxb = ddx * ofb.zw;
vec2 ddyb = ddy * ofb.zw;
vec2 uvc = uv * ofc.zw + vec2(toStepX(ofc.x), toStepY(ofc.y));
vec2 ddxc = ddx * ofc.zw;
vec2 ddyc = ddy * ofc.zw;
vec2 uvd = uv * ofd.zw + vec2(toStepX(ofd.x), toStepY(ofd.y));
vec2 ddxd = ddx * ofd.zw;
vec2 ddyd = ddy * ofd.zw;
vec2 b = smoothstep(0.45, 0.55, fuv);
return mix(mix(textureGrad(samp, uva, ddxa, ddya), textureGrad(samp, uvb, ddxb, ddyb), b.x),
mix(textureGrad(samp, uvc, ddxc, ddyc), textureGrad(samp, uvd, ddxd, ddyd), b.x), b.y);
}
vec4 textureWithOptionalAntiTiling(sampler2D text, in vec2 uv) {
#ifdef ANTI_TILING_ORGANIC
return textureNoTileOrganic(text, uv);
#else
#ifdef ANTI_TILING_REGULAR
return textureNoTilerRegular(text, uv);
#else
return texture(text, uv);
#endif
#endif
}
#ifdef USE_BASE_COLOR_TEXTURE
uniform sampler2D baseColorTexture;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec4 baseColorAtlasUvMod;
uniform float alphaDiscardThreshold;
#endif
#else
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec3 uBaseColor;
#endif
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform float opacity;
#ifdef USE_CUTOUT_MASK
uniform float cutoutMaskThreshold;
#endif
uniform vec4 baseColorCorrection;
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
vec3 getBaseColorHook(out float alpha);
vec3 getBaseColor(out float alpha) {
#ifdef USE_BASE_COLOR_TEXTURE
vec2 uv = vUv0;
#ifdef USE_BASE_COLOR_TEXTURE_ATLAS_REPEAT
vec2 uvScaled = uv * baseColorAtlasUvMod.zw;
vec2 dfdx = dFdx(uvScaled);
vec2 dfdy = dFdy(uvScaled);
uv = fract(uv) * baseColorAtlasUvMod.zw + baseColorAtlasUvMod.xy;
vec4 baseColorGamma = textureGrad(baseColorTexture, uv, dfdx, dfdy);
float textureAlpha = baseColorGamma.a;
#else
uv = uv * baseColorAtlasUvMod.zw + baseColorAtlasUvMod.xy;
#ifdef USE_ALPHA_IN_LOWER_HALF
vec4 baseColorGamma = textureWithOptionalAntiTiling(baseColorTexture, vec2(uv.x, .5 + .5 * uv.y));
float textureAlpha = texture(baseColorTexture, vec2(uv.x, .5 * uv.y)).r;
#else
vec4 baseColorGamma = textureWithOptionalAntiTiling(baseColorTexture, uv);
float textureAlpha = baseColorGamma.a;
#endif
#endif
vec3 baseColor = gammaToLinear(baseColorGamma.rgb);
#ifdef USE_CUTOUT_MASK
alpha = step(cutoutMaskThreshold, textureAlpha);
if (alpha == 0.0)
discard;
#else
alpha = opacity * textureAlpha;
#endif
vec3 resultBaseColor = applyBaseColorCorrection(baseColor, baseColorCorrection);
#else  // NOT USE_BASE_COLOR_TEXTURE
alpha = opacity;
vec3 resultBaseColor = uBaseColor;
#endif
return resultBaseColor;
}
in vec2 vUv0;
#endif
in vec3 vNormalV;
in vec3 vPositionV;
void main() {
#ifdef USE_CUTOUT
float alpha;
getBaseColor(alpha);
#endif
vec3 dx = dFdx(vPositionV);
vec3 dy = dFdy(vPositionV);
vec3 normalV = normalize(cross(dx, dy));
fragColor = vec4(vec3(normalV * 0.5) + vec3(0.5), 1.0);
}
`,"standard_material_fragment.glsl":`const float PI = 3.14159265358979;
const float RECIPROCAL_PI2 = 0.15915494;
float saturate(in float a) {
return clamp(a, 0.0, 1.0);
}
vec3 inverseTransformDirection(in vec3 normal, in mat4 matrix) {
return normalize((vec4(normal, 0.0) * matrix).xyz);
}
float _g2l(in float x) {
return (x <= 0.04045) ? x / 12.92 : pow((x + 0.055) / 1.055, 2.4);
}
vec3 gammaToLinear(in vec3 rgb) {
return vec3(_g2l(rgb.r), _g2l(rgb.g), _g2l(rgb.b));
}
float _l2g(in float x) {
return (x <= 0.0031308) ? x * 12.92 : pow(x, 1.0 / 2.4) * 1.055 - 0.055;
}
vec3 linearToGamma(in vec3 rgb) {
return vec3(_l2g(rgb.r), _l2g(rgb.g), _l2g(rgb.b));
}
vec3 hable(in vec3 rgb) {
float A = 0.15;  // shoulderStrength
float B = 0.50;  // linearStrength
float C = 0.10;  // linearAngle
float D = 0.20;  // toeStrength
float E = 0.02;  // toeNumerator
float F = 0.30;  // toeDenominator
return ((rgb * (A * rgb + C * B) + D * E) / (rgb * (A * rgb + B) + D * F)) - E / F;
}
vec3 toneMappingHable(in vec3 rgb) {
float exposure = 11.2;
float exposureBias = 2.0;
vec3 current = hable(exposureBias * rgb);
vec3 whiteScale = 1.0 / hable(vec3(exposure));
return pow(current * whiteScale, vec3(1.0 / 2.2));
}
vec3 uchimura(in vec3 x, in float P, in float a, in float m, in float l, in float c, in float b) {
float l0 = ((P - m) * l) / a;
float L0 = m - m / a;
float L1 = m + (1.0 - m) / a;
float S0 = m + l0;
float S1 = m + a * l0;
float C2 = (a * P) / (P - S1);
float CP = -C2 / P;
vec3 w0 = vec3(1.0 - smoothstep(0.0, m, x));
vec3 w2 = vec3(step(m + l0, x));
vec3 w1 = vec3(1.0 - w0 - w2);
vec3 T = vec3(m * pow(x / m, vec3(c)) + b);
vec3 S = vec3(P - (P - S1) * exp(CP * (x - S0)));
vec3 L = vec3(m + a * (x - m));
return T * w0 + L * w1 + S * w2;
}
vec3 toneMappingUchimura(in vec3 rgb) {
float P = 1.0;   // max display brightness
float a = 1.0;   // contrast
float m = 0.22;  // linear section start
float l = 0.4;   // linear section length
float c = 1.45;  // black
float b = 0.0;   // pedestal
return pow(uchimura(rgb, P, a, m, l, c, b), vec3(1.0 / 2.2));
}
vec3 toneMappingUnreal(in vec3 rgb) {
return rgb / (rgb + 0.187) * 1.035;
}
vec3 linearToGammaToneMapped(in vec3 rgb) {
#ifdef TONE_MAPPING_UNREAL
return toneMappingUnreal(rgb);
#endif
#ifdef TONE_MAPPING_HABLE
return toneMappingHable(rgb);
#endif
#ifdef TONE_MAPPING_UCHIMURA
return toneMappingUchimura(rgb);
#endif
return toneMappingUnreal(rgb);
}
vec4 cubic(in float v) {
vec4 n = vec4(1.0, 2.0, 3.0, 4.0) - v;
vec4 s = n * n * n;
float x = s.x;
float y = s.y - 4.0 * s.x;
float z = s.z - 4.0 * s.y + 6.0 * s.x;
float w = 6.0 - x - y - z;
return vec4(x, y, z, w) * (1.0 / 6.0);
}
vec3 hdrDecodeRgbm(in vec4 rgbm) {
const float rgbmScale = 2.82842712;  // sqrt(8)
float m = 1.0 - rgbm.a;
vec3 r = rgbm.rgb * (rgbmScale * m);
return r * r;
}
vec3 hdrDecodeYcocgm(in vec4 ycocgm, in vec2 threshold) {
const float ycocgmLumaRange = 16.0;
float m = ycocgm.w * (16.0 * 255.0 / 256.0) - 1.0;
float chroma_scale_factor = fract(m);
float y_factor = m - chroma_scale_factor;
chroma_scale_factor = 1.0 - chroma_scale_factor;
float factor = y_factor == ycocgmLumaRange - 2.0 ? 0.0 : 1.0;
float y = mix(ycocgm.x * threshold.x, (y_factor + ycocgm.x) * threshold.y + threshold.x, factor);
float co = (ycocgm.y - 0.5) * chroma_scale_factor;
float cg = (ycocgm.z - 0.5) * chroma_scale_factor;
return vec3(y, co, cg);
}
vec3 ycocgToRgb(in vec3 ycocg) {
float y = ycocg.x, co = ycocg.y, cg = ycocg.z;
y = y * y;
float r = saturate(y + co - cg);
float g = saturate(y + cg);
float b = saturate(y - co - cg);
return vec3(r, g, b) * 8.0;
}
/*vec3 hdrDecodeYcocgmBicubic(in sampler2D ycocgmSampler, in vec2 texSize, in vec2 invTexSize,
in vec2 threshold, in vec2 texCoords) {
vec2 texCoordsScaled = texCoords * texSize - 0.5;
vec2 fxy = fract(texCoordsScaled);
texCoordsScaled -= fxy;
vec4 xcubic = cubic(fxy.x), ycubic = cubic(fxy.y);
vec4 c = texCoordsScaled.xxyy + vec2(-0.5, +1.5).xyxy;
vec4 s = vec4(xcubic.xz + xcubic.yw, ycubic.xz + ycubic.yw);
vec4 offset = (c + vec4 (xcubic.yw, ycubic.yw) / s) * invTexSize.xxyy;
vec3 sample0 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.xz), threshold);
vec3 sample1 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.yz), threshold);
vec3 sample2 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.xw), threshold);
vec3 sample3 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.yw), threshold);
float sx = s.x / (s.x + s.y), sy = s.z / (s.z + s.w);
return mix(mix(sample3, sample2, sx), mix(sample1, sample0, sx), sy);
}*/
vec3 hdrDecodeYcocgmBilinear(in sampler2D ycocgmSampler, in vec2 texSize, in vec2 invTexSize,
in vec2 threshold, in vec2 texCoords) {
vec2 texCoordsScaled = texCoords * texSize - 0.5;
vec2 fxy = fract(texCoordsScaled);
texCoordsScaled -= fxy;
vec4 c = texCoordsScaled.xxyy + vec2(-0.5, +0.5).xyxy;
vec4 offset = c + vec4(1.0);
float sx = 1.0 - fxy.x;
float sy = 1.0 - fxy.y;
offset *= invTexSize.xxyy;
vec3 sample0 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.xz), threshold);
vec3 sample1 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.yz), threshold);
vec3 sample2 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.xw), threshold);
vec3 sample3 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.yw), threshold);
return mix(mix(sample3, sample2, sx), mix(sample1, sample0, sx), sy);
}
/*vec3 hdrDecodeRgbmBicubic(in sampler2D rgbmSampler, in vec2 texSize,
in vec2 invTexSize, in vec2 texCoords) {
vec2 texCoordsScaled = texCoords * texSize - 0.5;
vec2 fxy = fract(texCoordsScaled);
texCoordsScaled -= fxy;
vec4 xcubic = cubic(fxy.x), ycubic = cubic(fxy.y);
vec4 c = texCoordsScaled.xxyy + vec2(-0.5, +1.5).xyxy;
vec4 s = vec4(xcubic.xz + xcubic.yw, ycubic.xz + ycubic.yw);
vec4 offset = (c + vec4 (xcubic.yw, ycubic.yw) / s) * invTexSize.xxyy;
vec3 sample0 = hdrDecodeRgbm(texture(rgbmSampler, offset.xz));
vec3 sample1 = hdrDecodeRgbm(texture(rgbmSampler, offset.yz));
vec3 sample2 = hdrDecodeRgbm(texture(rgbmSampler, offset.xw));
vec3 sample3 = hdrDecodeRgbm(texture(rgbmSampler, offset.yw));
float sx = s.x / (s.x + s.y), sy = s.z / (s.z + s.w);
return mix(mix(sample3, sample2, sx), mix(sample1, sample0, sx), sy);
}*/
vec3 hdrDecodeRgbmBilinear(in sampler2D rgbmSampler, in vec2 texSize, in vec2 invTexSize,
in vec2 texCoords) {
vec2 texCoordsScaled = texCoords * texSize - 0.5;
vec2 fxy = fract(texCoordsScaled);
texCoordsScaled -= fxy;
vec4 c = texCoordsScaled.xxyy + vec2(-0.5, +0.5).xyxy;
vec4 offset = c + vec4(1.0);
float sx = 1.0 - fxy.x;
float sy = 1.0 - fxy.y;
offset *= invTexSize.xxyy;
vec3 sample0 = hdrDecodeRgbm(texture(rgbmSampler, offset.xz));
vec3 sample1 = hdrDecodeRgbm(texture(rgbmSampler, offset.yz));
vec3 sample2 = hdrDecodeRgbm(texture(rgbmSampler, offset.xw));
vec3 sample3 = hdrDecodeRgbm(texture(rgbmSampler, offset.yw));
return mix(mix(sample3, sample2, sx), mix(sample1, sample0, sx), sy);
}
struct ReflectionProbe {
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
vec3 boxMin;
vec3 boxMax;
vec3 posW;
#else
vec4 boxMin;
vec4 boxMax;
vec4 posW;
#endif
};
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform LightBuffer {
vec4 lightmapSize;
vec4 lightmapThreshold;
ReflectionProbe reflectionProbes[3];
int reflectionProbesCount;
};
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform GlobalBuffer {
mat4 unjitteredInvProjMatrix;
mat4 unjitteredPrevViewProjMatrix;
vec4 viewSpaceFrustumRayDirections[4];
vec4 viewSpaceFrustumRayOrigins[4];
vec2 zNear_zFar;
vec4 fogDistStart_DistDensity_HeightStart_HeightDensity;
vec4 fogColor;
vec4 camera_exposure_gamma;
float colorMapIntensity;
float time;
vec2 texelSize;
vec2 renderTargetSize;
float deltaTime;
float velocityFactor;
vec2 jitterOffset;
float temporalAaHistoryWeight;
bool allTaaSamplesAccumulated;
vec2 neighbourhoodTexelOffsets[8];
float accumulatedStaticTaaSamples;
vec4 screenResolution;
float lightmapMode;
float dynamicTaaHistoryMultiplier;
};
#define uFogColor fogColor.xyz
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform CameraBuffer {
mat4 projectionMatrix;
mat4 viewProjMatrix;
mat4 viewMatrix;
mat4 invViewMatrix;
vec4 cameraPosition_pad;
};
#define uCameraPosition cameraPosition_pad.xyz
#endif
#ifdef USE_FOG
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec4 fogDistStart_DistDensity_HeightStart_HeightDensity;
uniform vec3 uFogColor;
#endif
const float LOG2 = 1.442695;
vec3 addFog(in vec3 colorIn, in float distance, in vec3 positionW) {
float distanceValue = max(0.0, distance - fogDistStart_DistDensity_HeightStart_HeightDensity.x);
float distanceDensity = fogDistStart_DistDensity_HeightStart_HeightDensity.y;
float distanceFogExp =
1.0 - exp2(-distanceDensity * distanceDensity * distanceValue * distanceValue * LOG2);
float heightValue = max(0.0, -positionW.z + fogDistStart_DistDensity_HeightStart_HeightDensity.z);
float heightDensity = fogDistStart_DistDensity_HeightStart_HeightDensity.w;
float heightFogExp =
1.0 - exp2(-heightDensity * heightDensity * heightValue * heightValue * LOG2);
float fogAmount = min(1.0, distanceFogExp + heightFogExp);
return mix(colorIn, uFogColor.xyz, fogAmount);
}
#endif
#if defined(USE_ENVMAP) || defined(USE_HEADLIGHT) || defined(USE_FOG) || defined(LIVE_LIGHTMAP) || \\
defined(USE_SHADOWMAP)
in vec3 vPositionW;
#endif
#if defined(USE_ENVMAP) || defined(USE_HEADLIGHT) || defined(LIVE_LIGHTMAP) || \\
defined(USE_SHADOWMAP)
in vec3 vNormalW;
#endif
#if defined(USE_BASE_COLOR_TEXTURE) || defined(USE_ROUGHNESS_TEXTURE) ||                         \\
defined(USE_METALLIC_TEXTURE) || defined(USE_BUMP_TEXTURE) || defined(USE_HEIGHT_TEXTURE) || \\
defined(USE_NORMAL_TEXTURE)
in vec2 vUv0;
#endif
#if defined(USE_BUMP_TEXTURE) || defined(USE_FOG) || defined(USE_SSAO)
in vec3 vPositionV;
#endif
vec3 rgbToHsl(vec3 rgb) {
vec3 hsl = vec3(0.0);
float fMin = min(min(rgb.r, rgb.g), rgb.b);
float fMax = max(max(rgb.r, rgb.g), rgb.b);
float delta = fMax - fMin;
hsl.z = (fMax + fMin) / 2.0;  // Luminance
if (delta == 0.0) {
return hsl;
}
hsl.y = delta / ((hsl.z <= 0.5) ? (fMax + fMin) : (2.0 - fMax - fMin));
float denom = 6.0 * delta;
if (rgb.r == fMax) {
hsl.x = (rgb.g - rgb.b) / denom;
} else if (rgb.g == fMax) {
hsl.x = (rgb.b - rgb.r) / denom + (1.0 / 3.0);
} else if (rgb.b == fMax) {
hsl.x = (rgb.r - rgb.g) / denom + (2.0 / 3.0);
}
if (hsl.x < 0.0) {
hsl.x += 1.0;
}
if (hsl.x > 1.0) {
hsl.x -= 1.0;
}
return hsl;
}
float hueToRgb(float p, float q, float hue) {
if (hue < 0.0) {
hue += 1.0;
}
if (hue > 1.0) {
hue -= 1.0;
}
float res;
if (6.0 * hue < 1.0) {
res = p + (q - p) * 6.0 * hue;
} else if (2.0 * hue < 1.0) {
res = q;
} else if (3.0 * hue < 2.0) {
res = p + (q - p) * ((2.0 / 3.0) - hue) * 6.0;
} else {
res = p;
}
return res;
}
vec3 hslToRgb(vec3 hsl) {
vec3 rgb;
if (hsl.y == 0.0) {
return vec3(hsl.z);
}
float q = hsl.z < 0.5 ? hsl.z * (1.0 + hsl.y) : (hsl.z + hsl.y) - (hsl.y * hsl.z);
float p = 2.0 * hsl.z - q;
rgb.r = hueToRgb(p, q, hsl.x + (1.0 / 3.0));
rgb.g = hueToRgb(p, q, hsl.x);
rgb.b = hueToRgb(p, q, hsl.x - (1.0 / 3.0));
return rgb;
}
vec3 adjustContrast(vec3 col, float contrast) {
float factor = (1.0 + contrast);
return clamp(vec3(factor * (col.r - 0.5) + 0.5, factor * (col.g - 0.5) + 0.5,
factor * (col.b - 0.5) + 0.5),
vec3(0.0), vec3(1.0));
}
float modOne(float x) {
if (x < 0.0) {
return 1.0 - (float(int(x)) - x);
}
return x - float(int(x));
}
float adjustComponent(float component, float adjustment) {
return clamp(component * (1.0 + adjustment), 0.0, 1.0);
}
float adjustContrastInComponent(float component, float contrast) {
return clamp((1.0 + contrast) * (component - 0.5) + 0.5, 0.0, 1.0);
}
vec3 applyBaseColorCorrection(vec3 color, vec4 colorCorrection) {
if (colorCorrection.x != 0.0 || colorCorrection.y != 0.0 || colorCorrection.z != 0.0) {
vec3 colorInHSL = rgbToHsl(color);
colorInHSL = vec3(modOne(colorInHSL.x + colorCorrection.x),
adjustComponent(colorInHSL.y, colorCorrection.y),
adjustComponent(colorInHSL.z, colorCorrection.z));
color = hslToRgb(colorInHSL);
}
if (colorCorrection.a == 0.0)
return color;
return adjustContrast(color, colorCorrection.a);
}
float desaturate(vec4 color) {
float minComp = min(min(color.r, color.g), color.b);
float maxComp = max(max(color.r, color.g), color.b);
return minComp * 0.5 + maxComp * 0.5;
}
float applyMapCorrection(vec4 color, vec4 correction) {
float value = desaturate(color);
float inversion = correction.r;
float scale = correction.g;
float contrast = correction.b;
value = clamp(scale * value + inversion, 0.0, 1.0);
if (contrast == 0.0)
return value;
value = adjustContrastInComponent(value, contrast);
return value;
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#ifdef ANTI_TILING_REGULAR
uniform float antiTilingRegularStepX;
uniform float antiTilingRegularStepY;
uniform float antiTilingRegularMaxOffsetX;
uniform float antiTilingRegularMaxOffsetY;
#endif
#endif
float hash(vec2 p) {
vec3 p3 = fract(vec3(p.xyx) * 0.13);
p3 += dot(p3, p3.yzx + 3.333);
return fract((p3.x + p3.y) * p3.z);
}
float noise2d(vec2 x) {
vec2 i = floor(x);
vec2 f = fract(x);
float a = hash(i);
float b = hash(i + vec2(1.0, 0.0));
float c = hash(i + vec2(0.0, 1.0));
float d = hash(i + vec2(1.0, 1.0));
vec2 u = f * f * (3.0 - 2.0 * f);
return mix(a, b, u.x) + (c - a) * u.y * (1.0 - u.x) + (d - b) * u.x * u.y;
}
float sum(vec3 v) {
return v.x + v.y + v.z;
}
vec4 textureNoTileOrganic(sampler2D sampler, in vec2 x) {
float k = noise2d(x);
vec2 duvdx = dFdx(x);
vec2 duvdy = dFdy(x);
float l = k * 8.0;
float f = fract(l);
float ia = floor(l + 0.5);
float ib = floor(l);
f = min(f, 1.0 - f) * 2.0;
vec2 offa = sin(vec2(3.0, 7.0) * ia);
vec2 offb = sin(vec2(3.0, 7.0) * ib);
vec3 cola = textureGrad(sampler, x + offa, duvdx, duvdy).xyz;
vec3 colb = textureGrad(sampler, x + offb, duvdx, duvdy).xyz;
vec3 res = mix(cola, colb, smoothstep(0.1, 0.9, f - 0.1 * sum(cola - colb)));
return vec4(res.x, res.y, res.z, texture(sampler, x).a);
}
float toStepX(float x) {
#ifdef ANTI_TILING_REGULAR
float stepVal = antiTilingRegularStepX;
return floor(x * antiTilingRegularMaxOffsetX / stepVal) * stepVal;
#else
return floor(x);
#endif
}
float toStepY(float x) {
#ifdef ANTI_TILING_REGULAR
float stepVal = antiTilingRegularStepY;
return floor(x * antiTilingRegularMaxOffsetY / stepVal) * stepVal;
#else
return floor(x);
#endif
}
vec4 hash4(vec2 p) {
return fract(tan(vec4(1.0 + dot(p, vec2(37.0, 17.0)), 2.0 + dot(p, vec2(11.0, 47.0)),
3.0 + dot(p, vec2(41.0, 29.0)), 4.0 + dot(p, vec2(23.0, 31.0)))) *
103.0);
}
vec4 textureNoTilerRegular(sampler2D samp, in vec2 uv) {
vec2 iuv = floor(uv);
vec2 fuv = fract(uv);
vec4 ofa = hash4(iuv + vec2(0.0, 0.0));
vec4 ofb = hash4(iuv + vec2(1.0, 0.0));
vec4 ofc = hash4(iuv + vec2(0.0, 1.0));
vec4 ofd = hash4(iuv + vec2(1.0, 1.0));
vec2 ddx = dFdx(uv);
vec2 ddy = dFdy(uv);
#ifdef ANTI_TILING_REGULAR_MIRROR_X
ofa.z = sign(ofa.z - 0.5);
ofb.z = sign(ofb.z - 0.5);
ofc.z = sign(ofc.z - 0.5);
ofd.z = sign(ofd.z - 0.5);
#else
ofa.z = 1.0;
ofb.z = 1.0;
ofc.z = 1.0;
ofd.z = 1.0;
#endif
#ifdef ANTI_TILING_REGULAR_MIRROR_Y
ofa.w = sign(ofa.w - 0.5);
ofb.w = sign(ofb.w - 0.5);
ofc.w = sign(ofc.w - 0.5);
ofd.w = sign(ofd.w - 0.5);
#else
ofa.w = 1.0;
ofb.w = 1.0;
ofc.w = 1.0;
ofd.w = 1.0;
#endif
vec2 uva = uv * ofa.zw + vec2(toStepX(ofa.x), toStepY(ofa.y));
vec2 ddxa = ddx * ofa.zw;
vec2 ddya = ddy * ofa.zw;
vec2 uvb = uv * ofb.zw + vec2(toStepX(ofb.x), toStepY(ofb.y));
vec2 ddxb = ddx * ofb.zw;
vec2 ddyb = ddy * ofb.zw;
vec2 uvc = uv * ofc.zw + vec2(toStepX(ofc.x), toStepY(ofc.y));
vec2 ddxc = ddx * ofc.zw;
vec2 ddyc = ddy * ofc.zw;
vec2 uvd = uv * ofd.zw + vec2(toStepX(ofd.x), toStepY(ofd.y));
vec2 ddxd = ddx * ofd.zw;
vec2 ddyd = ddy * ofd.zw;
vec2 b = smoothstep(0.45, 0.55, fuv);
return mix(mix(textureGrad(samp, uva, ddxa, ddya), textureGrad(samp, uvb, ddxb, ddyb), b.x),
mix(textureGrad(samp, uvc, ddxc, ddyc), textureGrad(samp, uvd, ddxd, ddyd), b.x), b.y);
}
vec4 textureWithOptionalAntiTiling(sampler2D text, in vec2 uv) {
#ifdef ANTI_TILING_ORGANIC
return textureNoTileOrganic(text, uv);
#else
#ifdef ANTI_TILING_REGULAR
return textureNoTilerRegular(text, uv);
#else
return texture(text, uv);
#endif
#endif
}
#if defined(USE_BUMP_TEXTURE) || defined(USE_SSAO)
in vec3 vNormalV;
#endif
#if defined(USE_BUMP_TEXTURE)
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec4 bumpCorrection;
uniform float bumpScale;
#endif
uniform sampler2D bumpTexture;
float bumpTextureCorrected(vec2 coord) {
return applyMapCorrection(textureWithOptionalAntiTiling(bumpTexture, coord), bumpCorrection);
}
vec2 dBumpdxy() {
vec2 texdx = dFdx(vUv0);
vec2 texdy = dFdy(vUv0);
float Hll = bumpScale * bumpTextureCorrected(vUv0);
float dBx = bumpScale * bumpTextureCorrected(vUv0 + texdx) - Hll;
float dBy = bumpScale * bumpTextureCorrected(vUv0 + texdy) - Hll;
return vec2(dBx, dBy);
}
vec3 perturbNormal(in vec3 surfPos, in vec3 surfNorm) {
vec2 dBdxy = dBumpdxy();
vec3 vSigmaX = dFdx(surfPos);
vec3 vSigmaY = dFdy(surfPos);
vec3 R1 = cross(vSigmaY, surfNorm);
vec3 R2 = cross(surfNorm, vSigmaX);
float fDet = dot(vSigmaX, R1);
vec3 vGrad = sign(fDet) * (dBdxy.x * R1 + dBdxy.y * R2);
return normalize(abs(fDet) * surfNorm - vGrad);
}
#endif
#ifdef USE_BASE_COLOR_TEXTURE
uniform sampler2D baseColorTexture;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec4 baseColorAtlasUvMod;
uniform float alphaDiscardThreshold;
#endif
#else
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec3 uBaseColor;
#endif
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform float opacity;
#ifdef USE_CUTOUT_MASK
uniform float cutoutMaskThreshold;
#endif
uniform vec4 baseColorCorrection;
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
vec3 getBaseColorHook(out float alpha);
vec3 getBaseColor(out float alpha) {
#ifdef USE_BASE_COLOR_TEXTURE
vec2 uv = vUv0;
#ifdef USE_BASE_COLOR_TEXTURE_ATLAS_REPEAT
vec2 uvScaled = uv * baseColorAtlasUvMod.zw;
vec2 dfdx = dFdx(uvScaled);
vec2 dfdy = dFdy(uvScaled);
uv = fract(uv) * baseColorAtlasUvMod.zw + baseColorAtlasUvMod.xy;
vec4 baseColorGamma = textureGrad(baseColorTexture, uv, dfdx, dfdy);
float textureAlpha = baseColorGamma.a;
#else
uv = uv * baseColorAtlasUvMod.zw + baseColorAtlasUvMod.xy;
#ifdef USE_ALPHA_IN_LOWER_HALF
vec4 baseColorGamma = textureWithOptionalAntiTiling(baseColorTexture, vec2(uv.x, .5 + .5 * uv.y));
float textureAlpha = texture(baseColorTexture, vec2(uv.x, .5 * uv.y)).r;
#else
vec4 baseColorGamma = textureWithOptionalAntiTiling(baseColorTexture, uv);
float textureAlpha = baseColorGamma.a;
#endif
#endif
vec3 baseColor = gammaToLinear(baseColorGamma.rgb);
#ifdef USE_CUTOUT_MASK
alpha = step(cutoutMaskThreshold, textureAlpha);
if (alpha == 0.0)
discard;
#else
alpha = opacity * textureAlpha;
#endif
vec3 resultBaseColor = applyBaseColorCorrection(baseColor, baseColorCorrection);
#else  // NOT USE_BASE_COLOR_TEXTURE
alpha = opacity;
vec3 resultBaseColor = uBaseColor;
#endif
return resultBaseColor;
}
#ifdef LIVE_LIGHTMAP
uniform sampler2D liveLightmap;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform float lightmapMode;
uniform vec4 screenResolution;
#endif
#endif
#ifdef USE_LIGHTMAP
centroid in vec2 vUv1;
uniform sampler2D lightmap;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec4 lightmapSize;
uniform vec2 lightmapThreshold;
#endif
#endif  // NOT USE_LIGHTMAP
vec3 getLightIntensity() {
#ifdef LIVE_LIGHTMAP
if (lightmapMode == 1.0)
return texture(liveLightmap, gl_FragCoord.xy / screenResolution.xy).xyz;
if (lightmapMode == -1.0)
return vec3(1.0);
#endif
#ifdef USE_LIGHTMAP
vec2 uv = vec2(vUv1.x, vUv1.y);
#ifdef LIGHTMAP_YCOCGM
return ycocgToRgb(hdrDecodeYcocgmBilinear(lightmap, lightmapSize.xy, lightmapSize.zw,
lightmapThreshold.xy, uv));
#else  // LIGHTMAP_RGBM
return hdrDecodeRgbmBilinear(lightmap, lightmapSize.xy, lightmapSize.zw, uv);
#endif
#else  // ifndef USE_LIGHTMAP
return vec3(1.0);
#endif
}
#if defined(USE_ENVMAP)
#define USE_NORMAL_MAPPING_FUNCS
uniform sampler2D roughnessTexture;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec4 roughnessCorrection;
uniform float roughness;
#endif
float getRoughness() {
#ifdef USE_ROUGHNESS_TEXTURE
return applyMapCorrection(textureWithOptionalAntiTiling(roughnessTexture, vUv0),
roughnessCorrection);
#else
return roughness;
#endif
}
uniform sampler2D metallicTexture;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec4 metallicCorrection;
uniform float metallic;
#endif
float getMetallic() {
#ifdef USE_METALLIC_TEXTURE
return applyMapCorrection(textureWithOptionalAntiTiling(metallicTexture, vUv0),
metallicCorrection);
#else
return metallic;
#endif
}
#ifdef USE_BRDF_TEXTURE
vec2 decodeNormalizedFloatsFromRGBA8(vec4 encoded) {
float value1 = (encoded.r * 255.0 * 256.0) + (encoded.g * 255.0);
float value2 = (encoded.b * 255.0 * 256.0) + (encoded.a * 255.0);
value1 /= 65535.0;
value2 /= 65535.0;
return vec2(value1, value2);
}
uniform sampler2D brdfLUT;
#endif
vec3 envBRDFApprox(vec3 specularColor, float roughness, float NoV) {
const vec4 c0 = vec4(-1, -0.0275, -0.572, 0.022);
const vec4 c1 = vec4(1, 0.0425, 1.04, -0.04);
vec4 r = roughness * c0 + c1;
float a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;
vec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;
return specularColor * AB.x + AB.y;
}
vec3 getBrdf(float roughness, vec3 fresnel, float clampCosnv, vec3 specularColor) {
#ifdef USE_BRDF_TEXTURE
vec4 brdfEncoded = texture(brdfLUT, vec2(clampCosnv, roughness)).rgba;
vec2 brdf = decodeNormalizedFloatsFromRGBA8(brdfEncoded);
return fresnel * brdf.x + brdf.y;
#else
return envBRDFApprox(specularColor, roughness, clampCosnv);
#endif
}
uniform samplerCube envMap[MAX_REFLECTION_PROBES];
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform float envMipsCount;
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform ReflectionProbe reflectionProbes[MAX_REFLECTION_PROBES];
#ifdef USE_REFLECTION_PROBE_BLENDING
uniform int reflectionProbesCount;
#endif  // USE_REFLECTION_PROBE_BLENDING
#endif    // DEV_DISABLE_UNIFORM_BUFFERS
struct EnvMapLevel {
float mipLevel0;
float mipLevel1;
float mipMixFactor;
};
EnvMapLevel getEnvMapLevel(float roughness) {
EnvMapLevel result;
float maxMipLevel = envMipsCount - 1.0;
float mipSelector = roughness * maxMipLevel;
result.mipLevel0 = floor(mipSelector);
result.mipLevel1 = min(result.mipLevel0 + 1.0, maxMipLevel);
result.mipMixFactor = fract(mipSelector);
return result;
}
const vec3 infBox = vec3(1000.0);
vec3 cubeMapProject(vec3 reflectionW, in ReflectionProbe reflectionProbe) {
vec3 firstPlaneIntersect = (reflectionProbe.boxMax.xyz - vPositionW) / reflectionW;
vec3 secondPlaneIntersect = (reflectionProbe.boxMin.xyz - vPositionW) / reflectionW;
vec3 furthestPlane = max(firstPlaneIntersect, secondPlaneIntersect);
vec3 furthestPlaneNonNeg = step(0.0, -furthestPlane) * infBox + abs(furthestPlane);
float distance = min(min(furthestPlaneNonNeg.x, furthestPlaneNonNeg.y), furthestPlaneNonNeg.z);
vec3 intersectionPosW = vPositionW + reflectionW * distance;
return intersectionPosW - reflectionProbe.posW.xyz;
}
float signedDistanceBox(vec3 p, vec3 b, float offset) {
vec3 q = abs(p) - b;
return length(max(q, 0.0)) + min(max(q.x, max(q.y, q.z)), 0.0) - offset;
}
float getSignedDistanceField(in ReflectionProbe probe) {
vec3 halfBox = vec3(probe.boxMax - probe.boxMin) * vec3(0.5);
vec3 boxPos = vec3(probe.boxMax + probe.boxMin) * vec3(0.5);
vec3 localPos = boxPos - vPositionW;
const float offset = 0.1;
return signedDistanceBox(localPos, halfBox, offset);
}
vec3 sampleEnvMap(in EnvMapLevel envMapLevel, in vec3 reflectionW, samplerCube envMap,
int probeIndex) {
#ifdef USE_ENVMAP_PROJECT
ReflectionProbe reflectionProbe = reflectionProbes[probeIndex];
if (reflectionProbe.boxMin.x != reflectionProbe.boxMax.x)
reflectionW = cubeMapProject(reflectionW, reflectionProbe);
#endif
vec4 cubeColorRaw0 = textureLod(envMap, reflectionW, envMapLevel.mipLevel0);
vec3 cubeColor0 = hdrDecodeRgbm(cubeColorRaw0);
vec4 cubeColorRaw1 = textureLod(envMap, reflectionW, envMapLevel.mipLevel1);
vec3 cubeColor1 = hdrDecodeRgbm(cubeColorRaw1);
return mix(cubeColor0, cubeColor1, envMapLevel.mipMixFactor);
}
vec3 sampleEnvMapBlended(in EnvMapLevel envMapLevel, in vec3 reflectionW) {
#ifdef USE_REFLECTION_PROBE_BLENDING
float weight[MAX_REFLECTION_PROBES];
#ifdef USE_ENVMAP_PROJECT
for (int i = 0; i < reflectionProbesCount; i++) {
weight[i] = max(-getSignedDistanceField(reflectionProbes[i]), 0.0);
weight[i] = smoothstep(0.0, 1.0, weight[i]);
}
float weightSum = 0.0;
for (int i = 0; i < reflectionProbesCount; i++) {
weightSum += weight[i];
}
if (weightSum == 0.0) {
weight[0] = 1.0;
} else {
for (int i = 0; i < reflectionProbesCount; i++) weight[i] /= weightSum;
}
#else
for (int i = 0; i < reflectionProbesCount; i++) weight[i] = 1.0;
#endif
vec3 envColor = vec3(0.0, 0.0, 0.0);
if (weight[0] > 0.0)
envColor += sampleEnvMap(envMapLevel, reflectionW, envMap[0], 0) * weight[0];
if (reflectionProbesCount >= 2 && weight[1] > 0.0)
envColor += sampleEnvMap(envMapLevel, reflectionW, envMap[1], 1) * weight[1];
if (reflectionProbesCount >= 3 && weight[2] > 0.0)
envColor += sampleEnvMap(envMapLevel, reflectionW, envMap[2], 2) * weight[2];
#else  // not USE_REFLECTION_PROBE_BLENDING
vec3 envColor = sampleEnvMap(envMapLevel, reflectionW, envMap[0], 0);
#endif
return envColor;
}
#endif
#ifdef USE_NORMAL_TEXTURE
uniform sampler2D normalTexture;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform float normalScale;
#endif
#endif
#ifdef USE_NORMAL_MAPPING_FUNCS
vec3 computeTangent(vec2 texCoord, vec3 normalW) {
vec2 uvDiff1 = vec2(dFdx(texCoord.x), dFdy(texCoord.x));
vec2 uvDiff2 = vec2(dFdx(texCoord.y), dFdy(texCoord.y));
vec3 denormTangent = uvDiff1.x * dFdy(vPositionW) - dFdx(vPositionW) * uvDiff1.y;
vec3 tangent = denormTangent - normalW * dot(normalW, denormTangent);
float lenSq = dot(tangent, tangent);
tangent = lenSq < 1e-6 ? vec3(normalW.z, normalW.x, normalW.y) : tangent * inversesqrt(lenSq);
return tangent;
}
vec3 computeNormal() {
float faceSign = gl_FrontFacing ? 1.0 : -1.0;
#ifdef USE_NORMAL_TEXTURE
vec3 normalW = normalize(vNormalW);
vec3 tangentW = computeTangent(vUv0, normalW);
vec3 bitangentW = cross(normalW, tangentW);
vec3 value = texture(normalTexture, vUv0).xyz;
value = (value == vec3(0.0)) ? vec3(0.0, 0.0, 1.0) : value * 2.0 - 1.0;
value = tangentW * value.x * normalScale + bitangentW * value.y * normalScale + normalW * value.z;
return normalize(value) * faceSign;
#elif defined(USE_BUMP_TEXTURE)
vec3 normalPerturbedV = perturbNormal(-vPositionV, normalize(vNormalV));
return normalize(inverseTransformDirection(normalPerturbedV, viewMatrix)) * faceSign;
#else
return normalize(vNormalW) * faceSign;
#endif
}
#endif
float getEnvMapFresnel(float roughness) {
float roughness2 = roughness * roughness;
return (roughness2 - 2.0 * roughness + 1.0);
}
vec3 fresnelSchlickEnv(in vec3 specularColor, in float envMapFresnel, in float clampCosnv,
inout float opacity) {
float fresnel = 1.0 - clampCosnv;
float fresnel2 = fresnel * fresnel;
fresnel *= fresnel2 * fresnel2;
fresnel *= envMapFresnel;
opacity = opacity + (1.0 - opacity) * fresnel;
return specularColor + (1.0 - specularColor) * fresnel;
}
vec3 getSpecularColor(in vec3 baseColor, float metalic) {
const float dielectricF0 = 0.04;
return mix(vec3(dielectricF0), baseColor, metalic);
}
float getLuminance(in vec3 color) {
return 0.2126 * color.r + 0.7152 * color.g + 0.0722 * color.b;
}
#if defined(USE_ENVMAP)
vec3 addSpecular(in vec3 baseColor, in vec3 totalIntensity, inout float opacity, float metallic,
float roughness) {
vec3 totalSpec = vec3(0.0, 0.0, 0.0);
vec3 diffuseIntensity = totalIntensity * (1.0 - mix(0.04, 1.0, metallic));
vec3 viewW = normalize(uCameraPosition - vPositionW);
vec3 normalW = computeNormal();
float clampCosnv = saturate(dot(normalW, viewW));
vec3 reflectionW = normalize(reflect(-viewW, normalW));
vec3 specularColor = getSpecularColor(baseColor, metallic);
EnvMapLevel envMapLevel = getEnvMapLevel(roughness);
vec3 envColor = sampleEnvMapBlended(envMapLevel, reflectionW);
float envMapFresnel = roughness * roughness - 2.0 * roughness + 1.0;
vec3 fresnel = fresnelSchlickEnv(specularColor, envMapFresnel, clampCosnv, opacity);
float luminance = getLuminance(totalIntensity);
totalSpec = envColor * getBrdf(roughness, fresnel, clampCosnv, specularColor);
#if defined(WEAK_REFLECTION_SHADOW)
float shadowingFactor = mix(0.4, 1.0, luminance);
#else
float shadowingFactor = mix(0.4, 1.0, luminance) * mix(min(luminance, 1.0), 1.0, metallic);
#endif
return baseColor * diffuseIntensity + totalSpec * shadowingFactor;
}
vec3 addSpecular(in vec3 baseColor, in vec3 totalIntensity, inout float opacity) {
float metallic = getMetallic();
float roughness = getRoughness();
return addSpecular(baseColor, totalIntensity, opacity, metallic, roughness);
}
#else  // NOT USE_ENVMAP
vec3 addSpecular(in vec3 baseColor, in vec3 lightIntensity, in float opacity, float metallic,
float roughness) {
return baseColor * lightIntensity;
}
vec3 addSpecular(vec3 baseColor, in vec3 lightIntensity, in float opacity) {
return baseColor * lightIntensity;
}
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#ifdef USE_HIGHLIGHT
uniform vec3 uHighlight;
uniform float highlightMix;
#endif
#endif
#if defined(HDR_OUTPUT)
vec4 hdrEncode(in vec3 rgb) {
const float rgbmScale = 2.82842712;  // sqrt(8)
vec3 r = sqrt(rgb) / rgbmScale;
float m = max(max(r.r, r.g), r.b);
m = clamp(m, 1.0 / 255.0, 1.0);
m = ceil(m * 255.0) / 255.0;
r /= m;
return vec4(r.r, r.g, r.b, (1.0 - m));
}
#endif
#ifdef USE_COLORMAP
vec3 colormap(in sampler2D lut, in vec3 color, in float intensity) {
const float resolution = 16.0;
const float maxValueIndex = resolution - 1.0;
const float sliceWidth = 1.0 / resolution;
const float slicePixelWidth = sliceWidth / resolution;
const float sliceMarginWidth = 0.5 * slicePixelWidth;
const float sliceInnerWidth = sliceWidth - slicePixelWidth;
const float slicePixelHeight = 1.0 / resolution;
const float sliceMarginHeight = 0.5 * slicePixelHeight;
const float sliceInnerHeight = 1.0 - slicePixelHeight;
float bSlice0 = min(floor(color.b * maxValueIndex), maxValueIndex - 1.0);
float bSlice1 = bSlice0 + 1.0;
float bOffset = color.b * maxValueIndex - bSlice0;
float rSlicePos = sliceMarginWidth + color.r * sliceInnerWidth;
float gSlicePos = sliceMarginHeight + color.g * sliceInnerHeight;
float rPos0 = rSlicePos + (bSlice0 * sliceWidth);
float rPos1 = rSlicePos + (bSlice1 * sliceWidth);
vec3 color0 = texture(lut, vec2(rPos0, gSlicePos)).rgb;
vec3 color1 = texture(lut, vec2(rPos1, gSlicePos)).rgb;
return mix(color, mix(color0, color1, bOffset), intensity);
}
uniform sampler2D colorMap;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform float colorMapIntensity;
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
#endif
#ifdef USE_CHROMA_KEY
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec3 uChromaKeyColor;
uniform vec3 uChromaKeyDeltaCoeff;
#endif
const float k32 = sqrt(3.0) / 2.0;
vec3 rgb2abi(vec3 color) {
float r = color.r;
float g = color.g;
float b = color.b;
return vec3(r - 0.5 * g - 0.5 * b, k32 * (g - b), 0.3333 * (r + g + b));
}
const float IPI2 = 0.5 / 3.1415926538;
vec3 rgb2hci(vec3 color) {
vec3 abi = rgb2abi(color);
return vec3(atan(abi.y, abi.x) * IPI2, length(abi.xy), abi.z);
}
float chromaKeyShapeFn(vec3 delta, vec3 color, vec3 key) {
vec3 diff = color - key;
vec3 v = delta * vec3(
0.5 - abs(abs(diff.x) - 0.5), abs(diff.y), abs(diff.z));
float x = max(v.r, max(v.g, v.b));
return x * x;
}
float chromaKeyEdgeFn(float a) {
return clamp(.2 / .5 * (a - 1.0), 0.0, 1.0);
}
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform float emissionStrength;
#ifdef USE_EXPOSURE_AND_GAMMA
uniform vec4 camera_exposure_gamma;
#else
const vec4 camera_exposure_gamma = vec4(1.0, 1.0, 0.0, 0.0);
#endif
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
vec3 addSpecularHook(in vec3 baseColor, in vec3 totalIntensity, inout float opacity);
#ifdef USE_SHADOWMAP
uniform sampler2D tShadowmap;
uniform mat4 uShadowmapMatrix;
uniform vec4 uShadowmapLightDirection;
float sampleShadowmap(vec2 coord, vec2 offset, float currentDepth) {
return currentDepth < texture(tShadowmap, coord + offset).x ? 0.0 : 1.0;
}
vec3 getShadowmapLightDirection() {
return uShadowmapLightDirection.xyz;
}
float slopeBias(vec3 shadowmapCoord) {
vec2 dU_dXY = vec2(dFdx(shadowmapCoord.x), dFdy(shadowmapCoord.x));
vec2 dV_dXY = vec2(dFdx(shadowmapCoord.y), dFdy(shadowmapCoord.y));
vec2 dz_dXY = vec2(dFdx(shadowmapCoord.z), dFdy(shadowmapCoord.z));
float detJ = dU_dXY.x * dV_dXY.y - dV_dXY.x * dU_dXY.y;
vec2 dz_dUV = vec2(0.0, 0.0);
if (detJ != 0.0) {
dz_dUV.x = dot(vec2(dV_dXY.y, -dV_dXY.x), dz_dXY) * (1.0 / detJ);
dz_dUV.y = dot(vec2(-dU_dXY.y, dU_dXY.x), dz_dXY) * (1.0 / detJ);
}
vec2 distanceToTexelCenterUV = 0.5 - fract(shadowmapCoord.xy * float(SHADOWMAP_SIZE));
distanceToTexelCenterUV *= 1.0 / (float(SHADOWMAP_SIZE));
return min(0.0, dot(distanceToTexelCenterUV, dz_dUV));
}
float receiverPlaneBias(vec3 texCoordDX, vec3 texCoordDY) {
vec2 biasUV;
biasUV.x = texCoordDY.y * texCoordDX.z - texCoordDX.y * texCoordDY.z;
biasUV.y = texCoordDX.x * texCoordDY.z - texCoordDY.x * texCoordDX.z;
biasUV *= 1.0 / ((texCoordDX.x * texCoordDY.y) - (texCoordDX.y * texCoordDY.x));
vec2 texelSize = 1.0 / vec2(SHADOWMAP_SIZE, SHADOWMAP_SIZE);
return clamp(dot(vec2(1.0, 1.0) * texelSize, abs(biasUV)), 0.0, 0.01);
}
float getShadowCheckerboard(vec3 positionW, vec3 normalW) {
vec4 shadowmapCoord = uShadowmapMatrix * vec4(positionW, 1.0);
shadowmapCoord.xyz = shadowmapCoord.xyz * 0.5 + 0.5;
if (shadowmapCoord.x < 0.0 || shadowmapCoord.x > 1.0 || shadowmapCoord.y < 0.0 ||
shadowmapCoord.y > 1.0)
return 0.0;
shadowmapCoord.xy *= float(SHADOWMAP_SIZE);
return mod(floor(shadowmapCoord.x) + floor(shadowmapCoord.y), 2.0);
}
float getShadowValue(vec3 positionW, vec3 normalW, vec3 lightDir) {
vec4 shadowmapCoord = uShadowmapMatrix * vec4(positionW, 1.0);
shadowmapCoord.xyz = shadowmapCoord.xyz * 0.5 + 0.5;
float cosTheta = dot(normalW, lightDir);
if (cosTheta < 0.02)
return 1.0;  // TODO: what is this case? it is needed though
float recBias = receiverPlaneBias(dFdx(shadowmapCoord.xyz), dFdy(shadowmapCoord.xyz));
float constantBias = 0.0002;
float currentDepth = shadowmapCoord.z - constantBias - recBias;
vec2 diff = max(dFdx(shadowmapCoord.xy), dFdy(shadowmapCoord.xy));
float filterSize = 1.0 - min(diff.x, diff.y) * float(SHADOWMAP_SIZE) * 2.0;
if (filterSize < 0.3)
return sampleShadowmap(shadowmapCoord.xy, vec2(0.0, 0.0), currentDepth);
float value = 0.0;
for (float y = -1.5; y <= 1.5; y += 1.0)
for (float x = -1.5; x <= 1.5; x += 1.0)
value += sampleShadowmap(shadowmapCoord.xy, vec2(x, y) * (1.0 / float(SHADOWMAP_SIZE)) * 0.5,
currentDepth);
return value * (1.0 / 16.0);
}
vec4 debugShadowmap() {
if (gl_FragCoord.x < 600.0 && gl_FragCoord.y < 600.0) {
vec2 coord = gl_FragCoord.xy / 600.0;
float value = texture(tShadowmap, vec2(1.0 - coord.x, coord.y)).x;
return value == 0.0 ? vec4(1.0, 0.0, 0.0, 1.0) : vec4(vec3(value), 1.0);
}
return vec4(0.0);
}
vec3 computeShadowColor(vec3 positionW, vec3 normalW) {
float sunShadow = getShadowValue(positionW, normalW, getShadowmapLightDirection());
vec3 result = vec3(0.5 + 0.5 * (1.0 - sunShadow));
#ifdef DEBUG_SHADOWMAP_CHECKERBOARD
result.x = result.x * 0.2 + getShadowCheckerboard(positionW, normalW) * 0.8;
#endif
return result;
}
#endif  // USE_SHADOWMAP
#ifdef USE_SSAO
uniform sampler2D ssao;
uniform vec2 uViewportSize;
uniform vec2 uInvViewportSize;
#endif  // USE_SSAO
void main() {
float alpha;
vec3 baseColor = getBaseColorHook(alpha);
#ifdef RENDER_CUTOUT_MODE
{
vec3 normalV = normalize(cross(dFdx(vPositionV), dFdy(vPositionV)));
fragColor = vec4(vec3(normalV * 0.5) + vec3(0.5), 1.0);
return;
}
#endif
#ifdef USE_CHROMA_KEY
float dist = chromaKeyShapeFn(uChromaKeyDeltaCoeff, rgb2hci(baseColor), rgb2hci(uChromaKeyColor));
alpha *= chromaKeyEdgeFn(dist);
#endif
#if defined(USE_BASE_COLOR_TEXTURE)
if (alpha < alphaDiscardThreshold) {
discard;
}
#endif
vec3 lightIntensity = getLightIntensity();
#ifdef USE_SSAO
lightIntensity = vec3(texture(ssao, gl_FragCoord.xy * uInvViewportSize).x);
#endif
#ifdef USE_SHADOWMAP
#ifdef DEBUG_SHADOWMAP
fragColor = debugShadowmap();
if (fragColor.a > 0.0)
return;
#endif  // DEBUG_SHADOWMAP
lightIntensity = computeShadowColor(vPositionW, vNormalW * (gl_FrontFacing ? 1.0 : -1.0));
#endif  // USE_SHADOWMAP
#ifdef USE_HIGHLIGHT
#if defined(DEV_DISABLE_UNIFORM_BUFFERS) || defined(OBJECT_HAS_HIGHLIGHT)
baseColor = mix(baseColor, uHighlight, highlightMix);
alpha = mix(alpha, 1.0, highlightMix);
#endif
#endif
vec3 diffuseSpecular = addSpecularHook(baseColor, lightIntensity, alpha);
#if defined(LIVE_LIGHTMAP) || defined(USE_HEADLIGHT)
#ifdef LIVE_LIGHTMAP
if (lightmapMode == -1.0)
#endif
{
vec3 lightW = normalize(uCameraPosition - vPositionW.xyz);
vec3 normalW = vNormalW * (gl_FrontFacing ? 1.0 : -1.0);
float pointDiffuse = max(dot(normalize(normalW), lightW), 0.0);
diffuseSpecular *= pointDiffuse;
}
#endif
vec3 diffuseSpecularEmissive = diffuseSpecular + baseColor * emissionStrength;
#ifdef USE_FOG
float distance = length(vPositionV);
diffuseSpecularEmissive = addFog(diffuseSpecularEmissive, distance, vPositionW);
#endif
#ifdef HDR_OUTPUT
if (alpha < 0.5) {
discard;
}
fragColor = hdrEncode(diffuseSpecularEmissive);
#else  // no HDR_OUTPUT
vec3 exposedColor =
pow(camera_exposure_gamma.x * diffuseSpecularEmissive.xyz, vec3(camera_exposure_gamma.y));
vec3 gammaColor = linearToGammaToneMapped(exposedColor);
#ifdef USE_COLORMAP
fragColor = vec4(colormap(colorMap, min(gammaColor, 1.0), colorMapIntensity), alpha);
#else
fragColor = vec4(gammaColor, alpha);
#endif
#endif  // no HDR_OUTPUT
}
`,"standard_material_fragment_hooks.glsl":`vec3 addSpecularHook(in vec3 baseColor, in vec3 totalIntensity, inout float opacity) {
return addSpecular(baseColor, totalIntensity, opacity);
}
vec3 getBaseColorHook(out float alpha) {
return getBaseColor(alpha);
}
`,"standard_material_vertex.glsl":`const float PI = 3.14159265358979;
const float RECIPROCAL_PI2 = 0.15915494;
float saturate(in float a) {
return clamp(a, 0.0, 1.0);
}
vec3 inverseTransformDirection(in vec3 normal, in mat4 matrix) {
return normalize((vec4(normal, 0.0) * matrix).xyz);
}
vec3 sphericalDecode(in vec2 spNormal) {
float theta = (spNormal.x / 254.0 + 0.5) * PI;
float phi = spNormal.y * (PI / 127.0);
float sinTheta = sin(theta);
return vec3(sinTheta * cos(phi), sinTheta * sin(phi), cos(theta));
}
vec4 transformPosition() {
return vec4(t0.x * position.x + t0.y * position.y + t0.z * position.z + t0.w,
t1.x * position.x + t1.y * position.y + t1.z * position.z + t1.w,
t2.x * position.x + t2.y * position.y + t2.z * position.z + t2.w, 1.0);
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform CameraBuffer {
mat4 projectionMatrix;
mat4 viewProjMatrix;
mat4 viewMatrix;
mat4 invViewMatrix;
vec4 cameraPosition_pad;
};
#define uCameraPosition cameraPosition_pad.xyz
#endif
mat4 getModelViewMatrix() {
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
return modelViewMatrix;
#else
#ifdef MODEL_MATRIX
return viewMatrix * modelMatrix;
#else
return viewMatrix;
#endif
#endif
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#define MODEL_MATRIX
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = projectionMatrix * modelViewMatrix * worldPos;
}
#else  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec4 worldPos) {
#ifdef MODEL_MATRIX
gl_Position = viewProjMatrix * modelMatrix * worldPos;
#else
gl_Position = viewProjMatrix * worldPos;
#endif  // MODEL_MATRIX
}
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec3 worldPos) {
setClipPositionFromWorldPos(vec4(worldPos, 1.0));
}
void setClipPositionFromViewPos(in vec4 viewPos) {
gl_Position = projectionMatrix * viewPos;
}
void setClipPositionFromViewPos(in vec3 viewPos) {
setClipPositionFromViewPos(vec4(viewPos, 1.0));
}
vec3 multiplyPositionByModelMatrix(in vec4 position) {
#ifdef MODEL_MATRIX
return (modelMatrix * position).xyz;
#else
return position.xyz;
#endif
}
vec3 multiplyPositionByModelMatrix(in vec3 position) {
return multiplyPositionByModelMatrix(vec4(position, 1.0));
}
vec3 multiplyDirectionByModelMatrix(in vec3 direction) {
#ifdef MODEL_MATRIX
return (modelMatrix * vec4(direction, 0.0)).xyz;
#else
return direction;
#endif
}
#if defined(USE_BASE_COLOR_TEXTURE) || defined(USE_ROUGHNESS_TEXTURE) ||                         \\
defined(USE_METALLIC_TEXTURE) || defined(USE_BUMP_TEXTURE) || defined(USE_HEIGHT_TEXTURE) || \\
defined(USE_NORMAL_TEXTURE)
out vec2 vUv0;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec4 uUv0OffsetAndScale;  // xy = offset, zw = scale
uniform vec2 uUv0RotationCosSin;
#endif
#endif
#ifdef USE_LIGHTMAP
centroid out vec2 vUv1;
#endif
#if defined(USE_BUMP_TEXTURE) || defined(USE_FOG) || defined(USE_SSAO)
out vec3 vPositionV;
#endif
#if defined(USE_ENVMAP) || defined(USE_HEADLIGHT) || defined(USE_FOG) || defined(LIVE_LIGHTMAP) || \\
defined(USE_SHADOWMAP)
out vec3 vPositionW;
#endif
#if defined(USE_ENVMAP) || defined(USE_HEADLIGHT) || defined(LIVE_LIGHTMAP) || \\
defined(USE_SHADOWMAP)
out vec3 vNormalW;
#endif
#if defined(USE_BUMP_TEXTURE) || defined(USE_HEIGHT_TEXTURE) || defined(USE_ENVMAP) || \\
defined(USE_HEADLIGHT) || defined(LIVE_LIGHTMAP) || defined(USE_SHADOWMAP) ||      \\
defined(USE_SSAO)
#define MV_NORMAL_REQUIRED
void modifyMvPositionHook(inout vec4 mvPosition, in vec3 normal);
#endif
#ifdef MV_NORMAL_REQUIRED
out vec3 vNormalV;
#endif
void main() {
#if defined(USE_BASE_COLOR_TEXTURE) || defined(USE_ROUGHNESS_TEXTURE) ||                         \\
defined(USE_METALLIC_TEXTURE) || defined(USE_BUMP_TEXTURE) || defined(USE_HEIGHT_TEXTURE) || \\
defined(USE_NORMAL_TEXTURE)
const vec2 center = vec2(0.5, 0.5);
mat2 uvRot =
mat2(uUv0RotationCosSin.x, -uUv0RotationCosSin.y, uUv0RotationCosSin.y, uUv0RotationCosSin.x);
vUv0 = uvRot * (uv0 * uUv0OffsetAndScale.zw - center) + center + uUv0OffsetAndScale.xy;
#endif
vec4 transformedPosition = transformPosition();
mat4 modelViewMatrix = getModelViewMatrix();
vec4 mvPosition = modelViewMatrix * transformedPosition;
#ifdef USE_LIGHTMAP
float zeroOrOne = min(uv1.x + uv1.y, 1.0);
vUv1 = uv1 * uv1Mod.zw + uv1Mod.xy * zeroOrOne;
#endif
#if defined(MV_NORMAL_REQUIRED)
vec3 n = sphericalDecode(sphericalNormal);
vec3 normal = vec3(dot(t0.xyz, n), dot(t1.xyz, n), dot(t2.xyz, n));
#if defined(NON_UNIFORM_SCALE)
vNormalV = normalize(mat3(normalMatrix) * normal);
#else
vNormalV = normalize(mat3(modelViewMatrix) * normal);
#endif
modifyMvPositionHook(mvPosition, vNormalV);
#endif
#if defined(USE_BUMP_TEXTURE) || defined(USE_FOG) || defined(USE_SSAO)
vPositionV = -mvPosition.xyz;
#endif
#if defined(USE_ENVMAP) || defined(USE_HEADLIGHT) || defined(USE_FOG) || defined(LIVE_LIGHTMAP) || \\
defined(USE_SHADOWMAP)
vPositionW = multiplyPositionByModelMatrix(transformedPosition);
#endif
#if defined(USE_ENVMAP) || defined(USE_HEADLIGHT) || defined(LIVE_LIGHTMAP) || \\
defined(USE_SHADOWMAP)
vNormalW = multiplyDirectionByModelMatrix(normal);
vNormalW = normalize(vNormalW);
#endif
gl_Position = projectionMatrix * mvPosition;
}
`,"standard_material_vertex_hooks.glsl":`void modifyMvPositionHook(inout vec4 mvPosition, in vec3 normal) {}
`,"static_render_fragment.glsl":`float _l2g(in float x) {
return (x <= 0.0031308) ? x * 12.92 : pow(x, 1.0 / 2.4) * 1.055 - 0.055;
}
vec3 linearToGamma(in vec3 rgb) {
return vec3(_l2g(rgb.r), _l2g(rgb.g), _l2g(rgb.b));
}
vec3 hable(in vec3 rgb) {
float A = 0.15;  // shoulderStrength
float B = 0.50;  // linearStrength
float C = 0.10;  // linearAngle
float D = 0.20;  // toeStrength
float E = 0.02;  // toeNumerator
float F = 0.30;  // toeDenominator
return ((rgb * (A * rgb + C * B) + D * E) / (rgb * (A * rgb + B) + D * F)) - E / F;
}
vec3 toneMappingHable(in vec3 rgb) {
float exposure = 11.2;
float exposureBias = 2.0;
vec3 current = hable(exposureBias * rgb);
vec3 whiteScale = 1.0 / hable(vec3(exposure));
return pow(current * whiteScale, vec3(1.0 / 2.2));
}
vec3 uchimura(in vec3 x, in float P, in float a, in float m, in float l, in float c, in float b) {
float l0 = ((P - m) * l) / a;
float L0 = m - m / a;
float L1 = m + (1.0 - m) / a;
float S0 = m + l0;
float S1 = m + a * l0;
float C2 = (a * P) / (P - S1);
float CP = -C2 / P;
vec3 w0 = vec3(1.0 - smoothstep(0.0, m, x));
vec3 w2 = vec3(step(m + l0, x));
vec3 w1 = vec3(1.0 - w0 - w2);
vec3 T = vec3(m * pow(x / m, vec3(c)) + b);
vec3 S = vec3(P - (P - S1) * exp(CP * (x - S0)));
vec3 L = vec3(m + a * (x - m));
return T * w0 + L * w1 + S * w2;
}
vec3 toneMappingUchimura(in vec3 rgb) {
float P = 1.0;   // max display brightness
float a = 1.0;   // contrast
float m = 0.22;  // linear section start
float l = 0.4;   // linear section length
float c = 1.45;  // black
float b = 0.0;   // pedestal
return pow(uchimura(rgb, P, a, m, l, c, b), vec3(1.0 / 2.2));
}
vec3 toneMappingUnreal(in vec3 rgb) {
return rgb / (rgb + 0.187) * 1.035;
}
vec3 linearToGammaToneMapped(in vec3 rgb) {
#ifdef TONE_MAPPING_UNREAL
return toneMappingUnreal(rgb);
#endif
#ifdef TONE_MAPPING_HABLE
return toneMappingHable(rgb);
#endif
#ifdef TONE_MAPPING_UCHIMURA
return toneMappingUchimura(rgb);
#endif
return toneMappingUnreal(rgb);
}
uniform sampler2D staticRender;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec2 sizeInv;
#endif
void main() {
vec3 colorLinear = texture(staticRender, gl_FragCoord.xy * sizeInv).rgb;
fragColor = vec4(linearToGammaToneMapped(colorLinear), 1.0);
}
`,"static_render_vertex.glsl":`mat4 getModelViewMatrix() {
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
return modelViewMatrix;
#else
#ifdef MODEL_MATRIX
return viewMatrix * modelMatrix;
#else
return viewMatrix;
#endif
#endif
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#define MODEL_MATRIX
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = projectionMatrix * modelViewMatrix * worldPos;
}
#else  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec4 worldPos) {
#ifdef MODEL_MATRIX
gl_Position = viewProjMatrix * modelMatrix * worldPos;
#else
gl_Position = viewProjMatrix * worldPos;
#endif  // MODEL_MATRIX
}
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec3 worldPos) {
setClipPositionFromWorldPos(vec4(worldPos, 1.0));
}
void setClipPositionFromViewPos(in vec4 viewPos) {
gl_Position = projectionMatrix * viewPos;
}
void setClipPositionFromViewPos(in vec3 viewPos) {
setClipPositionFromViewPos(vec4(viewPos, 1.0));
}
vec3 multiplyPositionByModelMatrix(in vec4 position) {
#ifdef MODEL_MATRIX
return (modelMatrix * position).xyz;
#else
return position.xyz;
#endif
}
vec3 multiplyPositionByModelMatrix(in vec3 position) {
return multiplyPositionByModelMatrix(vec4(position, 1.0));
}
vec3 multiplyDirectionByModelMatrix(in vec3 direction) {
#ifdef MODEL_MATRIX
return (modelMatrix * vec4(direction, 0.0)).xyz;
#else
return direction;
#endif
}
void main() {
gl_Position = getModelViewMatrix() * vec4(position, 1.0);
}
`,"universal_material_fragment.glsl":`const float PI = 3.14159265358979;
const float RECIPROCAL_PI2 = 0.15915494;
float saturate(in float a) {
return clamp(a, 0.0, 1.0);
}
vec3 inverseTransformDirection(in vec3 normal, in mat4 matrix) {
return normalize((vec4(normal, 0.0) * matrix).xyz);
}
float _g2l(in float x) {
return (x <= 0.04045) ? x / 12.92 : pow((x + 0.055) / 1.055, 2.4);
}
vec3 gammaToLinear(in vec3 rgb) {
return vec3(_g2l(rgb.r), _g2l(rgb.g), _g2l(rgb.b));
}
float _l2g(in float x) {
return (x <= 0.0031308) ? x * 12.92 : pow(x, 1.0 / 2.4) * 1.055 - 0.055;
}
vec3 linearToGamma(in vec3 rgb) {
return vec3(_l2g(rgb.r), _l2g(rgb.g), _l2g(rgb.b));
}
vec3 hable(in vec3 rgb) {
float A = 0.15;  // shoulderStrength
float B = 0.50;  // linearStrength
float C = 0.10;  // linearAngle
float D = 0.20;  // toeStrength
float E = 0.02;  // toeNumerator
float F = 0.30;  // toeDenominator
return ((rgb * (A * rgb + C * B) + D * E) / (rgb * (A * rgb + B) + D * F)) - E / F;
}
vec3 toneMappingHable(in vec3 rgb) {
float exposure = 11.2;
float exposureBias = 2.0;
vec3 current = hable(exposureBias * rgb);
vec3 whiteScale = 1.0 / hable(vec3(exposure));
return pow(current * whiteScale, vec3(1.0 / 2.2));
}
vec3 uchimura(in vec3 x, in float P, in float a, in float m, in float l, in float c, in float b) {
float l0 = ((P - m) * l) / a;
float L0 = m - m / a;
float L1 = m + (1.0 - m) / a;
float S0 = m + l0;
float S1 = m + a * l0;
float C2 = (a * P) / (P - S1);
float CP = -C2 / P;
vec3 w0 = vec3(1.0 - smoothstep(0.0, m, x));
vec3 w2 = vec3(step(m + l0, x));
vec3 w1 = vec3(1.0 - w0 - w2);
vec3 T = vec3(m * pow(x / m, vec3(c)) + b);
vec3 S = vec3(P - (P - S1) * exp(CP * (x - S0)));
vec3 L = vec3(m + a * (x - m));
return T * w0 + L * w1 + S * w2;
}
vec3 toneMappingUchimura(in vec3 rgb) {
float P = 1.0;   // max display brightness
float a = 1.0;   // contrast
float m = 0.22;  // linear section start
float l = 0.4;   // linear section length
float c = 1.45;  // black
float b = 0.0;   // pedestal
return pow(uchimura(rgb, P, a, m, l, c, b), vec3(1.0 / 2.2));
}
vec3 toneMappingUnreal(in vec3 rgb) {
return rgb / (rgb + 0.187) * 1.035;
}
vec3 linearToGammaToneMapped(in vec3 rgb) {
#ifdef TONE_MAPPING_UNREAL
return toneMappingUnreal(rgb);
#endif
#ifdef TONE_MAPPING_HABLE
return toneMappingHable(rgb);
#endif
#ifdef TONE_MAPPING_UCHIMURA
return toneMappingUchimura(rgb);
#endif
return toneMappingUnreal(rgb);
}
vec4 cubic(in float v) {
vec4 n = vec4(1.0, 2.0, 3.0, 4.0) - v;
vec4 s = n * n * n;
float x = s.x;
float y = s.y - 4.0 * s.x;
float z = s.z - 4.0 * s.y + 6.0 * s.x;
float w = 6.0 - x - y - z;
return vec4(x, y, z, w) * (1.0 / 6.0);
}
vec3 hdrDecodeRgbm(in vec4 rgbm) {
const float rgbmScale = 2.82842712;  // sqrt(8)
float m = 1.0 - rgbm.a;
vec3 r = rgbm.rgb * (rgbmScale * m);
return r * r;
}
vec3 hdrDecodeYcocgm(in vec4 ycocgm, in vec2 threshold) {
const float ycocgmLumaRange = 16.0;
float m = ycocgm.w * (16.0 * 255.0 / 256.0) - 1.0;
float chroma_scale_factor = fract(m);
float y_factor = m - chroma_scale_factor;
chroma_scale_factor = 1.0 - chroma_scale_factor;
float factor = y_factor == ycocgmLumaRange - 2.0 ? 0.0 : 1.0;
float y = mix(ycocgm.x * threshold.x, (y_factor + ycocgm.x) * threshold.y + threshold.x, factor);
float co = (ycocgm.y - 0.5) * chroma_scale_factor;
float cg = (ycocgm.z - 0.5) * chroma_scale_factor;
return vec3(y, co, cg);
}
vec3 ycocgToRgb(in vec3 ycocg) {
float y = ycocg.x, co = ycocg.y, cg = ycocg.z;
y = y * y;
float r = saturate(y + co - cg);
float g = saturate(y + cg);
float b = saturate(y - co - cg);
return vec3(r, g, b) * 8.0;
}
/*vec3 hdrDecodeYcocgmBicubic(in sampler2D ycocgmSampler, in vec2 texSize, in vec2 invTexSize,
in vec2 threshold, in vec2 texCoords) {
vec2 texCoordsScaled = texCoords * texSize - 0.5;
vec2 fxy = fract(texCoordsScaled);
texCoordsScaled -= fxy;
vec4 xcubic = cubic(fxy.x), ycubic = cubic(fxy.y);
vec4 c = texCoordsScaled.xxyy + vec2(-0.5, +1.5).xyxy;
vec4 s = vec4(xcubic.xz + xcubic.yw, ycubic.xz + ycubic.yw);
vec4 offset = (c + vec4 (xcubic.yw, ycubic.yw) / s) * invTexSize.xxyy;
vec3 sample0 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.xz), threshold);
vec3 sample1 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.yz), threshold);
vec3 sample2 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.xw), threshold);
vec3 sample3 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.yw), threshold);
float sx = s.x / (s.x + s.y), sy = s.z / (s.z + s.w);
return mix(mix(sample3, sample2, sx), mix(sample1, sample0, sx), sy);
}*/
vec3 hdrDecodeYcocgmBilinear(in sampler2D ycocgmSampler, in vec2 texSize, in vec2 invTexSize,
in vec2 threshold, in vec2 texCoords) {
vec2 texCoordsScaled = texCoords * texSize - 0.5;
vec2 fxy = fract(texCoordsScaled);
texCoordsScaled -= fxy;
vec4 c = texCoordsScaled.xxyy + vec2(-0.5, +0.5).xyxy;
vec4 offset = c + vec4(1.0);
float sx = 1.0 - fxy.x;
float sy = 1.0 - fxy.y;
offset *= invTexSize.xxyy;
vec3 sample0 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.xz), threshold);
vec3 sample1 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.yz), threshold);
vec3 sample2 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.xw), threshold);
vec3 sample3 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.yw), threshold);
return mix(mix(sample3, sample2, sx), mix(sample1, sample0, sx), sy);
}
/*vec3 hdrDecodeRgbmBicubic(in sampler2D rgbmSampler, in vec2 texSize,
in vec2 invTexSize, in vec2 texCoords) {
vec2 texCoordsScaled = texCoords * texSize - 0.5;
vec2 fxy = fract(texCoordsScaled);
texCoordsScaled -= fxy;
vec4 xcubic = cubic(fxy.x), ycubic = cubic(fxy.y);
vec4 c = texCoordsScaled.xxyy + vec2(-0.5, +1.5).xyxy;
vec4 s = vec4(xcubic.xz + xcubic.yw, ycubic.xz + ycubic.yw);
vec4 offset = (c + vec4 (xcubic.yw, ycubic.yw) / s) * invTexSize.xxyy;
vec3 sample0 = hdrDecodeRgbm(texture(rgbmSampler, offset.xz));
vec3 sample1 = hdrDecodeRgbm(texture(rgbmSampler, offset.yz));
vec3 sample2 = hdrDecodeRgbm(texture(rgbmSampler, offset.xw));
vec3 sample3 = hdrDecodeRgbm(texture(rgbmSampler, offset.yw));
float sx = s.x / (s.x + s.y), sy = s.z / (s.z + s.w);
return mix(mix(sample3, sample2, sx), mix(sample1, sample0, sx), sy);
}*/
vec3 hdrDecodeRgbmBilinear(in sampler2D rgbmSampler, in vec2 texSize, in vec2 invTexSize,
in vec2 texCoords) {
vec2 texCoordsScaled = texCoords * texSize - 0.5;
vec2 fxy = fract(texCoordsScaled);
texCoordsScaled -= fxy;
vec4 c = texCoordsScaled.xxyy + vec2(-0.5, +0.5).xyxy;
vec4 offset = c + vec4(1.0);
float sx = 1.0 - fxy.x;
float sy = 1.0 - fxy.y;
offset *= invTexSize.xxyy;
vec3 sample0 = hdrDecodeRgbm(texture(rgbmSampler, offset.xz));
vec3 sample1 = hdrDecodeRgbm(texture(rgbmSampler, offset.yz));
vec3 sample2 = hdrDecodeRgbm(texture(rgbmSampler, offset.xw));
vec3 sample3 = hdrDecodeRgbm(texture(rgbmSampler, offset.yw));
return mix(mix(sample3, sample2, sx), mix(sample1, sample0, sx), sy);
}
vec4 hdrEncode(in vec3 rgb) {
const float rgbmScale = 2.82842712;  // sqrt(8)
vec3 r = sqrt(rgb) / rgbmScale;
float m = max(max(r.r, r.g), r.b);
m = clamp(m, 1.0 / 255.0, 1.0);
m = ceil(m * 255.0) / 255.0;
r /= m;
return vec4(r.r, r.g, r.b, (1.0 - m));
}
struct ReflectionProbe {
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
vec3 boxMin;
vec3 boxMax;
vec3 posW;
#else
vec4 boxMin;
vec4 boxMax;
vec4 posW;
#endif
};
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform LightBuffer {
vec4 lightmapSize;
vec4 lightmapThreshold;
ReflectionProbe reflectionProbes[3];
int reflectionProbesCount;
};
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform GlobalBuffer {
mat4 unjitteredInvProjMatrix;
mat4 unjitteredPrevViewProjMatrix;
vec4 viewSpaceFrustumRayDirections[4];
vec4 viewSpaceFrustumRayOrigins[4];
vec2 zNear_zFar;
vec4 fogDistStart_DistDensity_HeightStart_HeightDensity;
vec4 fogColor;
vec4 camera_exposure_gamma;
float colorMapIntensity;
float time;
vec2 texelSize;
vec2 renderTargetSize;
float deltaTime;
float velocityFactor;
vec2 jitterOffset;
float temporalAaHistoryWeight;
bool allTaaSamplesAccumulated;
vec2 neighbourhoodTexelOffsets[8];
float accumulatedStaticTaaSamples;
vec4 screenResolution;
float lightmapMode;
float dynamicTaaHistoryMultiplier;
};
#define uFogColor fogColor.xyz
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform CameraBuffer {
mat4 projectionMatrix;
mat4 viewProjMatrix;
mat4 viewMatrix;
mat4 invViewMatrix;
vec4 cameraPosition_pad;
};
#define uCameraPosition cameraPosition_pad.xyz
#endif
#ifdef USE_FOG
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec4 fogDistStart_DistDensity_HeightStart_HeightDensity;
uniform vec3 uFogColor;
#endif
const float LOG2 = 1.442695;
vec3 addFog(in vec3 colorIn, in float distance, in vec3 positionW) {
float distanceValue = max(0.0, distance - fogDistStart_DistDensity_HeightStart_HeightDensity.x);
float distanceDensity = fogDistStart_DistDensity_HeightStart_HeightDensity.y;
float distanceFogExp =
1.0 - exp2(-distanceDensity * distanceDensity * distanceValue * distanceValue * LOG2);
float heightValue = max(0.0, -positionW.z + fogDistStart_DistDensity_HeightStart_HeightDensity.z);
float heightDensity = fogDistStart_DistDensity_HeightStart_HeightDensity.w;
float heightFogExp =
1.0 - exp2(-heightDensity * heightDensity * heightValue * heightValue * LOG2);
float fogAmount = min(1.0, distanceFogExp + heightFogExp);
return mix(colorIn, uFogColor.xyz, fogAmount);
}
#endif
in vec3 vPositionW;
in vec3 vNormalW;
in vec2 vUv0;
#if defined(USE_BUMP_TEXTURE) || defined(USE_FOG)
in vec3 vPositionV;
#endif
vec3 rgbToHsl(vec3 rgb) {
vec3 hsl = vec3(0.0);
float fMin = min(min(rgb.r, rgb.g), rgb.b);
float fMax = max(max(rgb.r, rgb.g), rgb.b);
float delta = fMax - fMin;
hsl.z = (fMax + fMin) / 2.0;  // Luminance
if (delta == 0.0) {
return hsl;
}
hsl.y = delta / ((hsl.z <= 0.5) ? (fMax + fMin) : (2.0 - fMax - fMin));
float denom = 6.0 * delta;
if (rgb.r == fMax) {
hsl.x = (rgb.g - rgb.b) / denom;
} else if (rgb.g == fMax) {
hsl.x = (rgb.b - rgb.r) / denom + (1.0 / 3.0);
} else if (rgb.b == fMax) {
hsl.x = (rgb.r - rgb.g) / denom + (2.0 / 3.0);
}
if (hsl.x < 0.0) {
hsl.x += 1.0;
}
if (hsl.x > 1.0) {
hsl.x -= 1.0;
}
return hsl;
}
float hueToRgb(float p, float q, float hue) {
if (hue < 0.0) {
hue += 1.0;
}
if (hue > 1.0) {
hue -= 1.0;
}
float res;
if (6.0 * hue < 1.0) {
res = p + (q - p) * 6.0 * hue;
} else if (2.0 * hue < 1.0) {
res = q;
} else if (3.0 * hue < 2.0) {
res = p + (q - p) * ((2.0 / 3.0) - hue) * 6.0;
} else {
res = p;
}
return res;
}
vec3 hslToRgb(vec3 hsl) {
vec3 rgb;
if (hsl.y == 0.0) {
return vec3(hsl.z);
}
float q = hsl.z < 0.5 ? hsl.z * (1.0 + hsl.y) : (hsl.z + hsl.y) - (hsl.y * hsl.z);
float p = 2.0 * hsl.z - q;
rgb.r = hueToRgb(p, q, hsl.x + (1.0 / 3.0));
rgb.g = hueToRgb(p, q, hsl.x);
rgb.b = hueToRgb(p, q, hsl.x - (1.0 / 3.0));
return rgb;
}
vec3 adjustContrast(vec3 col, float contrast) {
float factor = (1.0 + contrast);
return clamp(vec3(factor * (col.r - 0.5) + 0.5, factor * (col.g - 0.5) + 0.5,
factor * (col.b - 0.5) + 0.5),
vec3(0.0), vec3(1.0));
}
float modOne(float x) {
if (x < 0.0) {
return 1.0 - (float(int(x)) - x);
}
return x - float(int(x));
}
float adjustComponent(float component, float adjustment) {
return clamp(component * (1.0 + adjustment), 0.0, 1.0);
}
float adjustContrastInComponent(float component, float contrast) {
return clamp((1.0 + contrast) * (component - 0.5) + 0.5, 0.0, 1.0);
}
vec3 applyBaseColorCorrection(vec3 color, vec4 colorCorrection) {
if (colorCorrection.x != 0.0 || colorCorrection.y != 0.0 || colorCorrection.z != 0.0) {
vec3 colorInHSL = rgbToHsl(color);
colorInHSL = vec3(modOne(colorInHSL.x + colorCorrection.x),
adjustComponent(colorInHSL.y, colorCorrection.y),
adjustComponent(colorInHSL.z, colorCorrection.z));
color = hslToRgb(colorInHSL);
}
if (colorCorrection.a == 0.0)
return color;
return adjustContrast(color, colorCorrection.a);
}
float desaturate(vec4 color) {
float minComp = min(min(color.r, color.g), color.b);
float maxComp = max(max(color.r, color.g), color.b);
return minComp * 0.5 + maxComp * 0.5;
}
float applyMapCorrection(vec4 color, vec4 correction) {
float value = desaturate(color);
float inversion = correction.r;
float scale = correction.g;
float contrast = correction.b;
value = clamp(scale * value + inversion, 0.0, 1.0);
if (contrast == 0.0)
return value;
value = adjustContrastInComponent(value, contrast);
return value;
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#ifdef ANTI_TILING_REGULAR
uniform float antiTilingRegularStepX;
uniform float antiTilingRegularStepY;
uniform float antiTilingRegularMaxOffsetX;
uniform float antiTilingRegularMaxOffsetY;
#endif
#endif
float hash(vec2 p) {
vec3 p3 = fract(vec3(p.xyx) * 0.13);
p3 += dot(p3, p3.yzx + 3.333);
return fract((p3.x + p3.y) * p3.z);
}
float noise2d(vec2 x) {
vec2 i = floor(x);
vec2 f = fract(x);
float a = hash(i);
float b = hash(i + vec2(1.0, 0.0));
float c = hash(i + vec2(0.0, 1.0));
float d = hash(i + vec2(1.0, 1.0));
vec2 u = f * f * (3.0 - 2.0 * f);
return mix(a, b, u.x) + (c - a) * u.y * (1.0 - u.x) + (d - b) * u.x * u.y;
}
float sum(vec3 v) {
return v.x + v.y + v.z;
}
vec4 textureNoTileOrganic(sampler2D sampler, in vec2 x) {
float k = noise2d(x);
vec2 duvdx = dFdx(x);
vec2 duvdy = dFdy(x);
float l = k * 8.0;
float f = fract(l);
float ia = floor(l + 0.5);
float ib = floor(l);
f = min(f, 1.0 - f) * 2.0;
vec2 offa = sin(vec2(3.0, 7.0) * ia);
vec2 offb = sin(vec2(3.0, 7.0) * ib);
vec3 cola = textureGrad(sampler, x + offa, duvdx, duvdy).xyz;
vec3 colb = textureGrad(sampler, x + offb, duvdx, duvdy).xyz;
vec3 res = mix(cola, colb, smoothstep(0.1, 0.9, f - 0.1 * sum(cola - colb)));
return vec4(res.x, res.y, res.z, texture(sampler, x).a);
}
float toStepX(float x) {
#ifdef ANTI_TILING_REGULAR
float stepVal = antiTilingRegularStepX;
return floor(x * antiTilingRegularMaxOffsetX / stepVal) * stepVal;
#else
return floor(x);
#endif
}
float toStepY(float x) {
#ifdef ANTI_TILING_REGULAR
float stepVal = antiTilingRegularStepY;
return floor(x * antiTilingRegularMaxOffsetY / stepVal) * stepVal;
#else
return floor(x);
#endif
}
vec4 hash4(vec2 p) {
return fract(tan(vec4(1.0 + dot(p, vec2(37.0, 17.0)), 2.0 + dot(p, vec2(11.0, 47.0)),
3.0 + dot(p, vec2(41.0, 29.0)), 4.0 + dot(p, vec2(23.0, 31.0)))) *
103.0);
}
vec4 textureNoTilerRegular(sampler2D samp, in vec2 uv) {
vec2 iuv = floor(uv);
vec2 fuv = fract(uv);
vec4 ofa = hash4(iuv + vec2(0.0, 0.0));
vec4 ofb = hash4(iuv + vec2(1.0, 0.0));
vec4 ofc = hash4(iuv + vec2(0.0, 1.0));
vec4 ofd = hash4(iuv + vec2(1.0, 1.0));
vec2 ddx = dFdx(uv);
vec2 ddy = dFdy(uv);
#ifdef ANTI_TILING_REGULAR_MIRROR_X
ofa.z = sign(ofa.z - 0.5);
ofb.z = sign(ofb.z - 0.5);
ofc.z = sign(ofc.z - 0.5);
ofd.z = sign(ofd.z - 0.5);
#else
ofa.z = 1.0;
ofb.z = 1.0;
ofc.z = 1.0;
ofd.z = 1.0;
#endif
#ifdef ANTI_TILING_REGULAR_MIRROR_Y
ofa.w = sign(ofa.w - 0.5);
ofb.w = sign(ofb.w - 0.5);
ofc.w = sign(ofc.w - 0.5);
ofd.w = sign(ofd.w - 0.5);
#else
ofa.w = 1.0;
ofb.w = 1.0;
ofc.w = 1.0;
ofd.w = 1.0;
#endif
vec2 uva = uv * ofa.zw + vec2(toStepX(ofa.x), toStepY(ofa.y));
vec2 ddxa = ddx * ofa.zw;
vec2 ddya = ddy * ofa.zw;
vec2 uvb = uv * ofb.zw + vec2(toStepX(ofb.x), toStepY(ofb.y));
vec2 ddxb = ddx * ofb.zw;
vec2 ddyb = ddy * ofb.zw;
vec2 uvc = uv * ofc.zw + vec2(toStepX(ofc.x), toStepY(ofc.y));
vec2 ddxc = ddx * ofc.zw;
vec2 ddyc = ddy * ofc.zw;
vec2 uvd = uv * ofd.zw + vec2(toStepX(ofd.x), toStepY(ofd.y));
vec2 ddxd = ddx * ofd.zw;
vec2 ddyd = ddy * ofd.zw;
vec2 b = smoothstep(0.45, 0.55, fuv);
return mix(mix(textureGrad(samp, uva, ddxa, ddya), textureGrad(samp, uvb, ddxb, ddyb), b.x),
mix(textureGrad(samp, uvc, ddxc, ddyc), textureGrad(samp, uvd, ddxd, ddyd), b.x), b.y);
}
vec4 textureWithOptionalAntiTiling(sampler2D text, in vec2 uv) {
#ifdef ANTI_TILING_ORGANIC
return textureNoTileOrganic(text, uv);
#else
#ifdef ANTI_TILING_REGULAR
return textureNoTilerRegular(text, uv);
#else
return texture(text, uv);
#endif
#endif
}
#if defined(USE_BUMP_TEXTURE)
in vec3 vNormalV;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec4 bumpCorrection;
uniform float bumpScale;
#endif
uniform sampler2D bumpTexture;
float bumpTextureCorrected(vec2 coord) {
return applyMapCorrection(textureWithOptionalAntiTiling(bumpTexture, coord), bumpCorrection);
}
vec2 dBumpdxy() {
vec2 texdx = dFdx(vUv0);
vec2 texdy = dFdy(vUv0);
float Hll = bumpScale * bumpTextureCorrected(vUv0);
float dBx = bumpScale * bumpTextureCorrected(vUv0 + texdx) - Hll;
float dBy = bumpScale * bumpTextureCorrected(vUv0 + texdy) - Hll;
return vec2(dBx, dBy);
}
vec3 perturbNormal(in vec3 surfPos, in vec3 surfNorm) {
vec2 dBdxy = dBumpdxy();
vec3 vSigmaX = dFdx(surfPos);
vec3 vSigmaY = dFdy(surfPos);
vec3 R1 = cross(vSigmaY, surfNorm);
vec3 R2 = cross(surfNorm, vSigmaX);
float fDet = dot(vSigmaX, R1);
vec3 vGrad = sign(fDet) * (dBdxy.x * R1 + dBdxy.y * R2);
return normalize(abs(fDet) * surfNorm - vGrad);
}
#endif
#ifdef USE_BASE_COLOR_TEXTURE
uniform sampler2D baseColorTexture;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec4 baseColorAtlasUvMod;
uniform float alphaDiscardThreshold;
#endif
#else
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec3 uBaseColor;
#endif
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform float opacity;
#ifdef USE_CUTOUT_MASK
uniform float cutoutMaskThreshold;
#endif
uniform vec4 baseColorCorrection;
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
vec3 getBaseColorHook(out float alpha);
vec3 getBaseColor(out float alpha) {
#ifdef USE_BASE_COLOR_TEXTURE
vec2 uv = vUv0;
#ifdef USE_BASE_COLOR_TEXTURE_ATLAS_REPEAT
vec2 uvScaled = uv * baseColorAtlasUvMod.zw;
vec2 dfdx = dFdx(uvScaled);
vec2 dfdy = dFdy(uvScaled);
uv = fract(uv) * baseColorAtlasUvMod.zw + baseColorAtlasUvMod.xy;
vec4 baseColorGamma = textureGrad(baseColorTexture, uv, dfdx, dfdy);
float textureAlpha = baseColorGamma.a;
#else
uv = uv * baseColorAtlasUvMod.zw + baseColorAtlasUvMod.xy;
#ifdef USE_ALPHA_IN_LOWER_HALF
vec4 baseColorGamma = textureWithOptionalAntiTiling(baseColorTexture, vec2(uv.x, .5 + .5 * uv.y));
float textureAlpha = texture(baseColorTexture, vec2(uv.x, .5 * uv.y)).r;
#else
vec4 baseColorGamma = textureWithOptionalAntiTiling(baseColorTexture, uv);
float textureAlpha = baseColorGamma.a;
#endif
#endif
vec3 baseColor = gammaToLinear(baseColorGamma.rgb);
#ifdef USE_CUTOUT_MASK
alpha = step(cutoutMaskThreshold, textureAlpha);
if (alpha == 0.0)
discard;
#else
alpha = opacity * textureAlpha;
#endif
vec3 resultBaseColor = applyBaseColorCorrection(baseColor, baseColorCorrection);
#else  // NOT USE_BASE_COLOR_TEXTURE
alpha = opacity;
vec3 resultBaseColor = uBaseColor;
#endif
return resultBaseColor;
}
#ifdef LIVE_LIGHTMAP
uniform sampler2D liveLightmap;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform float lightmapMode;
uniform vec4 screenResolution;
#endif
#endif
#ifdef USE_LIGHTMAP
centroid in vec2 vUv1;
uniform sampler2D lightmap;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec4 lightmapSize;
uniform vec2 lightmapThreshold;
#endif
#endif  // NOT USE_LIGHTMAP
vec3 getLightIntensity() {
#ifdef LIVE_LIGHTMAP
if (lightmapMode == 1.0)
return texture(liveLightmap, gl_FragCoord.xy / screenResolution.xy).xyz;
if (lightmapMode == -1.0)
return vec3(1.0);
#endif
#ifdef USE_LIGHTMAP
vec2 uv = vec2(vUv1.x, vUv1.y);
#ifdef LIGHTMAP_YCOCGM
return ycocgToRgb(hdrDecodeYcocgmBilinear(lightmap, lightmapSize.xy, lightmapSize.zw,
lightmapThreshold.xy, uv));
#else  // LIGHTMAP_RGBM
return hdrDecodeRgbmBilinear(lightmap, lightmapSize.xy, lightmapSize.zw, uv);
#endif
#else  // ifndef USE_LIGHTMAP
return vec3(1.0);
#endif
}
#if defined(USE_ENVMAP)
#define USE_NORMAL_MAPPING_FUNCS
uniform sampler2D roughnessTexture;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec4 roughnessCorrection;
uniform float roughness;
#endif
float getRoughness() {
#ifdef USE_ROUGHNESS_TEXTURE
return applyMapCorrection(textureWithOptionalAntiTiling(roughnessTexture, vUv0),
roughnessCorrection);
#else
return roughness;
#endif
}
uniform sampler2D metallicTexture;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec4 metallicCorrection;
uniform float metallic;
#endif
float getMetallic() {
#ifdef USE_METALLIC_TEXTURE
return applyMapCorrection(textureWithOptionalAntiTiling(metallicTexture, vUv0),
metallicCorrection);
#else
return metallic;
#endif
}
#ifdef USE_BRDF_TEXTURE
vec2 decodeNormalizedFloatsFromRGBA8(vec4 encoded) {
float value1 = (encoded.r * 255.0 * 256.0) + (encoded.g * 255.0);
float value2 = (encoded.b * 255.0 * 256.0) + (encoded.a * 255.0);
value1 /= 65535.0;
value2 /= 65535.0;
return vec2(value1, value2);
}
uniform sampler2D brdfLUT;
#endif
vec3 envBRDFApprox(vec3 specularColor, float roughness, float NoV) {
const vec4 c0 = vec4(-1, -0.0275, -0.572, 0.022);
const vec4 c1 = vec4(1, 0.0425, 1.04, -0.04);
vec4 r = roughness * c0 + c1;
float a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;
vec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;
return specularColor * AB.x + AB.y;
}
vec3 getBrdf(float roughness, vec3 fresnel, float clampCosnv, vec3 specularColor) {
#ifdef USE_BRDF_TEXTURE
vec4 brdfEncoded = texture(brdfLUT, vec2(clampCosnv, roughness)).rgba;
vec2 brdf = decodeNormalizedFloatsFromRGBA8(brdfEncoded);
return fresnel * brdf.x + brdf.y;
#else
return envBRDFApprox(specularColor, roughness, clampCosnv);
#endif
}
uniform samplerCube envMap[MAX_REFLECTION_PROBES];
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform float envMipsCount;
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform ReflectionProbe reflectionProbes[MAX_REFLECTION_PROBES];
#ifdef USE_REFLECTION_PROBE_BLENDING
uniform int reflectionProbesCount;
#endif  // USE_REFLECTION_PROBE_BLENDING
#endif    // DEV_DISABLE_UNIFORM_BUFFERS
struct EnvMapLevel {
float mipLevel0;
float mipLevel1;
float mipMixFactor;
};
EnvMapLevel getEnvMapLevel(float roughness) {
EnvMapLevel result;
float maxMipLevel = envMipsCount - 1.0;
float mipSelector = roughness * maxMipLevel;
result.mipLevel0 = floor(mipSelector);
result.mipLevel1 = min(result.mipLevel0 + 1.0, maxMipLevel);
result.mipMixFactor = fract(mipSelector);
return result;
}
const vec3 infBox = vec3(1000.0);
vec3 cubeMapProject(vec3 reflectionW, in ReflectionProbe reflectionProbe) {
vec3 firstPlaneIntersect = (reflectionProbe.boxMax.xyz - vPositionW) / reflectionW;
vec3 secondPlaneIntersect = (reflectionProbe.boxMin.xyz - vPositionW) / reflectionW;
vec3 furthestPlane = max(firstPlaneIntersect, secondPlaneIntersect);
vec3 furthestPlaneNonNeg = step(0.0, -furthestPlane) * infBox + abs(furthestPlane);
float distance = min(min(furthestPlaneNonNeg.x, furthestPlaneNonNeg.y), furthestPlaneNonNeg.z);
vec3 intersectionPosW = vPositionW + reflectionW * distance;
return intersectionPosW - reflectionProbe.posW.xyz;
}
float signedDistanceBox(vec3 p, vec3 b, float offset) {
vec3 q = abs(p) - b;
return length(max(q, 0.0)) + min(max(q.x, max(q.y, q.z)), 0.0) - offset;
}
float getSignedDistanceField(in ReflectionProbe probe) {
vec3 halfBox = vec3(probe.boxMax - probe.boxMin) * vec3(0.5);
vec3 boxPos = vec3(probe.boxMax + probe.boxMin) * vec3(0.5);
vec3 localPos = boxPos - vPositionW;
const float offset = 0.1;
return signedDistanceBox(localPos, halfBox, offset);
}
vec3 sampleEnvMap(in EnvMapLevel envMapLevel, in vec3 reflectionW, samplerCube envMap,
int probeIndex) {
#ifdef USE_ENVMAP_PROJECT
ReflectionProbe reflectionProbe = reflectionProbes[probeIndex];
if (reflectionProbe.boxMin.x != reflectionProbe.boxMax.x)
reflectionW = cubeMapProject(reflectionW, reflectionProbe);
#endif
vec4 cubeColorRaw0 = textureLod(envMap, reflectionW, envMapLevel.mipLevel0);
vec3 cubeColor0 = hdrDecodeRgbm(cubeColorRaw0);
vec4 cubeColorRaw1 = textureLod(envMap, reflectionW, envMapLevel.mipLevel1);
vec3 cubeColor1 = hdrDecodeRgbm(cubeColorRaw1);
return mix(cubeColor0, cubeColor1, envMapLevel.mipMixFactor);
}
vec3 sampleEnvMapBlended(in EnvMapLevel envMapLevel, in vec3 reflectionW) {
#ifdef USE_REFLECTION_PROBE_BLENDING
float weight[MAX_REFLECTION_PROBES];
#ifdef USE_ENVMAP_PROJECT
for (int i = 0; i < reflectionProbesCount; i++) {
weight[i] = max(-getSignedDistanceField(reflectionProbes[i]), 0.0);
weight[i] = smoothstep(0.0, 1.0, weight[i]);
}
float weightSum = 0.0;
for (int i = 0; i < reflectionProbesCount; i++) {
weightSum += weight[i];
}
if (weightSum == 0.0) {
weight[0] = 1.0;
} else {
for (int i = 0; i < reflectionProbesCount; i++) weight[i] /= weightSum;
}
#else
for (int i = 0; i < reflectionProbesCount; i++) weight[i] = 1.0;
#endif
vec3 envColor = vec3(0.0, 0.0, 0.0);
if (weight[0] > 0.0)
envColor += sampleEnvMap(envMapLevel, reflectionW, envMap[0], 0) * weight[0];
if (reflectionProbesCount >= 2 && weight[1] > 0.0)
envColor += sampleEnvMap(envMapLevel, reflectionW, envMap[1], 1) * weight[1];
if (reflectionProbesCount >= 3 && weight[2] > 0.0)
envColor += sampleEnvMap(envMapLevel, reflectionW, envMap[2], 2) * weight[2];
#else  // not USE_REFLECTION_PROBE_BLENDING
vec3 envColor = sampleEnvMap(envMapLevel, reflectionW, envMap[0], 0);
#endif
return envColor;
}
#endif
#ifdef USE_NORMAL_TEXTURE
uniform sampler2D normalTexture;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform float normalScale;
#endif
#endif
#ifdef USE_NORMAL_MAPPING_FUNCS
vec3 computeTangent(vec2 texCoord, vec3 normalW) {
vec2 uvDiff1 = vec2(dFdx(texCoord.x), dFdy(texCoord.x));
vec2 uvDiff2 = vec2(dFdx(texCoord.y), dFdy(texCoord.y));
vec3 denormTangent = uvDiff1.x * dFdy(vPositionW) - dFdx(vPositionW) * uvDiff1.y;
vec3 tangent = denormTangent - normalW * dot(normalW, denormTangent);
float lenSq = dot(tangent, tangent);
tangent = lenSq < 1e-6 ? vec3(normalW.z, normalW.x, normalW.y) : tangent * inversesqrt(lenSq);
return tangent;
}
vec3 computeNormal() {
float faceSign = gl_FrontFacing ? 1.0 : -1.0;
#ifdef USE_NORMAL_TEXTURE
vec3 normalW = normalize(vNormalW);
vec3 tangentW = computeTangent(vUv0, normalW);
vec3 bitangentW = cross(normalW, tangentW);
vec3 value = texture(normalTexture, vUv0).xyz;
value = (value == vec3(0.0)) ? vec3(0.0, 0.0, 1.0) : value * 2.0 - 1.0;
value = tangentW * value.x * normalScale + bitangentW * value.y * normalScale + normalW * value.z;
return normalize(value) * faceSign;
#elif defined(USE_BUMP_TEXTURE)
vec3 normalPerturbedV = perturbNormal(-vPositionV, normalize(vNormalV));
return normalize(inverseTransformDirection(normalPerturbedV, viewMatrix)) * faceSign;
#else
return normalize(vNormalW) * faceSign;
#endif
}
#endif
float getEnvMapFresnel(float roughness) {
float roughness2 = roughness * roughness;
return (roughness2 - 2.0 * roughness + 1.0);
}
vec3 fresnelSchlickEnv(in vec3 specularColor, in float envMapFresnel, in float clampCosnv,
inout float opacity) {
float fresnel = 1.0 - clampCosnv;
float fresnel2 = fresnel * fresnel;
fresnel *= fresnel2 * fresnel2;
fresnel *= envMapFresnel;
opacity = opacity + (1.0 - opacity) * fresnel;
return specularColor + (1.0 - specularColor) * fresnel;
}
vec3 getSpecularColor(in vec3 baseColor, float metalic) {
const float dielectricF0 = 0.04;
return mix(vec3(dielectricF0), baseColor, metalic);
}
float getLuminance(in vec3 color) {
return 0.2126 * color.r + 0.7152 * color.g + 0.0722 * color.b;
}
#if defined(USE_ENVMAP)
vec3 addSpecular(in vec3 baseColor, in vec3 totalIntensity, inout float opacity, float metallic,
float roughness) {
vec3 totalSpec = vec3(0.0, 0.0, 0.0);
vec3 diffuseIntensity = totalIntensity * (1.0 - mix(0.04, 1.0, metallic));
vec3 viewW = normalize(uCameraPosition - vPositionW);
vec3 normalW = computeNormal();
float clampCosnv = saturate(dot(normalW, viewW));
vec3 reflectionW = normalize(reflect(-viewW, normalW));
vec3 specularColor = getSpecularColor(baseColor, metallic);
EnvMapLevel envMapLevel = getEnvMapLevel(roughness);
vec3 envColor = sampleEnvMapBlended(envMapLevel, reflectionW);
float envMapFresnel = roughness * roughness - 2.0 * roughness + 1.0;
vec3 fresnel = fresnelSchlickEnv(specularColor, envMapFresnel, clampCosnv, opacity);
float luminance = getLuminance(totalIntensity);
totalSpec = envColor * getBrdf(roughness, fresnel, clampCosnv, specularColor);
#if defined(WEAK_REFLECTION_SHADOW)
float shadowingFactor = mix(0.4, 1.0, luminance);
#else
float shadowingFactor = mix(0.4, 1.0, luminance) * mix(min(luminance, 1.0), 1.0, metallic);
#endif
return baseColor * diffuseIntensity + totalSpec * shadowingFactor;
}
vec3 addSpecular(in vec3 baseColor, in vec3 totalIntensity, inout float opacity) {
float metallic = getMetallic();
float roughness = getRoughness();
return addSpecular(baseColor, totalIntensity, opacity, metallic, roughness);
}
#else  // NOT USE_ENVMAP
vec3 addSpecular(in vec3 baseColor, in vec3 lightIntensity, in float opacity, float metallic,
float roughness) {
return baseColor * lightIntensity;
}
vec3 addSpecular(vec3 baseColor, in vec3 lightIntensity, in float opacity) {
return baseColor * lightIntensity;
}
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#ifdef USE_HIGHLIGHT
uniform vec3 uHighlight;
uniform float highlightMix;
#endif
#endif
#ifdef USE_COLORMAP
vec3 colormap(in sampler2D lut, in vec3 color, in float intensity) {
const float resolution = 16.0;
const float maxValueIndex = resolution - 1.0;
const float sliceWidth = 1.0 / resolution;
const float slicePixelWidth = sliceWidth / resolution;
const float sliceMarginWidth = 0.5 * slicePixelWidth;
const float sliceInnerWidth = sliceWidth - slicePixelWidth;
const float slicePixelHeight = 1.0 / resolution;
const float sliceMarginHeight = 0.5 * slicePixelHeight;
const float sliceInnerHeight = 1.0 - slicePixelHeight;
float bSlice0 = min(floor(color.b * maxValueIndex), maxValueIndex - 1.0);
float bSlice1 = bSlice0 + 1.0;
float bOffset = color.b * maxValueIndex - bSlice0;
float rSlicePos = sliceMarginWidth + color.r * sliceInnerWidth;
float gSlicePos = sliceMarginHeight + color.g * sliceInnerHeight;
float rPos0 = rSlicePos + (bSlice0 * sliceWidth);
float rPos1 = rSlicePos + (bSlice1 * sliceWidth);
vec3 color0 = texture(lut, vec2(rPos0, gSlicePos)).rgb;
vec3 color1 = texture(lut, vec2(rPos1, gSlicePos)).rgb;
return mix(color, mix(color0, color1, bOffset), intensity);
}
uniform sampler2D colorMap;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform float colorMapIntensity;
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
#endif
#ifdef USE_CHROMA_KEY
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec3 uChromaKeyColor;
uniform vec3 uChromaKeyDeltaCoeff;
#endif
const float k32 = sqrt(3.0) / 2.0;
vec3 rgb2abi(vec3 color) {
float r = color.r;
float g = color.g;
float b = color.b;
return vec3(r - 0.5 * g - 0.5 * b, k32 * (g - b), 0.3333 * (r + g + b));
}
const float IPI2 = 0.5 / 3.1415926538;
vec3 rgb2hci(vec3 color) {
vec3 abi = rgb2abi(color);
return vec3(atan(abi.y, abi.x) * IPI2, length(abi.xy), abi.z);
}
float chromaKeyShapeFn(vec3 delta, vec3 color, vec3 key) {
vec3 diff = color - key;
vec3 v = delta * vec3(
0.5 - abs(abs(diff.x) - 0.5), abs(diff.y), abs(diff.z));
float x = max(v.r, max(v.g, v.b));
return x * x;
}
float chromaKeyEdgeFn(float a) {
return clamp(.2 / .5 * (a - 1.0), 0.0, 1.0);
}
#endif
struct BSDF {
vec3 response;
vec3 throughput;
float ior;
};
struct SurfaceShader {
vec3 color;
float transparency;
};
struct LightShader {
vec3 intensity;
vec3 direction;
};
#define M_FLOAT_EPS 1e-8
BSDF combineBsdf(BSDF topLayer, BSDF bottomLayer) {
BSDF result = BSDF(vec3(0.0), vec3(1.0), 0.0);
result.response = topLayer.response + bottomLayer.response * topLayer.throughput;
result.throughput = topLayer.throughput * bottomLayer.throughput;
return result;
}
BSDF mixBsdf(BSDF x, BSDF y, float a) {
BSDF result = BSDF(vec3(0.0), vec3(1.0), 0.0);
result.response = mix(x.response, y.response, a);
result.throughput = mix(x.throughput, y.throughput, a);
return result;
}
float square(float x) {
return x * x;
}
vec2 square(vec2 x) {
return x * x;
}
vec3 square(vec3 x) {
return x * x;
}
#define DIRECTIONAL_ALBEDO_METHOD 0
#define MAX_LIGHT_SOURCES 9
#define M_PI 3.1415926535897932
#define M_PI_INV (1.0 / M_PI)
float pow5(float x) {
return square(square(x)) * x;
}
float fresnelSchlick(float cosTheta, float F0) {
float x = clamp(1.0 - cosTheta, 0.0, 1.0);
float x5 = pow5(x);
return F0 + (1.0 - F0) * x5;
}
vec3 fresnelSchlick(float cosTheta, vec3 F0) {
float x = clamp(1.0 - cosTheta, 0.0, 1.0);
float x5 = pow5(x);
return F0 + (1.0 - F0) * x5;
}
float fresnelSchlick(float cosTheta, float F0, float F90) {
float x = clamp(1.0 - cosTheta, 0.0, 1.0);
float x5 = pow5(x);
return mix(F0, F90, x5);
}
vec3 fresnelSchlick(float cosTheta, vec3 F0, vec3 F90) {
float x = clamp(1.0 - cosTheta, 0.0, 1.0);
float x5 = pow5(x);
return mix(F0, F90, x5);
}
float fresnelSchlick(float cosTheta, float F0, float F90, float exponent) {
float x = clamp(1.0 - cosTheta, 0.0, 1.0);
return mix(F0, F90, pow(x, exponent));
}
vec3 fresnelSchlick(float cosTheta, vec3 F0, vec3 F90, float exponent) {
float x = clamp(1.0 - cosTheta, 0.0, 1.0);
return mix(F0, F90, pow(x, exponent));
}
vec3 forwardFacingNormal(vec3 N, vec3 V) {
return (dot(N, V) < 0.0) ? -N : N;
}
float goldenRatioSequence(int i) {
const float GOLDEN_RATIO = 1.6180339887498948;
return fract((float(i) + 1.0) * GOLDEN_RATIO);
}
struct FresnelData {
float ior;  // Physical Fresnel
vec3 value;
};
float ggxNdf(vec3 H, vec2 alpha) {
vec2 He = H.xy / alpha;
float denom = dot(He, He) + square(H.z);
return 1.0 / (M_PI * alpha.x * alpha.y * square(denom));
}
float ggxSmithG2(float NdotL, float NdotV, float alpha) {
float alpha2 = square(alpha);
float lambdaL = sqrt(alpha2 + (1.0 - alpha2) * square(NdotL));
float lambdaV = sqrt(alpha2 + (1.0 - alpha2) * square(NdotV));
return 2.0 / (lambdaL / NdotL + lambdaV / NdotV);
}
vec3 ggxDirAlbedo(float NdotV, float alpha, vec3 F0, vec3 F90) {
float x = NdotV;
float y = alpha;
float x2 = square(x);
float y2 = square(y);
vec4 r = vec4(0.1003, 0.9345, 1.0, 1.0) + vec4(-0.6303, -2.323, -1.765, 0.2281) * x +
vec4(9.748, 2.229, 8.263, 15.94) * y + vec4(-2.038, -3.748, 11.53, -55.83) * x * y +
vec4(29.34, 1.424, 28.96, 13.08) * x2 + vec4(-8.245, -0.7684, -7.507, 41.26) * y2 +
vec4(-26.44, 1.436, -36.11, 54.9) * x2 * y + vec4(19.99, 0.2913, 15.86, 300.2) * x * y2 +
vec4(-5.448, 0.6286, 33.37, -285.1) * x2 * y2;
vec2 AB = clamp(r.xy / r.zw, 0.0, 1.0);
return F0 * AB.x + F90 * AB.y;
}
float ggxDirAlbedo(float NdotV, float alpha, float F0, float F90) {
return ggxDirAlbedo(NdotV, alpha, vec3(F0), vec3(F90)).x;
}
vec3 ggxEnergyCompensation(float NdotV, float alpha, vec3 Fss) {
float Ess = ggxDirAlbedo(NdotV, alpha, 1.0, 1.0);
return 1.0 + Fss * (1.0 - Ess) / Ess;
}
float ggxEnergyCompensation(float NdotV, float alpha, float Fss) {
return ggxEnergyCompensation(NdotV, alpha, vec3(Fss)).x;
}
float iorToF0(float ior) {
return square((ior - 1.0) / (ior + 1.0));
}
float f0ToIor(float F0) {
float sqrtF0 = sqrt(clamp(F0, 0.01, 0.99));
return (1.0 + sqrtF0) / (1.0 - sqrtF0);
}
float fresnelDielectricValue(float ior, float cosTheta) {
if (cosTheta < 0.0)
return 1.0;
float g = ior * ior + cosTheta * cosTheta - 1.0;
if (g < 0.0)
return 1.0;
g = sqrt(g);
float gmc = g - cosTheta;
float gpc = g + cosTheta;
float x = gmc / gpc;
float y = (gpc * cosTheta - 1.0) / (gmc * cosTheta + 1.0);
return 0.5 * x * x * (1.0 + y * y);
}
FresnelData fresnelDielectric(float ior, float cosTheta) {
return FresnelData(ior, vec3(fresnelDielectricValue(ior, cosTheta)));
}
FresnelData fresnelSchlick(vec3 F0, vec3 F90, float exponent, float cosTheta) {
return FresnelData(0.0, fresnelSchlick(cosTheta, F0, F90, exponent));
}
vec3 refractionSolidSphere(vec3 R, vec3 N, float ior) {
R = refract(R, N, 1.0 / ior);
vec3 N1 = normalize(R * dot(R, N) - N * 0.5);
return refract(R, N1, ior);
}
vec3 environmentRadianceSample(vec3 normalW, vec3 viewW, float roughness) {
#ifdef USE_ENVMAP
vec3 reflectionW = reflect(-viewW, normalW);
EnvMapLevel envMapLevel = getEnvMapLevel(roughness);
return sampleEnvMapBlended(envMapLevel, reflectionW);
#else
return vec3(0.0);
#endif
}
vec3 environmentRadianceCombine(vec3 normalW, vec3 viewW, vec3 envColor, float roughness,
vec3 fresnel) {
#ifdef USE_ENVMAP
float clampCosnv = saturate(dot(normalW, viewW));  // TODO: reuse ndotv
vec3 brdf = getBrdf(roughness, fresnel, clampCosnv, vec3(1.0));
return envColor * brdf;
#else
return vec3(0.0);
#endif
}
vec3 environmentRadianceRefracted(vec3 normalW, vec3 viewW, float roughness, FresnelData fresnel) {
#ifdef USE_ENVMAP
float clampCosnv = saturate(dot(normalW, viewW));  // TODO: reuse ndotv
vec3 reflectionW = refractionSolidSphere(-viewW, normalW, fresnel.ior);
EnvMapLevel envMapLevel = getEnvMapLevel(roughness);
vec3 envColor = sampleEnvMapBlended(envMapLevel, reflectionW);
vec3 brdf = getBrdf(roughness, fresnel.value, clampCosnv, vec3(1.0));
return envColor * (vec3(1.0) - brdf);
#else
return vec3(0.0);
#endif
}
void uniformEdf(vec3 N, vec3 L, vec3 color, out vec3 result) {
result = color;
}
void extractColor3(vec3 in1, int index, out float out1) {
float N_r_color3_out = in1.x;
float N_g_color3_out = in1.y;
float N_b_color3_out = in1.z;
float N_sw_color3_out = 0.0;
if (float(index) < float(1)) {
N_sw_color3_out = N_r_color3_out;
} else if (float(index) < float(2)) {
N_sw_color3_out = N_g_color3_out;
} else if (float(index) < float(3)) {
N_sw_color3_out = N_b_color3_out;
} else if (float(index) < float(4)) {
N_sw_color3_out = 0.000000;
} else if (float(index) < float(5)) {
N_sw_color3_out = 0.000000;
}
out1 = N_sw_color3_out;
}
float orenNayarDiffuse(vec3 L, vec3 V, vec3 N, float NdotL, float roughness) {
float LdotV = clamp(dot(L, V), M_FLOAT_EPS, 1.0);
float NdotV = clamp(dot(N, V), M_FLOAT_EPS, 1.0);
float s = LdotV - NdotL * NdotV;
float stinv = (s > 0.0f) ? s / max(NdotL, NdotV) : 0.0;
float sigma2 = square(roughness * M_PI);
float A = 1.0 - 0.5 * (sigma2 / (sigma2 + 0.33));
float B = 0.45 * sigma2 / (sigma2 + 0.09);
return A + B * stinv;
}
void orenNayarDiffuseBsdfReflectionLightmap(vec3 L, vec3 V, vec3 P, float occlusion, float weight,
vec3 color, float roughness, vec3 normal,
inout BSDF bsdf) {
bsdf.throughput = vec3(0.0);
if (weight < M_FLOAT_EPS)
return;
bsdf.response = color * occlusion * weight * M_PI_INV;
if (roughness > 0.0)
bsdf.response *= orenNayarDiffuse(L, V, normal, 1.0, roughness);
}
void dielectricBsdfIndirect(vec3 V, float weight, vec3 tint, float ior, float roughness,
float roughnessSq, vec3 N, int scatter_mode, inout BSDF bsdf) {
if (weight < M_FLOAT_EPS)
return;
float NdotV = clamp(dot(N, V), M_FLOAT_EPS, 1.0);
vec3 safeTint = max(tint, 0.0);
vec3 fresnel = fresnelDielectric(ior, NdotV).value;
float F0 = iorToF0(ior);
vec3 comp = ggxEnergyCompensation(NdotV, roughnessSq, fresnel);
vec3 dirAlbedo = ggxDirAlbedo(NdotV, roughnessSq, F0, 1.0) * comp;
bsdf.throughput = 1.0 - dirAlbedo * weight;
vec3 sampledRadiance = environmentRadianceSample(N, V, roughness);
vec3 Li = environmentRadianceCombine(N, V, sampledRadiance, roughness, fresnel);
bsdf.response = Li * safeTint * comp * weight;
}
void generalizedSchlickBsdfReflection(vec3 L, vec3 V, vec3 P, float occlusion, float weight,
vec3 color0, vec3 color90, float exponent, float roughnessSq,
vec3 N, vec3 X, int distribution, int scatter_mode,
inout BSDF bsdf) {
if (weight < M_FLOAT_EPS) {
return;
}
X = normalize(X - dot(X, N) * N);
vec3 Y = cross(N, X);
vec3 H = normalize(L + V);
float NdotL = clamp(dot(N, L), M_FLOAT_EPS, 1.0);
float NdotV = clamp(dot(N, V), M_FLOAT_EPS, 1.0);
float VdotH = clamp(dot(V, H), M_FLOAT_EPS, 1.0);
vec3 Ht = vec3(dot(H, X), dot(H, Y), dot(H, N));
vec3 safeColor0 = max(color0, 0.0);
vec3 safeColor90 = max(color90, 0.0);
FresnelData fresnel = fresnelSchlick(safeColor0, safeColor90, exponent, VdotH);
float D = ggxNdf(Ht, vec2(roughnessSq));
float G = ggxSmithG2(NdotL, NdotV, roughnessSq);
vec3 comp = ggxEnergyCompensation(NdotV, roughnessSq, fresnel.value);
vec3 dirAlbedo = ggxDirAlbedo(NdotV, roughnessSq, safeColor0, safeColor90) * comp;
float avgDirAlbedo = dot(dirAlbedo, vec3(1.0 / 3.0));
bsdf.throughput = vec3(1.0 - avgDirAlbedo * weight);
bsdf.response = D * fresnel.value * G * comp * occlusion * weight / (4.0 * NdotV);
}
void generalizedSchlickBsdfIndirect(vec3 V, vec3 color0, vec3 color90, float exponent,
float roughness, float roughnessSq, vec3 N,
vec3 sampledRadiance, inout BSDF bsdf) {
float NdotV = clamp(dot(N, V), M_FLOAT_EPS, 1.0);
vec3 safeColor0 = max(color0, 0.0);
vec3 safeColor90 = max(color90, 0.0);
vec3 fresnel = fresnelSchlick(safeColor0, safeColor90, exponent, NdotV).value;
vec3 comp = ggxEnergyCompensation(NdotV, roughnessSq, fresnel);
vec3 dirAlbedo = ggxDirAlbedo(NdotV, roughnessSq, safeColor0, safeColor90) * comp;
float avgDirAlbedo = dot(dirAlbedo, vec3(1.0 / 3.0));
bsdf.throughput = vec3(1.0 - avgDirAlbedo);
vec3 Li = environmentRadianceCombine(N, V, sampledRadiance, roughness, fresnel);
bsdf.response = Li * comp;
}
vec3 surfaceTransmission(vec3 N, vec3 V, float roughness, FresnelData fresnel, vec3 tint) {
bool refractionTwoSided = true;
if (refractionTwoSided)
tint = square(tint);
return environmentRadianceRefracted(N, V, roughness, fresnel) * tint;
}
void dielectricBsdfTransmission(vec3 V, float weight, vec3 tint, float ior, float roughness,
float roughnessSq, vec3 N, int scatter_mode, inout BSDF bsdf) {
if (weight < M_FLOAT_EPS)
return;
float NdotV = clamp(dot(N, V), M_FLOAT_EPS, 1.0);
vec3 safeTint = max(tint, 0.0);
FresnelData fresnel = fresnelDielectric(ior, NdotV);
float F0 = iorToF0(ior);
vec3 comp = ggxEnergyCompensation(NdotV, roughnessSq, fresnel.value);
vec3 dirAlbedo = ggxDirAlbedo(NdotV, roughnessSq, F0, 1.0) * comp;
bsdf.throughput = 1.0 - dirAlbedo * weight;
if (scatter_mode != 0)
bsdf.response = surfaceTransmission(N, V, roughness, fresnel, safeTint) * weight;
}
void generalizedSchlickBsdfTransmission(vec3 V, float weight, vec3 color0, vec3 color90,
float exponent, float roughness, float roughnessSq, vec3 N,
int scatter_mode, inout BSDF bsdf) {
if (weight < M_FLOAT_EPS)
return;
float NdotV = clamp(dot(N, V), M_FLOAT_EPS, 1.0);
vec3 safeColor0 = max(color0, 0.0);
vec3 safeColor90 = max(color90, 0.0);
FresnelData fresnel = fresnelSchlick(safeColor0, safeColor90, exponent, NdotV);
vec3 comp = ggxEnergyCompensation(NdotV, roughnessSq, fresnel.value);
vec3 dirAlbedo = ggxDirAlbedo(NdotV, roughnessSq, safeColor0, safeColor90) * comp;
float avgDirAlbedo = dot(dirAlbedo, vec3(1.0 / 3.0));
bsdf.throughput = vec3(1.0 - avgDirAlbedo * weight);
if (scatter_mode != 0) {
float avgF0 = dot(safeColor0, vec3(1.0 / 3.0));
fresnel.ior = f0ToIor(avgF0);
bsdf.response = surfaceTransmission(N, V, roughness, fresnel, safeColor0) * weight;
}
}
struct SheenConfig {
vec3 sheenColor;
float sheenRoughness;
};
struct SheenParams {
float sheenRoughness;
float sheenIntensity;
vec3 sheenColorNormalized;
};
SheenConfig defaultSheenConfig() {
return SheenConfig(vec3(0.0), 0.0);
}
SheenParams sheenParams(SheenConfig config) {
SheenParams params;
float r = 0.0, g = 0.0, b = 0.0;
extractColor3(config.sheenColor, 0, r);
extractColor3(config.sheenColor, 1, g);
extractColor3(config.sheenColor, 2, b);
params.sheenRoughness = config.sheenRoughness;
params.sheenIntensity = max(max(r, g), b);
params.sheenColorNormalized =
params.sheenIntensity > 0.0 ? config.sheenColor / params.sheenIntensity : config.sheenColor;
return params;
}
float imageworksSheenNdf(float NdotH, float roughness) {
float invRoughness = 1.0 / max(roughness, 0.005);
float cos2 = NdotH * NdotH;
float sin2 = 1.0 - cos2;
return (2.0 + invRoughness) * pow(sin2, invRoughness * 0.5) / (2.0 * M_PI);
}
float imageworksSheenBrdf(float NdotL, float NdotV, float NdotH, float roughness) {
float D = imageworksSheenNdf(NdotH, roughness);
float F = 1.0;
float G = 1.0;
return D * F * G / (4.0 * (NdotL + NdotV - NdotL * NdotV));
}
float imageworksSheenDirAlbedo(float NdotV, float roughness) {
vec2 r =
vec2(13.67300, 1.0) + vec2(-68.78018, 61.57746) * NdotV +
vec2(799.08825, 442.78211) * roughness + vec2(-905.00061, 2597.49308) * NdotV * roughness +
vec2(60.28956, 121.81241) * square(NdotV) + vec2(1086.96473, 3045.55075) * square(roughness);
return clamp(r.x / r.y, 0.0, 1.0);
}
BSDF sheenReflectionBsdf(SheenParams params, vec3 L, vec3 V, vec3 P, float occlusion, vec3 N) {
BSDF bsdf = BSDF(vec3(0.0), vec3(1.0), 0.0);
float weight = params.sheenIntensity;
vec3 color = params.sheenColorNormalized;
float roughness = params.sheenRoughness;
if (weight < M_FLOAT_EPS)
return bsdf;
vec3 H = normalize(L + V);
float NdotL = clamp(dot(N, L), M_FLOAT_EPS, 1.0);
float NdotV = clamp(dot(N, V), M_FLOAT_EPS, 1.0);
float NdotH = clamp(dot(N, H), M_FLOAT_EPS, 1.0);
vec3 fr = color * imageworksSheenBrdf(NdotL, NdotV, NdotH, roughness);
float dirAlbedo = imageworksSheenDirAlbedo(NdotV, roughness);
bsdf.throughput = vec3(1.0 - dirAlbedo * weight);
bsdf.response = fr * NdotL * occlusion * weight;
return bsdf;
}
struct ClearcoatConfig {
float clearcoat;
float clearcoatRoughness;
};
ClearcoatConfig defaultClearcoatConfig() {
return ClearcoatConfig(0.0, 0.0);
}
struct ClearcoatParams {
float clearcoat;
float clearcoatRoughness;
float clearcoatRoughnessSq;
};
ClearcoatParams clearcoatParams(ClearcoatConfig config) {
ClearcoatParams result = ClearcoatParams(config.clearcoat, config.clearcoatRoughness, 0.0);
result.clearcoatRoughnessSq =
clamp(config.clearcoatRoughness * config.clearcoatRoughness, M_FLOAT_EPS, 1.0);
return result;
}
BSDF clearcoatReflectionBsdf(ClearcoatParams params, vec3 L, vec3 V, vec3 P, float occlusion,
vec3 normal, vec3 tangent) {
BSDF result = BSDF(vec3(0.0), vec3(1.0), 0.0);
if (params.clearcoat < M_FLOAT_EPS)
return result;
tangent = normalize(tangent - dot(tangent, normal) * normal);
vec3 Y = cross(normal, tangent);
vec3 H = normalize(L + V);
float NdotL = clamp(dot(normal, L), M_FLOAT_EPS, 1.0);
float NdotV = clamp(dot(normal, V), M_FLOAT_EPS, 1.0);
float VdotH = clamp(dot(V, H), M_FLOAT_EPS, 1.0);
vec3 Ht = vec3(dot(H, tangent), dot(H, Y), dot(H, normal));
float ior = 1.5;
FresnelData fresnel = fresnelDielectric(ior, VdotH);
float D = ggxNdf(Ht, vec2(params.clearcoatRoughnessSq));
float G = ggxSmithG2(NdotL, NdotV, params.clearcoatRoughnessSq);
float F0 = iorToF0(ior);
vec3 comp = ggxEnergyCompensation(NdotV, params.clearcoatRoughnessSq, fresnel.value);
vec3 dirAlbedo = ggxDirAlbedo(NdotV, params.clearcoatRoughnessSq, F0, 1.0) * comp;
result.throughput = 1.0 - dirAlbedo * params.clearcoat;
result.response = D * fresnel.value * G * comp * occlusion * params.clearcoat / (4.0 * NdotV);
return result;
}
BSDF clearcoatIndirectBsdf(ClearcoatParams params, vec3 V, vec3 normal) {
BSDF result = BSDF(vec3(0.0), vec3(1.0), 0.0);
dielectricBsdfIndirect(V, params.clearcoat, vec3(1.0), 1.5, params.clearcoatRoughness,
params.clearcoatRoughnessSq, normal, 0, result);
return result;
}
BSDF clearcoatTransmissionBsdf(ClearcoatParams params, vec3 V, vec3 normal) {
BSDF result = BSDF(vec3(0.0), vec3(1.0), 0.0);
dielectricBsdfTransmission(V, params.clearcoat, vec3(1.0), 1.5, params.clearcoatRoughness,
params.clearcoatRoughnessSq, normal, 0, result);
return result;
}
struct SpecularConfig {
float specular;
vec3 specularColor;
};
SpecularConfig defaultSpecularConfig() {
return SpecularConfig(1.0, vec3(1.0));
}
struct PbrConfig {
vec3 baseColor;
float metallic;
float roughness;
float occlusion;
float transmission;
float alpha;
float alphaCutoff;
float ior;
vec3 emissionColor;
float emissionStrength;
ClearcoatConfig clearcoat;
SheenConfig sheen;
SpecularConfig specular;
vec3 surfaceNormal;
vec3 surfaceTangent;
};
struct PbrParams {
vec3 dielectricF90;
vec3 dielectricF0;
float roughness;
float roughnessSq;
};
PbrConfig defaultPbrConfig(vec3 baseColor, float metallic, float roughness, vec3 normal,
vec3 tangent) {
PbrConfig params;
params.baseColor = baseColor;
params.metallic = metallic;
params.roughness = roughness;
params.occlusion = 0.0;
params.transmission = 0.0;
params.ior = 1.5;
params.alpha = 1.0;
params.alphaCutoff = 0.5;
params.emissionColor = baseColor;
params.emissionStrength = 0.0;
params.clearcoat = defaultClearcoatConfig();
params.sheen = defaultSheenConfig();
params.specular = defaultSpecularConfig();
params.surfaceNormal = normal;
params.surfaceTangent = tangent;
return params;
}
#if CUSTOM_SHADER_VERSION == 0
PbrConfig defaultPbrConfig(vec3 baseColor, float metallic, float roughness) {
return defaultPbrConfig(baseColor, metallic, roughness, vec3(0.0, 0.0, 1.0), vec3(1.0, 0.0, 0.0));
}
#endif
PbrParams pbrParams(SpecularConfig specular, float roughness, float ior) {
PbrParams params;
const float one_minus_ior_in1_tmp = 1.000000;
float one_minus_ior = one_minus_ior_in1_tmp - ior;
const float one_plus_ior_in1_tmp = 1.000000;
float one_plus_ior = one_plus_ior_in1_tmp + ior;
const vec3 dielectric_f90_in1_tmp = vec3(1.000000, 1.000000, 1.000000);
params.dielectricF90 = dielectric_f90_in1_tmp * specular.specular;
params.roughness = roughness;
params.roughnessSq = clamp(roughness * roughness, M_FLOAT_EPS, 1.0);
float ior_div = one_minus_ior / one_plus_ior;
float dielectric_f0_from_ior = ior_div * ior_div;
vec3 dielectric_f0_from_ior_specular_color = specular.specularColor * dielectric_f0_from_ior;
const float clamped_dielectric_f0_from_ior_specular_color_in2_tmp = 1.000000;
vec3 clamped_dielectric_f0_from_ior_specular_color = min(
dielectric_f0_from_ior_specular_color, clamped_dielectric_f0_from_ior_specular_color_in2_tmp);
params.dielectricF0 = clamped_dielectric_f0_from_ior_specular_color * specular.specular;
return params;
}
void fixReflectionThroughput(inout BSDF bsdf, float transmission) {
float minThroughput = max(0.8 - transmission, 0.0);
bsdf.throughput = max(bsdf.throughput, vec3(minThroughput));
}
SurfaceShader gltfPbrSurfaceShader(PbrConfig config, vec3 lightIntensity, bool useEnvMap) {
ClearcoatParams clearcoat = clearcoatParams(config.clearcoat);
SheenParams sheen = sheenParams(config.sheen);
PbrParams pbr = pbrParams(config.specular, config.roughness, config.ior);
SurfaceShader result = SurfaceShader(vec3(0.0), 0.0);
float backContrib = 0.0;
float frontContrib = 0.0;
vec3 position = vPositionW;
vec3 view = normalize(uCameraPosition - position);
vec3 normal = forwardFacingNormal(config.surfaceNormal, view);
vec3 tangent = config.surfaceTangent;
{
float occlusion = 1.0;
const float lightmapMultiplier = 3.0;
if (true) {
vec3 baseSurfaceNormal = normalize(vNormalW);
LightShader lightShader = LightShader(lightIntensity, baseSurfaceNormal);
vec3 L = lightShader.direction;
BSDF metalBsdf = BSDF(vec3(0.0), vec3(1.0), 0.0);
generalizedSchlickBsdfReflection(L, view, position, occlusion, 1.000000, config.baseColor,
vec3(1.000000, 1.000000, 1.000000), 5.000000,
pbr.roughnessSq, normal, tangent, 0, 0, metalBsdf);
BSDF diffuseBsdf = BSDF(vec3(0.0), vec3(1.0), 0.0);
orenNayarDiffuseBsdfReflectionLightmap(L, view, position, occlusion, 1.000000,
config.baseColor, 0.000000, normal, diffuseBsdf);
BSDF reflectionBsdf = BSDF(vec3(0.0), vec3(1.0), 0.0);
generalizedSchlickBsdfReflection(L, view, position, occlusion, 1.000000, pbr.dielectricF0,
pbr.dielectricF90, 5.000000, pbr.roughnessSq, normal,
tangent, 0, 0, reflectionBsdf);
fixReflectionThroughput(reflectionBsdf, config.transmission);
BSDF dielectricBsdf = combineBsdf(reflectionBsdf, diffuseBsdf);
BSDF base_mix_out = mixBsdf(dielectricBsdf, metalBsdf, config.metallic);
#ifdef USE_SHEEN
BSDF sheenBsdf = sheenReflectionBsdf(sheen, L, view, position, occlusion, normal);
fixReflectionThroughput(sheenBsdf, config.transmission);
BSDF sheenLayer = combineBsdf(sheenBsdf, base_mix_out);
vec3 sheenThroughput = sheenBsdf.throughput;
#else
BSDF sheenLayer = base_mix_out;
vec3 sheenThroughput = vec3(1.0);
#endif
#ifdef USE_CLEARCOAT
BSDF clearcoatBsdf =
clearcoatReflectionBsdf(clearcoat, L, view, position, occlusion, normal, tangent);
BSDF clearcoatLayer = combineBsdf(clearcoatBsdf, sheenLayer);
vec3 clearcoatThroughput = clearcoatBsdf.throughput;
#else
BSDF clearcoatLayer = sheenLayer;
vec3 clearcoatThroughput = vec3(1.0);
#endif
result.color += lightShader.intensity * lightmapMultiplier * clearcoatLayer.response;
float transContrib =
config.transmission *
getLuminance(reflectionBsdf.throughput * sheenThroughput * clearcoatThroughput) *
(1.0 - config.metallic);
float lightContrib = getLuminance(lightShader.intensity) * lightmapMultiplier;
backContrib += lightContrib * transContrib;
frontContrib += lightContrib * (1.0 - transContrib);
}
{
float luminance = getLuminance(lightIntensity) * 0.75;
float shadowingFactor =
mix(0.4, 1.0, luminance) * mix(min(luminance, 1.0), 1.0, config.metallic);
occlusion = shadowingFactor;
}
if (useEnvMap) {
BSDF metalBsdf = BSDF(vec3(0.0), vec3(1.0), 0.0);
vec3 sampledRadiance = environmentRadianceSample(normal, view, config.roughness);
if (config.metallic > 0.0) {
generalizedSchlickBsdfIndirect(view, config.baseColor, vec3(1.0), 5.0, pbr.roughness,
pbr.roughnessSq, normal, sampledRadiance, metalBsdf);
}
BSDF reflectionBsdf = BSDF(vec3(0.0), vec3(1.0), 0.0);
generalizedSchlickBsdfIndirect(view, pbr.dielectricF0, pbr.dielectricF90, 5.0, pbr.roughness,
pbr.roughnessSq, normal, sampledRadiance, reflectionBsdf);
BSDF dielectricBsdf = reflectionBsdf;
BSDF base_mix_out = mixBsdf(dielectricBsdf, metalBsdf, config.metallic);
#ifdef USE_CLEARCOAT
BSDF clearcoatBsdf = clearcoatIndirectBsdf(clearcoat, view, normal);
BSDF clearcoatLayer = combineBsdf(clearcoatBsdf, base_mix_out);
vec3 clearcoatThroughput = clearcoatBsdf.throughput;
#else
BSDF clearcoatLayer = base_mix_out;
vec3 clearcoatThroughput = vec3(1.0);
#endif
result.color += occlusion * clearcoatLayer.response;
float transContrib = config.transmission *
getLuminance(reflectionBsdf.throughput * clearcoatThroughput) *
(1.0 - config.metallic);
backContrib += transContrib * occlusion;
frontContrib += (1.0 - transContrib) * occlusion;
}
if (true) {
vec3 emission_out = vec3(0.0);
uniformEdf(normal, view, config.emissionColor * config.emissionStrength, emission_out);
result.color += emission_out;
}
if (config.transmission > 0.0 && useEnvMap) {
BSDF metalBsdf = BSDF(vec3(0.0), vec3(1.0), 0.0);
generalizedSchlickBsdfTransmission(view, 1.000000, config.baseColor,
vec3(1.000000, 1.000000, 1.000000), 5.000000,
pbr.roughness, pbr.roughnessSq, normal, 0, metalBsdf);
BSDF diffuseBsdf = BSDF(vec3(0.0), vec3(1.0), 0.0);
BSDF reflectionBsdf = BSDF(vec3(0.0), vec3(1.0), 0.0);
generalizedSchlickBsdfTransmission(view, 1.000000, pbr.dielectricF0, pbr.dielectricF90,
5.000000, pbr.roughness, pbr.roughnessSq, normal, 0,
reflectionBsdf);
BSDF transmissionBsdf = BSDF(vec3(0.0), vec3(1.0), 0.0);
dielectricBsdfTransmission(view, 1.000000, config.baseColor, config.ior, pbr.roughness,
pbr.roughnessSq, normal, 1, transmissionBsdf);
BSDF transmission_mix_out = mixBsdf(diffuseBsdf, transmissionBsdf, config.transmission);
BSDF dielectricBsdf = combineBsdf(reflectionBsdf, transmission_mix_out);
BSDF base_mix_out = mixBsdf(dielectricBsdf, metalBsdf, config.metallic);
#ifdef USE_CLEARCOAT
BSDF clearcoatBsdf = clearcoatTransmissionBsdf(clearcoat, view, normal);
BSDF clearcoatLayer = combineBsdf(clearcoatBsdf, base_mix_out);
#else
BSDF clearcoatLayer = base_mix_out;
#endif
result.color += clearcoatLayer.response;
frontContrib += getLuminance(clearcoatLayer.response);
}
result.transparency = backContrib / (frontContrib + backContrib + 0.015);
}
return result;
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform float emissionStrength;
#ifdef USE_EXPOSURE_AND_GAMMA
uniform vec4 camera_exposure_gamma;
#else
const vec4 camera_exposure_gamma = vec4(1.0, 1.0, 0.0, 0.0);
#endif
uniform int u_hdrOutput;
uniform int u_useEnvMap;
#ifndef CUSTOM_PBR_SHADER
uniform vec2 clearcoat;  // clearcoatStrength, clearcoatRoughness
uniform vec4 sheen;      // sheenColor (RGB), sheenRoughness
uniform vec4 specular;   // specularColor (RGB), specularStrength
#endif
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
float lengthSq(vec2 v) {
return dot(v, v);
}
vec3 computeTangentAdvanced(vec2 texCoord, vec3 normalW) {
#ifdef USES_TEX_COORDS
return computeTangent(texCoord, normalW);
#else
vec3 denormTangent = dFdx(vPositionW);
return normalize(denormTangent - normalW * dot(normalW, denormTangent));
#endif
}
void NG_shpk_wrapper(vec3 shpk_positionW, vec3 shpk_normalW, vec3 shpk_tangentW,
vec3 shpk_bitangentW, vec2 shpk_texcoordW, float shpk_time, out PbrConfig);
#define ALPHA_MODE_OPAQUE 0
#define ALPHA_MODE_MASK 1
#define ALPHA_MODE_BLEND 2
void main() {
vec2 texCoord = vUv0;
bool useEnvMap = false;
#ifdef USE_ENVMAP
useEnvMap = u_useEnvMap == 1;
#endif
#ifdef CUSTOM_PBR_SHADER
vec3 normalW = normalize((gl_FrontFacing ? 1.0 : -1.0) * vNormalW);
vec3 tangentW = computeTangentAdvanced(texCoord, normalW);
vec3 bitangentW = cross(normalW, tangentW);
PbrConfig pbr;
NG_shpk_wrapper(vPositionW, normalW, tangentW, bitangentW, texCoord, 0.0, pbr);
#if CUSTOM_SHADER_VERSION == 0
pbr.surfaceNormal = normalW;
pbr.surfaceTangent = tangentW;
#endif
if (ALPHA_MODE == ALPHA_MODE_MASK) {
if (pbr.alpha < pbr.alphaCutoff)
discard;
}
float alpha = ALPHA_MODE == 0 ? 1.0 : pbr.alpha;
#else
float alpha;
vec3 baseColor = getBaseColorHook(alpha);
vec3 normalW = computeNormal();
vec3 tangentW = computeTangentAdvanced(texCoord, normalW);
#ifdef USE_CHROMA_KEY
float dist = chromaKeyShapeFn(uChromaKeyDeltaCoeff, rgb2hci(baseColor), rgb2hci(uChromaKeyColor));
alpha *= chromaKeyEdgeFn(dist);
#endif
#if defined(USE_BASE_COLOR_TEXTURE)
if (alpha < alphaDiscardThreshold)
discard;
#endif
float roughness = 1.0;
float metallic = 0.0;
#ifdef USE_ENVMAP
if (useEnvMap) {
roughness = getRoughness();
metallic = getMetallic();
}
#endif
PbrConfig pbr = defaultPbrConfig(baseColor, metallic, roughness, normalW, tangentW);
pbr.emissionStrength = emissionStrength;
pbr.clearcoat.clearcoat = clearcoat.x;
pbr.clearcoat.clearcoatRoughness = clearcoat.y;
pbr.sheen.sheenColor = sheen.rgb;
pbr.sheen.sheenRoughness = sheen.w;
pbr.specular.specularColor = specular.rgb;
pbr.specular.specular = specular.w;
{
vec3 viewW = normalize(uCameraPosition - vPositionW);
float clampCosnv = saturate(dot(normalW, viewW));
float envMapFresnel = roughness * roughness - 2.0 * roughness + 1.0;
fresnelSchlickEnv(pbr.specular.specularColor, envMapFresnel, clampCosnv, alpha);
}
#endif  // !CUSTOM_PBR_SHADER
#ifdef USE_HIGHLIGHT
if (highlightMix != 0.0) {
pbr.baseColor = mix(pbr.baseColor, uHighlight, highlightMix);
alpha = mix(alpha, 1.0, highlightMix);
}
#endif
#ifdef USE_STANDARD_PBR_MODEL
vec3 lightIntensity = getLightIntensity();
if (ALPHA_MODE == ALPHA_MODE_BLEND && pbr.transmission > 0.0) {
pbr.metallic = min(pbr.metallic + 0.5, 1.0);
alpha = alpha * (1.0 - min(0.8, pbr.transmission));
}
vec3 result = addSpecular(pbr.baseColor, lightIntensity, alpha, pbr.metallic, pbr.roughness);
result = result + pbr.baseColor * pbr.emissionColor * pbr.emissionStrength;
if (pbr.metallic > 0.0) {
vec3 view = normalize(uCameraPosition - vPositionW);
vec3 normal = forwardFacingNormal(pbr.surfaceNormal, view);
BSDF metalBsdf = BSDF(vec3(0.0), vec3(1.0), 0.0);
float roughnessSq = clamp(pbr.roughness * pbr.roughness, M_FLOAT_EPS, 1.0);
generalizedSchlickBsdfReflection(normalize(vNormalW), view, vPositionW, 1.0, 1.0, pbr.baseColor,
vec3(1.0), 5.0, roughnessSq, normal, pbr.surfaceTangent, 0, 0,
metalBsdf);
result = result + metalBsdf.response * pbr.metallic;
}
#ifdef USE_SHEEN
SheenParams sheen = sheenParams(pbr.sheen);
if (sheen.sheenIntensity > 0.0) {
vec3 view = normalize(uCameraPosition - vPositionW);
vec3 normal = forwardFacingNormal(pbr.surfaceNormal, view);
BSDF sheenBsdf = sheenReflectionBsdf(sheen, normalize(vNormalW), view, vPositionW, 1.0, normal);
fixReflectionThroughput(sheenBsdf, pbr.transmission);
result = result * sheenBsdf.throughput + sheenBsdf.response;
}
#endif
#else
vec3 lightIntensity = getLightIntensity();
SurfaceShader resultFull = gltfPbrSurfaceShader(pbr, lightIntensity, useEnvMap);
vec3 result = resultFull.color;
if (ALPHA_MODE == ALPHA_MODE_BLEND && pbr.transmission > 0.0) {
alpha = alpha * (1.0 - resultFull.transparency);
}
#endif  // !USE_STANDARD_PBR_MODEL
#ifdef USE_FOG
float distance = length(vPositionV);
result = addFog(result, distance, vPositionW);
#endif
if (u_hdrOutput == 1) {
if (alpha < 0.5)
discard;
fragColor = hdrEncode(result);
} else {
vec3 exposedColor = pow(camera_exposure_gamma.x * result.xyz, vec3(camera_exposure_gamma.y));
vec3 gammaColor = linearToGammaToneMapped(exposedColor);
#ifdef USE_COLORMAP
fragColor = vec4(colormap(colorMap, min(gammaColor, 1.0), colorMapIntensity), alpha);
#else
fragColor = vec4(gammaColor, alpha);
#endif
}
}
`,"universal_material_vertex.glsl":`const float PI = 3.14159265358979;
const float RECIPROCAL_PI2 = 0.15915494;
float saturate(in float a) {
return clamp(a, 0.0, 1.0);
}
vec3 inverseTransformDirection(in vec3 normal, in mat4 matrix) {
return normalize((vec4(normal, 0.0) * matrix).xyz);
}
vec3 sphericalDecode(in vec2 spNormal) {
float theta = (spNormal.x / 254.0 + 0.5) * PI;
float phi = spNormal.y * (PI / 127.0);
float sinTheta = sin(theta);
return vec3(sinTheta * cos(phi), sinTheta * sin(phi), cos(theta));
}
vec4 transformPosition() {
return vec4(t0.x * position.x + t0.y * position.y + t0.z * position.z + t0.w,
t1.x * position.x + t1.y * position.y + t1.z * position.z + t1.w,
t2.x * position.x + t2.y * position.y + t2.z * position.z + t2.w, 1.0);
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform CameraBuffer {
mat4 projectionMatrix;
mat4 viewProjMatrix;
mat4 viewMatrix;
mat4 invViewMatrix;
vec4 cameraPosition_pad;
};
#define uCameraPosition cameraPosition_pad.xyz
#endif
mat4 getModelViewMatrix() {
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
return modelViewMatrix;
#else
#ifdef MODEL_MATRIX
return viewMatrix * modelMatrix;
#else
return viewMatrix;
#endif
#endif
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#define MODEL_MATRIX
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = projectionMatrix * modelViewMatrix * worldPos;
}
#else  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec4 worldPos) {
#ifdef MODEL_MATRIX
gl_Position = viewProjMatrix * modelMatrix * worldPos;
#else
gl_Position = viewProjMatrix * worldPos;
#endif  // MODEL_MATRIX
}
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec3 worldPos) {
setClipPositionFromWorldPos(vec4(worldPos, 1.0));
}
void setClipPositionFromViewPos(in vec4 viewPos) {
gl_Position = projectionMatrix * viewPos;
}
void setClipPositionFromViewPos(in vec3 viewPos) {
setClipPositionFromViewPos(vec4(viewPos, 1.0));
}
vec3 multiplyPositionByModelMatrix(in vec4 position) {
#ifdef MODEL_MATRIX
return (modelMatrix * position).xyz;
#else
return position.xyz;
#endif
}
vec3 multiplyPositionByModelMatrix(in vec3 position) {
return multiplyPositionByModelMatrix(vec4(position, 1.0));
}
vec3 multiplyDirectionByModelMatrix(in vec3 direction) {
#ifdef MODEL_MATRIX
return (modelMatrix * vec4(direction, 0.0)).xyz;
#else
return direction;
#endif
}
out vec2 vUv0;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec4 uUv0OffsetAndScale;
uniform vec2 uUv0RotationCosSin;
#endif
#ifdef USE_LIGHTMAP
centroid out vec2 vUv1;
#endif
#if defined(USE_BUMP_TEXTURE) || defined(USE_FOG)
out vec3 vPositionV;
#endif
#ifdef USE_BUMP_TEXTURE
out vec3 vNormalV;
#endif
out vec3 vPositionW;
out vec3 vNormalW;
void modifyMvPositionHook(inout vec4 mvPosition, in vec3 normal);
void main() {
const vec2 center = vec2(0.5, 0.5);
mat2 uvRot =
mat2(uUv0RotationCosSin.x, -uUv0RotationCosSin.y, uUv0RotationCosSin.y, uUv0RotationCosSin.x);
vUv0 = uvRot * (uv0 * uUv0OffsetAndScale.zw - center) + center + uUv0OffsetAndScale.xy;
vec4 transformedPosition = transformPosition();
mat4 modelViewMatrix = getModelViewMatrix();
vec4 mvPosition = modelViewMatrix * transformedPosition;
#ifdef USE_LIGHTMAP
float zeroOrOne = min(uv1.x + uv1.y, 1.0);
vUv1 = uv1 * uv1Mod.zw + uv1Mod.xy * zeroOrOne;
#endif
vec3 n = sphericalDecode(sphericalNormal);
vec3 normal = vec3(dot(t0.xyz, n), dot(t1.xyz, n), dot(t2.xyz, n));
modifyMvPositionHook(mvPosition, normal);
#if defined(USE_BUMP_TEXTURE) || defined(USE_FOG)
vPositionV = -mvPosition.xyz;
#endif
#if defined(USE_BUMP_TEXTURE)
#if defined(NON_UNIFORM_SCALE)
vNormalV = normalize(mat3(normalMatrix) * normal);
#else
vNormalV = normalize(mat3(modelViewMatrix) * normal);
#endif
#endif
vPositionW = multiplyPositionByModelMatrix(transformedPosition);
vNormalW = multiplyDirectionByModelMatrix(normal);
vNormalW = normalize(vNormalW);
gl_Position = projectionMatrix * mvPosition;
}
`,"water.glsl":`#ifdef USE_NORMAL_TEXTURE
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform float time;
uniform float wavesSpeed;
uniform float wavesScale;
uniform float refractionFactor;
#endif
vec4 getNoise(in vec2 uv, in float wavesTime) {
vec2 uv0 = (uv / 103.0) + vec2(wavesTime / 17.0, wavesTime / 29.0);
vec2 uv1 = uv / 107.0 - vec2(wavesTime / -19.0, wavesTime / 31.0);
vec2 uv2 = uv / vec2(897.0, 983.0) + vec2(wavesTime / 101.0, wavesTime / 97.0);
vec2 uv3 = uv / vec2(991.0, 877.0) - vec2(wavesTime / 109.0, wavesTime / -113.0);
vec4 noise = texture(normalTexture, uv0) + texture(normalTexture, uv1) +
texture(normalTexture, uv2) + texture(normalTexture, uv3);
return noise * 0.5 - 1.0;
}
vec3 addSpecularHook(in vec3 baseColor, in vec3 totalIntensity, inout float opacity) {
vec3 toEyeW = uCameraPosition - vPositionW;
vec3 viewW = normalize(toEyeW);
vec4 noise = getNoise(vPositionW.xy * wavesScale, time * wavesSpeed);
vec3 normalW = normalize(noise.xyz);
float clampCosnv = saturate(dot(normalW, viewW));
const float waterF0 = 0.02;
vec3 specularColor = vec3(waterF0);
vec3 reflectionW = reflect(-viewW, normalW);
vec3 refractionW = refract(-viewW, normalW, 0.75);
EnvMapLevel mirrorLevel = EnvMapLevel(0.0, 0.0, 0.0);
vec3 reflectedEnv = sampleEnvMap(mirrorLevel, normalize(reflectionW), envMap[0], 0);
vec3 refractedEnv =
refractionFactor * sampleEnvMap(mirrorLevel, normalize(refractionW), envMap[0], 0);
vec3 fresnel = fresnelSchlickEnv(specularColor, 1.0, clampCosnv, opacity);
vec3 totalSpec = reflectedEnv * fresnel + refractedEnv * (1.0 - fresnel);
vec3 diffuseIntensity = totalIntensity * 0.98;
float luminance = getLuminance(totalIntensity);
return totalSpec * mix(0.4, 1.0, luminance) + baseColor * diffuseIntensity;
}
#else  // NOT USE_NORMAL_TEXTURE
vec3 addSpecularHook(in vec3 baseColor, in vec3 totalIntensity, inout float opacity) {
return baseColor * totalIntensity;
}
#endif
vec3 getBaseColorHook(out float alpha) {
return getBaseColor(alpha);
}
`,"wireframe_fragment.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec3 uLineColor;
uniform float maxDistance;
uniform float lineThickness;
uniform float backsideLineThickness;
#endif
in vec3 vBaryCentric;
in vec3 vPositionV;
const float LOG2 = 1.442695;
const float maxOpacity = 0.9;
const float minOpacity = 0.4;
const float maxSize = 1.5;
const float minSize = 0.9;
const vec3 luma = vec3(0.299, 0.587, 0.114);
float edgeFactor(float size) {
vec3 d = fwidth(vBaryCentric);
vec3 r = smoothstep(vec3(0.0), d * size, vBaryCentric);
return min(min(r.x, r.y), r.z);
}
void main(void) {
float distanceSq = dot(vPositionV, vPositionV);
float distanceExp = 1.0 - exp2(-(1.0 / maxDistance) * distanceSq * LOG2);
float opacity = max(lineThickness, mix(maxOpacity, minOpacity, distanceExp));
float size = max(lineThickness, mix(maxSize, minSize, distanceExp));
#if defined(USE_TRANSPARENT_WIREFRAME)
vec3 color = uLineColor;
if (!gl_FrontFacing) {
opacity *= 0.5;
size = max(backsideLineThickness, mix(maxSize, minSize, distanceExp));
float luminance = dot(uLineColor, luma);
color = mix(uLineColor, vec3(luminance), 0.65);
}
float edge = edgeFactor(size);
if (edge < 1.0) {
fragColor = vec4(color, (1.0 - edge) * opacity);
} else {
discard;
}
#else
opacity = (1.0 - edgeFactor(size)) * opacity;
fragColor = vec4(mix(vec3(1.0), uLineColor, opacity), 1.0);
#endif
}
`,"wireframe_vertex.glsl":`vec4 transformPosition() {
return vec4(t0.x * position.x + t0.y * position.y + t0.z * position.z + t0.w,
t1.x * position.x + t1.y * position.y + t1.z * position.z + t1.w,
t2.x * position.x + t2.y * position.y + t2.z * position.z + t2.w, 1.0);
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform CameraBuffer {
mat4 projectionMatrix;
mat4 viewProjMatrix;
mat4 viewMatrix;
mat4 invViewMatrix;
vec4 cameraPosition_pad;
};
#define uCameraPosition cameraPosition_pad.xyz
#endif
mat4 getModelViewMatrix() {
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
return modelViewMatrix;
#else
#ifdef MODEL_MATRIX
return viewMatrix * modelMatrix;
#else
return viewMatrix;
#endif
#endif
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#define MODEL_MATRIX
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = projectionMatrix * modelViewMatrix * worldPos;
}
#else  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec4 worldPos) {
#ifdef MODEL_MATRIX
gl_Position = viewProjMatrix * modelMatrix * worldPos;
#else
gl_Position = viewProjMatrix * worldPos;
#endif  // MODEL_MATRIX
}
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec3 worldPos) {
setClipPositionFromWorldPos(vec4(worldPos, 1.0));
}
void setClipPositionFromViewPos(in vec4 viewPos) {
gl_Position = projectionMatrix * viewPos;
}
void setClipPositionFromViewPos(in vec3 viewPos) {
setClipPositionFromViewPos(vec4(viewPos, 1.0));
}
vec3 multiplyPositionByModelMatrix(in vec4 position) {
#ifdef MODEL_MATRIX
return (modelMatrix * position).xyz;
#else
return position.xyz;
#endif
}
vec3 multiplyPositionByModelMatrix(in vec3 position) {
return multiplyPositionByModelMatrix(vec4(position, 1.0));
}
vec3 multiplyDirectionByModelMatrix(in vec3 direction) {
#ifdef MODEL_MATRIX
return (modelMatrix * vec4(direction, 0.0)).xyz;
#else
return direction;
#endif
}
out vec3 vBaryCentric;
out vec3 vPositionV;
void main() {
int order = gl_VertexID % 3;
if (order == 0) {
vBaryCentric = vec3(1.0, 0.0, 0.0);
} else if (order == 1) {
vBaryCentric = vec3(0.0, 1.0, 0.0);
} else {
vBaryCentric = vec3(0.0, 0.0, 1.0);
}
mat4 modelViewMatrix = getModelViewMatrix();
vec4 transformedPosition = transformPosition();
vec4 mvPosition = modelViewMatrix * transformedPosition;
vPositionV = -mvPosition.xyz;
gl_Position = projectionMatrix * modelViewMatrix * transformedPosition;
}
`},_r=class _r{constructor(e,t){r(this,"id");r(this,"code");this.id=e,this.code=t}static get(e){const i=Xd[e];return new _r(e,i)}static makeInline(e){const t=_r._inlineId++;return new _r("inline_"+t,e)}static reloadShaders(e){fetch(ii("shaders.js")).then(t=>{t.text().then(i=>{const n=i.split(`
`).splice(1).join(`
`),o=JSON.parse(n),a=Xd;for(const l in o)Object.prototype.hasOwnProperty.call(o,l)&&(a[l]=o[l]);e()})})}hash(){let e=0;for(let t=0;t<this.code.length;t++){const i=this.code.charCodeAt(t);e=(e<<5)-e+i,e|=0}return e}equals(e){return this.id===e.id&&this.code===e.code}};r(_r,"_inlineId",0);let ln=_r;const E0=Object.freeze((()=>{const s=new zd,e=new Float32Array([0,0]);return s.uv0=e,s.uv1=new Uint16Array([0,0]),s.uv1Mod=new Float32Array([0,0,1/65535,1/65535]),s.t0=new Float32Array([1,0,0,0]),s.t1=new Float32Array([0,1,0,0]),s.t2=new Float32Array([0,0,1,0]),s.sphericalNormal=e,s})()),T0=Object.freeze(["position","sphericalNormal","uv0","uv1","uv1Mod","t0","t1","t2"]),qd=ln.makeInline(""),S0=Object.keys(Rr).map(s=>"TONE_MAPPING_"+s),w0=s=>{s===null?s=Gd:Object.values(Rr).includes(s)||(Ke(!1,"Invalid tone mapping mode value"),s=Gd);for(const[e,t]of Object.entries(Rr))if(t==s)return"TONE_MAPPING_"+e;return""};var Yd=(s=>(s.MAJOR_LIGHTING_PROPERTY_UPDATED="majorLightingPropertyUpdated",s.MATERIAL_UPDATED="materialUpdated",s.RECOMPILE_NEEDED="recompileNeeded",s.DISPOSED="materialDisposed",s))(Yd||{});const Bs=class Bs extends ei{constructor(t){super();r(this,"name","");r(this,"attributes");r(this,"vertexShaderName");r(this,"_vertexShaderBody");r(this,"_vertexShaderHooks");r(this,"fragmentShaderName");r(this,"_fragmentShaderBody");r(this,"_fragmentShaderHooks");r(this,"shaderParams");r(this,"_updated");r(this,"side",Fi.FRONT);r(this,"doNotOverrideSide",!1);r(this,"_opacity",1);r(this,"transparent",!1);r(this,"transparentRenderOrder",0);r(this,"blending",yi.DISABLED);r(this,"blendSrc",Z.SRC_ALPHA);r(this,"blendDst",Z.ONE_MINUS_SRC_ALPHA);r(this,"blendEquation",Z.FUNC_ADD);r(this,"blendSrcAlpha",null);r(this,"blendDstAlpha",null);r(this,"blendEquationAlpha",null);r(this,"depthTest",!0);r(this,"depthWrite",!0);r(this,"colorWrite",!0);r(this,"_hideFromLightProbes",!1);r(this,"_defines",new Set);r(this,"_definesString",null);r(this,"_lightmapSize",new tt);r(this,"_lightmapThreshold",new Ce);r(this,"uniforms",{});r(this,"uniformBufferData");r(this,"defaultAttributeValues",E0);r(this,"index0AttributeName");r(this,"visible",!0);r(this,"_programNeedsUpdate",!0);r(this,"program",null);r(this,"_sharedMaterialState",null);r(this,"lightmapSupported",!1);r(this,"fogSupported",!1);r(this,"hdrOutputSupported",!1);r(this,"colorMapSupported",!1);r(this,"exposureAndGammaSupported",!1);r(this,"toneMappingSupported",!1);r(this,"renderSteps",1);r(this,"renderResourceId",-1);r(this,"_onSharedMaterialStateUpdate",()=>{this._applySharedState(),this._updated()});Bs._materialRenderResourceIdCount+=1,this.renderResourceId=Bs._materialRenderResourceIdCount,this.shaderParams=t,this.attributes=T0,t.vsName&&t.vsName,t.fsName&&t.fsName,this.vertexShaderName=t.vsName,this._vertexShaderBody=ln.get(t.vsName),this._vertexShaderHooks=t.vsHooks?ln.get(t.vsHooks):qd,this.fragmentShaderName=t.fsName,this._fragmentShaderBody=ln.get(t.fsName),this._fragmentShaderHooks=t.fsHooksCode?ln.makeInline(t.fsHooksCode):t.fsHooks?ln.get(t.fsHooks):qd,this._updated=()=>this.dispatchEvent({type:Bs.eventType.MATERIAL_UPDATED}),this.uniformBufferData=t.uniformBufferData}accessUniform(t){return Object.prototype.hasOwnProperty.call(this.uniforms,t),this.uniforms[t]}get isAnimated(){return!1}get isPlaying(){return!1}update(t){}rewind(){console.assert(!1)}play(){console.assert(!1)}pause(){console.assert(!1)}get envMapMirror(){return!1}get hideFromLightProbes(){return this._hideFromLightProbes}set hideFromLightProbes(t){this._hideFromLightProbes=t}get programNeedsUpdate(){return this._programNeedsUpdate}fillMaterialUniformDataFromUniforms(){}set programNeedsUpdate(t){this._definesString=null,this._programNeedsUpdate=t,this.dispatchEvent({type:Bs.eventType.RECOMPILE_NEEDED})}get lightmapEnabled(){return this.lightmapSupported&&this.sharedMaterialState!==null&&this.sharedMaterialState.lightmapEnabled}get sharedMaterialState(){return this._sharedMaterialState}set sharedMaterialState(t){const i=this._sharedMaterialState;if(this._sharedMaterialState=t,this._sharedMaterialState===null){i==null||i.removeEventListener(il.eventType.UPDATED,this._onSharedMaterialStateUpdate);return}this._sharedMaterialState.addEventListener(il.eventType.UPDATED,this._onSharedMaterialStateUpdate),this._applySharedState()}hasDefine(t){return this._defines.has(t)}addDefine(t){this.hasDefine(t)||(this._defines.add(t),this.programNeedsUpdate=!0)}removeDefine(t){this.hasDefine(t)&&(this._defines.delete(t),this.programNeedsUpdate=!0)}removeDefines(t){let i=!1;for(const n of this._defines)t(n)&&(this._defines.delete(n),i=!0);return i&&(this.programNeedsUpdate=!0),i}condDefine(t,i){return t?this.addDefine(i):this.removeDefine(i),t}getDefines(){return this._defines}_getDefinesString(){if(this._definesString===null){const t=[];for(const i of this._defines)t.push("#define "+i);t.sort(),this._definesString=t.join(`
`)}return this._definesString}generateProgramId(){return[this._fragmentShaderBody.id,this._fragmentShaderHooks.id,this._getDefinesString(),this._vertexShaderBody.id,this._vertexShaderHooks.id].join("$")}tryToRefreshShaderCode(){const t=ln.get(this.vertexShaderName),i=ln.get(this.fragmentShaderName),n=!t.equals(this._vertexShaderBody)||!i.equals(this._fragmentShaderBody);return n&&(this._vertexShaderBody=t,this._fragmentShaderBody=i),n}generateVertexShader(t=`#define DEV_DISABLE_UNIFORM_BUFFERS 
 #define NON_UNIFORM_SCALE`,i=""){return["#version 300 es","precision highp float;","precision highp int;",this._getDefinesString(),t,"#ifdef DEV_DISABLE_UNIFORM_BUFFERS","uniform mat4 modelMatrix;","uniform mat4 modelViewMatrix;","uniform mat3 normalMatrix;","uniform mat4 projectionMatrix;","uniform mat4 viewMatrix;","uniform vec3 uCameraPosition;","#else",i,"#endif","in vec3 position;","in vec2 sphericalNormal;","in vec2 uv0;","in vec2 uv1;","in vec4 uv1Mod;","in vec4 t0;","in vec4 t1;","in vec4 t2;",this._vertexShaderBody.code,this._vertexShaderHooks.code].join(`
`)}generateFragmentShader(t="#define DEV_DISABLE_UNIFORM_BUFFERS",i=""){return["#version 300 es","precision "+Qe.gl.fragmentPrecision+" float;","precision "+Qe.gl.fragmentPrecision+" int;",t,this._getDefinesString(),"#ifdef DEV_DISABLE_UNIFORM_BUFFERS","uniform mat4 viewMatrix;","uniform vec3 uCameraPosition;","#else",i,"#endif","out vec4 fragColor;",this._fragmentShaderBody.code,this._fragmentShaderHooks.code].join(`
`)}dispose(){this.dispatchEvent({type:Bs.eventType.DISPOSED})}setUniform(t,i,n,o=le.MATERIAL){this.uniforms[t]={type:i,value:n,uniformSourceType:o},this.uniforms[t].uniformSourceType===le.MATERIAL&&this.uniformBufferData&&Object.prototype.hasOwnProperty.call(this.uniformBufferData,t)&&Ba(this.uniformBufferData,t,n)}propertyFromUniform(t){Object.defineProperty(this,t,{get:function(){return this.uniforms[t].value},set:function(i){this.uniforms[t].value=i}})}hash(){throw"canMerge not implemented"}updateRenderStep(t){}_setShadowmapUniforms(t){this.removeDefines(i=>i.startsWith("SHADOWMAP_SIZE")),this.condDefine(t!==void 0,"USE_SHADOWMAP")&&(this.addDefine(`SHADOWMAP_SIZE ${t.shadowmapSize}`),this.setUniform("tShadowmap","t",t.shadowmapTexture,le.GLOBAL),this.setUniform("uShadowmapMatrix","m4",t.shadowmapMatrix,le.GLOBAL),this.setUniform("uShadowmapLightDirection","v4",t.sunLightDirection,le.GLOBAL))}_setSsaoUniforms(t){this.condDefine(t!==void 0,"USE_SSAO")&&(this.setUniform("ssao","t",t.ssaoTexture,le.GLOBAL),this.setUniform("uViewportSize","v2",t.viewportSize),this.setUniform("uInvViewportSize","v2",t.invViewportSize),this.condDefine(t.debugMode,"DEBUG_SSAO"))}_applySharedState(){if(this.fogSupported){const n=this.sharedMaterialState.fog;if(this.condDefine(n!==void 0&&n.enabled(),"USE_FOG")&&n&&M.DEV_DISABLE_UNIFORM_BUFFERS){const o=n.distanceEnabled?n.distanceDensity:0,a=n.heightEnabled?n.heightDensity:0;this.setUniform("fogDistStart_DistDensity_HeightStart_HeightDensity","v4",new tt(n.distanceStart,o,n.heightStart,a),le.GLOBAL),this.setUniform("fogColor","c",n.color,le.GLOBAL)}}if(this.condDefine(!!this._sharedMaterialState.liveLightmap.texture,"LIVE_LIGHTMAP")){Ke(this._sharedMaterialState);const n=this._sharedMaterialState.liveLightmap;this.setUniform("screenResolution","v4",new tt(this._sharedMaterialState.physicalWidth,this._sharedMaterialState.physicalHeight,0,0),le.GLOBAL),this.setUniform("lightmapMode","f",n.mode,le.GLOBAL),this.setUniform("liveLightmap","t",n.texture,le.GLOBAL)}if(M.DEV_SHADOWMAP&&this._setShadowmapUniforms(this.sharedMaterialState.shadowmapInfo),M.DEV_SSAO&&this._setSsaoUniforms(this.sharedMaterialState.ssaoInfo),this.hdrOutputSupported&&this.condDefine(this.sharedMaterialState.hdrOutput,"HDR_OUTPUT"),this.colorMapSupported){const n=this.sharedMaterialState.colorMap,o=this.sharedMaterialState.colorMapIntensity,a=n!==null&&o>0;this.condDefine(a,"USE_COLORMAP")&&M.DEV_DISABLE_UNIFORM_BUFFERS&&(this.setUniform("colorMap","t",n,le.GLOBAL),this.setUniform("colorMapIntensity","f",o,le.GLOBAL))}if(this.exposureAndGammaSupported&&(this.addDefine("USE_EXPOSURE_AND_GAMMA"),M.DEV_DISABLE_UNIFORM_BUFFERS)){const n=Math.pow(2,this.sharedMaterialState.cameraExposure);this.setUniform("camera_exposure_gamma","v4",new tt(n,this.sharedMaterialState.cameraGamma,0,0),le.GLOBAL)}if(this.toneMappingSupported){const n=w0(this.sharedMaterialState.toneMapping);this.hasDefine(n)||(S0.forEach(o=>{this.removeDefine(o)}),this.addDefine(n))}const t=this.sharedMaterialState.brdfLUT;this.condDefine(t!==void 0,"USE_BRDF_TEXTURE")&&this.setUniform("brdfLUT","t",t,le.GLOBAL),this.condDefine(this.sharedMaterialState.weakReflectionShadow,"WEAK_REFLECTION_SHADOW");const i=this.sharedMaterialState.lightmapEncoding;this.condDefine(this.lightmapEnabled&&i!==void 0,"USE_LIGHTMAP")&&i&&(this.addDefine("LIGHTMAP_"+i.toUpperCase()),this.setUniform("lightmap","t",null,le.LIGHT),M.DEV_DISABLE_UNIFORM_BUFFERS&&(this.setUniform("lightmapSize","v4",this._lightmapSize,le.LIGHT),this.setUniform("lightmapThreshold","v2",this._lightmapThreshold,le.LIGHT)))}refreshPerObjectUniforms(t){const i=this.uniforms;let n=t.lightmap;return this.lightmapEnabled&&i.lightmap.value!==n?((!n||!n.loaded)&&(n=this.sharedMaterialState.getDefaultLightmap(n?n.ycocgmThreshold:0)),i.lightmap.value=n,M.DEV_DISABLE_UNIFORM_BUFFERS&&(this.accessUniform("lightmapSize").value.set(n.width,n.height,1/n.width,1/n.height),this.accessUniform("lightmapThreshold").value.set(n.ycocgmThreshold,(1-n.ycocgmThreshold)/(16-3))),!0):!1}};r(Bs,"eventType",Yd),r(Bs,"_materialRenderResourceIdCount",0);let Ht=Bs;const M0="aabb_query_vertex.glsl",P0="aabb_query_fragment.glsl";class C0{constructor(){r(this,"axis",new tl(0))}}class R0 extends Ht{constructor(){super({vsName:M0,fsName:P0,uniformBufferData:new C0}),this.side=Fi.DOUBLE,this.uniforms={axis:{type:"i",value:0,uniformSourceType:le.MATERIAL}}}get axis(){return this.accessUniform("axis").value}set axis(e){console.assert(e===0||e===1||e===2),this.uniforms.axis.value=e,this.uniformBufferData.axis=new tl(e)}}class Ye extends ft{constructor(e,t){super(),this.geometry=e,this.material=t,this.materialOverride=null,this.lightProbes=[],this.lightmap=null,this.lightmapIdx=0,this.anchor=void 0,this.sharedBuffersDebug=void 0,this.visibilityId=null}clone(e,t){return e===void 0&&(e=new Ye(this.geometry,this.material)),ft.prototype.clone.call(this,e,t),e}}class Bn extends Ye{constructor(e,t,i){super(t,i),this._visible=!0,this.node=e,this.originalMaterialId=void 0,this.autoLightmapResolution=-1,this.matrixAutoUpdate=!1,this.highlightMix=0,this.selected=!1,this.selectedSecondary=!1,this.cameraDistance=0,this.grassScaleOverride=void 0,this.matrix=this.matrixWorld=null,this._matrixWorld=null,this._mergedMesh=null}clone(){Pe(!1)}updateMatrixWorld(){}get hideInViews(){return this.node.hideInViews}set hideInViews(e){console.assert(!1)}get visible(){return this._visible}set visible(e){e!==this._visible&&(this._visible=e,this._mergedMesh&&!M.EDIT_MODE&&(this._mergedMesh.visible=e))}get matrixWorld(){var e;return this._matrixWorld||((e=this.node)==null?void 0:e.animationMatrix)}set matrixWorld(e){this._matrixWorld=e}}class nl extends Ye{constructor(e,t){super(e,t),this._visible=!0,this.anyLogicalMeshHasUvs=!1,this.lightmap=null,this.matrixAutoUpdate=!1,this.hideInViews=null,this.matrixAutoUpdate=!1,this.center=null,this.cameraDistance=0,this.matrix=null,this.editableRootNode=null,this.logicalMeshes=[]}clone(){Pe(!1)}updateMatrixWorld(){}addLogicalMesh(e){this.logicalMeshes.push(e),e._mergedMesh=this}get visible(){return this._visible}set visible(e){if(e!==this._visible){this._visible=e;for(let t=0;t<this.logicalMeshes.length;t+=1){const i=this.logicalMeshes[t];i._visible=e}}}get matrixWorld(){return this.editableRootNode?this.editableRootNode.mesh?this.editableRootNode.mesh.matrixWorld:this.editableRootNode.animationMatrix:null}set matrixWorld(e){Ke(!1,"Cannot set matrixWorld for a merged mesh. ")}}class I0{constructor(){r(this,"hslContrast",new tt);r(this,"inversionScaleContrast",new tt)}}class Ko{constructor(){r(this,"contrast",0);r(this,"hslAdjustment",{h:0,s:0,l:0});r(this,"scale",0);r(this,"inversion",!1);r(this,"correctionTurnedOn",!1);r(this,"texture");r(this,"correctionUniforms",new I0)}getUniformVectors(){if(this.texture&&this.correctionTurnedOn){this.correctionUniforms.hslContrast.set(this.hslAdjustment.h,this.hslAdjustment.s,this.hslAdjustment.l,this.contrast);const e=(this.inversion?-1:1)*(1+this.scale),t=this.inversion?1:0;this.correctionUniforms.inversionScaleContrast.set(t,e,this.contrast,0)}else this.correctionUniforms.hslContrast.set(0,0,0,0),this.correctionUniforms.inversionScaleContrast.set(0,1,0,0);return this.correctionUniforms}loadFromJson(e,t){if(!e)return;const i=new tn(e);this.correctionTurnedOn=!0,this.contrast=i.parseNumber("contrast",0);const n=e.hslAdjustment;if(n)this.hslAdjustment.h=n[0],this.hslAdjustment.s=n[1],this.hslAdjustment.l=n[2];else{const o=t.getHSL(),a=e.hslOffset;this.hslAdjustment.h=a[0],this.hslAdjustment.s=Math.max(-1,Math.min(a[1]/(o.s==0?1:o.s),4)),this.hslAdjustment.l=Math.max(-1,Math.min(a[2]/(o.l==0?1:o.l),4))}this.inversion=i.parseBoolean("inversion",!1),this.scale=i.parseNumber("scale",0)}equals(e){return this.texture===e.texture&&this.correctionTurnedOn===e.correctionTurnedOn&&this.contrast===e.contrast&&this.hslAdjustment.h===e.hslAdjustment.h&&this.hslAdjustment.s===e.hslAdjustment.s&&this.hslAdjustment.l===e.hslAdjustment.l&&this.inversion===e.inversion&&this.scale===e.scale}serializeCorrection(){return this.correctionTurnedOn?{contrast:this.contrast,hslAdjustment:[this.hslAdjustment.h,this.hslAdjustment.s,this.hslAdjustment.l],inversion:this.inversion,scale:this.scale}:null}}const _o=new F(0,0,0),$o=new tt(0,0,1,1),sl=0;var Vi=(s=>(s.BASE_COLOR="baseColorTexture",s.BUMP="bumpTexture",s.METALLIC="metallicTexture",s.ROUGHNESS="roughnessTexture",s.HEIGHT="heightTexture",s.NORMAL="normalTexture",s))(Vi||{});const D0=["baseColorTexture","bumpTexture","metallicTexture","roughnessTexture","heightTexture","normalTexture"];var Qd=(s=>(s.NONE="None",s.ORGANIC="Organic",s.REGULAR="Regular",s))(Qd||{}),Es=(s=>(s.WEBWALK="webwalk",s.SCENE="scene",s.EDITOR="editor",s.MATERIAL_LIBRARY="materialLibrary",s))(Es||{});class Kd{constructor(){r(this,"mirrorX",!1);r(this,"mirrorY",!1);r(this,"stepX",1);r(this,"stepY",1);r(this,"maxOffsetX",1);r(this,"maxOffsetY",1)}}class Zo{constructor(){r(this,"baseColor",new be);r(this,"baseColorCorrection",new tt);r(this,"baseColorAtlasUvMod",new tt);r(this,"alphaDiscardThreshold",0);r(this,"envMipsCount",1);r(this,"opacity",1);r(this,"cutoutMaskThreshold",.5);r(this,"roughness",1);r(this,"roughnessCorrection",new tt);r(this,"metallic",0);r(this,"metallicCorrection",new tt);r(this,"emissionStrength",1);r(this,"highlight",new be);r(this,"antiTilingRegularStepX",1);r(this,"antiTilingRegularStepY",1);r(this,"antiTilingRegularMaxOffsetX",0);r(this,"antiTilingRegularMaxOffsetY",0);r(this,"chromaKeyColor",new be);r(this,"chromaKeyDeltaCoeff",new F);r(this,"bumpScale",1);r(this,"normalScale",1);r(this,"bumpCorrection",new tt);r(this,"uv0OffsetScale",new tt);r(this,"cosUvRotationSinUvRotation",new Ce)}}const $i=class $i extends Ht{constructor(t){var i,n,o,a,l;super({vsName:(i=t==null?void 0:t.vsName)!=null?i:$i.vertexShaderName,fsName:(n=t==null?void 0:t.fsName)!=null?n:$i.fragmentShaderName,vsHooks:(o=t==null?void 0:t.vsHooks)!=null?o:$i.vertexShaderHooks,fsHooks:(a=t==null?void 0:t.fsHooks)!=null?a:$i.fragmentShaderHooks,fsHooksCode:t==null?void 0:t.fsHooksCode,uniformBufferData:(l=t==null?void 0:t.uniformBufferData)!=null?l:new Zo});r(this,"_emitLiveLightmapRequestIfWarranted",()=>{this._emissive&&this.dispatchEvent({type:$i.eventType.MAJOR_LIGHTING_PROPERTY_UPDATED})});r(this,"merged",!1);r(this,"_opacity",1);r(this,"_cutoutMaskThreshold",.5);r(this,"_cutoutMode","autodetect");r(this,"_renderCutoutMode",!1);r(this,"baseColor",new be(16777215));r(this,"_correctedBaseColorTexture",new Ko);r(this,"_correctedRoughnessTexture",new Ko);r(this,"_correctedMetallicTexture",new Ko);r(this,"_correctedBumpTexture",new Ko);r(this,"_correctedNormalTexture",new Ko);r(this,"_antiTilingType");r(this,"antiTilingRegularParameters",new Kd);r(this,"_emissive",!1);r(this,"_emissionStrength",1);r(this,"_reflective",!0);r(this,"_roughness",1);r(this,"_metallic",0);r(this,"cubeCameraIndex",null);r(this,"_lastUsedLightProbeIds",[]);r(this,"disableLightProbe",!1);r(this,"_envMapProject",!0);r(this,"_bumpScale",.001);r(this,"_normalScale",1);r(this,"_headLight");r(this,"_uvTransform");r(this,"_repeatableTexturesRequired",!1);r(this,"highlight");r(this,"_highlightMix",0);r(this,"doNotImport");r(this,"_source");r(this,"_alphaInLowerHalf",!1);r(this,"_chromaKeyEnabled");r(this,"chromaKeyColor",new be(0,.94,0));r(this,"chromaKeyDelta",new F(.1,.1,.1));r(this,"_chromaKeyDeltaCoeff",new F);r(this,"lightmapSupported",!0);r(this,"fogSupported",!0);r(this,"hdrOutputSupported",!0);r(this,"colorMapSupported",!0);r(this,"exposureAndGammaSupported",!0);r(this,"toneMappingSupported",!0);r(this,"name","");r(this,"materialLibraryHash");r(this,"_id");this.doNotImport={baseColor:!1,opacity:!1},M.EDIT_MODE&&(this.highlight=M.EDITOR_SELECTION_COLOR)}get id(){return this._id}set id(t){this._id,this._id=t}resetIdFromSceneMaterialManager(){this._id=void 0}get source(){return this._source===void 0?"webwalk":this._source}set source(t){this._source,this._source=t}get opacity(){return this._opacity}set opacity(t){t>.99?this._opacity=1:this._opacity=t,this.configureTransparency(),this.setUniforms(),this._updated(),this.dispatchEvent({type:$i.eventType.MAJOR_LIGHTING_PROPERTY_UPDATED})}get cutoutMaskThreshold(){return this._cutoutMaskThreshold}set cutoutMaskThreshold(t){this._cutoutMaskThreshold=t,this.setUniforms(),this._updated()}_useChromaKey(){return!!(this.isAnimated&&this.chromaKeyEnabled)}_useAlphaInLowerHalf(){return!!(this.isAnimated&&this.alphaInLowerHalf)}_useBaseColorTextureAsCutout(){const t=this._correctedBaseColorTexture.texture;return this.opacity===1&&(t&&t.isCutout||this._useAlphaInLowerHalf()||this._useChromaKey())}loadCorrection(t,i){var n;(n=this._getCorrectedTexture(t))==null||n.loadFromJson(i,this.baseColor)}isCutoutEnabled(){return this._useBaseColorTextureAsCutout()&&this._cutoutMode==="autodetect"||this._cutoutMode==="enabled"}configureTransparency(){const t=this._getTexture("baseColorTexture"),i=!!t&&(t.hasAlpha||this._useAlphaInLowerHalf()||this._useChromaKey());this.transparent=this.opacity<1||i;const n=!!(this._useBaseColorTextureAsCutout()&&this._cutoutMode==="autodetect"||this._cutoutMode==="enabled");this.transparent?(this.blending=yi.NORMAL,n?this.transparentRenderOrder=0:this.transparentRenderOrder=1):this.blending=yi.DISABLED,this.depthWrite=!this.transparent||n,this.condDefine(n,"USE_CUTOUT_MASK")}getCutoutMode(){return this._cutoutMode}setCutoutMode(t){this._cutoutMode=t,this.configureTransparency(),this.setUniforms(),this._updated()}setChromaKeyColorRGB(t,i,n){this.chromaKeyColor.setRGB(t,i,n),this.setUniforms(),this._updated()}getChromaKeyDeltaComponent(t){return this.chromaKeyDelta.getComponent(t)}setChromaKeyDeltaComponent(t,i){this.chromaKeyDelta.setComponent(t,i),this.setUniforms(),this._updated()}rewind(){this.baseColorTexture instanceof dt,this.baseColorTexture.rewind()}play(){console.assert(this.isAnimated),this.baseColorTexture instanceof dt;const t=this.baseColorTexture.isPlaying;this.baseColorTexture.play(),this.baseColorTexture.isPlaying!==t&&this._updated()}pause(){console.assert(this.isAnimated),this.baseColorTexture instanceof dt;const t=this.baseColorTexture.isPlaying;this.baseColorTexture.pause(),this.baseColorTexture.isPlaying!==t&&this._updated()}sleepAnimation(){console.assert(this.isAnimated),this.baseColorTexture instanceof dt,this.baseColorTexture.sleepAnimation()}wakeAnimation(){console.assert(this.isAnimated),this.baseColorTexture instanceof dt,this.baseColorTexture.wakeAnimation()}getTextures(){const t=new Map;for(const i of D0){const n=this._getTexture(i);n!==void 0&&t.set(i,n)}return t}getTextureMapCorrectionTurnedOn(t){var i,n;return(n=(i=this._getCorrectedTexture(t))==null?void 0:i.correctionTurnedOn)!=null?n:!1}setTextureMapCorrectionTurnedOn(t,i){const n=this._getCorrectedTexture(t);n&&this._doSetProperty(n,"correctionTurnedOn",i)}getTextureMapInversion(t){var i,n;return(n=(i=this._getCorrectedTexture(t))==null?void 0:i.inversion)!=null?n:!1}setTextureMapInversion(t,i){const n=this._getCorrectedTexture(t);n&&this._doSetProperty(n,"inversion",i)}getTextureMapContrast(t){var i,n;return(n=(i=this._getCorrectedTexture(t))==null?void 0:i.contrast)!=null?n:0}setTextureMapContrast(t,i){const n=this._getCorrectedTexture(t);n&&this._doSetProperty(n,"contrast",i)}getTextureMapScale(t){var i,n;return(n=(i=this._getCorrectedTexture(t))==null?void 0:i.scale)!=null?n:0}setTextureMapScale(t,i){const n=this._getCorrectedTexture(t);n&&this._doSetProperty(n,"scale",i)}getTextureMapHslAdjustment(t,i){var n,o;return(o=(n=this._getCorrectedTexture(t))==null?void 0:n.hslAdjustment[i])!=null?o:0}setTextureMapHslAdjustment(t,i,n){const o=this._getCorrectedTexture(t);o&&this._doSetProperty(o.hslAdjustment,i,n)}setAntiTilingRegularParameters(t,i){this._doSetProperty(this.antiTilingRegularParameters,t,i)}setDoNotImport(t,i){this._doSetProperty(this.doNotImport,t,i)}isLightProbeDisabled(){return this.disableLightProbe||!this.reflective}_setLightProbeUniforms(t=null){const i=M.ENABLE_REFLECTION_PROBES_BLENDING?M.MAX_BLENDED_REFLECTION_PROBES:1;for(let o=0;o<i;o++)this.setUniform(`envMap[${o}]`,"t",t,le.LIGHT);this.addDefine(`MAX_REFLECTION_PROBES ${i}`);const n=this.envMapMirror?1:M.LIGHT_PROBE_MIPS_COUNT;if(this.setUniform("envMipsCount","f",n,le.MATERIAL),this.condDefine(this.envMapProject,"USE_ENVMAP_PROJECT")&&(this.condDefine(M.ENABLE_REFLECTION_PROBES_BLENDING,"USE_REFLECTION_PROBE_BLENDING")&&this.setUniform("reflectionProbesCount","i",0,le.LIGHT),M.DEV_DISABLE_UNIFORM_BUFFERS))for(let o=0;o<M.MAX_BLENDED_REFLECTION_PROBES;o++)this.setUniform(`reflectionProbes[${o}].boxMin`,"v3",_o,le.LIGHT),this.setUniform(`reflectionProbes[${o}].boxMax`,"v3",_o,le.LIGHT),this.setUniform(`reflectionProbes[${o}].posW`,"v3",_o,le.LIGHT);this._lastUsedLightProbeIds=[]}getUvOffsetAndScale(t){var i;return t.copyFrom(((i=this._uvTransform)==null?void 0:i.offsetAndScale)||$o)}_uvTransformModified(){this.ensureTexturesRepeatable(),this._updated()}setUvTransform(t){this._uvTransform=t,this._uvTransformModified()}setUvOffsetAndScale(t,i,n,o){this._uvTransform||(this._uvTransform={offsetAndScale:$o.clone(),rotationDeg:sl}),t instanceof tt?this._uvTransform.offsetAndScale.copyFrom(t):this._uvTransform.offsetAndScale.set(t,i,n,o),this._uvTransformModified()}getUvOffsetAndScaleByProperty(t){return this._uvTransform.offsetAndScale[t]}setUvOffsetAndScaleByProperty(t,i){this._uvTransform.offsetAndScale[t]=i,this._uvTransformModified()}get uvRotationDeg(){return this._uvTransform.rotationDeg}set uvRotationDeg(t){this._uvTransform||(this._uvTransform={offsetAndScale:$o.clone(),rotationDeg:sl}),this._uvTransform.rotationDeg=t,this._uvTransformModified()}ensureTexturesRepeatable(){this._repeatableTexturesRequired=!0,this.baseColorTexture instanceof Za&&this.baseColorTexture.loaded&&(this.addDefine("USE_BASE_COLOR_TEXTURE_ATLAS_REPEAT"),this.setUniforms())}forceEnableUv0(){return!1}_applySharedState(){super._applySharedState();const t=this.emissiveEnabled?this.emissionStrength:0;this.setUniform("emissionStrength","f",t,le.MATERIAL)}setRenderCutoutMode(t){this._renderCutoutMode=t,this.setUniforms()}setUniforms(){var x,v,E;this.setUniform("opacity","f",this.opacity,le.MATERIAL),this.setUniform("cutoutMaskThreshold","f",this.cutoutMaskThreshold,le.MATERIAL);const t=!this.isLightProbeDisabled();let i=this.forceEnableUv0();const n=this.roughnessTexture,o=!!n&&n.loaded&&t;this.condDefine(o,"USE_ROUGHNESS_TEXTURE")?(this.setUniform("roughnessTexture","t",n,le.MATERIAL),i=!0):this.setUniform("roughness","f",this.roughness,le.MATERIAL);const a=this.metallicTexture,l=!!a&&a.loaded&&t;this.condDefine(l,"USE_METALLIC_TEXTURE")?(this.setUniform("metallicTexture","t",a,le.MATERIAL),i=!0):this.setUniform("metallic","f",this.metallic,le.MATERIAL);const c=this.emissiveEnabled?this.emissionStrength:0;this.setUniform("emissionStrength","f",c,le.MATERIAL),this.condDefine(this.antiTilingType==="Organic","ANTI_TILING_ORGANIC"),this.condDefine(this.antiTilingType==="Regular","ANTI_TILING_REGULAR")&&(this.condDefine(this.antiTilingRegularParameters.mirrorX,"ANTI_TILING_REGULAR_MIRROR_X"),this.condDefine(this.antiTilingRegularParameters.mirrorY,"ANTI_TILING_REGULAR_MIRROR_Y"),this.setUniform("antiTilingRegularStepX","f",this.antiTilingRegularParameters.stepX,le.MATERIAL),this.setUniform("antiTilingRegularStepY","f",this.antiTilingRegularParameters.stepY,le.MATERIAL),this.setUniform("antiTilingRegularMaxOffsetX","f",this.antiTilingRegularParameters.maxOffsetX,le.MATERIAL),this.setUniform("antiTilingRegularMaxOffsetY","f",this.antiTilingRegularParameters.maxOffsetY,le.MATERIAL));const h=this._correctedBaseColorTexture.getUniformVectors();this.setUniform("baseColorCorrection","v4",h.hslContrast,le.MATERIAL);const d=this._correctedBumpTexture.getUniformVectors().inversionScaleContrast;if(this.setUniform("bumpCorrection","v4",d,le.MATERIAL),o){const w=this._correctedRoughnessTexture.getUniformVectors().inversionScaleContrast;this.setUniform("roughnessCorrection","v4",w,le.MATERIAL)}if(l){const w=this._correctedMetallicTexture.getUniformVectors().inversionScaleContrast;this.setUniform("metallicCorrection","v4",w,le.MATERIAL)}let u=this._correctedBaseColorTexture.texture,m=$o;if(u&&u instanceof Za&&u.parentTexture&&(m=u.uvOffsetScale,u=u.parentTexture),this.condDefine(!!u&&u.loaded,"USE_BASE_COLOR_TEXTURE")?(this.setUniform("baseColorTexture","t",u,le.MATERIAL),i=!0,this.setUniform("baseColorAtlasUvMod","v4",m,le.MATERIAL),this._useBaseColorTextureAsCutout()?this.setUniform("alphaDiscardThreshold","f",.25,le.MATERIAL):this.setUniform("alphaDiscardThreshold","f",0,le.MATERIAL)):this.setUniform("baseColor","c",this.baseColor,le.MATERIAL),this.condDefine(this._useAlphaInLowerHalf(),"USE_ALPHA_IN_LOWER_HALF"),this.condDefine(this._useChromaKey(),"USE_CHROMA_KEY")){this.setUniform("chromaKeyColor","c",this.chromaKeyColor,le.MATERIAL);const w=1.22,C=this.chromaKeyDelta;this._chromaKeyDeltaCoeff.x=1/(w*C.x),this._chromaKeyDeltaCoeff.y=1/(w*C.y),this._chromaKeyDeltaCoeff.z=1/(w*C.z),this.setUniform("chromaKeyDeltaCoeff","v3",this._chromaKeyDeltaCoeff,le.MATERIAL)}const g=this.bumpTexture,b=this.normalTexture;if(this.condDefine(!!b&&b.loaded&&t,"USE_NORMAL_TEXTURE")?(this.setUniform("normalTexture","t",b,le.MATERIAL),this.setUniform("normalScale","f",this.normalScale,le.MATERIAL),i=!0):this.condDefine(!!g&&g.loaded&&t,"USE_BUMP_TEXTURE")&&(this.setUniform("bumpTexture","t",g,le.MATERIAL),this.setUniform("bumpScale","f",this.bumpScale,le.MATERIAL),i=!0),i){this.setUniform("uUv0OffsetAndScale","v4",((x=this._uvTransform)==null?void 0:x.offsetAndScale)||$o,le.MATERIAL);const w=(((v=this._uvTransform)==null?void 0:v.rotationDeg)||sl)*Math.PI/180;this.setUniform("uUv0RotationCosSin","v2",new Ce(Math.cos(w),Math.sin(w)),le.MATERIAL)}this.condDefine(t,"USE_ENVMAP")&&this._setLightProbeUniforms(),this.condDefine(this.highlight!==void 0,"USE_HIGHLIGHT")&&(this.setUniform("highlight","c",this.highlight,le.MATERIAL),this.setUniform("highlightMix","f",this.highlightMix,le.OBJECT)),this.condDefine((E=this.headLight)!=null?E:!this.lightmapEnabled,"USE_HEADLIGHT"),this.condDefine(this._renderCutoutMode,"RENDER_CUTOUT_MODE"),this.fillMaterialUniformDataFromUniforms()}forceObjectUniformsRefresh(){this._lastUsedLightProbeIds=[]}textureNeedsUv0(t){return!0}get type(){return Tn.STANDARD}hash(){return this.baseColorTexture?this.type+this.baseColorTexture.name:`${this.type}#${this.baseColor.r}:${this.baseColor.g}:${this.baseColor.b}`}_getCorrectedTexture(t){switch(t){case"baseColorTexture":return this._correctedBaseColorTexture;case"bumpTexture":return this._correctedBumpTexture;case"normalTexture":return this._correctedNormalTexture;case"metallicTexture":return this._correctedMetallicTexture;case"roughnessTexture":return this._correctedRoughnessTexture;case"heightTexture":return}Zn(t,`Unknown type ${t}.`)}_getTexture(t){const i=this._getCorrectedTexture(t);return i?i.texture:this[t]}_setTexture(t,i){const n=this._getCorrectedTexture(t);n&&(n.texture=i,i&&!i.loaded?i.addLoadedListener(()=>{t=="baseColorTexture"&&this.configureTransparency(),this._repeatableTexturesRequired&&this.ensureTexturesRepeatable(),this.setUniforms(),this._updated()}):(this.setUniforms(),this._updated()))}canMerge(t){if(this.type!==t.type||this.opacity!==t.opacity)return!1;if(this._correctedBaseColorTexture.texture||t._correctedBaseColorTexture.texture){if(!$i.baseColorTexturesEqual(this,t)||!$i.antiTilingEqual(this,t))return!1}else if(!this.baseColor.equals(t.baseColor))return!1;if((this.emissive||t.emissive)&&(this.emissive!==t.emissive||this.emissionStrength!==t.emissionStrength))return!1;if(this.roughnessTexture||t.roughnessTexture){if(this.roughnessTexture!==t.roughnessTexture)return!1}else if(this.roughness!==t.roughness)return!1;if(this.metallicTexture||t.metallicTexture){if(this.metallicTexture!==t.metallicTexture)return!1}else if(this.metallic!==t.metallic)return!1;return!((this.bumpTexture||t.bumpTexture)&&(this.bumpTexture!==t.bumpTexture||this.bumpScale!==t.bumpScale)||(this.normalTexture||t.normalTexture)&&(this.normalTexture!==t.normalTexture||this.normalScale!==t.normalScale)||this.envMapProject!==t.envMapProject||this.doubleSided!==t.doubleSided||!$i.uvOffsetScaleEqual(this,t))}assignLightProbe(t,i){const n=this.uniforms,o=this.envMapMirror?t.getMirrorTexture():t.getFilteredTexture();n[`envMap[${i}]`].value=o!=null?o:null,M.DEV_DISABLE_UNIFORM_BUFFERS&&this.envMapProject&&(t.isBoundingBoxEnabled()?(n[`reflectionProbes[${i}].posW`].value=t.position,n[`reflectionProbes[${i}].boxMin`].value=t.boxMin,n[`reflectionProbes[${i}].boxMax`].value=t.boxMax):(n[`reflectionProbes[${i}].boxMin`].value=_o,n[`reflectionProbes[${i}].boxMax`].value=_o))}refreshPerObjectUniforms(t){const i=this.uniforms;let n=super.refreshPerObjectUniforms(t);const o=t instanceof Bn&&t.selected?t.highlightMix:0;if(i.highlightMix!==void 0&&o!==i.highlightMix.value&&(i.highlightMix.value=o,n=!0),this.isLightProbeDisabled())return n;const a=[];if(t.lightProbes.forEach(c=>a.push(c.id)),Va(this._lastUsedLightProbeIds,a))return n;n=!0,this._lastUsedLightProbeIds=[...a];const l=this.envMapMirror?1:M.LIGHT_PROBE_MIPS_COUNT;if(i.envMipsCount.value=l,M.ENABLE_REFLECTION_PROBES_BLENDING){const c=this.envMapMirror?1:t.lightProbes.length;for(let d=0;d<c;d++)this.assignLightProbe(t.lightProbes[d],d);i.reflectionProbesCount.value=c;const h=t.lightProbes[0].getFilteredTexture();for(let d=c;d<M.MAX_BLENDED_REFLECTION_PROBES;d+=1)i[`envMap[${d}]`].value=h,M.DEV_DISABLE_UNIFORM_BUFFERS&&(i[`reflectionProbes[${d}].boxMin`].value=_o,i[`reflectionProbes[${d}].boxMax`].value=_o)}else this.assignLightProbe(t.lightProbes[0],0);return n}setBaseColorRGB(t,i,n){this.baseColor.setRGB(t,i,n),this.setUniforms(),this._updated(),this._emitLiveLightmapRequestIfWarranted()}getTextureAndSettings(t){var n;const i=this._getTexture(t);return t==="bumpTexture"?[i,{bumpScale:this._bumpScale}]:t=="normalTexture"?[i,{normalScale:this._normalScale}]:t==="baseColorTexture"?[i,{correctionTurnedOn:this._correctedBaseColorTexture.correctionTurnedOn,correction:(n=this._correctedBaseColorTexture.serializeCorrection())!=null?n:void 0,antiTilingType:this.antiTilingType,antiTilingRegularParameters:Vt({},this.antiTilingRegularParameters),baseColor:this.baseColor.roundChannels().toArray()}]:[i,{}]}setTexture(t,i,n={}){var o,a,l,c,h,d,u,m,g,b,x,v;if(i===null&&(i=void 0),i){const E=this.baseColorTexture;E instanceof dt&&(i.wrapS=E.wrapS,i.wrapT=E.wrapT,i.anisotropy=E.anisotropy)}this._getCorrectedTexture(t)!==void 0&&(this._setTexture(t,i),this._getCorrectedTexture(t).correctionTurnedOn=n.correctionTurnedOn||!1,this._getCorrectedTexture(t).contrast=((o=n.correction)==null?void 0:o.contrast)||0,this._getCorrectedTexture(t).hslAdjustment.h=((a=n.correction)==null?void 0:a.hslAdjustment[0])||0,this._getCorrectedTexture(t).hslAdjustment.s=((l=n.correction)==null?void 0:l.hslAdjustment[1])||0,this._getCorrectedTexture(t).hslAdjustment.l=((c=n.correction)==null?void 0:c.hslAdjustment[2])||0,t==="baseColorTexture"?(this.antiTilingType=n.antiTilingType||this.antiTilingType||"None",this.antiTilingRegularParameters.mirrorX=((h=n.antiTilingRegularParameters)==null?void 0:h.mirrorX)||!1,this.antiTilingRegularParameters.mirrorY=((d=n.antiTilingRegularParameters)==null?void 0:d.mirrorY)||!1,this.antiTilingRegularParameters.stepX=((u=n.antiTilingRegularParameters)==null?void 0:u.stepX)||1,this.antiTilingRegularParameters.stepY=((m=n.antiTilingRegularParameters)==null?void 0:m.stepY)||1,this.antiTilingRegularParameters.maxOffsetX=((g=n.antiTilingRegularParameters)==null?void 0:g.maxOffsetX)||1,this.antiTilingRegularParameters.maxOffsetY=((b=n.antiTilingRegularParameters)==null?void 0:b.maxOffsetY)||1,n.baseColor&&this.baseColor.fromArray(n.baseColor)):t==="bumpTexture"?this._bumpScale=(x=n.bumpScale)!=null?x:.001:t==="normalTexture"&&(this._normalScale=(v=n.normalScale)!=null?v:1))}serializeTextureProperties(t){const i=this._getCorrectedTexture(t);if(i!==void 0)return{correction:i.serializeCorrection(),texture:i.texture?i.texture.serialize():null}}serializeAntiTilingProperties(){if(!this.antiTiling)return;const t=this.antiTilingType;Pe(t);let i;return t==="Regular"&&(i=this.antiTilingRegularParameters),{antiTilingType:t,antiTilingRegularParameters:i}}serializeUvOffsetScale(){return this.uvTransformEnabled?this._uvTransform.offsetAndScale.toArray():null}serializeUvRotation(){return this.uvTransformEnabled?this._uvTransform.rotationDeg:null}serialize(){var d;this.id,this.merged,this.source;const t=this.baseColor.roundChannels().toArray(),i=this.serializeTextureProperties("baseColorTexture"),n=this.serializeTextureProperties("roughnessTexture"),o=this.serializeTextureProperties("metallicTexture"),a=this.serializeTextureProperties("bumpTexture"),l=this.serializeTextureProperties("normalTexture"),c=this._chromaKeyEnabled!==void 0;return{name:this.name,id:this.id,materialLibraryHash:(d=this.materialLibraryHash)!=null?d:null,type:this.type,source:this.source!=="scene"?this.source:null,baseColor:t,baseColorTexture:i.texture,baseColorTextureCorrection:i.correction,alphaInLowerHalf:this.alphaInLowerHalf,chromaKeyEnabled:c?this.chromaKeyEnabled:null,chromaKeyColor:c?this.chromaKeyColor.roundChannels().toArray():null,chromaKeyDelta:c?this.chromaKeyDelta.toArray():null,opacity:this.opacity,cutoutMode:this._cutoutMode,cutoutMaskThreshold:this.cutoutMaskThreshold,emissive:this.emissive,emissionStrength:this.emissionStrength,reflective:this.reflective,roughness:this.roughness,metallic:this.metallic,envMapProject:this.envMapProject,bumpScale:a.texture?this.bumpScale:null,normalScale:l.texture?this.normalScale:null,doubleSided:this.doubleSided,doNotImport:this.doNotImport,roughnessTexture:n.texture,roughnessTextureCorrection:n.correction,metallicTexture:o.texture,metallicTextureCorrection:o.correction,bumpTexture:a.texture,bumpTextureCorrection:a.correction,normalTexture:l.texture,uvOffsetScale:this.serializeUvOffsetScale(),uvRotationDeg:this.serializeUvRotation(),antiTiling:this.serializeAntiTilingProperties(),wavesSpeed:null,wavesScale:null}}_onTextureSet(t){t?t.addLoadedListener(()=>{this.setUniforms(),this._updated()}):(this.setUniforms(),this._updated())}get roughnessTexture(){return this._correctedRoughnessTexture.texture}set roughnessTexture(t){this._correctedRoughnessTexture.texture=t,this._onTextureSet(t)}get metallicTexture(){return this._correctedMetallicTexture.texture}set metallicTexture(t){this._correctedMetallicTexture.texture=t,this._onTextureSet(t)}get bumpTexture(){return this._correctedBumpTexture.texture}set bumpTexture(t){this._correctedBumpTexture.texture=t,this._onTextureSet(t)}get normalTexture(){return this._correctedNormalTexture.texture}set normalTexture(t){this._correctedNormalTexture.texture=t,this._onTextureSet(t)}get alphaInLowerHalf(){return this._alphaInLowerHalf}set alphaInLowerHalf(t){this._alphaInLowerHalf=t,this.configureTransparency(),this.setUniforms(),this._updated()}get chromaKeyEnabled(){return!!this._chromaKeyEnabled}set chromaKeyEnabled(t){this._chromaKeyEnabled=!!t,this.configureTransparency(),this.setUniforms(),this._updated()}get isAnimated(){const t=this.baseColorTexture;return t instanceof dt&&t.isAnimated}get isPlaying(){const t=this.baseColorTexture;return t instanceof dt&&t.isAnimated&&t.isPlaying}get doubleSided(){return this.side===Fi.DOUBLE}set doubleSided(t){this.side=t?Fi.DOUBLE:Fi.FRONT,this.setUniforms(),this._updated()}get antiTiling(){return this._antiTilingType!==void 0}get antiTilingType(){return this._antiTilingType}set antiTilingType(t){this._antiTilingType=t,this.setUniforms(),this._updated()}get envMapMirror(){return this.roughness===0&&!this.roughnessTexture}get highlightMix(){return this._highlightMix}set highlightMix(t){t!==this._highlightMix&&(this._highlightMix=t,this.uniforms.highlightMix.value=t)}get baseColorTexture(){return this._correctedBaseColorTexture.texture}set baseColorTexture(t){this._setTexture("baseColorTexture",t)}_doSetProperty(t,i,n){this.source,n!==t[i]&&(Ba(t,i,n),this.setUniforms(),this._updated(),this._emitLiveLightmapRequestIfWarranted())}get emissive(){return this._emissive}get emissiveEnabled(){return this._emissive&&(!this.sharedMaterialState||this.sharedMaterialState.emissiveMaterialsLightEnabled)}set emissive(t){this._doSetProperty(this,"_emissive",t),this.dispatchEvent({type:$i.eventType.MAJOR_LIGHTING_PROPERTY_UPDATED})}get emissionStrength(){return this._emissionStrength}set emissionStrength(t){this._doSetProperty(this,"_emissionStrength",t)}get reflective(){return this._reflective}set reflective(t){this._doSetProperty(this,"_reflective",t)}get headLight(){return this._headLight}set headLight(t){this._doSetProperty(this,"_headLight",t)}get roughness(){return this._roughness}set roughness(t){this._doSetProperty(this,"_roughness",t)}get metallic(){return this._metallic}set metallic(t){this._doSetProperty(this,"_metallic",t)}get envMapProject(){return this._envMapProject}set envMapProject(t){this._doSetProperty(this,"_envMapProject",t)}get bumpScale(){return this._bumpScale}set bumpScale(t){this._doSetProperty(this,"_bumpScale",t)}get normalScale(){return this._normalScale}set normalScale(t){this._doSetProperty(this,"_normalScale",t)}get uvTransformEnabled(){return this._uvTransform!==void 0}set uvTransformEnabled(t){t?this.setUvTransform({offsetAndScale:$o.clone(),rotationDeg:sl}):(this._uvTransform=void 0,this.setUniforms(),this._updated())}static baseColorTexturesEqual(t,i){return t._correctedBaseColorTexture.equals(i._correctedBaseColorTexture)&&t._useAlphaInLowerHalf()===i._useAlphaInLowerHalf()&&(t._useChromaKey()?i._useChromaKey()&&t.chromaKeyColor.equals(i.chromaKeyColor)&&t.chromaKeyDelta.equals(i.chromaKeyDelta):!i._useChromaKey())}static antiTilingEqual(t,i){return t.antiTilingType===i.antiTilingType&&t.antiTilingRegularParameters.mirrorX===i.antiTilingRegularParameters.mirrorX&&t.antiTilingRegularParameters.mirrorY===i.antiTilingRegularParameters.mirrorY&&t.antiTilingRegularParameters.stepX===i.antiTilingRegularParameters.stepX&&t.antiTilingRegularParameters.stepY===i.antiTilingRegularParameters.stepY&&t.antiTilingRegularParameters.maxOffsetX===i.antiTilingRegularParameters.maxOffsetX&&t.antiTilingRegularParameters.maxOffsetY===i.antiTilingRegularParameters.maxOffsetY}static uvOffsetScaleEqual(t,i){return t._uvTransform&&i._uvTransform?t._uvTransform.offsetAndScale.equals(i._uvTransform.offsetAndScale):!1}};r($i,"vertexShaderName","standard_material_vertex.glsl"),r($i,"fragmentShaderName","standard_material_fragment.glsl"),r($i,"vertexShaderHooks","standard_material_vertex_hooks.glsl"),r($i,"fragmentShaderHooks","standard_material_fragment_hooks.glsl");let gt=$i;const L0="anchor_vertex.glsl";class F0 extends gt{constructor(){super({vsName:L0,uniformBufferData:new Zo}),this._metallic=.1,this._roughness=.5,this._bumpScale=.01,this.hideFromLightProbes=!0,this.lightmapSupported=!1}}const O0="wireframe_vertex.glsl",B0="wireframe_fragment.glsl",$d=100;class U0{constructor(){r(this,"maxDistance",$d)}}class Ts extends Ht{constructor(t,i=$d,n,o=!0){super({vsName:O0,fsName:B0,uniformBufferData:new U0});r(this,"lineColor");r(this,"lineThickness");r(this,"_customizationFunc");const a=Mc();this.lineColor=t||a.lineColor,this.lineThickness=0,this.setUniform("lineColor","c",this.lineColor,le.OBJECT),this.setUniform("lineThickness","f",0,le.OBJECT),this.setUniform("backsideLineThickness","f",0,le.OBJECT),this.setUniform("maxDistance","f",i,le.MATERIAL),this.condDefine(o,"USE_TRANSPARENT_WIREFRAME"),this.blending=yi.NORMAL,this.depthTest=!0,this.depthWrite=!0,this.side=Fi.DOUBLE,this.transparent=o,this._customizationFunc=n,this.fillMaterialUniformDataFromUniforms()}get customizationFunc(){return this._customizationFunc}uniformsNeedUpdate(t,i,n){return this.uniforms.lineThickness.value!==t||this.uniforms.lineColor.value!==i||this.uniforms.backsideLineThickness.value!==n}refreshPerObjectUniforms(t){let i=this.lineColor,n=this.lineThickness,o=this.lineThickness;if(this._customizationFunc){const l=this._customizationFunc(t);i=l.lineColor||i,n=l.lineThickness||n,o=l.backsideLineThickness||o}const a=this.uniformsNeedUpdate(n,i,o);return this.uniforms.lineThickness.value=n,this.uniforms.lineColor.value=i,this.uniforms.backsideLineThickness.value=o,a}}function Zd(s=M.EDITOR_SELECTION_COLOR){const e=()=>({lineThickness:2,backsideLineThickness:2}),t=new Ts(s,100,e);return t.depthTest=!0,t.depthWrite=!1,t.side=Fi.DOUBLE,t.hideFromLightProbes=!0,t.lineThickness=1.5,t}function Oc(s=M.EDITOR_SELECTION_COLOR){const e=new gt;return e.hideFromLightProbes=!0,e.disableLightProbe=!0,e.lightmapSupported=!1,e.headLight=!1,e.reflective=!1,e.opacity=.2,e.transparent=!0,e.doubleSided=!1,e.baseColor=s,e.setUniforms(),e}class N0 extends gt{constructor(){super({}),this.lightmapSupported=!1,this.headLight=!0,this.reflective=!1,this.setUniforms()}refreshPerObjectUniforms(e){let t=be.WHITE;if(e.sharedBuffersDebug!==void 0){const i=e.sharedBuffersDebug;i>0&&(t=i===1?be.BLUE:be.GREEN)}return this.uniforms.baseColor.value=t,!0}}const k0="equirect_sky_vertex.glsl",z0="equirect_sky_fragment.glsl";class Jd extends Ht{constructor(){super({vsName:k0,fsName:z0}),this.depthWrite=!1,this.side=Fi.FRONT,this.uniforms={map:{type:"t",value:null,uniformSourceType:le.MATERIAL}},this.fogSupported=!0,this.hdrOutputSupported=!0,this.colorMapSupported=!0,this.exposureAndGammaSupported=!0,this.toneMappingSupported=!0}get map(){return this.accessUniform("map").value}set map(e){this.accessUniform("map").value=e,this.condDefine(this.map.encoding=="rgbm","USE_RGBM_MAP")}}class V0{constructor(){r(this,"circleSpan",0)}}class G0 extends Ht{constructor(){super({vsName:"gaze_pointer_vertex.glsl",fsName:"gaze_pointer_fragment.glsl",uniformBufferData:new V0}),this.blending=yi.NORMAL,this.transparent=!0,this.transparentRenderOrder=2,this.setUniform("circleSpan","f",0,le.MATERIAL)}set circleSpan(e){console.assert(e<=1);const t=2*Math.PI*e-Math.PI;this.uniforms.circleSpan.value=t,this.uniformBufferData.circleSpan=t}}const ol={BY_NORMALS:"By normals",UP:"Up"},H0=new tt(0,0,1,1);class W0 extends Zo{constructor(){super(...arguments);r(this,"grassDirectionality",1);r(this,"renderSteps",0)}}class Bc extends gt{constructor(){super({vsHooks:"grass_vertex.glsl",fsHooks:"grass_fragment.glsl",uniformBufferData:new W0});r(this,"_grassHeight",.05);r(this,"_correctedHeightTexture",new Ko);r(this,"_direction",ol.BY_NORMALS);r(this,"grassScale",1);r(this,"doNotImport",{baseColor:!0,baseColorTexture:!0});this._repeatableTexturesRequired=!0,this.renderSteps=8,this.doNotImport={baseColor:!0,baseColorTexture:!0},this.antiTilingType=Qd.ORGANIC,this.setUniform("currentStep","f",0,le.OBJECT),this.setUniform("grassOffsetScaled","f",0,le.OBJECT),this.setUniform("grassDirectionality","f",1,le.MATERIAL),this.setUniform("renderSteps","f",this.renderSteps,le.MATERIAL)}_getCorrectedTexture(t){return t===Vi.HEIGHT?this._correctedHeightTexture:super._getCorrectedTexture(t)}set grassHeight(t){this._grassHeight=t,this._updated()}get grassHeight(){return this._grassHeight}set grassLayers(t){this.renderSteps=t,this.uniforms.renderSteps.value=this.renderSteps,this._updated()}get grassLayers(){return this.renderSteps}get grassDirectionMode(){return ol}get grassDirection(){return this._direction}set grassDirection(t){this._direction=t,this.uniforms.grassDirectionality.value=this._direction===ol.UP?0:1,this._updated()}set heightTexture(t){this._correctedHeightTexture.texture=t,t.addLoadedListener(()=>{var i;this.setUniform("heightTexture","t",this.heightTexture,le.MATERIAL),this.condDefine(this.heightTexture!==void 0,"USE_HEIGHT_TEXTURE"),this.setUniform("uUv0OffsetAndScale","v4",((i=this._uvTransform)==null?void 0:i.offsetAndScale)||H0,le.MATERIAL),this._updated()})}get heightTexture(){return this._correctedHeightTexture.texture}_setTexture(t,i){if(t===Vi.HEIGHT)this.heightTexture=i;else return super._setTexture(t,i)}get type(){return Tn.GRASS}canMerge(t){return!1}configureTransparency(){this.blending=yi.NORMAL}updateRenderStep(t){const i=this.grassHeight/this.renderSteps*t;this.uniforms.grassOffsetScaled.value=i*this.grassScale,this.uniforms.currentStep.value=t}refreshPerObjectUniforms(t){const i=this.uniforms;let n=Ht.prototype.refreshPerObjectUniforms.call(this,t),o;if(t instanceof Bn){const a=t.selected?t.highlightMix:0;i.highlightMix!==void 0&&a!==i.highlightMix.value&&(i.highlightMix.value=a,n=!0),o=t.grassScaleOverride}return this.grassScale=o!=null?o:1,this._direction===ol.UP&&(i.grassDirectionality.value=o?1:0),n}serialize(){var n,o;this.id;const t=this.baseColor.roundChannels().toArray(),i=this.serializeTextureProperties(Vi.BASE_COLOR);return{name:this.name,id:this.id,type:this.type,baseColor:t,baseColorTexture:i.texture,baseColorTextureCorrection:i.correction,heightTexture:(o=(n=this.heightTexture)==null?void 0:n.serialize())!=null?o:null,grassHeight:this.grassHeight,grassLayers:this.grassLayers,grassDirection:this.grassDirection,doNotImport:this.doNotImport,uvOffsetScale:this.serializeUvOffsetScale(),antiTiling:this.serializeAntiTilingProperties()}}}class j0{constructor(){r(this,"color",new be);r(this,"highlight",new be);r(this,"highlightMix",0)}}class Uc extends Ht{constructor(e){super({vsName:"editor_light_vertex.glsl",fsName:"editor_light_fragment.glsl",uniformBufferData:new j0}),this.setUniform("color","c",e.color,le.MATERIAL),this.setUniform("highlight","c",M.EDITOR_SELECTION_COLOR,le.MATERIAL),this.setUniform("highlightMix","f",0,le.MATERIAL),this.propertyFromUniform("highlightMix")}}class X0 extends Ht{constructor(t){super({vsName:gt.vertexShaderName,vsHooks:gt.vertexShaderHooks,fsName:"luma_fragment.glsl"});r(this,"_color");this.lightmapSupported=!0,this.sharedMaterialState=t,this._color=new be(be.WHITE),this.setUniform("uObjectBaseColor","c",this._color,le.OBJECT)}refreshPerObjectUniforms(t){let i=Ht.prototype.refreshPerObjectUniforms.call(this,t);const n=t.material.baseColor;return n.equals(this._color)||(this._color.copyFrom(n),i=!0),i}}const q0="object_distance_vertex.glsl",Y0="object_id_fragment.glsl",Q0="object_id_distance_fragment.glsl";class K0 extends Ht{constructor(e){super({vsName:q0,fsName:e?Y0:Q0}),this.doNotOverrideSide=!0,this.uniforms={objectId:{type:"i",value:null,uniformSourceType:le.OBJECT}}}refreshPerObjectUniforms(e){return this.uniforms.objectId.value=e.visibilityId,!0}}const $0="outline_vertex.glsl",Z0="outline_fragment.glsl";class J0{constructor(){r(this,"color",new be);r(this,"thickness",0)}}class e_ extends Ht{constructor(e,t){super({vsName:$0,fsName:Z0,uniformBufferData:new J0}),this.side=Fi.DOUBLE,this.uniforms={color:{type:"c",value:e,uniformSourceType:le.MATERIAL},thickness:{type:"f",value:t,uniformSourceType:le.MATERIAL}},this.fillMaterialUniformDataFromUniforms()}}const t_=[-1.099459,-.1335146,-4.083223,5.919603,-.1104166,1.600158,-1326538e-12,.5127716,4.917807,-1.169858,-.1832793,.9694744,.09495762,-.04738918,.2194171,.1095749,.3815119,3.603604,-.9665225,-.1403888,5.194457,-1.107607,-.8135181,4.969661,-.2300508,1.279158,-2.48935,-1.292508,-.1299552,-2.071404,-.04752482,1.215598,-1.904179,.3027985,.06332446,8.707768,-.9264666,-.169678,4.57407,-.4232936,-7.575833,5.079755,-.2576343,.6908129,-4.506805,-1.139072,-.1796056,1.923311,6.788529,-2.364389,-1.064041,.171701,.501581,1.534681,-1.107257,-.1384411,-4.285744,5.713157,-.1015992,1.372638,.06555893,.6550471,5.127514,-1.187337,-.1969013,.8551048,.05289708,-.07626406,.01733153,.1779454,.4742709,3.801038,-.9685321,-.1553308,4.732492,-1.178935,-.7852791,4.604492,-.2666518,1.177527,-2.367663,-1.252817,-.05129949,-2.800433,-.01295992,1.308964,-2.204331,.7276011,.1188388,8.699265,-.9459509,-.2322133,4.375041,-.1712018,-7.451681,5.078019,-.4223538,1.074719,-4.595561,-1.125092,-.179675,1.626399,6.989743,-2.406382,-.9060383,.2961611,.543814,1.337715,-1.135338,-.171616,-1.499253,2.373491,-.1654023,.9566404,.1113453,.6579439,4.528473,-1.13278,-.1456214,-1.736672,1.756589,-.1087003,.3757927,.252507,.5003814,7.178513,-1.167176,-.2927225,5.727667,-3.139244,-.6425204,2.822634,-.1457812,1.017072,-6.78708,-1.042529,.04110823,-4.000629,4.362364,1.09054,-1.338674,.8246964,.2912211,10.95249,-1.061598,-.2096143,3.803155,-7.977069,-3.63788,3.707671,-.1903128,.99715,-3.397953,-1.07356,-.2077964,1.492052,16.26322,-5.015304,-.4059889,.2659782,.5634436,.639538,-1.172794,-.2111186,-1.360013,1.60408,-.08473723,.7217312,.154803,.6328974,4.25701,-1.238374,-.2670827,.3247678,.5466311,-.7425952,.527644,.02678026,.6814734,5.484169,-1.176923,-.2574586,2.304045,-2.797678,1.464405,1.998552,.2550559,.7544892,-4.199772,-1.003284,.01943984,-2.145066,10.30924,-15.25413,-2.02301,.5448699,.5539148,8.159497,-1.060017,-.2037206,2.483018,-4.595459,6.526991,4.031804,.1206513,.7875752,-2.586527,-1.081141,-.2123302,1.092275,2.683841,-4.166938,-1.396582,.4371205,.6664862,1.030233,-1.222392,-.2651924,-.4625037,.3521964,.02148855,.5078494,.179159,.5998216,3.852516,-1.42461,-.4710155,-.1826815,1.786277,-1.952442,.5277612,-.01773629,.6701272,2.415874,-1.130655,-.1358609,.9171203,-4.660394,6.251162,1.904529,.2639668,.822844,1.85613,-.9739015,-.06674749,-.4768897,12.48589,-19.94688,-2.353043,.5885575,.4830135,1.287251,-1.082178,-.1974495,1.050245,-4.792855,8.663406,3.246969,.1556731,.8050376,.8117442,-1.063354,-.1727108,.9681592,2.736077,-4.969269,-.836057,.5994612,.6786935,1.024039,-1.261936,-.3053676,-.4262222,.4000196,-.02059388,.4721802,.1480028,.6121337,3.505343,-1.681088,-.6971919,-.1105652,.7437426,-.6594399,.2254221,.08710195,.5681865,1.263913,-.9453001,.03460388,.6067038,-1.985128,3.457236,2.655483,-.01162354,1.00195,3.304716,-1.086609,-.2029011,-.639917,6.926885,-15.12189,-3.793051,.945612,.2893725,.2222222,-1.041259,-.138879,1.147331,6.282086,3.679836,4.398314,-.1355232,.9273509,1.031134,-1.063473,-.1916051,.6556979,-.003371891,-3.699664,-1.926783,.7371154,.6367068,1.179975,-1.33639,-.3778927,-.7259477,.2270247,.4627513,.1366459,.2637347,.4998211,3.292059,-2.119878,-1.055472,.5422052,.7826648,-1.286065,.9517905,-.1432358,.5910513,-.2379816,-.7761432,.2124336,-.6845184,-.9812342,4.347257,.967198,.377315,.9646598,5.789529,-1.118734,-.3513815,.5500918,.9449627,-12.6207,-1.82528,.473126,.3568768,-3.326892,-1.026437,-.08257946,.3221701,11.98372,1.55513,2.560304,.1406465,.8643181,2.912858,-1.069949,-.2029607,.5825042,-.002398595,-3.278335,-1.349882,.7208433,.6625391,.8505164,-1.392309,-.4454945,-.5664,.6283393,-.3761727,.6949802,.07748178,.5968661,3.192797,-2.713405,-1.395112,.202923,.1877272,-.3715859,-.1652929,.2385861,.1375467,-.4150768,-.9588644,.024339,-1.527493,-.9632874,5.496269,1.094931,.2004044,1.369604,6.084554,-.8028546,-.2473563,1.617898,2.073591,-11.49446,-.8394131,.2726847,.1367293,-4.634538,-1.198326,-.1804865,-.3565414,4.0732,1.662086,1.23977,.3367978,.9360383,2.997402,-1.013531,-.185906,.5799857,13.31883,-4.346873,-1.11382,.5275714,.6496373,.8045177,-1.530103,-.6107468,-.3841771,1.881508,-1.464807,.665469,-5950797e-12,.8101012,2.738912,-2.415469,-1.057499,-.4161968,-2.357548,.6300296,.6224915,.01545048,-.1339415,2.038561,-3.096796,-1.465688,-1.199232,4.567061,3.26098,-.9794907,.8950491,1.331015,2.049235,.2713904,.2852852,1.20209,-8.206784,-5.805762,1.804431,-.6090648,.3288858,-1.990902,-1.45658,-.345596,-.06409257,16.67697,-2.311094,-.9771104,.6759863,.7911932,1.245136,-.9860389,-.2099564,.294665,-.0035478,-2.268313,-.06205647,.4705185,.6856284,.8657995,-1.971736,-.9414047,-.3400557,1.468763,-1.474284,.5501062,-110975e-10,.9001702,2.35637,-1.589845,-.7797079,-.558224,-.8137376,.5846617,.1129459,-.02658005,-.2112486,2.707248,-6.940173,-2.823963,-1.620848,1.090696,2.39173,1.370047,.5890462,1.331253,1.7284,1.293144,-.001919778,1.644206,-.8666967,-7.161953,-1.385018,-.1505374,.2530122,-1.388643,-1.48888,-.2495496,-.2377137,11.67714,-.8617124,1.053828,.1992744,.8553304,.3633564,-1.060891,-.4035829,.2823207,-.002369798,-1.876577,-.5950265,.4241017,.6631669,.3140802,-1.101204,-.1351353,-4.030882,6.096353,-.1148599,1.606507,-1555474e-12,.5973715,4.436084,-1.154597,-.1923378,.8512132,.2934895,-.06522777,.1389077,.09091469,.2108541,3.133307,-1.031588,-.1546804,5.266214,-.949139,-.7184867,4.875626,-.1911907,1.087895,-2.865642,-1.159454,-.09546699,-1.508146,-.02031411,1.040653,-2.333508,.2540592,.0931677,8.594981,-1.03594,-.2021151,4.719343,-.9019318,-7.858046,3.901234,-.2233137,.6550733,-4.344739,-1.096669,-.1558196,2.057553,6.274495,-2.678352,-1.814927,.1550676,.4998989,1.903276,-1.114209,-.1473531,-7.602914,8.973685,-.04980074,1.289198,.08366906,.6118757,4.557987,-1.149397,-.1981628,4.914096,-3.498986,-.0625709,.1667401,.104898,.5935965,2.284689,-1.056121,-.1456172,.4272656,2.912649,-.5501745,4.406542,-.138768,.9733011,1.245555,-1.125047,-.04003662,1.058457,-3.462236,.4395278,-2.395805,.5177589,.4253189,4.866247,-1.051444,-.2804541,3.364668,3.293787,-10.15741,3.807407,-.3592377,.7900825,-3.367415,-1.093847,-.1436965,2.38478,5.78707,-2.445987,-1.311171,.2326563,.5555416,1.158439,-1.134824,-.1680468,-3.32562,4.458596,-.1135063,1.1045,.07794544,.6854854,4.609952,-1.143017,-.1565926,.3014687,-.1763027,-.03557925,-.2342406,.2528705,.4750602,5.884085,-1.136801,-.2907502,3.682423,-.4061202,-.8728159,4.00151,-.1522202,1.044847,-5.528713,-1.063652,.07808107,-1.983678,.3648078,2.102276,-3.06505,.8431951,.2662834,10.3883,-1.061015,-.2859814,4.223615,-2.290138,-8.31401,4.405718,-.4613627,1.008383,-4.50291,-1.106302,-.1697123,2.087196,8.238929,-2.992416,-1.821776,.3434859,.534119,.7755179,-1.17111,-.2106304,-1.614361,2.378103,-.1625969,.8504483,.1059312,.6618227,4.046256,-1.20048,-.2235733,1.01439,-1.174074,-.444018,.2262406,.1665868,.567631,5.461829,-1.223587,-.3502622,1.699106,.6724266,1.268567,2.135102,.0008039374,.944569,-5.221111,-.9452673,.1468459,-1.335034,4.346628,-12.85652,-1.807046,.8175243,.3656798,9.301065,-1.134681,-.3310951,3.571244,-2.208948,6.04158,3.107577,-.3112127,.9188333,-4.186351,-1.083237,-.1831394,2.062654,1.385424,-5.00495,-1.332669,.3627352,.6191181,.332315,-1.211527,-.2590617,-.1660874,.3627905,-.1039258,.4697924,.1671653,.6022506,3.507497,-1.433017,-.4733592,.1724445,.9953236,-1.874457,.4432099,.0171581,.644147,2.339272,-1.08492,-.1587903,.8999585,-2.537516,5.877859,2.014554,.09689141,.9030399,.3177242,-1.008242,.00279303,-.3507469,10.283,-20.80454,-2.781026,.899509,.3473867,3.366951,-1.103151,-.2799598,2.525791,-4.255704,9.903388,3.722668,-.3603941,.9369454,-1.303292,-1.102235,-.2025061,2.08566,1.686787,-5.010957,-1.656458,.4584029,.6184162,-.2751759,-1.25613,-.3104904,.163935,.1315502,-.7297583,.477848,.1259265,.6202728,3.012108,-1.620114,-.655267,-.2877157,1.094371,.2818914,.369683,.09428521,.5681308,1.450951,-.9686204,-.03755647,1.46998,-3.103414,2.856583,1.883209,-.05746099,1.001751,1.286383,-1.089377,-.1023062,-1.498891,10.66455,-17.20184,-2.759314,1.061258,.2624701,2.910211,-1.044681,-.2156857,3.230136,-.5863862,6.09664,3.550019,-.4255773,.9687696,-1.500033,-1.133658,-.2505101,1.71784,.008480428,-5.011789,-1.740989,.498343,.6088641,-.2081829,-1.335366,-.3863319,-.5279971,.3638324,.3230699,.08339707,.2483293,.4998346,2.678646,-2.004511,-.9957121,1.250807,.01625025,-.3410754,.7858244,-.09506757,.5788643,.02651876,-.8714157,.1192051,-.8486879,-.3702497,1.818277,1.103427,.2454866,.984735,3.841575,-1.042618,-.2285793,.3620175,2.983368,-9.776844,-1.971587,.6691674,.32132,-.7901947,-1.099112,-.1869868,2.044065,2.062964,1.265668,2.71013,-.1099443,.9024108,.2179353,-1.106985,-.2396881,1.809807,8.523319,-5.011788,-1.590086,.3248449,.6550606,-.1003187,-1.421285,-.4767024,-.3885004,.827459,-.3644229,.6999513,.0519671,.624631,2.578431,-2.611217,-1.398846,.4527425,-.5932142,.2224617,-.5593581,.3389633,.06536004,-.7767112,-.9881543,.04684782,-.8616613,.8799807,4.00313,1.739543,-.08098378,1.499673,5.524802,-.7544759,-.2314808,.812577,-.7724135,-9.577645,-1.629433,.6790832,-.02526624,-4.193895,-1.273719,-.218703,1.401798,5.231832,.7405093,1.775166,-.07269476,1.05745,1.996087,-1.046864,-.2247559,1.679449,11.40057,-4.948829,-1.182664,.3241038,.61159,-.2470012,-1.514607,-.598543,-.187761,1.75693,-1.314206,.611581,-597046e-11,.8124304,2.412975,-2.308414,-1.083797,-.1179959,-1.728246,.7784742,.5494505,.006203168,-.1419518,.9326251,-3.230837,-1.43867,-.9868286,2.974393,1.949339,-.6337857,.8160271,1.354373,3.278606,.5149378,.2754789,1.040965,-4.501186,-3.399057,.9661861,-.4736173,.2794847,-4.037574,-1.62187,-.3192763,.8786242,9.785565,-2.727652,.01903691,.5521261,.8419871,2.138764,-.9951701,-.2550607,1.498952,-.002737197,-3.101832,-.5921329,.2864422,.663141,-.4405218,-1.902954,-.9056918,-.206957,1.191499,-1.092577,.5849556,-9649602e-12,.9001527,2.048407,-1.271627,-.7193923,-.01136606,-.1167951,.003286175,-.05262827,-.02473874,-.2187133,1.716125,-7.647175,-3.114129,-1.490128,-.5266488,3.06309,1.474262,.5481458,1.353089,2.052174,2.191403,.342112,1.44651,2.170943,-7.768187,-1.471207,-.1456708,.2310576,-1.753574,-1.932296,-.3814739,.6245422,6.748294,-.3060171,1.067747,.2500671,.8614611,-.1252596,-.9471101,-.405264,1.300174,-.003951536,-1.908284,-.5385721,.2133578,.6658012,-.6250292],i_=[1.962684,1.159831,4.450588,5.079633,4.437388,4.324573,1.946487,1.287515,3.703696,8.782833,3.440437,5.160333,1.88217,1.335878,2.648641,13.58368,3.105473,5.907387,1.738159,1.624289,-.008786695,21.18253,2.770255,7.055672,1.571896,2.301786,-4.028545,29.66806,1.630876,8.711031,1.475048,2.679086,-6.311315,33.77896,2.140975,9.385283,1.326174,3.378759,-9.831444,39.42061,2.852702,10.82542,1.153344,3.967771,-12.65181,41.95016,7.468239,12.2135,.9746081,4.051626,-12.98454,37.54964,17.49232,14.20619,.8448016,3.181809,-8.757338,21.97962,35.24033,16.39549,2.029623,1.364434,4.201529,5.415099,9.825839,10.63328,2.023126,1.494728,3.420413,9.072178,9.205157,11.86639,1.956307,1.648665,2.039712,14.30239,9.039526,13.30453,1.825053,1.985022,-.8036307,22.02493,9.415361,15.17659,1.650367,2.593201,-4.469328,29.69817,9.410977,17.4485,1.555202,2.962925,-6.60817,33.29887,10.64559,18.50816,1.412478,3.439403,-9.196616,36.85077,13.45341,20.03128,1.25299,3.820805,-11.15338,37.21593,20.14916,21.8232,1.091952,3.663027,-10.3133,29.78985,32.96835,23.7545,.9501691,2.664579,-5.545167,12.81159,51.54768,25.74284],n_=[-1.14053,-.1982747,-7.51273,8.403899,-.05699038,.9015907,.03392161,.5111184,4.772522,-1.165117,-.1852955,2.963684,-2.262274,-.1571683,.6339974,.04977879,.4220053,7.243307,-1.169936,-.3357429,1.911291,-.2391074,-.4791643,1.446113,-.09178108,.8096219,-4.700239,-1.060246,-.1051633,.5013829,2.832309,-.3707855,1.523131,.09163749,.7208566,5.604183,-1.089753,-.2382167,2.360312,-5.902562,-8.799894,1.377692,-.06131633,.6124057,-1.415472,-1.075481,-.1242391,1.425781,8.810319,-2.922646,1.48652,.0327058,.4999482,3.889783,-1.149342,-.2076337,-7.446587,8.014559,-.04866227,.8203043,.06386483,.5452051,4.894198,-1.120531,-.1513311,2.735504,-2.417591,-.1361114,.4296342,.09427488,.4102448,8.171403,-1.226964,-.3516378,1.308298,-.05097487,-.4846783,1.654619,-.113494,1.131147,-3.347854,-.9664377,.02767589,.1658235,2.407439,-.1300304,.9170958,.2742895,.2550064,6.642633,-1.153358,-.3126223,2.078934,-5.857733,-8.659848,1.758505,-.09616094,.9663832,-1.230863,-1.05385,-.1330743,1.481738,10.49485,-3.528854,.9142363,.124488,.5001048,2.644615,-1.173687,-.2360362,-3.741454,4.088507,-.07528205,.6645237,.07718265,.5586318,4.65122,-1.213757,-.2589561,.7132551,-.4259327,-.1980821,.3627815,.0466656,.5847377,5.807984,-1.108794,-.225987,1.574179,-.3753731,-.5984743,1.659414,-.01681021,.8647325,.6785219,-1.060896,-.0134669,-.7529656,1.711319,-.9792435,.2022433,.3826487,.5290714,5.725157,-1.085145,-.2840715,2.088029,-4.935097,-9.056542,1.976149,-.03912485,.7452125,-.8636064,-1.077983,-.1416633,1.100848,10.15875,-2.943712,.5255135,.2164224,.6699937,2.941143,-1.223293,-.2867444,-1.624136,1.668299,-.09537589,.5015947,.1130741,.5082152,4.244812,-1.325342,-.4280991,.470549,.06926592,-.4572587,.5344144,-.02554192,.6639401,3.093939,-1.113581,-.1192133,.4011536,.7011889,.2052842,.9880724,.01807533,.857624,4.69016,-1.016063,-.1038138,-.2280391,.7898918,-11.27333,.2074545,.5388182,.4660455,1.364263,-1.099582,-.2228607,1.332648,5.135188,1.653152,1.41702,-.1087532,.8080874,1.809275,-1.064357,-.1520775,.8207368,-.001323565,-5.009523,.3946298,.4337902,.6719172,2.593198,-1.278702,-.3512866,-.4511055,.389576,-.2429672,.4270577,.1135348,.4998867,3.71913,-1.580069,-.7095475,-.3198904,1.715748,-1.185915,.4523161,-.01026159,.553835,.7927188,-.9474023,.1173703,.4881381,-2.618684,3.251661,1.213931,-.01736274,1.025998,8.000768,-1.129091,-.3287694,-.3524077,3.352892,-14.16073,-.8485617,.6560766,.3111303,-2.820937,-1.030884,-.1137581,1.109855,8.082276,1.519214,2.112433,-.1592299,.8703367,3.675905,-1.075192,-.1627166,.351491,1.168164,-4.255822,-.6015348,.6265776,.6548384,2.884818,-1.316017,-.3889652,-.5030854,.4488704,-.31868,.4570763,.08909201,.5011746,3.659274,-1.731876,-.8493806,.1194871,2.002781,-2.006547,.4872233,-.02854606,.4611629,.2662137,-.927368,.1380954,-.3302179,-3.553265,4.633345,.9696729,.08799775,1.094451,8.291129,-1.099377,-.3325392,.2501063,2.613712,-13.28142,-.5579527,.4992081,.3022924,-3.504402,-1.04842,-.1227773,.5845373,11.05869,.03813151,1.330409,.01978131,.8396439,3.95943,-1.063233,-.1560639,.2840033,.8751565,-3.41182,-.1436564,.584658,.6799095,2.899292,-1.376715,-.4541567,-1.445491,1.569898,-.1390627,.555827,.04109877,.5516123,3.349451,-1.953391,-1.035869,1.690563,-.196469,-.7787096,.5799605,.02945626,.2451373,.04217906,-1.012422,.07136451,-1.862534,-.7228653,.1947997,.2091805,.06399233,1.290733,7.928994,-.9706708,-.288095,1.107797,-2.731734,-8.445995,.4296774,.5117648,.1761207,-3.824277,-1.110611,-.1789409,.2108488,20.7143,-1.763174,.09554695,-.02943103,.8815496,3.422079,-1.048334,-.1614087,.2475184,.02146938,-2.983901,.2538224,.560137,.6777394,2.461925,-1.393719,-.5002724,-2.40894,2.680983,-.1362825,.7395067,-3300343e-12,.8132057,3.260889,-2.128663,-1.151182,2.923026,-1.931838,-.442617,.2309983,-.00548589,-.2229467,.3279529,-1.618022,-.376649,-3.163544,1.611608,-.3967476,.393368,.3006742,1.613765,6.835177,-.5669064,-.1481749,2.071817,-8.157422,-5.988088,.2387202,.1447191,.05011258,-4.296385,-1.241724,-.2519348,-.1908609,29.52235,-3.33366,-.01837651,.1022249,.8867262,2.92932,-1.02167,-.1667327,.1789771,-.002178108,-2.641572,-.05641484,.5303758,.678035,2.138196,-1.669332,-.7588708,-2.993557,3.17876,-.08066442,.6544672,-808988e-11,.9001272,2.628924,-1.755806,-.8735348,3.258881,-2.504785,-.3300791,.1180565,-.009315982,-.3205824,1.785154,-3.720277,-1.73335,-3.332272,1.515869,.1734218,.8011956,.199544,1.638502,3.817666,.4724641,.3209828,2.051443,-5.105574,-6.509139,-.4232041,.2598931,-.00349391,-2.151756,-1.5256,-.4897606,-.09891121,23.46818,-2.278152,.1681219,-.04469389,.9294666,1.051,-.9908649,-.2008182,.1605143,-.002463113,-2.477349,-.1218647,.4750121,.6661364,1.460813,-2.122119,-1.125475,-3.066599,3.145078,-.05411593,.5133628,-7823408e-12,.9001416,2.268448,-1.528158,-.9370249,2.567559,-1.591439,-.363446,.1763256,.001119624,-.2637929,1.811848,-6.524387,-2.673507,-2.940472,-.6025609,.7852067,1.073499,-.03540435,1.490466,3.517416,.8886026,-.09681828,1.430554,4.993717,-6.071355,-.6053986,.5092997,.07491329,-1.27301,-1.481997,-.5897282,.2659264,1.267239,-.5741291,.05983011,-.2217312,.926083,-.3016452,-1.010943,-.2075134,.05066749,14.70708,-3.780501,.07253223,.4045458,.6559925,1.320164,-1.129907,-.1884011,-8.04767,9.035776,-.05539419,.8823349,.03197135,.5042822,4.839388,-1.133821,-.1510781,3.362822,-2.453381,-.1463925,.4728708,.0595814,.4805162,7.6363,-1.176518,-.3549902,1.729044,-.2160966,-.5075865,1.675584,-.08906902,.5452218,-5.386842,-1.043563,-.07520975,.8750644,2.510518,.007584882,.936125,.07889083,.5813108,6.066644,-1.081304,-.2222253,2.517638,-4.45382,-8.663691,.8662558,-.04802657,.4886656,-.8965449,-1.083774,-.1375469,1.685818,5.63112,-3.100752,.4045941,.02346895,.5008309,3.390321,-1.143158,-.2058334,-9.660198,10.62394,-.04434119,.8607615,.03177325,.5918162,4.416481,-1.146773,-.1727385,4.626048,-4.684602,-.08307137,.1619616,.1484866,.2681126,7.572868,-1.151324,-.3099303,.4125596,2.340752,-.4214444,1.987375,-.191341,1.337311,-3.845978,-1.034258,-.007778759,.7050094,-.8036369,.313857,.2469452,.355997,.04790329,7.485917,-1.096568,-.2673169,2.575654,-.8057121,-8.884928,1.41617,-.2091315,1.065445,-1.543494,-1.083304,-.1528265,1.697727,2.503702,-2.885296,-.12985,.154887,.5066496,2.479652,-1.165736,-.2329945,-5.967964,6.705959,-.05931355,.7485638,.03913878,.6183926,4.221591,-1.212422,-.254591,2.418626,-2.266104,-.1102014,.01363887,.1055411,.4557412,5.648062,-1.070436,-.2163341,.7098718,.7843075,-.432393,2.109823,-.095897,1.060428,-.1985193,-1.104879,-.03013622,.02976276,1.069707,.141,-.488002,.4452288,.3195986,6.41859,-1.048969,-.2655317,2.689426,-3.941038,-9.506461,1.837119,-.1892124,.9043414,-1.562146,-1.106145,-.1601642,1.544544,7.388492,-2.9246,-.4328453,.1763161,.5851902,2.523111,-1.203666,-.2776587,-2.084286,2.45084,-.08746613,.5258507,.07983316,.5486167,3.860055,-1.340448,-.423059,.3462849,.4707607,-.2512626,.1530746,.02724218,.5876133,3.035216,-1.014554,-.116879,.9477794,-1.061218,-.419673,2.058832,-.05989624,.9763861,3.058168,-1.137388,-.0985403,-.2984893,3.64782,-.6585571,-1.47918,.6102932,.3480333,3.265914,-1.021816,-.2344957,2.463671,-7.240685,-8.862697,2.514058,-.2122768,.9028136,-.03313968,-1.126581,-.1874347,1.454154,10.34398,-3.237393,-.8654927,.2457248,.6002482,1.845769,-1.263727,-.3439354,-.1786388,.3980166,-.3349517,.3825166,.1029225,.4998955,3.331096,-1.53001,-.6879698,.2380415,1.608216,-1.682679,.354636,-.00391522,.5128605,.4517655,-.9685659,.09480403,.06076844,-3.217561,4.568074,1.069299,.02083638,1.072165,7.301088,-1.113925,-.3112382,.3954133,5.105907,-14.56866,-.4917378,.5289909,.3014709,-2.678374,-1.046864,-.1215754,1.778308,4.661489,.2565583,1.35368,-.1175767,.8457746,3.415972,-1.10448,-.1940913,1.343668,-.001759206,-5.009204,-.4186951,.312571,.6720408,1.628183,-1.286902,-.3781238,-.08977253,.3545393,-.4866515,.3843664,.08281675,.5046991,3.122231,-1.712597,-.8549112,.4809286,1.515398,-2.212211,.2539029,.02335997,.4268444,-.06089466,-.8807283,.1646097,-.4437898,-3.188247,5.984417,1.334779,-.04026975,1.175751,7.546431,-1.147253,-.3538199,.6101836,4.43778,-15.59813,-1.103222,.6242039,.217429,-3.091472,-1.03823,-.1213475,1.547505,5.893176,1.368738,1.663127,-.137713,.8736453,3.185279,-1.101026,-.1874907,1.272667,3.596524,-5.007243,-.6352483,.3048985,.6788844,1.931613,-1.342753,-.4384971,-1.213491,1.621399,-.1551441,.5614218,.02591739,.5782132,2.958967,-1.937684,-1.066019,1.913336,-.7347719,-.5916167,.158759,.1092568,.1599071,-.6275002,-.9302391,.1486187,-1.603835,.1783713,1.100461,1.174181,-.1602361,1.468971,7.868331,-1.053631,-.372705,1.114117,-.9603286,-10.62469,-1.16214,.7952797,-.04440862,-4.478765,-1.083629,-.1261405,1.229344,11.27825,.131901,1.624729,-.2825898,1.036911,3.661082,-1.09395,-.2067455,1.258035,7.548645,-4.598387,-.8944932,.3292634,.6291871,1.311304,-1.385867,-.5068139,-1.48649,1.969049,-.1698025,.6629167,-5289365e-12,.8644368,2.760315,-2.107367,-1.175639,2.313241,-1.001653,-.4843139,.1124485,3901494e-11,-.320478,-.3502469,-1.475244,-.2833055,-2.085824,1.192563,-.76452,.8380081,.220358,1.753702,7.157885,-.6644372,-.2549735,1.600273,-8.589034,-6.144718,-.7599731,.289837,-.09656242,-5.770923,-1.211687,-.1653494,.83934,27.92988,-3.395461,.9933752,-.03976877,.9546526,3.776659,-1.063757,-.2037563,1.117207,-.001252806,-3.33233,-.6971409,.3388719,.6635171,1.311398,-1.678889,-.7992295,-2.421687,2.871029,-.07662842,.6046208,-7598099e-12,.9001307,2.002314,-1.692144,-.880425,3.060895,-2.000009,-.3183563,.08385862,-.006326713,-.3369967,1.206639,-3.676795,-1.719207,-2.534697,1.005285,.1550407,1.07291,.1318094,1.689191,3.717018,.5424542,.3263528,1.551055,-3.841058,-6.598996,-1.201779,.3530669,-.06482523,-2.542945,-1.553849,-.457686,.9324676,19.50982,-2.344516,1.12102,-.1221537,.9582816,.7285496,-1.02065,-.2215797,1.009774,-.002056855,-2.740338,-.8122355,.3328967,.6594676,.8982766,-2.24736,-1.221267,-3.072346,3.385139,-.04387559,.5084887,-7418833e-12,.9001401,1.750107,-1.248499,-.8442718,3.062611,-2.020314,-.2815341,.05254745,.003345008,-.2835911,1.433225,-7.004119,-2.927978,-2.649852,.7971894,.5466893,1.442667,-.06063912,1.547429,2.806194,1.434882,.09114639,1.170089,.03512808,-5.861915,-1.411843,.5400486,.02386984,-.7746522,-1.559053,-.5502302,1.200396,13.47741,-2.344397,.8868907,-.3292661,.9217826,-1.362105,-1.044436,-.2360719,.7054471,-.002904518,-2.092829,-.5119668,.4174861,.6588427,.9687435],s_=[1.59033,1.355401,1.151412,13.59116,5.857714,8.090833,1.55254,1.51004,.1276413,16.04643,5.912162,8.350009,1.470871,1.880464,-1.865398,20.30808,5.471461,9.109834,1.356563,2.373866,-4.653245,25.70922,5.686009,10.0948,1.244232,2.851519,-7.130942,29.93449,6.38212,11.14578,1.173693,3.120604,-8.491886,31.87393,7.290615,11.80066,1.091845,3.368888,-9.722083,32.68508,10.32424,12.36508,.9858985,3.500541,-10.26328,30.92956,16.10881,13.31222,.8864993,3.172888,-8.68755,23.62161,26.21851,14.74967,.7946973,2.189355,-4.207953,9.399091,40.62849,16.81753,1.711696,1.657311,.9328021,13.1788,15.06751,18.63556,1.666968,1.849993,-.2088601,15.86653,14.8688,19.40719,1.584846,2.170022,-2.019597,19.70826,14.90684,20.45055,1.469412,2.524017,-4.197267,23.65249,16.64588,21.34477,1.369714,2.843548,-6.059031,26.34993,18.81361,22.32186,1.310477,2.984444,-6.831686,26.8234,21.23267,22.59755,1.222552,3.176523,-7.731496,26.7176,24.84358,23.36863,1.115781,3.130635,-7.581744,23.36531,31.71048,24.13859,1.013181,2.699342,-5.602709,15.00158,42.17613,25.15957,.8976323,1.726948,-1.29612,1.183675,55.03215,26.43066],o_=[-1.372629,-.4905585,-41.00789,41.22169,-.00738936,.4839359,.006474757,.5092936,3.471755,-1.523025,-.6497084,6.249857,-5.662543,-.01908402,.551281,-2181049e-11,.4339598,2.507663,-1.035567,-.0747874,.922103,-2.140047,-.02374146,.3795517,-.01769134,.7729303,7.479831,-1.271086,-.558819,.6908023,2.096832,-.2453967,1.410648,.04475036,.5741186,-4.719115,-.9712598,-.07033926,.9167274,-.9502097,.3004684,.4547054,-.05929017,.7204135,5.266196,-1.087457,-.1888896,.8156686,.3101712,-2.155419,1.422205,.09692261,.499943,3.122404,-1.42528,-.5413508,-34.54883,34.81142,-.008686975,.4914268,-2479243e-12,.6094201,3.239879,-1.688557,-.8070865,7.018459,-6.244574,-.02149341,.3993971,.01252502,.109786,1.630662,-.8664152,.07869125,-.5236535,-1.21896,-.02059093,.6684898,-.05584112,1.410496,8.602299,-1.319763,-.5985323,1.253918,1.914706,-.3216739,.9011213,.1324845,.06231252,-5.252749,-.9706008,-.05914059,.569315,-1.175362,.5221644,.7518213,-.08247655,.9850863,5.875635,-1.08533,-.1956105,.8019605,.5338101,-3.423464,1.110444,.1507923,.4999481,2.864942,-1.431967,-.5478935,-32.86288,33.05288,-.008380797,.477205,-3044274e-12,.5976303,3.289973,-1.801361,-.9315889,5.391756,-4.588592,-.02040076,.4144684,.01814534,.1145651,1.051795,-.7905357,.1451332,-.1605661,-1.592174,.0004561348,.3380323,-.07770275,1.489512,8.775384,-1.308575,-.5539232,.9184133,2.011479,-.3842472,1.432274,.1637153,.05272957,-4.408856,-.9829872,-.08183048,.4464556,-1.442716,1.029641,-.06991617,.008702356,.9116452,5.706417,-1.08713,-.2038013,.7260801,.9164376,-5.006183,1.511271,.1257134,.6201652,2.715439,-1.448662,-.5799075,-28.33268,28.58023,-.009134061,.4404783,-2709026e-12,.5540071,3.029357,-2.061772,-1.14519,7.918478,-7.212525,-.0202076,.2962715,.0468967,.2334587,.8517209,-.6413755,.1780425,-2.412919,1.064484,-.01949986,.6769741,-.175276,1.325869,7.262714,-1.304871,-.3975581,1.219002,.7285178,-.2710105,.7779727,.3247139,.1839517,-.8818168,-1.001104,-.1994801,.3676742,-1.409737,.2901555,.250694,.002468899,.8584645,3.398923,-1.111552,-.2487204,.7410842,1.703749,-5.007855,1.057763,.1354511,.6600013,2.088715,-1.547227,-.6679466,-18.61465,18.84045,-.0124221,.4157339,-2432805e-12,.5446957,2.812423,-2.04389,-1.149081,2.304118,-1.715757,-.02433628,.2816836,.07185458,.2706789,1.06486,-.904072,-.08274472,-.2555676,-.6326215,-.0277088,.6676024,-.2513532,1.241452,5.903839,-1.000013,-.1010774,.3699166,.8774526,-.3042007,.6951053,.4361813,.2573892,.6793421,-1.171332,-.3768188,.3701377,-1.470757,.5525942,.02991456,.01581823,.8214514,2.365233,-1.068667,-.232633,.6725059,2.243733,-4.61437,1.033677,.1376291,.6865304,2.013334,-1.592991,-.7246948,-25.98204,26.2196,-.008365176,.4207571,-2742772e-12,.587319,2.623735,-2.271349,-1.280884,6.308739,-5.75835,-.01977049,.3671835,.06698038,.1759218,1.150597,-.636862,-.007436052,-2.230026,1.640997,-.01548497,.3145331,-.2492644,1.260215,5.083843,-1.177925,-.09628114,.3051152,-.03749544,-.2713209,1.164226,.4559969,.2874284,2.175429,-1.0785,-.3801779,.4788906,-.4795969,.5977621,-.4488535,.03386874,.8062054,1.538143,-1.108028,-.2596892,.5162202,1.557081,-4.265039,1.182535,.1563762,.6883383,2.095084,-1.668427,-.7908511,-27.7969,27.99746,-.007186935,.3757766,-3326858e-12,.5439687,2.563421,-2.156175,-1.220004,3.585732,-3.235988,-.01086239,.1846143,.1046017,.2842191,1.234427,-1.117051,-.4101627,-.846373,.7671472,-.02226609,.8574943,-.3434124,1.154824,4.475715,-.744484,.2312078,-.5393724,.1574213,-.1763914,.2751692,.55642,.3483932,2.217672,-1.273036,-.5275562,.4902512,-.04498436,.4339366,.2386682,.02380879,.7855923,1.413444,-1.084192,-.2936753,.4719432,1.384436,-3.257789,.6119543,.1681884,.6936631,1.650441,-1.84849,-.951267,-30.05251,30.24315,-.005635304,.344778,-2782999e-12,.5643559,2.309422,-2.300008,-1.252335,-1.218876,1.49373,-.0061071,.0797486,.1023449,.2360948,1.505934,-1.483705,-.8547575,-.7797146,.6447971,-.02678052,1.091263,-.3344889,1.189425,3.830416,-.5348005,.3982733,-.4071573,.3265569,-.08658789,-.2370892,.5369097,.3143303,1.478279,-1.320401,-.6043247,.3019196,-.07732911,.4768381,.6745764,.03694098,.8169056,1.158234,-1.10104,-.3420019,.3775661,1.769338,-2.990515,.1649529,.1970125,.6759757,1.453355,-2.251946,-1.229349,-32.71808,32.83114,-.004252027,.3372289,-3001937e-12,.5842674,2.154046,-1.867834,-.9531252,-12.29365,12.69149,-.006844772,.1185107,.07539587,.1899412,1.846381,-3.398629,-2.180862,2.335213,-3.382823,-.008613985,.8431602,-.2393567,1.218556,3.11246,.5708381,.940603,-.6890113,2.746233,-.05772068,.1096005,.3491978,.3212049,.7281453,-1.705909,-.8517224,.113116,-2.141434,.4274043,.33976,.178649,.78828,.9026101,-1.012865,-.3495551,.3369038,3.724205,-3.089586,.1266964,.146179,.6931052,1.170199,-2.890318,-1.665573,-34.93756,35.00369,-.002984251,.2622419,-425936e-11,.6905752,1.947681,-1.956022,-1.0629,-19.19714,19.75164,-.008865396,.216554,.05475637,.003164249,1.761134,-5.612198,-3.101371,4.098034,-6.144001,.009944958,.2905472,-.170711,1.33766,3.199107,.8353756,.4855943,-1.243589,5.147385,-.07013963,.938041,.2335714,.2802696,.1727744,-1.524329,-.7388547,.3259025,-4.050634,.4058549,-.2591384,.1898299,.7884126,.3556071,-1.070371,-.4207858,.1739862,5.29341,-3.136757,.2323856,.1673706,.6844287,1.007227,-1.34172,-.4834889,-46.33447,46.82148,-.006137296,.4599216,.007047323,.4999398,2.895798,-1.529104,-.6498631,15.34103,-14.50675,-.01531439,.3280082,.01682926,.5013227,1.901587,-1.014776,-.1454495,-4.071085,2.954982,-.02630348,.5681531,-.03016505,.5003504,6.773854,-1.172413,-.402632,2.960428,.202071,-.2004947,.9375572,.05998168,.4502898,-4.945934,-.9898161,-.05772814,.4470024,-.5786656,.1158168,.346804,-.0504336,.8012363,6.867947,-1.085111,-.1882675,1.223748,.3565495,-3.688357,.5653723,.06727646,.49994,2.69013,-1.389119,-.529025,-40.55774,41.05972,-.007062577,.456006,-1736334e-12,.6671455,2.775512,-1.584641,-.7200619,12.48067,-11.56028,-.01659568,.3050029,.01099895,-.02138015,1.438927,-.9826068,-.08887254,-2.960031,1.808816,-.02478159,.6035733,-.04868441,1.584739,7.347705,-1.150423,-.4073793,2.412991,.487084,-.2337902,.8295114,.1129914,-.09016643,-5.150045,-1.016933,-.06311501,.5218937,-.571643,.1250993,.3601524,-.05497586,1.018333,7.060139,-1.073151,-.1845444,1.155394,.3004486,-3.431711,.4657031,.09401223,.4999544,2.68862,-1.391257,-.5365815,-42.55881,42.99132,-.005838466,.4229134,-2760038e-12,.6234597,2.775531,-1.780062,-.922888,13.76172,-12.60946,-.01507526,.3117435,.02205045,.03463446,.6093731,-.7388169,.127567,-3.999528,2.223993,-.01856853,.543931,-.08834054,1.645951,8.037139,-1.322387,-.5320143,2.659359,1.086712,-.2129712,.8704649,.1800315,-.138372,-4.967241,-.9378288,-.01599895,.3607555,-1.980561,.3791456,.1212268,-.02845992,1.059139,6.825542,-1.100832,-.2172313,1.211561,2.002721,-5.010011,.5717583,.06777702,.5676392,2.160006,-1.409373,-.5708751,-30.34974,30.79809,-.007280715,.3723304,-2436279e-12,.5913377,2.577348,-1.954312,-1.11651,5.399148,-4.299553,-.01724739,.3742824,.04187077,.1232727,.1044883,-.6772215,.2001396,-.3670523,-1.014628,-.003497152,.4099858,-.1584633,1.514559,7.7504,-1.2916,-.4977437,.9641914,1.56242,-.3227782,.9055427,.3046444,.009546291,-3.385619,-.9750857,-.0877056,.9054256,-1.429236,.8974777,-.1217961,-.05194608,.9589153,4.909409,-1.088007,-.1959301,.9745799,1.260761,-5.008864,.7271248,.1096661,.6340731,2.717295,-1.45605,-.6223072,-22.28088,22.69604,-.009340812,.4118308,-2418083e-12,.5589638,2.442117,-2.176449,-1.302416,2.222836,-1.22273,-.01728051,.1323513,.07027731,.2093351,.04835745,-.5789641,.2215407,.2142291,-1.201725,-.01185728,.8122982,-.238042,1.404146,6.706841,-1.307463,-.4515174,.6447827,1.223841,-.2902391,.4986588,.4073652,.1060885,-1.706696,-.9698678,-.1307094,.9389347,-1.522852,.7768797,-.1368595,-.03857426,.8980966,3.676935,-1.104349,-.2380323,1.047043,1.865421,-5.011664,.7014954,.09622701,.6687354,1.89136,-1.502249,-.6724523,-28.88092,29.3036,-.006685766,.3685464,-2469442e-12,.5566754,2.310797,-2.217125,-1.364924,4.048243,-3.111333,-.01317747,.1921948,.08627702,.2213689,.001981769,-.6215757,.1687995,-.5949131,-.1551293,.0003356129,.6897657,-.2855053,1.363084,6.271042,-1.216317,-.3489429,.7566226,.5409809,-.2830843,.6191825,.4755163,.1383909,-.9131387,-1.030437,-.2034064,.8335995,-1.050947,.8689093,-.367231,-.04056183,.8856842,3.111269,-1.078984,-.2070549,.9683145,1.497022,-5.007653,.7702541,.1285822,.6587911,2.225188,-1.559291,-.7374039,-35.96311,36.3447,-.004667132,.3277964,-2487945e-12,.5764681,2.215652,-2.356929,-1.444755,6.244526,-5.540162,-.00879451,.17921,.09578517,.1922194,.3737676,-.6589752,-.0292691,-1.831779,1.869962,-.002030095,.7552089,-.3168157,1.294054,4.632196,-1.161046,-.1472506,.6494138,-.8327174,-.2320724,.3391212,.5269637,.2458573,.9376341,-1.034427,-.3062504,.8975634,.3203531,.8565142,-.1250162,-.04094017,.8223468,1.861304,-1.109954,-.2740277,1.063811,.7077398,-4.695734,.5621696,.1248956,.678972,1.297723,-1.788293,-.9368751,-43.8298,44.24963,-.00365253,.3094331,-2810503e-12,.5861599,1.904402,-2.268206,-1.312676,2.863082,-2.373727,-.00514498,.1711072,.09316041,.1791683,.9309598,-1.376966,-.7418582,-1.349589,1.563419,-.003124219,.6967139,-.3061887,1.255669,3.602731,-.601754,.2815928,.5424052,-.688545,-.1620001,.2980046,.4995571,.2812466,.7371203,-1.278853,-.5245326,.787052,.3125067,.7748105,-.07788581,.003490956,.813019,1.283748,-1.05093,-.2786331,1.056344,1.053002,-4.047789,.4432174,.1169077,.6806764,.9532621,-2.084927,-1.203954,-48.81638,49.2016,-.002896045,.2882977,-3073517e-12,.637418,1.702211,-2.328567,-1.238023,-1.891019,2.45152,-.005847581,.2084702,.0784813,.08095008,1.211048,-2.634632,-1.78946,-.1370558,-.3326435,.002783737,.5239451,-.2548881,1.324116,2.896327,.06882616,.5997821,.1535398,1.375209,-.1267285,.4239743,.4013122,.2395382,.1794675,-1.430918,-.6439041,.832598,-1.705612,.7236426,-.05567593,.06408718,.8388887,.6836524,-1.037956,-.3215402,.9457349,3.178114,-4.152156,.2230992,.1156198,.6656923,.7606223,-2.967314,-1.728778,-37.30988,37.55578,-.002588835,.2927966,-3935038e-12,.6868694,1.592161,-2.123311,-1.175148,-13.14988,13.86882,-.007828537,.1852026,.05481038,.02428177,1.294309,-5.443597,-3.156344,2.110838,-3.421556,.0118189,.1196951,-.1742902,1.272805,2.404353,1.029898,.5912521,-.3983531,3.286069,-.09252065,1.331381,.2560642,.3624178,.8001754,-1.547574,-.7881604,1.020902,-2.897069,.521347,-.9242315,.1185594,.7317211,-1.150721,-.9621043,-.1991406,.6531287,3.925839,-3.596904,.6317332,.1531334,.6966285,1.457846],r_=[.9926518,1.999494,-4.136109,18.5627,13.51028,13.90238,.9634366,2.119694,-4.614523,19.19701,13.76644,14.18731,.9446537,2.17161,-4.915556,19.1824,15.37135,14.0053,.9073074,2.330536,-5.577596,19.61615,16.88365,14.46955,.8739124,2.388682,-5.842995,19.23265,18.87735,14.85698,.8563688,2.391534,-5.769133,18.28709,20.97209,14.69587,.8270533,2.34279,-5.558071,16.84993,23.56498,15.05975,.7908339,2.190341,-4.852571,13.74862,28.06846,15.48444,.7403619,1.783998,-2.983854,7.622563,35.0761,16.15805,.6840111,1.154457,-.239383,-.7896893,42.82765,17.79469,1.1683,1.860993,-2.129074,12.51952,30.32499,29.38716,1.150338,1.918813,-2.413527,12.74862,30.87134,29.51432,1.114719,1.964689,-2.625423,12.47837,32.37949,29.43596,1.077948,2.006292,-2.846934,11.90195,34.59293,29.37492,1.035143,1.986681,-2.752584,10.60972,37.22185,29.18594,1.015992,1.992054,-2.812626,10.01416,38.473,29.24624,.9756887,1.939897,-2.533281,8.319176,40.83907,29.25586,.9264164,1.716454,-1.597044,4.739725,45.07683,28.78915,.8595191,1.346034,-.02801895,-.6582906,50.17523,28.52953,.7754116,.7709245,2.200201,-7.487661,54.36622,28.93432],a_=[t_,n_,o_],l_=[i_,s_,r_];function rl(s,e,t,i){const n=i,o=1-i,a=n*n,l=a*n,c=l*n,h=c*n,d=o*o,u=d*o,m=u*o;return 1*(m*o)*s[e+0*t]+5*m*n*s[e+1*t]+10*u*a*s[e+2*t]+10*d*l*s[e+3*t]+5*o*c*s[e+4*t]+1*h*s[e+5*t]}function eu(s,e,t,i,n,o){const a=Math.pow(Math.max(0,1-n/(Math.PI/2)),.3333333333333333),l=Math.max(1,Math.min(10,Math.floor(t))),c=Math.min(10,l+1),h=Math.max(0,Math.min(1,t-l)),d=o,u=e*6*10+o,m=rl(s,d+e*6*(l-1),e,a),g=rl(s,u+e*6*(l-1),e,a),b=rl(s,d+e*6*(c-1),e,a),x=rl(s,u+e*6*(c-1),e,a);return m*(1-i)*(1-h)+g*i*(1-h)+b*(1-i)*h+x*i*h}function c_(s,e,t){const i=Math.acos(xi(s.z,0,1)),n=Array.from({length:9},()=>new F(0,0,0));for(let a=0;a<3;a++){const l=a;for(let c=0;c<9;c++)n[c].setComponent(l,eu(a_[a].slice(c),9,e,t,i,0))}const o=h_(i,e,t,n);return{params:n,radiance:o}}function h_(s,e,t,i){const n=new F;for(let c=0;c<3;c++){const h=c,d=eu(l_[c],1,e,t,s,0);n.setComponent(h,d)}const o=new F(Math.pow(.2126,1/2.2),Math.pow(.7152,1/2.2),Math.pow(.0722,1/2.2)),l=d_(Math.cos(s),0,1,i).multiply(n).dot(o);return l>0&&n.divideScalar(l),n}function d_(s,e,t,i){const n=i[0],o=i[1],a=i[2],l=i[3],c=i[4],h=i[5],d=i[6],u=i[7],m=i[8];function g(v){return(1+t*t)/Math.pow(1+v*v-2*t*v,1.5)}const b=new F(g(u.x),g(u.y),g(u.z)),x=Math.max(s,.05);return new F((1+n.x*Math.exp(o.x/x))*(a.x+l.x*Math.exp(c.x*e)+h.x*t*t+d.x*b.x+m.x*Math.sqrt(Math.max(0,s))),(1+n.y*Math.exp(o.y/x))*(a.y+l.y*Math.exp(c.y*e)+h.y*t*t+d.y*b.y+m.y*Math.sqrt(Math.max(0,s))),(1+n.z*Math.exp(o.z/x))*(a.z+l.z*Math.exp(c.z*e)+h.z*t*t+d.z*b.z+m.z*Math.sqrt(Math.max(0,s))))}class u_{constructor(){r(this,"hosekWilkieParams",[]);r(this,"radiance",new F);r(this,"sunDirection",new F);r(this,"groundTint",new be);r(this,"topColor",new be);r(this,"bottomColor",new be);r(this,"sinBottomAngle",0);r(this,"exponent",0)}}class Nc extends Ht{constructor(){super({vsName:"procedural_sky_vertex.glsl",fsName:"procedural_sky_fragment.glsl",uniformBufferData:new u_});r(this,"_turbidity",3);r(this,"_groundAlbedo",.1);r(this,"_sunDirection",new F(0,0,1));r(this,"_sunEastAzimuth",0);r(this,"_sunProgressAngle",90);r(this,"_useSunLightPosition",!1);r(this,"_groundTint",[1,1,1]);r(this,"_topColor",new be(15135487).toArray());r(this,"_bottomColor",new be(16777215).toArray());r(this,"_bottomAngle",-30);r(this,"_exponent",.9);r(this,"_simpleModelUseGradient",!0);r(this,"_model","simple");this.depthWrite=!1,this.side=Fi.BACK,this.fogSupported=!0,this.hdrOutputSupported=!0,this.colorMapSupported=!0,this.exposureAndGammaSupported=!0,this.toneMappingSupported=!0,this._setUniforms()}get groundTint(){return this._groundTint}set groundTint(t){this._groundTint=t,this._setUniforms()}get simpleModelUseGradient(){return this._simpleModelUseGradient}set simpleModelUseGradient(t){this._simpleModelUseGradient=t,this._setUniforms()}get exponent(){return this._exponent}set exponent(t){this._exponent=t,this._setUniforms()}get bottomAngle(){return this._bottomAngle}set bottomAngle(t){this._bottomAngle=t,this._setUniforms()}get bottomColor(){return this._bottomColor}set bottomColor(t){this._bottomColor=t,this._setUniforms()}get topColor(){return this._topColor}set topColor(t){this._topColor=t,this._setUniforms()}get model(){return this._model}set model(t){this._model=t,this._setUniforms()}get useSunLightPosition(){return this._useSunLightPosition}set useSunLightPosition(t){this._useSunLightPosition=t,this._setUniforms()}get sunEastAzimuth(){return this._sunEastAzimuth}set sunEastAzimuth(t){this._sunEastAzimuth=t,this._setUniforms()}get sunProgressAngle(){return this._sunProgressAngle}set sunProgressAngle(t){this._sunProgressAngle=t,this._setUniforms()}get turbidity(){return this._turbidity}set turbidity(t){this._turbidity=t,this._setUniforms()}get groundAlbedo(){return this._groundAlbedo}set groundAlbedo(t){this._groundAlbedo=t,this._setUniforms()}set sunDirection(t){this._sunDirection.approxEquals(t)||(this._sunDirection=t,this._setUniforms())}_setUniforms(){switch(this.condDefine(this._model==="hosekWilkie","SKY_MODEL_HOSEK_WILKIE"),this.condDefine(this._model==="simple","SKY_MODEL_SIMPLE"),this._model){case"hosekWilkie":this._setHosekWilkieUniforms();break;case"simple":this._setSimpleUniforms();break}this._updated()}_setSimpleUniforms(){this.setUniform("uTopColor","c",new be(this._topColor[0],this._topColor[1],this._topColor[2]),le.MATERIAL),this.condDefine(this._simpleModelUseGradient,"SIMPLE_USE_BOTTOM_GRADIENT"),this._simpleModelUseGradient&&(this.setUniform("uBottomColor","c",new be(this._bottomColor[0],this._bottomColor[1],this._bottomColor[2]),le.MATERIAL),this.setUniform("uSinBottomAngle","f",Math.sin(qt(this._bottomAngle)),le.MATERIAL),this.setUniform("uExponent","f",this._exponent,le.MATERIAL))}_setHosekWilkieUniforms(){this._useSunLightPosition||this._calculateSunDirection();const{params:t,radiance:i}=c_(this._sunDirection,this._turbidity,this._groundAlbedo),n=t.map((o,a)=>`uHosekWilkieParams[${a}]`);for(let o=0;o<t.length;o++)this.setUniform(n[o],"v3",t[o],le.MATERIAL);this.setUniform("uRadiance","v3",i,le.MATERIAL),this.setUniform("uSunDirection","v3",this._sunDirection,le.MATERIAL),this.setUniform("uGroundTint","c",new be(this._groundTint[0],this._groundTint[1],this._groundTint[2]),le.MATERIAL)}_calculateSunDirection(){const t=qt(this._sunEastAzimuth+90),i=qt(this._sunProgressAngle);this._sunDirection.x=Math.cos(t)*Math.cos(i),this._sunDirection.y=Math.sin(t)*Math.cos(i),this._sunDirection.z=Math.sin(i),this._sunDirection.normalize()}serialize(){const t={model:this._model};switch(this._model){case"hosekWilkie":t.turbidity=this._turbidity,t.groundAlbedo=this._groundAlbedo,t.useSunLightPosition=this._useSunLightPosition,this._useSunLightPosition||(t.sunEastAzimuth=this._sunEastAzimuth,t.sunProgressAngle=this._sunProgressAngle),t.groundTint=this._groundTint;break;case"simple":t.topColor=this._topColor,t.simpleModelUseBottomGradient=this._simpleModelUseGradient,this._simpleModelUseGradient&&(t.bottomColor=this._bottomColor,t.bottomAngle=this._bottomAngle,t.exponent=this._exponent);break}return t}loadFromJson(t){var i,n,o,a,l,c,h,d,u,m,g;switch(this._model=t.model,this._model){case"hosekWilkie":this._turbidity=(i=t.turbidity)!=null?i:2,this._groundAlbedo=(n=t.groundAlbedo)!=null?n:.1,this._useSunLightPosition=(o=t.useSunLightPosition)!=null?o:!1,this._useSunLightPosition||(this._sunEastAzimuth=(a=t.sunEastAzimuth)!=null?a:0,this._sunProgressAngle=(l=t.sunProgressAngle)!=null?l:90),this._groundTint=(c=t.groundTint)!=null?c:[1,1,1];break;case"simple":this._topColor=(h=t.topColor)!=null?h:new be(15135487).toArray(),this._simpleModelUseGradient=(d=t.simpleModelUseBottomGradient)!=null?d:!0,this._simpleModelUseGradient&&(this._bottomColor=(u=t.bottomColor)!=null?u:new be(16777215).toArray(),this._bottomAngle=(m=t.bottomAngle)!=null?m:-30,this._exponent=(g=t.exponent)!=null?g:.9);break}this._setUniforms()}}const f_="rotate_gizmo_material_vertex.glsl",m_="rotate_gizmo_material_fragment.glsl";class p_{constructor(){r(this,"opacity",1);r(this,"color",new be);r(this,"gizmoPosition",new F);r(this,"sphereRadius",0)}}class __ extends Ht{constructor(t,i){super({vsName:f_,fsName:m_,uniformBufferData:new p_});r(this,"setUniforms",()=>{});this.blending=yi.NORMAL,this.depthTest=!1,this.depthWrite=!1,this.transparent=!0,this.transparentRenderOrder=1e3,this.hideFromLightProbes=!0,this.uniforms={opacity:{type:"f",value:1,uniformSourceType:le.MATERIAL},color:{type:"c",value:t,uniformSourceType:le.MATERIAL},gizmoPosition:{type:"v3",value:new F(0,0,0),uniformSourceType:le.MATERIAL},sphereRadius:{type:"f",value:1,uniformSourceType:le.MATERIAL}},this.opacity=i,this.fillMaterialUniformDataFromUniforms()}get color(){return this.accessUniform("color").value}get opacity(){return this.accessUniform("opacity").value}set opacity(t){this.accessUniform("opacity").value=t}get gizmoPosition(){return this.accessUniform("gizmoPosition").value}get sphereRadius(){return this.accessUniform("sphereRadius").value}set sphereRadius(t){this.accessUniform("sphereRadius").value=t}}const kc="sprite_vertex.glsl";class g_ extends Zo{constructor(){super(...arguments);r(this,"offset",new F)}}class tu extends gt{constructor(){super({vsName:kc,uniformBufferData:new g_}),this.vertexShaderName=kc,this._vertexShaderBody=ln.get(kc),this.hideFromLightProbes=!0,this.lightmapSupported=!1,this.setUniform("offset","v3",new F(0,0,0),le.MATERIAL)}set offset(e){this.uniforms.offset.value=e,this.uniformBufferData.offset.copyFrom(e)}}const v_="universal_material_vertex.glsl",b_="universal_material_fragment.glsl";class x_ extends Zo{constructor(){super(...arguments);r(this,"clearcoat",new Ce(0,0));r(this,"sheen",new tt(0,0,0,0));r(this,"specular",new tt(1,1,1,1));r(this,"highlightMix",0);r(this,"u_hdrOutput",new tl(0));r(this,"u_useEnvMap",new tl(0));r(this,"shpk_uniform0",new tt(0,0,0,0));r(this,"shpk_uniform1",new tt(0,0,0,0));r(this,"shpk_uniform2",new tt(0,0,0,0));r(this,"shpk_uniform3",new tt(0,0,0,0));r(this,"shpk_uniform4",new tt(0,0,0,0));r(this,"shpk_uniform5",new tt(0,0,0,0));r(this,"shpk_uniform6",new tt(0,0,0,0));r(this,"shpk_uniform7",new tt(0,0,0,0));r(this,"shpk_uniform8",new tt(0,0,0,0));r(this,"shpk_uniform9",new tt(0,0,0,0));r(this,"shpk_uniform10",new tt(0,0,0,0));r(this,"shpk_uniform11",new tt(0,0,0,0));r(this,"shpk_uniform12",new tt(0,0,0,0));r(this,"shpk_uniform13",new tt(0,0,0,0));r(this,"shpk_uniform14",new tt(0,0,0,0));r(this,"shpk_uniform15",new tt(0,0,0,0));r(this,"shpk_uniform16",new tt(0,0,0,0));r(this,"shpk_uniform17",new tt(0,0,0,0));r(this,"shpk_uniform18",new tt(0,0,0,0));r(this,"shpk_uniform19",new tt(0,0,0,0))}}class iu extends gt{constructor(){super({vsName:v_,fsName:b_,uniformBufferData:new x_});r(this,"textures",new Array);r(this,"uniformVectors",new Array);r(this,"alphaMode",Dr.OPAQUE);r(this,"usesTexCoords",!1);r(this,"clearcoatUnused",!1);r(this,"sheenUnused",!1);r(this,"_customShaderVersion",0);r(this,"_customShader");r(this,"_clearcoat",new Ce(0,0));r(this,"_sheen",new tt(0,0,0,0));r(this,"_specular",new tt(1,1,1,1))}get customShaderVersion(){return this._customShaderVersion}set customShaderVersion(t){this.removeDefine(`CUSTOM_SHADER_VERSION ${this._customShaderVersion}`),this._customShaderVersion=t}get clearcoat(){return this._clearcoat.x}set clearcoat(t){this._clearcoat.x=t,this.setUniforms(),this._updated()}get clearcoatRoughness(){return this._clearcoat.y}set clearcoatRoughness(t){this._clearcoat.y=t,this.setUniforms(),this._updated()}get sheenColor(){return[this._sheen.x,this._sheen.y,this._sheen.z]}set sheenColor(t){this._sheen.x=t[0],this._sheen.y=t[1],this._sheen.z=t[2],this.setUniforms(),this._updated()}get sheenRoughness(){return this._sheen.w}set sheenRoughness(t){this._sheen.w=t,this.setUniforms(),this._updated()}get specularColor(){return[this._specular.x,this._specular.y,this._specular.z]}set specularColor(t){this._specular.x=t[0],this._specular.y=t[1],this._specular.z=t[2],this.setUniforms(),this._updated()}get specular(){return this._specular.w}set specular(t){this._specular.w=t,this.setUniforms(),this._updated()}setUniforms(){var c,h;super.setUniforms();const t=!!this._customShader;t||(this.setUniform("clearcoat","v2",this._clearcoat,le.MATERIAL),this.setUniform("specular","v4",this._specular,le.MATERIAL),this.setUniform("sheen","v4",this._sheen,le.MATERIAL)),this.condDefine(!M.UNIVERSAL_MATERIAL_GLTF_PBR,"USE_STANDARD_PBR_MODEL"),this.condDefine(t,"CUSTOM_PBR_SHADER"),this.condDefine(this.usesTexCoords,"USES_TEX_COORDS"),this.addDefine("USE_NORMAL_MAPPING_FUNCS"),this.addDefine(`CUSTOM_SHADER_VERSION ${this._customShaderVersion}`);const i=d=>d.startsWith("USE_CLEARCOAT")||d.startsWith("USE_SHEEN")||d.startsWith("ALPHA_MODE");this.removeDefines(i);const n=t?!this.clearcoatUnused:this.clearcoat>0,o=Math.max(this._sheen.x,this._sheen.y,this._sheen.z),a=t?!this.sheenUnused:o>0;n&&this.addDefine("USE_CLEARCOAT"),a&&this.addDefine("USE_SHEEN"),this.addDefine(`ALPHA_MODE ${this.alphaMode}`),this.addDefine("HDR_OUTPUT");const l=(c=this.sharedMaterialState)!=null&&c.hdrOutput?1:0;if(this.setUniform("u_hdrOutput","i",l),this.reflective){const d=this.isLightProbeDisabled()?0:1;this.addDefine("USE_ENVMAP"),this.setUniform("u_useEnvMap","i",d),d||this._setLightProbeUniforms((h=this.sharedMaterialState)==null?void 0:h.getDefaultCubemap())}M.EDIT_MODE&&(this.addDefine("USE_HIGHLIGHT"),this.highlight&&this.setUniform("highlight","c",this.highlight,le.MATERIAL),this.setUniform("highlightMix","f",this.highlight?this.highlightMix:0,le.OBJECT));for(let d=0;d<this.textures.length;d++)this.setUniform(`texture${d}`,"t",this.textures[d],le.MATERIAL);for(let d=0;d<this.uniformVectors.length;d++)this.setUniform(`shpk_uniform${d}`,"v4",this.uniformVectors[d],le.MATERIAL)}_applySharedState(){super._applySharedState(),this.addDefine("HDR_OUTPUT")}forceEnableUv0(){return this.usesTexCoords}canMerge(t){return!1}set customShader(t){this._customShader=t,this._fragmentShaderHooks=t!=null?t:ln.get(gt.fragmentShaderHooks),this.setUniforms(),this._updated()}get customShader(){return this._customShader}get type(){return Tn.UNIVERSAL}configureTransparency(){this.transparent=this.customShader?this.alphaMode!=Dr.OPAQUE:this.opacity!=1,this.blending=this.transparent?yi.NORMAL:yi.DISABLED,this.transparentRenderOrder=this.alphaMode==Dr.MASK?0:1,this.depthWrite=this.alphaMode!=Dr.BLEND}serialize(){const t=super.serialize(),i=!this._customShader;return t.clearcoat=i?this.clearcoat:null,t.clearcoatRoughness=i?this.clearcoatRoughness:null,t.sheenColor=i?this.sheenColor:null,t.sheenRoughness=i?this.sheenRoughness:null,t.specular=i?this.specular:null,t.specularColor=i?this.specularColor:null,i&&(t.shaderId=null),t}}const y_=.1;class A_ extends Zo{constructor(){super(...arguments);r(this,"wavesSpeed",0);r(this,"wavesScale",0);r(this,"refractionFactor",0)}}class E_ extends gt{constructor(){super({fsHooks:"water.glsl",uniformBufferData:new A_});r(this,"_isPlaying",!0);r(this,"_isSleeping",!1);r(this,"_wavesSpeed",1);r(this,"_wavesScale",1);r(this,"_refractionFactor",0);M.DEV_DISABLE_UNIFORM_BUFFERS&&this.setUniform("time","f",0,le.GLOBAL),this.setUniform("wavesSpeed","f",0,le.MATERIAL),this._roughness=0,this.baseColor=new be(0),this.opacity=.2,this.doNotImport={baseColor:!0,baseColorTexture:!0,opacity:!0}}get hideFromLightProbes(){return this.opacity!==1&&this.refractionFactor!==0}set hideFromLightProbes(t){super.hideFromLightProbes=t}get isAnimated(){return!0}get isPlaying(){return!this._isSleeping&&this._isPlaying&&this.wavesSpeed>0}get refractionFactor(){return this._refractionFactor}set refractionFactor(t){this._doSetProperty(this,"_refractionFactor",t)}get wavesSpeed(){return this._wavesSpeed}set wavesSpeed(t){this._doSetProperty(this,"_wavesSpeed",t)}get wavesScale(){return this._wavesScale}set wavesScale(t){this._doSetProperty(this,"_wavesScale",t)}textureNeedsUv0(t){return!1}get type(){return Tn.WATER}canMerge(t){if(this.type!==t.type)return!1;const i=t;return this.opacity===i.opacity&&this.baseColor.equals(i.baseColor)&&this.normalTexture===i.normalTexture&&this.wavesSpeed===i.wavesSpeed&&this.wavesScale===i.wavesScale&&this.refractionFactor===i.refractionFactor}setUniforms(){if(super.setUniforms(),this.normalTexture!==void 0&&this.normalTexture.loaded&&!this.isLightProbeDisabled()){this.setUniform("wavesScale","f",this.wavesScale,le.MATERIAL);const t=this.opacity!==1?this.refractionFactor:0;this.setUniform("refractionFactor","f",t,le.MATERIAL)}this.setUniform("wavesSpeed","f",this.wavesSpeed*y_,le.MATERIAL),this.fillMaterialUniformDataFromUniforms()}play(){this._isPlaying=!0}pause(){this._isPlaying=!1}sleepAnimation(){this._isSleeping=!0}wakeAnimation(){this._isSleeping=!1}update(t){M.DEV_DISABLE_UNIFORM_BUFFERS&&(this.accessUniform("time").value+=t)}serialize(){var t,i;return this.id,{name:this.name,id:this.id,type:this.type,baseColor:this.baseColor.roundChannels().toArray(),baseColorTexture:null,opacity:this.opacity,normalTexture:(i=(t=this.normalTexture)==null?void 0:t.serialize())!=null?i:null,wavesSpeed:this.wavesSpeed,wavesScale:this.wavesScale,refractionFactor:this.refractionFactor,doNotImport:this.doNotImport}}}class on{constructor(){r(this,"id",NaN);r(this,"attributes",new g0);r(this,"attributesKeys",new Array);r(this,"boundingBox",null);r(this,"boundingSphere",null);r(this,"_disableBoundingVolumesCompute",!1);r(this,"_onDispose")}addAttribute(e,t){this.attributes[e]=t,this.attributesKeys.indexOf(e)==-1&&this.attributesKeys.push(e)}getAttribute(e){return this.attributes[e]}hasAttribute(e){return this.attributesKeys.includes(e)}applyMatrix(e){const t=this.attributes.position;t!==void 0&&(Pe(t.array instanceof Float32Array),e.affineTransformPoint3Array(t.array),t.needsUpdate=!0);const i=this.attributes.normal;i!==void 0&&(Pe(i.array instanceof Float32Array),new Ho().getNormalMatrix(e).transformVector3Array(i.array),i.needsUpdate=!0),this.boundingBox!==null&&this.computeBoundingBox(),this.boundingSphere!==null&&this.computeBoundingSphere()}center(){Ke(!this._disableBoundingVolumesCompute),this.computeBoundingBox();const e=this.boundingBox.center().negate();return this.applyMatrix(new at().setPosition(e)),e}computeBoundingBox(){if(this._disableBoundingVolumesCompute)return;Ke(this.attributes.position);const e=new F;this.boundingBox===null&&(this.boundingBox=new ti);const t=this.attributes.position.array;if(t){const i=this.boundingBox;i.makeEmpty();for(let n=0,o=t.length;n<o;n+=3)e.set(t[n],t[n+1],t[n+2]),i.expandByPoint(e)}else this.attributes.position.buffer&&console.warn("Computing bounding box for geometry with released position data");(!t||t.length===0)&&(this.boundingBox.min.set(0,0,0),this.boundingBox.max.set(0,0,0)),(isNaN(this.boundingBox.min.x)||isNaN(this.boundingBox.min.y)||isNaN(this.boundingBox.min.z))&&console.error('Computed bbox min/max have NaN values. The "position" attribute is likely to have NaN values.')}computeBoundingSphere(){if(this._disableBoundingVolumesCompute)return;Ke(this.attributes.position);const e=new ti,t=new F;this.boundingSphere===null&&(this.boundingSphere=new Fn);const i=this.attributes.position.array;if(i){e.makeEmpty();const n=this.boundingSphere.center;for(let a=0;a<i.length;a+=3)t.set(i[a],i[a+1],i[a+2]),e.expandByPoint(t);e.center(n);let o=0;for(let a=0;a<i.length;a+=3)t.set(i[a],i[a+1],i[a+2]),o=Math.max(o,n.distanceToSquared(t));this.boundingSphere.radius=Math.sqrt(o),isNaN(this.boundingSphere.radius)&&console.error('Computed bounding sphere radius is NaN. The "position" attribute is likely to have NaN values.')}else this.attributes.position.buffer&&console.warn("Computing bounding sphere for geometry with released position data")}computeVertexNormals(){var n;const e=this.attributes;if(!e.position)return;e.position.array instanceof Float32Array;const t=(n=e.index)==null?void 0:n.array,i=Er.vertexNormals(e.position.array,t);e.normal===void 0?this.addAttribute("normal",new At(i,3)):e.normal.array=i,e.normal.needsUpdate=!0}normalizeNormals(){this.attributes.normal&&(this.attributes.normal.array instanceof Float32Array,Er.normalizeVectors(this.attributes.normal.array))}setOnDispose(e){this._onDispose=e}dispose(){this._onDispose&&this._onDispose(this)}convertNormalsToSpherical(){Ke(this.attributes.normal),Ke(this.attributes.sphericalNormal===void 0),Ke(this.attributes.normal.array);const e=this.attributes.normal.array,t=Qe.ios,i=Er.normalsToSpherical(e,t);delete this.attributes.normal;const n=this.attributesKeys.indexOf("normal");this.attributesKeys.splice(n,1),this.addAttribute("sphericalNormal",new At(i,2))}changePosition(e){Ke(this.attributes.position);const t=this.attributes.position.length/3,i=this.attributes.position.array;for(let n=0;n<3*t;n+=3)i[n]+=e.x,i[n+1]+=e.y,i[n+2]+=e.z}generateUv1FromUv0(){this.attributes.uv0,this.attributes.uv1,this.attributes.uv1Mod;const e=[0,0,1/65535,1/65535],t=new Uint16Array(this.attributes.uv0.array.length),i=this.attributes.uv0.array;for(let n=0;n<i.length/2;n++){const o=[i[n*2],i[n*2+1]];t[n*2]=o[0]/e[2],t[n*2+1]=o[1]/e[3]}this.addAttribute("uv1",new At(t,2,0,!0)),this.addAttribute("uv1Mod",new At(new Float32Array(e),4,1,!0))}}class nt{static createBox(e,t,i,n=1,o=1,a=1){for(const b of[n,o,a])console.assert(Number.isInteger(b)&&b>=1);const l=new Array,c=new Array,h=new Array,d=new Array;let u=0;function m(b,x,v,E,w,C,I,O,U,z){const ie=C/U,J=I/z,re=C/2,Oe=I/2,We=O/2,Ve=U+1,lt=z+1;let k=0;const K=new F;for(let de=0;de<lt;de++){const ce=de*J-Oe;for(let Te=0;Te<Ve;Te++){const pe=Te*ie-re;K[b]=pe*E,K[x]=ce*w,K[v]=We,c.push(K.x,K.y,K.z),K[b]=0,K[x]=0,K[v]=O>0?1:-1,h.push(K.x,K.y,K.z),d.push(Te/U),d.push(1-de/z),k+=1}}for(let de=0;de<z;de++)for(let ce=0;ce<U;ce++){const Te=u+ce+Ve*de,pe=u+ce+Ve*(de+1),ye=u+(ce+1)+Ve*(de+1),Re=u+(ce+1)+Ve*de;l.push(Te,pe,Re),l.push(pe,ye,Re)}u+=k}m("z","y","x",-1,-1,i,t,e,a,o),m("z","y","x",1,-1,i,t,-e,a,o),m("x","z","y",1,1,e,i,t,n,a),m("x","z","y",1,-1,e,i,-t,n,a),m("x","y","z",1,-1,e,t,i,n,o),m("x","y","z",-1,-1,e,t,-i,n,o),console.assert(c.length<=65535+1);const g=new on;return g.addAttribute("index",new At(new Uint16Array(l),1)),g.addAttribute("position",new At(new Float32Array(c),3)),g.addAttribute("normal",new At(new Float32Array(h),3)),g.addAttribute("uv0",new At(new Float32Array(d),2)),g}static createSphere(e=50,t=8,i=6,n=0,o=Math.PI*2,a=0,l=Math.PI){console.assert(t>=3&&Number.isInteger(t)),console.assert(i>=2&&Number.isInteger(i));const c=a+l;let h=0;const d=[],u=new F,m=new F,g=new Array,b=new Array,x=new Array,v=new Array;for(let w=0;w<=i;w++){const C=[],I=w/i;for(let O=0;O<=t;O++){const U=O/t;u.x=-e*Math.cos(n+U*o)*Math.sin(a+I*l),u.y=e*Math.cos(a+I*l),u.z=e*Math.sin(n+U*o)*Math.sin(a+I*l),b.push(u.x,u.y,u.z),m.set(u.x,u.y,u.z),m.normalize(),x.push(m.x,m.y,m.z),v.push(U,1-I),C.push(h++)}d.push(C)}for(let w=0;w<i;w++)for(let C=0;C<t;C++){const I=d[w][C+1],O=d[w][C],U=d[w+1][C],z=d[w+1][C+1];(w!==0||a>0)&&g.push(I,O,z),(w!==i-1||c<Math.PI)&&g.push(O,U,z)}console.assert(b.length<=65535+1);const E=new on;return E.addAttribute("index",new At(new Uint16Array(g),1)),E.addAttribute("position",new At(new Float32Array(b),3)),E.addAttribute("normal",new At(new Float32Array(x),3)),E.addAttribute("uv0",new At(new Float32Array(v),2)),E}static createPlane(e,t,i=1,n=1){console.assert(i>=1&&Number.isInteger(i)),console.assert(n>=1&&Number.isInteger(n));const o=e/2,a=t/2,l=i,c=n,h=l+1,d=c+1,u=e/l,m=t/c,g=new Float32Array(h*d*3),b=new Float32Array(h*d*3),x=new Float32Array(h*d*2);let v=0,E=0;for(let I=0;I<d;I++){const O=I*m-a;for(let U=0;U<h;U++){const z=U*u-o;g[v]=z,g[v+1]=-O,b[v+2]=1,x[E]=U/l,x[E+1]=1-I/c,v+=3,E+=2}}v=0;const w=new(g.length/3>65535?Uint32Array:Uint16Array)(l*c*6);for(let I=0;I<c;I++)for(let O=0;O<l;O++){const U=O+h*I,z=O+h*(I+1),ie=O+1+h*(I+1),J=O+1+h*I;w[v]=U,w[v+1]=z,w[v+2]=J,w[v+3]=z,w[v+4]=ie,w[v+5]=J,v+=6}const C=new on;return C.addAttribute("index",new At(w,1)),C.addAttribute("position",new At(g,3)),C.addAttribute("normal",new At(b,3)),C.addAttribute("uv0",new At(x,2)),C}static createCylinder(e=20,t=20,i=100,n=8,o=1,a=!1,l=0,c=2*Math.PI){console.assert(n>=3&&Number.isInteger(n)),console.assert(o>=1&&Number.isInteger(o));const h=new Array,d=new Array,u=new Array,m=new Array;let g=0;const b=new Array,x=i/2;function v(){const C=new F,I=new F,O=(t-e)/i;for(let U=0;U<=o;U++){const z=[],ie=U/o,J=ie*(t-e)+e;for(let re=0;re<=n;re++){const Oe=re/n,We=Oe*c+l,Ve=Math.sin(We),lt=Math.cos(We);I.x=J*Ve,I.y=-ie*i+x,I.z=J*lt,d.push(I.x,I.y,I.z),C.set(Ve,O,lt),C.normalize(),u.push(C.x,C.y,C.z),m.push(Oe,1-ie),z.push(g++)}b.push(z)}for(let U=0;U<n;U++)for(let z=0;z<o;z++){const ie=b[z][U],J=b[z+1][U],re=b[z+1][U+1],Oe=b[z][U+1];h.push(ie,J,Oe),h.push(J,re,Oe)}}function E(C){const I=new Ce,O=new F,U=C?e:t,z=C?1:-1,ie=g;for(let re=1;re<=n;re++)d.push(0,x*z,0),u.push(0,z,0),m.push(.5,.5),g++;const J=g;for(let re=0;re<=n;re++){const We=re/n*c+l,Ve=Math.cos(We),lt=Math.sin(We);O.x=U*lt,O.y=x*z,O.z=U*Ve,d.push(O.x,O.y,O.z),u.push(0,z,0),I.x=Ve*.5+.5,I.y=lt*.5*z+.5,m.push(I.x,I.y),g++}for(let re=0;re<n;re++){const Oe=ie+re,We=J+re;C===!0?h.push(We,We+1,Oe):h.push(We+1,We,Oe)}}v(),a||(e>0&&E(!0),t>0&&E(!1)),console.assert(d.length<=65535+1);const w=new on;return w.addAttribute("index",new At(new Uint16Array(h),1)),w.addAttribute("position",new At(new Float32Array(d),3)),w.addAttribute("normal",new At(new Float32Array(u),3)),w.addAttribute("uv0",new At(new Float32Array(m),2)),w}static createTorus(e=1,t=.4,i=8,n=6,o=Math.PI*2){console.assert(i>=3&&Number.isInteger(i)),console.assert(n>=3&&Number.isInteger(n));const a=new Array,l=new Array,c=new Array,h=new Array,d=new F,u=new F,m=new F;for(let b=0;b<=i;b++)for(let x=0;x<=n;x++){const v=x/n*o,E=b/i*Math.PI*2;u.x=(e+t*Math.cos(E))*Math.cos(v),u.y=(e+t*Math.cos(E))*Math.sin(v),u.z=t*Math.sin(E),l.push(u.x,u.y,u.z),d.x=e*Math.cos(v),d.y=e*Math.sin(v),m.subVectors(u,d).normalize(),c.push(m.x,m.y,m.z),h.push(x/n),h.push(b/i)}for(let b=1;b<=i;b++)for(let x=1;x<=n;x++){const v=(n+1)*b+x-1,E=(n+1)*(b-1)+x-1,w=(n+1)*(b-1)+x,C=(n+1)*b+x;a.push(v,E,C),a.push(E,w,C)}console.assert(l.length<=65535+1);const g=new on;return g.addAttribute("index",new At(new Uint16Array(a),1)),g.addAttribute("position",new At(new Float32Array(l),3)),g.addAttribute("normal",new At(new Float32Array(c),3)),g.addAttribute("uv0",new At(new Float32Array(h),2)),g}static createPolyhedron(e,t,i=1,n=0){const o=new Array,a=new Array;function l(b,x,v){const E=Math.pow(2,n),w=new Array;for(let I=0;I<=E;I++){w[I]=[];const O=b.clone().lerp(v,I/E),U=x.clone().lerp(v,I/E),z=E-I;for(let ie=0;ie<=z;ie++)ie===0&&I===E?w[I][ie]=O:w[I][ie]=O.clone().lerp(U,ie/z)}const C=I=>o.push(I.x,I.y,I.z);for(let I=0;I<E;I++)for(let O=0;O<2*(E-I)-1;O++){const U=Math.floor(O/2);O%2===0?(C(w[I][U+1]),C(w[I+1][U]),C(w[I][U])):(C(w[I][U+1]),C(w[I+1][U+1]),C(w[I+1][U]))}}function c(){for(let b=0;b<a.length;b+=6){const x=a[b+0],v=a[b+2],E=a[b+4],w=Math.max(x,v,E),C=Math.min(x,v,E);w>.9&&C<.1&&(x<.2&&(a[b+0]+=1),v<.2&&(a[b+2]+=1),E<.2&&(a[b+4]+=1))}}function h(b,x){const v=b*3;x.x=e[v+0],x.y=e[v+1],x.z=e[v+2]}function d(){const b=new F,x=new F,v=new F,E=new F,w=new Ce,C=new Ce,I=new Ce,O=(U,z,ie,J)=>{J<0&&U.x===1&&(a[z]=U.x-1),ie.x===0&&ie.z===0&&(a[z]=J/2/Math.PI+.5)};for(let U=0,z=0;U<o.length;U+=9,z+=6){b.set(o[U+0],o[U+1],o[U+2]),x.set(o[U+3],o[U+4],o[U+5]),v.set(o[U+6],o[U+7],o[U+8]),w.set(a[z+0],a[z+1]),C.set(a[z+2],a[z+3]),I.set(a[z+4],a[z+5]),E.copyFrom(b).add(x).add(v).divideScalar(3);const ie=u(E);O(w,z+0,b,ie),O(C,z+2,x,ie),O(I,z+4,v,ie)}}const u=b=>Math.atan2(b.z,-b.x),m=b=>Math.atan2(-b.y,Math.sqrt(b.x*b.x+b.z*b.z));{const b=new F,x=new F,v=new F;for(let E=0;E<t.length;E+=3)h(t[E+0],b),h(t[E+1],x),h(t[E+2],v),l(b,x,v)}{const b=new F;for(let x=0;x<o.length;x+=3)b.x=o[x+0],b.y=o[x+1],b.z=o[x+2],b.normalize().multiplyScalar(i),o[x+0]=b.x,o[x+1]=b.y,o[x+2]=b.z}{const b=new F;for(let x=0;x<o.length;x+=3){b.x=o[x+0],b.y=o[x+1],b.z=o[x+2];const v=u(b)/2/Math.PI+.5,E=m(b)/Math.PI+.5;a.push(v,1-E)}d(),c()}const g=new on;return g.addAttribute("position",new At(new Float32Array(o),3)),g.addAttribute("normal",new At(new Float32Array(o.slice()),3)),g.addAttribute("uv0",new At(new Float32Array(a),2)),n===0?g.computeVertexNormals():g.normalizeNormals(),g}static createIcosahedron(e,t){const i=(1+Math.sqrt(5))/2,n=[-1,i,0,1,i,0,-1,-i,0,1,-i,0,0,-1,i,0,1,i,0,-1,-i,0,1,-i,i,0,-1,i,0,1,-i,0,-1,-i,0,1],o=[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1];return nt.createPolyhedron(n,o,e,t)}}function T_(){const s=nt.createBox(2,2,2);return s.convertNormalsToSpherical(),s}function S_(){const s=nt.createIcosahedron(1,2);return s.convertNormalsToSpherical(),s}var al=(s=>(s.CUBE="cube",s.SPHERE="sphere",s))(al||{});const Lr=new F,nu=new wi;var su=(s=>(s.UPDATED="cameraVolumeTriggerUpdated",s.DISPOSED="cameraVolumeTriggerDisposed",s))(su||{});const fs=class fs extends ei{constructor(t,i,n){super();r(this,"_enterCallbacks");r(this,"_exitCallbacks");r(this,"volumeType");r(this,"position");r(this,"rotation");r(this,"scale");r(this,"_inverse",new at);r(this,"_inverseCached",!1);r(this,"_inside",!1);r(this,"_cameraPosition");r(this,"_disposed",!1);this._enterCallbacks=t,this._exitCallbacks=i,this.volumeType=n.type,this.position=new F().fromArray(n.position),this.rotation=new ui().setFromDegTriple(n.rotation),this.scale=new F().fromArray(n.scale),this.onCameraPositionUpdated=this.onCameraPositionUpdated.bind(this)}onCameraPositionUpdated(t){this._cameraPosition=t.newPosition,this.onUpdated()}onUpdated(){if(this._disposed||(this.dispatchEvent({type:fs.eventType.UPDATED}),!this._cameraPosition))return;const t=this.isPointInside(this._cameraPosition);t!==this._inside&&(this._inside=t,t?this._enterCallbacks.forEach(i=>i()):this._exitCallbacks.forEach(i=>i()))}getVolumeGeometry(){return this.volumeType==="sphere"?fs._sphereGeometry:fs._boxGeometry}setPosition(t,i,n){this.position.set(t,i,n),this._inverseCached=!1,this.onUpdated()}setRotation(t,i,n){this.rotation.yaw=Nt(t),this.rotation.pitch=Nt(i),this.rotation.roll=Nt(n),this._inverseCached=!1,this.onUpdated()}setRotationDeg(t,i,n){const o=qt(t),a=qt(i),l=qt(n);this.setRotation(o,a,l)}setScale(t,i,n){this.scale.set(t,i,n),this._inverseCached=!1,this.onUpdated()}isPointInsideUnitSphere(t){return t.lengthSq()<=1}isPointInsideUnitCube(t){return Math.abs(Lr.x)<=1&&Math.abs(t.y)<=1&&Math.abs(t.z)<=1}isPointInside(t){return this._inverseCached||(this.rotation.toQuaternion(nu),this._inverse.compose(this.position,nu,this.scale),this._inverse.getInverse(this._inverse),this._inverseCached=!0),Lr.set(t.x,t.y,t.z),this._inverse.affineTransformPoint3(Lr),this.volumeType==="sphere"?this.isPointInsideUnitSphere(Lr):this.isPointInsideUnitCube(Lr)}dispose(t=!1){this._disposed=!0,this._inside&&!t&&this._exitCallbacks.forEach(i=>i()),this._inside=!1,this.dispatchEvent({type:fs.eventType.DISPOSED})}reinstate(){this._disposed=!1,this.dispatchEvent({type:fs.eventType.UPDATED})}serialize(){return{type:this.volumeType,position:this.position.toArray(),rotation:this.rotation.toDegTriple(),scale:this.scale.toArray()}}};r(fs,"eventType",su),r(fs,"_boxGeometry",T_()),r(fs,"_sphereGeometry",S_());let pn=fs;var ou=(s=>(s.POSITION_UPDATED="positionUpdated",s.BOUNDS_UPDATED="boundsUpdated",s.BOUNDS_INIT="boundsInit",s))(ou||{});const Us=class Us extends ei{constructor(t,i=!1){super();r(this,"id");r(this,"position");r(this,"boxMin",new F);r(this,"boxMax",new F);r(this,"_filteredCubeTexture");r(this,"_mirrorCubeTexture");r(this,"_boxEnabled");t.id,this.id=t.id,this.position=new F,t.position&&this.position.fromArray(t.position),this._boxEnabled=t.box?!("enabled"in t.box)||t.box.enabled:!1,t.box&&!i&&(this.boxMin.fromArray(t.box.min),this._setClampedBoxMax(...t.box.max))}setFilteredTexture(t){this._filteredCubeTexture&&this._filteredCubeTexture.dispose(),this._filteredCubeTexture=t}isBoundingBoxInitialized(){return!this.boxMin.equals(this.boxMax)}resetBoundingBox(){this.boxMin.set(0,0,0),this.boxMax.set(0,0,0)}isBoundingBoxEnabled(){return this._boxEnabled}disableBoundingBox(){this._boxEnabled=!1,this.dispatchEvent({type:Us.eventType.BOUNDS_UPDATED})}enableBoundingBox(){this._boxEnabled=!0,this.isBoundingBoxInitialized()||this.dispatchEvent({type:Us.eventType.BOUNDS_INIT}),this.dispatchEvent({type:Us.eventType.BOUNDS_UPDATED})}getFilteredTexture(){return this._filteredCubeTexture}setMirrorTexture(t){this._mirrorCubeTexture&&this._mirrorCubeTexture.dispose(),this._mirrorCubeTexture=t}setPosition(t,i,n){this.position.set(t,i,n),this.dispatchEvent({type:Us.eventType.POSITION_UPDATED})}texturesReady(){return!!(this._mirrorCubeTexture||this._filteredCubeTexture)}getMirrorTexture(){return this._mirrorCubeTexture||this._filteredCubeTexture}_setClampedBoxMin(t,i,n){t>this.boxMax.x-.1&&(t=this.boxMax.x-.1),i>this.boxMax.y-.1&&(i=this.boxMax.y-.1),n>this.boxMax.z-.1&&(n=this.boxMax.z-.1),this.boxMin.set(t,i,n)}setBoxMin(t,i,n){this._setClampedBoxMin(t,i,n),this.dispatchEvent({type:Us.eventType.BOUNDS_UPDATED})}_setClampedBoxMax(t,i,n){t<this.boxMin.x+.1&&(t=this.boxMin.x+.1),i<this.boxMin.y+.1&&(i=this.boxMin.y+.1),n<this.boxMin.z+.1&&(n=this.boxMin.z+.1),this.boxMax.set(t,i,n)}setBoxMax(t,i,n){this._setClampedBoxMax(t,i,n),this.dispatchEvent({type:Us.eventType.BOUNDS_UPDATED})}serialize(){const t={id:this.id,position:this.position.toArray()};return this.isBoundingBoxInitialized()&&(t.box={enabled:this._boxEnabled,min:this.boxMin.toArray(),max:this.boxMax.toArray()}),t}dispose(){this._filteredCubeTexture&&(this._filteredCubeTexture.dispose(),this._filteredCubeTexture=void 0),this._mirrorCubeTexture&&(this._mirrorCubeTexture.dispose(),this._mirrorCubeTexture=void 0)}};r(Us,"eventType",ou);let Mi=Us;var ru=(s=>(s.UPDATED="nodeConfigUpdated",s))(ru||{});function zc(s){return s!=null}class w_ extends ei{constructor(t){var i,n,o,a,l,c;super();r(this,"nodes",new Array);r(this,"name");r(this,"overriddenMaterialId");r(this,"_editable");r(this,"_setsDisableCollisions");r(this,"_disableCollisions");r(this,"_setsHideInViews");r(this,"_hideInViews",null);r(this,"_setsLightmapResolution",!1);r(this,"_lightmapResolution",null);r(this,"_ground");r(this,"_faceCamera");r(this,"_rotate");r(this,"_rotationSpeed");r(this,"_isolateShadows");r(this,"_setsSimplificationParams",!1);r(this,"_simplificationParams",null);r(this,"_updated");this.name=t.name,this.overriddenMaterialId=t.overriddenMaterialId,this._editable=t.editable||!1,this._setsDisableCollisions=zc(t.disableCollisions),this._disableCollisions=(i=t.disableCollisions)!=null?i:!1,this._setsHideInViews=zc(t.hideInViews),t.hideInViews&&(this._hideInViews=t.hideInViews,this._hideInViews.sort()),zc(t.lightmapResolution)&&(this._setsLightmapResolution=!0,this._lightmapResolution=t.lightmapResolution),this._ground=(n=t.ground)!=null?n:!1,this._faceCamera=(o=t.faceCamera)!=null?o:null,this._rotate=(a=t.rotate)!=null?a:!1,this._rotationSpeed=(l=t.rotationSpeed)!=null?l:.1,this._isolateShadows=(c=t.isolateShadows)!=null?c:!1,t.simplificationParams&&(this._setsSimplificationParams=!0,this._simplificationParams=t.simplificationParams),this._updated=()=>this.dispatchEvent({type:"nodeConfigUpdated",target:this})}get hideInViews(){return this._hideInViews}_configUpdated(){this.nodes.forEach(t=>t.visitSubtree(i=>i.configure())),this._updated()}addNode(t){this.nodes.push(t)}isOnHideInViews(t){return this._hideInViews,this._hideInViews.indexOf(t)!==-1}setHideInViews(t){this._hideInViews=t,this._configUpdated()}addToHideInViews(...t){console.assert(this.setsHideInViews),this._hideInViews;for(const i of t)console.assert(!this.isOnHideInViews(i)),this._hideInViews.push(i);this._configUpdated()}removeFromHideInViews(t){this._hideInViews&&(this._hideInViews=this._hideInViews.filter(i=>i!==t),this._configUpdated())}serialize(){var i;const t=this.setsSimplificationParams?this.simplificationParams:null;return{name:this.name,disableCollisions:this.setsDisableCollisions?this.disableCollisions:null,hideInViews:this.setsHideInViews?this.hideInViews:null,lightmapResolution:this.setsLightmapResolution?this.lightmapResolution:null,ground:this.ground?!0:null,faceCamera:this.faceCamera,rotate:this.rotate?!0:null,rotationSpeed:this.rotate?this.rotationSpeed:null,isolateShadows:this.isolateShadows?!0:null,simplificationParams:t,overriddenMaterialId:(i=this.overriddenMaterialId)!=null?i:null}}get setsDisableCollisions(){return this._setsDisableCollisions}set setsDisableCollisions(t){this._setsDisableCollisions=t,this._configUpdated()}get disableCollisions(){return this._disableCollisions}set disableCollisions(t){console.assert(this._setsDisableCollisions),this._disableCollisions=t,this._configUpdated()}get editable(){return!!(this._editable||this.faceCamera||this.rotate)}set editable(t){this._editable=t,this._configUpdated()}get ground(){return this._ground}set ground(t){this._ground=t,this._configUpdated()}get faceCamera(){return this._faceCamera}set faceCamera(t){this._faceCamera=t,this._configUpdated()}get rotate(){return this._rotate}set rotate(t){this._rotate=t,this._configUpdated()}get rotationSpeed(){return this._rotationSpeed}set rotationSpeed(t){t===0&&(t=.01),this._rotationSpeed=t,this._configUpdated()}get setsLightmapResolution(){return this._setsLightmapResolution}set setsLightmapResolution(t){this._setsLightmapResolution=t,this._configUpdated()}get lightmapResolution(){return this._lightmapResolution}set lightmapResolution(t){console.assert(this._setsLightmapResolution),this._lightmapResolution=t,this._configUpdated()}get isolateShadows(){return this._isolateShadows}set isolateShadows(t){this._isolateShadows=t,this._configUpdated()}get setsSimplificationParams(){return this._setsSimplificationParams}set setsSimplificationParams(t){this._setsSimplificationParams=t,this._configUpdated()}get simplificationParams(){return this._simplificationParams}set simplificationParams(t){console.assert(this._setsSimplificationParams),this._simplificationParams=t,this._configUpdated()}get setsHideInViews(){return this._setsHideInViews}set setsHideInViews(t){this._setsHideInViews=t,this._hideInViews===null&&(this._hideInViews=[]),this._configUpdated()}}function M_(s){const e=new at,t=new at;let i;const n=new F,o=new ui;function a(){i=new F;const l=new ti;s.visitSubtree(c=>{const h=c.mesh;h&&l.union(h.geometry.boundingBox)}),l.center(i),t.elements[12]=-i.x,t.elements[13]=-i.y,t.elements[14]=-i.z}return(l,c)=>(i||a(),s.animationMatrix,s.config.faceCamera?(n.copyFrom(c).sub(i).normalize(),o.setFromDirection(n),s.config.faceCamera==="yaw"&&(o.pitch=0),o.toRotationMatrix(e),s.animationMatrix.identity().setPosition(i).multiply(e).multiply(t),!1):(s.config.rotate,o.yaw=Nt(o.yaw+2*Math.PI*s.config.rotationSpeed*l),o.toRotationMatrix(e),s.animationMatrix.identity().setPosition(i).multiply(e).multiply(t),!0))}let au=class{constructor(e,t,i){r(this,"id");r(this,"parent");r(this,"config");r(this,"children",new Array);r(this,"mesh",null);r(this,"update",(e,t)=>!1);r(this,"initialLightProbeIds");r(this,"disableCollisions",null);r(this,"ground",null);r(this,"animationMatrix",null);r(this,"hideInViews",null);r(this,"lightmapResolution",null);r(this,"shadowsIsolatedWithin",null);r(this,"editable",!1);r(this,"editableRoot",null);r(this,"simplificationParams",null);r(this,"_facesCnt",null);r(this,"_originalFacesSubtreeCnt",null);r(this,"_originalFaceCnt");var n;this.id=i.id,this.initialLightProbeIds=(n=i.lightProbeIds)!=null?n:[],this.parent=e,this.config=t,this._originalFaceCnt=i.originalFaceCnt||0,this.hideInViews=null,this.lightmapResolution=null,t.addNode(this),this.configure()}configure(){this.config.setsDisableCollisions?this.disableCollisions=this.config.disableCollisions:this.parent?this.disableCollisions=this.parent.disableCollisions:this.disableCollisions=!1,this.ground=this.disableCollisions?!1:this.config.ground,this.isAnimatedRoot?(this.animationMatrix=new at,this.update=M_(this)):this.parent?this.animationMatrix=this.parent.animationMatrix:this.animationMatrix=null,this.config.setsHideInViews?this.hideInViews=this.config.hideInViews:this.parent?this.hideInViews=this.parent.hideInViews:this.hideInViews=null,this.config.setsLightmapResolution?this.lightmapResolution=this.config.lightmapResolution:this.parent?this.lightmapResolution=this.parent.lightmapResolution:this.lightmapResolution=null,this.config.setsSimplificationParams?this.simplificationParams=this.config.simplificationParams:this.parent?this.simplificationParams=this.parent.simplificationParams:this.simplificationParams=null,this.config.isolateShadows?this.shadowsIsolatedWithin=this.config.name:this.parent&&this.parent.shadowsIsolatedWithin?this.shadowsIsolatedWithin=this.parent.shadowsIsolatedWithin:this.shadowsIsolatedWithin=null,this.editable=this.config.editable,this.editable?this.editableRoot=this:this.parent?this.editableRoot=this.parent.editableRoot:this.editableRoot=null}visitSubtree(e){var t;e(this),(t=this.children)==null||t.forEach(i=>i.visitSubtree(e))}facesInSubtree(){return this._facesCnt===null&&(this._facesCnt=0,this.visitSubtree(e=>{this._facesCnt,e.mesh&&(this._facesCnt+=e.mesh.geometry.vertexCnt/3)})),this._facesCnt}originalFacesInSubtree(){return this._originalFacesSubtreeCnt===null&&(this._originalFacesSubtreeCnt=0,this.visitSubtree(e=>{this._originalFacesSubtreeCnt,e.mesh&&(this._originalFacesSubtreeCnt+=e._originalFaceCnt)})),this._originalFacesSubtreeCnt}hide(){this.visitSubtree(e=>{e.mesh&&(e.mesh.visible=!1)})}show(){this.visitSubtree(e=>{e.mesh&&(e.mesh.visible=!0)})}get isAnimatedRoot(){return!!(this.config.faceCamera||this.config.rotate)}serialize(){const e={id:this.id,children:this.children.map(t=>t.serialize())};return this.mesh&&(e.lightProbeIds=this.mesh.lightProbes.map(t=>t.id),e.mesh=!0),e}get type(){return this.config.name}set highlightMix(e){this.visitSubtree(t=>{t.mesh&&(t.mesh.highlightMix=e)})}set selected(e){this.visitSubtree(t=>{t.mesh&&(t.mesh.selected=e)})}set selectedSecondary(e){this.visitSubtree(t=>{t.mesh&&(t.mesh.selectedSecondary=e)})}};function Vc(s,e){let t;return s===Tn.UNIVERSAL?t=new iu:s===Tn.GRASS?t=new Bc:s===Tn.WATER?t=new E_:t=M.DEV_MATERIALX?new iu:new gt,t.source=e,t}class P_{constructor(e,t,i,n,o,a){r(this,"materials",new Array);r(this,"_animatableAuxiliaryObjects");r(this,"_materialIdToMergedMaterial",new Map);r(this,"_lastGeneratedMaterialId",-1);r(this,"_materialIdToPreviousTypes",new Map);r(this,"_materialToOverriddenNodeConfigs",new Map);r(this,"_gpuMeshes");r(this,"_sharedMaterialState");r(this,"_lightProbesDisabled");r(this,"_onSceneUpdated");r(this,"_onLiveLightmapUpdateNeeded");r(this,"_materialUpdated",()=>{this._onSceneUpdated()});this._gpuMeshes=e,this._sharedMaterialState=t,this._lightProbesDisabled=i,this._animatableAuxiliaryObjects=n,this._onSceneUpdated=o,this._onLiveLightmapUpdateNeeded=a}_generateNewMaterialId(){for(this._lastGeneratedMaterialId++;this._materialIdToMergedMaterial.has(this._lastGeneratedMaterialId);)this._lastGeneratedMaterialId++;return this._lastGeneratedMaterialId}getMaterial(e){return this._materialIdToMergedMaterial.get(e)}getOverriddenConfigs(e){const t=this._materialToOverriddenNodeConfigs.get(e);return t?[...t]:[]}addMergedMaterial(e,t,i){M.EDIT_MODE,e.id,e.id=t,i.id!==void 0&&this._materialIdToMergedMaterial.has(i.id),e.id!==void 0&&this._materialIdToMergedMaterial.has(e.id),this._materialIdToMergedMaterial.set(e.id,i)}addMaterial(e,t){e.source,Es.WEBWALK,e.id,`${e.id}`,e.id=t!=null?t:this._generateNewMaterialId(),this._materialIdToMergedMaterial.has(e.id),`${e.id}`,this.materials.push(e),this._materialIdToMergedMaterial.set(e.id,e),this._hookMaterialToScene(e)}removeMaterial(e){M.EDIT_MODE,e.id,this._materialIdToMergedMaterial.has(e.id),`${e.id}`,e.source,Es.SCENE,this._removeMaterialOverride(e),zi(e,this.materials),this._materialIdToMergedMaterial.delete(e.id),this._unhookMaterialFromScene(e),e.resetIdFromSceneMaterialManager(),this._removeMaterialOverride(e),this._onSceneUpdated()}removeMaterialOverrideForNodeType(e){var n;if(M.EDIT_MODE,e.overriddenMaterialId===void 0)return;const t=this.getMaterial(e.overriddenMaterialId);(n=this._materialToOverriddenNodeConfigs.get(t))==null||n.delete(e);let i=this.getMaterial(e.overriddenMaterialId).emissiveEnabled;e.overriddenMaterialId=void 0;for(const o of e.nodes){const a=o.mesh;a&&(a.material=this.getMaterial(a.originalMaterialId),a.material.emissiveEnabled&&(i=!0))}i&&this._onLiveLightmapUpdateNeeded(),this._onSceneUpdated()}initializeMaterialOverrides(e){for(const t of e){if(t.overriddenMaterialId===void 0)continue;const i=this.getMaterial(t.overriddenMaterialId);this.overrideMaterialForNodeType(t,i,!0)}}overrideMaterialForNodeType(e,t,i=!1){M.EDIT_MODE,t.id,e.overriddenMaterialId=t.id;let n=t.emissiveEnabled;this._materialToOverriddenNodeConfigs.has(t)||this._materialToOverriddenNodeConfigs.set(t,new Set),this._materialToOverriddenNodeConfigs.get(t).add(e);for(const o of e.nodes){const a=o.mesh;a&&(a.material.emissiveEnabled&&(n=!0),a.material=t)}i||(n&&this._onLiveLightmapUpdateNeeded(),t.setUniforms(),this._onSceneUpdated())}_removeMaterialOverride(e){for(const t of this.getOverriddenConfigs(e))this.removeMaterialOverrideForNodeType(t);this._materialToOverriddenNodeConfigs.delete(e)}_hookMaterialToScene(e){e.id,this._materialIdToPreviousTypes.has(e.id)||this._materialIdToPreviousTypes.set(e.id,new Map),this._materialIdToPreviousTypes.get(e.id).set(e.type,e),e.addEventListener(Ht.eventType.MATERIAL_UPDATED,this._materialUpdated),e.addEventListener(gt.eventType.MAJOR_LIGHTING_PROPERTY_UPDATED,this._onLiveLightmapUpdateNeeded),e.sharedMaterialState=this._sharedMaterialState,e.disableLightProbe=this._lightProbesDisabled()}_unhookMaterialFromScene(e){e.id,this._materialIdToPreviousTypes.has(e.id)&&this._materialIdToPreviousTypes.delete(e.id),e.removeEventListener(Ht.eventType.MATERIAL_UPDATED,this._materialUpdated),e.removeEventListener(gt.eventType.MAJOR_LIGHTING_PROPERTY_UPDATED,this._onLiveLightmapUpdateNeeded),e.sharedMaterialState=null}_replaceMaterial(e,t){const i=this.materials.findIndex(n=>n===e);e.id,this.materials[i]=t,this._materialIdToMergedMaterial.set(e.id,t),this._onSceneUpdated();for(let n=0;n<this._gpuMeshes.length;n+=1)this._gpuMeshes[n].material===e&&(this._gpuMeshes[n].material=t);return t.setUniforms(),t}changeMaterialType(e,t){M.EDIT_MODE,e.id;const i=this._materialIdToPreviousTypes.get(e.id);if(!i.has(t)){const o=Vc(t,e.source);o.name=e.name,o.id=e.id,i.set(t,o)}const n=i.get(t);return this._hookMaterialToScene(n),this._replaceMaterial(e,n),n}getAnimatedMaterials(){const e=new Set;for(const i of this._animatableAuxiliaryObjects)i.traverse(n=>{if(n instanceof Ye){const o=n.material;o.isAnimated&&e.add(o)}});const t=this.materials.filter(i=>i.isAnimated);return[...e,...t]}serialize(){return M.EDIT_MODE,this.materials.map(e=>e.serialize())}}var ts=function(){var s="b9H79Tebbbe8Fv9Gbb9Gvuuuuueu9Giuuub9Geueu9Giuuueuikqbeeedddillviebeoweuec:q;iekr;leDo9TW9T9VV95dbH9F9F939H79T9F9J9H229F9Jt9VV7bb8A9TW79O9V9Wt9F9KW9J9V9KW9wWVtW949c919M9MWVbeY9TW79O9V9Wt9F9KW9J9V9KW69U9KW949c919M9MWVbdE9TW79O9V9Wt9F9KW9J9V9KW69U9KW949tWG91W9U9JWbiL9TW79O9V9Wt9F9KW9J9V9KWS9P2tWV9p9JtblK9TW79O9V9Wt9F9KW9J9V9KWS9P2tWV9r919HtbvL9TW79O9V9Wt9F9KW9J9V9KWS9P2tWVT949Wbol79IV9Rbrq;d8Yqdbk:yzeHu8Jjjjjbcj;eb9Rgv8Kjjjjbc9:hodnadcefal0mbcuhoaiRbbc:Ge9hmbavaialfgrad9Radz1jjjbhwcj;abad9UhlaicefhodnadTmbalc;WFbGglcjdalcjd6EhDcbhqinaqae9pmeaDaeaq9RaqaDfae6Egkcsfglcl4cifcd4hxdndndndnalc9WGgmTmbcbhPcehsawcjdfhzaohHinaraH9Rax6midnaraHaxfgo9RcK6mbczhlcbhOinalgic9WfgAawcj;cbffhldndndndndnaHaAco4fRbbaOcoG4ciGPlbedibkal9cb83ibalcwf9cb83ibxikalaoRblaoRbbgAco4gCaCciSgCE86bbawcj;cbfaifglcGfaoclfaCfgCRbbaAcl4ciGgXaXciSgXE86bbalcVfaCaXfgCRbbaAcd4ciGgXaXciSgXE86bbalc7faCaXfgCRbbaAciGgAaAciSgAE86bbalctfaCaAfgCRbbaoRbegAco4gXaXciSgXE86bbalc91faCaXfgCRbbaAcl4ciGgXaXciSgXE86bbalc4faCaXfgCRbbaAcd4ciGgXaXciSgXE86bbalc93faCaXfgCRbbaAciGgAaAciSgAE86bbalc94faCaAfgCRbbaoRbdgAco4gXaXciSgXE86bbalc95faCaXfgCRbbaAcl4ciGgXaXciSgXE86bbalc96faCaXfgCRbbaAcd4ciGgXaXciSgXE86bbalc97faCaXfgCRbbaAciGgAaAciSgAE86bbalc98faCaAfgARbbaoRbigoco4gCaCciSgCE86bbalc99faAaCfgARbbaocl4ciGgCaCciSgCE86bbalc9:faAaCfgARbbaocd4ciGgCaCciSgCE86bbalcufaAaCfglRbbaociGgoaociSgoE86bbalaofhoxdkalaoRbwaoRbbgAcl4gCaCcsSgCE86bbawcj;cbfaifglcGfaocwfaCfgCRbbaAcsGgAaAcsSgAE86bbalcVfaCaAfgARbbaoRbegCcl4gXaXcsSgXE86bbalc7faAaXfgARbbaCcsGgCaCcsSgCE86bbalctfaAaCfgARbbaoRbdgCcl4gXaXcsSgXE86bbalc91faAaXfgARbbaCcsGgCaCcsSgCE86bbalc4faAaCfgARbbaoRbigCcl4gXaXcsSgXE86bbalc93faAaXfgARbbaCcsGgCaCcsSgCE86bbalc94faAaCfgARbbaoRblgCcl4gXaXcsSgXE86bbalc95faAaXfgARbbaCcsGgCaCcsSgCE86bbalc96faAaCfgARbbaoRbvgCcl4gXaXcsSgXE86bbalc97faAaXfgARbbaCcsGgCaCcsSgCE86bbalc98faAaCfgARbbaoRbogCcl4gXaXcsSgXE86bbalc99faAaXfgARbbaCcsGgCaCcsSgCE86bbalc9:faAaCfgARbbaoRbrgocl4gCaCcsSgCE86bbalcufaAaCfglRbbaocsGgoaocsSgoE86bbalaofhoxekalao8Pbb83bbalcwfaocwf8Pbb83bbaoczfhokdnaiam9pmbaOcdfhOaiczfhlarao9RcL0mekkaiam6miaoTmidnakTmbawaPfRbbhOawcj;cbfhlazhiakhAinaialRbbgHce4cbaHceG9R7aOfgO86bbaiadfhialcefhlaAcufgAmbkkazcefhzaPcefgPad6hsaohHaPad9hmexvkkcbhoasceGmdxikaoaxad2fhXdnakTmbcbhmcehsawcjdfhCinarao9Rax6miaoTmdaoaxfhoawamfRbbhOawcj;cbfhlaChiakhAinaialRbbgHce4cbaHceG9R7aOfgO86bbaiadfhialcefhlaAcufgAmbkaCcefhCamcefgmad6hsamad9hmbkaXhoxikcbhlcehsinarao9Rax6mdaoTmeaoaxfhoalcefglad6hsadal9hmbkaXhoxdkcbhoasceGTmekc9:hoxikabaqad2fawcjdfakad2z1jjjb8Aawawcjdfakcufad2fadz1jjjb8Aakaqfhqaombkc9:hoxekcbc99arao9Radcaadca0ESEhokavcj;ebf8Kjjjjbaok;xzeHu8Jjjjjbc;ae9Rgv8Kjjjjbc9:hodnaeci9UgrcHfal0mbcuhoaiRbbgwc;WeGc;Ge9hmbawcsGgDce0mbavc;abfcFecjez:jjjjb8AavcUf9cu83ibavc8Wf9cu83ibavcyf9cu83ibavcaf9cu83ibavcKf9cu83ibavczf9cu83ibav9cu83iwav9cu83ibaialfc9WfhqaicefgwarfhodnaeTmbcmcsaDceSEhkcbhxcbhmcbhrcbhicbhlindnaoaq9nmbc9:hoxikdndnawRbbgDc;Ve0mbavc;abfalaDcu7gPcl4fcsGcitfgsydlhzasydbhHdnaDcsGgDak9pmbavaiaPfcsGcdtfydbaxaDEhsaDThDdndnadcd9hmbabarcetfgPaH87ebaPcdfaz87ebaPclfas87ebxekabarcdtfgPaHBdbaPclfazBdbaPcwfasBdbkaxaDfhxavc;abfalcitfgPasBdbaPazBdlavaicdtfasBdbavc;abfalcefcsGglcitfgPaHBdbaPasBdlaiaDfhialcefhlxdkdndnaDcsSmbamaDfaDc987fcefhmxekaocefhDao8SbbgscFeGhPdndnascu9mmbaDhoxekaocvfhoaPcFbGhPcrhsdninaD8SbbgOcFbGastaPVhPaOcu9kmeaDcefhDascrfgsc8J9hmbxdkkaDcefhokaPce4cbaPceG9R7amfhmkdndnadcd9hmbabarcetfgDaH87ebaDcdfaz87ebaDclfam87ebxekabarcdtfgDaHBdbaDclfazBdbaDcwfamBdbkavc;abfalcitfgDamBdbaDazBdlavaicdtfamBdbavc;abfalcefcsGglcitfgDaHBdbaDamBdlaicefhialcefhlxekdnaDcpe0mbaxcefgOavaiaqaDcsGfRbbgscl49RcsGcdtfydbascz6gPEhDavaias9RcsGcdtfydbaOaPfgzascsGgOEhsaOThOdndnadcd9hmbabarcetfgHax87ebaHcdfaD87ebaHclfas87ebxekabarcdtfgHaxBdbaHclfaDBdbaHcwfasBdbkavaicdtfaxBdbavc;abfalcitfgHaDBdbaHaxBdlavaicefgicsGcdtfaDBdbavc;abfalcefcsGcitfgHasBdbaHaDBdlavaiaPfcsGgicdtfasBdbavc;abfalcdfcsGglcitfgDaxBdbaDasBdlalcefhlaiaOfhiazaOfhxxekaxcbaoRbbgHEgAaDc;:eSgDfhzaHcsGhCaHcl4hXdndnaHcs0mbazcefhOxekazhOavaiaX9RcsGcdtfydbhzkdndnaCmbaOcefhxxekaOhxavaiaH9RcsGcdtfydbhOkdndnaDTmbaocefhDxekaocdfhDao8SbegPcFeGhsdnaPcu9kmbaocofhAascFbGhscrhodninaD8SbbgPcFbGaotasVhsaPcu9kmeaDcefhDaocrfgoc8J9hmbkaAhDxekaDcefhDkasce4cbasceG9R7amfgmhAkdndnaXcsSmbaDhsxekaDcefhsaD8SbbgocFeGhPdnaocu9kmbaDcvfhzaPcFbGhPcrhodninas8SbbgDcFbGaotaPVhPaDcu9kmeascefhsaocrfgoc8J9hmbkazhsxekascefhskaPce4cbaPceG9R7amfgmhzkdndnaCcsSmbashoxekascefhoas8SbbgDcFeGhPdnaDcu9kmbascvfhOaPcFbGhPcrhDdninao8SbbgscFbGaDtaPVhPascu9kmeaocefhoaDcrfgDc8J9hmbkaOhoxekaocefhokaPce4cbaPceG9R7amfgmhOkdndnadcd9hmbabarcetfgDaA87ebaDcdfaz87ebaDclfaO87ebxekabarcdtfgDaABdbaDclfazBdbaDcwfaOBdbkavc;abfalcitfgDazBdbaDaABdlavaicdtfaABdbavc;abfalcefcsGcitfgDaOBdbaDazBdlavaicefgicsGcdtfazBdbavc;abfalcdfcsGcitfgDaABdbaDaOBdlavaiaHcz6aXcsSVfgicsGcdtfaOBdbaiaCTaCcsSVfhialcifhlkawcefhwalcsGhlaicsGhiarcifgrae6mbkkcbc99aoaqSEhokavc;aef8Kjjjjbaok:flevu8Jjjjjbcz9Rhvc9:hodnaecvfal0mbcuhoaiRbbc;:eGc;qe9hmbav9cb83iwaicefhraialfc98fhwdnaeTmbdnadcdSmbcbhDindnaraw6mbc9:skarcefhoar8SbbglcFeGhidndnalcu9mmbaohrxekarcvfhraicFbGhicrhldninao8SbbgdcFbGaltaiVhiadcu9kmeaocefhoalcrfglc8J9hmbxdkkaocefhrkabaDcdtfaic8Etc8F91aicd47avcwfaiceGcdtVgoydbfglBdbaoalBdbaDcefgDae9hmbxdkkcbhDindnaraw6mbc9:skarcefhoar8SbbglcFeGhidndnalcu9mmbaohrxekarcvfhraicFbGhicrhldninao8SbbgdcFbGaltaiVhiadcu9kmeaocefhoalcrfglc8J9hmbxdkkaocefhrkabaDcetfaic8Etc8F91aicd47avcwfaiceGcdtVgoydbfgl87ebaoalBdbaDcefgDae9hmbkkcbc99arawSEhokaok:Lvoeue99dud99eud99dndnadcl9hmbaeTmeindndnabcdfgd8Sbb:Yab8Sbbgi:Ygl:l:tabcefgv8Sbbgo:Ygr:l:tgwJbb;:9cawawNJbbbbawawJbbbb9GgDEgq:mgkaqaicb9iEalMgwawNakaqaocb9iEarMgqaqNMM:r:vglNJbbbZJbbb:;aDEMgr:lJbbb9p9DTmbar:Ohixekcjjjj94hikadai86bbdndnaqalNJbbbZJbbb:;aqJbbbb9GEMgq:lJbbb9p9DTmbaq:Ohdxekcjjjj94hdkavad86bbdndnawalNJbbbZJbbb:;awJbbbb9GEMgw:lJbbb9p9DTmbaw:Ohdxekcjjjj94hdkabad86bbabclfhbaecufgembxdkkaeTmbindndnabclfgd8Ueb:Yab8Uebgi:Ygl:l:tabcdfgv8Uebgo:Ygr:l:tgwJb;:FSawawNJbbbbawawJbbbb9GgDEgq:mgkaqaicb9iEalMgwawNakaqaocb9iEarMgqaqNMM:r:vglNJbbbZJbbb:;aDEMgr:lJbbb9p9DTmbar:Ohixekcjjjj94hikadai87ebdndnaqalNJbbbZJbbb:;aqJbbbb9GEMgq:lJbbb9p9DTmbaq:Ohdxekcjjjj94hdkavad87ebdndnawalNJbbbZJbbb:;awJbbbb9GEMgw:lJbbb9p9DTmbaw:Ohdxekcjjjj94hdkabad87ebabcwfhbaecufgembkkk;siliui99iue99dnaeTmbcbhiabhlindndnJ;Zl81Zalcof8UebgvciV:Y:vgoal8Ueb:YNgrJb;:FSNJbbbZJbbb:;arJbbbb9GEMgw:lJbbb9p9DTmbaw:OhDxekcjjjj94hDkalclf8Uebhqalcdf8UebhkabaiavcefciGfcetfaD87ebdndnaoak:YNgwJb;:FSNJbbbZJbbb:;awJbbbb9GEMgx:lJbbb9p9DTmbax:Ohkxekcjjjj94hkkabaiavcdfciGfcetfak87ebdndnaoaq:YNgoJb;:FSNJbbbZJbbb:;aoJbbbb9GEMgx:lJbbb9p9DTmbax:Ohqxekcjjjj94hqkabaiavcufciGfcetfaq87ebdndnJbbjZararN:tawawN:taoaoN:tgrJbbbbarJbbbb9GE:rJb;:FSNJbbbZMgr:lJbbb9p9DTmbar:Ohqxekcjjjj94hqkabaiavciGfcetfaq87ebalcwfhlaiclfhiaecufgembkkk9mbdnadcd4ae2gdTmbinababydbgecwtcw91:Yaece91cjjj98Gcjjj;8if::NUdbabclfhbadcufgdmbkkk9teiucbcbydj1jjbgeabcifc98GfgbBdj1jjbdndnabZbcztgd9nmbcuhiabad9RcFFifcz4nbcuSmekaehikaik;LeeeudndnaeabVciGTmbabhixekdndnadcz9pmbabhixekabhiinaiaeydbBdbaiclfaeclfydbBdbaicwfaecwfydbBdbaicxfaecxfydbBdbaeczfheaiczfhiadc9Wfgdcs0mbkkadcl6mbinaiaeydbBdbaeclfheaiclfhiadc98fgdci0mbkkdnadTmbinaiaeRbb86bbaicefhiaecefheadcufgdmbkkabk;aeedudndnabciGTmbabhixekaecFeGc:b:c:ew2hldndnadcz9pmbabhixekabhiinaialBdbaicxfalBdbaicwfalBdbaiclfalBdbaiczfhiadc9Wfgdcs0mbkkadcl6mbinaialBdbaiclfhiadc98fgdci0mbkkdnadTmbinaiae86bbaicefhiadcufgdmbkkabkkkebcjwklz9Kbb",e="b9H79TebbbeKl9Gbb9Gvuuuuueu9Giuuub9Geueuikqbbebeedddilve9Weeeviebeoweuec:q;Aekr;leDo9TW9T9VV95dbH9F9F939H79T9F9J9H229F9Jt9VV7bb8A9TW79O9V9Wt9F9KW9J9V9KW9wWVtW949c919M9MWVbdY9TW79O9V9Wt9F9KW9J9V9KW69U9KW949c919M9MWVblE9TW79O9V9Wt9F9KW9J9V9KW69U9KW949tWG91W9U9JWbvL9TW79O9V9Wt9F9KW9J9V9KWS9P2tWV9p9JtboK9TW79O9V9Wt9F9KW9J9V9KWS9P2tWV9r919HtbrL9TW79O9V9Wt9F9KW9J9V9KWS9P2tWVT949Wbwl79IV9RbDq;b9tqlbzik9:evu8Jjjjjbcz9Rhbcbheincbhdcbhiinabcwfadfaicjuaead4ceGglE86bbaialfhiadcefgdcw9hmbkaec:q:yjjbfai86bbaecitc:q1jjbfab8Piw83ibaecefgecjd9hmbkk;e8JlHud97euo978Jjjjjbcj;kb9Rgv8Kjjjjbc9:hodnadcefal0mbcuhoaiRbbc:Ge9hmbavaialfgrad9Rad;8qbbcj;abad9UhoaicefhldnadTmbaoc;WFbGgocjdaocjd6EhwcbhDinaDae9pmeawaeaD9RaDawfae6Egqcsfgoc9WGgkci2hxakcethmaocl4cifcd4hPabaDad2fhscbhzdnincbhHalhOcbhAdninaraO9RaP6miavcj;cbfaAak2fhCaOaPfhlcbhidnakc;ab6mbaral9Rc;Gb6mbcbhoinaCaofhidndndndndnaOaoco4fRbbgXciGPlbedibkaipxbbbbbbbbbbbbbbbbpklbxikaialpbblalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLgQcdp:meaQpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9ogLpxiiiiiiiiiiiiiiiip8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklbalclfaYpQbfaKc:q:yjjbfRbbfhlxdkaialpbbwalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9ogLpxssssssssssssssssp8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklbalcwfaYpQbfaKc:q:yjjbfRbbfhlxekaialpbbbpklbalczfhlkdndndndndnaXcd4ciGPlbedibkaipxbbbbbbbbbbbbbbbbpklzxikaialpbblalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLgQcdp:meaQpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9ogLpxiiiiiiiiiiiiiiiip8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklzalclfaYpQbfaKc:q:yjjbfRbbfhlxdkaialpbbwalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9ogLpxssssssssssssssssp8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklzalcwfaYpQbfaKc:q:yjjbfRbbfhlxekaialpbbbpklzalczfhlkdndndndndnaXcl4ciGPlbedibkaipxbbbbbbbbbbbbbbbbpklaxikaialpbblalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLgQcdp:meaQpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9ogLpxiiiiiiiiiiiiiiiip8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklaalclfaYpQbfaKc:q:yjjbfRbbfhlxdkaialpbbwalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9ogLpxssssssssssssssssp8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklaalcwfaYpQbfaKc:q:yjjbfRbbfhlxekaialpbbbpklaalczfhlkdndndndndnaXco4Plbedibkaipxbbbbbbbbbbbbbbbbpkl8WxikaialpbblalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLgQcdp:meaQpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9ogLpxiiiiiiiiiiiiiiiip8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgXcitc:q1jjbfpbibaXc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgXcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spkl8WalclfaYpQbfaXc:q:yjjbfRbbfhlxdkaialpbbwalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9ogLpxssssssssssssssssp8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgXcitc:q1jjbfpbibaXc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgXcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spkl8WalcwfaYpQbfaXc:q:yjjbfRbbfhlxekaialpbbbpkl8Walczfhlkaoc;abfhiaocjefak0meaihoaral9Rc;Fb0mbkkdndnaiak9pmbaici4hoinaral9RcK6mdaCaifhXdndndndndnaOaico4fRbbaocoG4ciGPlbedibkaXpxbbbbbbbbbbbbbbbbpklbxikaXalpbblalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLgQcdp:meaQpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9ogLpxiiiiiiiiiiiiiiiip8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklbalclfaYpQbfaKc:q:yjjbfRbbfhlxdkaXalpbbwalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9ogLpxssssssssssssssssp8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklbalcwfaYpQbfaKc:q:yjjbfRbbfhlxekaXalpbbbpklbalczfhlkaocdfhoaiczfgiak6mbkkalTmbaAcd0hHalhOaAcefgAclSmdxekkcbhlaHceGTmdkdnakTmbavcjdfazfhiavazfpbdbhYcbhXinaiavcj;cbfaXfgopblbgLcep9TaLpxeeeeeeeeeeeeeeeegQp9op9Hp9rgLaoakfpblbg8Acep9Ta8AaQp9op9Hp9rg8ApmbzeHdOiAlCvXoQrLgEaoamfpblbg3cep9Ta3aQp9op9Hp9rg3aoaxfpblbg5cep9Ta5aQp9op9Hp9rg5pmbzeHdOiAlCvXoQrLg8EpmbezHdiOAlvCXorQLgQaQpmbedibedibedibediaYp9UgYp9AdbbaiadfgoaYaQaQpmlvorlvorlvorlvorp9UgYp9AdbbaoadfgoaYaQaQpmwDqkwDqkwDqkwDqkp9UgYp9AdbbaoadfgoaYaQaQpmxmPsxmPsxmPsxmPsp9UgYp9AdbbaoadfgoaYaEa8EpmwDKYqk8AExm35Ps8E8FgQaQpmbedibedibedibedip9UgYp9AdbbaoadfgoaYaQaQpmlvorlvorlvorlvorp9UgYp9AdbbaoadfgoaYaQaQpmwDqkwDqkwDqkwDqkp9UgYp9AdbbaoadfgoaYaQaQpmxmPsxmPsxmPsxmPsp9UgYp9AdbbaoadfgoaYaLa8ApmwKDYq8AkEx3m5P8Es8FgLa3a5pmwKDYq8AkEx3m5P8Es8Fg8ApmbezHdiOAlvCXorQLgQaQpmbedibedibedibedip9UgYp9AdbbaoadfgoaYaQaQpmlvorlvorlvorlvorp9UgYp9AdbbaoadfgoaYaQaQpmwDqkwDqkwDqkwDqkp9UgYp9AdbbaoadfgoaYaQaQpmxmPsxmPsxmPsxmPsp9UgYp9AdbbaoadfgoaYaLa8ApmwDKYqk8AExm35Ps8E8FgQaQpmbedibedibedibedip9UgYp9AdbbaoadfgoaYaQaQpmlvorlvorlvorlvorp9UgYp9AdbbaoadfgoaYaQaQpmwDqkwDqkwDqkwDqkp9UgYp9AdbbaoadfgoaYaQaQpmxmPsxmPsxmPsxmPsp9UgYp9AdbbaoadfhiaXczfgXak6mbkkazclfgzad6mbkasavcjdfaqad2;8qbbavavcjdfaqcufad2fad;8qbbaqaDfhDc9:hoalmexikkc9:hoxekcbc99aral9Radcaadca0ESEhokavcj;kbf8Kjjjjbaokwbz:bjjjbk;tzeHu8Jjjjjbc;ae9Rgv8Kjjjjbc9:hodnaeci9UgrcHfal0mbcuhoaiRbbgwc;WeGc;Ge9hmbawcsGgDce0mbavc;abfcFecje;8kbavcUf9cu83ibavc8Wf9cu83ibavcyf9cu83ibavcaf9cu83ibavcKf9cu83ibavczf9cu83ibav9cu83iwav9cu83ibaialfc9WfhqaicefgwarfhodnaeTmbcmcsaDceSEhkcbhxcbhmcbhrcbhicbhlindnaoaq9nmbc9:hoxikdndnawRbbgDc;Ve0mbavc;abfalaDcu7gPcl4fcsGcitfgsydlhzasydbhHdnaDcsGgDak9pmbavaiaPfcsGcdtfydbaxaDEhsaDThDdndnadcd9hmbabarcetfgPaH87ebaPcdfaz87ebaPclfas87ebxekabarcdtfgPaHBdbaPclfazBdbaPcwfasBdbkaxaDfhxavc;abfalcitfgPasBdbaPazBdlavaicdtfasBdbavc;abfalcefcsGglcitfgPaHBdbaPasBdlaiaDfhialcefhlxdkdndnaDcsSmbamaDfaDc987fcefhmxekaocefhDao8SbbgscFeGhPdndnascu9mmbaDhoxekaocvfhoaPcFbGhPcrhsdninaD8SbbgOcFbGastaPVhPaOcu9kmeaDcefhDascrfgsc8J9hmbxdkkaDcefhokaPce4cbaPceG9R7amfhmkdndnadcd9hmbabarcetfgDaH87ebaDcdfaz87ebaDclfam87ebxekabarcdtfgDaHBdbaDclfazBdbaDcwfamBdbkavc;abfalcitfgDamBdbaDazBdlavaicdtfamBdbavc;abfalcefcsGglcitfgDaHBdbaDamBdlaicefhialcefhlxekdnaDcpe0mbaxcefgOavaiaqaDcsGfRbbgscl49RcsGcdtfydbascz6gPEhDavaias9RcsGcdtfydbaOaPfgzascsGgOEhsaOThOdndnadcd9hmbabarcetfgHax87ebaHcdfaD87ebaHclfas87ebxekabarcdtfgHaxBdbaHclfaDBdbaHcwfasBdbkavaicdtfaxBdbavc;abfalcitfgHaDBdbaHaxBdlavaicefgicsGcdtfaDBdbavc;abfalcefcsGcitfgHasBdbaHaDBdlavaiaPfcsGgicdtfasBdbavc;abfalcdfcsGglcitfgDaxBdbaDasBdlalcefhlaiaOfhiazaOfhxxekaxcbaoRbbgHEgAaDc;:eSgDfhzaHcsGhCaHcl4hXdndnaHcs0mbazcefhOxekazhOavaiaX9RcsGcdtfydbhzkdndnaCmbaOcefhxxekaOhxavaiaH9RcsGcdtfydbhOkdndnaDTmbaocefhDxekaocdfhDao8SbegPcFeGhsdnaPcu9kmbaocofhAascFbGhscrhodninaD8SbbgPcFbGaotasVhsaPcu9kmeaDcefhDaocrfgoc8J9hmbkaAhDxekaDcefhDkasce4cbasceG9R7amfgmhAkdndnaXcsSmbaDhsxekaDcefhsaD8SbbgocFeGhPdnaocu9kmbaDcvfhzaPcFbGhPcrhodninas8SbbgDcFbGaotaPVhPaDcu9kmeascefhsaocrfgoc8J9hmbkazhsxekascefhskaPce4cbaPceG9R7amfgmhzkdndnaCcsSmbashoxekascefhoas8SbbgDcFeGhPdnaDcu9kmbascvfhOaPcFbGhPcrhDdninao8SbbgscFbGaDtaPVhPascu9kmeaocefhoaDcrfgDc8J9hmbkaOhoxekaocefhokaPce4cbaPceG9R7amfgmhOkdndnadcd9hmbabarcetfgDaA87ebaDcdfaz87ebaDclfaO87ebxekabarcdtfgDaABdbaDclfazBdbaDcwfaOBdbkavc;abfalcitfgDazBdbaDaABdlavaicdtfaABdbavc;abfalcefcsGcitfgDaOBdbaDazBdlavaicefgicsGcdtfazBdbavc;abfalcdfcsGcitfgDaABdbaDaOBdlavaiaHcz6aXcsSVfgicsGcdtfaOBdbaiaCTaCcsSVfhialcifhlkawcefhwalcsGhlaicsGhiarcifgrae6mbkkcbc99aoaqSEhokavc;aef8Kjjjjbaok:flevu8Jjjjjbcz9Rhvc9:hodnaecvfal0mbcuhoaiRbbc;:eGc;qe9hmbav9cb83iwaicefhraialfc98fhwdnaeTmbdnadcdSmbcbhDindnaraw6mbc9:skarcefhoar8SbbglcFeGhidndnalcu9mmbaohrxekarcvfhraicFbGhicrhldninao8SbbgdcFbGaltaiVhiadcu9kmeaocefhoalcrfglc8J9hmbxdkkaocefhrkabaDcdtfaic8Etc8F91aicd47avcwfaiceGcdtVgoydbfglBdbaoalBdbaDcefgDae9hmbxdkkcbhDindnaraw6mbc9:skarcefhoar8SbbglcFeGhidndnalcu9mmbaohrxekarcvfhraicFbGhicrhldninao8SbbgdcFbGaltaiVhiadcu9kmeaocefhoalcrfglc8J9hmbxdkkaocefhrkabaDcetfaic8Etc8F91aicd47avcwfaiceGcdtVgoydbfgl87ebaoalBdbaDcefgDae9hmbkkcbc99arawSEhokaok:wPliuo97eue978Jjjjjbca9Rhiaec98Ghldndnadcl9hmbdnalTmbcbhvabhdinadadpbbbgocKp:RecKp:Sep;6egraocwp:RecKp:Sep;6earp;Geaoczp:RecKp:Sep;6egwp;Gep;Kep;LegDpxbbbbbbbbbbbbbbbbp:2egqarpxbbbjbbbjbbbjbbbjgkp9op9rp;Kegrpxbb;:9cbb;:9cbb;:9cbb;:9cararp;MeaDaDp;Meawaqawakp9op9rp;Kegrarp;Mep;Kep;Kep;Jep;Negwp;Mepxbbn0bbn0bbn0bbn0gqp;KepxFbbbFbbbFbbbFbbbp9oaopxbbbFbbbFbbbFbbbFp9op9qarawp;Meaqp;Kecwp:RepxbFbbbFbbbFbbbFbbp9op9qaDawp;Meaqp;Keczp:RepxbbFbbbFbbbFbbbFbp9op9qpkbbadczfhdavclfgval6mbkkalae9pmeaipxbbbbbbbbbbbbbbbbgqpklbaiabalcdtfgdaeciGglcdtgv;8qbbdnalTmbaiaipblbgocKp:RecKp:Sep;6egraocwp:RecKp:Sep;6earp;Geaoczp:RecKp:Sep;6egwp;Gep;Kep;LegDaqp:2egqarpxbbbjbbbjbbbjbbbjgkp9op9rp;Kegrpxbb;:9cbb;:9cbb;:9cbb;:9cararp;MeaDaDp;Meawaqawakp9op9rp;Kegrarp;Mep;Kep;Kep;Jep;Negwp;Mepxbbn0bbn0bbn0bbn0gqp;KepxFbbbFbbbFbbbFbbbp9oaopxbbbFbbbFbbbFbbbFp9op9qarawp;Meaqp;Kecwp:RepxbFbbbFbbbFbbbFbbp9op9qaDawp;Meaqp;Keczp:RepxbbFbbbFbbbFbbbFbp9op9qpklbkadaiav;8qbbskdnalTmbcbhvabhdinadczfgxaxpbbbgopxbbbbbbFFbbbbbbFFgkp9oadpbbbgDaopmlvorxmPsCXQL358E8FpxFubbFubbFubbFubbp9op;6eaDaopmbediwDqkzHOAKY8AEgoczp:Sep;6egrp;Geaoczp:Reczp:Sep;6egwp;Gep;Kep;Legopxb;:FSb;:FSb;:FSb;:FSawaopxbbbbbbbbbbbbbbbbp:2egqawpxbbbjbbbjbbbjbbbjgmp9op9rp;Kegwawp;Meaoaop;Mearaqaramp9op9rp;Kegoaop;Mep;Kep;Kep;Jep;Negrp;Mepxbbn0bbn0bbn0bbn0gqp;Keczp:Reawarp;Meaqp;KepxFFbbFFbbFFbbFFbbp9op9qgwaoarp;Meaqp;KepxFFbbFFbbFFbbFFbbp9ogopmwDKYqk8AExm35Ps8E8Fp9qpkbbadaDakp9oawaopmbezHdiOAlvCXorQLp9qpkbbadcafhdavclfgval6mbkkalae9pmbaiaeciGgvcitgdfcbcaad9R;8kbaiabalcitfglad;8qbbdnavTmbaiaipblzgopxbbbbbbFFbbbbbbFFgkp9oaipblbgDaopmlvorxmPsCXQL358E8FpxFubbFubbFubbFubbp9op;6eaDaopmbediwDqkzHOAKY8AEgoczp:Sep;6egrp;Geaoczp:Reczp:Sep;6egwp;Gep;Kep;Legopxb;:FSb;:FSb;:FSb;:FSawaopxbbbbbbbbbbbbbbbbp:2egqawpxbbbjbbbjbbbjbbbjgmp9op9rp;Kegwawp;Meaoaop;Mearaqaramp9op9rp;Kegoaop;Mep;Kep;Kep;Jep;Negrp;Mepxbbn0bbn0bbn0bbn0gqp;Keczp:Reawarp;Meaqp;KepxFFbbFFbbFFbbFFbbp9op9qgwaoarp;Meaqp;KepxFFbbFFbbFFbbFFbbp9ogopmwDKYqk8AExm35Ps8E8Fp9qpklzaiaDakp9oawaopmbezHdiOAlvCXorQLp9qpklbkalaiad;8qbbkk;4wllue97euv978Jjjjjbc8W9Rhidnaec98GglTmbcbhvabhoinaiaopbbbgraoczfgwpbbbgDpmlvorxmPsCXQL358E8Fgqczp:Segkclp:RepklbaopxbbjZbbjZbbjZbbjZpx;Zl81Z;Zl81Z;Zl81Z;Zl81Zakpxibbbibbbibbbibbbp9qp;6ep;NegkaraDpmbediwDqkzHOAKY8AEgrczp:Reczp:Sep;6ep;MegDaDp;Meakarczp:Sep;6ep;Megxaxp;Meakaqczp:Reczp:Sep;6ep;Megqaqp;Mep;Kep;Kep;Lepxbbbbbbbbbbbbbbbbp:4ep;Jepxb;:FSb;:FSb;:FSb;:FSgkp;Mepxbbn0bbn0bbn0bbn0grp;KepxFFbbFFbbFFbbFFbbgmp9oaxakp;Mearp;Keczp:Rep9qgxaqakp;Mearp;Keczp:ReaDakp;Mearp;Keamp9op9qgkpmbezHdiOAlvCXorQLgrp5baipblbpEb:T:j83ibaocwfarp5eaipblbpEe:T:j83ibawaxakpmwDKYqk8AExm35Ps8E8Fgkp5baipblbpEd:T:j83ibaocKfakp5eaipblbpEi:T:j83ibaocafhoavclfgval6mbkkdnalae9pmbaiaeciGgvcitgofcbcaao9R;8kbaiabalcitfgwao;8qbbdnavTmbaiaipblbgraipblzgDpmlvorxmPsCXQL358E8Fgqczp:Segkclp:RepklaaipxbbjZbbjZbbjZbbjZpx;Zl81Z;Zl81Z;Zl81Z;Zl81Zakpxibbbibbbibbbibbbp9qp;6ep;NegkaraDpmbediwDqkzHOAKY8AEgrczp:Reczp:Sep;6ep;MegDaDp;Meakarczp:Sep;6ep;Megxaxp;Meakaqczp:Reczp:Sep;6ep;Megqaqp;Mep;Kep;Kep;Lepxbbbbbbbbbbbbbbbbp:4ep;Jepxb;:FSb;:FSb;:FSb;:FSgkp;Mepxbbn0bbn0bbn0bbn0grp;KepxFFbbFFbbFFbbFFbbgmp9oaxakp;Mearp;Keczp:Rep9qgxaqakp;Mearp;Keczp:ReaDakp;Mearp;Keamp9op9qgkpmbezHdiOAlvCXorQLgrp5baipblapEb:T:j83ibaiarp5eaipblapEe:T:j83iwaiaxakpmwDKYqk8AExm35Ps8E8Fgkp5baipblapEd:T:j83izaiakp5eaipblapEi:T:j83iKkawaiao;8qbbkk:Pddiue978Jjjjjbc;ab9Rhidnadcd4ae2glc98GgvTmbcbheabhdinadadpbbbgocwp:Recwp:Sep;6eaocep:SepxbbjFbbjFbbjFbbjFp9opxbbjZbbjZbbjZbbjZp:Uep;Mepkbbadczfhdaeclfgeav6mbkkdnaval9pmbaialciGgecdtgdVcbc;abad9R;8kbaiabavcdtfgvad;8qbbdnaeTmbaiaipblbgocwp:Recwp:Sep;6eaocep:SepxbbjFbbjFbbjFbbjFp9opxbbjZbbjZbbjZbbjZp:Uep;Mepklbkavaiad;8qbbkk9teiucbcbydj1jjbgeabcifc98GfgbBdj1jjbdndnabZbcztgd9nmbcuhiabad9RcFFifcz4nbcuSmekaehikaikkkebcjwklz9Tbb",t=new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]),i=new Uint8Array([32,0,65,2,1,106,34,33,3,128,11,4,13,64,6,253,10,7,15,116,127,5,8,12,40,16,19,54,20,9,27,255,113,17,42,67,24,23,146,148,18,14,22,45,70,69,56,114,101,21,25,63,75,136,108,28,118,29,73,115]);if(typeof WebAssembly!="object")return{supported:!1};var n=WebAssembly.validate(t)?e:s,o,a=WebAssembly.instantiate(l(n),{}).then(function(E){o=E.instance,o.exports.__wasm_call_ctors()});function l(E){for(var w=new Uint8Array(E.length),C=0;C<E.length;++C){var I=E.charCodeAt(C);w[C]=I>96?I-97:I>64?I-39:I+4}for(var O=0,C=0;C<E.length;++C)w[O++]=w[C]<60?i[w[C]]:(w[C]-60)*64+w[++C];return w.buffer.slice(0,O)}function c(E,w,C,I,O,U,z){var ie=E.exports.sbrk,J=I+3&-4,re=ie(J*O),Oe=ie(U.length),We=new Uint8Array(E.exports.memory.buffer);We.set(U,Oe);var Ve=w(re,I,O,Oe,U.length);if(Ve==0&&z&&z(re,J,O),C.set(We.subarray(re,re+I*O)),ie(re-ie(0)),Ve!=0)throw new Error("Malformed buffer data: "+Ve)}var h={NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},d={ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"},u=[],m=0;function g(E){var w={object:new Worker(E),pending:0,requests:{}};return w.object.onmessage=function(C){var I=C.data;w.pending-=I.count,w.requests[I.id][I.action](I.value),delete w.requests[I.id]},w}function b(E){for(var w="self.ready = WebAssembly.instantiate(new Uint8Array(["+new Uint8Array(l(n))+"]), {}).then(function(result) { result.instance.exports.__wasm_call_ctors(); return result.instance; });self.onmessage = "+v.name+";"+c.toString()+v.toString(),C=new Blob([w],{type:"text/javascript"}),I=URL.createObjectURL(C),O=u.length;O<E;++O)u[O]=g(I);for(var O=E;O<u.length;++O)u[O].object.postMessage({});u.length=E,URL.revokeObjectURL(I)}function x(E,w,C,I,O){for(var U=u[0],z=1;z<u.length;++z)u[z].pending<U.pending&&(U=u[z]);return new Promise(function(ie,J){var re=new Uint8Array(C),Oe=++m;U.pending+=E,U.requests[Oe]={resolve:ie,reject:J},U.object.postMessage({id:Oe,count:E,size:w,source:re,mode:I,filter:O},[re.buffer])})}function v(E){var w=E.data;if(!w.id)return self.close();self.ready.then(function(C){try{var I=new Uint8Array(w.count*w.size);c(C,C.exports[w.mode],I,w.count,w.size,w.source,C.exports[w.filter]),self.postMessage({id:w.id,count:w.count,action:"resolve",value:I},[I.buffer])}catch(O){self.postMessage({id:w.id,count:w.count,action:"reject",value:O})}})}return{ready:a,supported:!0,useWorkers:function(E){b(E)},decodeVertexBuffer:function(E,w,C,I,O){c(o,o.exports.meshopt_decodeVertexBuffer,E,w,C,I,o.exports[h[O]])},decodeIndexBuffer:function(E,w,C,I){c(o,o.exports.meshopt_decodeIndexBuffer,E,w,C,I)},decodeIndexSequence:function(E,w,C,I){c(o,o.exports.meshopt_decodeIndexSequence,E,w,C,I)},decodeGltfBuffer:function(E,w,C,I,O,U){c(o,o.exports[d[O]],E,w,C,I,o.exports[h[U]])},decodeGltfBufferAsync:function(E,w,C,I,O){return u.length>0?x(E,w,C,d[I],h[O]):a.then(function(){var U=new Uint8Array(E*w);return c(o,o.exports[d[I]],U,E,w,C,o.exports[h[O]]),U})}}}();typeof exports=="object"&&typeof module=="object"?module.exports=ts:typeof define=="function"&&define.amd?define([],function(){return ts}):typeof exports=="object"?exports.MeshoptDecoder=ts:(typeof self!="undefined"?self:globalThis).MeshoptDecoder=ts;function Ss(s,e,t,i,n=0){s.addAttribute(e,new At(t,i,n,!0))}function lu(s){if(s instanceof cl)return lu(s.parent);s instanceof Jo?s.cleanupIndicesAndVertices():s instanceof ll&&(s.cleanupTransforms(),s.parent.cleanupIndicesAndVertices())}class Jo extends on{constructor(){super();r(this,"isInstanced",!1);r(this,"instanceCount",0);r(this,"index",null);r(this,"indexUint",!0);r(this,"vertices",null);r(this,"normals",null);r(this,"uvs0",null);r(this,"isUvs0Repeating",!1);r(this,"uvs1",null);r(this,"indexCnt",0);r(this,"indexOffset",0);r(this,"vertexCnt",0);r(this,"vertexOffset",0);r(this,"defaultAttributeValues");r(this,"gpuSize",0);r(this,"boundingBox",new ti);r(this,"boundingSphere",new Fn);this._disableBoundingVolumesCompute=!0}allocateCoreBuffers(t){console.assert(!this.vertices),t&&(this.vertexCnt<=65535+1?(this.indexUint=!1,this.index=new Uint16Array(this.indexCnt),this.gpuSize+=this.indexCnt*2):(this.indexUint=!0,this.index=new Uint32Array(this.indexCnt),this.gpuSize+=this.indexCnt*4)),this.vertices=new Float32Array(this.vertexCnt*3),this.gpuSize+=this.vertexCnt*3*4,this.normals=Qe.ios?new Int16Array(this.vertexCnt*2):new Int8Array(this.vertexCnt*2),this.gpuSize+=this.vertexCnt*2}addCoreAttributes(){Ke(this.vertices),Ke(this.normals),this.index&&Ss(this,"index",this.index,1),Ss(this,"position",this.vertices,3),Ss(this,"sphericalNormal",this.normals,2),this.normals=null}cleanupIndicesAndVertices(){this.index=null,this.vertices=null}allocateUv0(){console.assert(!this.uvs0),this.uvs0=new Float32Array(this.vertexCnt*2),this.gpuSize+=this.vertexCnt*2*4}addUv0Attribute(){Ss(this,"uv0",this.uvs0,2),this.uvs0=null}allocateUv1(){console.assert(!this.uvs1),this.uvs1=new Uint16Array(this.vertexCnt*2),this.gpuSize+=this.vertexCnt*2*2}addUv1Attribute(){Ss(this,"uv1",this.uvs1,2),this.uvs1=null}}class ll extends on{constructor(t,i){super();r(this,"parent");r(this,"ownsGpuBuffers");r(this,"isInstanced",!0);r(this,"instanceCount",0);r(this,"uvs1Mod",null);r(this,"transforms0",null);r(this,"transforms1",null);r(this,"transforms2",null);r(this,"indexOffset",0);r(this,"vertexOffset",0);r(this,"boundingBox",new ti);r(this,"boundingSphere",new Fn);r(this,"_gpuSize",0);this.parent=t,this._disableBoundingVolumesCompute=!0,this.ownsGpuBuffers=i}allocateCoreBuffers(t){console.assert(!this.transforms0&&!this.transforms1&&!this.transforms2),this.parent.vertices||this.parent.allocateCoreBuffers(t);const i=this.instanceCount*4;this.transforms0=new Float32Array(i),this.transforms1=new Float32Array(i),this.transforms2=new Float32Array(i),this._gpuSize+=3*i*4}addCoreAttributes(){Ke(this.transforms0&&this.transforms1&&this.transforms2),this.parent.attributes.position||this.parent.addCoreAttributes();for(const t of this.parent.attributesKeys)this.addAttribute(t,this.parent.attributes[t]);Ss(this,"t0",this.transforms0,4,1),Ss(this,"t1",this.transforms1,4,1),Ss(this,"t2",this.transforms2,4,1)}cleanupTransforms(){this.transforms0=null,this.transforms1=null,this.transforms2=null}allocateUv0(){this.parent.uvs0||this.parent.allocateUv0()}addUv0Attribute(){this.parent.attributes.uv0||this.parent.addUv0Attribute(),this.addAttribute("uv0",this.parent.attributes.uv0)}allocateUv1(){console.assert(!this.uvs1Mod),this.parent.uvs1||this.parent.allocateUv1(),this.uvs1Mod=new Float32Array(this.instanceCount*4),this._gpuSize+=this.instanceCount*4*4}addUv1Attribute(){this.parent.attributes.uv1||this.parent.addUv1Attribute(),this.addAttribute("uv1",this.parent.attributes.uv1),Ss(this,"uv1Mod",this.uvs1Mod,4,1),this.uvs1Mod=null}get index(){return this.parent.index}get vertices(){return this.parent.vertices}get normals(){return this.parent.normals}get uvs0(){return this.parent.uvs0}get uvs1(){return this.parent.uvs1}get indexUint(){return this.parent.indexUint}get vertexCnt(){return this.parent.vertexCnt}set vertexCnt(t){this.parent.vertexCnt=t}get indexCnt(){return this.parent.indexCnt}set indexCnt(t){this.parent.indexCnt=t}get gpuSize(){return this.ownsGpuBuffers?this._gpuSize+this.parent.gpuSize:this._gpuSize}get isUvs0Repeating(){return this.parent.isUvs0Repeating}set isUvs0Repeating(t){this.parent.isUvs0Repeating=t}}class cl{constructor(e,t,i,n=void 0,o=void 0,a=null,l=null){r(this,"id",NaN);r(this,"indexCnt");r(this,"vertexCnt");r(this,"parent");r(this,"vertexOffset");r(this,"indexOffset");r(this,"vertexAttribOffset");r(this,"isInstanced");r(this,"instanceId",0);r(this,"instanceCount",1);r(this,"defaultAttributeValues");r(this,"boundingBox",null);r(this,"boundingSphere",null);this.indexCnt=e,this.vertexCnt=t,this.parent=i,this.vertexOffset=o,this.indexOffset=n,this.isInstanced=i.isInstanced,this.boundingBox=a,this.boundingSphere=l}get indexUint(){return this.parent.indexUint}get isUvs0Repeating(){return this.parent.isUvs0Repeating}get attributes(){return this.parent.attributes}get attributesKeys(){return this.parent.attributesKeys}hasAttribute(e){return this.parent.hasAttribute(e)}setOnDispose(e){this.parent.setOnDispose(e)}}let Rt;function C_(s,e){return Dt(this,null,function*(){return new Promise(t=>{const i=o=>{Rt=o,t()},n=window.document.createElement("script");n.addEventListener("load",function o(){n.removeEventListener("load",o),window.MeshIntersector_module({wasmBinary:e}).then(i)}),n.src=s,window.document.head.appendChild(n)})})}function R_(){return Dt(this,null,function*(){const s=ii("lib/MeshIntersector_module.wasm"),e=ii("lib/MeshIntersector_module.js");return new Promise((t,i)=>{qa(s,!0,a=>{C_(e,a).then(()=>t())},(a,l)=>{i(new Error(`MeshIntersector loading failed err:${a} message:${l}`))})})})}class hl{constructor(){r(this,"meshId",-1);r(this,"mesh");r(this,"distance",1/0);r(this,"numTestedMeshChunks",0);r(this,"numTestedNodes",0)}clear(){this.meshId=-1,this.mesh=void 0,this.distance=1/0,this.numTestedMeshChunks=0,this.numTestedNodes=0}}var go=(s=>(s[s.NONE=0]="NONE",s[s.VISIBLE=1]="VISIBLE",s[s.GROUND=2]="GROUND",s[s.COLLIDER=4]="COLLIDER",s[s.DOUBLE_SIDED=8]="DOUBLE_SIDED",s))(go||{});class I_{constructor(e){r(this,"_scene");r(this,"_dynamicBoxes",new Array);this._scene=e}_visualizeBoxes(e,t,i){const n=e.length/6,o=new F,a=new F,l=new F,c=new Array;for(let h=0;h<n;h++){const d=new Ye(t,i);o.set(e[h*6+0],e[h*6+1],e[h*6+2]),a.set(e[h*6+3],e[h*6+4],e[h*6+5]),l.addVectors(o,a).multiplyScalar(.5),d.scale.subVectors(a,o),d.position.copyFrom(l),c.push(d)}return c}visualizeTree(e){const t=Rt.getNodeBoxes(e),i=Rt.getChunkBoxes(e),n=nt.createBox(1,1,1),o=new Ts(new be(65280)),a=new Ts(new be(16711680));let l=this._visualizeBoxes(t,n,o);l=l.concat(this._visualizeBoxes(i,n,a));for(const c of l)this._scene.add(c);return this._scene.updateMatrixWorld(),l}visualizeDynamicTree(e){for(const t of this._dynamicBoxes)this._scene.remove(t);this._dynamicBoxes=this.visualizeTree(e)}}const ms=class ms{constructor(e,t){r(this,"_staticIdToMesh",new Map);r(this,"_staticMeshToId",new Map);r(this,"_staticGeometryToId",new Map);r(this,"_staticTreeInitialized",!1);r(this,"_dynamicIdToMesh",new Map);r(this,"_dynamicMeshToId",new Map);r(this,"_dynamicGeometryToId",new Map);r(this,"_hasDynamicTransforms",!1);r(this,"_staticTreeId");r(this,"_dynamicTreeId");r(this,"_debug");r(this,"_debugVisualizer");r(this,"_isDisposed",!1);r(this,"_sumTime",0);r(this,"_numSamples",0);r(this,"_dynamicIsect",new hl);r(this,"_tempIsect",new hl);ms._instance&&ms._instance._dispose(),ms._instance=this,this._staticTreeId=Rt.addTree(),this._dynamicTreeId=Rt.addTree(),this._debug=e,t&&(this._debugVisualizer=new I_(t)),Rt.performTests()}_dispose(){this._staticTreeId&&Rt.removeTree(this._staticTreeId),this._dynamicTreeId&&Rt.removeTree(this._dynamicTreeId),this._staticIdToMesh.clear(),this._staticMeshToId.clear(),this._staticGeometryToId.clear(),this._dynamicIdToMesh.clear(),this._dynamicMeshToId.clear(),this._dynamicGeometryToId.clear(),this._staticTreeInitialized=!1,this._hasDynamicTransforms=!1,this._debugVisualizer=void 0,this._tempIsect=new hl,this._dynamicIsect=new hl,this._isDisposed,this._isDisposed=!0,ms._instance=void 0}buildStaticTree(e){var c;if(this._staticTreeInitialized,this._isDisposed)return;const t=performance.now();for(const h of e){const d=this._addMesh(this._staticTreeId,h,this._staticGeometryToId);this._staticIdToMesh.set(d,h),this._staticMeshToId.set(h,d)}const i=performance.now();Rt.computeIntervals(this._staticTreeId);const n=performance.now();Rt.optimizeLocality(this._staticTreeId);const o=performance.now();Rt.computeChunks(this._staticTreeId);const a=performance.now();Rt.rebuildTree(this._staticTreeId),this._staticTreeInitialized=!0;const l=performance.now();if(this._debug){const h=(i-t).toFixed(2),d=(n-i).toFixed(2),u=(o-n).toFixed(2),m=(a-o).toFixed(2),g=(l-a).toFixed(2),b=(l-t).toFixed(2);console.log(`buildStaticTree time: ${b} (init: ${h} intervals: ${d} optimize: ${u} chunkize: ${m} buildTree: ${g})`),Rt.printInfo()}(c=this._debugVisualizer)==null||c.visualizeTree(this._staticTreeId)}_removeUnusedDynamicGeometries(){const e=new Set;this._dynamicIdToMesh.forEach(i=>{e.add(this._meshToBaseGeometry(i))});const t=new Array;this._dynamicGeometryToId.forEach((i,n)=>t.push([n,i])),t.forEach(([i,n])=>{e.has(i)||(Rt.removeGeometry(this._dynamicTreeId,n),this._dynamicGeometryToId.delete(i))})}updateDynamicTree(e,t){var o;if(this._isDisposed)return;const i=performance.now();for(const a of t){const l=this._dynamicMeshToId.get(a);l!==void 0&&(Rt.removeMesh(this._dynamicTreeId,l),this._dynamicMeshToId.delete(a),this._dynamicIdToMesh.delete(l))}for(const a of e){const l=this._addMesh(this._dynamicTreeId,a,this._dynamicGeometryToId);this._dynamicMeshToId.set(a,l),this._dynamicIdToMesh.set(l,a)}this._removeUnusedDynamicGeometries(),Rt.computeIntervals(this._dynamicTreeId),Rt.optimizeLocality(this._dynamicTreeId),Rt.computeChunks(this._dynamicTreeId),Rt.rebuildTree(this._dynamicTreeId),this._hasDynamicTransforms=!1,this._dynamicMeshToId.forEach((a,l)=>{l.matrixWorld&&(this._hasDynamicTransforms=!0)});const n=performance.now();this._debug&&console.log(`updateDynamicTree time: ${(n-i).toFixed(2)}`),(o=this._debugVisualizer)==null||o.visualizeDynamicTree(this._dynamicTreeId)}updateMeshVisibility(e){this._isDisposed||e.forEach(t=>{const i=this._staticMeshToId.get(t),n=this._dynamicMeshToId.get(t);i!==void 0&&Rt.updateMeshFlags(this._staticTreeId,i,this._meshFlags(t)),n!==void 0&&Rt.updateMeshFlags(this._dynamicTreeId,n,this._meshFlags(t))})}_loadMatrixWorld(e){if(!e.matrixWorld)return;const t=ms._tempMatrix,i=e.matrixWorld.elements;for(let n=0;n<3;n++)for(let o=0;o<4;o++)t[n*4+o]=i[o*4+n];return t}_updateDynamicMeshTransforms(){var n;const e=performance.now();let t=!1;this._dynamicMeshToId.forEach((o,a)=>{if(a.matrixWorld){const l=this._loadMatrixWorld(a);Rt.updateMeshTransform(this._dynamicTreeId,o,l)&&(t=!0)}}),t&&Rt.rebuildTree(this._dynamicTreeId);const i=performance.now();this._debug&&console.log(`updateDynamicMeshTransforms time: ${(i-e).toFixed(2)}`),t&&((n=this._debugVisualizer)==null||n.visualizeDynamicTree(this._dynamicTreeId))}_updateDynamicMeshes(){this._hasDynamicTransforms&&this._updateDynamicMeshTransforms(),this.updateMeshVisibility(Array.from(this._dynamicIdToMesh.values()))}_addGeometry(e,t,i){var d,u;let n=i.get(t);if(n!==void 0)return n;const o=t instanceof Jo?t.vertices:(d=t.getAttribute("position"))==null?void 0:d.array,a=t instanceof Jo?t.index:(u=t.getAttribute("index"))==null?void 0:u.array,l=a instanceof Uint16Array?2:a instanceof Uint32Array?4:0;o.length%3,a&&(a.length%3,void 0);const c=o.length/3,h=a?a.length/3:c/3;return n=Rt.addGeometry(e,a,o,h,l),i.set(t,n),n}_meshToBaseGeometry(e){const t=e.geometry;if(t instanceof on)return t;{let i=t.parent;return i instanceof ll&&(i=i.parent),i}}_meshFlags(e){var i;let t=(e.visible?1:0)|4;return e instanceof Bn&&e.node&&(e.node.ground&&(t|=2),e.node.disableCollisions&&(t&=-5)),(i=e.material)!=null&&i.doubleSided&&(t|=8),t}_addMesh(e,t,i){var h,d;const n=t.geometry;let o,a,l;if(n instanceof on){o=this._loadMatrixWorld(t),l=0;const u=n.getAttribute("index"),m=n.getAttribute("position");a=u?u.length/3:m.length/9}else{const u=n.parent;if(u instanceof ll){o=ms._tempMatrix;const m=n.instanceId*4;u.transforms0&&u.transforms1&&u.transforms2,o.set(u.transforms0.slice(m,m+4),0),o.set(u.transforms1.slice(m,m+4),4),o.set(u.transforms2.slice(m,m+4),8)}a=n.indexCnt?n.indexCnt/3:n.vertexCnt/3,l=n.indexCnt?((h=n.indexOffset)!=null?h:0)/3:((d=n.vertexOffset)!=null?d:0)/3}const c=this._addGeometry(e,this._meshToBaseGeometry(t),i);return Rt.addMesh(e,c,l,a,this._meshFlags(t),o)}_intersectTree(e,t,i,n,o){Rt.intersectTree(e,t.origin.x,t.origin.y,t.origin.z,t.direction.x,t.direction.y,t.direction.z,i,n,o)}intersect(e,t=1/0,i=0,n=this._tempIsect){if(this._staticTreeInitialized,this._isDisposed)return n;const o=performance.now();return this._intersectTree(this._staticTreeId,e,t,i,n),this._dynamicMeshToId.size>0&&(this._updateDynamicMeshes(),t=Math.min(t,n.distance),this._intersectTree(this._dynamicTreeId,e,t,i,this._dynamicIsect),this._dynamicIsect.distance<n.distance&&(n.distance=this._dynamicIsect.distance,n.meshId=this._dynamicIsect.meshId,n.mesh=this._dynamicIdToMesh.get(n.meshId)),n.numTestedNodes+=this._dynamicIsect.numTestedNodes,n.numTestedMeshChunks+=this._dynamicIsect.numTestedMeshChunks),n.meshId!=-1&&!n.mesh&&(n.mesh=this._staticIdToMesh.get(n.meshId)),this._debug&&this._logIntersection(performance.now()-o,n),n}customIntersection(e,t,i=1/0,n=0,o=this._tempIsect){const a=performance.now();if(this._isDisposed)return o;const l=Rt.addTree(),c=new Map;return e.forEach(h=>this._addMesh(l,h,c)),Rt.computeIntervals(l),Rt.computeChunks(l),Rt.rebuildTree(l),this._intersectTree(l,t,i,n,o),Rt.removeTree(l),o.meshId!=-1&&!o.mesh&&(o.mesh=e[o.meshId]),this._debug&&this._logIntersection(performance.now()-a,o,"Custom intersection"),o}_logIntersection(e,t,i="Intersection"){this._sumTime+=e,this._numSamples++;const n=this._sumTime/this._numSamples,o=`node-tests:${t.numTestedNodes} mesh-chunk-tests:${t.numTestedMeshChunks}`,a=e.toFixed(2),l=n.toFixed(2),c=t.distance.toFixed(2);console.log(`${i} (${a} ms avg: ${l} ms; ${o}; hit:${c} hit-id:${t.meshId})`)}};r(ms,"_instance"),r(ms,"_tempMatrix",new Float32Array(4*4));let Gc=ms;class vo{constructor(){r(this,"ray",new Ac);r(this,"far",1/0);r(this,"obeyNodeDisableCollisions",!1);r(this,"onlyGroundCollisions",!1);r(this,"ignoreVisibility",!1)}}class ws{constructor(){r(this,"distance",1/0);r(this,"point",new F);r(this,"object",null)}}function cu(s,e,t){const i=new F;return i.copyFrom(s),i.sub(e).normalize(),i.multiplyScalar(t),s.sub(i)}function D_(s,e){const t=s.x-e.x,i=s.y-e.y;return Math.sqrt(t*t+i*i)}const Ns=class Ns{constructor(e,t){r(this,"_scene");r(this,"_distToGroundConfig",new vo);r(this,"_distToObstacleConfig",new vo);r(this,"_intersectionBelowConfig",new vo);r(this,"_distanceToCeilingConfig",new vo);r(this,"_defaultConfig",new vo);r(this,"_rayIntersection",new ws);r(this,"_debugGeometry");r(this,"_debugMaterial");r(this,"_controls");r(this,"_camera");r(this,"_cameraPosition");r(this,"_meshIntersector");this._controls=t,this._camera=e.camera,this._cameraPosition=t.cameraWorldPosition(),this._scene=e;const i=Ns.DEBUG_TREE?this._scene.threeScene:void 0;if(this._meshIntersector=new Gc(Ns.DEBUG,i),Ns.DEBUG_POINTS){this._debugGeometry=nt.createSphere(.01),this._debugGeometry.convertNormalsToSpherical();const n=new gt;n.disableLightProbe=!0,n.lightmapSupported=!1,n.baseColor.setRGB(1,0,0),n.setUniforms(),this._debugMaterial=n}this._distToGroundConfig.ray.direction.set(0,0,-1),this._distToGroundConfig.obeyNodeDisableCollisions=!0,this._distToGroundConfig.onlyGroundCollisions=this._camera.autoClimb,this._distToObstacleConfig.obeyNodeDisableCollisions=!0,this._distToObstacleConfig.onlyGroundCollisions=!1,this._intersectionBelowConfig.ray.direction.set(0,0,-1),this._intersectionBelowConfig.obeyNodeDisableCollisions=!1,this._distanceToCeilingConfig.ray.direction.set(0,0,1),this._distanceToCeilingConfig.obeyNodeDisableCollisions=!0}addStaticObstacles(e){this._meshIntersector,this._meshIntersector.buildStaticTree(e)}addDynamicObstacles(e){this._meshIntersector,this._meshIntersector.updateDynamicTree(e,[])}removeDynamicObstacles(e){this._meshIntersector,this._meshIntersector.updateDynamicTree([],e)}_debugPointAt(e){this._debugGeometry&&this._debugMaterial;const t=new Ye(this._debugGeometry,this._debugMaterial);t.position.copyFrom(e),this._scene.addAuxiliaryObject(t),t.updateMatrixWorld()}closestIntersection(e,t){var o;this._meshIntersector;let i=go.VISIBLE;e.ignoreVisibility&&(i=go.NONE),e.onlyGroundCollisions&&(i|=go.GROUND),e.obeyNodeDisableCollisions&&(i|=go.COLLIDER);const n=this._meshIntersector.intersect(e.ray,e.far,i);return n.mesh?(t.distance=n.distance,t.object=(o=n.mesh)!=null?o:null,t.point=e.ray.at(n.distance),Ns.DEBUG_POINTS&&this._debugPointAt(t.point),!0):!1}distanceToClosestObstacle(e){return this.closestIntersection(e,this._rayIntersection)?this._rayIntersection.distance:1/0}distanceToGroundFrom(e,t){this._distToGroundConfig.ray.origin.copyFrom(e),this._distToGroundConfig.far=t;const i=this.distanceToClosestObstacle(this._distToGroundConfig);return this._camera.autoClimb||i>=1?i:1/0}distanceToObstacle(e){return this._distToObstacleConfig.ray.direction.copyFrom(this._camera.getWorldDirection()),this._distToObstacleConfig.ray.origin.copyFrom(this._cameraPosition),this._distToObstacleConfig.far=e,this.distanceToClosestObstacle(this._distToObstacleConfig)}distanceToGround(e){return this.distanceToGroundFrom(this._cameraPosition,e)}findIntersectionBelow(e,t,i){return this._intersectionBelowConfig.ray.origin.copyFrom(e),this._intersectionBelowConfig.far=t,this.closestIntersection(this._intersectionBelowConfig,i)}distanceToCeilingFrom(e,t){return this._distanceToCeilingConfig.ray.origin.copyFrom(e),this._distanceToCeilingConfig.far=t,this.distanceToClosestObstacle(this._distanceToCeilingConfig)}distanceToCeiling(e){return this.distanceToCeilingFrom(this._cameraPosition,e)}cameraHeightFromPoint(e){const t=this.distanceToGroundFrom(e,M.MAX_GROUND_SEARCH_DEPTH);return t===1/0?null:t}adjustPointToMatchCameraHeight(e){const t=this._camera.fixedHeight||M.CAMERA_FIXED_HEIGHT||this._controls.cameraHeight;if(t===null)return!1;const i=this.distanceToGroundFrom(e,M.MAX_GROUND_SEARCH_DEPTH);if(i===1/0)return!1;const n=t-i;return Math.abs(n)<.01||n>0&&this.distanceToCeilingFrom(e,n+M.MIN_DISTANCE_TO_CEILING)!==1/0?!1:(e.z+=n,!0)}_defaultRaycasterConfig(e,t){const i=this._defaultConfig;if(this._camera.isOrthographic()){const n=this._camera.getCurrent(),o=this._camera.getWorldQuaternion(new wi),a=e*(n.right-n.left)/2,l=t*(n.top-n.bottom)/2,c=new F(a,l,0);o.applyToVector3(c),i.ray.origin=this._cameraPosition.clone().add(c),i.ray.direction.copyFrom(this._camera.getWorldDirection())}else i.ray.origin=this._cameraPosition.clone(),this._camera.getCurrent().unprojectVector(i.ray.direction.set(e,t,1)),i.ray.direction.sub(this._cameraPosition).normalize();return i}findIntersectionAtPosition(e,t,i,n){const o=this._defaultRaycasterConfig(e,t);return o.ignoreVisibility=!1,o.obeyNodeDisableCollisions=i,this.closestIntersection(o,n)}findObstacleMeshAtPosition(e,t,i){return this.findIntersectionAtPosition(e,t,i,this._rayIntersection)?this._rayIntersection.object:null}findMeshFromListAtPosition(e,t,i,n=!1){var c;const o=this._defaultRaycasterConfig(t,i);o.ignoreVisibility=n,this._meshIntersector;const a=n?go.NONE:go.VISIBLE;return(c=this._meshIntersector.customIntersection(e,o.ray,o.far,a).mesh)!=null?c:null}clickedPointToMoveTarget(e){const t=new vo;t.obeyNodeDisableCollisions=!0;const i=t.ray.origin,n=t.ray.direction,o=new ws,a=new F,l=c=>{const h=D_(i,a);if(t.far=h+M.CLICK_MOVE_MIN_DISTANCE_TO_OBSTACLE,n.x=a.x-i.x,n.y=a.y-i.y,!(Math.abs(n.x)<.01&&Math.abs(n.y)<.01))if(n.z=0,n.normalize(),this.closestIntersection(t,o)){let d=o.distance-M.CLICK_MOVE_MIN_DISTANCE_TO_OBSTACLE;d>0&&(c.x=i.x+n.x*d,c.y=i.y+n.y*d,c.z=i.z);const u=.01;if(d=Math.min(o.distance-u,h),i.x+=n.x*d,i.y+=n.y*d,this.adjustPointToMatchCameraHeight(i)){l(c);return}}else c.x=a.x,c.y=a.y,c.z=i.z};i.copyFrom(this._cameraPosition),a.copyFrom(e),e.copyFrom(this._cameraPosition),l(e),this.adjustPointToMatchCameraHeight(e)}movePointTowardsTheCamera(e,t){return cu(e,this._cameraPosition,t)}updateMeshVisibility(e){this._meshIntersector,this._meshIntersector.updateMeshVisibility(e);const t=new Array;for(const i of e)i instanceof nl&&t.push(...i.logicalMeshes);t.length>0&&this._meshIntersector.updateMeshVisibility(t)}handleCollisions(e){const t=new vo;t.ray.origin=this._cameraPosition;const i=t.ray.direction,n=new yc,o=new F;let a=0;t.obeyNodeDisableCollisions=!0,t.far=5,Ke(t.far>M.CAMERA_MAX_PER_FRAME_LINEAR_DISTANCE);const l=(d,u)=>{const m=n.start.distanceTo(d),g=n.end.distanceTo(d);return a-.02<m+g&&m+g<a+.02&&g>=u},c=d=>{if(this._controls.applyCameraYaw(i),i.normalize(),l(this._cameraPosition,d)&&o.equals(i))return!1;let u=this.distanceToClosestObstacle(t);return u===1/0&&(u=t.far),o.copyFrom(i),n.start.copyFrom(this._cameraPosition),n.end.copyFrom(i).multiplyScalar(u).add(this._cameraPosition),a=n.distance(),u<d},h=this._controls.maxFrameMoveLinearDistance(e)+M.KEY_MOVE_MIN_DISTANCE_TO_OBSTACLE;this._controls.movesForward()&&(i.set(0,1,0),c(h)&&this._controls.stopForward()),this._controls.movesBackward()&&(i.set(0,-1,0),c(h)&&this._controls.stopBackward()),this._controls.movesLeft()&&(i.set(-1,0,0),c(h)&&this._controls.stopLeft()),this._controls.movesRight()&&(i.set(1,0,0),c(h)&&this._controls.stopRight()),this._controls.movesDown()&&(i.set(0,0,-1),c(h)&&this._controls.stopDown()),this._controls.movesUp()&&(i.set(0,0,1),c(h)&&this._controls.stopUp())}};r(Ns,"DEBUG",M.COLLIDER_DEBUG),r(Ns,"DEBUG_TREE",M.COLLIDER_DEBUG_TREE),r(Ns,"DEBUG_POINTS",M.COLLIDER_DEBUG_POINTS);let Hc=Ns;class L_{constructor(e,t,i){r(this,"_vrManager");r(this,"_animateCallback");r(this,"_animateIdleCallback");r(this,"_clock",new Dp);r(this,"_inAnimateCallback",!1);r(this,"_frameRequested",!1);r(this,"_callIdleCallback",!1);r(this,"_idleFrameCnt",0);r(this,"_enabled",!1);this._vrManager=e,this._animateCallback=t,this._animateIdleCallback=i}_animateVR(){this._animate(this._vrManager.vrEnabled())}_animateWindow(){this._animate(!1)}_doRequestFrame(){this._frameRequested||(this._inAnimateCallback||this._clock.getDelta(),this._frameRequested=!0,this._vrManager.vrEnabled()?this._vrManager.requestAnimationFrame(this._animateVR.bind(this)):requestAnimationFrame(this._animateWindow.bind(this)))}_animate(e){this._enabled&&(this._frameRequested=!1,this._callIdleCallback?(Ke(!e),this._animateIdleCallback(this._clock.getDelta(),this._idleFrameCnt)?(this._idleFrameCnt+=1,this._doRequestFrame()):this._callIdleCallback=!1):(this._inAnimateCallback=!0,this._animateCallback(this._clock.getDelta(),e),M.ALWAYS_RENDER&&this.requestFrame(),this._inAnimateCallback=!1,this._frameRequested||(this._callIdleCallback=!0,this._idleFrameCnt=0,this._doRequestFrame())))}requestFrame(){this._enabled&&(this._callIdleCallback=!1,this._doRequestFrame())}disable(){this._enabled=!1}enable(){this._enabled=!0,this._frameRequested=!1,this.requestFrame()}isEnabled(){return this._enabled}}var hu=(s=>(s.TOUR_STARTED="tourStarted",s.TOUR_STOPPED="tourStopped",s))(hu||{});const ma=class ma extends ei{constructor(t){super();r(this,"_teleport");r(this,"_running");r(this,"_maxTeleportToViewTime");r(this,"_switchToView",()=>{this._running&&this._teleport.switchToNextVisibleView(this._maxTeleportToViewTime)});r(this,"_onTeleportDone",()=>{this._running&&setTimeout(this._switchToView,M.AUTO_TOUR_IN_VIEW_STILL_TIME_MS)});this._teleport=t,this._running=!1,this._maxTeleportToViewTime=4,this._teleport.addEventListener(Mn.eventType.TELEPORT_DONE,this._onTeleportDone)}isRunning(){return this._running}start(){console.assert(!this._running),this._running=!0,this.dispatchEvent({type:ma.eventType.TOUR_STARTED}),this._switchToView()}stop(){console.assert(this._running),this._running=!1,this._teleport.switchToView(this._teleport.lastDestinationView,0),this.dispatchEvent({type:ma.eventType.TOUR_STOPPED})}};r(ma,"eventType",hu);let Fr=ma;const Wc=.2,du=.011,jc=.011,F_=.047;function O_(){const s=new gt;return s.baseColor.setRGB(.298,.619,.851),s.highlight=new be(.033,.125,.445),s.reflective=!1,s.lightmapSupported=!1,s.setUniforms(),s}function B_(s){const e=nt.createCylinder(.05,.05,jc,32),t=nt.createCylinder(.05,.03,du,32,1,!1),i=nt.createCylinder(0,.05,Wc,32,1,!0),n=new at;n.makeRotationX(Math.PI/2),e.applyMatrix(n),e.convertNormalsToSpherical();const o=new Ye(e,s);o.position.z+=jc/2,n.makeTranslation(0,-(Wc/2+du/2),0),t.applyMatrix(n),t.convertNormalsToSpherical();const a=new Ye(t,s);i.convertNormalsToSpherical();const l=new Ye(i,s);l.add(a),l.rotateX(-Math.PI/2),l.position.z=jc+F_+Wc/2;const c=new ft;return c.add(o),c.add(l),c}class U_{constructor(e){r(this,"_scene");r(this,"_targetMaterial",O_());r(this,"_targetObject",B_(this._targetMaterial));r(this,"_baseMesh",this._targetObject.children[0]);r(this,"_visible",!1);r(this,"_highlightChangeSign",1);this._scene=e}hide(){this._visible&&(this._scene.removeAuxiliaryObject(this._targetObject),this._visible=!1)}isVisible(){return this._visible}showTargetAtPosition(e,t,i,n){this._visible||(this._scene.addAuxiliaryObject(this._targetObject),this._visible=!0),this._baseMesh.visible=n,this._targetObject.position.set(e,t,i),this._targetObject.updateMatrixWorld()}update(e){this._targetMaterial.highlightMix+=e*this._highlightChangeSign,this._targetMaterial.highlightMix>=1&&(this._targetMaterial.highlightMix=1,this._highlightChangeSign=-1),this._targetMaterial.highlightMix<=0&&(this._targetMaterial.highlightMix=0,this._highlightChangeSign=1)}}class N_{constructor(e,t,i,n){r(this,"_collider");r(this,"_controls");r(this,"_teleport");r(this,"_targetIndicator");r(this,"_intersection",new ws);r(this,"_cancelTeleport");r(this,"_cancelTeleportInPointerLock");this._collider=t,this._controls=i,this._teleport=n,this._targetIndicator=new U_(e),this._teleport.addEventListener(Mn.eventType.TELEPORT_DONE,()=>this._targetIndicator.hide()),this._cancelTeleport=()=>{this._teleport.teleportingToPoint&&this._teleport.cancelSwitchToPoint()},this._cancelTeleportInPointerLock=()=>{!this._controls.mousePressLook&&this._teleport.teleportingToPoint&&this._teleport.cancelSwitchToPoint()},this._init()}onMeshClicked(e,t){if(this._shouldIgnoreClick())return;this._collider.clickedPointToMoveTarget(t);const i=t.x,n=t.y;let o=t.z,a=!1;if(this._collider.findIntersectionBelow(t,4,this._intersection)){o=this._intersection.point.z;const l=this._intersection.object.geometry.boundingBox;l&&o>l.max.z-.01&&(a=!0)}else o-=this._controls.cameraHeight||1.6;M.CLICK_MOVE_SHOW_TARGET_INDICATOR&&this._targetIndicator.showTargetAtPosition(i,n,o,a),this._teleport.switchToPoint(t)}update(e){this._targetIndicator.isVisible()&&this._targetIndicator.update(e)}dispose(){document.removeEventListener("keydown",this._cancelTeleport,!1),document.removeEventListener("mousedown",this._cancelTeleport,!1),document.removeEventListener("mousemove",this._cancelTeleportInPointerLock,!1),document.removeEventListener("touchstart",this._cancelTeleport,!1),document.removeEventListener("wheel",this._cancelTeleport,!1)}_shouldIgnoreClick(){return this._controls.isOrbitEnabled()||this._controls.isHandlingGesture()||this._controls.camera().moveMaxSpeed===0}_init(){document.addEventListener("keydown",this._cancelTeleport,!1),document.addEventListener("mousedown",this._cancelTeleport,!1),document.addEventListener("mousemove",this._cancelTeleportInPointerLock,!1),document.addEventListener("touchstart",this._cancelTeleport,!1),document.addEventListener("wheel",this._cancelTeleport,!1)}}var Gi=(s=>(s[s.TRIGGER=0]="TRIGGER",s[s.BACKWARD=1]="BACKWARD",s[s.FORWARD=2]="FORWARD",s[s.LEFT=3]="LEFT",s[s.RIGHT=4]="RIGHT",s[s.DOWN=5]="DOWN",s[s.UP=6]="UP",s[s.PREVIOUS=7]="PREVIOUS",s[s.NEXT=8]="NEXT",s))(Gi||{});const uu=.7,k_=[{gamepadIdPattern:/^Spatial Controller \(Spatial Interaction Source\).*$/,axisMapping:new Map([[2,[7,8]],[3,[6,5]],[0,[3,4]],[1,[2,1]]]),buttonMapping:new Map([[1,0]])},{gamepadIdPattern:/Oculus Touch \(Left\)/,axisMapping:new Map([[0,[3,4]],[1,[2,1]]]),buttonMapping:new Map([[1,0],[3,5],[4,6]])},{gamepadIdPattern:/Oculus Touch \(Right\)/,axisMapping:new Map([[0,[3,4]],[1,[2,1]]]),buttonMapping:new Map([[1,0],[3,8],[4,7]])},{gamepadIdPattern:/OpenVR (Gamepad|Controller)/,axisMapping:new Map([[0,[7,8]],[1,[5,6]]]),buttonMapping:new Map([[1,0]])},{gamepadIdPattern:/.*/,gamepadLayoutMappingId:"standard",axisMapping:new Map([[0,[3,4]],[1,[2,1]],[2,[3,4]],[3,[2,1]]]),buttonMapping:new Map([[0,5],[1,8],[2,7],[3,6],[4,0],[5,0]])},{gamepadIdPattern:/.*/,gamepadLayoutMappingId:"xr-standard",hand:"left",axisMapping:new Map([[2,[3,4]],[3,[2,1]]]),buttonMapping:new Map([[0,0],[4,5],[5,6]])},{gamepadIdPattern:/.*/,gamepadLayoutMappingId:"xr-standard",hand:"right",axisMapping:new Map([[2,[3,4]],[3,[2,1]]]),buttonMapping:new Map([[0,0],[4,8],[5,7]])},{gamepadIdPattern:/.*/,gamepadLayoutMappingId:"xr-standard",axisMapping:new Map([[2,[3,4]],[3,[2,1]]]),buttonMapping:new Map([[0,0],[4,8],[5,7]])},{gamepadIdPattern:/.*/,axisMapping:new Map([[0,[7,8]],[1,[6,5]]]),buttonMapping:new Map([[0,0],[1,0],[2,0],[3,0]])}];function fu(s){return s<=-uu?0:s>=uu?1:-1}class er{constructor(e,t){r(this,"axisMapping",new Map);r(this,"buttonMapping",new Map);r(this,"axisPosition",[]);r(this,"buttonPressed",[]);const i=er._getActionMapping(e,t);i&&(this.axisMapping=i.axisMapping,this.buttonMapping=i.buttonMapping),this.axisPosition=e.axes.map(fu),this.buttonPressed=e.buttons.map(n=>n.pressed)}static _gamepadMatchesActionMapping(e,t,i){var o;if(t.gamepadLayoutMappingId&&e.mapping!==t.gamepadLayoutMappingId)return!1;const n=(o=e.hand)!=null?o:i;return t.hand&&n!==t.hand?!1:t.gamepadIdPattern.test(e.id)}static _getActionMapping(e,t){for(const i of k_)if(er._gamepadMatchesActionMapping(e,i,t))return i;return console.error("No matching action mapping for gamepad found",e.id),null}}var tr=(s=>(s.ACTION_ACTIVATED="actionActivated",s.ACTION_DEACTIVATED="actionDeactivated",s))(tr||{});class z_ extends ei{constructor(){super();r(this,"_gamepadStates",new Map);r(this,"_xrGamepadStates",new Map);r(this,"_actionsActivated",new Set);r(this,"_actionsDeactivated",new Set);r(this,"_actionDeactivatedEvent",{type:"actionDeactivated",action:0});r(this,"_actionActivatedEvent",{type:"actionActivated",action:0});r(this,"_onGamepadConnected",t=>{const i=t.gamepad,n=new er(i);this._gamepadStates.set(i.index,n)});r(this,"_onGamepadDisconnected",t=>{this._gamepadStates.delete(t.gamepad.index)});if(navigator.getGamepads){window.addEventListener("gamepadconnected",this._onGamepadConnected),window.addEventListener("gamepaddisconnected",this._onGamepadDisconnected);for(const t of navigator.getGamepads())if(t){const i=new er(t);this._gamepadStates.set(t.index,i)}}}hasGamepads(){return this._gamepadStates.size>0||this._xrGamepadStates.size>0}update(){if(!this.hasGamepads())return;this._actionsActivated.clear(),this._actionsDeactivated.clear();const t=(n,o)=>{for(let a=0;a<o.axes.length;++a){const l=fu(o.axes[a]),c=n.axisPosition[a];if(l!==c){const h=n.axisMapping.get(a);h!==void 0&&(c!==-1&&this._actionsDeactivated.add(h[c]),l!==-1&&this._actionsActivated.add(h[l]))}n.axisPosition[a]=l}for(let a=0;a<o.buttons.length;++a){const l=o.buttons[a].pressed,c=n.buttonPressed[a];if(l!==c){const h=n.buttonMapping.get(a);h!==void 0&&(c?this._actionsDeactivated.add(h):this._actionsActivated.add(h))}n.buttonPressed[a]=l}},i=navigator.getGamepads?navigator.getGamepads():[];for(const n of i){if(!n)continue;const o=this._gamepadStates.get(n.index);o&&t(o,n)}for(const[n,o]of this._xrGamepadStates)t(o,n);for(const n of this._actionsDeactivated)this._actionDeactivatedEvent.action=n,this.dispatchEvent(this._actionDeactivatedEvent);for(const n of this._actionsActivated)this._actionActivatedEvent.action=n,this.dispatchEvent(this._actionActivatedEvent)}addXrGamepad(t,i){const n=new er(t,i);this._xrGamepadStates.set(t,n)}removeXrGamepad(t){this._xrGamepadStates.delete(t)}removeAllXrGamepads(){this._xrGamepadStates.clear()}}class ir{constructor(e,t,i,n){r(this,"collider");r(this,"target",new F);r(this,"noZoom",!1);r(this,"mouseZoomToPointer",!0);r(this,"mouseZoomSpeed",.97);r(this,"keyZoomSpeed",.7);r(this,"minZoom",0);r(this,"maxZoom",1/0);r(this,"noRotate",!1);r(this,"noPitchRotate",!1);r(this,"mouseRotateSpeed",2*Math.PI);r(this,"keyYawRotateSpeed",M.CAMERA_ARROWS_TURN_SPEED);r(this,"keyPitchRotateSpeed",M.CAMERA_ARROWS_TURN_SPEED/2);r(this,"autoRotate",!1);r(this,"autoRotateSpeed",2);r(this,"keyPanSpeed",.25);r(this,"primaryMouseButton",0);r(this,"secondaryMouseButton",2);r(this,"mouseButtons",{ROTATE:this.primaryMouseButton,ZOOM:1,PAN:this.secondaryMouseButton});r(this,"getMinPitchAngle",()=>-Math.PI/2);r(this,"getMaxPitchAngle",()=>Math.PI/2);r(this,"getMinYawAngle",()=>-Math.PI);r(this,"getMaxYawAngle",()=>Math.PI);r(this,"getMinDistance",()=>0);r(this,"getMaxDistance",()=>1/0);r(this,"getNoPan",()=>!1);r(this,"getAutoRotateAngle",()=>2*Math.PI/60/60*this.autoRotateSpeed);r(this,"_camera");r(this,"_controls");r(this,"_domElement");r(this,"_animationController");r(this,"_enabled",!1);r(this,"_rayIntersection",new ws);r(this,"_rotateStart",new Ce);r(this,"_rotateEnd",new Ce);r(this,"_rotateDelta",new Ce);r(this,"_panStart",new Ce);r(this,"_panEnd",new Ce);r(this,"_panDelta",new Ce);r(this,"_panOffset",new F);r(this,"_dollyStart",new Ce);r(this,"_dollyEnd",new Ce);r(this,"_dollyDelta",new Ce);r(this,"_dollyTarget",new F);r(this,"_cameraToTarget",new F);r(this,"_dollyTargetOffset",new F);r(this,"_yawDelta",0);r(this,"_pitchDelta",0);r(this,"_scale",1);r(this,"_panVector",new F);r(this,"_panPrimary",!1);r(this,"_keyDollyDir",0);r(this,"_keyYawRotateDir",0);r(this,"_keyPitchRotateDir",0);r(this,"_keyHorizontalPanDir",0);r(this,"_keyVerticalPanDir",0);r(this,"_state",-1);r(this,"_cancelMouseDown");r(this,"_onMouseMove",e=>{if(!this._enabled)return;e.preventDefault();const t=this._domElement instanceof Document?this._domElement.body:this._domElement;if(this._state===0){if(this.noRotate===!0)return;this._rotateEnd.set(e.clientX,e.clientY),this._rotateDelta.subVectors(this._rotateEnd,this._rotateStart),this._rotateLeft(this._rotateDelta.x/t.clientWidth*this.mouseRotateSpeed),this.noPitchRotate===!1&&this._rotateUp(this._rotateDelta.y/t.clientHeight*this.mouseRotateSpeed),this._rotateStart.copyFrom(this._rotateEnd)}else if(this._state===1){if(this.noZoom===!0)return;this._dollyEnd.set(e.clientX,e.clientY),this._dollyDelta.subVectors(this._dollyEnd,this._dollyStart),this._dollyDelta.y>0?this._dollyIn():this._dollyDelta.y<0&&this._dollyOut(),this._dollyStart.copyFrom(this._dollyEnd)}else if(this._state===2){if(this.getNoPan()===!0)return;this._panEnd.set(e.clientX,e.clientY),this._panDelta.subVectors(this._panEnd,this._panStart),this.pan(this._panDelta.x/t.clientHeight,this._panDelta.y/t.clientWidth),this._panStart.copyFrom(this._panEnd)}this._state!==-1&&this._update()});r(this,"_onMouseUp",e=>{this._enabled&&this._cancelMouseDown&&(this._cancelMouseDown(),this._cancelMouseDown=void 0)});r(this,"_onMouseDown",e=>{if(!this._enabled)return;if((this._domElement instanceof Document?this._domElement.body:this._domElement).focus(),e.preventDefault(),e.button===this.mouseButtons.ROTATE){if(this.noRotate===!0)return;this._state=0,this._rotateStart.set(e.clientX,e.clientY)}else if(e.button===this.mouseButtons.ZOOM){if(this.noZoom===!0)return;this._state=1,this._dollyStart.set(e.clientX,e.clientY),this._updateDollyTarget(e.clientX,e.clientY)}else if(e.button===this.mouseButtons.PAN){if(this.getNoPan()===!0)return;this._state=2,this._panStart.set(e.clientX,e.clientY)}this._state!==-1&&(document.addEventListener("mousemove",this._onMouseMove,!1),document.addEventListener("mouseup",this._onMouseUp,!1),this._cancelMouseDown=()=>{document.removeEventListener("mousemove",this._onMouseMove,!1),document.removeEventListener("mouseup",this._onMouseUp,!1),this._state=-1})});r(this,"_onMouseWheel",e=>{if(!this._enabled||this.noZoom||this._state!==-1)return;e.preventDefault();const t=-e.deltaY;this._updateDollyTarget(e.clientX,e.clientY),t>0?this._dollyOut():t<0&&this._dollyIn(),this._update()});r(this,"_touchStart",e=>{if(!this._enabled)return;const t=e.touches.length;if(e.preventDefault(),this._touchPanEvent(e.touches))this._state=5,this._panStart.set(e.touches[0].clientX,e.touches[0].clientY);else if(this._touchRotateEvent(t))this._state=3,this._rotateStart.set(e.touches[0].clientX,e.touches[0].clientY);else if(this._touchZoomEvent(t)){this._state=4;const i=e.touches[0].clientX-e.touches[1].clientX,n=e.touches[0].clientY-e.touches[1].clientY,o=Math.sqrt(i*i+n*n);this._dollyStart.set(0,o);const a=e.touches[0].clientX-i/2,l=e.touches[0].clientY-n/2;this._updateDollyTarget(a,l)}else this._state=-1});r(this,"_touchMove",e=>{if(!this._enabled)return;const t=e.touches.length;e.preventDefault();const i=this._domElement instanceof Document?this._domElement.body:this._domElement;if(this._touchPanEvent(e.touches)&&this._state===5)this._panEnd.set(e.touches[0].clientX,e.touches[0].clientY),this._panDelta.subVectors(this._panEnd,this._panStart),this.pan(this._panDelta.x/i.clientHeight,this._panDelta.y/i.clientWidth),this._panStart.copyFrom(this._panEnd),this._update();else if(this._touchRotateEvent(t)&&this._state===3)this._rotateEnd.set(e.touches[0].clientX,e.touches[0].clientY),this._rotateDelta.subVectors(this._rotateEnd,this._rotateStart),this._rotateLeft(this._rotateDelta.x/i.clientWidth*this.mouseRotateSpeed),this._rotateUp(this._rotateDelta.y/i.clientHeight*this.mouseRotateSpeed),this._rotateStart.copyFrom(this._rotateEnd),this._update();else if(this._touchZoomEvent(t)&&this._state===4){const n=e.touches[0].clientX-e.touches[1].clientX,o=e.touches[0].clientY-e.touches[1].clientY,a=Math.sqrt(n*n+o*o);this._dollyEnd.set(0,a),this._dollyDelta.subVectors(this._dollyEnd,this._dollyStart),this._dollyDelta.y>0?this._dollyOut():this._dollyDelta.y<0&&this._dollyIn(),this._dollyStart.copyFrom(this._dollyEnd),this._update()}else this._state=-1});r(this,"_touchEnd",e=>{this._enabled&&(this._state=-1)});r(this,"_onKeyDown",e=>{wd(e)||this._onKey(e,!0)});r(this,"_onKeyUp",e=>{this._onKey(e,!1)});r(this,"_onFocusLost",e=>{this._stopAll()});this._camera=e,this._controls=t,this._domElement=i,this._animationController=n,this._domElement.addEventListener("mousedown",this._onMouseDown,!1),this._domElement.addEventListener("wheel",this._onMouseWheel,!1),this._domElement.addEventListener("touchstart",this._touchStart,!1),this._domElement.addEventListener("touchend",this._touchEnd,!1),this._domElement.addEventListener("touchmove",this._touchMove,!1),this._domElement.addEventListener("blur",this._onFocusLost,!1),this._domElement.addEventListener("keydown",this._onKeyDown,!1),this._domElement.addEventListener("keyup",this._onKeyUp,!1),!this._camera.isPerspective()&&!this._camera.isOrthographic()&&console.warn("WARNING: OrbitControls.js requires perspective or orthographic camers")}_determineDollyTarget(e,t){if(this.collider&&this.mouseZoomToPointer){const i=e/window.innerWidth*2-1,n=-(t/window.innerHeight)*2+1;if(this.collider.findIntersectionAtPosition(i,n,!0,this._rayIntersection)){this._dollyTarget.copyFrom(this._rayIntersection.point);return}}this._dollyTarget.copyFrom(this.target)}_updateDollyTarget(e,t){this.getNoPan()?this._dollyTarget.copyFrom(this.target):this._determineDollyTarget(e,t)}_updateDirection(e,t,i){return i===!0?t:e===t?0:e}_update(){let e=this._controls.getYawAngle(),t=this._controls.getPitchAngle();const i=this._controls.cameraWorldPosition();this.autoRotate&&this._state===-1&&this._rotateLeft(this.getAutoRotateAngle());const n=this.getMinYawAngle();let o=this.getMaxYawAngle();Math.abs(o-n)>=2*Math.PI-1e-6?e+=this._yawDelta:n===o?e=n:(n>o&&(o+=2*Math.PI,e<n&&(e+=2*Math.PI)),this._yawDelta<0?e=Math.min(Math.max(e+this._yawDelta,n),o):e=Math.max(Math.min(e+this._yawDelta,o),n)),t=xi(t+this._pitchDelta,this.getMinPitchAngle(),this.getMaxPitchAngle()),this._cameraToTarget.copyFrom(this.target).sub(i);const a=this._cameraToTarget.length(),l=xi(a*this._scale,this.getMinDistance(),this.getMaxDistance()),c=l/a;this._dollyTargetOffset.copyFrom(this._dollyTarget).sub(this.target).multiplyScalar(1-c),this.target.add(this._dollyTargetOffset),this.target.add(this._panVector),ir.computeCameraPosition(i,this.target,e,t,l),this._controls.setYawAngle(e),this._controls.setPitchAngle(t),this._controls.cameraTransformUpdated();const h=ir.computeCameraNear(l);Math.abs(h-this._camera.near)>1e-6&&(this._camera.near=h,this._camera.updateProjectionMatrix()),this._yawDelta=0,this._pitchDelta=0,this._scale=1,this._panVector.set(0,0,0),this._animationController.requestFrame()}_stopAll(){this._keyDollyDir=0,this._keyYawRotateDir=this._keyPitchRotateDir=0,this._keyHorizontalPanDir=this._keyVerticalPanDir=0,this._cancelMouseDown&&(this._cancelMouseDown(),this._cancelMouseDown=void 0)}enable(){this._enabled=!0,this._update()}disable(){this._enabled=!1,this._stopAll()}isEnabled(){return this._enabled}setPanPrimary(e){this._panPrimary=e,this._panPrimary?(this.mouseButtons.PAN=this.primaryMouseButton,this.mouseButtons.ROTATE=this.secondaryMouseButton):(this.mouseButtons.ROTATE=this.primaryMouseButton,this.mouseButtons.PAN=this.secondaryMouseButton)}getCameraDistance(){const e=new F;return e.copyFrom(this._controls.cameraWorldPosition()).sub(this.target),e.length()}_rotateLeft(e){e===void 0&&(e=this.getAutoRotateAngle()),this._yawDelta-=e}_rotateUp(e){e===void 0&&(e=this.getAutoRotateAngle()),this._pitchDelta-=e}_panLeft(e){const t=this._camera.matrixWorld.elements;this._panOffset.set(t[0],t[1],t[2]),this._panOffset.multiplyScalar(-e),this._panVector.add(this._panOffset)}_panUp(e){const t=this._camera.matrixWorld.elements;this._panOffset.set(t[4],t[5],t[6]),this._panOffset.multiplyScalar(e),this._panVector.add(this._panOffset)}pan(e,t){if(this._camera.isPerspective()){let o=this._controls.cameraWorldPosition().clone().sub(this.target).length();o*=Math.tan(this._camera.fov/2*Math.PI/180),this._panLeft(2*e*o),this._panUp(2*t*o)}else this._camera.isOrthographic()&&(this._panLeft(e*(this._camera.right-this._camera.left)),this._panUp(t*(this._camera.top-this._camera.bottom)))}_dollyIn(e){e===void 0&&(e=this.mouseZoomSpeed),this._camera.isPerspective()?this._scale/=e:this._camera.isOrthographic()&&(this._camera.orthoFrustumSize/=e,this._camera.updateProjectionMatrix())}_dollyOut(e){e===void 0&&(e=this.mouseZoomSpeed),this._camera.isPerspective()?this._scale*=e:this._camera.isOrthographic()&&(this._camera.orthoFrustumSize*=e,this._camera.updateProjectionMatrix())}update(e){if(!this._enabled||!e)return;let t=!1;if(this._keyYawRotateDir!==0&&(this._rotateLeft(this._keyYawRotateDir*this.keyYawRotateSpeed*e),t=!0),this._keyPitchRotateDir!==0&&(this._rotateUp(this._keyPitchRotateDir*this.keyPitchRotateSpeed*e),t=!0),(this._keyHorizontalPanDir!==0||this._keyVerticalPanDir!==0)&&(this.pan(this._keyHorizontalPanDir*this.keyPanSpeed*e,this._keyVerticalPanDir*this.keyPanSpeed*e),t=!0),this._keyDollyDir!==0){const i=Math.pow(this.keyZoomSpeed,e);this._keyDollyDir===-1?this._dollyIn(i):this._dollyOut(i),t=!0}t&&this._update()}_upKey(e){return["w","ArrowUp"].includes(e.key)}_downKey(e){return["s","ArrowDown"].includes(e.key)}_leftKey(e){return["a","ArrowLeft"].includes(e.key)}_rightKey(e){return["d","ArrowRight"].includes(e.key)}_onKey(e,t){if(this._enabled===!1)return;let i=!1;if(this._panPrimary&&!this.getNoPan()?(i=!0,this._upKey(e)?this._keyVerticalPanDir=this._updateDirection(this._keyVerticalPanDir,1,t):this._downKey(e)?this._keyVerticalPanDir=this._updateDirection(this._keyVerticalPanDir,-1,t):this._leftKey(e)?this._keyHorizontalPanDir=this._updateDirection(this._keyHorizontalPanDir,1,t):this._rightKey(e)?this._keyHorizontalPanDir=this._updateDirection(this._keyHorizontalPanDir,-1,t):i=!1):!this._panPrimary&&!this.noRotate&&(i=!0,this._upKey(e)&&!this.noPitchRotate?this._keyPitchRotateDir=this._updateDirection(this._keyPitchRotateDir,1,t):this._downKey(e)&&!this.noPitchRotate?this._keyPitchRotateDir=this._updateDirection(this._keyPitchRotateDir,-1,t):this._leftKey(e)?this._keyYawRotateDir=this._updateDirection(this._keyYawRotateDir,1,t):this._rightKey(e)?this._keyYawRotateDir=this._updateDirection(this._keyYawRotateDir,-1,t):i=!1),!this.noZoom){let n;["=","+","e"].includes(e.key)?n=1:["-","q"].includes(e.key)&&(n=-1),n!==void 0&&(this._keyDollyDir=this._updateDirection(this._keyDollyDir,n,t),i=!0)}i&&(e.preventDefault(),this._animationController.requestFrame())}_touchPanEvent(e){return this.getNoPan()?!1:this._panPrimary&&e.length===1?!0:!this._panPrimary&&e.length===2?Math.abs(e[0].clientY-e[1].clientY)<=M.MAX_TWO_POINTERS_IN_LINE_DIFF:!1}_touchRotateEvent(e){return!this.noRotate&&!this._panPrimary&&e===1}_touchZoomEvent(e){return!this.noZoom&&e===2}static computeCameraPosition(e,t,i,n,o){const a=new F,l=i-Math.PI/2,c=n+Math.PI/2;a.x=o*Math.sin(c)*Math.cos(l),a.y=o*Math.sin(c)*Math.sin(l),a.z=o*Math.cos(c),e.copyFrom(t).add(a)}static computeCameraNear(e){return e*M.CAMERA_ORBIT_NEAR_FROM_1M}}var Xc=(s=>(s.WALK="fps",s.ORBIT="orbit",s))(Xc||{});const V_=10,G_=10,mu=100,pu=.5,H_=Math.PI/12;class dl{constructor(e){r(this,"activeDirection",0);r(this,"activeSource",0);r(this,"speed",0);r(this,"_maxPerFrameDistance");this._maxPerFrameDistance=e}moves(){return this.activeDirection!==0||this.speed!==0}movesInDirection(e){return this.activeDirection===e||Math.sign(this.speed)===e}activateDirectionFromSource(e,t){this.activeDirection=e,this.activeSource=t}deactivateDirectionFromSource(e,t){this.activeDirection===e&&this.activeSource===t&&(this.activeDirection=0,this.activeSource=t)}deactivateSource(e){this.activeSource===e&&(this.activeDirection=0,this.activeSource=0)}stopInDirection(e){this.activeDirection===e&&(this.activeDirection=0,this.activeSource=0),Math.sign(this.speed)===e&&(this.speed=0)}update(e,t){if(!this.moves())return 0;const i=Math.sign(this.speed),n=this.activeDirection||-i;let o;i===n?o=e/M.CAMERA_FULL_ACCELERATION_TIME:o=e/M.CAMERA_FULL_DECELERATION_TIME;const a=t*n*o,l=t*(this.speed+a/2);return this.speed=xi(this.speed+a,-e,e),!this.activeDirection&&Math.sign(this.speed)!==i&&(this.speed=0),xi(l,-this._maxPerFrameDistance,this._maxPerFrameDistance)}}class W_{constructor(e,t,i,n){r(this,"_camera");r(this,"_domElement");r(this,"_gamepadManager");r(this,"_animationController");r(this,"_enabled",!0);r(this,"_controlMode","fps");r(this,"_moveMaxSpeedFactor",1);r(this,"_moveX",new dl(M.CAMERA_MAX_PER_FRAME_LINEAR_DISTANCE));r(this,"_moveY",new dl(M.CAMERA_MAX_PER_FRAME_LINEAR_DISTANCE));r(this,"_moveZ",new dl(M.CAMERA_MAX_PER_FRAME_LINEAR_DISTANCE));r(this,"_rotationYaw",new dl(H_));r(this,"_pointers",[new Ce(0,0),new Ce(0,0)]);r(this,"_prevPointers",[new Ce(0,0),new Ce(0,0)]);r(this,"_scrollDelta",0);r(this,"_gesture",null);r(this,"_gestureStartPointers",[new Ce(0,0),new Ce(0,0)]);r(this,"_lastPinchTime",0);r(this,"_lastTwoPointerDragTime",0);r(this,"_mousePressed",!1);r(this,"_rollObject",new ft);r(this,"_pitchObject",new ft);r(this,"_yawObject",new ft);r(this,"_hmdResetSinceUpdate",!1);r(this,"_mouseRotation",new F(0,0,0));r(this,"_hmdRotation",new ui(0,0,0,On.XYZ));r(this,"_previousMouseRotation",new Ce);r(this,"_currentMouseRotation",new Ce);r(this,"_targetMouseRotation",new Ce);r(this,"_prevCameraPosition",new F);r(this,"_prevCameraRotation",new wi);r(this,"_newCameraPosition",new F);r(this,"_newCameraRotation",new wi);r(this,"_scaleTemp",new F);r(this,"mousePressLook",!1);r(this,"flipMouseLook",!1);r(this,"mouseControlsPitch",!0);r(this,"restrictVerticalAngle",!0);r(this,"verticalAngleMin",-Math.PI/2);r(this,"verticalAngleMax",Math.PI/3);r(this,"arrowsTurn",!0);r(this,"orbit");r(this,"cameraHeight",null);r(this,"cameraTransformUpdated");r(this,"onHmdUpdate");r(this,"_onPointerMove",e=>{if(this._enabled){if(e.preventDefault(),this._savePointerPositions(e),this._gesture!==null){if(this._gesture===3||this._gesture===0&&!this._recognizeGesture())return;if(this._gesture===1){const t=this._prevPointers[1].distanceTo(this._prevPointers[0]),n=this._pointers[1].distanceTo(this._pointers[0])-t;Math.abs(n)>0&&(this._lastPinchTime=Date.now(),this._moveY.activateDirectionFromSource(Math.sign(n),2)),this._animationController.requestFrame()}else if(this._gesture===2&&this._arePointersInHorizontalLine(this._pointers)){const t=this._pointers[0].y-this._prevPointers[0].y;Math.abs(t)>0&&(this._lastTwoPointerDragTime=Date.now(),this._moveZ.activateDirectionFromSource(Math.sign(t),2)),this._animationController.requestFrame()}}else if(this._mouseLookEnabled()||this._isTouchLook(e)){const t=this._mouseMovementX(e),i=this._mouseMovementY(e),n=this.flipMouseLook||this._isTouchLook(e)?1:-1;this._targetMouseRotation.x+=n*t*M.CAMERA_LOOK_SPEED,this.mouseControlsPitch&&(this._targetMouseRotation.y+=n*i*M.CAMERA_LOOK_SPEED),this._animationController.requestFrame()}}});r(this,"_onMouseDown",e=>{this._enabled&&(this._domElement.focus(),e.preventDefault(),this._savePointerPositions(e),this._mousePressed=!0,this._animationController.requestFrame())});r(this,"_onTouchStart",e=>{this._enabled&&(e.preventDefault(),this._savePointerPositions(e),e.touches.length===2?(this._gesture=0,this._gestureStartPointers[0].copyFrom(this._pointers[0]),this._gestureStartPointers[1].copyFrom(this._pointers[1])):e.touches.length>2&&(this._gesture=3))});r(this,"_onMouseUp",e=>{this._enabled&&(e.preventDefault(),this._mousePressed=!1)});r(this,"_onTouchEnd",e=>{this._enabled&&(e.preventDefault(),e.touches.length===0?this._gesture=null:this._gesture=3)});r(this,"_onMouseWheel",e=>{if(!this._enabled||!this._hasFocus())return;e.preventDefault();const t=-e.deltaY/100;this._scrollDelta+=t*M.CAMERA_SCROLL_SPEED,this._scrollDelta=xi(this._scrollDelta,-pu,pu),this._animationController.requestFrame()});r(this,"_onKeyDown",e=>{let t=!0;if(!(!this._enabled||wd(e))){switch(this._setMoveMaxSpeedFactor(e.shiftKey),e.code){case"ArrowUp":case"Space":case"KeyW":this._moveY.activateDirectionFromSource(1,1);break;case"ArrowLeft":this.arrowsTurn?this._rotationYaw.activateDirectionFromSource(1,1):this._moveX.activateDirectionFromSource(-1,1);break;case"KeyA":this._moveX.activateDirectionFromSource(-1,1);break;case"ArrowDown":case"KeyS":this._moveY.activateDirectionFromSource(-1,1);break;case"ArrowRight":this.arrowsTurn?this._rotationYaw.activateDirectionFromSource(-1,1):this._moveX.activateDirectionFromSource(1,1);break;case"KeyD":this._moveX.activateDirectionFromSource(1,1);break;case"PageUp":case"KeyE":this._moveZ.activateDirectionFromSource(1,1);break;case"PageDown":case"KeyQ":this._moveZ.activateDirectionFromSource(-1,1);break;default:t=!1;break}t&&(e.preventDefault(),this._animationController.requestFrame())}});r(this,"_onKeyUp",e=>{let t=!0;if(this._enabled){switch(this._setMoveMaxSpeedFactor(e.shiftKey),e.code){case"ArrowUp":case"Space":case"KeyW":this._moveY.deactivateDirectionFromSource(1,1);break;case"ArrowLeft":case"KeyA":this._rotationYaw.deactivateDirectionFromSource(1,1),this._moveX.deactivateDirectionFromSource(-1,1);break;case"ArrowDown":case"KeyS":this._moveY.deactivateDirectionFromSource(-1,1);break;case"ArrowRight":case"KeyD":this._rotationYaw.deactivateDirectionFromSource(-1,1),this._moveX.deactivateDirectionFromSource(1,1);break;case"PageUp":case"KeyE":this._moveZ.deactivateDirectionFromSource(1,1);break;case"PageDown":case"KeyQ":this._moveZ.deactivateDirectionFromSource(-1,1);break;default:t=!1;break}t&&e.preventDefault()}});r(this,"_onGamepadActionActivated",e=>{if(this._enabled)switch(e.action){case Gi.BACKWARD:this._moveY.activateDirectionFromSource(-1,3);break;case Gi.FORWARD:this._moveY.activateDirectionFromSource(1,3);break;case Gi.LEFT:this.arrowsTurn?this._rotationYaw.activateDirectionFromSource(1,3):this._moveX.activateDirectionFromSource(-1,3);break;case Gi.RIGHT:this.arrowsTurn?this._rotationYaw.activateDirectionFromSource(-1,3):this._moveX.activateDirectionFromSource(1,3);break;case Gi.DOWN:this._moveZ.activateDirectionFromSource(-1,3);break;case Gi.UP:this._moveZ.activateDirectionFromSource(1,3);break}});r(this,"_onGamepadActionDeactivated",e=>{if(this._enabled)switch(e.action){case Gi.BACKWARD:this._moveY.deactivateDirectionFromSource(-1,3);break;case Gi.FORWARD:this._moveY.deactivateDirectionFromSource(1,3);break;case Gi.LEFT:this._moveX.deactivateDirectionFromSource(-1,3),this._rotationYaw.deactivateDirectionFromSource(1,3);break;case Gi.RIGHT:this._moveX.deactivateDirectionFromSource(1,3),this._rotationYaw.deactivateDirectionFromSource(-1,3);break;case Gi.DOWN:this._moveZ.deactivateDirectionFromSource(-1,3);break;case Gi.UP:this._moveZ.deactivateDirectionFromSource(1,3);break}});r(this,"_onMouseOut",e=>{this._onMouseUp(e)});r(this,"_onMouseEnter",e=>{e.buttons>0&&this._onMouseDown(e)});r(this,"_onFocusLost",e=>{this._stopAll()});r(this,"_disableContextMenu",e=>{e.preventDefault()});this._camera=e,this._domElement=t,this._gamepadManager=i,this._animationController=n,this._rollObject.add(this._camera),this._pitchObject.add(this._rollObject),this._yawObject.add(this._pitchObject),this.orbit=new ir(this._camera,this,this._domElement,this._animationController),this._camera.rotation.set(0,0,0),this._camera.up.set(0,0,1),this._camera.lookAt(new F(0,1,0)),this._camera.matrixWorld.decompose(this._prevCameraPosition,this._prevCameraRotation,this._scaleTemp),this._registerEventListeners(),this.cameraTransformUpdated=()=>{this._yawObject.updateMatrixWorld(!0),this._camera.matrixWorld.decompose(this._newCameraPosition,this._newCameraRotation,this._scaleTemp),this._newCameraPosition.equals(this._prevCameraPosition)||(this._camera.onNewPosition(this._newCameraPosition),this._prevCameraPosition.copyFrom(this._newCameraPosition)),this._newCameraRotation.equals(this._prevCameraRotation)||(this._camera.onNewRotation(this._newCameraRotation),this._prevCameraRotation.copyFrom(this._newCameraRotation))},this.onHmdUpdate=(()=>{const o=new F,a=new F,l=new F,c=new F,h=new F;return(d,u)=>{this._enabled&&(this._hmdRotation.copyFrom(d),this._hmdResetSinceUpdate?this._mouseRotation.z-=this._hmdRotation.z:u&&(c.subVectors(u,l),o.set(Math.cos(this._mouseRotation.z),Math.sin(this._mouseRotation.z),0),a.set(-Math.sin(this._mouseRotation.z),Math.cos(this._mouseRotation.z),0),h.copyFrom(o.multiplyScalar(c.x)),h.add(a.multiplyScalar(c.y)),h.z=c.z,this._yawObject.position.add(h)),u&&l.copyFrom(u),this._hmdResetSinceUpdate=!1,this._updateRotation())}})()}isFpsEnabled(){return this._enabled}setControlMode(e){this._controlMode=e,e==="fps"?(this._enabled=!0,this._mousePressed=!1,this.orbit.disable()):(this._enabled=!1,this.orbit.enable())}isOrbitEnabled(){return this.orbit.isEnabled()}orbitModeEnable(){this._enabled=!1,this.orbit.enable()}camera(){return this._camera}applyCameraYaw(e){this._yawObject.rotation.applyToVector3(e)}cameraWorldPosition(){return this._yawObject.position}_updateYaw(){this._yawObject.rotation.z=Nt(this._hmdRotation.z+this._mouseRotation.z)}_updateRotation(){this._updateYaw(),this._pitchObject.rotation.x=Nt(this._hmdRotation.x+this._mouseRotation.x),this._rollObject.rotation.y=this._hmdRotation.y,this._yawObject.updateMatrixWorld(!0)}resetRollAngle(){this._rollObject.rotation.y!==0&&(this._hmdRotation.y=0,this._updateRotation())}getPitchAngle(){return this._pitchObject.rotation.x}setPitchAngle(e){e!==this._pitchObject.rotation.x&&(this._mouseRotation.x=e,this._hmdRotation.x=0,this._updateRotation())}resetPitchAngle(){this.setPitchAngle(0)}getYawAngle(){return this._yawObject.rotation.z}setYawAngle(e){e!==this._yawObject.rotation.z&&(this._mouseRotation.z=e,this._hmdRotation.z=0,this._updateRotation())}resetYawAngle(){this.setYawAngle(0)}isHandlingGesture(){return this._gesture!==null}_mouseLookEnabled(){return!this.mousePressLook||this._mousePressed}_isTouchLook(e){return!this._gesture&&bs(e)}_arePointersInHorizontalLine(e){return Math.abs(e[0].y-e[1].y)<=M.MAX_TWO_POINTERS_IN_LINE_DIFF}_recognizeGesture(){const e=this._gestureStartPointers[0].distanceTo(this._gestureStartPointers[1]),t=this._pointers[0].distanceTo(this._pointers[1]);return Math.abs(t-e)>=V_?(this._gesture=1,!0):this._arePointersInHorizontalLine(this._pointers)&&this._arePointersInHorizontalLine(this._gestureStartPointers)&&Math.abs(this._pointers[0].y-this._gestureStartPointers[0].y)>=G_?(this._gesture=2,!0):!1}_savePointerPositions(e){this._prevPointers[0].copyFrom(this._pointers[0]),this._prevPointers[1].copyFrom(this._pointers[1]),bs(e)?(this._pointers[0].set(e.touches[0].clientX,e.touches[0].clientY),e.touches.length===2?this._pointers[1].set(e.touches[1].clientX,e.touches[1].clientY):this._pointers[1].set(0,0)):(this._pointers[0].set(e.clientX,e.clientY),this._pointers[1].set(0,0))}_restrictVerticalAngle(e){e.x>this.verticalAngleMax?e.x=this.verticalAngleMax:e.x<this.verticalAngleMin&&(e.x=this.verticalAngleMin)}_mouseRotationNeedsUpdate(){return this._currentMouseRotation.distanceTo(this._targetMouseRotation)>1e-4}_updateMouseRotation(e){if(!this._mouseRotationNeedsUpdate()){this._previousMouseRotation.set(0,0),this._currentMouseRotation.set(0,0),this._targetMouseRotation.set(0,0);return}const t=Math.min(e/M.CAMERA_LOOK_SMOOTHING,1);this._currentMouseRotation.lerp(this._targetMouseRotation,t),this._mouseRotation.z+=this._currentMouseRotation.x-this._previousMouseRotation.x,this._mouseRotation.x+=this._currentMouseRotation.y-this._previousMouseRotation.y,this.restrictVerticalAngle&&this._restrictVerticalAngle(this._mouseRotation),this._updateRotation(),this._previousMouseRotation.copyFrom(this._currentMouseRotation),this._animationController.requestFrame()}_mouseMovementX(e){let t=bs(e)?void 0:e.movementX;return t===void 0&&(t=this._pointers[0].x-this._prevPointers[0].x),t}_mouseMovementY(e){let t=bs(e)?void 0:e.movementY;return t===void 0&&(t=this._pointers[0].y-this._prevPointers[0].y),t}hmdReset(){this._hmdResetSinceUpdate=!0,this.resetPitchAngle()}_hasFocus(){return document.hasFocus!==void 0?document.hasFocus():document.activeElement===this._domElement}_setMoveMaxSpeedFactor(e){e?this._moveMaxSpeedFactor=M.CAMERA_MOVE_MAX_SPEED_SHIFT_FACTOR:this._moveMaxSpeedFactor=1}_moveMaxSpeed(){return this._camera.moveMaxSpeed*this._moveMaxSpeedFactor}maxFrameMoveLinearDistance(e){return Math.min(e*this._moveMaxSpeed(),M.CAMERA_MAX_PER_FRAME_LINEAR_DISTANCE)}movesForward(){return this._moveY.movesInDirection(1)||this._scrollDelta>0}stopForward(){this._scrollDelta>0&&(this._scrollDelta=0),this._moveY.stopInDirection(1)}movesBackward(){return this._moveY.movesInDirection(-1)||this._scrollDelta<0}stopBackward(){this._scrollDelta<0&&(this._scrollDelta=0),this._moveY.stopInDirection(-1)}movesLeft(){return this._moveX.movesInDirection(-1)}stopLeft(){this._moveX.stopInDirection(-1)}movesRight(){return this._moveX.movesInDirection(1)}stopRight(){this._moveX.stopInDirection(1)}movesUp(){return this._moveZ.movesInDirection(1)}stopUp(){this._moveZ.stopInDirection(1)}movesDown(){return this._moveZ.movesInDirection(-1)}stopDown(){this._moveZ.stopInDirection(-1)}_stopTurnLeft(){this._rotationYaw.stopInDirection(1)}_stopTurnRight(){this._rotationYaw.stopInDirection(-1)}enable(){this._controlMode==="fps"?(this._enabled=!0,this._mousePressed=!1):this.orbit.enable()}_moves(){return this._moveX.moves()||this._moveY.moves()||this._moveZ.moves()||this._rotationYaw.moves()||this._scrollDelta!==0}_stopAll(){this.stopForward(),this.stopBackward(),this.stopLeft(),this.stopRight(),this.stopUp(),this.stopDown(),this._stopTurnLeft(),this._stopTurnRight()}_updateScroll(e,t){let i=0;if(t)return this._scrollDelta=0,t;if(this._scrollDelta){const n=this.maxFrameMoveLinearDistance(e);i=xi(this._scrollDelta,-n,n),this._scrollDelta-=i}return i}disable(){this._controlMode==="fps"?this._enabled=!1:this.orbit.disable(),this._stopAll()}update(e){if(this._controlMode==="orbit"){this.orbit.update(e);return}this._updateMouseRotation(e),this._moveY.activeSource===2&&Date.now()-this._lastPinchTime>mu&&this._moveY.deactivateSource(2),this._moveZ.activeSource===2&&Date.now()-this._lastTwoPointerDragTime>mu&&this._moveZ.deactivateSource(2);const t=this._moveX.update(this._moveMaxSpeed(),e);let i=this._moveY.update(this._moveMaxSpeed(),e);const n=this._moveZ.update(this._moveMaxSpeed(),e);i=this._updateScroll(e,i),this._yawObject.translateX(t),this._yawObject.translateY(i),this._yawObject.translateZ(n);const o=this._rotationYaw.update(M.CAMERA_ARROWS_TURN_SPEED,e);this._mouseRotation.z+=o,this._updateYaw(),this._moves()&&this._animationController.requestFrame(),this.cameraTransformUpdated()}_registerEventListeners(){this._domElement.setAttribute("tabindex",-1),this._domElement.addEventListener("contextmenu",this._disableContextMenu,!1),this._domElement.addEventListener("mousedown",this._onMouseDown,!1),this._domElement.addEventListener("touchstart",this._onTouchStart,!1),this._domElement.addEventListener("mousemove",this._onPointerMove,!1),this._domElement.addEventListener("touchmove",this._onPointerMove,!1),this._domElement.addEventListener("mouseup",this._onMouseUp,!1),this._domElement.addEventListener("touchend",this._onTouchEnd,!1),this._domElement.addEventListener("keydown",this._onKeyDown,!1),this._domElement.addEventListener("keyup",this._onKeyUp,!1),this._domElement.addEventListener("mouseout",this._onMouseOut,!1),this._domElement.addEventListener("mouseenter",this._onMouseEnter,!1),this._domElement.addEventListener("wheel",this._onMouseWheel,!1),this._domElement.addEventListener("blur",this._onFocusLost,!1),this._gamepadManager.addEventListener(tr.ACTION_ACTIVATED,this._onGamepadActionActivated),this._gamepadManager.addEventListener(tr.ACTION_DEACTIVATED,this._onGamepadActionDeactivated)}isEnabled(){return this._controlMode==="fps"?this._enabled:this.orbit.isEnabled()}}/*!
 * Copyright (C) 2020-present unreal engine
 */var _u=(s=>(s.MODE_DISABLED="modeDisabled",s.MODE_ENABLED="modeEnabled",s))(_u||{});const pa=class pa extends ei{constructor(){super();r(this,"modeEnabled");this.modeEnabled=!1}enableMode(){this.modeEnabled=!0,this.dispatchEvent({type:pa.eventType.MODE_ENABLED})}disableMode(){this.modeEnabled=!1,this.dispatchEvent({type:pa.eventType.MODE_DISABLED})}modeIsEnabled(){return this.modeEnabled}};r(pa,"eventType",_u);let Ms=pa;/*!
 * Copyright (C) 2017-present unreal engine
 */console.assert(M.GAZE_POINTER_SHOW_LOADING_AFTER_S<=M.GAZE_POINTER_ACTIVATE_AFTER_S);const gu=Math.PI/60;function j_(){const s=new on,e=new Float32Array(2*3*3);return s.addAttribute("position",new At(e,3)),e[0]=.05,e[1]=-.05,e[2]=-2,e[3]=.05,e[4]=.05,e[5]=-2,e[6]=-.05,e[7]=-.05,e[8]=-2,e[9]=.05,e[10]=.05,e[11]=-2,e[12]=-.05,e[13]=.05,e[14]=-2,e[15]=-.05,e[16]=-.05,e[17]=-2,s.computeBoundingSphere(),s}class X_{constructor(e,t,i,n){r(this,"_scene");r(this,"_controls");r(this,"_requestFrame");r(this,"_gazePointerEnabled");r(this,"_startPitch");r(this,"_startYaw");r(this,"_gazeTime");r(this,"_gazeStarted");r(this,"_pointer");r(this,"_handleGazeStart");r(this,"_handleGazeEnd");r(this,"update",e=>{var n,o;if(!this._gazePointerEnabled)return;const t=this._controls.getPitchAngle(),i=this._controls.getYawAngle();if(this._startPitch===void 0)this._startPitch=t,this._startYaw=i;else if(Math.abs(this._startPitch-t)>gu||Math.abs(this._startYaw-i)>gu)this._resetUnconditionally();else{if(this._gazeTime,this._gazeTime+=e,this._gazeTime<M.GAZE_POINTER_SHOW_LOADING_AFTER_S)return;if(!this._gazeStarted)(n=this._handleGazeStart)!=null&&n.call(this)?this._gazeStarted=!0:this._resetUnconditionally();else{this._pointer;const a=M.GAZE_POINTER_ACTIVATE_AFTER_S-M.GAZE_POINTER_SHOW_LOADING_AFTER_S;this._pointer.setCircleSpan(Math.min((this._gazeTime-M.GAZE_POINTER_SHOW_LOADING_AFTER_S)/a,1)),this._gazeTime>=M.GAZE_POINTER_ACTIVATE_AFTER_S&&((o=this._handleGazeEnd)==null||o.call(this),this._resetUnconditionally())}}});this._scene=e,this._controls=t,this._requestFrame=i,this._gazePointerEnabled=n.modeIsEnabled(),n.addEventListener(Ms.eventType.MODE_DISABLED,()=>{this._gazePointerEnabled=!1,this._reevaluateState()}),n.addEventListener(Ms.eventType.MODE_ENABLED,()=>{this._gazePointerEnabled=!0,this._reevaluateState()}),this._reevaluateState()}setGazeHandlers(e,t){this._handleGazeStart=e,this._handleGazeEnd=t}_resetUnconditionally(){var e;this._startPitch=this._startYaw=void 0,this._gazeTime=0,this._gazeStarted=!1,(e=this._pointer)==null||e.setCircleSpan(0)}_reevaluateState(){var e;if(!this._gazePointerEnabled)this._resetUnconditionally();else if(!this._pointer){const t=new G0,i=new Ye(j_(),t);this._scene.addAuxiliaryObject(i),i.frustumCulled=!1,i.matrixWorld=this._controls.camera().matrixWorld,this._pointer={setVisible:n=>{i.visible=n,this._requestFrame()},setCircleSpan:n=>{t.circleSpan=n,this._requestFrame()}},this._resetUnconditionally()}(e=this._pointer)==null||e.setVisible(this._gazePointerEnabled)}reset(){this._startPitch!==void 0&&this._resetUnconditionally()}}/*!
 * Copyright (C) 2018-present unreal engine
 */class q_{constructor(e,t){r(this,"_scene");r(this,"_teleport");r(this,"_hashChanged",()=>{const e=M.urlHashGetArgument("view");if(e){const t=this._scene.findViewByName(e);t&&(this._teleport.switchToView(t),window.location.hash=M.urlHashRemoveArgument("view"))}});this._scene=e,this._teleport=t,window.addEventListener("hashchange",this._hashChanged,!1)}dispose(){window.removeEventListener("hashchange",this._hashChanged,!1)}}const vu=.03,Y_=500;class ul{constructor(e,t){r(this,"callbacks");r(this,"_pointerEventDispatcher");r(this,"_priority");r(this,"_isPotentialClick");r(this,"_pointerDownClip");r(this,"_lastClickClip");r(this,"_lastClickTime");r(this,"_enabled");r(this,"_onPointerDown",(e,t)=>{var n,o;const i=(o=(n=this.callbacks).onPointerDown)==null?void 0:o.call(n,e,t);return this._isPotentialClick=!0,this._pointerDownClip=[e,t],i});r(this,"_onPointerUp",(e,t,i)=>{var l,c,h,d;let n=(c=(l=this.callbacks).onPointerUp)==null?void 0:c.call(l,e,t);if(!this._isPotentialClick)return n;const o=Date.now();return this._lastClickTime!==void 0&&this._isWithinMaxClickMoveDiff(this._pointerDownClip,this._lastClickClip)&&this._isWithinMaxDoubleClickBreak(this._lastClickTime,o)&&this.callbacks.onDoubleClick?n=this.callbacks.onDoubleClick(e,t)||n:n=((d=(h=this.callbacks).onClick)==null?void 0:d.call(h,e,t,i))||n,this._lastClickTime=o,this._lastClickClip=[e,t],n});r(this,"_onPointerMove",(e,t)=>{var n,o;const i=(o=(n=this.callbacks).onPointerMove)==null?void 0:o.call(n,e,t);return this._isPotentialClick&&!this._isWithinMaxClickMoveDiff(this._pointerDownClip,[e,t])&&(this._isPotentialClick=!1,this._lastClickTime=void 0),i});this._pointerEventDispatcher=e,this._priority=t,this._isPotentialClick=!1,this._pointerDownClip=void 0,this._lastClickClip=void 0,this._lastClickTime=void 0,this._enabled=!1,this.callbacks={onClick:void 0,onDoubleClick:void 0,onPointerDown:void 0,onPointerUp:void 0,onPointerMove:void 0},this.enable()}_isWithinMaxClickMoveDiff(e,t){return Math.abs(e[0]-t[0])<=vu&&Math.abs(e[1]-t[1])<=vu}_isWithinMaxDoubleClickBreak(e,t){return Math.abs(e-t)<=Y_}_registerEventListeners(){this._pointerEventDispatcher.addPointerDownListener(this._onPointerDown,this._priority),this._pointerEventDispatcher.addPointerUpListener(this._onPointerUp,this._priority),this._pointerEventDispatcher.addPointerMoveListener(this._onPointerMove,this._priority)}_unregisterEventListeners(){this._pointerEventDispatcher.removePointerDownListener(this._onPointerDown),this._pointerEventDispatcher.removePointerUpListener(this._onPointerUp),this._pointerEventDispatcher.removePointerMoveListener(this._onPointerMove)}isEnabled(){return this._enabled}enable(){this._enabled||(this._registerEventListeners(),this._enabled=!0)}disable(){this._enabled&&(this._unregisterEventListeners(),this._enabled=!1)}}class Q_{constructor(e,t,i,n,o,a,l,c){r(this,"_collider");r(this,"_requestFrame");r(this,"_clickListeners");r(this,"_doubleClickListeners");r(this,"_hoverListeners");r(this,"_gamepadManager");r(this,"_gazePointer");r(this,"_gazeTargetIntersection");r(this,"_hoveredMesh");r(this,"_enabled");r(this,"_lastClipX");r(this,"_lastClipY");r(this,"_helper");r(this,"_callbacks");r(this,"_clickIntersection");r(this,"onGamepadActionActivated",e=>{this._gazePointer&&this._gazePointer.reset(),e.action===Gi.TRIGGER&&this.handleClick(0,0,!1)});this._collider=t,this._requestFrame=i,this._clickListeners=n,this._doubleClickListeners=o,this._hoverListeners=a,this._gamepadManager=l,this._gazePointer=c,this._gazeTargetIntersection=new ws,this._hoveredMesh=void 0,this._enabled=!1,this._lastClipX=void 0,this._lastClipY=void 0,this._gazePointer&&this._gazePointer.setGazeHandlers(()=>this.handleGazeStart(),()=>this.handleGazeEnd()),this._helper=new ul(e,M.POINTER_PRIORITY.INTERACTION_DISPATCHER),this._callbacks=this._helper.callbacks,this._clickIntersection=new ws,this._callbacks.onPointerMove=(h,d)=>(console.assert(this._enabled),this._hoverListeners.empty()||(this._lastClipX=h,this._lastClipY=d,this._requestFrame()),!1),this._callbacks.onClick=(h,d)=>this.handleClick(h,d,!1),this._callbacks.onDoubleClick=(h,d)=>this.handleClick(h,d,!0),this._gamepadManager.addEventListener(tr.ACTION_ACTIVATED,this.onGamepadActionActivated),this.enable()}dispatchClick(e,t){if(!t.object)return!1;const i=e?this._doubleClickListeners:this._clickListeners;for(const n of i)if(n(t.object,t.point,t.distance))return!0;return!1}handleGazeStart(){return this._collider.findIntersectionAtPosition(0,0,!0,this._gazeTargetIntersection)}handleGazeEnd(){this.dispatchClick(!1,this._gazeTargetIntersection)}handleClick(e,t,i){return this._gazePointer&&this._gazePointer.reset(),this._collider.findIntersectionAtPosition(e,t,!0,this._clickIntersection)?this.dispatchClick(i,this._clickIntersection):!1}handleHover(){if(!this._enabled||this._hoverListeners.empty()||this._lastClipX===void 0||this._lastClipY===void 0)return;const e=this._collider.findObstacleMeshAtPosition(this._lastClipX,this._lastClipY,!0);if(e===null){this._hoveredMesh&&(this._hoverListeners.invoke(this._hoveredMesh,!1),this._hoveredMesh=void 0);return}e!==this._hoveredMesh&&(this._hoveredMesh&&this._hoverListeners.invoke(this._hoveredMesh,!1),this._hoverListeners.invoke(e,!0),this._hoveredMesh=e)}enable(){this._enabled=!0,this._helper.enable(),console.assert(this._hoveredMesh===void 0)}disable(){this._enabled=!1,this._hoveredMesh!==void 0&&(this._hoverListeners.invoke(this._hoveredMesh,!1),this._hoveredMesh=void 0),this._helper.disable()}dispose(){this.disable(),this._gamepadManager.removeEventListener(tr.ACTION_ACTIVATED,this.onGamepadActionActivated)}}function K_(s){return s&1}function $_(s){return s&2}function Z_(s){return s&4}class J_{constructor(e,t){r(this,"_domElement");r(this,"_editMode");r(this,"_pointerDownListeners",new Array);r(this,"_pointerUpListeners",new Array);r(this,"_pointerMoveListeners",new Array);r(this,"_isPointerDown",!1);r(this,"_firstTouchIdentifier",-1);r(this,"_tmpClip",{clipX:0,clipY:0});r(this,"_enabled",!1);r(this,"_onPointerDown",e=>{this._extractButton(e)===0&&(this._isPointerDown||(this._isPointerDown=!0,bs(e)&&(console.assert(e.changedTouches.length>0),this._firstTouchIdentifier=e.changedTouches[0].identifier),this._dispatchEvent(this._pointerDownListeners,e)))});r(this,"_onPointerUp",e=>{if(this._extractButton(e)!==0)return;const i=bs(e);i&&this._findTouch(e,this._firstTouchIdentifier,!0)||this._isPointerDown&&(this._isPointerDown=!1,this._dispatchEvent(this._pointerUpListeners,e),i&&(this._firstTouchIdentifier=-1))});r(this,"_onPointerMove",e=>{bs(e)&&this._firstTouchIdentifier===-1||this._dispatchEvent(this._pointerMoveListeners,e)});this._domElement=e,this._editMode=t,this.enable()}_extractButton(e){if(bs(e)||e.button===void 0)return 0;switch(e.button){case 0:return 0;case 1:return 1;case 2:return 2}return-1}_isPointerLockActive(){const e=document;return!!(e.pointerLockElement||e.mozPointerLockElement||e.webkitPointerLockElement)}_findTouch(e,t,i=!1){if(!i)for(let n=0;n<e.changedTouches.length;n++){const o=e.changedTouches[n];if(o.identifier===t)return o}for(let n=0;n<e.touches.length;n++){const o=e.touches[n];if(o.identifier===t)return o}}_extractPosition(e){let t=0,i=0;const n=bs(e);if(!n&&this._isPointerLockActive())return this._tmpClip.clipX=0,this._tmpClip.clipY=0,this._tmpClip;if(n){const o=this._findTouch(e,this._firstTouchIdentifier);Ke(o!==void 0),t=o.clientX,i=o.clientY}else t=e.clientX,i=e.clientY;return this._tmpClip.clipX=t/window.innerWidth*2-1,this._tmpClip.clipY=-(i/window.innerHeight)*2+1,this._tmpClip}_getEventKeyModifiers(e){let t=0;return(e.ctrlKey&&!Qe.mac||e.metaKey&&Qe.mac)&&(t|=2),e.altKey&&(t|=4),e.shiftKey&&(t|=1),t}_dispatchEvent(e,t){if(e.length===0)return;const i=this._extractPosition(t);for(const n of e)if(n.callback(i.clipX,i.clipY,this._getEventKeyModifiers(t)))return}_registerEventListeners(){this._domElement.addEventListener("mousedown",this._onPointerDown,!1),this._domElement.addEventListener("touchstart",this._onPointerDown,!1),this._domElement.addEventListener("mouseup",this._onPointerUp,!1),this._domElement.addEventListener("touchend",this._onPointerUp,!1),this._domElement.addEventListener("mousemove",this._onPointerMove,!1),this._domElement.addEventListener("touchmove",this._onPointerMove,!1),window.addEventListener("mouseup",this._onPointerUp,!1),this._editMode&&window.top.addEventListener("mouseup",this._onPointerUp,!1)}_unregisterEventListeners(){this._domElement.removeEventListener("mousedown",this._onPointerDown,!1),this._domElement.removeEventListener("touchstart",this._onPointerDown,!1),this._domElement.removeEventListener("mouseup",this._onPointerUp,!1),this._domElement.removeEventListener("touchend",this._onPointerUp,!1),this._domElement.removeEventListener("mousemove",this._onPointerMove,!1),this._domElement.removeEventListener("touchmove",this._onPointerMove,!1),window.removeEventListener("mouseup",this._onPointerUp,!1),this._editMode&&window.top.removeEventListener("mouseup",this._onPointerUp,!1)}_addListener(e,t,i){const n=e.filter(l=>l.callback===t);console.assert(n.length===0,"Do not add the same callback twice!");const o={callback:t,priority:i};let a=0;for(a=0;a<e.length;a+=1){const l=e[a];if(o.priority<=l.priority){if(o.priority===l.priority){console.error("Adding two listeners with the same priority is not allowed!");return}break}}e.splice(a,0,o)}addPointerDownListener(e,t){this._addListener(this._pointerDownListeners,e,t)}removePointerDownListener(e){this._pointerDownListeners=this._pointerDownListeners.filter(t=>t.callback!==e)}addPointerUpListener(e,t){this._addListener(this._pointerUpListeners,e,t)}removePointerUpListener(e){this._pointerUpListeners=this._pointerUpListeners.filter(t=>t.callback!==e)}addPointerMoveListener(e,t){this._addListener(this._pointerMoveListeners,e,t)}removePointerMoveListener(e){this._pointerMoveListeners=this._pointerMoveListeners.filter(t=>t.callback!==e)}isEnabled(){return this._enabled}enable(){this._enabled||(this._registerEventListeners(),this._enabled=!0)}disable(){this._enabled&&(this._unregisterEventListeners(),this._enabled=!1)}}const qc=.005,eg=.02,tg=[new Ce(0,1),new Ce(1,0),new Ce(-1,0),new Ce(0,-1)];class ig{constructor(e,t,i){r(this,"collider");r(this,"controls");r(this,"animationController");r(this,"enabled",!0);r(this,"toGround",1/0);r(this,"cameraPosition");r(this,"prevCameraPosition",new F);this.collider=e,this.controls=t,this.animationController=i,this.cameraPosition=this.controls.cameraWorldPosition(),this.enable()}_heightNeedsUpdate(){const e=this.controls.cameraHeight;return e===null?!1:this.toGround<e-qc||this.toGround>e+qc}_calculateGroundDistance(e,t,i){const a=new F,l=[e];return tg.forEach(c=>{a.copyFrom(t),a.x+=c.x*.1,a.y+=c.y*.1;const h=this.collider.distanceToGroundFrom(a,i*(1+.1));isFinite(h)&&l.push(h)}),l.reduce((c,h)=>Math.min(c,h),1/0)}updateCameraHeight(e){if(!this.enabled)return;const t=this.cameraPosition.z-this.prevCameraPosition.z;if(this.cameraPosition.x!==this.prevCameraPosition.x||this.cameraPosition.y!==this.prevCameraPosition.y?this.toGround=this.collider.distanceToGround(M.MAX_GROUND_SEARCH_DEPTH):this.toGround!==1/0&&(this.toGround+=t),this.toGround!==1/0&&(this.controls.cameraHeight!==null?(this.controls.cameraHeight+=t,this.controls.cameraHeight=Math.max(eg,this.controls.cameraHeight)):this.controls.cameraHeight=this.toGround,this._heightNeedsUpdate())){const n=Math.sqrt(Math.pow(this.cameraPosition.x-this.prevCameraPosition.x,2)+Math.pow(this.cameraPosition.y-this.prevCameraPosition.y,2))/e,o=Math.max(1.5*n,M.CAMERA_DEFAULT_MOVE_MAX_SPEED),a=this.controls.cameraHeight;this.toGround=this._calculateGroundDistance(this.toGround,this.cameraPosition,a);let l=Math.min(o*e,Math.abs(this.toGround-a));this.toGround>a&&(l=-l),(l<0||this.collider.distanceToCeiling(l+M.MIN_DISTANCE_TO_CEILING)===1/0&&Math.abs(l)>qc)&&(this.cameraPosition.z+=l,this.toGround+=l,this.animationController.requestFrame())}this.prevCameraPosition.copyFrom(this.cameraPosition)}enable(){this.enabled=!0,this.toGround=this.collider.distanceToGround(M.MAX_GROUND_SEARCH_DEPTH),this.toGround!==1/0?this.controls.cameraHeight=this.toGround:this.controls.cameraHeight=null,this.prevCameraPosition.copyFrom(this.cameraPosition)}disable(){this.enabled=!1}isEnabled(){return this.enabled}}/*!
 * Copyright (C) 2019-present unreal engine
 */class ng{constructor(e,t){r(this,"_controls");r(this,"_collider");r(this,"_enabled",!1);r(this,"_prevCameraPositionZ");r(this,"_cameraPosition");r(this,"_receivedHmdPosition",!1);this._controls=e,this._collider=t,this._cameraPosition=e.cameraWorldPosition()}onHmdPositionUpdate(e){this._enabled&&!this._receivedHmdPosition&&e.z>1&&(this._controls.cameraHeight=e.z,this._collider.adjustPointToMatchCameraHeight(this._cameraPosition),this._controls.cameraTransformUpdated(),this._prevCameraPositionZ=this._cameraPosition.z,this._receivedHmdPosition=!0)}onTeleportDone(){this._enabled&&(this._prevCameraPositionZ=this._cameraPosition.z)}updateCameraHeight(){this._enabled&&(this._controls.cameraHeight!==null&&(this._controls.cameraHeight+=this._cameraPosition.z-this._prevCameraPositionZ),this._prevCameraPositionZ=this._cameraPosition.z)}enable(){this._enabled=!0,this._controls.cameraHeight=this._collider.cameraHeightFromPoint(this._cameraPosition),this._controls.cameraHeight===null&&(this._controls.cameraHeight=M.FALLBACK_CAMERA_HEIGHT),this._prevCameraPositionZ=this._cameraPosition.z,this._receivedHmdPosition=!1}disable(){this._enabled=!1,this._controls.cameraHeight=null}}function is(s){let e,t,i,n;this.set=function(o,a,l){console.assert(e===void 0&&t===void 0&&i===void 0&&n===void 0),e=s.autoClear,t=s.autoClearColor,i=s.autoClearDepth,n=s.autoClearStencil,s.autoClear=o||a||l,s.autoClearColor=o,s.autoClearDepth=a,s.autoClearStencil=l},this.restore=function(){console.assert(e!==void 0&&t!==void 0&&i!==void 0&&n!==void 0),s.autoClear=e,s.autoClearColor=t,s.autoClearDepth=i,s.autoClearStencil=n,e=void 0,t=void 0,i=void 0,n=void 0}}const ns=256,bu=64,xu=32;class sg{constructor(e,t){r(this,"_camera",new As(90,1,.1,1e3));r(this,"_sceneRenderTarget");r(this,"_autoClearAlter");r(this,"_targetBuf",new Uint8Array(4*ns*ns));r(this,"_renderer");r(this,"_sphereMesh");r(this,"_canvas");r(this,"_scene");r(this,"_lightProbe");var a;this._setupCamera(),this._canvas=document.createElement("canvas"),this._canvas.width=ns,this._canvas.height=ns,this._renderer=e,this._scene=t,t.sharedMaterialState.builtinLightProbe,this._lightProbe=t.sharedMaterialState.builtinLightProbe;const i=(a=t.sharedMaterialState.lightmapEncoding)!=null?a:xs.RGBM,n=qo.createSphereLightmapTexture(bu,xu,i);n.id="[MaterialBallLightmap]";const o=new gt;o.baseColor.setRGB(1,0,0),o.sharedMaterialState=t.sharedMaterialState,o.configureTransparency(),o.setUniforms(),this._sphereMesh=this._createSphereMesh(o,1,n),this._sceneRenderTarget=this._renderer.createRenderTarget(ns,ns,{minFilter:Z.LINEAR,magFilter:Z.LINEAR}),this._autoClearAlter=new is(this._renderer)}_setupCamera(){this._camera.aspectRatio=1,this._camera.position.set(0,0,1.5),this._camera.lookAt(new F(0,0,0)),this._camera.updateMatrixWorld(),this._camera.updateMatrix(),this._camera.updateProjectionMatrix()}_createSphereMesh(e,t,i){const n=nt.createSphere(t,bu,xu);n.computeBoundingSphere(),n.convertNormalsToSpherical(),n.generateUv1FromUv0();const o=new Bn(null,n,e);return e.lightmapEnabled&&(o.lightmap=i),o.lightProbes=[this._lightProbe],o.frustumCulled=!1,o.userData.hideFromLightProbes=!0,o}render(e){const t=e.disableLightProbe;return this._sphereMesh.material=e,e.disableLightProbe=!1,e.setUniforms(),this._scene.addAuxiliaryObject(this._sphereMesh),this._autoClearAlter.set(!0,!0,!1),this._renderer.renderMeshes([this._sphereMesh],void 0,this._camera,this._sceneRenderTarget),this._renderer.readPixels(ns,ns,this._targetBuf),this._renderer.setRenderTarget(null),this._autoClearAlter.restore(),this._scene.removeAuxiliaryObject(this._sphereMesh),e.disableLightProbe=t,e.setUniforms(),this._targetBuf}renderToCanvas(e){this.render(e);const t=new ImageData(new Uint8ClampedArray(this._targetBuf),ns,ns),i=this._canvas.getContext("2d");if(!i)throw new Error("Could not get 2D rendering context from canvas");return i.putImageData(t,0,0),this._canvas}renderToDataImageUrl(e){return this.renderToCanvas(e),this._canvas.toDataURL("image/png")}}const og=.025,yu=1,Au=.3,rg=1-Au,ag=.4;class lg{constructor(e,t){r(this,"autoExposureEnabled",!1);r(this,"_camera");r(this,"_cameraExposureDelta",0);r(this,"_cameraExposureDeltaPerS",0);r(this,"_cameraExposureDeltaSign",0);r(this,"_currentTargetExposure",0);r(this,"_lastId",0);r(this,"_idToGammaAndExposure",{});r(this,"_idToPriority",{});r(this,"_idsInOrder");r(this,"_lumaMeter");this._camera=e,this._camera.addEventListener(gi.eventType.UPDATED,()=>this._updateTargetExposureAndGamma()),this._lastId=0,this._idToGammaAndExposure={},this._idToPriority={},this._idsInOrder=[],this._lumaMeter=t}setPriority(e,t){this._idToPriority[e]=t}adaptExposure(e=!1,t=!1){if(!(!t&&!this.autoExposureAppliable()))if(e){const{incidentLuma:i,reflectedLuma:n}=this._lumaMeter.measureIncidentAndReflectedLuma();this._onLumaMeasured(i,n,e)}else this._lumaMeter.measureIncidentAndReflectedLumaAsync().then(({incidentLuma:i,reflectedLuma:n})=>{this._onLumaMeasured(i,n,!1)}).catch(i=>{console.error("Async luma measurement failed:",i)})}_onLumaMeasured(e,t,i){const n=e*Au+t*rg,o=Math.pow(n,ag),a=this._camera.autoExposureLumaTarget,l=Math.log2(a/o);this._setTargetExposure(l),this._cameraExposureDelta<og&&(this._cameraExposureDelta=0),i&&this.updateWithoutDelay()}exposureNeedsUpdate(){return this._cameraExposureDelta>0}addManualExposure(e,t,i){return i==null&&(i=this._lastId++),this._idToGammaAndExposure[i]={gamma:t,exposure:e},this._idsInOrder.push(i),this._updateTargetExposureAndGamma(),i}updateManualExposure(e,t,i){this._idToGammaAndExposure[i]&&(this._idToGammaAndExposure[i]={gamma:t,exposure:e},this._updateTargetExposureAndGamma(),this.updateWithoutDelay())}removeManualExposure(e){this._idToGammaAndExposure[e]&&(delete this._idToGammaAndExposure[e],this._idsInOrder.splice(this._idsInOrder.findIndex(t=>t===e),1),this._updateTargetExposureAndGamma())}update(e){if(!this.exposureNeedsUpdate())return;const t=Math.min(this._cameraExposureDeltaPerS*e,this._cameraExposureDelta);this._cameraExposureDelta-=t,this._cameraExposureDelta<1e-5?(this._cameraExposureDelta=0,this._camera.exposure=this._currentTargetExposure):this._camera.exposure+=t*this._cameraExposureDeltaSign}updateWithoutDelay(){this.update(yu)}autoExposureAppliable(){return this.autoExposureEnabled&&this._camera.autoExposure&&!this._manualExposureApplied()}enableAutoExposure(){this.autoExposureEnabled=!0}disableAutoExposure(){this.autoExposureEnabled=!1}_manualExposureApplied(){return this._idsInOrder.length>0}_setTargetExposure(e){this._currentTargetExposure=e,this._cameraExposureDelta=e-this._camera.exposure,this._cameraExposureDeltaSign=Math.sign(this._cameraExposureDelta),this._cameraExposureDelta=Math.abs(this._cameraExposureDelta),this._cameraExposureDeltaPerS=this._cameraExposureDelta/yu}_setTargetExposureAndGamma(e,t){this._setTargetExposure(e),this._camera.gamma=t}_getActiveId(){this._idsInOrder.length>0;let e=1/0,t=this._idsInOrder.at(0);for(const i of this._idsInOrder){const n=this._idToPriority[i]!==void 0?this._idToPriority[i]:1/0;n<e&&(t=i,e=n)}return t}_updateTargetExposureAndGamma(){if(!this._manualExposureApplied()){if(this._camera.autoExposure){this._camera.gamma=this._camera.defaultGamma;return}this._setTargetExposureAndGamma(this._camera.defaultExposure,this._camera.defaultGamma);return}const e=this._idToGammaAndExposure[this._getActiveId()];this._setTargetExposureAndGamma(e.exposure,e.gamma)}}const fn=class fn{static registerIfEnabled(e,t=M.DEBUG){if(M.DEBUG_UI&&t&&"onDebugUi"in e){const i=e.onDebugUi;Ya.instance().registerCallback(e.constructor.name,i.bind(e))}}static beginWindow(e,t,i,n=!1,o=!0){ImGui.SetNextWindowPos(new ImGui.ImVec2(t.x,t.y),o?ImGui.Cond.FirstUseEver:0),ImGui.SetNextWindowSize(new ImGui.ImVec2(i.x,i.y),ImGui.Cond.FirstUseEver);const a=n?ImGui.WindowFlags.NoDecoration|ImGui.WindowFlags.AlwaysAutoResize|ImGui.WindowFlags.NoSavedSettings|ImGui.WindowFlags.NoFocusOnAppearing|ImGui.WindowFlags.NoNav:0;return ImGui.Begin(e,void 0,a)}static endWindow(){ImGui.End()}static header(e){return ImGui.CollapsingHeader(e,ImGui.TreeNodeFlags.DefaultOpen)}static editObject(e){fn.tryToHandleObject(!0,e)||fn.editProperties(e)}static getDisplayString(e,t){if(typeof e[t]=="number")return`${e[t]}`;if(e[t]instanceof Ce){const i=e[t];return`${i.x.toFixed(3)} ${i.y.toFixed(3)}`}else if(e[t]instanceof F){const i=e[t];return`${i.x.toFixed(3)} ${i.y.toFixed(3)} ${i.z.toFixed(3)}`}else if(typeof e[t]=="boolean")return`${e[t]}`}static displayProperty(e,t,i){i=i!=null?i:t.toString();const n=fn.getDisplayString(e,t);return n?(ImGui.Text(`${i}: ${n}`),!0):!1}static editProperty(e,t,i){var a;const n=t.toString()+fn.DebugEditPropSuffix,o=(a=i==null?void 0:i.label)!=null?a:t.toString();if(n in e)mc(e,n)(e);else{if(typeof e[t]=="number")return i!=null&&i.comboItems?ImGui.Combo(o,(l=e[t])=>e[t]=l,i.comboItems,i.comboItems.length):i!=null&&i.asInteger?ImGui.DragInt(o,(l=e[t])=>e[t]=l,i==null?void 0:i.speed,i==null?void 0:i.min,i==null?void 0:i.max):(i==null?void 0:i.min)!==void 0&&(i==null?void 0:i.max)!==void 0?ImGui.SliderFloat(o,(l=e[t])=>e[t]=l,i.min,i.max):ImGui.DragFloat(o,(l=e[t])=>e[t]=l,i==null?void 0:i.speed,i==null?void 0:i.min,i==null?void 0:i.max);if(e[t]instanceof F){const l=e[t];return ImGui.DragFloat3(o,l)}else if(typeof e[t]=="boolean")return ImGui.Checkbox(o,(l=e[t])=>e[t]=l)}return!1}static editProperties(e){let t;for(t in e)if(Object.prototype.hasOwnProperty.call(e,t)){if(typeof e[t]=="object"&&fn.tryToHandleObject(!0,e[t],t))continue;fn.editProperty(e,t)}}static displayObject(e,t){if(fn.tryToHandleObject(!1,e))return;const i=t!=null?t:e.constructor.name;ImGui.CollapsingHeader(i,ImGui.TreeNodeFlags.DefaultOpen)&&fn.displayProperties(e,i)}static displayProperties(e,t,i){let n,o=!1,a=0;const l=ImGui.TableFlags.Borders|ImGui.TableFlags.SizingFixedFit|ImGui.TableFlags.RowBg;if(ImGui.BeginTable(t,2,l)){i&&(ImGui.TableSetupColumn(i),ImGui.TableHeader(i),ImGui.TableHeadersRow());for(n in e)if(Object.prototype.hasOwnProperty.call(e,n)){const c=fn.getDisplayString(e,n);c?(o&&(ImGui.BeginTable(`${t}${a++}`,2,l),o=!1),ImGui.TableNextRow(),ImGui.TableNextColumn(),ImGui.Text(n.toString()),ImGui.TableNextColumn(),ImGui.Text(c)):typeof e[n]=="object"&&(o||(o=!0,ImGui.EndTable()),fn.displayProperties(e[n],t+n.toString(),n.toString()))}o||ImGui.EndTable()}}static tryToHandleObject(e,t,i){const o=(e?fl.customEditClasses:fl.customDisplayClasses).get(t.constructor.name);return o?(i&&ImGui.BulletText(i),ImGui.Indent(),o(t),ImGui.Unindent(),!0):!1}};r(fn,"DebugEditPropSuffix","ImGuiPropEdit"),r(fn,"DebugAccessPropSuffix","ImGuiPropAccess");let ss=fn;class cg{constructor(){r(this,"mouseScroll",new ImGui.Vec2);r(this,"scale",new ImGui.Vec2(1,1));r(this,"scaleSensitivity",.01);r(this,"allowScaleInX",!0);r(this,"allowScaleInY",!0);r(this,"minScale",.1);r(this,"maxScale",25)}renderCanvas(){const e=ImGui.GetCursorScreenPos(),t=ImGui.GetContentRegionAvail();t.x=Math.max(50,t.x),t.y=Math.max(50,t.y);const i=new ImGui.Vec2(e.x+t.x,e.y+t.y),n=ImGui.GetIO(),o=ImGui.GetWindowDrawList();o.AddRectFilled(e,i,ImGui.COL32(50,50,50,255)),o.AddRect(e,i,ImGui.COL32(255,255,255,255)),ImGui.InvisibleButton("canvas",t,ImGui.ButtonFlags.MouseButtonLeft|ImGui.ButtonFlags.MouseButtonRight);const a=ImGui.IsItemActive(),l=new ImGui.Vec2(e.x+this.mouseScroll.x,e.y+this.mouseScroll.y),c=-1;a&&ImGui.IsMouseDragging(ImGui.MouseButton.Right,c)&&(this.mouseScroll.x+=n.MouseDelta.x,this.mouseScroll.y+=n.MouseDelta.y),(this.allowScaleInX||this.allowScaleInY)&&a&&ImGui.IsMouseDragging(ImGui.MouseButton.Left,-1)&&(this.allowScaleInX&&(this.scale.x+=n.MouseDelta.x*this.scaleSensitivity,this.scale.x=Math.min(Math.max(this.minScale,this.scale.x),this.maxScale)),this.allowScaleInY&&(this.scale.y+=n.MouseDelta.y*this.scaleSensitivity,this.scale.y=Math.min(Math.max(this.minScale,this.scale.y),this.maxScale)));const h=ImGui.GetMouseDragDelta(ImGui.MouseButton.Right);ImGui.IsMouseReleased(ImGui.MouseButton.Right)&&h.x===0&&h.y===0&&ImGui.OpenPopupOnItemClick("context"),ImGui.BeginPopup("context")&&(ImGui.Button("Reset view")&&(this.scale.x=1,this.scale.y=1,this.mouseScroll.x=0,this.mouseScroll.y=0),ImGui.EndPopup()),o.PushClipRect(e,i,!0);const d=64,u=this.scale;for(let m=this.mouseScroll.x%(d*u.x);m<t.x;m+=d*u.x)o.AddLine(new ImGui.Vec2(e.x+m,e.y),new ImGui.Vec2(e.x+m,i.y),ImGui.COL32(200,200,200,40));for(let m=this.mouseScroll.y%(d*u.y);m<t.y;m+=d*u.y)o.AddLine(new ImGui.Vec2(e.x,e.y+m),new ImGui.Vec2(i.x,e.y+m),ImGui.COL32(200,200,200,40));return l}}const eo=class eo{static ZeroToOne(e,t){if(!M.DEBUG_UI)return;const i=t,n=i+ss.DebugEditPropSuffix;e&&Object.defineProperty(e,n,{value:o=>{ImGui.DragFloat(i,(a=o[i])=>o[i]=a,.025,0,1)}})}static ImGuiClassPropAccess(e=!0,t=!0){function i(n,o){M.DEBUG_UI&&(e&&eo.customDisplayClasses.set(n.name,a=>{ss.displayProperties(a,n.name)}),t&&eo.customEditClasses.set(n.name,a=>{ss.editProperties(a)}))}return i}static ImGuiCustomDisplay(e){function t(i,n){M.DEBUG_UI&&eo.customDisplayClasses.set(i.name,e)}return t}static ImGuiCustomEdit(e){function t(i,n){M.DEBUG_UI&&eo.customEditClasses.set(i.name,e)}return t}};r(eo,"customDisplayClasses",new Map),r(eo,"customEditClasses",new Map);let fl=eo;const cn=256,hg=16*16,dg=.3,ug=.04;class fg{constructor(e,t){r(this,"_rawRenderer");r(this,"_camera");r(this,"_scene");r(this,"_sceneRenderTarget");r(this,"_autoClearAlter");r(this,"_sceneRenderTargetAsync");r(this,"_autoClearAlterAsync");r(this,"_targetBufAsync",new Uint8Array(4*cn*cn));r(this,"_pboBufferAsync");r(this,"_currentTargetSize",new Ce(cn,cn));r(this,"_histogram",new Uint32Array(255*256));r(this,"_lumaMaterial");r(this,"_asyncReadInProgress",!1);this._rawRenderer=e,this._camera=t.camera,this._scene=t,this._sceneRenderTarget=this._rawRenderer.createRenderTarget(cn,cn,{minFilter:Z.NEAREST,magFilter:Z.NEAREST,stencilBuffer:!1,generateMipmaps:!1}),this._sceneRenderTargetAsync=this._rawRenderer.createRenderTarget(cn,cn,{minFilter:Z.NEAREST,magFilter:Z.NEAREST,stencilBuffer:!1,generateMipmaps:!1}),this._autoClearAlter=new is(this._rawRenderer),this._autoClearAlterAsync=new is(this._rawRenderer),this._lumaMaterial=new X0(this._scene.sharedMaterialState)}isAsyncReadInProgress(){return this._asyncReadInProgress}measureIncidentLumaSync(){const e=this._renderLumaSync();return this._computeMeanLuma(e,0)}measureIncidentAndReflectedLumaSync(){const e=this._renderLumaSync(),t=this._computeMeanLuma(e,0),i=this._computeMeanLuma(e,2);return{incidentLuma:t,reflectedLuma:i}}measureIncidentAndReflectedLumaAsync(){return Dt(this,null,function*(){if(this._asyncReadInProgress)throw new Error("Luma measurement already in progress");this._asyncReadInProgress=!0;try{yield this._renderLumaAsync();const e=this._computeMeanLuma(this._targetBufAsync,0),t=this._computeMeanLuma(this._targetBufAsync,2);return{incidentLuma:e,reflectedLuma:t}}finally{this._asyncReadInProgress=!1}})}_renderLumaAsync(){return Dt(this,null,function*(){const e=this._rawRenderer.renderContext;this._renderLumaToTarget(this._autoClearAlterAsync,this._sceneRenderTargetAsync),this._pboBufferAsync===void 0&&(this._pboBufferAsync=e.createBuffer()),e.bindBuffer(e.PIXEL_PACK_BUFFER,this._pboBufferAsync),e.bufferData(e.PIXEL_PACK_BUFFER,this._targetBufAsync.byteLength,e.STREAM_READ),this._rawRenderer.readPixels(cn,cn,0),this._rawRenderer.setRenderTarget(null),this._autoClearAlterAsync.restore(),e.bindBuffer(e.PIXEL_PACK_BUFFER,null);const t=e.fenceSync(e.SYNC_GPU_COMMANDS_COMPLETE,0);if(!t)throw new Error("Failed to create GL sync object");yield new Promise((i,n)=>{const o=()=>{const a=e.clientWaitSync(t,0,0);if(a===e.TIMEOUT_EXPIRED)requestAnimationFrame(o);else if(a===e.WAIT_FAILED){n(new Error("Sync wait failed"));return}else i()};o()});try{e.bindBuffer(e.PIXEL_PACK_BUFFER,this._pboBufferAsync),e.getBufferSubData(e.PIXEL_PACK_BUFFER,0,this._targetBufAsync)}finally{e.bindBuffer(e.PIXEL_PACK_BUFFER,null),e.deleteSync(t)}})}_renderLumaToTarget(e,t){e.set(!0,!0,!1);const i=this._scene.gpuMeshes.filter(n=>!n.material.transparent);this._rawRenderer.renderMeshes(i,this._lumaMaterial,this._camera,t)}_renderLumaSync(){this._renderLumaToTarget(this._autoClearAlter,this._sceneRenderTarget);const e=new Uint8Array(4*cn*cn);return this._rawRenderer.readPixels(cn,cn,e),this._rawRenderer.setRenderTarget(null),this._autoClearAlter.restore(),e}_computeMeanLuma(e,t=0){let i=0,n=0;const o=this._currentTargetSize.x*this._currentTargetSize.y;for(let h=0;h<o;++h){const d=h*4+t,u=e[d]+e[d+1]*255;u!==0&&(n+=1,this._histogram[u]+=1,i=Math.max(i,u))}if(n<hg)return-1;let a=0,l=0;for(let h=1;h<=i;++h){const d=Math.floor(dg*n-a),u=Math.min(d,this._histogram[h]);if(this._histogram[h]-=u,a+=u,u===d)break}for(let h=i;h>=0;--h){const d=Math.floor(ug*n-l),u=Math.min(d,this._histogram[h]);if(this._histogram[h]-=u,l+=u,u===d)break}let c=0;for(let h=1;h<=i;++h){const u=h/8160;c+=this._histogram[h]*Math.log(u),this._histogram[h]=0}return Math.exp(c/(n-a-l))}}class mg{constructor(e,t){r(this,"_rawRenderer");r(this,"_scene");r(this,"_debug");r(this,"_implementation");this._rawRenderer=e,this._scene=t}_getImplementation(){return this._implementation||(this._implementation=new fg(this._rawRenderer,this._scene)),this._implementation}measureIncidentAndReflectedLumaAsync(){return Dt(this,null,function*(){const e=this._getImplementation();return e.isAsyncReadInProgress()?Promise.reject(new Error("Luma measurement already in progress")):e.measureIncidentAndReflectedLumaAsync()})}measureIncidentLuma(){return this._getImplementation().measureIncidentLumaSync()}measureIncidentAndReflectedLuma(){return this._getImplementation().measureIncidentAndReflectedLumaSync()}onDebugUi(){ss.beginWindow("Luma Meter",{x:0,y:0},{x:300,y:200}),ss.displayProperty(this._debug,"lastIncidentLuma","Incident Luma"),ss.displayProperty(this._debug,"lastReflectedLuma","Reflected Luma"),M.DEBUG_SPECTOR&&ImGui.Button("Capture")&&(this._debug.debugCapture=!0),ImGui.Button("Dump results to file")&&(this._debug.dumpResultName="LumaMeter"),ss.endWindow()}}const Or=4096;class pg extends Ht{constructor(e){super({vsName:gt.vertexShaderName,vsHooks:gt.vertexShaderHooks,fsName:"shadowmap_fragment.glsl"}),this.sharedMaterialState=e}}class _g{constructor(e){r(this,"forward");r(this,"right");r(this,"up");r(this,"invRotationMatrix");r(this,"rotationMatrix");r(this,"scale",new F);r(this,"translation",new F);this.forward=e.clone().normalize(),this.up=new F(0,0,1),this.forward.dot(this.up)>.9&&this.up.set(0,1,0),this.right=this.up.clone().cross(this.forward).normalize(),this.up.crossVectors(this.forward,this.right).normalize();const t=new Ho().set(this.right.x,this.right.y,this.right.z,this.up.x,this.up.y,this.up.z,-this.forward.x,-this.forward.y,-this.forward.z),i=t.clone();i.transpose(),this.rotationMatrix=t.toMatrix4(),this.invRotationMatrix=i.toMatrix4()}fit(e){const t=new ti,i=new F;for(const n of e)for(let o=0;o<8;o++)i.set(o&1?n.max.x:n.min.x,o&2?n.max.y:n.min.y,o&4?n.max.z:n.min.z),this.rotationMatrix.affineTransformPoint3(i),t.expandByPoint(i);return t}}function gg(s,e,t){const i=Qa(e),n=Ka(e);s.texImage2D(Z.TEXTURE_2D,0,e,t.x,t.y,0,i,n,null)}const _a=class _a{constructor(e){r(this,"_rawRenderer");r(this,"_material");r(this,"_depthFbo");r(this,"_depthTexture");r(this,"_renderTarget");r(this,"_skippedFrameCounter",_a.SKIP_FRAMES-1);this._rawRenderer=e;const t=e.renderContext;this._depthTexture=t.createTexture(),t.bindTexture(Z.TEXTURE_2D,this._depthTexture),gg(t,Be.DEPTH32F,new Ce(Or,Or)),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,Z.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,Z.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,Z.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,Z.CLAMP_TO_EDGE),this._depthFbo=t.createFramebuffer(),t.bindFramebuffer(t.FRAMEBUFFER,this._depthFbo),t.framebufferTexture2D(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,Z.TEXTURE_2D,this._depthTexture,0),t.drawBuffers([Z.NONE]),t.bindFramebuffer(t.FRAMEBUFFER,null),this._renderTarget={x:0,y:0,width:Or,height:Or,webglFramebuffer:this._depthFbo,isCube:!1}}_getSunDirection(e){const t=new F(0,-1,0);return e.instances[0].rotation.applyToVector3(t),t}getTexture(){return{webglTexture:this._depthTexture,webglSlot:null,needsUpdate:!1}}generate(e){if(this._skippedFrameCounter++,this._skippedFrameCounter<_a.SKIP_FRAMES)return;this._skippedFrameCounter=0;const t=e.sharedMaterialState;this._material||(this._material=new pg(t));const i=e.lightManager.getSunLight();if(!i){t.shadowmapInfo=void 0;return}const n=this._getSunDirection(i),o=new tt(n.x,n.y,n.z,0);n.negate();const a=e.boundingBox,l=new _g(n),c=l.fit([a]),h=.001,d=new Li(c.min.x,c.max.x,c.max.y,c.min.y,-c.max.z-h,-c.min.z+h);d.matrix.identity(),d.matrixWorldInverse=l.rotationMatrix.clone(),d.matrixWorld.getInverse(d.matrixWorldInverse);const u=new at;u.multiplyMatrices(d.projectionMatrix,d.matrixWorldInverse);const m=new ti,g=new F;for(const C of[a])for(let I=0;I<8;I++)g.set(I&1?C.max.x:C.min.x,I&2?C.max.y:C.min.y,I&4?C.max.z:C.min.z),u.affineTransformPoint3(g),m.expandByPoint(g);this._rawRenderer.forceDoubleSided(!0);const b=e.gpuMeshes.filter(C=>!C.material.transparent);this._rawRenderer.renderMeshes(b,this._material,d,this._renderTarget);const x=e.gpuMeshes.filter(C=>C.material.isCutoutEnabled()),v=this._rawRenderer.autoClear;this._rawRenderer.autoClear=!1;for(const C of x)C.material.setRenderCutoutMode(!0);this._rawRenderer.renderMeshes(x,void 0,d,this._renderTarget);for(const C of x)C.material.setRenderCutoutMode(!1);this._rawRenderer.autoClear=v,this._rawRenderer.forceDoubleSided(null);const E={webglTexture:this._depthTexture,webglSlot:null,needsUpdate:!1},w=d.projectionMatrix.clone();d.matrixWorldInverse.getInverse(d.matrixWorld),w.multiply(d.matrixWorldInverse),t.shadowmapInfo=new A0(E,Or,w,o)}};r(_a,"SKIP_FRAMES",4);let Yc=_a;class nr extends ft{constructor(){super(),this.overrideMaterial=null,this.autoUpdate=!0}clone(e){return e===void 0&&(e=new nr),ft.prototype.clone.call(this,e),this.overrideMaterial!==null&&(e.overrideMaterial=this.overrideMaterial.clone()),e.autoUpdate=this.autoUpdate,e.matrixAutoUpdate=this.matrixAutoUpdate,e}}class vg extends Ht{constructor(e){super({vsName:gt.vertexShaderName,vsHooks:gt.vertexShaderHooks,fsName:"ssao_input_fragment.glsl"}),this.sharedMaterialState=e}}class bg{constructor(e=2,t=.25,i=2){this.radius=e,this.falloffStart2=t,this.falloffEnd2=i}}class xg extends Ht{constructor(e,t,i,n){super({vsName:gt.vertexShaderName,vsHooks:gt.vertexShaderHooks,fsName:"ssao_fragment.glsl"}),this.normalsTexture=t,this.depthTexture=i,this.backDepthTexture=n,this.sharedMaterialState=e,this.setUniform("tNormalsTex","t",t,le.MATERIAL),this.setUniform("tDepthTex","t",i,le.MATERIAL),n&&this.setUniform("tBackDepthTex","t",n,le.MATERIAL),this.condDefine(!!n,"USE_BACK_DEPTH")}setUniforms(e,t,i,n){const o=e.clone();o.invert(),this.setUniform("uProjectionMatrix","m4",e,le.MATERIAL),this.setUniform("uInvProjectionMatrix","m4",o,le.MATERIAL);for(let u=0;u<4;u++){const m=u&1?1:-1,g=u&2?1:-1,b=new F(m,g,-1),x=new F(m,g,1);o.transformPoint3(b),o.transformPoint3(x);const v=new F;v.subVectors(x,b),v.divideScalar(v.z);const E=new tt(v.x,v.y,v.z,0);this.setUniform(`uViewFrustumVectors[${u}]`,"v4",E,le.MATERIAL)}this.setUniform("uViewportSize","v2",t,le.MATERIAL);const a=new Ce(1,1).divide(t);this.setUniform("uInvViewportSize","v2",a,le.MATERIAL);const l=new Ce(t.x-1,t.y-1);this.setUniform("uViewportSizeMinusOne","v2",l,le.MATERIAL);const c=new Ce(1,1).divide(l);this.setUniform("uInvViewportSizeMinusOne","v2",c,le.MATERIAL);const h=.5*(t.y/(2*Math.tan(qt(i)*.5))),d=new tt(n.radius,h,n.falloffStart2,n.falloffEnd2);this.setUniform("uSsaoConfig","v4",d)}}function ml(s,e,t){const i=Qa(e),n=Ka(e);s.texImage2D(Z.TEXTURE_2D,0,e,t.x,t.y,0,i,n,null)}const Do=class Do{constructor(e,t){r(this,"_rawRenderer");r(this,"_inputMaterial");r(this,"_backDepthMaterial");r(this,"_material");r(this,"_fullRenderSize");r(this,"_renderSize");r(this,"_depthTexture");r(this,"_normalsTexture");r(this,"_depthNormalsFbo");r(this,"_depthNormalsRT");r(this,"_backDepthTexture");r(this,"_backDepthFbo");r(this,"_backDepthRT");r(this,"_ssaoTexture");r(this,"_ssaoFbo");r(this,"_ssaoRT");r(this,"_nearPlaneWarning",!1);this._rawRenderer=e,this.updateRenderSize(),t.gl.extension("EXT_color_buffer_float")}updateRenderSize(){var i;const e=this._rawRenderer.renderContext,t=new Ce(e.drawingBufferWidth,e.drawingBufferHeight);this._fullRenderSize=t.clone(),t.multiplyScalar(Do.SSAO_SCALE),!((i=this._renderSize)!=null&&i.equals(t))&&(this._renderSize=t,console.log("SSAO render size updated",t.x,t.y),this._material=void 0,this._inputMaterial=void 0,this._backDepthFbo=void 0,this._depthTexture=e.createTexture(),e.bindTexture(Z.TEXTURE_2D,this._depthTexture),ml(e,Be.DEPTH32F,this._renderSize),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,Z.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,Z.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,Z.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,Z.CLAMP_TO_EDGE),this._backDepthTexture=e.createTexture(),e.bindTexture(Z.TEXTURE_2D,this._backDepthTexture),ml(e,Be.DEPTH32F,this._renderSize),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,Z.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,Z.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,Z.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,Z.CLAMP_TO_EDGE),this._normalsTexture=e.createTexture(),e.bindTexture(Z.TEXTURE_2D,this._normalsTexture),ml(e,Be.RGBA32F,this._renderSize),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,Z.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,Z.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,Z.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,Z.CLAMP_TO_EDGE),e.bindTexture(Z.TEXTURE_2D,null),this._depthNormalsFbo=e.createFramebuffer(),e.bindFramebuffer(e.FRAMEBUFFER,this._depthNormalsFbo),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,Z.TEXTURE_2D,this._normalsTexture,0),e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,Z.TEXTURE_2D,this._depthTexture,0),e.drawBuffers([e.COLOR_ATTACHMENT0]),e.bindFramebuffer(e.FRAMEBUFFER,null),this._depthNormalsRT={x:0,y:0,width:t.x,height:t.y,webglFramebuffer:this._depthNormalsFbo,isCube:!1},this._backDepthFbo=e.createFramebuffer(),e.bindFramebuffer(e.FRAMEBUFFER,this._backDepthFbo),e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,Z.TEXTURE_2D,this._backDepthTexture,0),e.drawBuffers([]),e.bindFramebuffer(e.FRAMEBUFFER,null),this._backDepthRT={x:0,y:0,width:t.x,height:t.y,webglFramebuffer:this._backDepthFbo,isCube:!1},this._ssaoTexture=e.createTexture(),e.bindTexture(Z.TEXTURE_2D,this._ssaoTexture),ml(e,Be.RGBA8,this._renderSize),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,Z.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,Z.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,Z.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,Z.CLAMP_TO_EDGE),e.bindTexture(Z.TEXTURE_2D,null),this._ssaoFbo=e.createFramebuffer(),e.bindFramebuffer(e.FRAMEBUFFER,this._ssaoFbo),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,Z.TEXTURE_2D,this._ssaoTexture,0),e.drawBuffers([e.COLOR_ATTACHMENT0]),e.bindFramebuffer(e.FRAMEBUFFER,null),this._ssaoRT={x:0,y:0,width:t.x,height:t.y,webglFramebuffer:this._ssaoFbo,isCube:!1})}getTexture(){return{webglTexture:this._ssaoTexture,webglSlot:null,needsUpdate:!1}}generate(e){this.updateRenderSize(),this._renderSize;const t=e.sharedMaterialState,i={webglTexture:this._depthTexture,webglSlot:null,needsUpdate:!1},n=void 0,o={webglTexture:this._normalsTexture,webglSlot:null,needsUpdate:!1},a={webglTexture:this._ssaoTexture,webglSlot:null,needsUpdate:!1};this._inputMaterial||(this._inputMaterial=new vg(t)),this._material||(this._material=new xg(t,o,i,n));const l=e.camera;l.near<.25&&!this._nearPlaneWarning&&(this._nearPlaneWarning=!0,console.warn("Near plane is set to a very low value, this may cause rendering artifacts with SSAO."));const c=new bg(2,2,8);this._material.setUniforms(l.projectionMatrix,this._renderSize,l.fov,c);const h=this._rawRenderer.autoClear,d=this._rawRenderer.autoClearColor,u=this._rawRenderer.autoClearDepth,m=e.gpuMeshes.filter(I=>!I.material.transparent),g=e.gpuMeshes.filter(I=>I.material.isCutoutEnabled());this._rawRenderer.autoClearColor=!0,this._rawRenderer.autoClearDepth=!0,this._rawRenderer.forceDoubleSided(!0);{this._rawRenderer.autoClear=!0,this._rawRenderer.renderMeshes(m,this._inputMaterial,l,this._depthNormalsRT),this._rawRenderer.autoClear=!1;for(const I of g)I.material.setRenderCutoutMode(!0);this._rawRenderer.renderMeshes(g,void 0,l,this._depthNormalsRT);for(const I of g)I.material.setRenderCutoutMode(!1)}const b=this._rawRenderer.renderContext;b.disable(b.DEPTH_TEST),this._rawRenderer.forceDoubleSided(null);const x=Li.createNDC(),v=new Ye(nt.createPlane(2,2),this._material);new nr().add(v),this._rawRenderer.renderMeshes([v],this._material,x,this._ssaoRT),this._rawRenderer.autoClear=h,this._rawRenderer.autoClearColor=d,this._rawRenderer.autoClearDepth=u,b.enable(b.DEPTH_TEST),this._fullRenderSize;const w=this._fullRenderSize.clone(),C=new Ce(1,1).divide(w);t.ssaoInfo=new y0(a,i,o,w,C,Do.DEBUG)}};r(Do,"DEBUG",!0),r(Do,"ENABLE_BACK_DEPTH",!1),r(Do,"SSAO_SCALE",.5);let Qc=Do;const pl={};function Kc(s,e,t){pl[s]={name:s,value:e,fontFamily:t}}function ke(s,e){Kc(s,e,"FontAwesomeSolid")}function bo(s,e){Kc(s,e,"FontAwesomeRegular")}function Un(s,e){Kc(s,e,"FontAwesomeBrands")}ke("address-book",""),ke("address-card",""),ke("area-chart",""),ke("arrows",""),ke("arrow-up",""),ke("arrow-down",""),ke("assistive-listening-systems",""),ke("asterisk",""),ke("audio-description",""),ke("at",""),ke("bars",""),ke("bell",""),ke("book",""),ke("bookmark",""),ke("bullhorn",""),ke("calculator",""),ke("camera",""),ke("chart-bar",""),ke("chart-pie",""),ke("chevron-up",""),ke("chevron-down",""),ke("cloud",""),ke("cog",""),ke("comment",""),bo("compass",""),bo("credit-card",""),ke("crosshairs",""),ke("desktop",""),ke("download",""),ke("envelope",""),ke("expand",""),ke("external-link",""),bo("eye",""),ke("eye-dropper",""),ke("film",""),ke("flag",""),ke("folder",""),ke("gift",""),ke("headphones",""),ke("highlighter",""),ke("home",""),bo("image",""),ke("sign-in",""),ke("info",""),bo("lightbulb",""),ke("magic",""),ke("magnet",""),ke("map-marker",""),ke("map-pin",""),ke("map-signs",""),ke("paint-brush",""),ke("pencil",""),ke("pen",""),ke("phone",""),ke("question",""),ke("search",""),ke("share",""),ke("share-alt",""),ke("shopping-cart",""),ke("sliders",""),ke("star",""),bo("sticky-note",""),ke("sync",""),bo("edit",""),ke("tachometer",""),ke("tag",""),ke("video",""),ke("wrench",""),ke("palette",""),ke("paint-roller",""),ke("play",""),ke("pause",""),ke("plus",""),Un("youtube",""),Un("vimeo",""),Un("facebook",""),Un("twitter",""),Un("instagram",""),Un("linkedin",""),Un("skype",""),Un("whatsapp",""),Un("facebook-messenger",""),Un("telegram",""),Un("slack","");const Br=512,yg=Math.PI*(70/180),Ag=Math.floor(Br*(.5-.5*Math.sin(yg/2))),Eu=Br-2*Ag,Tu=2048;var Su=(s=>(s.SPHERE="sphere",s.SPRITE="sprite",s))(Su||{});class Eg{constructor(e){r(this,"icon");r(this,"text");r(this,"imagePath");r(this,"font");r(this,"color");r(this,"opacity");r(this,"textColor");r(this,"type");r(this,"position");r(this,"radius");r(this,"height");r(this,"borderRadius");const t=new tn(e),i=t.parseString("icon"),n=i?pl[i]:void 0;this.text=n?n.value:t.parseString("text",""),this.imagePath=t.parseString("image"),this.font=n?n.fontFamily:"Open Sans",this.color=t.parseString("color","#4c9ed9"),this.opacity=t.parseNumber("opacity",1),this.textColor=t.parseString("textColor","#ffffff"),this.type=t.parseEnum("type",Su,"sprite"),this.position=t.parseNumbers("position"),this.radius=t.parseNumber("radius",.1),this.height=t.parseNumber("height",.2),this.borderRadius=t.parseNumber("borderRadius",0)}colorWithOpacity(){return vs.combineColorWithOpacity(this.color,this.opacity)}hasAlpha(){return this.opacity<1}}class Tg{constructor(e){r(this,"usedTimes",1);r(this,"texture");this.texture=e}}class $c{constructor(){r(this,"sphereGeometry");r(this,"planeGeometry");r(this,"planeColliderGeometry");r(this,"texturesCache",new Map);r(this,"_debugColliderMaterial");this.sphereGeometry=nt.createSphere(1,32,16),this.sphereGeometry.convertNormalsToSpherical(),this.planeGeometry=nt.createPlane(1,1),this.planeGeometry.convertNormalsToSpherical();const e=new at;e.makeRotationX(Math.PI/2),this.planeColliderGeometry=nt.createCylinder(.5,.5,1,16,1),this.planeColliderGeometry.applyMatrix(e),this.planeColliderGeometry.convertNormalsToSpherical()}debugColliderMaterial(){return this._debugColliderMaterial||(this._debugColliderMaterial=new gt,this._debugColliderMaterial.opacity=.7,this._debugColliderMaterial.baseColor.setRGB(1,0,0),this._debugColliderMaterial.setUniforms()),this._debugColliderMaterial}static getInstance(e){let t=e.get("anchor_render_cache");return t||(t=new $c,e.set("anchor_render_cache",t)),t}}function Sg(s,e,t,i,n,o){const a=o*.5*Math.min(i,n);s.beginPath(),s.moveTo(e+a,t),s.lineTo(e+i-a,t),s.quadraticCurveTo(e+i,t,e+i,t+a),s.lineTo(e+i,t+n-a),s.quadraticCurveTo(e+i,t+n,e+i-a,t+n),s.lineTo(e+a,t+n),s.quadraticCurveTo(e,t+n,e,t+n-a),s.lineTo(e,t+a),s.quadraticCurveTo(e,t,e+a,t),s.closePath(),s.fill()}function _l(s,e){return`400 ${s}px ${e}`}function wg(s,e,t){s.font=_l(128,t);const n=s.measureText(e).width;let o=Math.floor(128*(Eu/n));o=Math.min(o,Eu),s.font=_l(o,t)}function Mg(s,e,t){s.width=Br,s.height=Br;const i=s.getContext("2d");return wg(i,e,t),i}function Pg(s,e,t,i){const n=M.SPRITE_ANCHOR_FONT_SIZE;let o=s.getContext("2d");o.font=_l(n,t);let a=e,l=e.length-1,c,h;for(;c=o.measureText(a).width,h=c+2*i,!(h<=Tu);)a=e.substring(0,l)+"...",--l;const d=1.5*n;return s.width=h,s.height=d,o=s.getContext("2d"),o.font=_l(n,t),[o,a]}function wu(s,e,t){const i=s.getContext("2d");i.fillStyle=e,t?Sg(i,0,0,s.width,s.height,t):i.fillRect(0,0,s.width,s.height)}function Cg(s,e,t,i,n){const o=document.createElement("canvas");return o.width=e,o.height=t,wu(o,i,n),o.getContext("2d").drawImage(s,0,0,e,t),o}function Rg(s,e){const t=new dt;t.hasAlpha=s.hasAlpha();const i=o=>{const a=s.type=="sphere"?Br:Tu;let l=o.naturalWidth,c=o.naturalHeight;return l>=c&&l>a?(c=c/l*a,l=a):c>l&&c>a&&(l=l/c*a,c=a),[Math.round(l),Math.round(c)]},n=o=>{[t.width,t.height]=i(o),t.image=Cg(o,t.width,t.height,s.colorWithOpacity(),s.borderRadius),t.needsUpdate=!0,t.notifyLoaded()};return Ld(M.LOAD_PRIORITY.CORE_RESOURCE,e,o=>n(o),()=>console.log(`Failed to load trigger image: ${e}`)),t}function Ig(s,e){const t=document.createElement("canvas");let i,n=s.text;s.type=="sphere"?i=Mg(t,n,s.font):[i,n]=Pg(t,n,s.font,e),wu(t,s.colorWithOpacity(),s.borderRadius),i.fillStyle=s.textColor,i.textAlign="center",i.textBaseline="middle",i.shadowColor="black",i.shadowBlur=16,i.fillText(n,t.width/2,t.height/2);const o=new dt(t);return o.width=t.width,o.height=t.height,o.anisotropy=dt.NO_ANISOTROPY,o.hasAlpha=s.hasAlpha(),o.minFilter=Z.LINEAR,o.loadingStatus=ys.COMPLETED,o.needsUpdate=!0,o}function Dg(s,e){var a,l;const i=[(a=e.icon)!=null?a:"",e.text,(l=e.imagePath)!=null?l:"",e.font,e.colorWithOpacity(),e.textColor,e.type=="sphere",20,e.borderRadius,e.hasAlpha()].join("_"),n=s.get(i);if(n)return n.usedTimes++,[e.color,e.textColor,i,n.texture];let o;return e.imagePath?o=Rg(e,wr(e.imagePath)):o=Ig(e,20),s.set(i,new Tg(o)),[e.color,e.textColor,i,o]}class Ys extends Ye{constructor(t,i,n){const o=new Eg(n),a=$c.getInstance(i),l=new F;l.fromArray(o.position);const[c,h,d,u]=Dg(a.texturesCache,o),m=new be;m.setStyle(c),m.convertGammaToLinear();const g=new be;g.setStyle(h),g.convertGammaToLinear();let b,x,v,E,w;o.type==="sphere"?(b=a.sphereGeometry,E=new F0,v=t.closestLightProbe(l),o.imagePath||(E.bumpTexture=u),E.disableLightProbe=v===null||!v.texturesReady(),E.headLight=!0):(o.type=="sprite",b=a.planeGeometry,E=new tu,v=null,E.headLight=!1,E.reflective=!1,w=new Ye(a.planeColliderGeometry,E)),E.baseColor=m,E.baseColorTexture=u,E.configureTransparency(),E.setUniforms();super(b,E);r(this,"color");r(this,"textColor");r(this,"colliderMesh");r(this,"_texturesCache");r(this,"_textureSignature");this._texturesCache=a.texturesCache,this._textureSignature=d,this.color=m,this.textColor=g,this.visible=!1,this.position.copyFrom(l),this.lightProbes=[v],w?(w.position.copyFrom(l),this.colliderMesh=w,this.colliderMesh.visible=!1):this.colliderMesh=this,this.colliderMesh.visibilityId=null,this.colliderMesh.anchor=this,u.addLoadedListener(()=>{if(o.type==="sphere"?x=[o.radius,o.radius,o.radius]:(E.baseColorTexture instanceof dt,x=[E.baseColorTexture.width/E.baseColorTexture.height*o.height,o.height,1]),this.scale.fromArray(x),this.updateMatrixWorld(!0),w){const C=Math.max(x[0],x[1]),I=o.height;w.scale.fromArray([C,C,I]),w.updateMatrixWorld(!0),w.visible=!0}this.visible=!0,Ui().requestFrame()})}dispose(){const t=this.material;t.dispose();const i=this._textureSignature,n=this._texturesCache.get(i),o=n.texture;t.baseColorTexture,setTimeout(()=>{n.usedTimes--,n.usedTimes===0&&(o.dispose(),this._texturesCache.delete(i))},5e3)}enableLightProbe(){if(this.lightProbes.length>0&&this.lightProbes[0]){Ke(this.lightProbes[0].texturesReady());const t=this.material;t.disableLightProbe=!1,t.setUniforms()}}}var hn=(s=>(s.TWO_STATE="twoState",s.MULTI_STATE="multiState",s.IMPULSE="impulse",s))(hn||{});const Lg={"":"address-book","":"address-card","":"area-chart","":"arrows","":"arrow-up","":"arrow-down","":"assistive-listening-systems","":"asterisk","":"audio-description","":"at","":"bars","":"bell","":"book","":"bookmark","":"bullhorn","":"calculator","":"camera","":"chart-bar","":"chart-pie","":"cloud","":"cog","":"comment","":"compass","":"credit-card","":"crosshairs","":"download","":"envelope","":"external-link","":"eye","":"eye-dropper","":"film","":"flag","":"folder","":"gift","":"headphones","":"home","":"image","":"sign-in","":"info","":"lightbulb","":"magic","":"magnet","":"map-marker","":"map-pin","":"map-signs","":"paint-brush","":"pencil","":"phone","":"question","":"share","":"share-alt","":"shopping-cart","":"sliders","":"star","":"tachometer","":"tag","":"video","":"wrench","":"play","":"youtube","":"vimeo","":"facebook","":"twitter","":"instagram"};class Fg{constructor(){r(this,"_callbacks");this._callbacks=[]}size(){return this._callbacks.length}addCallback(e){this._callbacks.push(e)}removeCallback(e){this._callbacks=this._callbacks.filter(t=>t!==e)}onNodeTypeClicked(e,t,i){return this._callbacks.forEach(n=>{try{n(e,t,i)}catch(o){console.error(o)}}),!0}}class Og{constructor(){r(this,"_nodeTypeToListenerMulti");r(this,"_listeners");this._nodeTypeToListenerMulti=new Map,this._listeners=new Map}_getMultiListener(e){let t=this._nodeTypeToListenerMulti.get(e);return t===void 0&&(t=new Fg,this._nodeTypeToListenerMulti.set(e,t),this._listeners.set(e,t.onNodeTypeClicked.bind(t))),t}onNodeTypeClicked(e,t){const i=this._getMultiListener(e);return i.addCallback(t),i.size()===1&&Ui().onNodeTypeClicked(e,this._listeners.get(e)),t}removeOnNodeTypeClicked(e,t){const i=this._nodeTypeToListenerMulti.get(e);if(i===void 0){Ke(i,`listenerMulti not registered for ${e}`);return}i.removeCallback(t),i.size()===0&&(Ui().removeOnNodeTypeClicked(e,this._listeners.get(e)),this._nodeTypeToListenerMulti.delete(e))}}const Mu=new Og;class os{constructor(e){r(this,"_anchors",new Array);r(this,"_nodeListeners",new Array);r(this,"_enabled");r(this,"triggers",new Array);r(this,"definition");r(this,"viewerApi");r(this,"running",!1);r(this,"config");r(this,"triggersVisible",!0);var t;this.triggersVisible=!0,this.definition=this.constructor.definition,this.viewerApi=Ui(),this.config=Tr(this.migrateConfig(e)),this._enabled=(t=this.config.enabled)!=null?t:!0,this.viewerApi.onVrChange(this._vrChanged.bind(this))}_installTriggers(){this.config.trigger&&this.addTrigger(this.config.trigger,(e,t)=>this.trigger(t))}isTriggerable(){return!1}trigger(e){}doDispose(){}doInit(){this.viewerApi.onSceneReadyToDisplay(()=>this._installTriggers())}hasProperty(e){return this.definition.properties.some(t=>t.id===e)}migrateConfig(e){var t;if(e=An(e),e.anchor!==void 0&&e.trigger===void 0&&!this.hasProperty("anchor")&&this.hasProperty("trigger")){const i=e.anchor,n=i.icon;n&&n.font&&(i.icon=Lg[n.value]),e.trigger=i,e.anchor=void 0}for(const i of this.definition.properties)e[i.id]===void 0&&i.defaultValue!==void 0&&(e[i.id]=i.defaultValue);return e.enabled=(t=e.enabled)!=null?t:!0,e}get enabled(){return this._enabled}get name(){return this.config.name}get type(){return this.config.type}get vrCompatible(){return this.definition.vrCompatible}cloneConfig(){return An(this.config)}updateConfig(e){this.dispose(),this.config=Tr(e),this.init()}init(){!this.running&&this.enabled&&(this.doInit(),this.running=!0)}dispose(){if(this.running){this.doDispose();for(const e of this._anchors)this.viewerApi.removeAnchor(e);for(const e of this.triggers)e instanceof pn&&(this.viewerApi.removeOnCameraPositionUpdated(e.onCameraPositionUpdated),e.dispose(!0));for(const[e,t]of this._nodeListeners)Mu.removeOnNodeTypeClicked(e,t);this._nodeListeners.length=0,this.triggers.length=0,this._anchors.length=0,this.running=!1}}enable(){this._enabled=!0;const e=this.cloneConfig();e.enabled=!0,this.updateConfig(e),this.init()}disable(){this._enabled=!1;const e=this.cloneConfig();e.enabled=!1,this.updateConfig(e),this.dispose()}_vrChanged(e){e&&!this.vrCompatible?this.dispose():!e&&!this.vrCompatible&&this.init()}_addCameraVolumeTrigger(e,t,i,n){typeof e.triggerOnEnter=="boolean"&&(e.triggerOnExit,e.triggerOnEnter=e.triggerOnEnter?"fireExtension":"doNothing",e.triggerOnExit=e.triggerOnExit?"fireExtension":"doNothing");const o={fireExtension:[t],activateExtension:[i],deactivateExtension:[n],doNothing:[]},a=new pn(o[e.triggerOnEnter],o[e.triggerOnExit],{position:e.position,rotation:e.rotation,scale:e.scale,type:e.cameraVolumeType});this.triggers.push(a),Ui().onCameraPositionUpdated(a.onCameraPositionUpdated)}addTrigger(e,t,i=ja,n=ja){if(e.type==="node"){const o=e.nodeType;this.triggers.push(...this.viewerApi.findNodesOfType(o)),this._nodeListeners.push([o,Mu.onNodeTypeClicked(o,t)])}else if(["sphere","sprite"].includes(e.type)){e=e;const o=this.viewerApi.addAnchor(e,t);this._anchors.push(o),this.triggers.push(o)}else e.type=="cameraVolumeTrigger"?this._addCameraVolumeTrigger(e,t,i,n):console.assert(!1,"Unknown trigger type.")}changeTriggersVisibility(e){this.triggersVisible!==e&&(this.triggersVisible=e,this.triggers.forEach(t=>{t instanceof Ys&&(t.visible=e)}))}}r(os,"definition");class Nn extends os{trigger(e){this.activated()?this.deactivate():this.activate(e)}isTriggerable(){return!0}isTriggerExclusive(){return!!this.config.triggerExclusive}_installTriggers(){this.config.trigger&&this.addTrigger(this.config.trigger,(e,t)=>this.trigger(t),(e,t)=>this.activate(t),()=>this.deactivate())}}const gr=class gr extends Nn{constructor(t){super(gr.migrateLegacyConfig(t));r(this,"_audioOnIcon");r(this,"_audioOffIcon");r(this,"_play");r(this,"_element");r(this,"_playButton");r(this,"_playButtonIcon");this._audioOnIcon=void 0,this._audioOffIcon=void 0,this._element=void 0,this._playButton=void 0,this._playButtonIcon=void 0,this._play=!1}static migrateLegacyConfig(t){return t.url&&!t.file&&(t.file={file:t.url.split("/").pop(),url:t.url},delete t.url),t.file.path&&t.file.url&&delete t.file.url,t}_onSceneReadyToDisplay(){const t=this.config;this._installTriggers(),t.menuButton&&(this._audioOffIcon,this._playButton=this.viewerApi.addMenuButton(this._audioOffIcon.src),this._playButton.addEventListener("click",()=>this.trigger()),this._playButtonIcon=this.viewerApi.getMenuButtonIcon(this._playButton)),t.autoplay&&this.viewerApi.onNextPageInteraction(()=>this.trigger())}activated(){return this._play}deactivate(){this._element,this._element.pause()}activate(){this._element,this.config.playRewinds&&(this._element.currentTime=0),this._element.play()}doInit(){var t;Me.log("Audio start"),this.config.menuButton&&!this._audioOnIcon&&(this._audioOnIcon=Wa(ii("img/audio-on.svg")),this._audioOffIcon=Wa(ii("img/audio-off.svg"))),this._element=document.createElement("audio"),this._element.volume=(t=this.config.volume)!=null?t:gr.legacyVolume,this.config.file&&(this.config.file.path?this._element.src=wr(this.config.file.path):this.config.file.url&&(this._element.src=this.config.file.url)),this._element.src&&(this._element.loop=this.config.loop,this._element.addEventListener("play",()=>{this._play=!0,this._playButtonIcon&&(this._audioOnIcon,this._playButtonIcon.src=this._audioOnIcon.src)}),this._element.addEventListener("pause",()=>{this._play=!1,this._playButtonIcon&&(this._audioOffIcon,this._playButtonIcon.src=this._audioOffIcon.src)}),document.body.appendChild(this._element),this.viewerApi.onSceneReadyToDisplay(()=>this._onSceneReadyToDisplay()))}doDispose(){Me.log("Audio stop"),this._play=!1,this._playButton&&(this.viewerApi.removeMenuButton(this._playButton),this._playButton=void 0,this._playButtonIcon=void 0),this._element,this._element.pause(),this._element.remove(),this._element=void 0}};r(gr,"legacyVolume",1),r(gr,"definition",{name:"Audio",type:hn.TWO_STATE,properties:[{id:"file",type:"file",label:"File",fileType:"audio"},{id:"autoplay",type:"bool",label:"Autoplay",defaultValue:!1},{id:"triggerExclusive",type:"bool",label:"Exclusive",defaultValue:!1},{id:"playRewinds",type:"bool",label:"Play rewinds",defaultValue:!1},{id:"loop",type:"bool",label:"Loop",defaultValue:!0},{id:"menuButton",type:"bool",label:"Show menu button",defaultValue:!0},{id:"trigger",type:"trigger",label:"Trigger",optional:!0},{id:"volume",type:"number",label:"Volume",minValue:0,maxValue:1,step:.025,defaultValue:.5,optional:!0}],vrCompatible:!0});let Zc=gr;class Pu extends os{constructor(t){super(t);r(this,"_nextView");this._nextView=0}isTriggerable(){return!0}trigger(){const t=this.config.views[this._nextView];this.viewerApi.switchToView(t,void 0,this.config.doNotMoveCamera),this._nextView=(this._nextView+1)%this.config.views.length}doInit(){super.doInit(),this._nextView=0}}r(Pu,"definition",{name:"Change view",type:hn.MULTI_STATE,properties:[{id:"views",type:"list",elementType:"view",label:"Views to toggle"},{id:"doNotMoveCamera",type:"bool",label:"Do not move camera",defaultValue:!1},{id:"trigger",type:"trigger",label:"Trigger",optional:!0}],vrCompatible:!0});class Cu extends os{constructor(t){super(t);r(this,"_visibleIcon");r(this,"_hiddenIcon");r(this,"_hideAnchorsButton");r(this,"_hideAnchorsButtonIcon");r(this,"_onAnchorsVisibilityChanged",()=>{this._hideAnchorsButtonIcon.src=this.viewerApi.anchorsVisible?this._visibleIcon.src:this._hiddenIcon.src});this._visibleIcon=Wa(ii("img/anchors-on.svg")),this._hiddenIcon=Wa(ii("img/anchors-off.svg"))}isTriggerable(){return!0}trigger(){this.viewerApi.anchorsVisible=!this.viewerApi.anchorsVisible}doInit(){const t=this.viewerApi;this._hideAnchorsButton=t.addMenuButton(this._visibleIcon.src),this._hideAnchorsButtonIcon=t.getMenuButtonIcon(this._hideAnchorsButton),t.onAnchorsVisibilityChanged(this._onAnchorsVisibilityChanged),this._hideAnchorsButton.addEventListener("click",()=>this.trigger()),t.onSceneReadyToDisplay(()=>t.anchorsVisible=this.config.visibleOnStart)}doDispose(){this.viewerApi.removeAnchorsVisibilityChangedListener(this._onAnchorsVisibilityChanged),this.viewerApi.removeMenuButton(this._hideAnchorsButton),this._hideAnchorsButton=void 0,this._hideAnchorsButtonIcon=void 0,this.viewerApi.anchorsVisible=!0}}r(Cu,"definition",{name:"Hide triggers",type:hn.TWO_STATE,properties:[{id:"visibleOnStart",type:"bool",label:"Visible on start",defaultValue:!0}],vrCompatible:!0});const _n=class _n extends Nn{constructor(t){super(t);r(this,"_popup");this._popup=void 0}_sleepAnimatedMaterials(){_n._animatedMaterialsAreSleeping||(this.viewerApi.sleepAnimatedMaterials(),_n._animatedMaterialsAreSleeping=!0)}_wakeAnimatedMaterials(){_n._animatedMaterialsAreSleeping&&(this.viewerApi.wakeAnimatedMaterials(),_n._animatedMaterialsAreSleeping=!1)}_doesElementContainVideo(t){if(t instanceof HTMLVideoElement||t instanceof HTMLIFrameElement)return!0;for(const i of t.children)if(this._doesElementContainVideo(i))return!0;return!1}_onClosePopup(){this._popup=void 0,_n._activeLabel===this&&(_n._activeLabel=void 0,this._wakeAnimatedMaterials())}activated(){return _n._activeLabel===this}deactivate(){this._popup!==void 0&&this.activated()&&this._popup.close()}activate(){if(!this.activated()){_n._activeLabel=this,this._popup=this.viewerApi.openPopup(this.config.content,this.config,()=>this._onClosePopup());const t=document.createElement("div");t.innerHTML=this.config.content,this._doesElementContainVideo(t)?this._sleepAnimatedMaterials():this._wakeAnimatedMaterials()}}doDispose(){this._popup!==void 0&&this._popup.close()}};r(_n,"definition",{name:"HTML label",type:hn.TWO_STATE,properties:[{id:"trigger",type:"trigger",label:"Trigger",optional:!0},{id:"content",type:"textArea",label:"Content",optional:!0,defaultValue:"Content to display..."},{id:"centerHorizontally",type:"bool",label:"Center horizontally",defaultValue:!1},{id:"centerVertically",type:"bool",label:"Center vertically",defaultValue:!1},{id:"padding",type:"bool",label:"Padding",defaultValue:!0}],vrCompatible:!1}),r(_n,"_activeLabel"),r(_n,"_animatedMaterialsAreSleeping",!1);let Jc=_n;/*!
 * Copyright (C) 2022-present unreal engine
 */function mt(s){return document.getElementById(s)}function xo(){if(!Qe.ios){const s=mt("walk-canvas");s&&s.focus()}}function Ru(s){return function(e){e.stopPropagation(),s(),xo()}}function kn(s,e){s.addEventListener("click",Ru(e))}function Pi(s,e){const t=mt(s);Ke(t!=null,`${s} could not be found.`),t!==null&&kn(t,e)}function gl(s){s.addEventListener("click",e=>{e.stopPropagation(),e.target instanceof HTMLInputElement||e.target instanceof HTMLSelectElement||e.target instanceof HTMLTextAreaElement||xo()})}const ks=class ks{constructor(e,t,i){r(this,"_content");r(this,"_options");r(this,"_onClose");r(this,"_container");r(this,"_contentElement");r(this,"_isOpen");this._content=e,this._isOpen=!1,this._options=t,this._container=document.getElementById("ext-html-label"),this._contentElement=this._container.querySelector("#ext-html-label-content"),this._onClose=i}static set _setLastOpenPopup(e){ks._lastOpenPopup=e}static get lastOpenPopup(){return ks._lastOpenPopup}static openPopup(e,t,i){const n=new ks(e,t,i);return ks.lastOpenPopup!==void 0?ks.lastOpenPopup.close(()=>n.open()):n.open(),ks._setLastOpenPopup=n,n}close(e){if(!this._isOpen){e==null||e();return}const t=n=>{this._container.classList.remove("ext-html-label-topleft"),this._container.classList.remove("ext-html-label-horizontal-center"),this._container.classList.remove("ext-html-label-vertical-center"),this._container.classList.remove("ext-html-label-center"),this._container.classList.remove("ui-out"),this._contentElement.innerHTML="",this._container.style.display="none",this._onClose&&this._onClose(),n==null||n(),this._isOpen=!1};this._container.classList.add("ui-out");const i=400;xo(),window.setTimeout(()=>t(e),i)}open(){if(this._isOpen)return;const e=()=>{this._options.centerVertically?this._options.centerHorizontally?this._container.classList.add("ext-html-label-center"):this._container.classList.add("ext-html-label-vertical-center"):this._options.centerHorizontally?this._container.classList.add("ext-html-label-horizontal-center"):this._container.classList.add("ext-html-label-topleft"),this._container.classList.add("ui-out"),this._container.classList.remove("ext-html-label-animated"),this._container.offsetHeight,this._container.classList.add("ext-html-label-animated"),this._container.classList.remove("ui-out")},t=()=>{this._options.padding||this._options.padding===void 0?this._contentElement.style.padding="":this._contentElement.style.padding="0"};if(this._content instanceof Node)this._contentElement.appendChild(this._content);else{const i=wr("").slice(0,-1),n=this._content.replace(/\$EXTRA_ASSETS/g,i);this._contentElement.innerHTML=n}t(),this._container.style.display="",e(),this._container.querySelector("#ext-html-label-close").onclick=()=>{this.close()},this._isOpen=!0}};r(ks,"_lastOpenPopup");let Ur=ks;const ic=class ic{constructor(e,t){r(this,"vrRadius");r(this,"vrPosition");r(this,"vrPositionOffset");r(this,"viewer");r(this,"trigger");this.viewer=e,this.trigger=t,this.vrPosition=new F,this.vrPositionOffset=new F,this.trigger&&["sprite","sphere"].includes(this.trigger.type)?(this.vrPosition.fromArray(this.trigger.position),this.vrRadius=this.trigger.radius):this.vrRadius=ic.VR_RADIUS}getPosition(e){if(e!=null)return(!this.trigger||this.trigger.type==="node")&&(this.vrPositionOffset.copyFrom(this.viewer.getCameraPosition()),this.vrPositionOffset.sub(e),this.vrPositionOffset.normalize().multiplyScalar(this.vrRadius),this.vrPosition.copyFrom(e).add(this.vrPositionOffset)),this.vrPosition}getRadius(){return this.vrRadius}};r(ic,"VR_RADIUS",.07);let vl=ic,Bg=(vr=class extends Nn{constructor(t){super(vr._migrateConfig(t));r(this,"_meshes");r(this,"_ownedMaterialPickerId");r(this,"_vrPlacer");r(this,"_apiUserStateKey");r(this,"_onStateChanged",(t,i)=>{console.assert(t===this._apiUserStateKey);const n=this.viewerApi.findMaterial(i);n&&this._setMaterial(n)});this._meshes=[],this._ownedMaterialPickerId=void 0,this._vrPlacer=new vl(this.viewerApi,this.config.trigger),this._apiUserStateKey="MaterialPicker:"+this.name,this.viewerApi.isSceneReadyToDisplay()||this._materialNames().forEach(i=>this.viewerApi.setMaterialEditable(i))}static _migrateConfig(t){if(!t.materials)return t;const i=An(t);return i.materials.length>0&&(i.toReplace=i.materials[0],i.toPick=i.materials.slice(1)),i.materials=void 0,Tr(i)}_materialNames(){return(this.config.toReplace?[this.config.toReplace]:[]).concat(this.config.toPick||[])}_materials(){return this._materialNames().map(t=>this.viewerApi.findMaterial(t))}_setMaterial(t){this._meshes.forEach(i=>this.viewerApi.setMaterialForMesh(t,i))}_materialSelected(t){this.viewerApi.apiUserChangeState(this._apiUserStateKey,t.name)}activated(){return this._ownedMaterialPickerId===void 0?!1:this.viewerApi.getCurrentMaterialPickerId()===this._ownedMaterialPickerId}deactivate(){this.activated()&&(this._ownedMaterialPickerId=void 0,this.viewerApi.closeMaterialPicker())}activate(t){this.activated()||(this.viewerApi.closeMaterialPicker(),this._ownedMaterialPickerId=this.viewerApi.openMaterialPicker(this._materials(),i=>this._materialSelected(i),null,this._vrPlacer.getPosition(t),this._vrPlacer.getRadius()))}isTriggerable(){return!0}_sceneReadyToDisplay(){this._installTriggers(),this._meshes=this.viewerApi.findMeshesWithMaterial(this.config.toReplace||[])}doInit(){this.viewerApi.onSceneReadyToDisplay(()=>this._sceneReadyToDisplay()),this.viewerApi.onApiUserStateChanged(this._apiUserStateKey,this._onStateChanged)}doDispose(){const t=this.viewerApi.findMaterial(this.config.toReplace);t&&this._materialSelected(t),this.viewerApi.removeOnApiUserStateChanged(this._apiUserStateKey,this._onStateChanged)}},r(vr,"definition",{name:"Material picker",type:hn.TWO_STATE,properties:[{id:"toReplace",type:"material",label:"Material to replace"},{id:"toPick",type:"list",elementType:"material",label:"Materials to pick"},{id:"trigger",type:"trigger",label:"Trigger",optional:!0}],vrCompatible:!0}),vr);const ai=class ai extends os{constructor(t){super(t);r(this,"_meshesForOptions",[]);r(this,"_defaultUvScale",[1,1]);r(this,"_originalUvOffsetScaleForMaterial",new Map);r(this,"_vrPlacer");r(this,"_apiUserStateKey");r(this,"_optionList");r(this,"_curOptionIdx",-1);r(this,"_materialSelected",(t,i)=>{this.viewerApi.apiUserChangeState(this._apiUserStateKey,i)});r(this,"_onStateChanged",(t,i)=>{if(console.assert(t===this._apiUserStateKey),this._revertChanges(),i!==0){this._curOptionIdx=i-1;for(let n=0;n<this._optionList[this._curOptionIdx].length;++n){const o=this._optionList[this._curOptionIdx][n],a=this.viewerApi.findMaterial(o.toUse),l=this._originalUvOffsetScaleForMaterial.get(a),c=o.uvScale?o.uvScale[0]:this._defaultUvScale[0],h=o.uvScale?o.uvScale[1]:this._defaultUvScale[1];a.setUvOffsetAndScale(l.x,l.y,l.z*c,l.w*h),a.setUniforms();for(const d of this._meshesForOptions[this._curOptionIdx][n])this.viewerApi.setMaterialForMesh(a,d)}}});r(this,"_sceneReadyToDisplay",()=>{for(const t of this.config.triggers)this.addTrigger(t,this.openFromTrigger.bind(this));for(let t=0;t<this._optionList.length;++t){this._meshesForOptions[t]=[];for(const{toReplace:i,toUse:n}of this._optionList[t]){this._meshesForOptions[t].push(this.viewerApi.findMeshesWithMaterial(i));const o=this.viewerApi.findMaterial(n);if(!this._originalUvOffsetScaleForMaterial.has(o)){const a=new tt;this._originalUvOffsetScaleForMaterial.set(o,o.getUvOffsetAndScale(a))}}}});r(this,"togglePickersMenu",()=>{const t=ai._startedPickers;if(console.assert(t.length>0),ai._pickerOpened&&this.viewerApi.closeMaterialPicker(),ai._menuPopup){this.closePickersMenu();return}const i=document.createElement("div");i.innerHTML=`
        <div class="ext-material-combo-picker-menu-title">
          <img src="${ii("img/sliders-horizontal.svg")}">
        </div>
        <ul class="ext-material-combo-picker-menu-list">
          <li class="ext-material-combo-picker-menu-item"></li>
        </ul>`;const n=i.getElementsByClassName("ext-material-combo-picker-menu-list")[0];let o=n.getElementsByClassName("ext-material-combo-picker-menu-item")[0];for(let a=0;a<t.length;++a){a>0&&(o=o.cloneNode(!0),n.appendChild(o));const l=t[a];Wo(o,l.name),o.addEventListener("click",function(){l._openFromMenu()})}ai._menuPopup=Ur.openPopup(i,{centerHorizontally:!0,centerVertically:!0,padding:!1},()=>{ai._menuPopup=void 0})});this._vrPlacer=new vl(this.viewerApi),this._apiUserStateKey="MaterialComboPicker:"+this.name,this._optionList=this.config.options,this.viewerApi.isSceneReadyToDisplay()||this._allMaterialNames().forEach(i=>this.viewerApi.setMaterialEditable(i))}_allMaterialNames(){const t=new Set;for(const i of this._optionList)for(const n of i)t.add(n.toReplace),t.add(n.toUse);return t}_revertChanges(){if(this._curOptionIdx!==-1)for(let t=0;t<this._optionList[this._curOptionIdx].length;++t){const i=this._optionList[this._curOptionIdx][t],n=this.viewerApi.findMaterial(i.toUse),o=this.viewerApi.findMaterial(i.toReplace);n.setUvOffsetAndScale(this._originalUvOffsetScaleForMaterial.get(n)),n.setUniforms();for(const a of this._meshesForOptions[this._curOptionIdx][t])this.viewerApi.setMaterialForMesh(o,a)}}isTriggerable(){return!1}openFromTrigger(t,i,n){ai._menuPopup&&this.closePickersMenu();const o=this._toPickMaterials();this.viewerApi.openMaterialPicker(o,this._materialSelected,()=>this.pickerClosed(),this._vrPlacer.getPosition(i),this._vrPlacer.getRadius()),ai._pickerOpened=!0}_toPickMaterialNames(){const t=[this._optionList[0][0].toReplace];for(const i of this._optionList)t.push(i[0].toUse);return t}_toPickMaterials(){return this._toPickMaterialNames().map(t=>this.viewerApi.findMaterial(t))}closePickersMenu(){ai._menuPopup.close(),ai._menuPopup=void 0}pickerClosed(){ai._pickerOpened=!1}_openFromMenu(){const t=this._toPickMaterials();this.viewerApi.openMaterialPicker(t,this._materialSelected),ai._pickerOpened=!0}doInit(){this.viewerApi.onSceneReadyToDisplay(this._sceneReadyToDisplay),this.viewerApi.onApiUserStateChanged(this._apiUserStateKey,this._onStateChanged);const t=ai._startedPickers;if(t.push(this),t.length===1){const i=this.viewerApi.addMenuButton(ii("img/sliders-horizontal.svg"));i.addEventListener("click",this.togglePickersMenu),ai._menuButton=i}}doDispose(){this._revertChanges(),this.viewerApi.removeOnApiUserStateChanged(this._apiUserStateKey,this._onStateChanged);const t=ai._startedPickers;if(t.splice(t.indexOf(this),1),t.length===0){const i=ai._menuButton;this.viewerApi.removeMenuButton(i),ai._menuButton=void 0}}};r(ai,"definition",{name:"Material combo picker",type:hn.TWO_STATE,hideFromEditor:!0,properties:[{id:"triggers",type:"list",label:"Triggers",elementType:"trigger"},{id:"options",type:"list",label:"Options",elementType:{type:"list",label:"option",elementType:[{id:"toReplace",type:"material",label:"Material to replace"},{id:"toUse",type:"material",label:"Material to use"},{id:"uvScale",type:"list",label:"UV Scale",elementType:"float"}]}}],vrCompatible:!0}),r(ai,"_startedPickers",[]),r(ai,"_menuButton"),r(ai,"_menuPopup"),r(ai,"_pickerOpened",!1);let eh=ai;const Ug=["toggle","impulse","activate","deactivate"];function Nr(s){const[e,t,i]=s.split(":");return[e,t,i]}function Ng(s){return["VideoTextureControl","SwitchObjects"].includes(s.type)}class Iu extends os{constructor(t){super(t);r(this,"_nextTriggerActivate");this._nextTriggerActivate=!0}migrateConfig(t){t=super.migrateConfig(t);const i=new Array;let n=!1;for(const o of t.extensions){let[a,l,c]=Nr(o);Ug.includes(c)||(n=!0,c="toggle"),i.push(`${a}:${l}:${c}`)}return n&&(t.extensions=i),t}extensionsAndTriggerTypes(){return this.config.extensions.map(t=>{const[i,n,o]=Nr(t);return[this.viewerApi.getExtension(i,n),o]})}get vrCompatible(){return this.extensionsAndTriggerTypes().every(([t])=>t.vrCompatible)}trigger(t){for(const[i,n]of this.extensionsAndTriggerTypes())try{switch(n){case"activate":Pe(i instanceof Nn),i.activate(t);break;case"deactivate":Pe(i instanceof Nn),i.deactivate();break;case"impulse":Pe(i instanceof Nn),i.trigger(t);break;case"toggle":i instanceof Nn?this._nextTriggerActivate?i.activate(t):i.deactivate():i.trigger(t);break}}catch(o){console.error("Failed to trigger an extension",o)}this._nextTriggerActivate=!this._nextTriggerActivate}isTriggerable(){return!1}doInit(){super.doInit(),this._nextTriggerActivate=!0}}r(Iu,"definition",{name:"Multi trigger",type:hn.IMPULSE,getListElementsToAdd:function(t,i,n){Ke(t==="extensions");const o=new Set(i.map(l=>Nr(l)[0])),a=l=>l.isTriggerable()&&(Ng(l)||!o.has(l.type));return n.filter(a).map(l=>`${l.type}:${l.name}:toggle`)},formatListElement:function(t){const[i,n,o]=Nr(t),a=zu(i),l=o.replace(o[0],o[0].toUpperCase());return`${a.name}: ${n} - ${l}`},getTriggerTypeDefinition:function(t){const[i]=Nr(t);return zu(i)},properties:[{id:"extensions",type:"list",elementType:"extension",label:"Extensions to trigger",elementLabel:"extension"},{id:"trigger",type:"trigger",label:"Trigger",optional:!0}],vrCompatible:!1});class Du extends os{constructor(e){super(e)}isTriggerable(){return!0}trigger(){this.viewerApi.openUrl(this.config.url,this.config.newWindow)}}r(Du,"definition",{name:"Open URL",type:hn.IMPULSE,properties:[{id:"url",type:"text",label:"URL"},{id:"newWindow",type:"bool",label:"New window",defaultValue:!0},{id:"trigger",type:"trigger",label:"Trigger",optional:!0}],vrCompatible:!0});let Lu=null,Ps=!1,th=!0;const Fu=[{name:"mainMaterial",baseColor:[.5,.5,.5],roughness:.7,metallic:1},{name:"displayMaterial",baseColor:[0,0,0],roughness:.001,metallic:0}],rs={sphere:null,cylinder:null,head:[],torso:[],displayPortrait:[],displayLandscape:[]},kr={};function kg(s){(!rs.plane||Lu!==s.id)&&(rs.sphere=nt.createSphere(.08,32,16),rs.sphere.convertNormalsToSpherical(),rs.cylinder=nt.createCylinder(.005,.005,1,3),rs.cylinder.convertNormalsToSpherical(),Lu=s.id)}function zg(s,e,t){const i=new ti;rs.head.forEach(o=>{i.union(o.geometry.boundingBox)});const n=(i.max.z-i.min.z)/2;return new Ys(s,s.renderCaches,{type:"sprite",position:[0,0,.1+i.center().z+n],height:.1,text:e,textColor:t,opacity:0})}function Vg(s){const e=new Ye(rs.sphere,s);return e.scale.set(.4,.4,.4),e.visible=!1,e}function Gg(s){const e=new gt;e.lightmapSupported=!1,e.headLight=!1,e.baseColor.setStyle(s).convertGammaToLinear(),e.transparent=!0,e.opacity=.5,e.emissive=!0,e.disableLightProbe=!0,e.setUniforms();const t=new Ye(rs.cylinder,e);return t.visible=!1,t}function Hg(s,e){s.length!==e.size&&console.warn("Mismatch between avatar meshes count and geometries map size");for(const t of s){e.has(t.geometryName)||console.assert(!1,'Avatar "'+t.geometryName+'" mesh is missing');const i={materialName:t.materialName?t.materialName:"mainMaterial",geometry:e.get(t.geometryName)};rs[t.group].push(i)}}function ih(s){const e=new gt;return e.lightmapSupported=!1,e.baseColor.fromArray(s.baseColor),e.roughness=s.roughness||1,e.metallic=s.metallic||0,e.opacity=s.opacity||1,e.highlight=new be(16777215),e.highlightMix=0,e.baseColorTexture=s.baseColorTexture,e.disableLightProbe=s.disableLightProbe||!1,e.headLight=s.headLight||!1,e.setUniforms(),e}function Wg(s,e){s&&Fu.push(...s),Fu.forEach(t=>{if(t.baseColorTexture){const i=new Image;i.src=e+t.baseColorTexture.file,t.baseColorTexture=Ui().createTextureFromHtmlImage(i)}kr[t.name]=ih(t)})}function jg(s,e,t){Ps=e.displayLookAtCamera||!1,th=e.rotateHeadInPortraitMode||!0,Hg(e.meshes,t),Wg(e.materials,s)}const nh="avatarDisposed",sh="avatarUpdated";class Xg extends ft{constructor(e,t,i){super(),this.uuid=t,this.displayName=i.displayName,this._scene=e,this._lastLightProbeCheckPosition=new F(0,0,0),this.colliders=[],kg(e),this._haveLightProbe=this._scene.lightProbes.length>0;for(const a of Object.values(kr))a.disableLightProbe=!this._haveLightProbe,a.headLight=this._haveLightProbe,a.setUniforms();this.mainMaterial=ih(kr.mainMaterial),Ps?(this.displayMaterial=new tu,this.displayMaterial.reflective=!1,this.displayMaterial.headLight=!1):this.displayMaterial=ih(kr.displayMaterial),this.mainMaterial.baseColor.setStyle(i.color).convertGammaToLinear(),this._body=new ft,this._head=new ft,this._head.rotation.order=On.ZXY,this._torso=new ft,this._displayLandscape=new ft,this._displayPortrait=new ft;const n=a=>{switch(a){case"mainMaterial":return this.mainMaterial;case"displayMaterial":return this.displayMaterial;default:return kr[a]}},o=(a,l)=>{rs[l].forEach(c=>{const h=n(c.materialName),d=new Ye(c.geometry,h);a.add(d),d.visibilityId=null,this.colliders.push(d)})};if(o(this._head,"head"),o(this._torso,"torso"),o(this._displayLandscape,"displayLandscape"),o(this._displayPortrait,"displayPortrait"),this._pointer=Vg(this.mainMaterial),this._pointerLeaderStartOffset=new F(0,.3,-.35),this._pointerLeader=Gg(i.color),this._displayNameAnchor=zg(e,i.displayName,i.color),this._body.add(this._torso),this._body.add(this._head),Ps?(this.add(this._displayLandscape),this.add(this._displayPortrait)):(this._head.add(this._displayLandscape),this._head.add(this._displayPortrait)),this.add(this._body),this.add(this._displayNameAnchor),this.add(this._pointerLeader),this.add(this._pointer),i.position&&this.position.fromArray(i.position),this.updateMatrixWorld(!0),this._setClosestLightProbe(),Ps){const a=new ti;this._displayLandscape.children.forEach(l=>{a.union(l.geometry.boundingBox)}),this.displayMaterial.offset=a.center()}this._videoTexture0=null,this._videoTexture1=null,this._landscape=!0,this._displayLandscape.visible=!Ps,this._displayPortrait.visible=!1,this._soundThreshold=140,this._maxHighlight=.5,this._highlightStepDown=.05}switchToPortrait(){this._landscape&&(this._landscape=!1,this._displayLandscape.visible=!1,this._displayPortrait.visible=!0,th&&!Ps&&(this._head.rotation.y=Math.PI/2,this._torso.position.z-=.05))}switchToLandscape(){this._landscape||(this._landscape=!0,this._displayLandscape.visible=!0,this._displayPortrait.visible=!1,th&&!Ps&&(this._head.rotation.y=0,this._torso.position.z+=.05))}hideBody(){this.traverse(e=>e.visible=!1),this.visible=!0,this._pointer.visible=!0,this._pointerLeader.visible=!0}_updated(){this.dispatchEvent({type:sh})}rotate(e,t){this._body.rotation.z=e,this._head.rotation.x=t}setOrientation(){this._videoTexture0.width<this._videoTexture0.height?this.switchToPortrait():this.switchToLandscape()}onVideoStreamStart(){Ps&&(this._displayLandscape.visible=!0,this._displayPortrait.visible=!1)}onVideoStreamStop(){Ps?(this._displayLandscape.visible=!1,this._displayPortrait.visible=!1):this.switchToLandscape()}setVideoTexture0(e){this._videoTexture0&&(this._videoTexture0.dispose(),this._videoTexture0=null),this._haveLightProbe&&(this.displayMaterial.disableLightProbe=!1),this.displayMaterial.baseColorTexture=void 0,this._updated(),e?(this.onVideoStreamStart(),e.addLoadedListener(()=>{this._videoTexture0=e,this.setOrientation(),this.displayMaterial.disableLightProbe=!0,this.displayMaterial.baseColorTexture=e,e.addResizedListener(()=>{this.setOrientation(),this._updated()}),this._updated()})):(this.onVideoStreamStop(),this._updated())}getVideoTexture0(){return this._videoTexture0}setVideoTexture1(e){this._videoTexture1&&(this._videoTexture1.dispose(),this._videoTexture1=null,this._updated()),e&&e.addLoadedListener(()=>{this._videoTexture1=e,this._updated()})}getVideoTexture1(){return this._videoTexture1}getMainMaterial(){return this.mainMaterial}_setClosestLightProbe(){const e=this._scene.closestLightProbe(this.position);if(this._head.children[0].lightProbes!==void 0){for(const t of this._head.children[0].lightProbes)if(t===e)return}for(const t of[this._head,this._torso,this._displayPortrait,this._displayLandscape])t.children.forEach(i=>{i.lightProbes=[e]});this._pointer.lightProbes=[e],this._pointerLeader.lightProbes=[e]}setPositionFromArray(e){this.position.fromArray(e),this._lastLightProbeCheckPosition.distanceTo(this.position)>.5&&(this._lastLightProbeCheckPosition.copyFrom(this.position),this._setClosestLightProbe(this.position))}placePointer(e,t,i){const n=new at,o=new F,a=new F,l=new F,c=new F,h=new at,d=new at;d.set(1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1);const u=new at;this._pointer.position.set(e-this.position.x,t-this.position.y,i-this.position.z),this._pointer.visible=!0,n.makeRotationZ(this._body.rotation.z),o.set(this._pointerLeaderStartOffset.x,this._pointerLeaderStartOffset.y,this._pointerLeaderStartOffset.z),n.affineTransformPoint3(o),a.set(this.position.x,this.position.y,this.position.z).add(o),l.set(e,t,i),c.set(e,t,i).sub(a),u.makeScale(1,c.length(),1),h.lookAt(a,l,ft.DEFAULT_UP),h.multiply(d),u.multiplyMatrices(h,u),c.divideScalar(2).add(o),u.setPosition(c),this._pointerLeader.matrix.identity(),this._pointerLeader.applyMatrix(u),this._pointerLeader.visible=!0}hidePointer(){this._pointerLeader.visible=!1,this._pointer.visible=!1}onSoundVolumeUpdated(e){if(e===null)return;const t=this._computeHighlighMix(e);this.getMainMaterial().highlightMix!==t&&(this.getMainMaterial().highlightMix=t,Ui().requestFrame())}onSoundSwitchedOff(){this.getMainMaterial().highlightMix>0&&(this.getMainMaterial().highlightMix=0,Ui().requestFrame())}_computeHighlighMix(e){const t=this.getMainMaterial().highlightMix;if(e<this._soundThreshold)return t>0?Math.max(0,t-this._highlightStepDown):0;{const i=(e-this._soundThreshold)/(255-this._soundThreshold)*this._maxHighlight;return i>t?i:Math.max(i,t-this._highlightStepDown)}}dispose(){this.mainMaterial.dispose(),this.displayMaterial.dispose(),this._videoTexture0&&this._videoTexture0.dispose(),this._videoTexture1&&this._videoTexture1.dispose(),this._displayNameAnchor.dispose(),this.dispatchEvent({type:nh})}}const Ou=M.EDIT_MODE;class Bu extends os{constructor(t){super(t);r(this,"_apiUserStateKey");r(this,"_meetingController");r(this,"_material");r(this,"_origBaseColorTexture");r(this,"_presentingAvatar");r(this,"_editModePopup");r(this,"_attachScreenShareToTexture",()=>{const t=this._getScreenShareTexture();t?this._material.baseColorTexture=t:this._material.baseColorTexture=this._origBaseColorTexture});r(this,"_presentationStop",()=>{Me.log("Presentation stop"),this._presentingAvatar&&(this._presentingAvatar.uuid===this._meetingController.myUuid&&this._meetingController.stopShareScreen(),this._presentingAvatar.removeEventListener(nh,this._presentationStop),this._presentingAvatar.removeEventListener(sh,this._attachScreenShareToTexture)),this._presentingAvatar=void 0,this._material.baseColorTexture=this._origBaseColorTexture,this._removeTriggerHighlight()});r(this,"_fakeTogglePresentation",()=>{if(this._editModePopup){this._editModePopup.close();return}const t=`In a 3D meeting this trigger will start a screen sharing on the ${this.config.material} material.<br>Outside of a 3D meeting and on the mobile devices the trigger will be hidden.`;this._editModePopup=Ur.openPopup(t,{padding:!0,centerVertically:!0,centerHorizontally:!0},()=>{this._editModePopup=void 0})});r(this,"_togglePresentation",()=>{const t=this._meetingController.myUuid;!this._presentingAvatar||!this._getScreenShareTexture()?(Me.log("Requesting screen share "+t),this._meetingController.startShareScreen(()=>{this.viewerApi.apiUserChangeState(this._apiUserStateKey,t)},()=>{this.viewerApi.apiUserChangeState(this._apiUserStateKey,null)},()=>{})):this._presentingAvatar.uuid!==t||(Me.log("Requesting presentation stop"),this.viewerApi.apiUserChangeState(this._apiUserStateKey,null))});r(this,"onStateChanged",(t,i)=>{if(console.assert(t===this._apiUserStateKey),!i){this._presentationStop();return}if(this._presentingAvatar&&this._presentingAvatar.uuid!==i&&(Me.log("Changing presenting user"),this._presentationStop()),!this._presentingAvatar){if(Me.log("New presenting user "+i),this._presentingAvatar=this.viewerApi.findAvatar(i),!this._presentingAvatar){console.log("Cannot attach presentation stream of a user "+i+" The user was not found.");return}this._presentingAvatar.addEventListener(nh,this._presentationStop),this._presentingAvatar.addEventListener(sh,this._attachScreenShareToTexture),this._addTriggerHighlight(),this._attachScreenShareToTexture()}});r(this,"_onAvatarListChanged",()=>{this.onStateChanged(this._apiUserStateKey,this.viewerApi.getApiUserState(this._apiUserStateKey))});r(this,"_meetingJoined",t=>{const i=this.config;if(this._material=this.viewerApi.findMaterial(i.material),!this._material){console.error("Material for a projection screen is missing"),this._material=void 0;return}this._meetingController=t,this._origBaseColorTexture=this._material.baseColorTexture,this.config.trigger&&this.addTrigger(this.config.trigger,this._togglePresentation),this.viewerApi.onApiUserStateChanged(this._apiUserStateKey,this.onStateChanged),this.viewerApi._onAvatarListChanged(this._onAvatarListChanged)});this._apiUserStateKey="ProjectionScreen:"+this.name,this._meetingController=void 0,this._material=void 0,this._origBaseColorTexture=void 0,this._presentingAvatar=void 0,this._editModePopup=void 0,this.viewerApi.isSceneReadyToDisplay()||this.viewerApi.setMaterialEditable(this.config.material)}_hasHighlightableTrigger(){return this.triggers[0]instanceof Ys}_getTriggerMaterial(){return this.triggers[0]instanceof Ys,this.triggers[0].material}_addTriggerHighlight(){if(!this._hasHighlightableTrigger())return;const t=this._getTriggerMaterial();t.highlight=this._presentingAvatar.getMainMaterial().baseColor,t.setUniforms(),t.highlightMix=.7}_removeTriggerHighlight(){this._hasHighlightableTrigger()&&(this._getTriggerMaterial().highlightMix=0)}_getScreenShareTexture(){return this._presentingAvatar.getVideoTexture1()}isTriggerable(){return!1}doInit(){Ou?this.config.trigger&&this.addTrigger(this.config.trigger,this._fakeTogglePresentation):Qe.screenCaptureApi&&this.viewerApi._onMeetingJoined(this._meetingJoined)}doDispose(){Ou||(this.viewerApi._removeOnMeetingJoined(this._meetingJoined),this._meetingController&&(this.viewerApi.removeOnApiUserStateChanged(this._apiUserStateKey,this.onStateChanged),this.viewerApi._removeOnAvatarListChanged(this._onAvatarListChanged)),this._meetingController=void 0,this._material=void 0)}}r(Bu,"definition",{name:"Meeting projection screen",warningText:"Screen sharing from a mobile device is not supported.",type:hn.TWO_STATE,properties:[{id:"material",type:"material",label:"Material to project on"},{id:"trigger",type:"trigger",label:"Trigger",optional:!0}],vrCompatible:!0});class Uu extends os{constructor(e){super(e)}isTriggerable(){return!0}trigger(){try{new Function('"use strict"; '+this.config.code)()}catch(e){console.error("Script extension error: "+e)}}doInit(){super.doInit(),this.config.trigger||this.trigger()}}r(Uu,"definition",{name:"Script",type:hn.IMPULSE,properties:[{id:"code",type:"textArea",label:"Code",defaultValue:"<!-- Put your JavaScript code here. If a trigger is set, the code is executed when the trigger is clicked. Otherwise the code is executed when a page is loaded -->"},{id:"trigger",type:"trigger",label:"Trigger",optional:!0}],vrCompatible:!0});class Nu extends os{constructor(t){super(t);r(this,"_apiUserStateKey");r(this,"_visibleNodeTypeIdx");r(this,"_visibleNodes");r(this,"_onStateChanged",(t,i)=>{console.assert(t===this._apiUserStateKey),this._visibleNodeTypeIdx=i,this._updateNodesVisibility()});if(this._apiUserStateKey="SwitchObjects:"+this.name,this._visibleNodeTypeIdx=void 0,this._visibleNodes=[],!this.viewerApi.isSceneReadyToDisplay())for(const i of this.config.nodeTypes)this.viewerApi.setNodeTypeEditable(i)}_affectedMeshes(){const t=new Array;return this.config.nodeTypes.forEach(i=>{this.viewerApi.findNodesOfType(i).forEach(o=>{o.visitSubtree(a=>{a.mesh&&t.push(a.mesh)})})}),t}_updateNodesVisibility(){if(this._visibleNodes.forEach(i=>i.hide()),this._visibleNodeTypeIdx===-1)this._visibleNodes=[];else{const i=this.config.nodeTypes[this._visibleNodeTypeIdx];this._visibleNodes=this.viewerApi.findNodesOfType(i),this._visibleNodes.forEach(n=>n.show())}const t=fm();t&&t.updateMeshVisibility(this._affectedMeshes()),this.viewerApi.requestFrame()}trigger(){this.config.nodeTypes.length!==0&&(this._visibleNodeTypeIdx=this._visibleNodeTypeIdx+1,this._visibleNodeTypeIdx===this.config.nodeTypes.length&&(this._visibleNodeTypeIdx=this.config.hideAllAfterLast?-1:0),this.viewerApi.apiUserChangeState(this._apiUserStateKey,this._visibleNodeTypeIdx))}isTriggerable(){return!0}doInit(){this._visibleNodes=[],this.viewerApi.onSceneReadyToDisplay(()=>{for(let i=0;i<this.config.nodeTypes.length;++i)(i>0||this.config.hideAllOnStart)&&this.viewerApi.findNodesOfType(this.config.nodeTypes[i]).forEach(o=>o.hide());const t=this.config.nodeTypes.length==0||this.config.hideAllOnStart;this._visibleNodeTypeIdx=t?-1:0,this._updateNodesVisibility(),this._installTriggers()}),this.viewerApi.onApiUserStateChanged(this._apiUserStateKey,this._onStateChanged)}doDispose(){for(let i=0;i<this.config.nodeTypes.length;++i)i!==this._visibleNodeTypeIdx&&this.viewerApi.findNodesOfType(this.config.nodeTypes[i]).forEach(o=>o.show());const t=fm();t&&t.updateMeshVisibility(this._affectedMeshes()),this.viewerApi.requestFrame()}}r(Nu,"definition",{name:"Switch objects",type:hn.MULTI_STATE,properties:[{id:"nodeTypes",type:"list",elementType:"nodeType",label:"Objects to switch"},{id:"trigger",type:"trigger",label:"Trigger",optional:!0},{id:"hideAllOnStart",type:"bool",label:"Hide all on start",defaultValue:!1},{id:"hideAllAfterLast",type:"bool",label:" Hide all after last",defaultValue:!1}],vrCompatible:!0});const ga=class ga extends Nn{constructor(t){super(t);r(this,"_material");r(this,"_initialized");r(this,"_initializationPending");r(this,"_origBaseColorTexture");this._origBaseColorTexture=void 0,this._material=void 0,this._initialized=!1,this._initializationPending=!1,this.viewerApi.isSceneReadyToDisplay()||this.viewerApi.setMaterialEditable(this.config.material)}_createVideoTexture(t){var n;const i=document.createElement("video");if(i.classList.add("video-js"),i.autoplay=!0,i.muted=!0,i.volume=(n=this.config.volume)!=null?n:ga.legacyVolume,i.type="application/x-mpegURL",Hls.isSupported()){const o=new Hls;o.loadSource(t),o.attachMedia(i)}else i.canPlayType("application/vnd.apple.mpegurl")?i.src=t:console.log("No Hls support");return this.viewerApi.createStreamTextureFromHtmlVideo(i)}_createStreamTexture(){const t=this._createVideoTexture(this.config.streamUrl);t.addLoadedListener(()=>{this._initializationPending=!1,this.running&&(this._origBaseColorTexture=this._material.baseColorTexture,this._material.baseColorTexture=t,this.viewerApi.onNextPageInteraction(()=>{t.muted=!1}),this._initialized=!0)}),this._initializationPending=!0,t.play()}_stateChanging(){return this._initializationPending?!0:!this._initialized&&!this._initializationPending?(this._createStreamTexture(),!0):!1}activated(){return this._material.isPlaying}activate(){this._stateChanging()||(this.config.playRewinds&&this._material.rewind(),this._material.play())}deactivate(){this._stateChanging()||this._material.pause()}trigger(){this._stateChanging()||super.trigger()}sceneLoadComplete(){const t=this.config;if(this._material=this.viewerApi.findMaterial(t.material),this._material){if(!this._material.baseColorTexture){console.error(`Material '${t.material}' for stream texture control '${t.name}' does not have a stream texture`),this._material=void 0;return}}else{console.error(`Material '${t.material}' for stream texture control '${t.name}' does not exist`);return}const i=()=>{this._installTriggers(),(this.config.autoplay||!this.config.trigger)&&this.trigger()};ho(ii("lib/Hls.js"),i,()=>Gt.error("Cannot load required library"))}doInit(){this.viewerApi.onSceneLoadComplete(()=>this.sceneLoadComplete())}doDispose(){if(this._material){if(this._initialized){this._initialized=!1;let t=this._material.baseColorTexture;this._material.baseColorTexture=this._origBaseColorTexture,t instanceof dt&&t.dispose(),t=void 0,this._origBaseColorTexture=void 0}this._material=void 0}}};r(ga,"legacyVolume",1),r(ga,"definition",{name:"Video Stream",type:hn.TWO_STATE,properties:[{id:"material",type:"material",label:"Material with stream"},{id:"streamUrl",type:"text",label:"Stream URL"},{id:"trigger",type:"trigger",label:"Trigger",optional:!0},{id:"autoplay",type:"bool",label:"Autoplay",defaultValue:!0},{id:"triggerExclusive",type:"bool",label:"Exclusive",defaultValue:!1},{id:"playRewinds",type:"bool",label:"Play rewinds",defaultValue:!1},{id:"volume",type:"number",label:"Volume",minValue:0,maxValue:1,step:.025,defaultValue:.5,optional:!0}],vrCompatible:!0});let oh=ga;const va=class va extends Nn{constructor(t){super(t);r(this,"_material");this._material=void 0,this.viewerApi.isSceneReadyToDisplay()||this.viewerApi.setMaterialEditable(this.config.material)}_videoTextureLoaded(){var n;const t=this._material.baseColorTexture,i=this.config;t.loop=i.loop,t.volume=(n=i.volume)!=null?n:va.legacyVolume,i.autoplay?i.muted||this.viewerApi.onNextPageInteraction(()=>{t.muted=!1}):(this._material.pause(),t.muted=i.muted),this._installTriggers()}_sceneLoadComplete(){const t=this.config;if(this._material=this.viewerApi.findMaterial(t.material),this._material){if(!this._material.baseColorTexture||!(this._material.baseColorTexture instanceof Yo)||this._material.baseColorTexture.video===void 0){console.error(`Material '${t.material}' for video texture control '${t.name}' does not have a video texture`),this._material=void 0;return}}else{console.error(`Material '${t.material}' for video texture control '${t.name}' does not exist`);return}this._material.baseColorTexture.addLoadedListener(()=>this._videoTextureLoaded())}activated(){var t;return!!((t=this._material)!=null&&t.isPlaying)}deactivate(){var t;(t=this._material)==null||t.pause()}activate(){this.config.playRewinds&&this._material.rewind(),this._material.play()}doInit(){this.viewerApi.onSceneLoadComplete(()=>this._sceneLoadComplete())}doDispose(){this._material&&(this._material.baseColorTexture.muted=!0,this._material.pause(),this._material=void 0)}};r(va,"legacyVolume",.5),r(va,"definition",{name:"Video texture control",type:hn.TWO_STATE,properties:[{id:"material",type:"material",label:"Material with video"},{id:"trigger",type:"trigger",label:"Trigger",optional:!0},{id:"autoplay",type:"bool",label:"Autoplay",defaultValue:!0},{id:"triggerExclusive",type:"bool",label:"Exclusive",defaultValue:!1},{id:"playRewinds",type:"bool",label:"Play rewinds",defaultValue:!1},{id:"loop",type:"bool",label:"Loop",defaultValue:!0},{id:"muted",type:"bool",label:"Muted",defaultValue:!0},{id:"volume",type:"number",label:"Volume",minValue:0,maxValue:1,step:.025,defaultValue:.5,optional:!0}],vrCompatible:!0});let rh=va;const ku={HtmlLabel:Jc,Audio:Zc,MaterialPicker:Bg,MaterialComboPicker:eh,VideoTextureControl:rh,OpenWebsite:Du,ChangeView:Pu,HideAnchors:Cu,Script:Uu,ProjectionScreen:Bu,SwitchObjects:Nu,VideoStream:oh,MultiTrigger:Iu};function zu(s){return ku[s].definition}class qg{constructor(){r(this,"_extensions",new Array);r(this,"_extensionTypes",ku)}updateConfig(e){this._extensions=[];for(const t of e)this._extensions.push(this._createExtensionFromConfig(t))}_augmentTriggerExclusiveExtension(e){if(!(e instanceof Nn&&e.isTriggerExclusive()))return;const t=e.activate;e.activate=i=>{this._extensions.forEach(n=>{if(n instanceof Nn&&n!==e&&n.isTriggerExclusive()&&n.activated())try{n.deactivate()}catch(o){}}),t.call(e,i)}}_createExtensionFromConfig(e){function t(a,l){return a.some(c=>c.name===l&&c.config.type===e.type)}e.name=e.name.toString();const i=e.name;let n=2;for(;t(this._extensions,e.name);)e.name=i+n.toString(),n+=1;const o=new this._extensionTypes[e.type](e);return this._augmentTriggerExclusiveExtension(o),o}initExtensionsByType(e){this._loadFontAwesomeIfNeeded(()=>{this.getExtensionsByType(e).forEach(t=>t.init())})}initExtensions(){this._loadFontAwesomeIfNeeded(()=>{this._extensions.forEach(e=>e.init())})}_loadFontAwesomeIfNeeded(e){const t=this._extensions.map(i=>this._getFonts(i.config)).concat(M.FONT_FAMILIES_TO_LOAD).reduce((i,n)=>i.concat(n),[]).filter((i,n,o)=>n===o.indexOf(i));t.length>0&&!M.EDIT_MODE?Pd(t,e,e):e()}_getFonts(e){function t(a){return a.icon&&pl[a.icon].fontFamily}const i=[];function n(a){const l=t(a);l&&i.push(l)}const o=this._extensionTypes[e.type].definition;for(const a of o.properties)if(a.type==="trigger"&&e[a.id])n(e[a.id]);else if(a.type==="list"&&a.elementType==="trigger"&&e[a.id])for(const l of e[a.id])n(l);return i}disposeExtensions(){this._extensions.forEach(e=>e.dispose())}disposeExtensionsByType(e){this.getExtensionsByType(e).forEach(t=>t.dispose())}getEditableExtensionDefinitions(){const e=[];for(const[t,i]of Object.entries(this._extensionTypes||{}))i.definition.hideFromEditor||e.push({type:t,definition:i.definition});return e}getEditableExtensions(){return this._extensions.filter(e=>!e.definition.hideFromEditor)}getEditableTriggerImagePaths(){const e=i=>i.properties.filter(n=>n.type==="trigger").map(n=>n.id),t=new Set;for(const i of this.getEditableExtensions())e(i.definition).forEach(n=>{i.config[n]&&i.config[n].image&&t.add(i.config[n].image)});return Array.from(t)}addExtension(e){this._extensions.push(e),e.init()}createExtension(e){return this._createExtensionFromConfig(e)}removeExtension(e){e.dispose();const t=this._extensions.indexOf(e);t!==-1&&this._extensions.splice(t,1)}shiftExtension(e,t){Ha(this._extensions,e,t)}getExtensionIndex(e){return this._extensions.findIndex(t=>t===e)}getConfigs(){return this._extensions.map(function(e){return e.config})}getExtensionsByType(e){return this._extensions.filter(t=>t.type===e)}getExtensionByTrigger(e){return this._extensions.find(t=>t.triggers.includes(e))}getExtension(e,t){const i=this._extensions.find(n=>n.type===e&&n.name===t);if(i)return i;console.error(`Unrecognized extension ${e} ${t}, supported types: ${Object.keys(this._extensionTypes)}`)}}const bl={cardboardConfig:{ADDITIONAL_VIEWERS:[],DEFAULT_VIEWER:"",MOBILE_WAKE_LOCK:!0,DEBUG:!1,DPDB_URL:null,CARDBOARD_UI_DISABLED:!1,K_FILTER:.98,ROTATE_INSTRUCTIONS_DISABLED:!1,PREDICTION_TIME_S:.04,YAW_ONLY:!1,BUFFER_SCALE:1,DIRTY_SUBMIT_FRAME_BINDINGS:!1}};class yo{constructor(){this.clock=performance||Date,this.reset()}reset(){this.startMS=this.clock.now()}elapsedMSec(){return this.clock.now()-this.startMS}elapsedSec(){return this.elapsedMSec()*.001}}class ah{constructor(e,t){this.nativeTimeoutId=null,this.durationMSec=e,this.callback=t}isRunning(){return this.nativeTimeoutId!==null}start(){function e(){this.nativeTimeoutId=null,this.callback&&this.callback()}this.nativeTimeoutId!==null&&clearTimeout(this.nativeTimeoutId),this.nativeTimeoutId=setTimeout(e,this.durationMSec)}}function Yg(s,e){var b;const t=new yo,i=new Uint8Array(1*1*4),n=(b=M.BENCHMARK_MEASUREMENTS)!=null?b:60*16,o=3,a=.1;this.benchmarking=e;const l="EXT_disjoint_timer_query_webgl2",c=s,h=c.getSupportedExtensions().includes(l)?c.getExtension(l):null;h||alert(l+" support isn't enabled in this browser. Using gl.readPixels() as a means of synchronisation.");let d=null,u=!1,m=!1,g=[];this.lastMS=0,this.lastFPS=0,this.benchmarking&&document.addEventListener("keydown",x=>{x.code=="KeyB"&&(x.shiftKey?this.extensiveLogging():g=[])}),this.tearDownQuery=function(){u=!1,m=!1,d&&(c&&c.deleteQuery(d),d=null)},this.extensiveLogging=function(){const x=Array.from(g).sort((O,U)=>O-U);this.max=x.at(-1);const v=Math.floor(x.length*(1-a)),E=Math.floor(x.length/2),w=Math.floor(x.length*a),C=x.reduce((O,U)=>O+U,0)/x.length;let I;M.BENCHMARK_LIST_ALL?I=x.reduce((O,U)=>O+U.toFixed(o)+";",""):I=`high median average low 
`+x[v].toFixed(o)+" "+x[E].toFixed(o)+" "+C.toFixed(o)+" "+x[w].toFixed(o)+` 
`,M.BENCHMARK_OUTPUT==="console"?console.log(I):prompt(I+`
You can copy the result of the performance measurement by CTRL-C`,I),g=[]},this.addNewMeasurement=function(x){this.lastMS=x,this.lastFPS=1e3/this.lastMS,this.benchmarking&&(g.push(this.lastMS),g.length==n&&this.extensiveLogging())},this.glQueryEnd=function(){if(m||(c.endQuery(h.TIME_ELAPSED_EXT),m=!0),c.getParameter(h.GPU_DISJOINT_EXT)){this.tearDownQuery();return}if(!c.getQueryParameter(d,c.QUERY_RESULT_AVAILABLE))return;const E=c.getQueryParameter(d,c.QUERY_RESULT);this.addNewMeasurement(E/Math.pow(10,6)),this.tearDownQuery()},this.begin=function(){t.reset(),h&&!u&&(d=c.createQuery(),c.beginQuery(h.TIME_ELAPSED_EXT,d),u=!0)},this.end=function(){h?u&&this.glQueryEnd():(c.readPixels(0,0,1,1,c.RGBA,c.UNSIGNED_BYTE,i),this.addNewMeasurement(t.elapsedSec()*1e3))}}function Vu(s,e){let t=null;function i(){t=null,s()}this.deferRun=function(){t!==null&&clearTimeout(t),t=setTimeout(i,e)}}function Qg(s,e){let t=null;function i(){s()}this.deferRun=function(){t!==null&&clearInterval(t),t=setInterval(i,e)}}/*!
 * Copyright (C) 2018-present unreal engine
 */const Kg=10,$g=200,Gu=1.3,Zg=1/5,Hu=1,Jg=1.9,ev=1.5,Ao=new F;function lh(s){if(s.empty())return 0;s.size(Ao);const e=Ao.x*Ao.y;return Ao.x<Hu||Ao.y<Hu||Ao.z<Jg||e<ev?0:e*Ao.z}function tv(s,e,t=.1){return s.min.x-t<=e.min.x&&e.max.x<=s.max.x+t&&s.min.y-t<=e.min.y&&e.max.y<=s.max.y+t&&s.min.z-t<=e.min.z&&e.max.z<=s.max.z+t}function iv(s,e,t=.2){return!(s.max.x<e.min.x+t||s.min.x>e.max.x-t||s.max.y<e.min.y+t||s.min.y>e.max.y-t||s.max.z<e.min.z+t||s.min.z>e.max.z-t)}class Wu{constructor(e){r(this,"_emptyBoxes",new Array);r(this,"_filledBoxes",new Array);r(this,"_tempBoxes",new Array);this._emptyBoxes.push(e);for(let t=0;t<6;t++)this._tempBoxes[t]=new ti}addFilledBox(e){this._filledBoxes.push(e)}findBestFilledBoxes(){let e=new Array;this._filledBoxes.forEach(i=>e.push([i,i.volume()]));const t=new Array;for(;e.length>0&&t.length<Kg;){const i=Ec(e,o=>o[1]),n=e[i][0];t.push(n),e=e.filter(o=>!iv(o[0],n))}return t}isEnclosedInFilledBox(e){return this._filledBoxes.some(t=>tv(t,e))}findLargestEmptyBox(){const e=Ec(this._emptyBoxes,t=>t.volume());return e!==void 0?this._emptyBoxes[e]:void 0}_visualizeBoxes(e,t,i,n=0){const o=new F,a=new Array,l=new ti;for(const c of e){l.copyFrom(c),l.min.subScalar(n),l.max.addScalar(n);const h=new Ye(t,i);o.addVectors(l.min,l.max).multiplyScalar(.5),h.scale.subVectors(l.min,l.max),h.position.copyFrom(o),a.push(h)}return a}visualize(e){const t=nt.createBox(1,1,1),i=new Ts(new be(65280)),n=new Ts(new be(16711680)),o=.1,a=this._visualizeBoxes(this._emptyBoxes,t,i),l=this._visualizeBoxes(this._filledBoxes,t,n,o);for(const c of[...a,...l])e.add(c);e.updateMatrixWorld()}_doSplit(e,t,i){const n=this._tempBoxes;n[0].max.copyFrom(e.max),n[0].min.copyFrom(e.min),n[0].min.z=t.max.z,n[1].max.copyFrom(e.max),n[1].max.z=t.min.z,n[1].min.copyFrom(e.min),n[2].max.copyFrom(e.max),n[2].min.copyFrom(e.min),n[2].min.x=t.max.x,n[3].max.copyFrom(e.max),n[3].max.x=t.min.x,n[3].min.copyFrom(e.min),n[4].max.copyFrom(e.max),n[4].min.copyFrom(e.min),n[4].min.y=t.max.y,n[5].max.copyFrom(e.max),n[5].max.y=t.min.y,n[5].min.copyFrom(e.min);const o=Ec(n,lh);lh(n[o])!==0&&(i.push(n[o].clone()),o===0?e.max.z=t.max.z:o===1?e.min.z=t.min.z:o===2?e.max.x=t.max.x:o===3?e.min.x=t.min.x:o===4?e.max.y=t.max.y:o===5&&(e.min.y=t.min.y),this._doSplit(e,t,i))}split(e){const t=new Array;for(let i=0;i<this._emptyBoxes.length;i+=1){const n=this._emptyBoxes[i];n.isIntersectionBox(e)?this._doSplit(n,e,t):t.push(n)}this._emptyBoxes=t}}r(Wu,"DEBUG",!1);function ju(s,e){s.center(e.position),e.position.z=s.min.z+Gu}function nv(s,e,t){const i=new Wu(s.boundingBox.clone()),n=new ti,o=new ti,a=new F,l=new yo,c=new Mi({id:0});for(let m=0;m<$g;m+=1){const g=i.findLargestEmptyBox();if(g===void 0)break;ju(g,c),c.enableBoundingBox(),o.makeEmpty();for(let b=0;b<5&&(e.findBounds(c),!!c.isBoundingBoxInitialized());b+=1){n.set(c.boxMin,c.boxMax);const x=lh(n);if(x===0||i.isEnclosedInFilledBox(n))break;n.center(a),a.z=n.min.z+Gu;const v=c.position.distanceToSquared(a);if(o.volume()<x&&v<.25&&o.set(n.min,n.max),v<.04)break;c.position.copyFrom(a)}o.empty()?(g.center(n.min),g.center(n.max),i.split(n)):(i.addFilledBox(o.clone()),i.split(o))}Me.log("Light probes arrangement time "+l.elapsedSec());const h=i.findBestFilledBoxes(),d=h.reduce((m,g)=>m+g.volume(),0);function u(m){const g=new Mi({id:s.lightProbes.length});ju(m,g),g.enableBoundingBox(),g.boxMin.copyFrom(m.min),g.boxMax.copyFrom(m.max),s.lightProbes.push(g)}(d>s.boundingBox.volume()*Zg||t)&&h.forEach(u),s.lightProbes.length===0&&t&&u(s.boundingBox)}class ch{static merge(e){const t={};for(let i=0;i<e.length;i++){const n=ch.clone(e[i]);for(const o in n)Object.prototype.hasOwnProperty.call(n,o)&&(t[o]=n[o])}return t}static clone(e){const t={};for(const i in e)if(Object.prototype.hasOwnProperty.call(e,i)){t[i]={};for(const n in e[i]){if(!Object.prototype.hasOwnProperty.call(e[i],n))continue;const o=e[i][n];o&&o.clone!==void 0?t[i][n]=o.clone():o instanceof Array?t[i][n]=o.slice():t[i][n]=o}}return t}}var Xu=(s=>(s.DISPOSED="webGLRenderTargetDisposed",s))(Xu||{});const nc=class nc extends ei{constructor(t,i,n){var o,a,l,c,h,d,u,m,g,b;super();r(this,"x",0);r(this,"y",0);r(this,"width");r(this,"height");r(this,"wrapS");r(this,"wrapT");r(this,"magFilter");r(this,"minFilter");r(this,"anisotropy");r(this,"offset",new Ce(0,0));r(this,"repeat",new Ce(1,1));r(this,"format");r(this,"depthBuffer");r(this,"stencilBuffer");r(this,"generateMipmaps");r(this,"shareDepthFrom");r(this,"isCube",!1);r(this,"loaded",!0);r(this,"useDepthTexture");r(this,"depthTexture",null);r(this,"webglFramebuffer",null);r(this,"webglRenderbuffer",null);r(this,"webglTexture",null);r(this,"webglSlot",null);this.width=t,this.height=i,n=n||{},this.wrapS=(o=n.wrapS)!=null?o:Z.CLAMP_TO_EDGE,this.wrapT=(a=n.wrapT)!=null?a:Z.CLAMP_TO_EDGE,this.magFilter=(l=n.magFilter)!=null?l:Z.LINEAR,this.minFilter=(c=n.minFilter)!=null?c:Z.LINEAR_MIPMAP_LINEAR,this.anisotropy=(h=n.anisotropy)!=null?h:1,this.format=(d=n.format)!=null?d:Be.RGBA8,this.depthBuffer=(u=n.depthBuffer)!=null?u:!0,this.stencilBuffer=(m=n.stencilBuffer)!=null?m:!0,this.generateMipmaps=n.generateMipmaps||!1,this.shareDepthFrom=(g=n.shareDepthFrom)!=null?g:null,this.useDepthTexture=(b=n.useDepthTexture)!=null?b:!1}dispose(){this.dispatchEvent({type:nc.eventType.DISPOSED})}};r(nc,"eventType",Xu);let sr=nc;var qu=(s=>(s.DISPOSED="webGLRenderTargetVRDisposed",s))(qu||{});const sc=class sc extends ei{constructor(t){super();r(this,"webglFramebuffer");r(this,"x",null);r(this,"y",null);r(this,"width",null);r(this,"height",null);r(this,"isCube",!1);this.webglFramebuffer=t}dispose(){this.webglFramebuffer=null,this.dispatchEvent({type:sc.eventType.DISPOSED})}};r(sc,"eventType",qu);let hh=sc;class as{constructor(e,t,i){r(this,"textureID");r(this,"depthID");r(this,"material");r(this,"uniforms");r(this,"camera",Li.createNDC());r(this,"scene",new nr);r(this,"quad");r(this,"renderToScreen",!1);r(this,"enabled",!0);r(this,"needsSwap",!0);r(this,"clear",!1);this.textureID=t!=null?t:"tDiffuse",this.depthID=i!=null?i:"tDepth",this.material=new Ht({vsName:e.vertexShaderName,fsName:e.fragmentShaderName}),this.material.uniforms=ch.clone(e.uniforms),this.uniforms=this.material.uniforms,this.quad=new Ye(nt.createPlane(2,2),this.material),this.scene.add(this.quad)}render(e,t,i=null){const n=this.material.uniforms[this.textureID];n&&(n.value=i);const o=this.material.uniforms[this.depthID];o&&(o.value=i.depthTexture),this.renderToScreen?e.render(this.scene,this.camera):e.render(this.scene,this.camera,t,this.clear)}dispose(){this.material.dispose(),this.quad.geometry.dispose()}}var Cs=(s=>(s.PROCEDURAL="procedural",s.EQUIRECT="equirect",s))(Cs||{}),Yu=(s=>(s.UPDATED="skyMeshUpdated",s))(Yu||{});const oc=class oc extends Ye{constructor(t,i,n,o){super(i,n);r(this,"autoPosition");r(this,"name");r(this,"fog");r(this,"_updatedEvent",{type:oc.eventType.UPDATED,target:this});o&&this.position.fromArray(o),this.autoPosition=!o,this.name=t,n instanceof Nc&&n.addEventListener(Ht.eventType.MATERIAL_UPDATED,()=>{this._updated()})}setTexture(t){Pe(this.type==="equirect"),this.material.map=t,this.yawRotationDeg=0,this._updated()}_updated(){this.dispatchEvent(this._updatedEvent)}update(t){if(!(this.material instanceof Nc)||!this.material.useSunLightPosition)return;const i=t.lightManager.getSunLight();if(i){const n=i.instances[0].rotation,o=new ui(n.yaw,n.pitch,0);this.material.sunDirection=o.applyToVector3(new F(0,-1,0)).normalize()}else this.material.useSunLightPosition=!1}get type(){return this.isEquirect?"equirect":"procedural"}get yawRotationDeg(){return mn(this.rotation.y)}set yawRotationDeg(t){const i=qt(t);this.rotation.y=i,this.updateMatrixWorld(),this._updated()}get isEquirect(){return this.material instanceof Jd}get radius(){return this.scale.x}set radius(t){this.scale.set(t,t,t),this.updateMatrixWorld(!0),this._updated()}serialize(){var i;const t={name:this.name,type:this.type};return this.autoPosition||(t.center=this.position.toArray()),this.isEquirect?(t.yawRotation=this.yawRotationDeg,t.texture=this.material.map?this.material.map.serialize():null):t.proceduralMaterial=this.material.serialize(),(i=this.fog)!=null&&i.enabled()&&(t.fog=this.fog.serialize()),t}clone(){throw Error("SkyMesh can't be cloned.")}};r(oc,"eventType",Yu);let zr=oc;/*!
 * Copyright (C) 2015-present unreal engine
 */function sv(s){return{uniforms:{roughness:{type:"f",value:.9},face:{type:"f",value:0},mipSize:{type:"f",value:128},envMap:{type:"t",value:null},envMapFiltered:{type:"t",value:null},integrationNumSamples:{type:"i",value:s}},vertexShaderName:"cubemap_filter_vertex.glsl",fragmentShaderName:"cubemap_filter_fragment.glsl"}}function dh(s){const e=new be;let t=null,i=!1;this.set=function(n,o=void 0){console.assert(!i),i=!0,e.copyFrom(s.getClearColor()),t=s.getClearAlpha(),s.setClearColor(n,o)},this.restore=function(){console.assert(i),i=!1,s.setClearColor(e,t)}}function ov(s,e){return Math.round(s[e]*256*256+s[e+1]*256+s[e+2])}function rv(s,e){const t=s.length;for(let i=0;i<t;i+=4){const n=ov(s,i);n!==16777215&&e.add(n)}}function av(s,e,t){const i=new K0(!0),n=new Lc(M.CAMERA_WALK_NEAR,t),o=M.OBJECT_VISIBILITY_TARGET_SIZE;let a=s.createRenderTarget(o,o,{magFilter:Z.NEAREST,minFilter:Z.NEAREST,depthBuffer:!0,stencilBuffer:!1,generateMipmaps:!1}),l=new Uint8Array(4*o*o);const c=new is(s),h=new dh(s);this.findVisibleObjects=function(d){const u=new Set,m=[];n.position.copyFrom(d),n.updateMatrixWorld();for(let b=0;b<e.length;b+=1){const x=e[b];console.assert(!x.visibilityId),x.visibilityId=b,m.push(x)}c.set(!0,!0,!1),h.set(be.WHITE);for(let b=0;b<6;b+=1)s.renderMeshes(m,i,n.sideCameras[b],a),s.readPixels(o,o,l),rv(l,u);h.restore(),c.restore();const g=[];for(let b of u)g.push(e[b]);for(let b=0;b<e.length;b+=1)e[b].visibilityId=null;return g},this.dispose=function(){i.dispose(),a.dispose(),a=null,l=null}}/*!
 * Copyright (C) 2014-present unreal engine
 */function lv(s,e){for(const t of s)if(t.material.envMapMirror&&t.lightProbes.includes(e))return!0;return!1}function cv(s,e){return Math.pow(2,gc(e)-s)}let ls;function hv(s,e){let t=null,i=0;const n=e*e;console.assert(n<Math.pow(2,16)),ls||(ls=new Uint16Array(256*256));for(let o=0;o<n*4;o+=4){const a=s[o],l=s[o+1];ls[a*256+l]+=1}ls[0]>.7*n&&(i=ls[0]),ls[0]=0;for(let o=1;o<ls.length;o+=1)ls[o]>i&&(i=ls[o],t=Math.floor(o/256)+o%256/255),ls[o]=0;return t}const ba=class ba{constructor(e,t,i,n,o){r(this,"_renderer");r(this,"_scene");r(this,"_aabbQueryMaterial",new R0);r(this,"_filterPass");r(this,"_pixelBuf");r(this,"_targetCubeRaw");r(this,"_targetFiltered");r(this,"_autoClearAlter");r(this,"_timer",new yo);r(this,"_cubeCamera");r(this,"_objectVisibilityQuery");r(this,"_mirrorCubeTexturesEnabled");r(this,"_alwaysCreateMirrorCubeTextures");r(this,"_orthoCubeCamera");r(this,"_numRenderedCubeMaps",0);const a={magFilter:Z.LINEAR,minFilter:Z.LINEAR,depthBuffer:!0,stencilBuffer:!1,generateMipmaps:!1};this._renderer=t,this._scene=e,this._filterPass=new as(sv(o),"envMap");const l=M.LIGHT_PROBE_MAX_MIP_SIZE;this._pixelBuf=new Uint8Array(l*l*4),this._targetCubeRaw=t.createRenderTargetCube(l,l,a),a.depthBuffer=!1,this._targetFiltered=t.createRenderTarget(l,l,a),this._autoClearAlter=new is(t),this._cubeCamera=new Lc(ba.CUBE_CAMERA_NEAR,e.camera.far),this._mirrorCubeTexturesEnabled=i,this._alwaysCreateMirrorCubeTextures=n}_dumpCubeMapFace(e,t,i){const n=e.width,o=e.height,a=new Uint8Array(n*o*4);this._renderer.readPixels(n,o,a);const l=String(i).padStart(4,"0");wp(d0(n,o,a),`cubemap_${l}_${t}.tga`)}_lightProbeRenderingSettingsOn(e,t,i,n=!1){this._scene.sharedMaterialState.hdrOutput=!0,this._scene.gpuMeshes.forEach(o=>{o.materialOverride&&!i.has(o)&&(i.set(o,o.materialOverride),o.materialOverride=null)}),this._scene.skyMeshes.forEach(o=>{i.set(o,o.visible),o.visible=!0}),this._scene.threeScene.traverse(function(o){if(!(o instanceof Ye)||!o.visible)return;const a=o.material;if(o.userData.hideFromLightProbes||a.hideFromLightProbes||n&&!(o instanceof zr)){e.add(o),o.visible=!1;return}!(a instanceof gt)||t.has(a)||(t.set(a,{disableLightProbe:a.disableLightProbe,headLight:a.headLight}),a.transparent=!1,a.blending=yi.DISABLED,a.depthWrite=!0,a.headLight!==void 0&&(a.headLight=!1),a.disableLightProbe=!0,a.setUniforms())})}_lightProbeRenderingSettingsOff(e,t,i){this._scene.sharedMaterialState.hdrOutput=!1,this._scene.gpuMeshes.forEach(n=>{i.has(n)&&(n.materialOverride=i.get(n),i.delete(n))}),this._scene.skyMeshes.forEach(n=>{i.has(n)&&(n.visible=i.get(n),i.delete(n))}),this._scene.threeScene.traverse(function(n){if(!(n instanceof Ye))return;const o=n.material;if(o instanceof gt&&o.forceObjectUniformsRefresh(),!n.visible){e.has(n)&&(n.visible=!0);return}if(o instanceof gt){const a=t.get(o);if(!a)return;t.delete(o),o.configureTransparency(),a.headLight!==void 0&&(o.headLight=a.headLight),o.disableLightProbe=a.disableLightProbe,o.setUniforms()}})}_renderLightProbe(e,t){for(let i=0;i<6;i+=1){t.activeCubeFace=i;const n=e.sideCameras[i];this._renderer.render(this._scene.threeScene,n,t)}this._numRenderedCubeMaps++}_createMirrorCubeTexture(e){const t=M.LIGHT_PROBE_MIRROR_SIZE,i=this._renderer.createRenderTargetCube(t,t,{magFilter:Z.LINEAR,minFilter:Z.LINEAR,stencilBuffer:!1,generateMipmaps:!1});return this._renderLightProbe(e,i),this._renderer.deallocateRenderTargetRenderingBuffers(i),i}_findLightProbeBounds(e,t){const i=this._targetCubeRaw;this._pixelBuf,this._orthoCubeCamera||(this._orthoCubeCamera=new v0(.01,255)),this._orthoCubeCamera.position.copyFrom(e.position),this._orthoCubeCamera.updateMatrixWorld();for(let n=0;n<6;n+=1){i.activeCubeFace=n,this._aabbQueryMaterial.axis=Math.floor(n/2),this._renderer.renderMeshes(this._scene.gpuMeshes,this._aabbQueryMaterial,this._orthoCubeCamera.sideCameras[n],i),this._renderer.readPixels(i.width,i.height,this._pixelBuf);const o=hv(this._pixelBuf,i.width);if(o===null){Me.log("Failed to find light probe bounds"),Me.log(`Light probe bounds: X[${t.boxMin.x.toFixed(2)}:${t.boxMax.x.toFixed(2)}] Y[${t.boxMin.y.toFixed(2)}:${t.boxMax.y.toFixed(2)}] Z[${t.boxMin.z.toFixed(2)}:${t.boxMax.z.toFixed(2)}]`),t.resetBoundingBox();return}const a=Math.floor(n/2),l=n&1?-1:1;(n&1?t.boxMin:t.boxMax).setComponent(a,e.position.getComponent(a)+o*l)}}_fillMipDebugBuffer(e,t,i){const n=255*e/M.LIGHT_PROBE_MIPS_COUNT;for(let o=0;o<4*t*t;o+=4)i[o]=n,i[o+1]=n,i[o+2]=n,i[o+3]=255/8}_readBuffer(e,t,i){let n=!0;for(;n;){e.readPixels(t,t,i);for(let o=0;o<t*t*4;o+=4)if(i[o]!==0||i[o+1]!==0||i[o+2]!==0){n=!1;break}if(n){console.warn("Cube face has all pixels black.");return}}}_generateFilteredTextureMip(e,t,i,n,o,a,l,c){M.DEBUG_LIGHT_PROBE_MIPS&&this._fillMipDebugBuffer(l,o,a);for(let h=0;h<6;h+=1)M.DEBUG_LIGHT_PROBE_MIPS||(t.uniforms.face.value=h,t.render(e,n,i),this._readBuffer(e,o,a)),e.copyFramebufferToCubeFaceMip(l,o,h,a,c)}createTextures(e,t,i,n){if(this._autoClearAlter.set(!0,!0,!1),i){const l=this._createMirrorCubeTexture(e);n.setMirrorTexture(l)}t&&this._findLightProbeBounds(e,n),this._renderLightProbe(e,this._targetCubeRaw),this._autoClearAlter.restore(),this._renderer.enableScissorTest(!0),this._autoClearAlter.set(!1,!1,!1);const o=this._targetFiltered.width,a=this._renderer.createCubeTexture(o,!0);n.setFilteredTexture(a),this._filterPass.uniforms.envMapFiltered.value=a;for(let l=0;l<M.LIGHT_PROBE_MIPS_COUNT;l+=1){const c=cv(l,o);this._renderer.setScissor(0,0,c,c);const h=l/(M.LIGHT_PROBE_MIPS_COUNT-1);this._filterPass.uniforms.mipSize.value=c,this._filterPass.uniforms.mipSize.value=c,this._filterPass.uniforms.roughness.value=h,this._pixelBuf,this._generateFilteredTextureMip(this._renderer,this._filterPass,this._targetCubeRaw,this._targetFiltered,c,this._pixelBuf,l,a)}this._renderer.enableScissorTest(!1),this._autoClearAlter.restore()}assignLightProbeIfClosest(e,t){t.geometry.boundingSphere;const i=t.geometry.boundingSphere.center,n=M.ENABLE_REFLECTION_PROBES_BLENDING?M.MAX_BLENDED_REFLECTION_PROBES:1;if(t.lightProbes.length==0){t.lightProbes.push(e);return}const o=i.distanceTo(e.position);let a=t.lightProbes.findIndex(l=>o<=i.distanceTo(l.position));for(a===-1&&(a=t.lightProbes.length),t.lightProbes=[...t.lightProbes.slice(0,a),e,...t.lightProbes.slice(a,t.lightProbes.length)];t.lightProbes.length>n;)t.lightProbes.pop()}_assignFallbackLightProbesToObjects(e,t){Me.log("No visible light probe found for "+t.length+" objects. Assigning the closest ones.");for(let i=0;i<t.length;i+=1)for(let n=0;n<e.length;n+=1)this.assignLightProbeIfClosest(e[n],t[i])}assignLightProbesToObjects(){this._timer.reset(),this._objectVisibilityQuery||(this._objectVisibilityQuery=new av(this._renderer,this._scene.gpuMeshes,this._scene.camera.far));for(const t of this._scene.gpuMeshes)t.lightProbes=[];for(const t of this._scene.lightProbes){const i=this._objectVisibilityQuery.findVisibleObjects(t.position);Me.log("Have visible objects "+i.length);for(const n of i)this.assignLightProbeIfClosest(t,n)}Me.log("Light probe assigment time "+this._timer.elapsedSec());const e=t=>t.lightProbes.length===0;this._assignFallbackLightProbesToObjects(this._scene.lightProbes,this._scene.gpuMeshes.filter(e))}_doCreateLightProbeTexture(e,t){this._cubeCamera.position.copyFrom(e.position),this._cubeCamera.updateMatrixWorld();const i=this._mirrorCubeTexturesEnabled&&(this._alwaysCreateMirrorCubeTextures||lv(this._scene.gpuMeshes,e));i&&Me.log("Mirror texture needed for the light probe."),this._timer.reset(),this.createTextures(this._cubeCamera,t,i,e),Me.log("Cube generation time "+this._timer.elapsedSec())}findBounds(e){this._cubeCamera.position.copyFrom(e.position),this._cubeCamera.updateMatrixWorld(),this._autoClearAlter.set(!0,!0,!1),this._findLightProbeBounds(this._cubeCamera,e),this._autoClearAlter.restore()}createLightProbeTexture(e,t){const i=new Set,n=new Map,o=new Map;this._lightProbeRenderingSettingsOn(i,n,o),this._doCreateLightProbeTexture(e,t),this._lightProbeRenderingSettingsOff(i,n,o)}createAllLightProbeTextures(){const e=new Set,t=new Map,i=new Map;this._lightProbeRenderingSettingsOn(e,t,i);for(const n of this._scene.lightProbes)this._doCreateLightProbeTexture(n,!1);this._lightProbeRenderingSettingsOff(e,t,i)}createSkyLightProbe(e){const t=new Set,i=new Map,n=new Map,o=new Mi({id:0,position:[0,0,0]},!0);e.material.lightmapSupported=!1,this._scene.addSkyMesh(e),this._lightProbeRenderingSettingsOn(t,i,n,!0),this._doCreateLightProbeTexture(o,!1),this._lightProbeRenderingSettingsOff(t,i,n),this._scene.removeSkyMesh(e),this._scene.sharedMaterialState.builtinLightProbe=o}dispose(){this._targetCubeRaw.dispose(),this._targetFiltered.dispose(),this._aabbQueryMaterial.dispose(),this._filterPass.material.dispose(),this._pixelBuf=void 0,this._objectVisibilityQuery&&(this._objectVisibilityQuery.dispose(),this._objectVisibilityQuery=void 0)}};r(ba,"DUMP_CUBE_MAPS",!1),r(ba,"CUBE_CAMERA_NEAR",.15);let uh=ba;class Qu extends as{constructor(){const e={uniforms:{inputBuffer:{type:"t",value:null},weight:{type:"f",value:1}},vertexShaderName:"accumulate_vertex.glsl",fragmentShaderName:"accumulate_fragment.glsl"};super(e,"inputBuffer"),this.material.depthTest=!1,this.material.depthWrite=!1,this.material.blending=yi.CUSTOM,this.material.blendEquation=Z.FUNC_ADD,this.material.blendDst=Z.ONE_MINUS_SRC_ALPHA,this.material.blendSrc=Z.SRC_ALPHA}}function dv(s,e,t,i,n){const o=s/e,a=Math.tan(qt(n.fov)*.5),l=n.near*a/n.zoom,c=-l,h=c*o,d=l*o,u=(d-h)/s,m=(l-c)/e;n.projectionMatrix.makeFrustum(h-t*u,d-t*u,c-i*m,l-i*m,n.near,n.far)}function uv(s,e,t,i,n){const o=n.top,a=n.bottom,l=n.left,c=n.right,h=(c-l)/s,d=(a-o)/e;n.projectionMatrix.makeOrthographic(l-t*h,c-t*h,o-i*d,a-i*d,n.near,n.far)}function Ku(s){if(s instanceof As)return dv;if(s instanceof Li)return uv;console.error("Unsupported camera type")}function fv(){const s={uniforms:{tDiffuse:{type:"t",value:null}},vertexShaderName:"copy_texture_vertex.glsl",fragmentShaderName:"copy_texture_fragment.glsl"},e=new as(s);return e.renderToScreen=!0,e}function fh(s,e,t){t===void 0&&(e.camera.addEventListener(gi.eventType.PROJECTION_TYPE_UPDATED,()=>this.updateProjectionType()),t=e.camera.current);let i,n,o=0;const a=[[.375,.4375],[.625,.0625],[.875,.1875],[.125,.0625],[.375,.6875],[.875,.4375],[.625,.5625],[.375,.9375],[.625,.3125],[.125,.5625],[.125,.8125],[.375,.1875],[.875,.9375],[.875,.6875],[.125,.3125],[.625,.8125]],l=new Qu,c=fv(),h=new is(s);let d=Ku(t);this.updateProjectionType=()=>{t=e.camera.current,d=Ku(t)},this.reset=function(){o=0},this.renderSample=function(u,m){console.assert(o<a.length),h.set(!0,!0,!1),d(n.width,n.height,a[o][0]-.5,a[o][1]-.5,t),u?s.renderMeshes(u,m,t,i,!0):(console.assert(!(m!==void 0&&u===void 0),"Passing overrideMaterial without passing meshes is not implemented"),s.render(e.threeScene,t,i,!0)),h.restore(),h.set(!1,!1,!1),l.uniforms.weight.value=1/(o+1),l.render(s,n,i),h.restore(),t.updateProjectionMatrix(),o+=1},this.renderedSamplesCount=function(){return o},this.allSamplesRendered=function(){return o===a.length},this.renderAllSamples=function(u,m){for(;!this.allSamplesRendered();)this.renderSample(u,m)},this.renderAccumulatedSamplesToScreen=function(){h.set(!0,!0,!1),c.render(s,void 0,n),h.restore()},this.copyAccumulatedSamplesToBuffer=function(){const u=n.width,m=n.height,g=new Uint8Array(u*m*4);return s.readPixels(u,m,g),g},this.setTargets=function(u,m){console.assert(u.width===m.width&&u.height===m.height),i=u,n=m},this.dispose=function(){l.material.dispose()}}function mv(s){const e=new e_(new be(0,0,0),1),t=new gt;return t.sharedMaterialState=s.sharedMaterialState,t.reflective=!1,t.headLight=!1,t.setUniforms(),{outlineMaterial:e,planMaterial:t}}function pv(s,e,t,i){const n=Math.max(s,e),o=Math.max(t.size().x,t.size().y);return n/o*i}function _v(s,e,t){for(let i=0;i<t;++i)for(let n=0;n<e;++n){const o=4*(i*e+n);if(i<t/2){const a=4*((t-i-1)*e+n);for(let l=0;l<4;++l){const c=s[o+l];s[o+l]=s[a+l],s[a+l]=c}}}}function $u(s,e){return console.assert(e%4===0,"id passed does not point to alpha channel"),s[e+3]!==0}function Zu(s,e){return console.assert(e%4===0,"id passed does not point to alpha channel"),s[e+3]<255}function gv(s,e,t){return s[t+3]<255&&s[t+3]>=s[e+3]}function vv(s,e){for(let t=0;t<s.length;t+=4)if($u(e,t)){const i=e[t+3]/255;for(let n=0;n<3;++n)s[t+n]=s[t+n]*(1-i)+e[t+n]*i;s[t+3]=255}}function bv(s,e=void 0){const t=new Uint8Array(s.length);for(let i=0;i<s.length;i+=4)if($u(s,i)&&(!e||Zu(e,i)))for(let n=0;n<4;++n)t[i+n]=255;return t}function xv(s,e,t){return s[t]===0&&Zu(e,t)}function yv(s,e,t,i){return s[i]===0&&gv(e,t,i)}function Ju(s,e,t){e[s]=1,t.push(s)}function Av(s,e,t,i,n){for(let o=0;o<e.length;++o)yv(t,i,s,s+e[o])&&Ju(s+e[o],t,n)}function Ev(s,e,t,i){const n=[],o=[];for(Ju(s,t,o);o.length;){const a=o.pop();n.push(a),Av(a,e,t,i,o)}return n}function Tv(s,e,t){for(let i=0;i<s.length;++i)t[s[i]]=255*e.r,t[s[i]+1]=255*e.g,t[s[i]+2]=255*e.b,t[s[i]+3]=255}function Sv(s,e,t,i=.02){const n=new Uint8Array(e.length),o=e.length/4*i,a=[-4,4,-s*4,s*4];for(let l=0;l<e.length;l+=4)if(xv(n,e,l)){const c=Ev(l,a,n,e);c.length<o&&Tv(c,t,e)}return e}function mh(s,e,t){return s.createRenderTarget(e,t,{magFilter:Z.NEAREST,minFilter:Z.NEAREST,stencilBuffer:!1,generateMipmaps:!1})}function ph(s,e,t){s.near=e,s.far=t,s.updateProjectionMatrix()}function wv(s,e){const t={uniforms:{tColor:{type:"t",value:null},tAlpha:{type:"t",value:null},colorFill:{type:"c",value:null}},vertexShaderName:"minimap_add_alpha_vertex.glsl",fragmentShaderName:"minimap_add_alpha_fragment.glsl"},i=new as(t,"tColor");return i.uniforms.tAlpha.value=s,e&&(i.material.condDefine(!0,"USE_ALPHA_FROM_COLOR"),i.uniforms.colorFill.value=e),i}function Mv(s,e){const i=new be(1,1,1),n=mv(e);function o(c,h,d,u,m,g,b){const x=new Uint8Array(h.width*h.height*4),v=new is(s),E=new dh(s);v.set(!0,!0,!1),E.set(new be(0),0);const w=[];if(e.gpuMeshes.forEach(C=>{(C.logicalMeshes||[C]).forEach(O=>{const U=m?!O.node.disableCollisions:!0;(u?!O.material.transparent:!0)&&U&&w.push(O)})}),g){const C=mh(s,h.width,h.height),I=mh(s,h.width,h.height),O=new fh(s,e,c);O.setTargets(C,I),O.renderAllSamples(w,d);const U=wv(C,b);v.restore(),v.set(!0,!0,!1),U.render(s,h,I),v.restore(),s.readPixels(h.width,h.height,x),C.dispose(),I.dispose(),O.dispose()}else s.renderMeshes(w,d,c,h),v.restore(),s.readPixels(h.width,h.height,x);return E.restore(),_v(x,h.width,h.height),x}function a(c,h,d,u,m){const g=pv(u,m,d,.1),b=c/g;n.outlineMaterial.setUniform("thickness","f",b),n.outlineMaterial.setUniform("color","c",h)}this.createMinimapImageDataComponents=function(c,h,d,u){a(c.outlineThickness,i,e.boundingBox,d,u);const m=h.cropRange.center(),g=mh(s,d,u),b=new Li(h.visibleRange.min.x-m.x,h.visibleRange.max.x-m.x,h.visibleRange.min.y-m.y,h.visibleRange.max.y-m.y,0,10);b.rotation.set(0,0,h.rotation*-1),b.position.set(m.x,m.y,h.slicePlaneHeight),b.updateMatrixWorld(!0),ph(b,0,h.slicePlaneHeight-h.farPlaneHeight);const x=o(b,g,n.planMaterial,!0,!0,!0);let v;e.minimapConfig.outlineThickness>0&&(ph(b,0,.1),v=o(b,g,n.outlineMaterial,!0,!0,!0,c.outlineColor),e.minimapConfig.fillEnabled&&Sv(d,v,c.outlineColor),vv(x,v)),g.dispose();const E=bv(x,v),w=new Uint8ClampedArray(x.buffer),C=new ImageData(w,d,u),I=new Uint8ClampedArray(E.buffer),O=new ImageData(I,d,u);return{minimapImageData:C,walkableImageData:O}};function l(c,h,d){a(c.outlineThickness,c.outlineColor,e.collisionBoundingBox,h,d);const u=s.createRenderTarget(h,d,{magFilter:Z.NEAREST,minFilter:Z.NEAREST,stencilBuffer:!1,generateMipmaps:!1}),m=new Li(e.collisionBoundingBox.min.x,e.collisionBoundingBox.max.x,e.collisionBoundingBox.max.y,e.collisionBoundingBox.min.y,0,10);m.position.set(0,0,c.slicePlaneHeight),m.updateMatrixWorld(!0),ph(m,0,.1);const g=o(m,u,n.outlineMaterial,!1,!0);u.dispose();const b=new Uint8ClampedArray(g.buffer);return new ImageData(b,h,d)}this.getCollisionData=function(c,h,d){const u={x:{min:0,max:h},y:{min:0,max:d}},m={x:{min:e.collisionBoundingBox.min.x,max:e.collisionBoundingBox.max.x},y:{min:e.collisionBoundingBox.max.y,max:e.collisionBoundingBox.min.y}};return{collisionImageData:l(c,h,d),canvasRange:u,collisionRange:m}},this.calculateRenderSize=function(c,h){const d=h.empty()?1:h.size().y/h.size().x,u=d<1?c:Math.round(c*(1/d)),m=d<1?Math.round(c*d):c;return{width:u,height:m}}}var Pv=globalThis&&globalThis.t||function(){var s=function(e,t){return s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(i,n){i.__proto__=n}||function(i,n){for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(i[o]=n[o])},s(e,t)};return function(e,t){if(typeof t!="function"&&t!==null)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");s(e,t);function i(){this.constructor=e}e.prototype=t===null?Object.create(t):(i.prototype=t.prototype,new i)}}(),Cv=function(){function s(e){e===void 0&&(e=0),this.iteratorType=e}return s.prototype.equals=function(e){return this.o===e.o},s}(),Rv=function(){function s(){this.i=0}return Object.defineProperty(s.prototype,"length",{get:function(){return this.i},enumerable:!1,configurable:!0}),s.prototype.size=function(){return this.i},s.prototype.empty=function(){return this.i===0},s}(),Iv=function(s){Pv(e,s);function e(){return s!==null&&s.apply(this,arguments)||this}return e}(Rv),Dv=globalThis&&globalThis.t||function(){var s=function(e,t){return s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(i,n){i.__proto__=n}||function(i,n){for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(i[o]=n[o])},s(e,t)};return function(e,t){if(typeof t!="function"&&t!==null)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");s(e,t);function i(){this.constructor=e}e.prototype=t===null?Object.create(t):(i.prototype=t.prototype,new i)}}(),Lv=function(s){Dv(e,s);function e(){return s!==null&&s.apply(this,arguments)||this}return e}(Iv);const Fv=Lv;function xl(){throw new RangeError("Iterator access denied!")}var Ov=globalThis&&globalThis.t||function(){var s=function(e,t){return s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(i,n){i.__proto__=n}||function(i,n){for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(i[o]=n[o])},s(e,t)};return function(e,t){if(typeof t!="function"&&t!==null)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");s(e,t);function i(){this.constructor=e}e.prototype=t===null?Object.create(t):(i.prototype=t.prototype,new i)}}(),Bv=function(s){Ov(e,s);function e(t,i){var n=s.call(this,i)||this;return n.o=t,n.iteratorType===0?(n.pre=function(){return this.o===0&&xl(),this.o-=1,this},n.next=function(){return this.o===this.container.size()&&xl(),this.o+=1,this}):(n.pre=function(){return this.o===this.container.size()-1&&xl(),this.o+=1,this},n.next=function(){return this.o===-1&&xl(),this.o-=1,this}),n}return Object.defineProperty(e.prototype,"pointer",{get:function(){return this.container.getElementByPos(this.o)},set:function(t){this.container.setElementByPos(this.o,t)},enumerable:!1,configurable:!0}),e.prototype.isAccessible=function(){return this.o!==this.container.size()},e}(Cv);function ef(s,e){return Math.floor((s+e-1)/e)}var Uv=Math.floor,tf=globalThis&&globalThis.t||function(){var s=function(e,t){return s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(i,n){i.__proto__=n}||function(i,n){for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(i[o]=n[o])},s(e,t)};return function(e,t){if(typeof t!="function"&&t!==null)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");s(e,t);function i(){this.constructor=e}e.prototype=t===null?Object.create(t):(i.prototype=t.prototype,new i)}}(),Nv=globalThis&&globalThis.h||function(s,e){var t={label:0,sent:function(){if(o[0]&1)throw o[1];return o[1]},trys:[],ops:[]},i,n,o,a;return a={next:l(0),throw:l(1),return:l(2)},typeof Symbol=="function"&&(a[Symbol.iterator]=function(){return this}),a;function l(h){return function(d){return c([h,d])}}function c(h){if(i)throw new TypeError("Generator is already executing.");for(;t;)try{if(i=1,n&&(o=h[0]&2?n.return:h[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,h[1])).done)return o;switch(n=0,o&&(h=[h[0]&2,o.value]),h[0]){case 0:case 1:o=h;break;case 4:return t.label++,{value:h[1],done:!1};case 5:t.label++,n=h[1],h=[0];continue;case 7:h=t.ops.pop(),t.trys.pop();continue;default:if(o=t.trys,!(o=o.length>0&&o[o.length-1])&&(h[0]===6||h[0]===2)){t=0;continue}if(h[0]===3&&(!o||h[1]>o[0]&&h[1]<o[3])){t.label=h[1];break}if(h[0]===6&&t.label<o[1]){t.label=o[1],o=h;break}if(o&&t.label<o[2]){t.label=o[2],t.ops.push(h);break}o[2]&&t.ops.pop(),t.trys.pop();continue}h=e.call(s,t)}catch(d){h=[6,d],n=0}finally{i=o=0}if(h[0]&5)throw h[1];return{value:h[0]?h[1]:void 0,done:!0}}},kv=globalThis&&globalThis.P||function(s,e){var t=typeof Symbol=="function"&&s[Symbol.iterator];if(!t)return s;var i=t.call(s),n,o=[],a;try{for(;(e===void 0||e-- >0)&&!(n=i.next()).done;)o.push(n.value)}catch(l){a={error:l}}finally{try{n&&!n.done&&(t=i.return)&&t.call(i)}finally{if(a)throw a.error}}return o},zv=globalThis&&globalThis.A||function(s,e,t){if(t||arguments.length===2)for(var i=0,n=e.length,o;i<n;i++)(o||!(i in e))&&(o||(o=Array.prototype.slice.call(e,0,i)),o[i]=e[i]);return s.concat(o||Array.prototype.slice.call(e))},Vr=function(s){tf(e,s);function e(t,i,n){var o=s.call(this,t,n)||this;return o.container=i,o}return e.prototype.copy=function(){return new e(this.o,this.container,this.iteratorType)},e}(Bv),Vv=function(s){tf(e,s);function e(t,i){t===void 0&&(t=[]),i===void 0&&(i=4096);var n=s.call(this)||this;n.C=0,n.q=0,n.D=0,n.R=0,n.N=0,n.G=[];var o=function(){if(typeof t.length=="number")return t.length;if(typeof t.size=="number")return t.size;if(typeof t.size=="function")return t.size();throw new TypeError("Cannot get the length or size of the container")}();n.F=i,n.N=ef(o,n.F)||1;for(var a=0;a<n.N;++a)n.G.push(new Array(n.F));var l=ef(o,n.F);n.C=n.D=(n.N>>1)-(l>>1),n.q=n.R=n.F-o%n.F>>1;var c=n;return t.forEach(function(h){c.pushBack(h)}),n}return e.prototype.J=function(t){for(var i=[],n=t||this.N>>1||1,o=0;o<n;++o)i[o]=new Array(this.F);for(var o=this.C;o<this.N;++o)i[i.length]=this.G[o];for(var o=0;o<this.D;++o)i[i.length]=this.G[o];i[i.length]=zv([],kv(this.G[this.D]),!1),this.C=n,this.D=i.length-1;for(var o=0;o<n;++o)i[i.length]=new Array(this.F);this.G=i,this.N=i.length},e.prototype.K=function(t){var i,n,o=this.q+t;return i=this.C+Uv(o/this.F),i>=this.N&&(i-=this.N),n=(o+1)%this.F-1,n<0&&(n=this.F-1),{curNodeBucketIndex:i,curNodePointerIndex:n}},e.prototype.clear=function(){this.G=[new Array(this.F)],this.N=1,this.C=this.D=this.i=0,this.q=this.R=this.F>>1},e.prototype.begin=function(){return new Vr(0,this)},e.prototype.end=function(){return new Vr(this.i,this)},e.prototype.rBegin=function(){return new Vr(this.i-1,this,1)},e.prototype.rEnd=function(){return new Vr(-1,this,1)},e.prototype.front=function(){if(this.i!==0)return this.G[this.C][this.q]},e.prototype.back=function(){if(this.i!==0)return this.G[this.D][this.R]},e.prototype.pushBack=function(t){return this.i&&(this.R<this.F-1?this.R+=1:this.D<this.N-1?(this.D+=1,this.R=0):(this.D=0,this.R=0),this.D===this.C&&this.R===this.q&&this.J()),this.i+=1,this.G[this.D][this.R]=t,this.i},e.prototype.popBack=function(){if(this.i!==0){var t=this.G[this.D][this.R];return this.i!==1&&(this.R>0?this.R-=1:this.D>0?(this.D-=1,this.R=this.F-1):(this.D=this.N-1,this.R=this.F-1)),this.i-=1,t}},e.prototype.pushFront=function(t){return this.i&&(this.q>0?this.q-=1:this.C>0?(this.C-=1,this.q=this.F-1):(this.C=this.N-1,this.q=this.F-1),this.C===this.D&&this.q===this.R&&this.J()),this.i+=1,this.G[this.C][this.q]=t,this.i},e.prototype.popFront=function(){if(this.i!==0){var t=this.G[this.C][this.q];return this.i!==1&&(this.q<this.F-1?this.q+=1:this.C<this.N-1?(this.C+=1,this.q=0):(this.C=0,this.q=0)),this.i-=1,t}},e.prototype.getElementByPos=function(t){if(t<0||t>this.i-1)throw new RangeError;var i=this.K(t),n=i.curNodeBucketIndex,o=i.curNodePointerIndex;return this.G[n][o]},e.prototype.setElementByPos=function(t,i){if(t<0||t>this.i-1)throw new RangeError;var n=this.K(t),o=n.curNodeBucketIndex,a=n.curNodePointerIndex;this.G[o][a]=i},e.prototype.insert=function(t,i,n){n===void 0&&(n=1);var o=this.i;if(t<0||t>o)throw new RangeError;if(t===0)for(;n--;)this.pushFront(i);else if(t===this.i)for(;n--;)this.pushBack(i);else{for(var a=[],l=t;l<this.i;++l)a.push(this.getElementByPos(l));this.cut(t-1);for(var l=0;l<n;++l)this.pushBack(i);for(var l=0;l<a.length;++l)this.pushBack(a[l])}return this.i},e.prototype.cut=function(t){if(t<0)return this.clear(),0;var i=this.K(t),n=i.curNodeBucketIndex,o=i.curNodePointerIndex;return this.D=n,this.R=o,this.i=t+1,this.i},e.prototype.eraseElementByPos=function(t){if(t<0||t>this.i-1)throw new RangeError;if(t===0)this.popFront();else if(t===this.i-1)this.popBack();else{for(var i=this.i-1,n=this.K(t),o=n.curNodeBucketIndex,a=n.curNodePointerIndex,l=t;l<i;++l){var c=this.K(t+1),h=c.curNodeBucketIndex,d=c.curNodePointerIndex;this.G[o][a]=this.G[h][d],o=h,a=d}this.popBack()}return this.i},e.prototype.eraseElementByValue=function(t){var i=this.i;if(i===0)return 0;for(var n=0,o=0;n<i;){var a=this.getElementByPos(n);a!==t&&(this.setElementByPos(o,a),o+=1),n+=1}return this.cut(o-1),this.i},e.prototype.eraseElementByIterator=function(t){var i=t.o;return this.eraseElementByPos(i),t=t.next(),t},e.prototype.find=function(t){for(var i=0;i<this.i;++i)if(this.getElementByPos(i)===t)return new Vr(i,this);return this.end()},e.prototype.reverse=function(){this.G.reverse().forEach(function(l){l.reverse()});var t=this,i=t.C,n=t.D,o=t.q,a=t.R;return this.C=this.N-n-1,this.D=this.N-i-1,this.q=this.F-a-1,this.R=this.F-o-1,this},e.prototype.unique=function(){if(this.i<=1)return this.i;for(var t=1,i=this.getElementByPos(0),n=1;n<this.i;++n){var o=this.getElementByPos(n);o!==i&&(i=o,this.setElementByPos(t++,o))}return this.cut(t-1),this.i},e.prototype.sort=function(t){for(var i=[],n=0;n<this.i;++n)i.push(this.getElementByPos(n));i.sort(t);for(var n=0;n<this.i;++n)this.setElementByPos(n,i[n]);return this},e.prototype.shrinkToFit=function(){if(this.i!==0){var t=[];if(this.C!==this.D){if(this.C<this.D)for(var i=this.C;i<=this.D;++i)t.push(this.G[i]);else{for(var i=this.C;i<this.N;++i)t.push(this.G[i]);for(var i=0;i<=this.D;++i)t.push(this.G[i])}this.C=0,this.D=t.length-1,this.G=t}}},e.prototype.forEach=function(t){for(var i=0;i<this.i;++i)t(this.getElementByPos(i),i,this)},e.prototype[Symbol.iterator]=function(){var t;return Nv(this,function(i){switch(i.label){case 0:t=0,i.label=1;case 1:return t<this.i?[4,this.getElementByPos(t)]:[3,4];case 2:i.sent(),i.label=3;case 3:return++t,[3,1];case 4:return[2]}})},e}(Fv);const nf=Vv;class sf{constructor(e){r(this,"context");r(this,"ext",null);r(this,"activeQuery",null);r(this,"isRunning",!1);r(this,"eventsPendingTimestamps",[]);r(this,"resolvedEvents",[]);r(this,"namedContextStack",[]);this.context=e,this.ext=e.getExtension("EXT_disjoint_timer_query_webgl2")}isProfilerRunning(){return this.isRunning}start(){if(this.ext==null)throw new Error("EXT_disjoint_timer_query WebGL extension is not available. Cannot start profiler.");if(this.isRunning)throw new Error("Profiler is already running");const e=this.context.getExtension("WEBGL_debug_renderer_info");if(e!=null){const t=this.context.getParameter(e.UNMASKED_RENDERER_WEBGL);if(t.indexOf("NVIDIA GeForce GT 750M")!==-1)throw new Error(`${t} cards seem to have a buggy implementation of EXT_disjoint_timer_query. Refusing to record to avoid misleading results.`)}this.isRunning=!0,this.eventsPendingTimestamps=[],this.resolvedEvents=[],this.activeQuery=this.context.createQuery(),this.context.beginQuery(this.ext.TIME_ELAPSED_EXT,this.activeQuery),this.pushContext("profile")}stop(){if(this.ext!=null){if(!this.isRunning)throw new Error("Profiler is already stopped");this.isRunning=!1,this.popContext("profile"),this.activeQuery=null,this.context.endQuery(this.ext.TIME_ELAPSED_EXT)}}pushContext(e){this.markAction({type:0,name:e}),this.namedContextStack.push(e)}popContext(e){if(this.namedContextStack.length===0)throw new Error("Tried to pop a context when the context stack is empty!");const t=this.namedContextStack.pop();if(t!==e)throw new Error(`Expected popContext to be called with ${t}, but it was called with ${e}`);this.markAction({type:1,name:e})}withContext(e,t){this.pushContext(e),t(),this.popContext(e)}isReady(){return this.eventsPendingTimestamps.length>0&&this.resolveEventsIfPossible(),this.eventsPendingTimestamps.length===0}getResolvedEvents(){return this.resolvedEvents}exportSpeedscopeProfile(){return Dt(this,null,function*(){for(;this.eventsPendingTimestamps.length>0;)this.resolveEventsIfPossible(),yield new Promise(e=>requestAnimationFrame(e));return this.toSpeedscopeProfile()})}downloadWhenReady(){return Dt(this,null,function*(){const e=yield this.exportSpeedscopeProfile(),t=document.createElement("a");t.href=URL.createObjectURL(new Blob([e],{type:"application/json"})),t.download=`gpuprofile-${+new Date}.speedscope.json`,document.body.appendChild(t),t.click(),document.body.removeChild(t)})}stopAndDownload(){return Dt(this,null,function*(){this.stop(),yield this.downloadWhenReady()})}markAction(e){if(this.ext==null)return;if(this.activeQuery==null)throw new Error("Cannot mark actions while no profile is active");const t=this.context,i=this.activeQuery;this.activeQuery=t.createQuery(),t.endQuery(this.ext.TIME_ELAPSED_EXT),t.beginQuery(this.ext.TIME_ELAPSED_EXT,this.activeQuery),this.eventsPendingTimestamps.push({action:e,query:i})}resolveEventsIfPossible(){if(this.ext==null)return;let e=0;const t=this.context;for(;e<this.eventsPendingTimestamps.length;){let o=this.eventsPendingTimestamps[e],a=o.query;if(!t.getQueryParameter(a,t.QUERY_RESULT_AVAILABLE))break;if(t.getParameter(this.ext.GPU_DISJOINT_EXT))throw new Error("GPU_DISJOINT_EXT");const l=this.context.getQueryParameter(a,t.QUERY_RESULT);t.deleteQuery(a);var i=this.resolvedEvents.length===0?0:this.resolvedEvents[this.resolvedEvents.length-1].timestamp,n=i+l;this.resolvedEvents.push({action:o.action,timestamp:n}),e++}e>0&&(this.eventsPendingTimestamps=this.eventsPendingTimestamps.slice(e))}toSpeedscopeProfile(){const e=[],t=[];if(this.resolvedEvents.length===0)throw new Error("Profile is empty");const i={type:"evented",name:"GPU Profile",unit:"nanoseconds",startValue:0,endValue:this.resolvedEvents[this.resolvedEvents.length-1].timestamp,events:t},n={$schema:"https://www.Speedscopeapp/file-format-schema.json",shared:{frames:e},profiles:[i]},o={};function a(l){return l in o||(o[l]=e.length,e.push({name:l})),o[l]}for(let l of this.resolvedEvents)t.push({type:l.action.type==0?"O":"C",frame:a(l.action.name),at:l.timestamp});return JSON.stringify(n)}}var _h=(s=>(s[s.OPEN_FRAME=0]="OPEN_FRAME",s[s.CLOSE_FRAME=1]="CLOSE_FRAME",s))(_h||{});const cs=.01;class Gv{constructor(){r(this,"_canvas",new cg);r(this,"_tableFlags",ImGui.TableFlags.Borders|ImGui.TableFlags.RowBg|ImGui.TableFlags.Resizable|ImGui.TableFlags.Sortable|ImGui.TableFlags.ScrollY);r(this,"currentFrameIndex",0);r(this,"displaySectionsData",!0);this._canvas.allowScaleInY=!1,this._canvas.maxScale=100}drawUi(e){ImGui.SetNextWindowPos(new ImGui.ImVec2(350,20),ImGui.Cond.FirstUseEver),ImGui.SetNextWindowSize(new ImGui.ImVec2(1200,1e3),ImGui.Cond.FirstUseEver),ImGui.Begin("Profiler"),ImGui.Button(e.profilerActive?"Pause profiler":"Start profiler")&&(e.profilerActive=!e.profilerActive),ImGui.SameLine(),ImGui.Button(this.displaySectionsData?"Display frame graphs":"Display sections data")&&(this.displaySectionsData=!this.displaySectionsData),this.displaySectionsData?this._drawProfilerSectionsData(e):this._drawFrameGraphs(e),ImGui.End()}_drawFrameGraphs(e){const t=Array.from(e.namedFrames.keys());e.profileHistory.forEach((n,o)=>t.push(`Frame ${o+1}`)),ImGui.Combo("Current frame",(n=this.currentFrameIndex)=>this.currentFrameIndex=n,t,t.length);let i;if(this.currentFrameIndex<e.namedFrames.size?i=e.namedFrames.get(t[this.currentFrameIndex]):i=e.profileHistory.getElementByPos(this.currentFrameIndex-e.namedFrames.size),i){ImGui.BeginTable("Profiler",2,this._tableFlags),ImGui.TableSetupColumn("Sections",ImGui.TableColumnFlags.None,.5),ImGui.TableSetupColumn("Call graph",ImGui.TableColumnFlags.WidthStretch,.5),ImGui.TableNextRow(),ImGui.TableNextColumn(),this._drawProfilerSectionsGraphs(i.frameId,e),ImGui.TableNextColumn();const n=this._canvas.renderCanvas(),o=ImGui.GetWindowDrawList();o.AddText(n,ImGui.COL32_WHITE,"GPU call graph:"),n.y+=20,this.drawCallGraph(e,i.gpuSections,n,this._canvas.scale),o.AddText(n,ImGui.COL32_WHITE,"CPU call graph:"),n.y+=20,this.drawCallGraph(e,i.cpuSections,n,this._canvas.scale),ImGui.EndTable()}}_drawProfilerSectionsData(e){ImGui.BeginTable("Profiler sections",7,this._tableFlags),ImGui.TableSetupColumn("Name",ImGui.TableColumnFlags.WidthStretch,.4);const t=ImGui.TableColumnFlags.DefaultSort|ImGui.TableColumnFlags.PreferSortDescending|ImGui.TableColumnFlags.WidthStretch;ImGui.TableSetupColumn("CPU total",t,.2),ImGui.TableSetupColumn("CPU counter",ImGui.TableColumnFlags.WidthStretch,.2),ImGui.TableSetupColumn("CPU average",ImGui.TableColumnFlags.WidthStretch,.2),ImGui.TableSetupColumn("GPU total",t,.2),ImGui.TableSetupColumn("GPU counter",ImGui.TableColumnFlags.WidthStretch,.2),ImGui.TableSetupColumn("GPU average",ImGui.TableColumnFlags.WidthStretch,.2),ImGui.TableHeadersRow();let i=1,n=!0;const o=ImGui.TableGetSortSpecs();o&&(i=o.Specs[0].ColumnIndex,n=o.Specs[0].SortDirection===ImGui.SortDirection.Descending);const a=Array.from(e.sectionsInfo.values()).sort((l,c)=>{switch(i){case 0:return c.name.localeCompare(l.name);case 1:{const h=c.cpuData.total-l.cpuData.total;if(Math.abs(h)>cs)return n?-h:h;break}case 2:{const h=c.cpuData.measureCounter-l.cpuData.measureCounter;if(Math.abs(h)>cs)return n?-h:h;break}case 3:{const h=c.cpuData.average-l.cpuData.average;if(Math.abs(h)>cs)return n?-h:h;break}case 4:{const h=c.gpuData.total-l.gpuData.total;if(Math.abs(h)>cs)return n?-h:h;break}case 5:{const h=c.gpuData.measureCounter-l.gpuData.measureCounter;if(Math.abs(h)>cs)return n?-h:h;break}case 6:{const h=c.gpuData.average-l.gpuData.average;if(Math.abs(h)>cs)return n?-h:h;break}}return c.index-l.index});for(const l of a)ImGui.TableNextRow(),ImGui.TableNextColumn(),ImGui.TextUnformatted(l.name),ImGui.TableNextColumn(),ImGui.TextUnformatted(`${l.cpuData.total.toFixed(2)} ms`),ImGui.TableNextColumn(),ImGui.TextUnformatted(`${l.cpuData.measureCounter}`),ImGui.TableNextColumn(),ImGui.TextUnformatted(`${l.cpuData.average.toFixed(2)} ms`),ImGui.TableNextColumn(),ImGui.TextUnformatted(`${l.gpuData.total.toFixed(2)} ms`),ImGui.TableNextColumn(),ImGui.TextUnformatted(`${l.gpuData.measureCounter.toFixed(2)}`),ImGui.TableNextColumn(),ImGui.TextUnformatted(`${l.gpuData.average.toFixed(2)} ms`);ImGui.EndTable()}_drawProfilerSectionsGraphs(e,t){ImGui.BeginTable("Frame sections",3,this._tableFlags),ImGui.TableSetupColumn("Name",ImGui.TableColumnFlags.None,.2),ImGui.TableSetupColumn("GPU average",ImGui.TableColumnFlags.DefaultSort|ImGui.TableColumnFlags.PreferSortDescending|ImGui.TableColumnFlags.WidthStretch,.4),ImGui.TableSetupColumn("CPU average",ImGui.TableColumnFlags.WidthStretch,.4),ImGui.TableHeadersRow();let i=0,n=0,o=1,a=!0;const l=ImGui.TableGetSortSpecs();l&&(o=l.Specs[0].ColumnIndex,a=l.Specs[0].SortDirection===ImGui.SortDirection.Descending);const c=Array.from(t.sectionsInfo.values()).filter(h=>h.lastFrameId>=e).sort((h,d)=>{i=Math.max(i,Math.max(h.gpuData.movingAverage,d.gpuData.movingAverage));let u=d.gpuData.movingAverage-h.gpuData.movingAverage;n=Math.max(n,Math.max(h.cpuData.movingAverage,d.cpuData.movingAverage));let m=d.cpuData.movingAverage-h.cpuData.movingAverage;if(a||(u=-u,m=-m),o===0)return d.name.localeCompare(h.name);if(o===1){if(Math.abs(u)>cs)return u;if(Math.abs(m)>cs)return m}else if(o===2){if(Math.abs(m)>cs)return m;if(Math.abs(u)>cs)return u}return d.index-h.index});for(const h of c){ImGui.TableNextRow(),ImGui.TableNextColumn(),ImGui.TextUnformatted(h.name),ImGui.TableNextColumn();const d=`${h.gpuData.movingAverage.toFixed(2)}`;this.plotProfilerSectionData(h.gpuData.samples.buffer,d,ImGui.GetColumnWidth(1),i),ImGui.TableNextColumn();const u=`${h.cpuData.movingAverage.toFixed(2)}`;this.plotProfilerSectionData(h.cpuData.samples.buffer,u,ImGui.GetColumnWidth(2),n)}ImGui.EndTable()}drawCallGraph(e,t,i,n){if(t.length===0)return;const o=ImGui.GetWindowDrawList(),a=ImGui.GetContentRegionAvail(),l=16*n.y,c=new ImGui.Vec2(i.x,i.y),h=a.x*n.x,d=t[0].duration,u=t[0].timestamp,m=h/d,g=3,b=1,x=20,v=5,E=1,w=new ImGui.Vec2,C=new ImGui.Vec2;for(const I of t){const O=e.sectionsInfo.get(I.name),U=I.duration*m;w.x=c.x+(I.timestamp-u)*m,C.x=w.x+U-b,w.y=c.y+(l+g)*I.stackIndex,C.y=w.y+l;const z=O?O.color:ImGui.COL32_WHITE;o.AddRectFilled(w,C,z);const ie=I.duration.toFixed(2),J=ImGui.GetMousePos();C.x=Math.ceil(C.x);const re=J.x>=w.x&&J.x<=C.x&&J.y>=w.y&&J.y<=C.y;U>x&&(w.x+=v,w.y+=E,o.AddText(w,ImGui.COL32_BLACK,I.name+` (${ie} ms)`)),re&&(ImGui.BeginTooltip(),ImGui.PushTextWrapPos(ImGui.GetFontSize()*35),ImGui.TextUnformatted(`${I.name}: ${ie} ms`),O&&(this.displaySectionMeasureData("Section CPU data",O.cpuData),O.gpuData.measureCounter>0&&this.displaySectionMeasureData("Section GPU data",O.gpuData)),ImGui.PopTextWrapPos(),ImGui.EndTooltip())}i.y=C.y+l}displaySectionMeasureData(e,t){ImGui.Separator(),ImGui.TextUnformatted(e),ImGui.Indent(),ImGui.TextUnformatted(`Average: ${t.average.toFixed(2)} ms`),ImGui.TextUnformatted(`Min: ${t.min.toFixed(2)} ms`),ImGui.TextUnformatted(`Max: ${t.max.toFixed(2)} ms`),ImGui.TextUnformatted(`Total: ${t.total.toFixed(2)} ms`),ImGui.TextUnformatted(`Counter: ${t.measureCounter}`),ImGui.Unindent()}plotProfilerSectionData(e,t,i,n){ImGui.PlotHistogram("",e.buffer,e.buffer.length,e.getPointer(),t,void 0,n,new ImGui.Vec2(i,20))}}class Hv{constructor(e,t){r(this,"_buffer");r(this,"_pointer",0);this._buffer=new Array(e),this._buffer.fill(t)}get buffer(){return this._buffer}getPointer(){return this._pointer}get(e){return this._buffer[e!=null?e:this._pointer]}set(e,t){return this._buffer[t!=null?t:this._pointer]=e}add(e){this._buffer[this._pointer]=e,this.incrementIndexPointer()}incrementIndexPointer(){this._pointer=(this._pointer+1)%this._buffer.length}}const gh=60;class Wv{constructor(){r(this,"_buffer",new Hv(gh,0))}get buffer(){return this._buffer}clearCurrentSample(){this._buffer.set(0)}addToCurrentSample(e){this._buffer.set(this._buffer.get()+e)}incrementIndexPointer(){this._buffer.incrementIndexPointer()}}class of{constructor(){r(this,"samples",new Wv);r(this,"average",0);r(this,"movingAverage",0);r(this,"min",Number.MAX_VALUE);r(this,"max",Number.MIN_VALUE);r(this,"total",0);r(this,"measureCounter",0)}onSampleMeasured(e){this.samples.addToCurrentSample(e),this.measureCounter++,this.total+=e,this.min=Math.min(this.min,e),this.max=Math.max(this.max,e),this.average=this.total/this.measureCounter,this.movingAverage=(this.movingAverage*(gh-1)+e)/gh}}class jv{constructor(e,t,i){r(this,"gpuSections",new Array);r(this,"webGLProfiler");r(this,"cpuSections",new Array);r(this,"cpuStackIndices",new Array);r(this,"frameId");r(this,"profilerFrameArgs");r(this,"_gpuEventsResolved",!1);this.webGLProfiler=t,this.frameId=e,this.profilerFrameArgs=i}start(){var e,t,i;(e=this.webGLProfiler)!=null&&e.isReady()&&this.webGLProfiler.start(),this.beginSection(`ProfilerFrame ${(i=(t=this.profilerFrameArgs)==null?void 0:t.name)!=null?i:this.frameId.toString()}`)}beginSection(e){var i;const t=this.cpuSections.length;this.cpuStackIndices.push(t),this.cpuSections.push({name:e,timestamp:performance.now(),duration:0,stackIndex:this.cpuStackIndices.length-1}),(i=this.webGLProfiler)!=null&&i.isProfilerRunning()&&this.webGLProfiler.pushContext(e)}endSection(e,t){var a;this.cpuStackIndices.length>0;const i=this.cpuStackIndices.pop(),n=this.cpuSections[i];n.duration=performance.now()-n.timestamp;const o=t.get(e);o&&(o.cpuData.onSampleMeasured(n.duration),o.lastFrameId=Math.max(this.frameId,o.lastFrameId)),(a=this.webGLProfiler)!=null&&a.isProfilerRunning()&&this.webGLProfiler.popContext(e)}end(e){var t,i,n;this.endSection(`ProfilerFrame ${(i=(t=this.profilerFrameArgs)==null?void 0:t.name)!=null?i:this.frameId.toString()}`,e),(n=this.webGLProfiler)!=null&&n.isProfilerRunning()&&this.webGLProfiler.stop()}tryResolveFrame(e){var t;return this._gpuEventsResolved||!this.webGLProfiler?!0:((t=this.webGLProfiler)!=null&&t.isReady()&&(this._copyGpuResolvedEvents(e),this._gpuEventsResolved=!0),this._gpuEventsResolved)}_copyGpuResolvedEvents(e){const t=[];for(const i of this.webGLProfiler.getResolvedEvents())if(i.action.type===_h.OPEN_FRAME){const n=this.gpuSections.length;t.push(n),this.gpuSections.push({name:i.action.name,timestamp:i.timestamp*1e-6,duration:0,stackIndex:t.length-1})}else if(i.action.type===_h.CLOSE_FRAME){const n=t.pop(),o=this.gpuSections[n];o.duration=i.timestamp*1e-6-o.timestamp;const a=e.get(i.action.name);a&&(a.gpuData.onSampleMeasured(o.duration),a.lastFrameId=Math.max(this.frameId,a.lastFrameId))}for(const i of e.values())i.gpuData.samples.incrementIndexPointer(),i.gpuData.samples.clearCurrentSample()}_exportSectionsAsText(e){var n,o;if(e.length===0)return`No sections to export.
`;let t="";const i=(o=(n=this.profilerFrameArgs)==null?void 0:n.minSectionDuration)!=null?o:1;for(let a=0;a<e.length;a++){const l=e[a];if(l.duration<i)continue;const h=`${"  ".repeat(l.stackIndex)} ${l.name}: ${l.duration.toFixed(2)} ms
`;t+=h}return t}exportLogAsText(){var i,n;let e="";const t=`${this.frameId} ${(n=(i=this.profilerFrameArgs)==null?void 0:i.name)!=null?n:""}`;return console.log(`***** Profiler Frame ${t} *****`),e+=`***** Profiler Frame ${t} *****
`,e+=`CPU Sections:
`,e+=this._exportSectionsAsText(this.cpuSections),e+=`GPU Sections:
`,e+=this._exportSectionsAsText(this.gpuSections),e+=`***** End of Profiler Frame ${t} *****
`,e}_logSectionsToConsole(e){var l,c,h,d;if(e.length===0){console.log("No sections to log.");return}let t=0;const i=(c=(l=this.profilerFrameArgs)==null?void 0:l.minSectionDuration)!=null?c:1,n=(d=(h=this.profilerFrameArgs)==null?void 0:h.firstCollapsedStackIndex)!=null?d:1;for(let u=0;u<e.length-1;u++){const m=e[u];if(m.duration<i)continue;for(;t>m.stackIndex;)console.groupEnd(),t--;const g=e[u+1].stackIndex,b=m.stackIndex<g,x=`${m.name}: ${m.duration.toFixed(2)} ms`;if(b){const v=m.stackIndex<n;for(;t<g;)t++,v?console.groupCollapsed(x):console.group(x)}else console.log(x)}const o=e[e.length-1],a=`${o.name}: ${o.duration.toFixed(2)} ms`;for(console.log(a);t>0;)console.groupEnd(),t--}logToConsole(){var t,i;const e=`${this.frameId} ${(i=(t=this.profilerFrameArgs)==null?void 0:t.name)!=null?i:""}`;console.log(`***** Profiler Frame ${e} *****`),console.log("CPU Sections:"),this._logSectionsToConsole(this.cpuSections),console.log("GPU Sections:"),this._logSectionsToConsole(this.gpuSections),console.log(`***** End of Profiler Frame ${e} *****`),M.PROFILER_EXPANDED_LOG&&console.log(this.exportLogAsText())}}const Ni=class Ni{constructor(){r(this,"sectionsInfo",new Map);r(this,"profilerActive",!0);r(this,"profilerUi");r(this,"_colors",[Jn.blueviolet,Jn.darkorange,Jn.darkgreen,Jn.darkred,Jn.darkslateblue,Jn.darkslategray,Jn.darkturquoise,Jn.darkviolet,Jn.deepskyblue]);r(this,"_defaultAlpha",200);r(this,"currentSectionColorIndex",0);r(this,"glRenderContext");r(this,"profiledFrame");r(this,"pendingFrames",new nf);r(this,"profileHistory",new nf);r(this,"namedFrames",new Map);r(this,"maxHistorySize",60);r(this,"currentFrameId",0);ss.registerIfEnabled(this,M.PROFILER),this.profilerUi=new Gv}static instance(){return M.PROFILER,Ni._instance||(Ni._instance=new Ni,console.log("Profiling enabled.")),Ni._instance}static createNewProfileFrame(e){var i;if(!M.PROFILER)return;const t=Ni.instance().profiledFrame;t&&Ni.instance().onProfilingEnd((i=t.profilerFrameArgs)==null?void 0:i.name),Ni.instance().onProfilingBegin(e)}static beginProfiling(e){M.PROFILER&&Ni.instance().onProfilingBegin(e)}static endProfiling(e){M.PROFILER&&Ni.instance().onProfilingEnd(e)}static beginSection(e,t=!1,i=!1,n){M.PROFILER&&Ni.instance().onSectionBegin(e,t,i,n)}static endSection(e,t=!1,i=!1){M.PROFILER&&Ni.instance().onSectionEnd(e,t,i)}static setWebGLContext(e){M.PROFILER&&(Ni.instance().glRenderContext=e,!Qe.ios&&Ni.instance().profiledFrame&&(Ni.instance().profiledFrame.webGLProfiler=new sf(e)))}logSectionsDataToConsole(){console.log("Profiler sections data:");for(const[e,t]of this.sectionsInfo.entries()){const i=t.cpuData,n=t.gpuData;console.log(`${e}:`),i.measureCounter>0&&console.log(`CPU - Total: ${i.total.toFixed(2)}, Counter: ${i.measureCounter}, `,`Moving Avg: ${i.movingAverage.toFixed(2)} ms, `,`Total Avg: ${i.average.toFixed(2)} ms, Min: ${i.min.toFixed(2)} ms, `,`Max: ${i.max.toFixed(2)} ms`),n.measureCounter>0&&console.log(`GPU - Total: ${n.total.toFixed(2)}, Counter: ${n.measureCounter}, `,`Moving Avg: ${i.movingAverage.toFixed(2)} ms, `,`Total Avg: ${n.average.toFixed(2)} ms, Min: ${n.min.toFixed(2)} ms, `,`Max: ${n.max.toFixed(2)} ms`)}}onProfilingBegin(e){var t,i,n;if(this.profilerActive){this.profiledFrame&&(console.warn("Profiler frame is still active, ending it before starting a new one."),this.onProfilingEnd((t=this.profiledFrame.profilerFrameArgs)==null?void 0:t.name));for(const o of this.sectionsInfo.values())o.cpuData.samples.clearCurrentSample();for(;this.pendingFrames.back()&&this.pendingFrames.back().tryResolveFrame(this.sectionsInfo);){const o=this.pendingFrames.popBack();(i=o.profilerFrameArgs)!=null&&i.name?this.namedFrames.set(o.profilerFrameArgs.name,o):this.profileHistory.pushFront(o),((n=o.profilerFrameArgs)!=null&&n.log||o.frameId===M.PROFILER_ID_TO_LOG)&&(o.logToConsole(),M.PROFILER_EXPANDED_LOG&&this.logSectionsDataToConsole())}for(;this.profileHistory.length>this.maxHistorySize;)this.profileHistory.popBack();this.profiledFrame=new jv(this.currentFrameId++,this.glRenderContext&&!Qe.ios?new sf(this.glRenderContext):void 0,e),this.profiledFrame.start()}}onProfilingEnd(e){var t;if(this.profilerActive){this.profiledFrame,this.profiledFrame.end(this.sectionsInfo),(t=this.profiledFrame.profilerFrameArgs)==null||t.name,this.pendingFrames.pushFront(this.profiledFrame);for(const i of this.sectionsInfo.values())i.cpuData.samples.incrementIndexPointer();this.profiledFrame=void 0}}onSectionBegin(e,t=!1,i=!1,n){if(this.profilerActive){if(t&&console.log(`Begin section: ${e}`),i&&this.checkGlError(),!this.sectionsInfo.has(e)){let o;if(n===void 0){const a=this.currentSectionColorIndex++%this._colors.length;o=this._defaultAlpha<<24|this._colors[a]}else o=n;this.sectionsInfo.set(e,{color:o,gpuData:new of,cpuData:new of,index:this.sectionsInfo.size,name:e,lastFrameId:this.currentFrameId})}this.profiledFrame.beginSection(e)}}onSectionEnd(e,t=!1,i=!1){this.profilerActive&&(this.profiledFrame.endSection(e,this.sectionsInfo),t&&console.log(`End section: ${e}`),i&&this.checkGlError())}checkGlError(){const e=this.glRenderContext.getError();e!==this.glRenderContext.NO_ERROR&&console.error(`GL error! ${e}`)}onDebugUi(){this.profilerUi.drawUi(this)}};r(Ni,"_instance");let ri=Ni;function rf(s,e,t){this.scene=s,this.camera=e,this.overrideMaterial=t,this.enabled=!0,this.clear=!0,this.needsSwap=!0}rf.prototype={render:function(s,e,t,i){var n=this.scene.overrideMaterial;this.overrideMaterial&&(this.scene.overrideMaterial=this.overrideMaterial),s.render(this.scene,this.camera,e,this.clear),this.scene.overrideMaterial=n}};const Xv={uniforms:{tDiffuse:{type:"t",value:null},texelSize:{type:"v2",value:new Ce(1/1024,1/512)}},vertexShaderName:"fxaa_vertex.glsl",fragmentShaderName:"fxaa_fragment.glsl"};class qv{constructor(){this.shaderPass=new as(Xv),this.shaderPass.clear=!1,this.shaderPass.renderToScreen=!1,this.shaderPass.material.depthTest=!1,this.shaderPass.material.depthWrite=!1,this.shaderPass.uniforms.texelSize.value.set(1/window.innerWidth,1/window.innerHeight)}get renderToScreen(){return this.shaderPass.renderToScreen}set renderToScreen(e){this.shaderPass.renderToScreen=e}onResize(e,t){this.shaderPass.uniforms.texelSize.value.set(1/e,1/t)}update(){}}const Yv={uniforms:{tDepth:{type:"t",value:null},tDiffuse:{type:"t",value:null},texelSize:{type:"v2",value:new Ce(1/1024,1/512)},delta:{type:"f",value:1},velocityFactor:{type:"f",value:.5},invViewProjMatrix:{type:"m4",value:new at},prevViewProjMatrix:{type:"m4",value:new at}},vertexShaderName:"motion_blur_vertex.glsl",fragmentShaderName:"motion_blur_fragment.glsl"};class af{constructor(e){r(this,"_camera");r(this,"_shaderPass",new as(Yv));r(this,"_previousMatrixWorldInverse",new at);r(this,"_previousProjectionMatrix",new at);r(this,"_inverseProjectionMatrix",new at);this._camera=e,this._shaderPass.clear=!1,this._shaderPass.renderToScreen=!1,this._shaderPass.material.depthTest=!0,this._shaderPass.material.depthWrite=!0,this._shaderPass.material.accessUniform("texelSize").value.set(1/(window.innerWidth*window.devicePixelRatio),1/(window.innerHeight*window.devicePixelRatio)),this._shaderPass.material.accessUniform("velocityFactor").value=e.motionBlurIntensity}get shaderPass(){return this._shaderPass}get renderToScreen(){return this._shaderPass.renderToScreen}set renderToScreen(e){this._shaderPass.renderToScreen=e}set intensity(e){this._shaderPass.material.accessUniform("velocityFactor").value=e}onResize(e,t){this._shaderPass.material.accessUniform("texelSize").value.set(1/e,1/t)}update(e){this._shaderPass.material.accessUniform("delta").value=e,this._shaderPass.material.accessUniform("invViewProjMatrix").value.getInverse(this._camera.matrixWorldInverse).multiply(this._inverseProjectionMatrix.getInverse(this._camera.projectionMatrix)),this._shaderPass.material.accessUniform("prevViewProjMatrix").value.copyFrom(this._previousProjectionMatrix.multiply(this._previousMatrixWorldInverse)),this._camera.updateMatrixWorld(),this._previousMatrixWorldInverse.copyFrom(this._camera.matrixWorldInverse),this._previousProjectionMatrix.copyFrom(this._camera.projectionMatrix)}}const lf={minFilter:Z.LINEAR,magFilter:Z.LINEAR,depthBuffer:!0,useDepthTexture:!0,stencilBuffer:!1,generateMipmaps:!1};class Qv extends ei{constructor(e,t,i){super(),this.renderer=e,this.camera=i,this.scene=t,this.renderModel=new rf(t,i),this.renderTarget1=null,this.renderTarget2=null,this.passes=[],this.postProcessChain=[],i.addEventListener(gi.eventType.MOTION_BLUR_UPDATED,()=>this.updateMotionBlur())}get isEnabled(){return this.postProcessChain.length>0}init(){this.configureTarget(1024,1024,lf),this.passes.push(this.renderModel)}onResize(e,t){this.renderer&&(this.configureTarget(e,t,lf),this.ssaa&&this.ssaa.setTargets(this.renderTarget1,this.renderTarget2)),this.postProcessChain.forEach(i=>{i.onResize(e,t)})}removePostProcess(e){this.passes=this.passes.filter(t=>t!==e.shaderPass),this.postProcessChain=this.postProcessChain.filter(t=>t!==e)}disposeTarget(){this.renderTarget1&&(this.renderTarget1.dispose(),this.renderTarget1=null),this.renderTarget2&&(this.renderTarget2.dispose(),this.renderTarget2=null)}configureTarget(e,t,i){this.disposeTarget(),this.renderTarget1=this.renderer.createRenderTarget(e,t,i),this.renderTarget2=this.renderer.createRenderTarget(e,t,i)}setup(){this.isEnabled&&(this.renderer.autoClear=!1,this.postProcessChain.forEach((e,t,i)=>{e.renderToScreen=t===i.length-1}))}render(e){let t=this.renderTarget1,i=this.renderTarget2;this.passes.filter(n=>n.enabled).forEach(n=>{n.render(this.renderer,t,i,e),n.needsSwap&&n!==this.passes.at(-1)&&([t,i]=[i,t])})}update(e){ri.beginSection("Postprocess.update"),this.postProcessChain.forEach(t=>{t.update(e)}),this.render(e),ri.endSection("Postprocess.update")}updateMotionBlur(){const e=this.postProcessChain.find(n=>n instanceof af),t=e&&!this.camera.motionBlurEnabled,i=!e&&this.camera.motionBlurEnabled;t&&(this.removePostProcess(e),this.setup()),i&&(this.addMotionBlur(),this.setup()),e&&(e.intensity=this.camera.motionBlurIntensity)}addFXAA(){const e=new qv;this.passes.push(e.shaderPass),this.postProcessChain.push(e)}addMotionBlur(){const e=new af(this.camera);this.passes.push(e.shaderPass),this.postProcessChain.push(e)}addSSAA(e){this.ssaa=new fh(this.renderer,e)}resetSSAA(){this.ssaa&&this.ssaa.reset()}updateSSAA(){return this.ssaa?(this.ssaa.renderSample(),this.ssaa.renderedSamplesCount()>=4&&this.ssaa.renderAccumulatedSamplesToScreen(),!this.ssaa.allSamplesRendered()):!1}}class Kv extends sr{constructor(t,i,n){super(t,i,n);r(this,"activeCubeFace",0);this.isCube=!0,this.webglFramebuffer=[],this.webglRenderbuffer=[]}}function $v(s){return s.split(`
`).map((t,i)=>i+1+": "+t).join(`
`)}function cf(s,e,t,i){const n=s.createShader(e);s.shaderSource(n,t),s.compileShader(n);const o=s.getShaderParameter(n,s.COMPILE_STATUS)===!1;if(o&&console.error(`Shader '${i}' failed to compile.`),o||M.LOG_INFO){const a=s.getShaderInfoLog(n);a!==""&&console.warn(`Shader '${i}' info log: `,a,$v(t))}return n}const hf=["viewMatrix","modelViewMatrix","projectionMatrix","normalMatrix","modelMatrix","cameraPosition"];let Zv=0;function Jv(s,e){const t={};for(let i=0,n=hf.length;i<n;i++){const o=hf[i];t[o]=df(s,e,o)}return t}function df(s,e,t){const i=s.getUniformLocation(e,t);return i||s.getUniformLocation(e,`u${kp(t)}`)}function e1(s,e,t){const i={i:[],f:[],v2:[],v3:[],c:[],v4:[],m4:[],t:[]};for(const n in t)if(Object.prototype.hasOwnProperty.call(t,n)){const o=df(s,e,n);if(o===null)continue;const l=t[n].type;Object.prototype.hasOwnProperty.call(i,l);let c=null;l==="i"||l==="f"||l==="t"?c=null:l==="v2"?c=[null,null]:l==="v3"||l==="c"?c=[null,null,null]:l==="v4"?c=[null,null,null,null]:l==="m4"?c=null:console.assert(!1),i[l].push({id:n,value:c,location:o})}return i}function t1(s,e,t){const i={};for(let n=0,o=t.length;n<o;n++){const a=t[n];i[a]=s.getAttribLocation(e,a)}return i}class i1{constructor(){r(this,"id");r(this,"usedTimes");r(this,"program",null);r(this,"transformUniformCache");r(this,"materialUniformCache");r(this,"attributes",{});r(this,"attributesKeys",[]);this.id=Zv++,this.usedTimes=1}recompileProgram(e,t){performance.now(),this.program&&e.deleteProgram(this.program);const i=t.index0AttributeName,n=e.createProgram(),o=cf(e,e.VERTEX_SHADER,t.generateVertexShader(),t.vertexShaderName),a=cf(e,e.FRAGMENT_SHADER,t.generateFragmentShader(),t.fragmentShaderName);e.attachShader(n,o),e.attachShader(n,a),i!==void 0&&e.bindAttribLocation(n,0,i),e.linkProgram(n);let l=e.getProgramInfoLog(n);if(l!==null&&(l=l.trim()),e.getProgramParameter(n,e.LINK_STATUS)===!1){const c=e.getProgramParameter(n,e.VALIDATE_STATUS);console.error(`Shader link error: ${e.getError()} validation status: ${c}material: ${t.name}`)}l&&l!=="\0"&&console.warn("program info log: "+l),e.deleteShader(o),e.deleteShader(a),this.transformUniformCache=Jv(e,n),this.materialUniformCache=e1(e,n,t.uniforms),this.attributes=t1(e,n,t.attributes),this.attributesKeys=Object.keys(this.attributes),this.program=n}}class n1{constructor(e){r(this,"_programIdToProgram",new Map);r(this,"_gl");this._gl=e}recompileProgram(e){const t=e.generateProgramId(),i=this._programIdToProgram.get(t);i?i.recompileProgram(this._gl,e):console.error("Couldn't find program to recompile!")}assignProgramToMaterial(e){const t=e.generateProgramId();let i=this._programIdToProgram.get(t);i?i.usedTimes++:(i=new i1,i.recompileProgram(this._gl,e),this._programIdToProgram.set(t,i)),e.program&&this.resetProgramAssignment(e),e.program=i}resetProgramAssignment(e){const t=e.program;if(e.program=null,t.usedTimes-=1,t.usedTimes===0){for(const i of this._programIdToProgram.keys())if(this._programIdToProgram.get(i)===t){this._programIdToProgram.delete(i);break}this._gl.deleteProgram(t.program)}}}function s1(s){const n=new Array(16).fill(0),o=new Array(16).fill(null),a=n.map(()=>0);let l=null,c=null,h=null,d=null,u=null,m=null,g=null,b=null,x=null,v=null,E=null,w=null,C=null,I=null;const O={x:null,y:null,width:null,height:null};this.resetAttributeStates=function(){for(let U=0,z=n.length;U<z;U++)n[U]=0},this.disableAttributeStates=function(){for(let U=0,z=n.length;U<z;U++)s.disableVertexAttribArray(U),n[U]=0},this.enableAttributeArray=function(U){n[U]!==2&&(s.enableVertexAttribArray(U),n[U]=2)},this.disableAttributeArray=function(U,z){n[U]!==1&&(s.disableVertexAttribArray(U),n[U]=1),o[U]!==z&&(z.length===2?s.vertexAttrib2fv(U,z):z.length===3?s.vertexAttrib3fv(U,z):z.length===4&&s.vertexAttrib4fv(U,z),o[U]=z)},this.resetAttributeDivisors=function(){for(let U=0,z=a.length;U<z;U++)a[U]&&(s.vertexAttribDivisor(U,0),a[U]=0)},this.setAttributeDivisor=function(U,z){s.vertexAttribDivisor(U,z),a[U]=z},this.setBlending=function(U){const z=U.blending;if(z!==l&&(z===yi.DISABLED?s.disable(s.BLEND):z===yi.ADDITIVE?(s.enable(s.BLEND),s.blendEquation(s.FUNC_ADD),s.blendFunc(s.SRC_ALPHA,s.ONE)):z===yi.SUBTRACTIVE?(s.enable(s.BLEND),s.blendEquation(s.FUNC_ADD),s.blendFunc(s.ZERO,s.ONE_MINUS_SRC_COLOR)):z===yi.MULTIPLY?(s.enable(s.BLEND),s.blendEquation(s.FUNC_ADD),s.blendFunc(s.ZERO,s.SRC_COLOR)):z===yi.CUSTOM?s.enable(s.BLEND):(z==yi.NORMAL,s.enable(s.BLEND),s.blendEquationSeparate(s.FUNC_ADD,s.FUNC_ADD),s.blendFuncSeparate(s.SRC_ALPHA,s.ONE_MINUS_SRC_ALPHA,s.ONE,s.ONE_MINUS_SRC_ALPHA)),l=z),z===yi.CUSTOM){const ie=U.blendEquation,J=U.blendEquationAlpha||ie,re=U.blendSrc,Oe=U.blendDst,We=U.blendSrcAlpha||re,Ve=U.blendDstAlpha||Oe;(ie!==c||J!==u)&&(s.blendEquationSeparate(ie,J),c=ie,u=J),(re!==h||Oe!==d||We!==m||Ve!==g)&&(s.blendFuncSeparate(re,Oe,We,Ve),h=re,d=Oe,m=We,g=Ve)}else c=null,h=null,d=null,u=null,m=null,g=null},this.setDepthTest=function(U){b!==U&&(U?s.enable(s.DEPTH_TEST):s.disable(s.DEPTH_TEST),b=U)},this.setDepthWrite=function(U){x!==U&&(s.depthMask(U),x=U)},this.setColorWrite=function(U){v!==U&&(s.colorMask(U,U,U,U),v=U)},this.forceDoubleSided=function(U){E=U},this.forceFlipSided=function(U){w=U},this.setDoubleSided=function(U){E!==null&&(U=E),C!==U&&(U?s.disable(s.CULL_FACE):s.enable(s.CULL_FACE),C=U)},this.setFlipSided=function(U){w!==null&&(U=w),I!==U&&(U?s.frontFace(s.CW):s.frontFace(s.CCW),I=U)},this.setViewport=function(U,z,ie,J){const re=O;(re.x!==U||re.y!==z||re.width!==ie||re.height!==J)&&(s.viewport(U,z,ie,J),re.x=U,re.y=z,re.width=ie,re.height=J)}}function o1(){this.texture=null,this.locked=!1,this.usedCount=0}function r1(s){const e=[];for(let t=0;t<s;t+=1)e[t]=new o1;return e}function a1(s){const e=s.getParameter(s.MAX_TEXTURE_IMAGE_UNITS),t=r1(e);this.setSlot=function(i,n){let o=i.webglSlot,a;if(o!==null)return a=t[o],a.usedCount+=1,a.locked=a.locked||n,!1;let l=1/0;for(let c=0;c<e;c+=1)a=t[c],!a.locked&&a.usedCount<l&&(l=a.usedCount,o=c);return o===null&&(console.warn("Not enough texture units"),o=0),a=t[o],a.texture&&(a.texture.webglSlot=null),a.texture=i,a.usedCount=1,a.locked=n,i.webglSlot=o,!0},this.unlockAllSlots=function(){for(let i=0;i<e;i+=1)t[i].locked=!1},this.freeSlot=function(i){if(i.webglSlot!==null){const n=t[i.webglSlot];i.webglSlot=null,n.texture=null,n.locked=!1,n.usedCount=0}}}function l1(s){const e=s.getParameter(s.MAX_TEXTURE_IMAGE_UNITS);let t=0;this.setSlot=function(i,n){return t===e&&(console.warn("Not enough texture units"),t=0),i.webglSlot=t,n&&(t+=1),!0},this.unlockAllSlots=function(){t=0},this.freeSlot=function(i){i.webglSlot=null}}function yl(s,e,t,i,n){if(Cr(i)){s.compressedTexImage2D(e,t,i,n.width,n.height,0,n.data);return}const o=Qa(i),a=Ka(i);n instanceof fo?s.texImage2D(e,t,i,n.width,n.height,0,o,a,n.data):s.texImage2D(e,t,i,o,a,n)}function Gr(s,e,t,i,n,o,a){const l=Qa(i),c=Ka(i);Cr(i),s.texImage2D(e,t,i,n,o,0,l,c,a)}function c1(s){const e={COMPRESSED_RGB_S3TC_DXT1_EXT:"WEBGL_compressed_texture_s3tc",COMPRESSED_RGBA_S3TC_DXT1_EXT:"WEBGL_compressed_texture_s3tc",COMPRESSED_RGBA_S3TC_DXT3_EXT:"WEBGL_compressed_texture_s3tc",COMPRESSED_RGBA_S3TC_DXT5_EXT:"WEBGL_compressed_texture_s3tc",COMPRESSED_RGB_PVRTC_4BPPV1_IMG:"WEBGL_compressed_texture_pvrtc",COMPRESSED_RGBA_PVRTC_4BPPV1_IMG:"WEBGL_compressed_texture_pvrtc",COMPRESSED_RGB_PVRTC_2BPPV1_IMG:"WEBGL_compressed_texture_pvrtc",COMPRESSED_RGBA_PVRTC_2BPPV1_IMG:"WEBGL_compressed_texture_pvrtc",COMPRESSED_RGB_ETC1_WEBGL:"WEBGL_compressed_texture_etc1",COMPRESSED_RGBA_ASTC_4x4_KHR:"WEBGL_compressed_texture_astc"};for(let[t,i]of Object.entries(Z)){const n=e[t];if(n!==void 0){const o=Qe.gl.extension(n);o&&console.assert(o[t]===i)}else console.assert(s[t]===i)}}function h1(s){return Qe.gl.disableTextureSlotReuse?new l1(s):new a1(s)}function d1(s,e){let t=new be(0),i=0;const n=[],o=[];this.domElement=s,this.renderContext=e,this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,this.sortObjects=!0;const a=this;let l,c,h,d,u,m,g;const b=new Ar,x=new at,v=new F;this.recompileProgram=function(B){g.recompileProgram(B)};function E(B,N,H,X){e.clearColor(B,N,H,X)}function w(){l=null,c=null,h=-1,d=null,u=null,m=new s1(e),g=new n1(e),e.clearColor(0,0,0,1),e.clearDepth(1),e.clearStencil(0),e.enable(e.DEPTH_TEST),e.depthFunc(e.LEQUAL),e.frontFace(e.CCW),e.cullFace(e.BACK),e.enable(e.CULL_FACE),e.enable(e.BLEND),e.blendEquation(e.FUNC_ADD),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),m.setViewport(0,0,s.width,s.height),E(t.r,t.g,t.b,i),Qe.ie||e.pixelStorei(e.UNPACK_COLORSPACE_CONVERSION_WEBGL,e.NONE)}w(),c1(e),this.webGLContextRestored=function(){w()},this.context=e,this.state=m;const C=h1(e),I=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);this.setCanvasSize=function(B,N){s.width=B,s.height=N,c===null&&this.setViewport(0,0,B,N)},this.setViewport=function(B,N,H,X){m.setViewport(B,N,H,X)},this.setScissor=function(B,N,H,X){e.scissor(B,N,H,X)},this.enableScissorTest=function(B){B?e.enable(e.SCISSOR_TEST):e.disable(e.SCISSOR_TEST)},this.setClearColor=function(B,N){t.copyFrom(B),i=N!==void 0?N:1,E(t.r,t.g,t.b,i)},this.getClearColor=function(){return t},this.getClearAlpha=function(){return i},this.clear=function(B,N,H){let X=0;B&&(X|=e.COLOR_BUFFER_BIT),N&&(X|=e.DEPTH_BUFFER_BIT),H&&(X|=e.STENCIL_BUFFER_BIT),e.clear(X)},this.clearColor=function(){e.clear(e.COLOR_BUFFER_BIT)},this.clearDepth=function(){e.clear(e.DEPTH_BUFFER_BIT)},this.clearStencil=function(){e.clear(e.STENCIL_BUFFER_BIT)};function O(B){const N=B.attributes;for(const H in B.attributesKeys)if(N.hasOwnProperty(H)){const X=N[H];X!==void 0&&X.buffer!==void 0&&(e.deleteBuffer(X.buffer),delete X.buffer)}m.disableAttributeStates(),d=null}function U(B){C.freeSlot(B),B.webglTexture&&(e.deleteTexture(B.webglTexture),B.webglTexture=null)}this.deallocateRenderTargetRenderingBuffers=function(B){if(B.isCube)for(let N=0;N<6;N++)e.deleteFramebuffer(B.webglFramebuffer[N]),e.deleteRenderbuffer(B.webglRenderbuffer[N]);else e.deleteFramebuffer(B.webglFramebuffer),e.deleteRenderbuffer(B.webglRenderbuffer);B.webglFramebuffer=null,B.webglRenderbuffer=null};function z(B){C.freeSlot(B),e.deleteTexture(B.webglTexture),B.webglTexture=null,B.webglFramebuffer&&a.deallocateRenderTargetRenderingBuffers(B)}function ie(B){B.setOnDispose(void 0),O(B)}function J(B){const N=B.target;N.removeEventListener(dt.eventType.DISPOSED,J),U(N)}function re(B){const N=B.target;N.removeEventListener(sr.eventType.DISPOSED,re),z(N)}function Oe(B){const N=B.target;N.removeEventListener(Ht.eventType.DISPOSED,Oe),g.resetProgramAssignment(N)}function We(B,N,H){const X=H.attributes,ve=N.attributes,we=N.attributesKeys,ze=(H.instanceId||0)*4*4;for(let Le=0,_e=we.length;Le<_e;Le++){const Ge=we[Le],ne=ve[Ge];if(ne>=0){const ue=X[Ge];if(ue!==void 0){const Ue=ue.itemSize,et=ue.glType;ue.buffer,e.bindBuffer(e.ARRAY_BUFFER,ue.buffer),m.enableAttributeArray(ne);const ot=ue.divisor||0;let Tt=ze*ot;H.vertexAttribOffset&&(Tt+=H.vertexAttribOffset*ue.glTypeSize*Ue),e.vertexAttribPointer(ne,Ue,et,!1,0,Tt),m.setAttributeDivisor(ne,ot)}else{const Ue=(H.defaultAttributeValues?H.defaultAttributeValues[Ge]:void 0)||B.defaultAttributeValues[Ge];m.disableAttributeArray(ne,Ue)}}}}function Ve(B,N){e.texParameteri(B,e.TEXTURE_WRAP_S,N.wrapS),e.texParameteri(B,e.TEXTURE_WRAP_T,N.wrapT),e.texParameteri(B,e.TEXTURE_MAG_FILTER,N.magFilter),e.texParameteri(B,e.TEXTURE_MIN_FILTER,N.minFilter);const H=Qe.gl.extension("EXT_texture_filter_anisotropic");H&&N.anisotropy>1&&e.texParameterf(B,H.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(N.anisotropy,Qe.gl.maxAnisotropy))}function lt(B,N){const H=B.material,X=N.material,ve=H.program,we=X.program;return ve&&we&&ve.id!==we.id?ve.id-we.id:H.renderResourceId-X.renderResourceId||B.id-N.id}function k(B,N){const H=B.material.transparentRenderOrder-N.material.transparentRenderOrder;return H||N.cameraDistance-B.cameraDistance||B.id-N.id}function K(B,N){(N||B.material).transparent?(a.sortObjects===!0&&(B.cameraDistance=b.nearPlaneDistanceToCenter(B)),o.push(B)):n.push(B)}function de(B,N,H){if(!(!H&&B.visible===!1)){B instanceof Ye&&(B.frustumCulled===!1||b.intersectsObject(B)===!0)&&K(B,N);for(let X=0,ve=B.children.length;X<ve;X++)de(B.children[X],N,H)}}this.setCubeTexture=function(B){if(B.needsUpdate&&B.webglTexture===null&&(B.webglTexture=e.createTexture(),C.setSlot(B,!1)),e.activeTexture(e.TEXTURE0+B.webglSlot),e.bindTexture(e.TEXTURE_CUBE_MAP,B.webglTexture),B.needsUpdate){e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,B.flipY);const N=Cr(B.format),H=B.image;Ve(e.TEXTURE_CUBE_MAP,B);for(let X=0;X<6;X++)if(!N)yl(e,e.TEXTURE_CUBE_MAP_POSITIVE_X+X,0,B.format,H[X]),B.releaseOnLoadedToGpu&&(H[X]=null);else{const ve=H[X].mipmaps;for(let we=0,ze=ve.length;we<ze;we++){const Le=ve[we];yl(e,e.TEXTURE_CUBE_MAP_POSITIVE_X+X,we,B.format,Le),B.releaseOnLoadedToGpu&&(Le.data=null)}}B.generateMipmaps&&e.generateMipmap(e.TEXTURE_CUBE_MAP),B.needsUpdate=!1}};const ce=new at,Te=new Ho;function pe(B,N,H){let X;N.matrixWorld?(ce.multiplyMatrices(B.matrixWorldInverse,N.matrixWorld),X=ce):X=B.matrixWorldInverse,e.uniformMatrix4fv(H.modelViewMatrix,!1,X.elements),H.normalMatrix&&(Te.getNormalMatrix(X),e.uniformMatrix3fv(H.normalMatrix,!1,Te.elements)),H.modelMatrix!==null&&(N.matrixWorld?e.uniformMatrix4fv(H.modelMatrix,!1,N.matrixWorld.elements):e.uniformMatrix4fv(H.modelMatrix,!1,I))}this.forceDoubleSided=function(B){m.forceDoubleSided(B)},this.forceFlipSided=function(B){m.forceFlipSided(B)},this.setMaterialFaces=function(B){m.setDoubleSided(B.side===Fi.DOUBLE),m.setFlipSided(B.side===Fi.BACK)};function ye(B,N=void 0){B.webglTexture||(B.addEventListener(dt.eventType.DISPOSED,J),B.webglTexture=e.createTexture()),e.activeTexture(e.TEXTURE0+(N!=null?N:B.webglSlot)),e.bindTexture(e.TEXTURE_2D,B.webglTexture),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,B.flipY),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,B.premultiplyAlpha),e.pixelStorei(e.UNPACK_ALIGNMENT,B.unpackAlignment),Ve(e.TEXTURE_2D,B);const H=B.mipmaps;if(H.length>0){for(let X=0,ve=H.length;X<ve;X++)yl(e,e.TEXTURE_2D,X,B.format,H[X]);B.releaseOnLoadedToGpu&&(B.mipmaps=void 0),B.generateMipmaps=!1}else yl(e,e.TEXTURE_2D,0,B.format,B.image),B.releaseOnLoadedToGpu&&(B.image=void 0);B.generateMipmaps&&e.generateMipmap(e.TEXTURE_2D),B.needsUpdate=!1}this.setTexture=function(B,N=void 0){B.needsUpdate?ye(B,N):(e.activeTexture(e.TEXTURE0+(N!=null?N:B.webglSlot)),e.bindTexture(e.TEXTURE_2D,B.webglTexture))},this.setRenderTarget=function(B){let N,H,X,ve,we;B?(B.isCube?N=B.webglFramebuffer[B.activeCubeFace]:N=B.webglFramebuffer,H=B.x,X=B.y,ve=B.width,we=B.height):(N=null,H=0,X=0,ve=s.width,we=s.height),N!==c&&(e.bindFramebuffer(e.FRAMEBUFFER,N),c=N),m.setViewport(H,X,ve,we)},this.loadMaterialUniforms=function(B,N){let H,X,ve,we,ze,Le,_e,Ge,ne,ue,Ue,et,ot;for(H=B.materialUniformCache.i,ue=0,Ue=H.length;ue<Ue;ue+=1)X=H[ue],ve=X.id,we=N[ve].value,X.value!==we&&(e.uniform1i(X.location,we),X.value=we);for(H=B.materialUniformCache.f,ue=0,Ue=H.length;ue<Ue;ue+=1)X=H[ue],ve=X.id,we=N[ve].value,X.value!==we&&(e.uniform1f(X.location,we),X.value=we);for(H=B.materialUniformCache.v2,ue=0,Ue=H.length;ue<Ue;ue+=1)X=H[ue],ve=X.id,we=N[ve].value,ze=we.x,Le=we.y,(X.value[0]!==ze||X.value[1]!==Le)&&(e.uniform2f(X.location,ze,Le),X.value[0]=ze,X.value[1]=Le);for(H=B.materialUniformCache.v3,ue=0,Ue=H.length;ue<Ue;ue+=1)X=H[ue],ve=X.id,we=N[ve].value,ze=we.x,Le=we.y,_e=we.z,(X.value[0]!==ze||X.value[1]!==Le||X.value[2]!==_e)&&(e.uniform3f(X.location,ze,Le,_e),X.value[0]=ze,X.value[1]=Le,X.value[2]=_e);for(H=B.materialUniformCache.c,ue=0,Ue=H.length;ue<Ue;ue+=1)X=H[ue],ve=X.id,we=N[ve].value,ze=we.r,Le=we.g,_e=we.b,(X.value[0]!==ze||X.value[1]!==Le||X.value[2]!==_e)&&(e.uniform3f(X.location,ze,Le,_e),X.value[0]=ze,X.value[1]=Le,X.value[2]=_e);for(H=B.materialUniformCache.v4,ue=0,Ue=H.length;ue<Ue;ue+=1)X=H[ue],ve=X.id,we=N[ve].value,ze=we.x,Le=we.y,_e=we.z,Ge=we.w,(X.value[0]!==ze||X.value[1]!==Le||X.value[2]!==_e||X.value[3]!==Ge)&&(e.uniform4f(X.location,ze,Le,_e,Ge),X.value[0]=ze,X.value[1]=Le,X.value[2]=_e,X.value[3]=Ge);for(H=B.materialUniformCache.m4,ue=0,Ue=H.length;ue<Ue;ue+=1)X=H[ue],ve=X.id,e.uniformMatrix4fv(X.location,!1,N[ve].value.elements);for(H=B.materialUniformCache.t,ue=0,Ue=H.length;ue<Ue;ue+=1)X=H[ue],ve=X.id,ne=N[ve].value,ne&&(et=C.setSlot(ne,!0),ot=ne.webglSlot,X.value!==ot&&(e.uniform1i(X.location,ot),X.value=ot),(et||ne.needsUpdate)&&(ne.isCube?this.setCubeTexture(ne):this.setTexture(ne)));C.unlockAllSlots()},this.resetState=function(){C.unlockAllSlots(),w()},this.setMaterial=function(B){m.setBlending(B),m.setDepthTest(B.depthTest),m.setDepthWrite(B.depthWrite),m.setColorWrite(B.colorWrite)},this.setProgram=function(B,N,H){console.assert(N instanceof Ht),N.programNeedsUpdate&&(g.assignProgramToMaterial(N),N.addEventListener(Ht.eventType.DISPOSED,Oe),N.programNeedsUpdate=!1),console.assert(!N.morphTargets);let X=!1,ve=!1;const we=N.program,ze=we.transformUniformCache;return we.id!==l&&(e.useProgram(we.program),l=we.id,X=!0,ve=!0),N.renderResourceId!==h&&(h=N.renderResourceId,ve=!0),X&&(e.uniformMatrix4fv(ze.projectionMatrix,!1,B.projectionMatrix.elements),ze.cameraPosition!==null&&(B.matrixWorld.getTranslation(v),e.uniform3f(ze.cameraPosition,v.x,v.y,v.z)),ze.viewMatrix!==null&&e.uniformMatrix4fv(ze.viewMatrix,!1,B.matrixWorldInverse.elements)),(X||H.matrixWorld!==u)&&(u=H.matrixWorld,pe(B,H,ze)),N.refreshPerObjectUniforms&&N.refreshPerObjectUniforms(H)&&(ve=!0),N.renderSteps>1&&(ve=!0),ve&&this.loadMaterialUniforms(we,N.uniforms),we},this.renderBufferDirect=function(B,N,H,X){if(N.visible===!1||H.vertexCnt===0)return;const ve=this.setProgram(B,N,X);let we=!1;(H.id!==d||ve.id!==l)&&(d=H.id,we=!0),console.assert(X instanceof Ye);const ze=e.TRIANGLES,Le=H.attributes.index;if(Le){const _e=Le.glType,Ge=H.indexUint?4:2;we&&(We(N,ve,H),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,Le.buffer));let ne,ue;H.indexOffset!==void 0?(ne=H.indexCnt,ue=Ge*H.indexOffset):(ne=Le.length,ue=0),H.isInstanced?e.drawElementsInstanced(ze,ne,_e,ue,H.instanceCount):e.drawElements(ze,ne,_e,ue)}else{we&&We(N,ve,H);const _e=H.attributes.position;let Ge,ne;H.vertexOffset!==void 0?(Ge=H.vertexCnt,ne=H.vertexOffset):(Ge=_e.length/_e.itemSize,ne=0),H.isInstanced?e.drawArraysInstanced(ze,ne,Ge,H.instanceCount):e.drawArrays(ze,ne,Ge)}m.resetAttributeDivisors()},this.renderObjects=function(B,N,H){ri.beginSection("WebGLRenderer.renderObjects");let X;H&&(X=H,this.setMaterial(X),this.setMaterialFaces(X));for(let ve=0,we=B.length;ve<we;ve+=1){const ze=B[ve],Le=ze.geometry,_e=ze.materialOverride?ze.materialOverride:ze.material;try{H?H.doNotOverrideSide&&_e&&this.setMaterialFaces(_e):(X=_e,this.setMaterial(X),this.setMaterialFaces(X));for(let Ge=0;Ge<X.renderSteps;Ge++)X.updateRenderStep(Ge),this.renderBufferDirect(N,X,Le,ze)}catch(Ge){const ne=X?X.name:"null";console.error(`Failed to render material ${ne}: ${Ge.stack}`)}}ri.endSection("WebGLRenderer.renderObjects")},this.updateRenderTargetMipmap=function(B){const N=C.setSlot(B,!1);e.activeTexture(e.TEXTURE0+B.webglSlot),B.isCube?(N&&e.bindTexture(e.TEXTURE_CUBE_MAP,B.webglTexture),e.generateMipmap(e.TEXTURE_CUBE_MAP)):(N&&e.bindTexture(e.TEXTURE_2D,B.webglTexture),e.generateMipmap(e.TEXTURE_2D))},this.resetCaching=function(){d=null,h=-1,l=null,u=null,m.resetAttributeStates()},this.render=function(B,N,H,X){this.renderMeshes(B.children,B.overrideMaterial,N,H,X)},this.renderMeshes=function(B,N,H,X,ve,we){ri.beginSection("WebGLRenderer.renderMeshes"),this.resetCaching(),H.matrixWorldInverse.getInverse(H.matrixWorld),x.multiplyMatrices(H.projectionMatrix,H.matrixWorldInverse),b.setFromMatrix(x),n.length=0,o.length=0;const ze=we===void 0?!1:we;for(let Le=0;Le<B.length;Le+=1)de(B[Le],N,ze);a.sortObjects===!0&&(n.sort(lt),o.sort(k)),this.setRenderTarget(X),(this.autoClear||ve)&&this.clear(this.autoClearColor,this.autoClearDepth,this.autoClearStencil),this.renderObjects(n,H,N),this.renderObjects(o,H,N),X&&X.generateMipmaps&&this.updateRenderTargetMipmap(X),m.setDepthTest(!0),m.setDepthWrite(!0),m.setColorWrite(!0),m.resetAttributeStates(),ri.endSection("WebGLRenderer.renderMeshes")};let Re=null;this.setUploadBuffersFuncOverride=function(B){Re=B},this.uploadNewBuffers=function(B){if(Re){Re(B);return}const N=B.geometry,H=N.attributes,X=N.attributesKeys;N.setOnDispose(ie),console.assert(N instanceof on||N instanceof cl);for(let ve=0,we=X.length;ve<we;ve+=1){const ze=X[ve],Le=H[ze],_e=ze==="index"?e.ELEMENT_ARRAY_BUFFER:e.ARRAY_BUFFER;if(Le.buffer)Le.needsUpdate===!0&&console.assert(!1);else{Le.buffer=e.createBuffer(),e.bindBuffer(_e,Le.buffer);const Ge=Le.array;if(Qe.ios&&_e===e.ARRAY_BUFFER){const ne=Le.itemSize*Ge.BYTES_PER_ELEMENT%4;console.assert(ne===0)}e.bufferData(_e,Ge,e.STATIC_DRAW),Ge instanceof Float32Array?(Le.glType=e.FLOAT,Le.glTypeSize=4):Ge instanceof Int8Array?(Le.glType=e.BYTE,Le.glTypeSize=1):Ge instanceof Int16Array?(Le.glType=e.SHORT,Le.glTypeSize=2):Ge instanceof Uint16Array?(Le.glType=e.UNSIGNED_SHORT,Le.glTypeSize=2):Ge instanceof Uint32Array?(Le.glType=e.UNSIGNED_INT,Le.glTypeSize=4):console.assert(!1),Le.releaseOnLoadedToGpu&&(Le.array=null),Le.needsUpdate=!1}}},this.uploadTexture=function(B,N=void 0){C.setSlot(B,!1),ye(B,N)},this.copyFramebufferToCubeFaceMip=function(B,N,H,X,ve){C.setSlot(ve,!1),e.activeTexture(e.TEXTURE0+ve.webglSlot),e.bindTexture(e.TEXTURE_CUBE_MAP,ve.webglTexture),Gr(e,e.TEXTURE_CUBE_MAP_POSITIVE_X+H,B,Be.RGBA8,N,N,X)},this.createCubeTexture=function(B,N){const H=new dt;H.isCube=!0,H.anisotropy=dt.NO_ANISOTROPY,N?H.minFilter=Z.LINEAR_MIPMAP_NEAREST:H.minFilter=Z.LINEAR,H.generateMipmaps=!1,H.needsUpdate=!1,H.addEventListener(dt.eventType.DISPOSED,J),H.webglTexture=e.createTexture(),C.setSlot(H,!1),e.activeTexture(e.TEXTURE0+H.webglSlot),e.bindTexture(e.TEXTURE_CUBE_MAP,H.webglTexture),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_MAG_FILTER,e.LINEAR),N?e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_MIN_FILTER,e.LINEAR_MIPMAP_NEAREST):e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_MIN_FILTER,e.LINEAR);for(let X=0;X<6;X+=1)Gr(e,e.TEXTURE_CUBE_MAP_POSITIVE_X+X,0,Be.RGBA8,B,B,null);return N&&e.generateMipmap(e.TEXTURE_CUBE_MAP),H};function he(B,N){e.bindRenderbuffer(e.RENDERBUFFER,B),N.depthBuffer?(e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_STENCIL,N.width,N.height),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_STENCIL_ATTACHMENT,e.RENDERBUFFER,B)):e.renderbufferStorage(e.RENDERBUFFER,e.RGBA4,N.width,N.height)}function je(B,N,H){e.bindFramebuffer(e.FRAMEBUFFER,B),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,N,H,0)}function Xe(B,N){if(N.addEventListener(sr.eventType.DISPOSED,re),N.webglTexture=e.createTexture(),C.setSlot(N,!1),e.activeTexture(e.TEXTURE0+N.webglSlot),B){e.bindTexture(e.TEXTURE_CUBE_MAP,N.webglTexture),Ve(e.TEXTURE_CUBE_MAP,N);for(let H=0;H<6;H++)N.webglFramebuffer[H]=e.createFramebuffer(),N.webglRenderbuffer[H]=e.createRenderbuffer(),Gr(e,e.TEXTURE_CUBE_MAP_POSITIVE_X+H,0,N.format,N.width,N.height,null),je(N.webglFramebuffer[H],e.TEXTURE_CUBE_MAP_POSITIVE_X+H,N.webglTexture),he(N.webglRenderbuffer[H],N);N.generateMipmaps&&e.generateMipmap(e.TEXTURE_CUBE_MAP)}else{if(N.webglFramebuffer=e.createFramebuffer(),N.shareDepthFrom?N.webglRenderbuffer=N.shareDepthFrom.webglRenderbuffer:N.webglRenderbuffer=e.createRenderbuffer(),e.bindTexture(e.TEXTURE_2D,N.webglTexture),Ve(e.TEXTURE_2D,N),Gr(e,e.TEXTURE_2D,0,N.format,N.width,N.height,null),je(N.webglFramebuffer,e.TEXTURE_2D,N.webglTexture),N.useDepthTexture)N.depthTexture=dt.newDataTexture(null,N.width,N.height,Be.DEPTH24),N.depthTexture.webglTexture=e.createTexture(),C.setSlot(N.depthTexture,!1),e.activeTexture(e.TEXTURE0+N.depthTexture.webglSlot),e.bindTexture(e.TEXTURE_2D,N.depthTexture.webglTexture),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_COMPARE_MODE,e.NONE),Gr(e,e.TEXTURE_2D,0,Be.DEPTH24,N.width,N.height,null),e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.TEXTURE_2D,N.depthTexture.webglTexture,0),e.bindTexture(e.TEXTURE_2D,null);else if(N.shareDepthFrom){if(N.depthBuffer){const H=e.DEPTH_STENCIL_ATTACHMENT;e.framebufferRenderbuffer(e.FRAMEBUFFER,H,e.RENDERBUFFER,N.webglRenderbuffer)}}else he(N.webglRenderbuffer,N);N.generateMipmaps&&e.generateMipmap(e.TEXTURE_2D)}e.bindRenderbuffer(e.RENDERBUFFER,null),e.bindFramebuffer(e.FRAMEBUFFER,null)}this.createFrameBufferRenderTarget=function(B){return new hh(B)},this.createRenderTarget=function(B,N,H){const X=new sr(B,N,H);return Xe(!1,X),X},this.createRenderTargetCube=function(B,N,H){const X=new Kv(B,N,H);return Xe(!0,X),X},this.readPixels=function(B,N,H){e.readPixels(0,0,B,N,e.RGBA,e.UNSIGNED_BYTE,H)},this.checkGlError=function(){const B=e.getError();B!==e.NO_ERROR&&console.log("gl error! "+B)}}const u1=10,f1=8;function m1(s){return M.DEBUG_WEBGL?Xs.wrapWebglDebug(s):s}function p1(s,e){var t,i,n,o,a,l;(t=e.alpha)!=null||(e.alpha=!0),(i=e.depth)!=null||(e.depth=!0),(n=e.stencil)!=null||(e.stencil=!1),(o=e.premultipliedAlpha)!=null||(e.premultipliedAlpha=!0),(a=e.antialias)!=null||(e.antialias=!0),(l=e.preserveDrawingBuffer)!=null||(e.preserveDrawingBuffer=!1);try{return s.getContext("webgl2",e)}catch(c){return null}}function uf(s,e){const t=p1(s,e);return t?(Qe.resetGlDetector(t),Qe.gl.reportToConsole(),new d1(s,m1(t))):null}function _1(s){const e={antialias:!M.NO_BUILTIN_AA&&!M.FORCE_FXAA,powerPreference:M.HIGH_PERFORMANCE_POWER_PREFERENCE?"high-performance":"default"},t=uf(s,e);return t&&(t.autoClear=!0,t.autoClearColor=!1,t.autoClearDepth=!0,t.autoClearStencil=!1,t.sortObjects=!0),t}class g1{constructor(e,t,i,n){r(this,"_rawRenderer");r(this,"_vrManager");r(this,"_exposureController");r(this,"_camera");r(this,"_threeScene");r(this,"_postProcess");r(this,"_prevExposureAdaptationTime",Date.now());r(this,"_prevExposureAdaptationFrames",0);this._rawRenderer=e,this._vrManager=t,this._exposureController=n,this._camera=i.camera,this._threeScene=i.threeScene,ri.setWebGLContext(e.renderContext),this._postProcess=new Qv(e,this._threeScene,this._camera),Qe.gl.antialiasPostprocess&&(this._postProcess.init(),Qe.gl.antialiasNative||this._postProcess.addFXAA(),this._camera.motionBlurEnabled&&this._postProcess.addMotionBlur(),this._postProcess.setup(),this._postProcess.addSSAA(i))}dpr(){return window.devicePixelRatio}resize(e){if(e)return;const t=window.innerWidth,i=window.innerHeight,n=t*this.dpr(),o=i*this.dpr();this._camera.physicalWidth=n,this._camera.physicalHeight=o,this._camera.updateProjectionMatrix(),this._rawRenderer.setCanvasSize(n,o),this._rawRenderer.domElement.style.width=t+"px",this._rawRenderer.domElement.style.height=i+"px",this._postProcess.onResize(n,o)}renderIdle(e,t){return t===0&&this._postProcess.resetSSAA(),this._exposureController.exposureNeedsUpdate()?(this.renderToScreen(e,!1),!0):this._postProcess.updateSSAA()}renderToScreen(e,t){ri.beginSection("Renderer.renderToScreen"),Date.now()-this._prevExposureAdaptationTime>1e3/u1&&this._prevExposureAdaptationFrames>f1&&(this._exposureController.adaptExposure(!1,M.FORCE_AUTO_EXPOSURE),this._prevExposureAdaptationTime=Date.now(),this._prevExposureAdaptationFrames=0),this._prevExposureAdaptationFrames++,this._exposureController.update(e),t?this._vrManager.render(this._threeScene,this._camera.matrixWorld):this._postProcess.isEnabled?this._postProcess.update(e):this._rawRenderer.render(this._threeScene,this._camera),ri.endSection("Renderer.renderToScreen")}enableAutoExposure(){this._exposureController.enableAutoExposure()}disableAutoExposure(){this._exposureController.disableAutoExposure()}}function v1(s,e,t){for(let i=0;i<t;++i)for(let n=0;n<e;++n){const o=4*(i*e+n);if(i<t/2){const l=4*((t-i-1)*e+n);for(let c=0;c<3;++c){const h=s[o+c];s[o+c]=s[l+c],s[l+c]=h}}const a=3;s[o+a]=255}}const Hr=function(s,e,t,i,n){return s.createRenderTarget(e,t,{magFilter:i,minFilter:i,depthBuffer:n,stencilBuffer:!1,generateMipmaps:!1})};function b1(s,e,t){const i=[],n=[],o=[{totalFovFraction:.25,count:2},{totalFovFraction:.25,count:16},{totalFovFraction:.375,count:48},{totalFovFraction:.125,count:8}],a=4;(function(){const c={fovSum:0,heightSum:0,totalFovFraction:0};for(let h=0;h<o.length;h++){const d=o[h],u=d.totalFovFraction*s/d.count;console.assert(u===Math.floor(u),`Height (${u})must be an integer`);const m=d.totalFovFraction*Math.PI/2/d.count,g=Hr(t,e*a,u*a,Z.LINEAR,!0);n.push(g);for(let b=0;b<d.count;b++)i.push({fov:m,fovOffset:c.fovSum+(b+.5)*m,height:u,yOffset:c.heightSum+b*u,renderTarget:g});c.fovSum+=d.count*m,c.heightSum+=d.count*u,c.totalFovFraction+=d.totalFovFraction}console.assert(c.totalFovFraction===1,"Invalid fractions sum"),console.assert(c.fovSum===Math.PI/2,"Invalid fov definition for rectangles"),console.assert(c.heightSum===s,"Invalid rectangles height")})(),this.getRectangleHeight=function(c){return i[c].height},this.getRectangleOffset=function(c){return i[c].yOffset},this.getRectangleFov=function(c){return i[c].fov},this.getRectangleFovOffset=function(c){return i[c].fovOffset},this.getRectangleRenderTarget=function(c){return i[c].renderTarget},this.dispose=function(){n.forEach(function(c){c.dispose()}),i.length=0,n.length=0},this.getRectangleCount=function(){return i.length}}function x1(s,e,t){let i=null,n=null,o=null,a=null;const l=new F;function c(){const g=document.body.offsetHeight*i,b=(document.body.offsetWidth-g)/2,x=Math.max(b,0),v=`${b}px`,E=`${x}px`;n.style.width=E,o.style.width=E,a.style.left=v,a.style.right=v}this.markArea=function(g){function b(v,E){v.style.zIndex=1,v.style.pointerEvents="none",v.style.position="absolute",v.style.top=0,v.style.bottom=0,v.style[E]=0,v.style.backgroundColor="rgba(0, 0, 0, 0.5)"}function x(v){v.style.zIndex=1,v.style.pointerEvents="none",v.style.position="absolute",v.style.boxSizing="border-box",v.style.top=0,v.style.bottom=0,v.style.border="4px solid rgba(35, 181, 233, 0.5)"}a||(n=document.createElement("div"),b(n,"left"),o=document.createElement("div"),b(o,"right"),a=document.createElement("div"),x(a),document.body.appendChild(n),document.body.appendChild(o),document.body.appendChild(a),window.addEventListener("resize",c)),i=g,c()},this.unmarkArea=function(){a&&(n.remove(),o.remove(),a.remove(),window.removeEventListener("resize",c),i=null,n=null,o=null,a=null)};function h(g,b,x,v,E,w){const C=e.camera.near,I=e.camera.far,O=512,U=.03;console.assert(x%O===0,"Invalid width for stereo panorama");const z=x/2,ie=new F(0,-1,0),J=z/2,re=2*Math.PI/O,Oe=x/O,We=-Oe,Ve=Oe,lt={BOTTOM:Symbol("Bottom"),TOP:Symbol("Top")},k=Math.floor(b/re)*re,K=C*Math.tan(re/2),de=new As;de.up.set(0,0,1);const ce=new b1(J,Oe,s),Te=ce.getRectangleCount(),pe=new F,ye=new F,Re=new F,he=new at,je=function(_e,Ge,ne,ue){const Ue=function(L){return K*Math.cos(L)},et=-(Ge*re-k),ot=_e===lt.TOP?-ce.getRectangleFovOffset(ne):ce.getRectangleFovOffset(ne);he.makeRotationZ(et),pe.set(ue,0,0),he.affineTransformPoint3(pe),de.position.copyFrom(g).add(pe),ye.copyFrom(ie),he.makeRotationX(ot).transformVector3(ye),he.makeRotationZ(et).transformVector3(ye),Re.copyFrom(de.position).add(ye),de.lookAt(Re);const Tt=C*Math.tan(ce.getRectangleFov(ne)/2),ct=Ue(ot);de.projectionMatrix.makeFrustum(-ct,ct,-Tt,Tt,C,I),de.updateMatrix(),de.updateMatrixWorld()},Xe=Hr(s,x,2*z,Z.NEAREST,!1);Xe.width=Oe;const B=new Qu,N=function(_e){Xe.dispose(),ce.dispose(),B.dispose(),E(_e)},H=[{hemisphere:lt.TOP,eyeOffset:U,parallaxOffset:We,targetYOffset:z},{hemisphere:lt.BOTTOM,eyeOffset:U,parallaxOffset:We,targetYOffset:z},{hemisphere:lt.TOP,eyeOffset:-U,parallaxOffset:Ve,targetYOffset:0},{hemisphere:lt.BOTTOM,eyeOffset:-U,parallaxOffset:Ve,targetYOffset:0}],X=function(_e,Ge){if(Ge++,Ge===O){if(_e++,_e===H.length)return[-1,-1];Ge=0}return[_e,Ge]},ve=H.length*O,we=Math.ceil(ve/100),ze=function(_e){v({done:_e,total:ve})},Le=function(_e,Ge){const ne=H[_e].hemisphere,ue=H[_e].eyeOffset,Ue=H[_e].parallaxOffset,et=H[_e].targetYOffset;for(let ot=0;ot<Te;ot++){je(ne,Ge,ot,ue);const Tt=ce.getRectangleRenderTarget(ot);s.render(e.threeScene,de,Tt);const ct=ce.getRectangleHeight(ot),L=ce.getRectangleOffset(ot);ne===lt.TOP?Xe.y=et+J+L:Xe.y=et+J-L-ct,Xe.x=(Ge*Oe+Ue+x)%x,Xe.height=ct,B.render(s,Xe,Tt)}if(w()){N(null);return}if([_e,Ge]=X(_e,Ge),_e===-1){const ot=new Uint8Array(x*2*z*4);s.readPixels(x,2*z,ot),N(ot);return}Ge%we===0&&ze(_e*O+Ge),setTimeout(()=>Le(_e,Ge),0)};Le(0,0)}function d(g,b,x,v){const E=new Lc(e.camera.near,e.camera.far);E.rotateZ(b),E.position.copyFrom(g),E.updateMatrixWorld();const w=4096,C=s.createRenderTargetCube(w,w,{magFilter:Z.LINEAR,minFilter:Z.LINEAR,stencilBuffer:!1,generateMipmaps:!1});for(let ie=0;ie<6;ie+=1)C.activeCubeFace=ie,s.render(e.threeScene,E.sideCameras[ie],C);const I=Hr(s,x,v,Z.NEAREST,!0),O={uniforms:{panoramaCube:{type:"t",value:null}},vertexShaderName:"cube_to_equirect_vertex.glsl",fragmentShaderName:"cube_to_equirect_fragment.glsl"},U=new as(O,"panoramaCube");U.render(s,I,C),U.dispose(),C.dispose();const z=new Uint8Array(x*v*4);return s.readPixels(x,v,z),I.dispose(),z}function u(g,b){const x=Hr(s,g,b,Z.NEAREST,!0),v=Hr(s,g,b,Z.NEAREST,!1),E=new fh(s,e);E.setTargets(x,v),E.renderAllSamples();const w=E.copyAccumulatedSamplesToBuffer();return x.dispose(),v.dispose(),E.dispose(),w}this.monoScreenToBuffer=function(g,b,x){return g?d(t.cameraWorldPosition(),t.getYawAngle(),b,x):u(b,x)},this.stereoPanoramaToBuffer=function(g,b,x,v){h(t.cameraWorldPosition(),t.getYawAngle(),g,b,x,v)},this.monoScreenToDataUrl=function(g,b,x){const v=this.monoScreenToBuffer(g,b,x);v1(v,b,x);const E=new Uint8ClampedArray(v),w=new ImageData(E,b,x),C=document.createElement("canvas");C.width=b,C.height=x,C.getContext("2d").putImageData(w,0,0);const O="image/jpeg";return C.toDataURL(O)},this.monoScreenToLocalImage=function(g,b,x){const v=this.monoScreenToDataUrl(g,b,x);Vo(v,"screenshot")},this.coverToServer=function(g,b){const x=u(g,b),v=`screenshot?width=${g}&height=${b}`;Mr(v,"application/binary",x)};function m(g,b){const x=Math.min(M.MAX_PANORAMA_SIZE,Qe.gl.maxRenderBufferSize);if(g<=x&&b<=x)return[g,b];const v=g/b;return g>b?[x,Math.floor(x/v)]:[Math.floor(x*v),x]}this.monoPanoramaToServer=function(g,b){g.position?l.fromArray(g.position):l.copyFrom(t.cameraWorldPosition());let x=g.width!==void 0?g.width:8e3,v=g.height!==void 0?g.height:4e3;[x,v]=m(x,v);const E=g.rotation!==void 0?qt(g.rotation):0,w=d(l,E,x,v),C=g.name,I=`panorama?width=${x}&height=${v}&name=${C}`;Mr(I,"application/binary",w,b,b)}}class ff{constructor(){r(this,"_strings",new Set);r(this,"_regExps",new Array)}add(e){e instanceof RegExp?this._regExps.push(e):this._strings.add(e)}matchesAny(e){return this._strings.has(e)?!0:this._regExps.some(t=>t.test(e))}}class y1{constructor(){r(this,"_editableNodeTypes",new ff);r(this,"_editableMaterialNames",new ff);r(this,"_allMaterialsEditable",!1)}setAllMaterialsEditable(){this._allMaterialsEditable=!0}setNodeTypeEditable(e){this._editableNodeTypes.add(e)}setMaterialEditable(e){this._editableMaterialNames.add(e)}isMaterialEditable(e){return this._allMaterialsEditable||this._editableMaterialNames.matchesAny(e)}isNodeTypeEditable(e){return this._editableNodeTypes.matchesAny(e)}}function A1(){return{enabled:!1,outlineColor:[0,0,0],outlineThickness:1,fillEnabled:!0,levels:[]}}function E1(s){return s!==void 0?s:A1()}function T1(s){return s&&s.trim()||"level"}class vh{constructor(e,t,i){r(this,"_boundingBox");r(this,"_updatedCallback");r(this,"_name");r(this,"_slicePlaneHeight");r(this,"_farPlaneHeight");r(this,"_rotation");r(this,"_crop");r(this,"_cropRange");r(this,"_ratio");r(this,"_visibleRange");this._boundingBox=t,this._updatedCallback=i,this._name=e.name||"level",this._slicePlaneHeight=e.slicePlaneHeight,this._farPlaneHeight=e.farPlaneHeight,this._rotation=e.rotation||0,this._crop=!!e.cropRange,this._cropRange=e.cropRange?new yr(new Ce().fromArray(e.cropRange.min),new Ce().fromArray(e.cropRange.max)):new yr,this._ratio=new Ce(1,1),this._visibleRange=new yr,this._crop&&this._updateRatio()}_setDefaultRange(){this._cropRange.set(new Ce(this._boundingBox.min.x,this._boundingBox.min.y),new Ce(this._boundingBox.max.x,this._boundingBox.max.y))}_updateVisibleRange(){const e=this._cropRange.center(),t=Math.abs(Math.sin(this._rotation)),i=Math.abs(Math.cos(this._rotation)),n=Math.abs(this._cropRange.max.x-this._cropRange.min.x),o=Math.abs(this._cropRange.max.y-this._cropRange.min.y),a=n*i+o*t,l=n*t+o*i;this._visibleRange.set(new Ce(e.x-a/2,e.y+l/2),new Ce(e.x+a/2,e.y-l/2))}_updateRatio(){const e=Math.abs(this._boundingBox.min.x-this._boundingBox.max.x),t=Math.abs(this._boundingBox.min.y-this._boundingBox.max.y),i=this._cropRange.size().x/e,n=this._cropRange.size().y/t;i>n?this._ratio.set(1,n/i):this._ratio.set(i/n,1)}setRange(e,t,i){e>this._cropRange.max[i]&&(e=this._cropRange.max[i]),t<this._cropRange.min[i]&&(t=this._cropRange.min[i]),this._cropRange.min[i]=e,this._cropRange.max[i]=t,this._updateVisibleRange(),this._updateRatio(),this._updatedCallback()}serialize(){const e=this._crop?{min:this._cropRange.min.toArray(),max:this._cropRange.max.toArray()}:null;return{name:this.name,slicePlaneHeight:this.slicePlaneHeight,farPlaneHeight:this.farPlaneHeight,cropRange:e,rotation:this.rotation}}get name(){return this._name}set name(e){this._name=T1(e),this._updatedCallback()}get slicePlaneHeight(){return this._slicePlaneHeight}set slicePlaneHeight(e){e>=this._farPlaneHeight&&(this._slicePlaneHeight=e,this._updatedCallback())}get farPlaneHeight(){return this._farPlaneHeight}set farPlaneHeight(e){e<=this._slicePlaneHeight&&(this._farPlaneHeight=e,this._updatedCallback())}get crop(){return this._crop}set crop(e){this._crop=e,e||this._setDefaultRange(),this._updateVisibleRange(),this._updateRatio(),this._updatedCallback()}get cropRange(){return this._cropRange.empty()&&this._setDefaultRange(),this._cropRange}get visibleRange(){return this._visibleRange.empty()&&this._updateVisibleRange(),this._visibleRange}get ratio(){const e=this._ratio;return(e.x===0||e.y===0||!isNaN(e.x)||!isNaN(e.y))&&this._updateRatio(),e}get rotation(){return this._rotation}set rotation(e){this._rotation=e,this._crop||this._setDefaultRange(),this._updateVisibleRange(),this._updateRatio(),this._updatedCallback()}get rotationDeg(){return mn(this.rotation)}set rotationDeg(e){this.rotation=qt(e)}}var mf=(s=>(s.UPDATED="minimapConfigUpdated",s))(mf||{});const rc=class rc extends ei{constructor(t,i){var l,c;super();r(this,"_boundingBox");r(this,"_defaultViewHeight");r(this,"_updated");r(this,"_enabled");r(this,"_outlineColor");r(this,"_outlineThickness");r(this,"_fillEnabled");r(this,"_levels");const n=t.minimap,o=t.views||[];this._boundingBox=i,this._defaultViewHeight=(c=(l=o.at(0))==null?void 0:l.position)==null?void 0:c.at(2);const a=E1(n);this._updated=()=>this.dispatchEvent({type:rc.eventType.UPDATED}),this._enabled=a.enabled,this._outlineColor=new be().fromArray(a.outlineColor),this._outlineThickness=a.outlineThickness,this._fillEnabled=a.fillEnabled,this._levels=a.levels.map(h=>new vh(h,i,this._updated))}_firstLevel(){var o;const t="level0",i=(o=this._defaultViewHeight)!=null?o:this._boundingBox.min.z+M.FALLBACK_CAMERA_HEIGHT,n=this._boundingBox.min.z;return new vh({name:t,slicePlaneHeight:i,farPlaneHeight:n},this._boundingBox,this._updated)}_nextLevel(t,i){const n="level"+t,o=this._levels[t-1],a=this._boundingBox.max.z-o.slicePlaneHeight,l=o.slicePlaneHeight+a/2,c=o.farPlaneHeight,h=o.rotation,d=i.crop?{min:i.cropRange.min.toArray(),max:i.cropRange.max.toArray()}:void 0;return new vh({name:n,slicePlaneHeight:l,farPlaneHeight:c,cropRange:d,rotation:h},this._boundingBox,this._updated)}_serializeLevels(){return this._levels.map(t=>t.serialize())}createLevel(t){const i=this._levels.length;return i===0?this._firstLevel():(Ke(t),this._nextLevel(i,t))}addLevel(t){this._levels.push(t),this._updated()}removeLevel(t){zi(t,this._levels),this._levels.length===0&&this._levels.push(this._firstLevel()),this._updated()}shiftLevel(t,i){Ha(this._levels,t,i),this._updated()}getLevelsIndex(t){return this._levels.findIndex(i=>i===t)}serialize(){return{enabled:this.enabled,outlineColor:this.outlineColor.toArray(),outlineThickness:this.outlineThickness,fillEnabled:this.fillEnabled,levels:this._serializeLevels()}}get enabled(){return this._enabled}set enabled(t){t&&this._levels.length===0&&this.addLevel(this.createLevel()),this._enabled=t,this._updated()}get outlineColor(){return this._outlineColor}get outlineColorRGB(){return this._outlineColor.toArray()}set outlineColorRGB(t){this._outlineColor.setRGB(...t),this._updated()}get outlineThickness(){return this._outlineThickness}set outlineThickness(t){this._outlineThickness=t,this._updated()}get fillEnabled(){return this._fillEnabled}set fillEnabled(t){this._fillEnabled=t,this._updated()}get levels(){return this._levels}};r(rc,"eventType",mf);let Wr=rc;function pf(s){return Nt(qt(s))}var zn=(s=>(s.ORBIT="orbit",s.FPS="fps",s))(zn||{});const S1={internal:!1,position:[0,0,0],rotation:[0,0],hideFromMenu:!0,sky:M.EDITOR_CONTROLLED_SKY_NAME};var _f=(s=>(s.UPDATED="viewUpdated",s))(_f||{});const br=class br extends ei{constructor(t=S1,i){var n,o,a,l,c,h,d,u,m,g,b,x,v;super();r(this,"id");r(this,"name");r(this,"internal");r(this,"position");r(this,"rotation");r(this,"hideFromMenu");r(this,"sky");r(this,"mode");r(this,"orthographic");r(this,"orthoFrustumSize");r(this,"distance");r(this,"panPrimary");r(this,"noRotate");r(this,"noPitchRotate");r(this,"noPan");r(this,"minDistance");r(this,"maxDistance");r(this,"minUpAngle");r(this,"maxUpAngle");r(this,"minSideAngle");r(this,"maxSideAngle");r(this,"target");r(this,"fov");r(this,"_updated");this.id=t.id!==void 0?t.id:br._nextViewAutoId++,this.name=t.name||"view"+this.id,this.internal=(n=t.internal)!=null?n:!1,this.mode=(o=t.mode)!=null?o:"fps",t.position?this.position=new F(t.position[0],t.position[1],t.position[2]):this.mode==="fps"&&(this.position=i),t.rotation&&(this.rotation=new ui(pf(t.rotation[0]),pf(t.rotation[1]),0)),this.hideFromMenu=(a=t.hideFromMenu)!=null?a:!1,this.sky=(l=t.sky)!=null?l:M.EDITOR_CONTROLLED_SKY_NAME,this.orthographic=(c=t.orthographic)!=null?c:!1,this.orthoFrustumSize=(h=t.orthoFrustumSize)!=null?h:M.CAMERA_ORTHO_FRUSTUM_SIZE,this.distance=t.distance,this.panPrimary=t.panPrimary,this.noRotate=t.noRotate,this.noPitchRotate=t.noPitchRotate,this.noPan=(d=t.noPan)!=null?d:!1,this.minDistance=(u=t.minDistance)!=null?u:1,this.maxDistance=(m=t.maxDistance)!=null?m:100,this.minUpAngle=(g=t.minUpAngle)!=null?g:-Math.PI/2,this.maxUpAngle=(b=t.maxUpAngle)!=null?b:Math.PI/2,this.minSideAngle=(x=t.minSideAngle)!=null?x:-Math.PI,this.maxSideAngle=(v=t.maxSideAngle)!=null?v:Math.PI,t.target&&(this.target=new F(t.target[0],t.target[1],t.target[2])),this.fov=t.fov,this._updated=()=>this.dispatchEvent({type:br.eventType.UPDATED})}isTop(){return!!(this.mode==="orbit"&&this.panPrimary&&this.noPitchRotate)}isOrbit(){return this.mode==="orbit"&&!this.isTop()}usesDefaultSky(){return this.sky===M.DEFAULT_SKY_NAME}switchSky(){this.usesDefaultSky()?this.sky=M.EDITOR_CONTROLLED_SKY_NAME:this.sky=M.DEFAULT_SKY_NAME,this._updated()}setName(t){this.name=t,this._updated()}getCameraParameters(){var t,i,n;return{position:(t=this.position)==null?void 0:t.toArray(),rotation:(i=this.rotation)==null?void 0:i.toDegTriple(),target:(n=this.target)==null?void 0:n.toArray(),distance:this.distance}}setCameraParameters(t){t.position?(this.position||(this.position=new F),this.position.fromArray(t.position)):this.position=void 0,t.rotation?(this.rotation||(this.rotation=new ui),this.rotation.setFromDegTriple(t.rotation)):this.rotation=void 0,this.distance=t.distance,t.target?(this.target||(this.target=new F),this.target.fromArray(t.target)):this.target=void 0}setPosition(t,i,n){Pe(this.position),this.position.set(t,i,n),this._updated()}setYaw(t){Pe(this.rotation),this.rotation.yaw=t,this._updated()}setMinUpAngle(t){t!==this.minUpAngle&&(this.minUpAngle=t,this._updated())}setMaxUpAngle(t){t!==this.maxUpAngle&&(this.maxUpAngle=t,this._updated())}setMinSideAngle(t){t!==this.minSideAngle&&(this.minSideAngle=t,this._updated())}setMaxSideAngle(t){t!==this.maxSideAngle&&(this.maxSideAngle=t,this._updated())}setHideFromMenu(t){t!==this.hideFromMenu&&(this.hideFromMenu=t,this._updated())}setMinDistance(t){t!==this.minDistance&&(this.minDistance=t,this._updated())}setMaxDistance(t){t!==this.maxDistance&&(this.maxDistance=t,this._updated())}setNoPan(t){t!==this.noPan&&(this.noPan=t,this._updated())}toCamera(){const t=new gi;return this.orthographic?Pe(!1,"TODO(kj): writeme"):(Pe(this.position),Pe(this.rotation),t.position.copyFrom(this.position),t.rotation.copyFrom(this.rotation)),t.updateMatrixWorld(!0),t.matrixWorldInverse.getInverse(t.matrixWorld),t}serialize(){var i;const t={id:this.id,name:this.name,mode:this.mode,rotation:(i=this.rotation)==null?void 0:i.toDegTriple().slice(0,2),hideFromMenu:this.hideFromMenu,sky:this.sky};return this.position&&(t.position=this.position.toArray()),this.target&&(t.target=this.target.toArray()),this.minSideAngle!==-1/0&&(t.minSideAngle=this.minSideAngle),this.maxSideAngle!==1/0&&(t.maxSideAngle=this.maxSideAngle),this.orthographic&&(t.orthographic=this.orthographic,t.orthoFrustumSize=this.orthoFrustumSize),this.distance!==void 0&&(t.distance=this.distance),this.minDistance!==void 0&&(t.minDistance=this.minDistance),this.maxDistance!==void 0&&(t.maxDistance=this.maxDistance),this.panPrimary!==void 0&&(t.panPrimary=this.panPrimary),this.noPan!==void 0&&(t.noPan=this.noPan),this.noRotate!==void 0&&(t.noRotate=this.noRotate),this.noPitchRotate!==void 0&&(t.noPitchRotate=this.noPitchRotate),this.minUpAngle!==void 0&&(t.minUpAngle=this.minUpAngle),this.maxUpAngle!==void 0&&(t.maxUpAngle=this.maxUpAngle),this.fov!==void 0&&(t.fov=this.fov),t}};r(br,"eventType",_f),r(br,"_nextViewAutoId",1e3);let Hi=br;const gf=(s,e)=>{const t=s.createRenderTarget(512,512,{format:Be.RGBA8,magFilter:Z.LINEAR,minFilter:Z.LINEAR,stencilBuffer:!1,generateMipmaps:!1}),i={vertexShaderName:"brdf_vertex.glsl",fragmentShaderName:"brdf_fragment.glsl",uniforms:{integrateBrdfNumSamples:{type:"f",value:e}}},n=new as(i),o=new is(s);return o.set(!0,!1,!1),n.render(s,t),o.restore(),n.dispose(),t},bh=["faces16","faces","vertices","normals","transforms"],xh=[...bh,"meshes","bounds","uvs0","uvs1"];class w1{constructor(e,t){r(this,"onProgress");r(this,"onFailure");r(this,"onHaveBuffer");r(this,"highPriorityUvs",!1);r(this,"assetsUrl");r(this,"buffers",{});r(this,"_buffersDone",{});this.assetsUrl=e,this.highPriorityUvs=t!=null?t:this.highPriorityUvs}haveAllBuffers(){return xh.every(e=>this.buffers[e]!==void 0)}haveCoreBuffers(){return bh.every(e=>this.buffers[e]!==void 0)}releaseCoreBuffersExceptTransform(){bh.filter(t=>t!=="transforms").forEach(t=>this.buffers[t]=void 0)}_queueAjaxGetBuffer(e,t){const i=o=>{var a;this.buffers[t]=o,(a=this.onHaveBuffer)==null||a.call(this)},n=o=>{var a;this._buffersDone[t]=o.loaded,(a=this.onProgress)==null||a.call(this)};uo(e,`${this.assetsUrl}${t}.buf`,!0,i,this.onFailure,n,!0)}load(){var i;const e=M.LOAD_PRIORITY.CORE_RESOURCE,t={uvs0:this.highPriorityUvs?e:M.LOAD_PRIORITY.UV0,uvs1:this.highPriorityUvs?e:M.LOAD_PRIORITY.LIGHTMAP};for(const n of xh)this._queueAjaxGetBuffer((i=t[n])!=null?i:e,n)}totalDone(){let e=0;return xh.forEach(t=>{var i;return e+=(i=this._buffersDone[t])!=null?i:0}),e}}const M1=10,vf=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0]),bf=function(s){this.minVerticesUntilTimeCall=s,this.verticesCount=0,this.timer=new yo};bf.prototype.shouldInterrupt=function(s){return this.verticesCount+=s,this.verticesCount>this.minVerticesUntilTimeCall&&this.timer.elapsedMSec()>M1?(this.verticesCount=0,this.timer.reset(),!0):!1};function xf(s,e,t,i,n,o,a){for(let l=0,c=3*t;l<c;l+=3){const h=s[l+e]*n,d=s[l+e+1]*n,u=s[l+e+2]*n;o[a+l]=i[0]*h+i[1]*d+i[2]*u+i[3],o[a+l+1]=i[4]*h+i[5]*d+i[6]*u+i[7],o[a+l+2]=i[8]*h+i[9]*d+i[10]*u+i[11]}}function yf(s,e,t,i,n,o){for(let a=0,l=2*t;a<l;a+=2){let c=(s[a+e]/254+.5)*Math.PI,h=s[a+e+1]*(Math.PI/127);const d=Math.sin(c),u=d*Math.cos(h),m=d*Math.sin(h),g=Math.cos(c),b=i[0]*u+i[1]*m+i[2]*g,x=i[4]*u+i[5]*m+i[6]*g,v=i[8]*u+i[9]*m+i[10]*g;c=(Math.acos(v)/Math.PI-.5)*2,h=Math.atan2(x,b)/Math.PI,n[o+a]=Na(c),n[o+a+1]=Na(h)}}function Al(s){return s.instanceId!==0||s.parent.ownsGpuBuffers===!1}function Af(s,e,t,i,n,o){let a=!1;for(let l=0,c=2*t;l<c;l+=1){const h=s[l+e]*i;n[o+l]=h,(h<0||h>1)&&(a=!0)}return a}function Ef(s,e,t,i,n){let o=!1;for(let a=0,l=2*t;a<l;a+=1){const c=s[a+e];i[n+a]=c,(c<0||c>1)&&(o=!0)}return o}function Tf(s,e,t,i,n,o,a,l,c){for(let h=0,d=2*t;h<d;h+=2){const u=s[h+e],m=s[h+e+1];u!==0||m!==0?(l[c+h]=Math.round(u*i)+o,l[c+h+1]=Math.round(m*n)+a):(l[c+h]=0,l[c+h+1]=0)}}function Sf(s){return s.uv0ByteOffset!==-1}function wf(s){return s.uv1ByteOffset!==-1}function Mf(s){return s.quantVertexRange/s.quantVertexMax}function yh(s){return s.quantUv0Max===0}function Pf(s){return s.quantUv0Range/s.quantUv0Max}function El(s,e,t,i,n,o){const a=new bf(5e4);let l=0,c=0;function h(){for(;l<s.length;){const d=s[l];if(c===0&&!t(d)){l+=1;continue}for(;c<d.logicalMeshes.length;){const u=d.logicalMeshes[c],m=e.get(u);if(i(u,m),c+=1,a.shouldInterrupt(m.vertexCnt)){setTimeout(h,0);return}}n(d),l+=1,c=0}o()}h()}function Cf(s,e){return e.geometry.allocateCoreBuffers(s),!0}function Rf(s){return s.anyLogicalMeshHasUvs?(s.geometry.allocateUv0(),!0):!1}function If(s){return s.lightmap?(s.geometry.allocateUv1(),!0):!1}function P1(s,e,t,i,n){const o=new Uint16Array(s),a=new Float32Array(s);function l(c,h){if(!Sf(h))return;const d=c.geometry;if(Al(d))return;const u=d.vertexOffset,m=d.parent;let g=!1;yh(h)?g=Ef(a,h.uv0ByteOffset/4,h.vertexCnt,m.uvs0,u*2):g=Af(o,h.uv0ByteOffset/2,h.vertexCnt,Pf(h),m.uvs0,u*2),g&&(m.isUvs0Repeating=!0)}El(e,t,Rf,l,i,n)}function Df(s,e,t,i,n){const o=n.instanceId*4,a=n.parent.uvs1Mod;a[o]=t/65535,a[o+1]=i/65535,a[o+2]=s/65535,a[o+3]=e/65535}function C1(s,e,t,i,n,o,a){const l=i?Of(n,s):new Uint16Array(s);function c(h,d){if(!wf(d))return;let u=d.uv1CoordUScale,m=d.uv1CoordVScale,g=d.uv1CoordUOffset,b=d.uv1CoordVOffset;const x=h.geometry;if(x.isInstanced){if(Df(u,m,g,b,x),Al(x))return;u=m=1,g=b=0}const v=x.vertexOffset;Tf(l,d.uv1ByteOffset/2,d.vertexCnt,u,m,g,b,x.parent.uvs1,v*2)}El(e,t,If,c,o,a)}function Lf(s,e){const t=e.parent,i=e.instanceId*4,n=t.transforms0;n[i]=s[0],n[i+1]=s[1],n[i+2]=s[2],n[i+3]=s[3];const o=t.transforms1;o[i]=s[4],o[i+1]=s[5],o[i+2]=s[6],o[i+3]=s[7];const a=t.transforms2;a[i]=s[8],a[i+1]=s[9],a[i+2]=s[10],a[i+3]=s[11]}function R1(s,e,t,i,n,o,a){const l=i?Ff(n,e,t,s.faces):[new Uint16Array(s.faces16),new Uint32Array(s.faces)],c=l[0],h=l[1],d=new Int8Array(s.vertices),u=new Int16Array(s.vertices),m=new Int32Array(s.vertices),g=new Int8Array(s.normals);function b(x,v){const E=x.geometry,w=E.parent;let C=new Float32Array(s.transforms,v.transformByteOffset,16);if(E.isInstanced){if(Lf(C,E),Al(E))return;C=vf}let I,O;switch(ka(v.quantVertexMax)){case 1:I=d,O=v.vertexByteOffset;break;case 2:I=u,O=v.vertexByteOffset/2;break;case 4:I=m,O=v.vertexByteOffset/4;break}const U=E.vertexOffset;xf(I,O,v.vertexCnt,C,Mf(v),w.vertices,U*3),yf(g,v.normalByteOffset,v.vertexCnt,C,w.normals,U*2);const z=w.index;let ie=E.indexOffset,J,re;v.useFaces16?(J=v.faceByteOffset/2,re=c):(J=v.faceByteOffset/4,re=h);for(let Oe=J,We=J+v.faceCnt*3;Oe<We;Oe+=1,ie+=1)z[ie]=re[Oe]+U}El(e,t,Cf.bind(null,!0),b,o,a)}function I1(s){return new Uint8Array(s.buffer,s.byteOffset,s.byteLength)}function Ff(s,e,t,i){let n=[],o=[],a=0,l=0;for(const g of e)for(const b of g.logicalMeshes){const x=t.get(b);if(x.useFaces16){let v=x.faceByteOffset/2;n.push([v,x.faceCnt,x.useFaces16]),a+=x.faceCnt}else{let v=x.faceByteOffset/4;o.push([v,x.faceCnt,x.useFaces16]),l+=x.faceCnt}}const c=(g,b)=>g[0]-b[0];n.sort(c),o.sort(c);let h=a>0?new Uint32Array(a*3):null,d=l>0?new Uint32Array(l*3):null,u=0,m=-1;for(const g of[...n,...o]){const b=g[0],x=g[1],v=g[2];if(m==b||x==0)continue;m=b;const E=new Uint32Array(i.slice(u,u+=4)).at(0),C=I1((v?h:d).subarray(b)),I=new Uint8Array(i).subarray(u,u+=E);s.decodeIndexBuffer(C,x*3,4,I)}return[new Uint16Array(h),d]}function Of(s,e){if(!e)return null;const t=new Uint8Array(e.slice(4)),i=new Uint32Array(e.slice(0,4)).at(0),n=new Uint8Array(i*4);return s.decodeVertexBuffer(n,i,4,t),new Uint16Array(n.buffer)}function D1(s,e,t,i,n,o,a){const l=i?Ff(n,e,t,s.faces):[new Uint16Array(s.faces16),new Uint32Array(s.faces)],c=l[0],h=l[1],d=new Int8Array(s.vertices),u=new Int16Array(s.vertices),m=new Int32Array(s.vertices),g=new Int8Array(s.normals),b=new Uint16Array(s.uvs0),x=new Float32Array(s.uvs0),v=i?Of(n,s.uvs1):new Uint16Array(s.uvs1);function E(C){return Cf(!1,C),Rf(C),If(C),!0}function w(C,I){const O=C.geometry,U=C.geometry.parent;let z=new Float32Array(s.transforms,I.transformByteOffset,16),ie;Sf(I)&&U.uvs0&&(ie=U.uvs0);let J,re,Oe,We,Ve;if(wf(I)&&U.uvs1&&(J=U.uvs1,re=I.uv1CoordUScale,Oe=I.uv1CoordVScale,We=I.uv1CoordUOffset,Ve=I.uv1CoordVOffset),O.isInstanced){if(Lf(z,O),J&&Df(re,Oe,We,Ve,O),Al(O))return;z=vf,re=Oe=1,We=Ve=0}let lt,k;I.useFaces16?(lt=c,k=I.faceByteOffset/2):(lt=h,k=I.faceByteOffset/4);let K,de;switch(ka(I.quantVertexMax)){case 1:K=d,de=I.vertexByteOffset;break;case 2:K=u,de=I.vertexByteOffset/2;break;case 4:K=m,de=I.vertexByteOffset/4;break}let ce;yh(I)?ce=I.uv0ByteOffset/4:ce=I.uv0ByteOffset/2;let Te=C.geometry.vertexOffset*3,pe=C.geometry.vertexOffset*2;const ye=U.vertices,Re=U.normals,he=I.normalByteOffset,je=I.uv1ByteOffset/2;for(let Xe=k,B=k+I.faceCnt*3;Xe<B;Xe+=1,Te+=3,pe+=2){const N=lt[Xe],H=de+N*3;xf(K,H,1,z,Mf(I),ye,Te);const X=he+N*2;if(yf(g,X,1,z,Re,pe),ie){const ve=ce+N*2;let we=!1;yh(I)?we=Ef(x,ve,1,ie,pe):we=Af(b,ve,1,Pf(I),ie,pe),we&&(U.isUvs0Repeating=!0)}if(J){const ve=je+N*2;Tf(v,ve,1,re,Oe,We,Ve,J,pe)}}}El(e,t,E,w,o,a)}class L1{constructor(e,t){r(this,"lightmapCount");r(this,"encoding");r(this,"format");r(this,"thresholds");this.lightmapCount=e;const i=new tn(t);this.encoding=i.parseEnum("encoding",xs,xs.RGBM),this.thresholds=i.parseNumbers("thresholds");const o=i.parseStrings("formats").indexOf("webp")>=0;this.format=o?"webp":"png"}load(e){const t=Z.NEAREST,i=[];for(let n=0;n<this.lightmapCount;n+=1){const o=new qs;o.id=o.name="lightmap-"+this.encoding+n,o.stdExt=this.format,o.encoding=this.encoding,o.alpha=!0,o.webFormats=["large/std"];const a=e.load(o,nn.NONE,M.LOAD_PRIORITY.LIGHTMAP);a.anisotropy=dt.NO_ANISOTROPY,a.magFilter=t,a.minFilter=t,a.ycocgmThreshold=this.thresholds.at(n)||0,a.encoding=this.encoding,i.push(a)}return[this.encoding,i]}}const F1=["cutoutMaskThreshold","doubleSided","name","opacity","materialLibraryHash"],O1=["bumpScale","normalScale","cutoutMode","emissive","emissionStrength","envMapProject","metallic","roughness","alphaInLowerHalf","chromaKeyEnabled"],B1=["baseColor","bumpScale","normalScale",Vi.BUMP,Vi.NORMAL,"doubleSided","emissive","metallic","opacity","roughness"];function Bf(s,e,t){for(let i=0;i<e.length;i+=1){const n=e[i],o=s[n];o!==void 0&&(t["_"+n]=o)}}const Uf=M.LOAD_PRIORITY.DIFFUSE,Tl=M.LOAD_PRIORITY.SPECULARITY,Sl=nn.REPEAT_WRAPPING|nn.GENERATE_MIPS|(M.PUPPETEER_TEST?nn.PAUSE_LOADED_VIDEO:0);class Ah{constructor(e,t,i=!1){r(this,"_textureManager");r(this,"_mergeConfig");r(this,"_textureAtlases");r(this,"_postponeTexLoad");r(this,"_shaders",new Array);r(this,"_shadersVersion",0);this._textureManager=e,this._mergeConfig=t,this._textureAtlases=e.atlases(),this._postponeTexLoad=i}_loadTexture(e,t,i){return this._textureManager.load(e,t,i,!1,this._postponeTexLoad)}getAtlasEntry(e){e instanceof $a||(e=$a.parse(e));const i=this._textureAtlases.get(e.atlasId).getAtlasEntry(e.id,e.name,e.atlasOffset[0],e.atlasOffset[1],e.atlasScale[0],e.atlasScale[1]);return i.rawExt!==void 0&&i.rawExt!==e.rawExt&&console.warn("Atlas entries with not matching rawExt "+e.name),i.rawExt=e.rawExt,i.stdExt!==void 0&&i.stdExt!==e.stdExt&&console.warn("Atlas entries with not matching stdExt "+e.name),i.stdExt=e.stdExt,i.importGpuCompress=e.importGpuCompress!==!1,i.importAutoScale=e.importAutoScale!==!1,i}applyBaseColorTexture(e,t){const i=t.baseColorTexture;if(i){let n;i.atlasId?n=this.getAtlasEntry(i):n=this._loadTexture(i,Sl,Uf),n.isCutout=void 0,e.baseColorTexture=n}}parseTexture(e,t,i,n=Sl,o=Uf){const l=new tn(t).parseObject(i);l&&(e[i]=this._loadTexture(l,n,o))}applyBaseColor(e,t){t.baseColor&&(e.baseColor.fromArray(t.baseColor),e.baseColor.roundChannels())}applyTextureCorrection(e,t,i){const n=i[t+"Correction"];e.loadCorrection(t,n)}applyUvOffsetScaleRotation(e,t){if(t.uvOffsetScale){const i=t.uvOffsetScale;e.setUvOffsetAndScale(i[0],i[1],i[2],i[3])}t.uvRotationDeg&&(e.uvRotationDeg=t.uvRotationDeg)}applyAntiTiling(e,t){const i=t.antiTiling;if(i!==void 0&&(e.antiTilingType=i.antiTilingType,e.antiTilingType==="Regular")){const n=i.antiTilingRegularParameters;for(const o of Object.keys(Kd))e.setAntiTilingRegularParameters(o,n[o])}}applyAttribute(e,t,i){i[e]&&(t[e]=i[e])}applyDoNotImport(e,t){t.doNotImport&&Tc(t.doNotImport,B1,e.doNotImport)}applyChromaKey(e,t){const i=t.chromaKeyColor;i&&(e.chromaKeyColor.fromArray(i),e.chromaKeyColor.roundChannels());const n=t.chromaKeyDelta;n&&e.chromaKeyDelta.fromArray(n)}setGrassMaterialProperties(e,t){return e.name=t.name,this.applyBaseColorTexture(e,t),this.parseTexture(e,t,Vi.HEIGHT),this.applyBaseColor(e,t),this.applyTextureCorrection(e,Vi.BASE_COLOR,t),this.applyAttribute("grassHeight",e,t),this.applyAttribute("grassLayers",e,t),this.applyAttribute("grassDirection",e,t),this.applyUvOffsetScaleRotation(e,t),this.applyAntiTiling(e,t),e}setWaterMaterialProperties(e,t){return e.name=t.name,this.parseTexture(e,t,Vi.NORMAL,nn.REPEAT_WRAPPING,Tl),this.applyBaseColor(e,t),this.applyAttribute("opacity",e,t),Bf(t,["wavesSpeed","wavesScale","refractionFactor"],e),e.setUniforms(),e}hasResidueAfterWaterMaterial(e){return e.wavesSpeed!==void 0&&e.wavesSpeed!==null||e.wavesScale!==void 0&&e.wavesScale!==null}setStandardMaterialProperties(e,t){Tc(t,F1,e),t.reflective!==void 0?e._reflective=t.reflective:e._reflective=!!(t.roughnessTexture||t.roughness!==1),Bf(t,O1,e),this.applyBaseColor(e,t),this.applyTextureCorrection(e,Vi.BASE_COLOR,t),this.applyBaseColorTexture(e,t);for(const i of[Vi.ROUGHNESS,Vi.METALLIC,Vi.BUMP])this.parseTexture(e,t,i,Sl,Tl),this.applyTextureCorrection(e,i,t);return this.hasResidueAfterWaterMaterial(t)||(this.parseTexture(e,t,Vi.NORMAL,Sl,Tl),this.applyTextureCorrection(e,Vi.NORMAL,t)),this.applyDoNotImport(e,t),this.applyChromaKey(e,t),this.applyUvOffsetScaleRotation(e,t),this.applyAntiTiling(e,t),e}setUniversalMaterialProperties(e,t){this.setStandardMaterialProperties(e,t);const i=new tn(t);for(let o=0;o<8;o++){const a=i.parseObject(`texture${o}`);a&&(e.textures[o]=this._loadTexture(a,nn.REPEAT_WRAPPING|nn.GENERATE_MIPS,Tl))}const n=i.parseNumber("shaderId",-1);if(n>=0&&n<this._shaders.length&&(e.customShader=this._shaders[n]),e.customShaderVersion=this._shadersVersion,t.uniforms){const o=t.uniforms;for(const a of o)e.uniformVectors.push(new tt(a[0],a[1],a[2],a[3]))}if(e.alphaMode=i.parseNumber("alphaMode",0),e.usesTexCoords=i.parseBoolean("usesTexCoords",!1),e.clearcoatUnused=i.parseBoolean("clearcoatUnused",!1),e.sheenUnused=i.parseBoolean("sheenUnused",!1),e.customShaderVersion==0&&(e.usesTexCoords=e.textures.length>0),!e.customShader){e.clearcoat=i.parseNumber("clearcoat",0),e.clearcoatRoughness=i.parseNumber("clearcoatRoughness",0);const o=i.parseNumbers("sheenColor");o.length==3&&(e.sheenColor=o),e.sheenRoughness=i.parseNumber("sheenRoughness",0);const a=i.parseNumbers("specularColor");a.length==3&&(e.specularColor=a),e.specular=i.parseNumber("specular",1)}return e.configureTransparency(),e.setUniforms(),e}setMaterialFromJson(e,t){switch(e.type){case Tn.UNIVERSAL:return this.setUniversalMaterialProperties(e,t);case Tn.GRASS:return this.setGrassMaterialProperties(e,t);case Tn.WATER:return this.setWaterMaterialProperties(e,t);default:return this.setStandardMaterialProperties(e,t)}}_createMaterial(e,t){Es.WEBWALK;const i=Vc(e.type,t);return this.setMaterialFromJson(i,e)}getMaterial(e,t){return e===void 0?Vc(Tn.STANDARD,t):this._createMaterial(e,t)}load(e,t){var d,u,m;const i=(d=e.materials)!=null?d:[];this._shaders=((u=e.shaders)!=null?u:[]).map(g=>ln.makeInline(g)),this._shadersVersion=(m=e.shadersVersion)!=null?m:0;const n=e.formatVersion,o=new Map;let a=0;const l=g=>{if(this._mergeConfig.isMaterialEditable(g.name))return g;const b=g.hash(),x=o.get(b)||[];for(const v of x)if(v.canMerge(g)){a+=1,v.merged=!0,g=v;break}return g.merged||(x.push(g),o.set(b,x)),g},h=i.some(g=>g.id===void 0)||n==="1.5.0";i.forEach((g,b)=>{var I;const x=(I=g.source)!=null?I:Es.SCENE,v=this._createMaterial(g,x);let E=g.id;h&&(E=b);const w=v,C=l(v);w===C?(C.merged,t.addMaterial(C,E),v.setUniforms()):(C.merged,t.addMergedMaterial(w,E,C))}),a>0&&Me.log(`Merged ${i.length} materials down to ${i.length-a}.`)}}const U1=500;class N1{constructor(e,t,i,n,o){r(this,"nodeId");r(this,"materialId");r(this,"useFaces16");r(this,"faceByteOffset");r(this,"faceCnt");r(this,"vertexByteOffset");r(this,"vertexCnt");r(this,"normalByteOffset");r(this,"uv0ByteOffset");r(this,"uv1ByteOffset");r(this,"lightmapIdx");r(this,"uv1CoordUScale");r(this,"uv1CoordVScale");r(this,"uv1CoordUOffset");r(this,"uv1CoordVOffset");r(this,"transformByteOffset");r(this,"boundsByteOffset");r(this,"quantVertexRange");r(this,"quantVertexMax");r(this,"quantUv0Range");r(this,"quantUv0Max");r(this,"autoLightmapResolution");r(this,"useInstances",!1);r(this,"hasCopies",!1);r(this,"isMasterCopy",!1);r(this,"boundingBox",new ti);r(this,"boundingSphere",new Fn);this.nodeId=e[n],this.materialId=e[n+1],this.useFaces16=e[n+2]===1,this.faceByteOffset=e[n+3],this.faceCnt=e[n+4],this.vertexByteOffset=e[n+5],this.vertexCnt=e[n+6],this.normalByteOffset=e[n+7],this.uv0ByteOffset=e[n+8],this.uv1ByteOffset=e[n+9],this.lightmapIdx=e[n+10],this.uv1CoordUScale=t[n+11],this.uv1CoordVScale=t[n+12],this.uv1CoordUOffset=e[n+13],this.uv1CoordVOffset=e[n+14],this.transformByteOffset=e[n+15],this.boundsByteOffset=e[n+16],this.quantVertexRange=t[n+17],this.quantVertexMax=e[n+18],this.quantUv0Range=t[n+19],this.quantUv0Max=e[n+20],this.autoLightmapResolution=o>=2?e[n+21]:-1,this.useInstances=!1,this.hasCopies=!1,this.isMasterCopy=!1,this._parseBounds(i)}_parseBounds(e){const t=this.boundsByteOffset/4;e.subarray(t,t+6).some(i=>!isFinite(i))||(this.boundingBox.max.x=e[t],this.boundingBox.max.y=e[t+1],this.boundingBox.max.z=e[t+2],this.boundingBox.min.x=e[t+3],this.boundingBox.min.y=e[t+4],this.boundingBox.min.z=e[t+5],this.boundingBox.center(this.boundingSphere.center),this.boundingSphere.radius=e[t+6])}uv0Needed(){return this.uv0ByteOffset!==-1}getSharedGeometryId(){return this.useInstances?this.vertexByteOffset:void 0}}class Nf{constructor(e,t,i,n,o,a){r(this,"meshPropsSet",new Set);r(this,"material");r(this,"lightmap");r(this,"lightProbes");r(this,"anyLogicalMeshHasUvs");r(this,"sharedGeometryId");r(this,"hideInViews");r(this,"editableRootNode");this.meshPropsSet.add(e),this.material=t,this.lightmap=i,this.lightProbes=n,this.hideInViews=o,this.editableRootNode=a,this.anyLogicalMeshHasUvs=e.uv0Needed(),this.sharedGeometryId=e.getSharedGeometryId()}canUseLightmap(e){return this.lightmap===null||e===null||this.lightmap===e}}function k1(s,e,t){let i,n,o,a;t?(i=s.faceCnt*3,n=s.vertexCnt):(i=0,n=s.faceCnt*3),e.isInstanced?(o=0,a=0):(o=e.indexCnt,a=e.vertexCnt);const l=new cl(i,n,e,o,a,s.boundingBox,s.boundingSphere);return e.boundingBox.union(s.boundingBox),Fn.union(s.boundingSphere,e.boundingSphere),e.isInstanced?(l.instanceId=e.instanceCount,e.instanceCount+=1,e.indexCnt=i,e.vertexCnt=n):(e.indexCnt+=i,e.vertexCnt+=n),l}class z1{constructor(e,t,i,n){r(this,"_scene");r(this,"_useIndexedGeometry");r(this,"_logicalMeshesCount",0);r(this,"_totalVertexCount",0);r(this,"_totalFaceCount",0);r(this,"_meshesBufferLength");r(this,"_allMeshProps",new Array);r(this,"mergedMeshes",new Array);r(this,"meshToProps",new Map);r(this,"coreGeometryDownloadSize",0);r(this,"geometryDownloadSize",0);r(this,"lightmapCount",0);r(this,"encodedUsingMeshOpt",!1);this._scene=e,this._useIndexedGeometry=n,this._meshesBufferLength=t.byteLength,this._parseMeshesBuffer(t,i),this._computeGeometrySizeInfo(),Me.log(`Have  ${this._totalVertexCount} vertices, ${this._totalFaceCount} faces and ${this.lightmapCount} lightmaps.`)}_parseMeshesBuffer(e,t){const i=new Int32Array(e),n=new Float32Array(e),o=new Float32Array(t),a={},l=i[0];this.encodedUsingMeshOpt=l>=3;const c=i[1];for(let h=2;h<i.length;h+=c){const d=new N1(i,n,o,h,l);this.lightmapCount=Math.max(this.lightmapCount,d.lightmapIdx+1);const u=d.vertexByteOffset;if(!Object.hasOwn(a,u))a[u]=[d];else{const m=a[u],g=m[0];g.isMasterCopy=!0,g.hasCopies=!0,d.hasCopies=!0,m.push(d)}this._allMeshProps.push(d)}for(const h of Object.values(a))(h.length-1)*h[0].faceCnt>U1&&h.forEach(m=>m.useInstances=!0)}_computeGeometrySizeInfo(){const e=h=>h+3&-4;let t=0,i=0,n=0,o=0,a=0,l=0,c=0;for(const h of this._allMeshProps){const d=h.vertexCnt;this._totalVertexCount+=d,this._totalFaceCount+=h.faceCnt,t=Math.max(t,h.faceByteOffset+h.faceCnt*3*(h.useFaces16?2:4)),i=Math.max(i,e(h.vertexByteOffset+d*3*ka(h.quantVertexMax))),n=Math.max(n,h.normalByteOffset+d*2),o=Math.max(o,h.transformByteOffset+16*4),a=Math.max(a,h.boundsByteOffset+7*4),h.uv0ByteOffset!==-1&&(l=Math.max(l,e(h.uv0ByteOffset+d*2*ka(h.quantVertexMax)))),h.uv1ByteOffset!==-1&&(c=Math.max(c,h.uv1ByteOffset+d*2*2))}this.coreGeometryDownloadSize=this._meshesBufferLength+t+i+n+o+a,this.geometryDownloadSize+=this.coreGeometryDownloadSize+l+c}_createLogicalMesh(e,t,i,n){const o=new Bn(e,t,i.material);return o.lightmap=i.lightmap,o.lightProbes=i.lightProbes,o.autoLightmapResolution=n.autoLightmapResolution,this.meshToProps.set(o,n),o.lightmapIdx=n.lightmapIdx,n.hasCopies&&M.DEBUG_SHARED_BUFFERS&&(o.sharedBuffersDebug=n.isMasterCopy?1:2),this._logicalMeshesCount+=1,i.addLogicalMesh(o),o}_assignMeshesToGroups(e){const t=new Array,i=new Map,n=o=>{var E;const a=this._scene.findNode(o.nodeId),l=(E=M.EDIT_MODE?void 0:a.config.overriddenMaterialId)!=null?E:o.materialId,c=this._scene.materialManager.getMaterial(l);let h=new Array;a.initialLightProbeIds!==null&&(h=this._scene.findLightProbes(a.initialLightProbeIds));let d=null;o.lightmapIdx!==-1&&(d=e[o.lightmapIdx]);const u=a.hideInViews||[],m=a.editableRoot;let g=a.editable||c.transparent;if(c.reflective&&c.roughness<.2&&(g=!0),g){t.push(new Nf(o,c,d,h,u,m));return}const b=o.getSharedGeometryId(),x=i.get(c)||[];for(const w of x)if(Va(w.lightProbes,h)&&w.editableRootNode===m&&w.canUseLightmap(d)&&w.sharedGeometryId===b&&Va(w.hideInViews,u)){d!==null&&(w.lightmap=d),w.anyLogicalMeshHasUvs=w.anyLogicalMeshHasUvs||o.uv0Needed(),w.meshPropsSet.add(o);return}const v=new Nf(o,c,d,h,u,m);x.push(v),i.set(c,x),t.push(v)};return this._allMeshProps.forEach(n),t}createMeshes(e){const t=e?e[0]:null,i=this._assignMeshesToGroups(e),n={};for(const o of i){let a;const l=o.sharedGeometryId;if(l!==void 0){let h=n[l],d=!1;h||(h=new Jo,d=!0,n[l]=h),a=new ll(h,d)}else a=new Jo;const c=new nl(a,o.material);c.lightProbes=o.lightProbes,c.lightmap=o.lightmap||t,c.hideInViews=o.hideInViews,c.anyLogicalMeshHasUvs=o.anyLogicalMeshHasUvs,c.editableRootNode=o.editableRootNode,this.mergedMeshes.push(c);for(const h of o.meshPropsSet){const d=k1(h,a,this._useIndexedGeometry),u=this._scene.findNode(h.nodeId);u.mesh=this._createLogicalMesh(u,d,c,h),u.mesh.originalMaterialId=h.materialId}}Me.log(`Have ${this._logicalMeshesCount} meshes and ${this.mergedMeshes.length} merged meshes.`)}}const kf=512*1024,zf=12*1024*1024;function V1(s,e,t,i,n,o){const a=!t,l=!t&&!M.DEBUG_SHARED_BUFFERS,c=new yo;this.onProgress=null,this.onMeshBuffersLoaded=null,this.onReadyToDisplay=null,this.onComplete=null,this.panoramas=[],this.load=function(){ri.createNewProfileFrame({name:"Webwalk init",log:!0}),ri.beginSection("SceneLoader.load");const h=this;let d=null,u=null,m=!1,g=!1,b=!1,x,v=null,E=!1,w=!1,C=!M.NO_COLLISIONS,I={total:void 0,texturesDone:0,totalDone:function(){return this.texturesDone+d.totalDone()}};function O(){I.total&&h.onProgress(I.totalDone()/I.total)}function U(){g||(g=!0,h.onReadyToDisplay(s))}function z(){!b||!m||C&&!w||n.loadingProgress().isFinished()&&(n.freeLoadingBuffers(),n.onTextureLoaded=void 0,d=u=null,s.sharedMaterialState.clearDefaultLightmaps(),Ga(()=>{U(),h.onComplete(s)}))}function ie(he){he.geometry.addUv1Attribute(),h.onMeshBuffersLoaded(he)}function J(){d.buffers.uvs1&&(x=z,C1(d.buffers.uvs1,u.mergedMeshes,u.meshToProps,u.encodedUsingMeshOpt,ts,ie,function(){d.buffers.uvs1=null,b=!0,x()}))}function re(he){he.geometry.isUvs0Repeating&&he.material.ensureTexturesRepeatable(),he.geometry.addUv0Attribute(),h.onMeshBuffersLoaded(he)}function Oe(){d.buffers.uvs0&&(x=J,P1(d.buffers.uvs0,u.mergedMeshes,u.meshToProps,re,function(){d.buffers.uvs0=null,x()}))}function We(){var he;(he=v.views)==null||he.forEach(je=>s.addView(new Hi(je,s.center))),s.createDefaultViews()}function Ve(){if(m=!0,We(),!t&&!s.disableProgressiveLoader&&!M.PUPPETEER_TEST){const je=1e3*M.PROGRESSIVE_LOADER_AFTER_SEC-c.elapsedMSec();je<=0?U():setTimeout(U,je)}x()}function lt(he){M.DEV_NEW_SCENE||s.addGpuMesh(he)}function k(he){he.geometry.addCoreAttributes();const je=he.logicalMeshes;console.assert(!je[0].node.editable||je.length===1),je[0].node.editable||!l?je.forEach(lt):lt(he),h.onMeshBuffersLoaded(he)}function K(he){he.geometry.isUvs0Repeating&&he.material.ensureTexturesRepeatable(),he.geometry.uvs0&&he.geometry.addUv0Attribute(),he.geometry.uvs1&&he.geometry.addUv1Attribute(),k(he)}function de(){if(a){if(!d.haveCoreBuffers())return;Me.log("Using indexed geometry"),x=Oe,R1(d.buffers,u.mergedMeshes,u.meshToProps,u.encodedUsingMeshOpt,ts,k,Ve)}else{if(!d.haveAllBuffers())return;x=z,D1(d.buffers,u.mergedMeshes,u.meshToProps,u.encodedUsingMeshOpt,ts,K,()=>{b=!0,Ve()})}d==null||d.releaseCoreBuffersExceptTransform()}function ce(){ts.ready.then(()=>{E=!0,x()})}function Te(){var he,je;v&&(x=pe,v.autoAddLightProbes!==void 0&&(s.autoAddLightProbes=v.autoAddLightProbes),s.disableProgressiveLoader=v.disableProgressiveLoader||!1,v.interactionPrompt&&(s.interactionPrompt=v.interactionPrompt),v.autoTour!==void 0&&(s.autoTour.disabled=v.autoTour.disabled||!1,s.autoTour.startOnLoad=v.autoTour.startOnLoad||!1),s.lightManager.load(v),M.NO_REFLECTION_PROBES||(he=v.lightProbes)==null||he.forEach(Xe=>s.addLightProbe(new Mi(Xe,M.NO_REFLECTION_PROBE_BOXES))),s.camera.setFromJson(v.camera),(je=v.cameraVolumes)==null||je.forEach(Xe=>s.addCameraAdjustmentVolume(new kh(Xe,s.camera,s.exposureController))),s.addNodeConfigsFromJson(v,i),s.addNodesFromJson(v),x())}function pe(){var B;if(!v||!d.buffers.meshes||!d.buffers.bounds||!E)return;x=de,(B=v.camera)!=null&&B.lutTexture&&(s.camera.colorMap=n.loadColorMap(v.camera.lutTexture)),n.loadAtlases(v.atlases||[]),new Ah(n,i).load(v,s.materialManager),s.lightmapLayoutVersion=v.lightmap?v.lightmap.lightmapLayoutVersion:0,s.lightmapLayoutVersion=s.lightmapLayoutVersion||0;const je=new Vh(n);if(je.load(v.skies||[],s),M.EDIT_MODE){const N={id:"builtin-sky",name:"Builtin Sky",webFormats:["webp"],url:ii("img/mirrored_hall_512x256.webp")};s.sharedMaterialState.builtinSkyMesh=je.loadSingleSky({name:"builtin-sky",type:Cs.EQUIRECT,texture:N},new Ir)}s.findSkyMesh(M.EDITOR_CONTROLLED_SKY_NAME)===null&&console.error("A sky with name "+M.EDITOR_CONTROLLED_SKY_NAME+" is missing."),u=new z1(s,d.buffers.meshes,d.buffers.bounds,a);let Xe=null;if(u.lightmapCount!==0){let N=new L1(u.lightmapCount,v.lightmap),H;[H,Xe]=N.load(n),s.setLightmapEncoding(H),N=null}if(u.createMeshes(Xe),M.EDIT_MODE&&s.materialManager.initializeMaterialOverrides(s.nodeConfigs),I.total=u.geometryDownloadSize+(n.loadingProgress().totalResources-u.lightmapCount)*kf+u.lightmapCount*zf,v.panoramas&&(h.panoramas=v.panoramas),s.minimapConfig=new Wr(v,s.boundingBox),!M.NO_BRDFLUT&&!Qe.isLongShaderExecutionProblematicDevice()){const N=Qe.ios?512:2048,H=gf(o,N);s.addBrdfLUT(H)}n.onTextureLoaded=N=>{I.texturesDone+=N.name.indexOf("lightmap-")===0?zf:kf,O(),x()},x()}function ye(he){v=he,x()}c.reset(),C&&R_().then(()=>{w=!0,x()}),x=Te;const Re=()=>Gt.sceneLoadError();uo(M.LOAD_PRIORITY.CORE_RESOURCE,e+"scene.json",!1,ye,Re),d=new w1(e,!a),d.onProgress=O,d.onFailure=Re,d.onHaveBuffer=function(){x()},d.load(),ce()},this.elapsedLoadTimeSec=function(){return c.elapsedSec()}}const Vf=M.DEBUG;class wl{constructor(e){r(this,"_renderer");r(this,"_renderTargets");r(this,"_mapUvStep",new Ce);r(this,"_mapUvOffsetScale",new tt);r(this,"_mapUvScale",new Ce);r(this,"_alphaStatsPass",wl._constructAlphaPass(this._mapUvStep,this._mapUvOffsetScale));r(this,"_alphaStatsCombinePass",wl._constructCombinePass(this._mapUvScale,this._mapUvStep));r(this,"_resultBuf",new Uint8Array(4*1024));r(this,"_debugTimer",Vf?new yo:void 0);this._renderer=e;const t={magFilter:Z.NEAREST,minFilter:Z.NEAREST,stencilBuffer:!1,depthBuffer:!1,generateMipmaps:!1};this._renderTargets=[this._renderer.createRenderTarget(1024,1024,t),this._renderer.createRenderTarget(512,512,t)]}static _constructCombinePass(e,t){const i={uniforms:{map:{type:"t",value:null},mapUvStep:{type:"v2",value:null},mapUvScale:{type:"v2",value:null}},vertexShaderName:"alpha_stats_vertex.glsl",fragmentShaderName:"alpha_stats_combine_fragment.glsl"},n=new as(i,"map");return n.material.depthTest=!1,n.material.depthWrite=!1,n.uniforms.mapUvScale.value=e,n.uniforms.mapUvStep.value=t,n}static _constructAlphaPass(e,t){const i={uniforms:{map:{type:"t",value:null},mapUvStep:{type:"v2",value:null},mapUvOffsetScale:{type:"v4",value:null}},vertexShaderName:"alpha_stats_vertex.glsl",fragmentShaderName:"alpha_stats_fragment.glsl"},n=new as(i,"map");return n.material.depthTest=!1,n.material.depthWrite=!1,n.uniforms.mapUvStep.value=e,n.uniforms.mapUvOffsetScale.value=t,n}detect(e){var E;const t=e instanceof Za;let i,n,o,a,l;if(t?(i=e.parentTexture,n=e.uvOffsetScale.x,o=e.uvOffsetScale.y,a=e.uvOffsetScale.z,l=e.uvOffsetScale.w):(i=e,n=o=0,a=l=1),!i.hasAlpha||i instanceof Yo){e.isCutout=!1;return}(E=this._debugTimer)==null||E.reset(),this._renderer.enableScissorTest(!0);const c=i.width*a,h=i.height*l;this._mapUvStep.set(1/c,1/h),this._mapUvOffsetScale.set(n,o,a,l);let d=Math.max(Math.floor(c/2),1),u=Math.max(Math.floor(h/2),1);this._renderer.setRenderTarget(this._renderTargets[0]),this._renderer.setViewport(0,0,d,u),this._renderer.setScissor(0,0,d,u),this._alphaStatsPass.render(this._renderer,this._renderTargets[0],i);let m=1,g=this._renderTargets[0];for(;d!==1&&u!==1;){this._mapUvStep.set(1/g.width,1/g.height),this._mapUvScale.set(d/g.width,u/g.height),d=Math.floor(d/2),u=Math.floor(u/2);const w=this._renderTargets[m];this._renderer.setRenderTarget(w),this._renderer.setViewport(0,0,d,u),this._renderer.setScissor(0,0,d,u),this._alphaStatsCombinePass.render(this._renderer,w,g),g=w,m=(m+1)%2}this._renderer.readPixels(d,u,this._resultBuf);let b=0,x=0;const v=Math.max(d,u);for(let w=0;w<v;++w)b+=this._resultBuf[4*w],x+=this._resultBuf[4*w+1];if(b=100*b/(255*v),x=100*x/(255*v),e.isCutout=b<20||x>50,Vf){this._debugTimer;let w="";t&&(w+=`From atlas: ${i.name} [${n}, ${o}, ${a}, ${l}]
`),console.log(`${e.name} ${i.width}x${i.height}
${w}Is cutout: ${e.isCutout}
Partialy transparent regions: ${b}%
Fully transparent pixels: ${x}%
Time: ${this._debugTimer.elapsedSec()}
`)}this._renderer.enableScissorTest(!1)}dispose(){this._renderTargets[0].dispose(),this._renderTargets[1].dispose(),this._alphaStatsPass.dispose(),this._alphaStatsCombinePass.dispose()}}const Eh=512*1024;class G1{constructor(e,t){r(this,"onTextureLoaded");r(this,"_renderer");r(this,"_textureLoader");r(this,"_cutoutDetector");r(this,"_loadingProgress",new zh);r(this,"_textures",new Array);r(this,"_idToTexture",new Map);r(this,"_atlases",new Map);r(this,"_onLoadSuccess",e=>{this._addToProgress(e),this._renderer.uploadTexture(e),e.isAtlas()?e.forEachAtlasEntry(t=>{console.assert(t.isCutout===void 0),this._detectCutout(t)}):e.isCutout===void 0&&this._detectCutout(e)});r(this,"_onLoadFailed",e=>{this._addToProgress(e);const t=`Failed to load texture <i>${this._textureLoader.getTexturePath(e)}</i><br><hr><ul><li>The server may be misconfigured for this type of file.</li><li>The ad blocker in your browser may be incorrectly classifying the texture as an ad banner.</li></ul>`;Gt.sceneLoadError(t)});r(this,"_onLoadFailedSoft",e=>{this._addToProgress(e),Gt.info("Failed to load texture")});r(this,"_onVideoLoadFailed",e=>{this._addToProgress(e),console.warn("Failed to load video texture")});this._renderer=t,this._textureLoader=new ox(e,Qe,this._onLoadSuccess,this._onLoadFailed,this._onLoadFailedSoft,this._onVideoLoadFailed)}_addToProgress(e){var t;this._loadingProgress.loadedBytes+=Eh,this._loadingProgress.loadedResources++,(t=this.onTextureLoaded)==null||t.call(this,e)}_detectCutout(e){this._cutoutDetector||(this._cutoutDetector=new wl(this._renderer)),e.isCutout===void 0&&this._cutoutDetector.detect(e)}remove(e){const t=this._idToTexture.get(e);if(t===void 0)return!1;delete this._textures[t],this._idToTexture.delete(e)}findTexture(e){const t=this._idToTexture.get(e);if(t===void 0)return;const i=this._textures[t],n=i==null?void 0:i.deref();if(!(n!=null&&n.isDisposed()))return n;delete this._textures[t],this._idToTexture.delete(e)}load(e,t=nn.DEFAULT,i=0,n=!1,o=!1){e instanceof qs||(e=qs.parse(e)),Pe(e.id);let a=this.findTexture(e.id);if(a===void 0){a=e.video?new Yo:new dt,a.initFromJson(e,t);const l=this._textures.length;this._textures.push(new WeakRef(a)),this._idToTexture.set(e.id,l),o?a.loadingStatus=ys.POSTPONED:(this._textureLoader.load(a,i,n),this._loadingProgress.totalBytes+=Eh,this._loadingProgress.totalResources++)}else!o&&a.loadingStatus===ys.POSTPONED&&(this._textureLoader.load(a,i,n),this._loadingProgress.totalBytes+=Eh,this._loadingProgress.totalResources++);return a}loadPostponed(e,t=0,i=!1){for(const n of e){const o=this.findTexture(n);o!==void 0&&o.loadingStatus===ys.POSTPONED&&this._textureLoader.load(o,t,i)}}loadColorMap(e){const t=this.load(e,nn.NONE,M.LOAD_PRIORITY.COLORMAP);return t.anisotropy=dt.NO_ANISOTROPY,t.flipY=!1,t}atlases(){return this._atlases}loadAtlases(e){if(e.length!==0)for(const t of e){const i=qs.parse(t),n=this.load(i,nn.DEFAULT,M.LOAD_PRIORITY.DIFFUSE);n.flipY=!1,n.enableAtlas(),Pe(typeof i.id=="string"),this._atlases.set(i.id,n)}}loadingProgress(){return this._loadingProgress}freeLoadingBuffers(){this._cutoutDetector=void 0}}const Gf=1024*1024,jr=Math.round,Wi=jr(window.devicePixelRatio||1),Th=100*Wi,Hf=48*Wi,Wf=3*Wi,jf=2*Wi,or=3*Wi,Eo=15*Wi,rr=94*Wi,ar=30*Wi;let Xf=0,Sh=0;function H1(s){var e;if(M.LOG_FPS){const t=(e=M.LOG_FPS_SKIP_INITIAL_SEC)!=null?e:10;if(Sh++,Sh>t){Xf+=s;const i=Xf/(Sh-t);Me.log(`Fps:${s} Average Fps:${i}`)}}}class Xr{constructor(e,t,i){r(this,"name");r(this,"min",1/0);r(this,"fg");r(this,"bg");r(this,"max",0);r(this,"canvas");r(this,"context");r(this,"dom");this.name=e,this.min=1/0,this.fg=t,this.bg=i,this.canvas=document.createElement("canvas"),this.canvas.width=Th,this.canvas.height=Hf,this.canvas.style.cssText="width:100px;height:48px",this.context=this.canvas.getContext("2d"),this.context.font="bold "+9*Wi+"px Helvetica,Arial,sans-serif",this.context.textBaseline="top",this.context.fillStyle=this.bg,this.context.fillRect(0,0,Th,Hf),this.context.fillStyle=this.fg,this.context.fillText(this.name,Wf,jf),this.context.fillRect(or,Eo,rr,ar),this.context.fillStyle=this.bg,this.context.globalAlpha=.9,this.context.fillRect(or,Eo,rr,ar),this.dom=this.canvas}update(e,t){this.min=Math.min(this.min,e),this.max=Math.max(this.max,e),this.context.fillStyle=this.bg,this.context.globalAlpha=1,this.context.fillRect(0,0,Th,Eo),this.context.fillStyle=this.fg,this.context.fillText(jr(e)+" "+this.name+" ("+jr(this.min)+"-"+jr(this.max)+")",Wf,jf),this.context.drawImage(this.canvas,or+Wi,Eo,rr-Wi,ar,or,Eo,rr-Wi,ar),this.context.fillRect(or+rr-Wi,Eo,Wi,ar),this.context.fillStyle=this.bg,this.context.globalAlpha=.9,this.context.fillRect(or+rr-Wi,Eo,Wi,jr((1-e/t)*ar))}}class W1{constructor(){r(this,"frames");r(this,"mode");r(this,"memPanel");r(this,"beginTime");r(this,"prevTime");r(this,"fpsPanel");r(this,"msPanel");r(this,"performance");r(this,"container",document.createElement("div"));r(this,"dom");this.mode=0,this.performance=performance,this.container.style.cssText="position:fixed;top:0;left:0;cursor:pointer;opacity:0.9;z-index:10000",this.container.addEventListener("click",e=>{e.preventDefault(),this.showPanel(++this.mode%this.container.children.length)},!1),this.beginTime=(performance||Date).now(),this.prevTime=this.beginTime,this.frames=0,this.fpsPanel=this.addPanel(new Xr("FPS","#0ff","#002")),this.msPanel=this.addPanel(new Xr("MS","#0f0","#020")),this.performance&&this.performance.memory&&(this.memPanel=this.addPanel(new Xr("MB","#f08","#201"))),this.showPanel(0),this.dom=this.container}update(){this.beginTime=this.end()}begin(){this.beginTime=(performance||Date).now()}end(){this.frames++;const e=(performance||Date).now();if(this.msPanel.update(e-this.beginTime,200),e>=this.prevTime+1e3){const t=this.frames*1e3/(e-this.prevTime);if(this.fpsPanel.update(t,100),H1(t),this.prevTime=e,this.frames=0,this.memPanel){const i=this.performance.memory;this.memPanel.update(i.usedJSHeapSize/Gf,i.jsHeapSizeLimit/Gf)}}return e}addPanel(e){return this.container.appendChild(e.dom),e}showPanel(e){for(let t=0;t<this.container.children.length;t++)this.container.children[t].style.display=t===e?"block":"none";this.mode=e}}class j1{constructor(e){r(this,"stats",new W1);r(this,"perf");r(this,"ms");r(this,"fps");this.stats.showPanel(0),M.BENCHMARK&&(this.perf=new Yg(e,M.BENCHMARK),this.ms=this.stats.addPanel(new Xr("RenderMS","#ff8","#221")),this.fps=this.stats.addPanel(new Xr("ApproxFPS","#ff8","#221"))),document.body.appendChild(this.stats.dom)}begin(){M.BENCHMARK&&(this.perf,this.perf.begin()),this.stats.begin()}end(){M.BENCHMARK&&(this.perf&&this.ms&&this.fps,this.perf.end(),this.ms.update(this.perf.lastMS,100),this.fps.update(this.perf.lastFPS,100)),this.stats.end()}}/*!
 * Copyright (C) 2015-present unreal engine
 */function wh(s,e){Array.from(document.getElementsByClassName(s)).forEach(e)}function X1(s){const e=new Array;wh(s,function(t){e.push(t)});for(const t of e)t.classList.remove(s)}function dn(s,e){s.style.display=e?"":"none"}function hs(s,e){dn(mt(s),e)}function Ml(s,e){wh(s,t=>{dn(t,e)})}function qf(s){dn(s,!0),s.style.opacity="0",Ga(function(){s.style.opacity="1"})}function q1(){let s=document.getElementById("qr-code-canvas");if(s){s.remove();return}s=document.createElement("canvas"),s.setAttribute("id","qr-code-canvas"),document.body.appendChild(s),QRCode.toCanvas(s,window.location.toString())}function Mh(s){s.style.opacity="0";const e=window.getComputedStyle(s).transitionDuration;if(e){let t=parseFloat(e);e.indexOf("ms")===-1&&(t*=1e3),setTimeout(function(){dn(s,!1),s.style.opacity="1.0"},t)}else dn(s,!1),s.style.opacity="1.0"}var Yf=(s=>(s.VISIBILITY_CHANGED="menuVisibilityChanged",s))(Yf||{});const xa=class xa extends ei{constructor(t,i,n,o,a,l=!0){super();r(this,"cover");r(this,"_editMode");r(this,"_gamepadManager");r(this,"_toggleVr");r(this,"_toggleFullScreen");r(this,"_togglePointerLock");r(this,"_scene");r(this,"_teleport");r(this,"_autoTour");r(this,"_screenshotTaker");r(this,"_vrSupported",!1);r(this,"_fullScreenSupported",!1);r(this,"_pointerLockSupported",!1);r(this,"_pointerLockEnabled",!1);r(this,"_vrEnabled",!1);r(this,"_showMenuSetting");r(this,"_showHelpSetting",!1);r(this,"_advancedDesktopHelp",!1);r(this,"_forceInfoTextTimer");r(this,"_interactionPrompt",!1);this._editMode=t,this._gamepadManager=i,this._toggleVr=n,this._toggleFullScreen=o,this._togglePointerLock=a,this._showMenuSetting=l}_visibleViews(){return this._scene?this._scene.visibleViews():[]}_findViewByIdx(t){const i=this._visibleViews();if(i.length>t)return i[t]}_findUiView(t){if(!t)return;const n=this._visibleViews().findIndex(a=>a===t);return n===-1?void 0:mt("view-list-items").children[n]}_removeUiViewHighlight(t){return()=>{t.classList.remove("active-view"),t.classList.remove("next-active-view")}}_removeAllUiViewsHighlight(){const t=Array.from(mt("view-list-items").children);for(const i of t)i.classList.remove("active-view"),i.classList.remove("next-active-view")}_onTourStarted(){mt("tour-button").classList.add("tour-on")}_onTourStopped(){mt("tour-button").classList.remove("tour-on"),this._removeAllUiViewsHighlight()}_toggleAutoTour(){this._autoTour.isRunning()?this._autoTour.stop():this._autoTour.start()}_stopAutoTour(){return this._autoTour.isRunning()?(this._autoTour.stop(),!0):!1}_onTeleportStarted(t){this._removeAllUiViewsHighlight();const i=this._findUiView(t.view);i&&i.classList.add("next-active-view")}_onTeleportDone(t){const i=this._findUiView(t.view);i&&(i.classList.remove("next-active-view"),i.classList.add("active-view"),setTimeout(this._removeUiViewHighlight(i),M.AUTO_TOUR_IN_VIEW_STILL_TIME_MS))}_viewClicked(t){return Ru(()=>{const i=this._stopAutoTour();this._teleport.switchToView(t,i?0:void 0)})}_fillCover(){Pe(this.cover);const t=this.cover.title,i=this.cover.author,n=this.cover.authorHref,o=this.cover.engineLogoOn,a=this.cover.engineLogoText,l=this.cover.engineLogoUrl;let c=this.cover.authorLogoUrl;this.cover.authorLogo&&(c=wr(this.cover.authorLogo.path));const h=mt("author-logo"),d=h.firstElementChild;c?(n&&(h.href=n),d.src=c):(dn(h,!1),d.removeAttribute("src"));const u=!this._scene||!!this._forceInfoTextTimer;hs("info-text",u&&(!!t||!!i)),u&&(Wo(mt("info-title"),t),Wo(mt("info-author"),i),n&&(mt("info-author").href=n));let m="";t?m=t:m="3D scene",i&&(m+=" by "+i),document.title=m;const g=mt("engine-logo");if(dn(g,o),o){if(a){const b=mt("engine-logo-text");dn(b,!0),Wo(b,a)}l&&(g.href=l)}}_fillUiViews(t,i){let n=i.children[0];for(this._removeUiViewHighlight(n)();i.children.length>1;)i.removeChild(i.children[i.children.length-1]);for(const o of t)o.hideFromMenu||(Wo(n,o.name),n.onclick=this._viewClicked(o),i.appendChild(n),n=n.cloneNode(!0))}_refreshMenu(){const t=mt("info-bar"),i=mt("info-bar-slide"),n=mt("view-list"),o=mt("view-list-slide"),a=mt("menu-bar"),l=mt("menu-bar-slide"),c=mt("menu-bar-folder"),h=mt("view-mode-slide");if(dn(c,!!this._scene&&!this._pointerLockEnabled),this.visible)t.style.pointerEvents="auto",i.style.left="0",n.style.pointerEvents="auto",o.style.top="0",a.style.pointerEvents="auto",l.style.right="0",c.style.pointerEvents="auto",c.children[0].style.transform="",h&&(h.style.left="0");else{const m=mt("menu-bar-content");t.style.pointerEvents="none",i.style.left=-i.offsetWidth+"px",n.style.pointerEvents="none",o.style.top=-o.offsetHeight+"px",a.style.pointerEvents="none",c.style.pointerEvents="auto",l.style.right=-m.offsetWidth+"px",c.children[0].style.transform="rotate(180deg)",h&&(h.style.left=-h.offsetWidth+"px");return}this.cover&&this._fillCover();const d=this._visibleViews(),u=mt("view-list-items");hs("view-list",d.length>0&&!this._pointerLockEnabled),d.length>0&&this._fillUiViews(d,u),hs("menu-buttons",!!this._scene&&!this._pointerLockEnabled),this._scene&&this._scene.canStartAutoTour()&&!this._vrEnabled?hs("tour-button",!0):(this._autoTour&&this._autoTour.isRunning()&&this._autoTour.stop(),hs("tour-button",!1))}_refreshHelp(){const t=this.helpVisible;if(Qe.mobile)hs("mobile-help",t);else if(hs("desktop-help",t),t){const i=mt("desktop-help-switch"),n=mt("desktop-help-content"),o=this._advancedDesktopHelp?1:0;i.children[o].classList.add("selected"),dn(n.children[o],!0),i.children[1-o].classList.remove("selected"),dn(n.children[1-o],!1)}}_toggleMenu(){this.visible=!this._showMenuSetting}_toggleHelp(){this.helpVisible=!this._showHelpSetting}_switchToBasicDesktopHelp(){this._advancedDesktopHelp=!1,this.refresh()}_switchToAdvancedDesktopHelp(){this._advancedDesktopHelp=!0,this.refresh()}_switchToPreviousView(){const t=this._stopAutoTour();this._teleport.switchToPreviousVisibleView(t?0:void 0)}_switchToNextView(){const t=this._stopAutoTour();this._teleport.switchToNextVisibleView(t?0:void 0)}_showInteractionPrompt(){const t=mt("interaction-prompt");t&&(this._interactionPrompt=!0,qf(t))}_hideInteractionPrompt(){this._interactionPrompt&&(this._interactionPrompt=!1,Mh(mt("interaction-prompt")))}_onKeyDown(t){if(this._hideInteractionPrompt(),t.ctrlKey||t.altKey||t.metaKey)return;const i=t.target||t.srcElement,n=i.nodeType===Node.ELEMENT_NODE?i.nodeName.toUpperCase():"";if(/INPUT|SELECT|TEXTAREA/.test(n))return;if(M.DEBUG){if(t.key.toLowerCase()==="c"){const a=Qe.gl.extension("WEBGL_lose_context");Ke(a),t.shiftKey?a.restoreContext():a.loseContext()}t.key==="r"&&kb()}if(!this._scene)return;switch(t.key.toLowerCase()){case"escape":this._stopAutoTour();break;case"f":this._fullScreenSupported&&this._toggleFullScreen();break;case"l":this._pointerLockSupported&&this._togglePointerLock();break;case"h":this._toggleHelp();break;case"m":this._toggleMenu();break;case"v":this._vrSupported&&this._toggleVr();break;case"p":M.NO_SCREENSHOTS||(t.shiftKey?this._screenshotTaker.monoScreenToLocalImage(!0,4e3,2e3):this._screenshotTaker.monoScreenToLocalImage(!1,window.innerWidth,window.innerHeight));break;case"u":ho(ii("lib/qrcode.js"),q1,()=>Gt.error("Cannot load required library"));break;case"[":this._switchToPreviousView();break;case"]":this._switchToNextView();break}const o=parseInt(t.key);if(!isNaN(o)){const a=this._findViewByIdx(o-1);a&&this._viewClicked(a)(t)}}_onMousePressed(){this._hideInteractionPrompt()}_onWheelScroll(){this._hideInteractionPrompt()}_onTouchStart(){this._hideInteractionPrompt()}_onGamepadActionActivated(t){switch(this._hideInteractionPrompt(),t.action){case Gi.PREVIOUS:this._switchToPreviousView();break;case Gi.NEXT:this._switchToNextView();break}}refresh(){this._refreshMenu(),this._refreshHelp()}get visible(){const t=this._vrEnabled&&Qe.mobile;return this._showMenuSetting&&!t}set visible(t){const i=this.visible;this._showMenuSetting=t,i!==this.visible&&this.dispatchEvent({type:xa.eventType.VISIBILITY_CHANGED}),this.refresh()}get helpVisible(){const t=this._vrEnabled&&Qe.mobile;return this._showHelpSetting&&!t&&!this._pointerLockEnabled}set helpVisible(t){this._showHelpSetting=t,this.refresh()}updateCover(t){this.cover=t,this._forceInfoTextTimer!==void 0&&clearTimeout(this._forceInfoTextTimer),this._forceInfoTextTimer=setTimeout(()=>{this._forceInfoTextTimer=void 0,this.refresh()},5e3),this.refresh()}onFullScreenChange(t){}onPointerLockChange(t){this._pointerLockEnabled=t,this.refresh()}onVrChange(t){const i=this.visible;this._vrEnabled=t,i!==this.visible&&this.dispatchEvent({type:xa.eventType.VISIBILITY_CHANGED}),this.refresh()}onResize(){if(!this.visible){const t=[mt("info-bar-slide"),mt("menu-bar-slide"),mt("view-list-slide")];t.forEach(i=>i.style.transition="none"),this.refresh(),t.forEach(i=>i.style.transition="")}}enablePlayButton(t){const i=mt("play-button");i.addEventListener("click",t),dn(i,!0)}setVrSupported(t){this._vrSupported=t,Ml("vr-specific",t)}setFullScreenSupported(){this._fullScreenSupported=!this._editMode,this._fullScreenSupported&&Ml("fullscreen-specific",!0)}setPointerLockSupported(){this._pointerLockSupported=!this._editMode}addExtraButton(t){const i=mt("tour-button"),n=document.createElement("img");n.src=t;const o=document.createElement("div");return o.className="menu-button menu-item ui-hoverable ui-panel",o.appendChild(n),i.parentNode.insertBefore(o,i),o}removeExtraButton(t){t.remove()}getExtraButonIcon(t){return t.firstElementChild}sceneLoadStarted(){hs("play-button",!1),hs("primary-progress",!0)}loadProgress(t){if(!this._scene){const o=Math.max(314.159*(1-t),0);mt("primary-progress-done").style.strokeDashoffset=o.toString()}const n=Math.floor(t*100);mt("secondary-progress-done").style.width=n+"%"}sceneReadyToDisplay(t,i,n,o){this._scene=t,this._teleport=i,this._teleport.addEventListener(Mn.eventType.TELEPORT_STARTED,this._onTeleportStarted.bind(this)),this._teleport.addEventListener(Mn.eventType.TELEPORT_DONE,this._onTeleportDone.bind(this)),this._autoTour=n,this._autoTour.addEventListener(Fr.eventType.TOUR_STARTED,this._onTourStarted.bind(this)),this._autoTour.addEventListener(Fr.eventType.TOUR_STOPPED,this._onTourStopped.bind(this)),this._screenshotTaker=o,Mh(mt("cover-image")),Mh(mt("primary-progress")),qf(mt("secondary-progress"));const a=Ui();this._scene.interactionPrompt&&!this._showHelpSetting&&!M.EDIT_MODE&&(a._isMeeting()?a._onMeetingJoined(()=>this._showInteractionPrompt()):this._showInteractionPrompt()),this._scene.addEventListener(Yi.eventType.VIEW_ADDED,()=>this.refresh()),this._scene.addEventListener(Yi.eventType.VIEW_REMOVED,()=>this.refresh()),this._scene.addEventListener(Yi.eventType.VIEW_SHIFTED,()=>this.refresh()),document.body.style.backgroundImage="none",document.body.style.backgroundColor="#000",this.refresh()}sceneLoadComplete(){hs("secondary-progress",!1)}init(){this._editMode&&(Ml("viewer-specific",!1),Ml("editor-specific",!0)),wh("ui-panel",n=>gl(n)),Qe.mobile&&X1("ui-hoverable");const t=mt("author-logo"),i=t.firstElementChild;i.onload=()=>dn(t,!0),i.onerror=()=>dn(t,!1),document.addEventListener("keydown",this._onKeyDown.bind(this),!1),document.addEventListener("mousedown",this._onMousePressed.bind(this),!1),document.addEventListener("wheel",this._onWheelScroll.bind(this),!1),document.addEventListener("touchstart",this._onTouchStart.bind(this),!1),Pi("help-button",this._toggleHelp.bind(this)),Pi("fullscreen-button",this._toggleFullScreen),Pi("vr-button",this._toggleVr),Pi("tour-button",this._toggleAutoTour.bind(this)),Pi("menu-bar-folder",this._toggleMenu.bind(this)),Pi("view-list-folder",this._toggleMenu.bind(this)),Pi("basic-desktop-help-option",this._switchToBasicDesktopHelp.bind(this)),Pi("advanced-desktop-help-option",this._switchToAdvancedDesktopHelp.bind(this)),Pi("close-desktop-help-button",this._toggleHelp.bind(this)),Pi("close-mobile-help-button",this._toggleHelp.bind(this)),this._gamepadManager.addEventListener(tr.ACTION_ACTIVATED,this._onGamepadActionActivated.bind(this)),this.refresh()}contextLost(){this._scene=this._teleport=this._autoTour=this._screenshotTaker=void 0,this.refresh()}};r(xa,"eventType",Yf);let Pl=xa;function Qf(s,e){return Math.abs(s.x-e.x)<Number.EPSILON&&Math.abs(s.y-e.y)<Number.EPSILON&&Math.abs(s.z-e.z)<Number.EPSILON}function Ph(){return window.innerWidth<640||window.innerHeight<640}function Kf(s,e,t){const i=Math.sin(e),n=Math.cos(e),o=(s.x-t.x)*n-(s.y-t.y)*i+t.x,a=(s.x-t.x)*i+(s.y-t.y)*n+t.y;s instanceof F?s.set(o,a,s.z):s.set(o,a)}function Y1(s){const e=document.createElement("canvas");e.width=s,e.height=s;const i=60*Math.PI/180,n=-i/2-Math.PI/2,o=i/2-Math.PI/2,a=e.getContext("2d");return a.beginPath(),a.arc(s/2,s/2,4,0,Math.PI*2),a.fillStyle="rgb(0, 220, 255)",a.fill(),a.moveTo(s/2,s/2),a.arc(s/2,s/2,12,n,o,!0),a.lineTo(s/2,s/2),a.arc(s/2,s/2,90,n,o),a.lineTo(s/2,s/2),a.fillStyle="rgba(0, 220, 255, 0.5)",a.fill(),e}class Q1{constructor(e,t){r(this,"width");r(this,"height");r(this,"container");r(this,"_translate");this.width=e,this.height=t;const i=200;this._translate="translate(-"+i/2+"px, -"+i/2+"px)",this.container=this._createContainer(i)}_createContainer(e){const t=document.createElement("div"),i=Y1(e);return t.style.width=e+"px",t.style.height=e+"px",t.style.position="absolute",t.style.pointerEvents="none",t.style.zIndex="2",t.style.opacity="1",t.style.transition="opacity 0.5s",t.id="minimap-camera",t.appendChild(i),t}update(e,t){this.container.style.left=e.x/this.width*100+"%",this.container.style.top=e.y/this.height*100+"%",this.container.style.transform=this._translate+" rotate("+t+"rad)"}show(){this.container.style.opacity="1"}hide(){this.container.style.opacity="0"}getContainer(){return this.container}}function K1(s,e){if("ResizeObserver"in window){new ResizeObserver(e).observe(s);return}const t=window.getComputedStyle(s),i=60;let n,o,a,l;function c(){o=i,n||h()}function h(){n=!0;const u=t.width,m=t.height;a!==u||l!==m?(a=u,l=m,e(),window.requestAnimationFrame(h)):o!==void 0&&o>0?(o-=1,window.requestAnimationFrame(h)):n=!1}new MutationObserver(()=>c()).observe(s,{attributes:!0}),window.addEventListener("resize",()=>c())}class $1{constructor(e,t,i,n){r(this,"_offset",{x:"0",y:"0"});r(this,"_width");r(this,"_height");r(this,"_driver");r(this,"_controllerElement");r(this,"_driverComputedStyle");this._width=e,this._height=t,this._driver=document.createElement("canvas"),this._driver.width=e*3,this._driver.height=t*3,this._driver.style.position="absolute",this._driver.style.maxWidth="100%",this._driver.style.maxHeight="100%",this._controllerElement=document.createElement("div"),this._controllerElement.classList.add("minimap-content-controller"),this._driverComputedStyle=window.getComputedStyle(this._driver),n.appendChild(this._driver),n.appendChild(this._controllerElement),K1(i,()=>this._onResize())}_setOffset(){this._controllerElement.style.transform="translate("+this._offset.x+","+this._offset.y+")"}_onResize(){this._controllerElement.style.width=this._driverComputedStyle.width,this._controllerElement.style.height=this._driverComputedStyle.height}add(e){this._controllerElement.appendChild(e)}clear(){this._controllerElement.innerHTML=""}updateOffset(e){this._offset.x=50-e.x/this._width*100+"%",this._offset.y=50-e.y/this._height*100+"%",this._setOffset()}addOffset(){this._setOffset()}removeOffset(){this._controllerElement.style.transform=""}updateRatio(e){const t=()=>{const i=Math.abs(Math.sin(e.rotation)),n=Math.abs(Math.cos(e.rotation));this._driver.width=3*(this._width*e.ratio.x*n+this._height*e.ratio.y*i),this._driver.height=3*(this._width*e.ratio.x*i+this._height*e.ratio.y*n),this._onResize()};window.requestAnimationFrame(t)}}var $f=(s=>(s.LEVEL_SELECTED="minimapLevelSelected",s))($f||{});const ac=class ac extends ei{constructor(t,i,n,o){super();r(this,"_minimapRenderer");r(this,"_scene");r(this,"_teleport");r(this,"_viewerApi");r(this,"_closed",!1);r(this,"_initialized",!1);r(this,"_minimized",!1);r(this,"_cameraMarker");r(this,"_contentController");r(this,"_currentLevel");r(this,"_levelsWrapper",new Array);r(this,"_levelSwitchLock",!1);r(this,"_cameraLimitMin",-1/0);r(this,"_cameraLimitMax",1/0);r(this,"_width");r(this,"_height");r(this,"_buttonMinimize",document.getElementById("minimap-button-minimize"));r(this,"_buttonMaximize",document.getElementById("minimap-button-maximize"));r(this,"_buttonClose",document.getElementById("minimap-button-close"));r(this,"_buttonToggle",document.getElementById("minimap-button-toggle"));r(this,"_container",document.getElementById("minimap-container"));r(this,"_wrapper",document.getElementById("minimap-wrapper"));r(this,"_content",document.getElementById("minimap-content"));r(this,"_tabs",document.getElementById("minimap-tabs"));r(this,"_lastCameraPosition",new F(0,0,0));r(this,"_lastCameraRotation",new F(0,0,0));r(this,"_pointPosition",new Ce);r(this,"_pixelPosition",new Ce);r(this,"_canvasRangeX");r(this,"_canvasRangeY");this._minimapRenderer=t,this._scene=i,this._teleport=n,this._viewerApi=o,this._viewerApi.onViewSwitchStarted(()=>this._levelSwitchLock=!0),this._viewerApi.onViewSwitchDone(()=>this._levelSwitchLock=!1);const a=700,{width:l,height:c}=this._minimapRenderer.calculateRenderSize(a,this._scene.boundingBox);this._width=l,this._height=c,this._canvasRangeX={min:0,max:this._width},this._canvasRangeY={min:0,max:this._height},this._scene.minimapConfig,this._scene.minimapConfig.enabled&&this._init(),this._scene.minimapConfig.addEventListener(Wr.eventType.UPDATED,()=>this._onConfigUpdate()),this._viewerApi._onMeetingJoined(()=>this._close())}_initLevels(){this._scene.minimapConfig,this._levelsWrapper=this._scene.minimapConfig.levels.map(t=>({level:t,canvas:void 0,tab:void 0}))}_createLevelTabs(){this._levelsWrapper.forEach(t=>{t.tab=document.createElement("div"),t.tab.classList.add("minimap-tab"),t.tab.innerText=t.level.name,t.tab.addEventListener("click",()=>{this.selectLevel(t.level),xo()}),this._tabs.appendChild(t.tab)})}_isLevelCurrent(t){return t===this._currentLevel}_setLevelCurrent(t){this._currentLevel=t,this._cameraMarker.show(),this._levelsWrapper.forEach(i=>{i.level===t?i.tab.classList.add("minimap-tab-current"):i.tab.classList.remove("minimap-tab-current")})}_setLevelSelected(t){this._levelsWrapper.forEach(i=>{i.canvas&&(i.canvas.style.opacity=i.level===t?"1":"0",i.canvas.style.zIndex=i.level===t?"1":"0"),i.level===t?i.tab.classList.add("minimap-tab-active"):i.tab.classList.remove("minimap-tab-active")})}_createInitLevel(){const i=this._levelsWrapper.find(n=>n.level===this._currentLevel)?this._currentLevel:this._levelsWrapper.at(-1).level;this.selectLevel(i,!0)}_calculateCameraLimit(t,i){const n=t.slicePlaneHeight-i.slicePlaneHeight;return t.slicePlaneHeight-n/2}_setCameraLimits(t){const i=this._levelsWrapper.filter(o=>o.level.slicePlaneHeight<t.slicePlaneHeight).sort((o,a)=>a.level.slicePlaneHeight-o.level.slicePlaneHeight)[0],n=this._levelsWrapper.filter(o=>o.level.slicePlaneHeight>t.slicePlaneHeight).sort((o,a)=>o.level.slicePlaneHeight-a.level.slicePlaneHeight)[0];this._cameraLimitMin=i?this._calculateCameraLimit(t,i.level):-1/0,this._cameraLimitMax=n?this._calculateCameraLimit(t,n.level):1/0}_levelForCameraPosition(t){return this._levelsWrapper.reduce((n,o)=>Math.abs(o.level.slicePlaneHeight-t.z)<Math.abs(n.level.slicePlaneHeight-t.z)?o:n).level}_selectLevelForCameraPosition(t){if(t.z>this._cameraLimitMax||t.z<this._cameraLimitMin){const i=this._levelForCameraPosition(t);this._setCameraLimits(i),this.selectLevel(i,!0)}}_updateElementsTransforms(t,i){if(!this._currentLevel)return;!t&&!i&&(t=this._viewerApi.getCameraPosition(),i=this._viewerApi.getCameraRotation()),this._pointPosition.set(t.x,t.y),Kf(this._pointPosition,this._currentLevel.rotation,this._currentLevel.cropRange.center()),this._pixelPosition.set(Di(this._pointPosition.x,this._currentLevel.visibleRange.max.x,this._currentLevel.visibleRange.min.x,this._canvasRangeX.max,this._canvasRangeX.min),Di(this._pointPosition.y,this._currentLevel.visibleRange.max.y,this._currentLevel.visibleRange.min.y,this._canvasRangeY.max,this._canvasRangeY.min));const n=i.z*-1+this._currentLevel.rotation*-1;this._cameraMarker.update(this._pixelPosition,n),this._minimized&&this._contentController.updateOffset(this._pixelPosition)}_minimize(){this._minimized=!0,this._container.classList.add("minimap-container-minimized"),this._wrapper.classList.add("minimap-wrapper-minimized"),this._contentController.addOffset(),this._updateElementsTransforms()}_maximize(){this._minimized=!1,this._container.classList.remove("minimap-container-minimized"),this._wrapper.classList.remove("minimap-wrapper-minimized"),this._contentController.removeOffset()}_close(){this._closed=!0,this._wrapper.style.transform="translate(-101%, 0)"}_open(){this._closed=!1,this._wrapper.style.transform=""}_toggle(){if(!this._viewerApi.menuVisible){this._close();return}if(this._minimized&&Ph()){this._maximize(),this._open();return}this._closed?this._open():this._close()}_onMenuVisibilityChanged(){this._closed&&this._viewerApi&&Ph()||this._toggle()}_setupInteractions(){kn(this._buttonMinimize,()=>this._minimize()),kn(this._buttonMaximize,()=>this._maximize()),kn(this._buttonClose,()=>this._close()),kn(this._buttonToggle,()=>this._toggle()),this._viewerApi.onMenuVisibilityChanged(()=>this._onMenuVisibilityChanged)}_addMinimapToCanvas(t,i){i.getContext("2d").putImageData(t,0,0)}_isWalkable(t,i,n){const o=(i+n*this._width)*4+3;return t.data[o]!==0}_createDestinationView(t){const i={position:[t.x,t.y,t.z]};return new Hi(i)}_addCanvasInteractionsHandler(t,i,n){const o=new F,a={min:0,max:1};i.addEventListener("click",l=>{const c=i.getBoundingClientRect(),h=(l.clientX-c.left)/c.width,d=(l.clientY-c.top)/c.height,u=Math.round(h*this._width),m=Math.round(d*this._height);if(this._isWalkable(t,u,m)){o.set(Di(h,a.min,a.max,n.visibleRange.min.x,n.visibleRange.max.x),Di(d,a.min,a.max,n.visibleRange.min.y,n.visibleRange.max.y),n.slicePlaneHeight),Kf(o,n.rotation*-1,n.cropRange.center());const g=this._createDestinationView(o);this._teleport.switchToView(g),this._isLevelCurrent(n)||this._setLevelCurrent(n)}xo()})}_show(){this._contentController.add(this._cameraMarker.getContainer()),this._buttonToggle.style.display="",this._container.style.display="",this._levelsWrapper.length>1&&(this._tabs.style.display="",this._wrapper.classList.add("minimap-wrapper-tabs"))}_dispose(){this._contentController.clear(),this._tabs.innerHTML="",this._tabs.style.display="none",this._container.style.display="none",this._buttonToggle.style.display="none",this._wrapper.classList.remove("minimap-wrapper-tabs")}_createLevelCanvas(t){const i=document.createElement("canvas");i.width=this._width,i.height=this._height,i.style.transition="opacity 0.5s";const{minimapImageData:n,walkableImageData:o}=this._minimapRenderer.createMinimapImageDataComponents(this._scene.minimapConfig,t,this._width,this._height);return this._addMinimapToCanvas(n,i),this._addCanvasInteractionsHandler(o,i,t),this._contentController.add(i),i}_enable(){this._initLevels(),this._createLevelTabs(),this._createInitLevel(),this._show()}_hasMissingElements(){return!(this._buttonMinimize&&this._buttonMaximize&&this._buttonClose&&this._buttonToggle&&this._container&&this._wrapper&&this._content)}_init(){this._hasMissingElements()||(this._contentController=new $1(this._width,this._height,this._wrapper,this._content),this._cameraMarker=new Q1(this._width,this._height),Ph()?this._close():this._minimize(),this._setupInteractions(),this._initialized=!0,this._enable())}_onConfigUpdate(){var t;if(!this._initialized){this._init();return}(t=this._scene.minimapConfig)!=null&&t.enabled?(this._dispose(),this._enable()):this._dispose()}selectLevel(t,i=!1){const n=this._levelsWrapper.filter(o=>o.level===t)[0];i&&this._setLevelCurrent(t),n.canvas||(n.canvas=this._createLevelCanvas(t)),this._isLevelCurrent(t)?this._cameraMarker.show():this._cameraMarker.hide(),this._setLevelSelected(t),this._setCameraLimits(t),this._updateElementsTransforms(),this._contentController.updateRatio(t),this.dispatchEvent({type:ac.eventType.LEVEL_SELECTED,level:t})}update(){if(this._hasMissingElements())return;const t=this._viewerApi.getCameraPosition(),i=this._viewerApi.getCameraRotation();(Qf(this._lastCameraPosition,t)===!1||Qf(this._lastCameraRotation,i)===!1)&&(this._updateElementsTransforms(t,i),this._levelSwitchLock||this._selectLevelForCameraPosition(t),this._lastCameraPosition.set(t.x,t.y,t.z),this._lastCameraRotation.set(i.x,i.y,i.z))}};r(ac,"eventType",$f);let Cl=ac;class Z1{constructor(){r(this,"_nodeTypeHoverListeners",new Map);r(this,"_materialHoverListeners",new Map)}_callListener(e,t,i){try{return e(t,i)}catch(n){console.error(n)}return!1}registerMaterialHoverListener(e,t){const i=this._materialHoverListeners.get(e);if(i){i.push(t);return}this._materialHoverListeners.set(e,[t])}registerNodeTypeHoverListener(e,t){const i=this._nodeTypeHoverListeners.get(e);if(i){i.push(t);return}this._nodeTypeHoverListeners.set(e,[t])}empty(){return this._nodeTypeHoverListeners.size==0&&this._materialHoverListeners.size==0}invoke(e,t){var i,n,o;if(e instanceof Ys)return((i=this._nodeTypeHoverListeners.get(e))!=null?i:[]).some(l=>this._callListener(l,e,t));if(e instanceof Bn){for(let a=e.node;a!==null;a=a.parent)if(((n=this._nodeTypeHoverListeners.get(a.type))!=null?n:[]).some(c=>this._callListener(c,a,t)))return!0}return e.material?((o=this._materialHoverListeners.get(e.material.name))!=null?o:[]).some(l=>this._callListener(l,e.material,t)):!1}}const J1=.1,Qn=class Qn{constructor(e,t,i,n,o,a){r(this,"lightmap",null);r(this,"meshes",new Array);r(this,"_gazeModeObserver");r(this,"_gazeListeners",new Array);r(this,"_onGazeModeEnabled",()=>this._setGaze(!0));r(this,"_onGazeModeDisabled",()=>this._setGaze(!1));this._gazeModeObserver=a;const l=Math.max(n.camera.near*2,J1);this._gazeModeObserver.addEventListener(Ms.eventType.MODE_ENABLED,this._onGazeModeEnabled),this._gazeModeObserver.addEventListener(Ms.eventType.MODE_DISABLED,this._onGazeModeDisabled);let[c,h,d,u]=this._computeSphereParameters(e,n,l);if(e.some(b=>b.lightmapEnabled)){let b=o.measureIncidentLuma();b<0&&(b=1);const x=n.sharedMaterialState.lightmapEncoding;this.lightmap=qo.createSingleColorLightmap(new be(b,b,b),x),this.lightmap.id=`[MaterialPickerLightmap ${b}]`}const m=n.camera.getWorldPosition(),g=new F;e.forEach((b,x)=>{if(!b)return;g.set(c,h,-l);const v=this._createSphereMesh(n,b,d,g,this.lightmap);c+=2*d+u;const E=this._computeWorldStaticMatrix(m,i,t,d,g,x);this.meshes.push(v),this._gazeListeners.push(w=>{w&&E?(v.matrix=E,v.matrixWorld=E):(v.matrix=n.camera.matrix,v.matrixWorld=n.camera.matrixWorld)})}),this._setGaze(a.modeIsEnabled())}_rotationAngle(e){return Math.abs(e.y)>Math.abs(e.x)?e.x>0?0:-Math.PI:e.y>0?Math.PI/2:-Math.PI/2}_createSphereMesh(e,t,i,n,o){t instanceof Bc&&(i-=Math.min(1,t.grassHeight)*i*.5);const a=nt.createSphere(i,32,16);a.changePosition(n),a.computeBoundingSphere(),a.convertNormalsToSpherical();const l=new Bn(null,a,t);return t.lightmapEnabled&&(l.lightmap=o),t instanceof Bc&&(l.grassScaleOverride=i),e.camera.getWorldPosition(Qn._cameraPositionTemp),l.lightProbes=[e.closestLightProbe(Qn._cameraPositionTemp)],l.frustumCulled=!1,l.userData.hideFromLightProbes=!0,l}_computeSphereParameters(e,t,i){const n=t.camera.fov,o=t.camera.aspectRatio,a=Math.tan(qt(n/2))*i,l=-a,c=o*l,h=o*a,d=Math.abs(h-c),u=Math.abs(a-l),m=.01*d;let g=(d-e.length*m-m)/(2*e.length);g=Math.min(g,M.MATERIAL_PICKER_BALL_MAX_SIZE/2*d);const b=-(2*g+m)*(e.length/2)+g+m,x=document.getElementById("menu-bar").getBoundingClientRect().top,E=(window.innerHeight-x)/window.innerHeight,w=-u/2+u*E+g+m;return[b,w,g,m]}_computeWorldStaticMatrix(e,t,i,n,o,a){if(!i)return;const l=new at,c=Qn._mat4Temp;return l.multiply(c.makeTranslation(i.x,i.y,i.z)),Qn._vec2Temp.x=e.x-i.x,Qn._vec2Temp.y=e.y-i.y,l.multiply(c.makeRotationZ(this._rotationAngle(Qn._vec2Temp))),l.multiply(c.makeRotationX(-Math.PI/2)),l.multiply(c.makeScale(t,t,t)),l.multiply(c.makeTranslation((a+1)*2.1,0,0)),l.multiply(c.makeScale(1/n,1/n,1/n)),l.multiply(c.makeTranslation(-o.x,-o.y,-o.z)),l}_setGaze(e){this._gazeListeners.forEach(t=>t(e))}dispose(){this._gazeListeners.length=0,this._gazeModeObserver.removeEventListener(Ms.eventType.MODE_ENABLED,this._onGazeModeEnabled),this._gazeModeObserver.removeEventListener(Ms.eventType.MODE_DISABLED,this._onGazeModeDisabled),this.meshes.forEach(e=>e.geometry.dispose()),this.meshes=[],this.lightmap&&(this.lightmap.dispose(),this.lightmap=null)}};r(Qn,"_cameraPositionTemp",new F),r(Qn,"_mat4Temp",new at),r(Qn,"_vec2Temp",new Ce);let Ch=Qn;function Zf(s,e,t){let i,n=null,o,a,l,c,h,d,u,m,g,b,x,v,E=!1,w=!1,C=null,I=null;const O={nextPageInteraction:[],viewerConfigLoaded:[],sceneReadyToDisplay:[],sceneLoadComplete:[],anchorClicked:{},materialPickerClicked:{},materialPickerClosed:null,nodeTypeClicked:{},anyNodeTypeClicked:[],materialClicked:{},hoverListeners:new Z1,viewSwitchStarted:[],viewSwitchDone:[],vrChange:[],beforeRender:[],anchorsVisibilityChanged:[],apiUserStateChanged:{},anyApiUserStateChanged:[],meetingJoined:[],avatarListChanged:[]},U=[],z=[];let ie=0;function J(...L){return null}function re(L){t.isMaterialEditable(L)||console.assert(!1,"Can't access material, call ViewerApi.setMaterialEditable('"+L+"') before the scene is loaded.")}function Oe(){const L=[];for(const te of n.materials)t.isMaterialEditable(te.name)&&L.push(te);return L}function We(){const L=[];for(const te of n.nodeConfigs)t.isNodeTypeEditable(te.name)&&L.push(te.name);return L}function Ve(L){re(L);for(const te of n.materials)if(te.name===L)return te;return null}const lt=new F;function k(){return lt.copyFrom(o.cameraWorldPosition()),lt}const K=new ui;function de(){return K.yaw=o.getYawAngle(),K.pitch=o.getPitchAngle(),K.roll=0,K}function ce(){return n.boundingBox}function Te(L){const te=[];re(L);for(let Fe of n.gpuMeshes)Fe.material.name===L&&te.push(Fe);return te}function pe(L){const te=n.findNodeConfig(L);return te?te.nodes.slice(0):[]}function ye(L,te){te.geometry.isUvs0Repeating&&L.ensureTexturesRepeatable&&L.ensureTexturesRepeatable(),te.material=L,u.requestFrame()}function Re(L,te){console.warn("setMaterialForNode() is deprecated, use setMaterialForMesh() instead"),ye(L,te)}this._allViews=function(){return n.allViews()},this.visibleViews=function(){return n.visibleViews()};function he(L,te,Fe){let xt;if(typeof L=="string"){let Ut=L;xt=n.findViewByName(Ut)}else xt=L;xt?(te===!0?te=0:te===!1&&(te=void 0),l.isRunning()&&(te=0,l.stop()),Fe?(a.activateSky(xt),a.updateHiddenMeshes(xt)):a.switchToView(xt,te)):console.error("Unknown view: "+L)}function je(L={}){const te=L.isPanorama||!1;function Fe(){return te?4e3:window.innerWidth}function xt(){return te?2e3:window.innerHeight}const Ut=L.width||Fe(),pt=L.height||xt();if(L.toDataUrl||!1)return h.monoScreenToDataUrl(te,Ut,pt);h.monoScreenToLocalImage(te,Ut,pt)}function Xe(L){n.addAuxiliaryObject(L),L!==L.colliderMesh&&i.uploadNewBuffers(L.colliderMesh),c==null||c.addDynamicObstacles([L.colliderMesh])}function B(L){n.removeAuxiliaryObject(L),c==null||c.removeDynamicObstacles([L.colliderMesh])}function N(L,...te){try{return L(...te)}catch(Fe){console.error(Fe)}return!1}function H(L,...te){if(L)for(let Fe of L)N(Fe,...te)}function X(){H(O.nextPageInteraction),O.nextPageInteraction.length=0}document.addEventListener("keydown",X),document.addEventListener("mousedown",X),document.addEventListener(Qe.ios?"touchstart":"touchend",X);let ve=!0;Object.defineProperty(this,"anchorsVisible",{get(){return ve},set(L){L!==ve&&(ve=L,ve?U.forEach(te=>Xe(te)):U.forEach(te=>B(te)),this.requestFrame(),H(O.anchorsVisibilityChanged,ve))}});function we(L,te){const Fe=new Ys(n,n.renderCaches,L);return U.push(Fe),ve&&Xe(Fe),O.anchorClicked[Fe.colliderMesh.id]=te,E=!0,u.requestFrame(),Fe}function ze(L){delete O.anchorClicked[L.colliderMesh.id],ve&&B(L),zi(L,U),L.dispose(),u.requestFrame()}function Le(L,te){const Fe=new Xg(n,L,te);return z.push(Fe),n.addAuxiliaryObject(Fe,!0),c==null||c.addDynamicObstacles(Fe.colliders),H(O.avatarListChanged),Fe}function _e(L){c==null||c.removeDynamicObstacles(L.colliders),n.removeAuxiliaryObject(L),zi(L,z),L.dispose(),H(O.avatarListChanged)}function Ge(L){return z.find(te=>te.uuid===L)}function ne(){for(const L of n.materialManager.getAnimatedMaterials())L.sleepAnimation()}function ue(){for(const L of n.materialManager.getAnimatedMaterials())L.wakeAnimation();u.requestFrame()}function Ue(L,te){return m.getExtension(L,te)}function et(L,te){let Fe=L[te];return Fe||(Fe=[],L[te]=Fe,Fe)}const ot=function(){const te=new F,Fe=new F,xt=new F,Ut=new Fn,pt=new F,Ri=new ui;let mi;function si(vt,R,G){Fe.set(vt.x,vt.y,mi.z).sub(mi);const q=Fe.length();q>R&&(Fe.normalize().multiplyScalar(q-R),G.add(Fe))}return function(vt){mi=o.cameraWorldPosition(),pt.copyFrom(mi);let R;vt instanceof el&&vt.light.type===sn.SUN?(Om(n,vt.rotation,te),R=te):vt instanceof au?(zx(vt,Ut),R=Ut.center,si(R,1+Ut.radius,pt)):(R=vt.position,si(R,1,pt)),xt.copyFrom(R).sub(pt).normalize(),Ri.setFromDirection(xt);const G=new Hi({position:pt.toArray(),rotation:[Ri.yawDeg,Ri.pitchDeg],mode:a.lastDestinationView.mode,orthographic:a.lastDestinationView.orthographic,orthoFrustumSize:a.lastDestinationView.orthoFrustumSize,distance:a.lastDestinationView.orthographic?a.lastDestinationView.distance:1,target:R.toArray()});a.switchToView(G)}}();this.getCurrentMaterialPickerId=function(){return C?ie:null},this.openMaterialPicker=function(L,te,Fe,xt,Ut){return console.assert(!C,"Only one material picker can be opened"),C=new Ch(L,xt,Ut,n,d,x),c.addDynamicObstacles(C.meshes),C.meshes.forEach(function(pt){n.addAuxiliaryObject(pt),O.materialPickerClicked[pt.id]=te}),O.materialPickerClosed=Fe,this._setMeetingCameraPreviewVisibility(!1),++ie},this.closeMaterialPicker=function(){C&&(c.removeDynamicObstacles(C.meshes),C.meshes.forEach(function(L){n.removeAuxiliaryObject(L),delete O.materialPickerClicked[L.id]}),C.dispose(),C=null,O.materialPickerClosed&&(O.materialPickerClosed(),O.materialPickerClosed=null),this._setMeetingCameraPreviewVisibility(!0))},window.addEventListener("resize",this.closeMaterialPicker.bind(this)),this._vrChange=function(L){H(O.vrChange,L)},this._update=function(L){H(O.beforeRender,L)},this._clickListener=function(L,te,Fe){if(!E)return!1;if(C){const pt=O.materialPickerClicked[L.id];return pt?(N(pt,L.material,C.meshes.indexOf(L)),!0):(this.closeMaterialPicker(),!0)}const xt=O.anchorClicked[L.id];if(xt)return N(xt,L.anchor,te,Fe),!0;const Ut=(pt,Ri)=>{if(pt){for(let mi of pt)if(N(mi,Ri,te,Fe))return!0}return!1};for(let pt=L.node;pt;pt=pt.parent)if(Ut(O.nodeTypeClicked[pt.type],L.node))return!0;return L.node&&Ut(O.anyNodeTypeClicked,L.node)?!0:L.material?Ut(O.materialClicked[L.material.name],L.material):!1},this.getHoverListeners=()=>O.hoverListeners,this._teleportStarted=function(L){const te=L.view;te&&H(O.viewSwitchStarted,te.name,te)},this._teleportDone=function(L){const te=L.view;te&&H(O.viewSwitchDone,te.name,te)},this._viewerConfigLoaded=function(L){g=L,H(O.viewerConfigLoaded,g),O.viewerConfigLoaded=[]},this._sceneReadyToDisplay=function(L,te,Fe,xt,Ut,pt,Ri,mi,si,vt,R,G,q){i=L,n=te,o=Fe,a=xt,l=Ut,c=pt,h=Ri,d=mi,b=si,x=vt,v=R,u=G,m=q,this.getEditableMaterials=Oe,this.getEditableNodeTypes=We,this.findMaterial=Ve,this.findMeshesWithMaterial=Te,this.findNodesOfType=pe,this.getCameraPosition=k,this.getCameraRotation=de,this.getSceneBoundingBox=ce,this.setMaterialForNode=Re,this.setMaterialForMesh=ye,this.switchToView=he,this.captureImage=je,this.addAnchor=we,this.removeAnchor=ze,this.addAvatar=Le,this.removeAvatar=_e,this.findAvatar=Ge,this.seeItem=ot,this.sleepAnimatedMaterials=ne,this.wakeAnimatedMaterials=ue,this.getExtension=Ue,H(O.sceneReadyToDisplay,n),O.sceneReadyToDisplay=[],a.addEventListener(Mn.eventType.TELEPORT_STARTED,this._teleportStarted.bind(this)),a.addEventListener(Mn.eventType.TELEPORT_DONE,this._teleportDone.bind(this))},this._contextLost=function(){w=!1,g=n=a=l=c=h=v=u=null,this.getEditableMaterials=J,this.getEditableNodeTypes=J,this.findMaterial=J,this.findMeshesWithMaterial=J,this.findNodesOfType=J,this.setMaterialForNode=J,this.setMaterialForMesh=J,this.switchToView=J,this.captureImage=J,this.addAnchor=J,this.addAvatar=J,this.removeAnchor=J,this.findAvatar=J,this.sleepAnimatedMaterials=J,this.wakeAnimatedMaterials=J,this.getExtension=J},this._sceneLoadComplete=function(){H(O.sceneLoadComplete),O.sceneLoadComplete=[],w=!0;for(const L of U)L.enableLightProbe()},this.openUrl=function(L,te){if(te||s)return window.open(L);window.location.href=L},this.onNextPageInteraction=function(L){O.nextPageInteraction.push(L)},this.onViewerConfigLoaded=function(L){if(g){L(g);return}O.viewerConfigLoaded.push(L)},this.isSceneReadyToDisplay=function(){return n!==null},this.onSceneReadyToDisplay=function(L){if(n){L(n);return}O.sceneReadyToDisplay.push(L)},this.onSceneLoadComplete=function(L){if(w){L(n);return}O.sceneLoadComplete.push(L)},this.requestFrame=function(){u&&u.requestFrame()},this.setNodeTypeEditable=function(L){console.assert(n===null,"setNodeTypeEditable must be called before the scene is loaded"),t.setNodeTypeEditable(L)},this.setMaterialEditable=function(L){console.assert(n===null,"setMaterialEditable must be called before the scene is loaded"),t.setMaterialEditable(L)},this.setAllMaterialsEditable=function(){console.assert(n===null,"setAllMaterialsEditable must be called before the scene is loaded"),t.setAllMaterialsEditable()},this.onCameraPositionUpdated=function(L){n.camera.addEventListener(gi.eventType.POSITION_CHANGED,L)},this.removeOnCameraPositionUpdated=function(L){n.camera.removeEventListener(gi.eventType.POSITION_CHANGED,L)},this.onNodeTypeClicked=function(L,te){typeof L=="function"?(te=L,O.anyNodeTypeClicked.push(te)):et(O.nodeTypeClicked,L).push(te),E=!0},this.removeOnNodeTypeClicked=function(L,te){typeof L=="function"?(te=L,zi(te,O.anyNodeTypeClicked)):zi(te,O.nodeTypeClicked[L])},this.onMaterialClicked=function(L,te){this.setMaterialEditable(L),et(O.materialClicked,L).push(te),E=!0},this.onNodeTypeHoverChanged=function(L,te){L instanceof Ys||this.setNodeTypeEditable(L),O.hoverListeners.registerNodeTypeHoverListener(L,te)},this.onMaterialHoverChanged=function(L,te){this.setMaterialEditable(L),O.hoverListeners.registerMaterialHoverListener(L,te)},this.onViewSwitchStarted=function(L){O.viewSwitchStarted.push(L)},this.onViewSwitchDone=function(L){O.viewSwitchDone.push(L)},this.onVrChange=function(L){O.vrChange.push(L)},this.onBeforeRender=function(L){O.beforeRender.push(L)},this.createTextureFromHtmlImage=function(L,te=!1){const Fe=new dt;Fe.image=L,Fe.wrapS=Fe.wrapT=Z.REPEAT,Fe.minFilter=Z.LINEAR_MIPMAP_LINEAR,Fe.format=te?Be.RGBA8:Be.RGB8,Fe.hasAlpha=te;let xt=null;function Ut(){Fe.needsUpdate=!0,Fe.width=L.naturalWidth,Fe.height=L.naturalHeight,Fe.notifyLoaded()}function pt(){Ut(),xt&&xt(),L.onload=xt}return L.complete&&L.naturalHeight!==0?Ut():(xt=L.onload,L.onload=pt),Fe},this.createTextureFromHtmlVideo=function(L){const te=new Yo;te.video=L,te.minFilter=Z.LINEAR,te.format=Be.RGB8,te.generateMipmaps=!1;function Fe(xt){te.width=xt.videoWidth,te.height=xt.videoHeight,te.wrapS=Z.REPEAT,te.wrapT=Z.REPEAT,te.notifyLoaded(),te.needsUpdate=!0}return L.setAttribute("playsinline",""),L.setAttribute("webkit-playsinline",""),L.crossOrigin="anonymous",Md(L,Fe),te},this.createStreamTextureFromHtmlVideo=function(L){const te=this.createTextureFromHtmlVideo(L);return te._interruptible=!1,te},this.addAnchor=function(L,te){},this.removeAnchor=function(L){},this.addAvatar=function(){},this.removeAvatar=function(){},this.findAvatar=function(L){},this.sleepAnimatedMaterials=function(){},this.wakeAnimatedMaterials=function(){},this.getExtension=function(L,te){},this.onAnchorsVisibilityChanged=function(L){O.anchorsVisibilityChanged.push(L)},this.removeAnchorsVisibilityChangedListener=function(L){O.anchorsVisibilityChanged=O.anchorsVisibilityChanged.filter(te=>te!==L)},this.getEditableMaterials=J,this.getEditableNodeTypes=J,this.findMaterial=J,this.findMeshesWithMaterial=J,this.findNodesOfType=J,this.getCameraPosition=J,this.getCameraRotation=J,this.getSceneBoundingBox=J,this.setMaterialForNode=J,this.setMaterialForMesh=J,this.switchToView=J,this.captureImage=J,this.seeItem=J,this.getViewerAssetUrl=L=>ii(L),this.addMenuButton=function(L){return e.addExtraButton(L)},this.removeMenuButton=function(L){e.removeExtraButton(L)},this.getMenuButtonIcon=function(L){return e.getExtraButonIcon(L)},Object.defineProperty(this,"menuVisible",{get(){return e.visible},set(L){e.visible=L}}),this.onMenuVisibilityChanged=function(L){e.addEventListener(Pl.eventType.VISIBILITY_CHANGED,()=>L())},Object.defineProperty(this,"helpVisible",{get(){return e.helpVisible},set(L){e.helpVisible=L}}),this.play=function(){um()};const Tt={};this.apiUserChangeState=function(L,te){if(Sr(Tt[L],te))return;Tt[L]=Tr(te);const Fe=An(te);H(O.apiUserStateChanged[L],L,Fe),H(O.anyApiUserStateChanged,L,Fe)},this.onApiUserStateChanged=function(L,te){typeof L=="function"?(te=L,O.anyApiUserStateChanged.push(te)):et(O.apiUserStateChanged,L).push(te)},this.removeOnApiUserStateChanged=function(L,te){typeof L=="function"?(te=L,zi(te,O.anyApiUserStateChanged)):zi(te,O.apiUserStateChanged[L])},this.getApiUserState=function(L){if(L===void 0)return An(Tt);const te=Tt[L];return te===void 0?void 0:An(te)},this._meetingJoined=function(L){console.assert(I===null),I=L,H(O.meetingJoined,I)},this._isMeeting=function(){return M.urlHashContains("meeting-key")||M.urlHashContains("meeting")},this._onMeetingJoined=function(L){O.meetingJoined.push(L),I!==null&&L(I)},this._removeOnMeetingJoined=function(L){zi(L,O.meetingJoined)},this._setMeetingCameraPreviewVisibility=function(L){I!==null&&I.setCameraPreviewVisibility(L)},this._onAvatarListChanged=function(L){O.avatarListChanged.push(L)},this._removeOnAvatarListChanged=function(L){zi(L,O.avatarListChanged)},this._createPointerEventHelper=function(L){return new ul(v,L)},this._disableControls=function(){o.disable()},this._enableControls=function(){o.enable()};const ct=new ws;this._findIntersectionAtPosition=function(L,te){return c==null||c.findIntersectionAtPosition(L,te,!0,ct),ct},this.getWalkMaxSpeed=function(){return console.assert(n,"getWalkMaxSpeed must be called after the scene is loaded"),n.camera.moveMaxSpeed},this.setWalkMaxSpeed=function(L){console.assert(n,"setWalkMaxSpeed must be called after the scene is loaded"),n.camera.moveMaxSpeed=L},this.openPopup=function(L,te={},Fe=void 0){return Ur.openPopup(L,te,Fe)},this.enableMinimap=function(){console.assert(n,"enableMinimap must be called after the scene is loaded"),n.minimapConfig.enabled=!0},this.disableMinimap=function(){console.assert(n,"disableMinimap must be called after the scene is loaded"),n.minimapConfig.enabled=!1},this.isMinimapEnabled=function(){return console.assert(n,"isMinimapEnabled must be called after the scene is loaded"),n.minimapConfig.enabled},this.vrEnabled=function(){return console.assert(n,"vrEnabled must be called after the scene is loaded"),b.vrEnabled()},this.enableVr=function(){console.assert(n,"enableVr must be called after the scene is loaded"),b.vrEnabled()||b.enableVr(i.context)},this.disableVr=function(){console.assert(n,"disableVr must be called after the scene is loaded"),b.vrEnabled()&&b.disableVr()}}class eb{constructor(e,t,i,n,o,a){this.xrSession=e,this.xrReferenceSpace=t,this.xrRenderTarget=i,this.xrState=n,this.autoClearAlter=o,this.eyeCamera=a}}class tb{constructor(e,t,i,n,o,a,l){r(this,"_isBrowserXREnabled",!!navigator.xr);r(this,"_isPolyfilledXR",!1);r(this,"_xrSessionMode","immersive-vr");r(this,"_deviceAvailable",!1);r(this,"_cameraFar",M.CAMERA_MIN_FAR);r(this,"_sessionInfo");r(this,"_currentPose");r(this,"_externalRAFCallback");r(this,"_renderer");r(this,"_gamepadManager");r(this,"_onVrSupportChange");r(this,"_onHmdUpdate");r(this,"_onVrSwitching");r(this,"_onPresentChange");r(this,"_eyeMatrix",new at);r(this,"_rotationEuler",new ui);r(this,"_rotationQuaternion",new wi);r(this,"_positionVector",new F);r(this,"_xrSessionEnded",()=>{if(this._sessionInfo,this._sessionInfo.xrRenderTarget.dispose(),this._sessionInfo=void 0,this._currentPose=void 0,this._gamepadManager.removeAllXrGamepads(),this._onPresentChange(!1),this._externalRAFCallback){const e=this._externalRAFCallback;this._externalRAFCallback=void 0,e()}});r(this,"_xrInputSourcesChanged",e=>{for(const t of e.removed)t.gamepad&&this._gamepadManager.removeXrGamepad(t.gamepad);for(const t of e.added)t.gamepad&&this._gamepadManager.addXrGamepad(t.gamepad,t.handedness)});r(this,"enableVr",e=>{this._isBrowserXREnabled?this._deviceAvailable?(this._onVrSwitching(!0),this._requestNecessaryVrPermissions().then(()=>{const t="local-floor";let i,n,o,a,l,c;return e.makeXRCompatible().then(()=>navigator.xr.requestSession(this._xrSessionMode,{requiredFeatures:[t]})).then(h=>(i=h,i.requestReferenceSpace(t))).then(h=>{var u;n=h;const d=new XRWebGLLayer(i,e);o=this._renderer.createFrameBufferRenderTarget(d.framebuffer),a={baseLayer:d},(u=this._sessionInfo)!=null&&u.eyeCamera?(c=this._sessionInfo.eyeCamera,l=this._sessionInfo.autoClearAlter):(c=new As,l=new is(this._renderer)),this._sessionInfo=new eb(i,n,o,a,l,c),this._sessionInfo.xrState.depthNear=M.CAMERA_WALK_NEAR,this._updateSessionFar(),this._sessionInfo.xrSession.addEventListener("end",this._xrSessionEnded),this._isPolyfilledXR||this._sessionInfo.xrSession.addEventListener("inputsourceschange",this._xrInputSourcesChanged),this._onVrSwitching(!1),this._onPresentChange(!0)}).catch(()=>{this._onVrSwitching(!1),Gt.info("Failed to enable VR mode")})}).catch(()=>{this._onVrSwitching(!1),Gt.info("Permissions necessary for VR mode not granted")})):Gt.info("VR device not connected"):Gt.info('You need a <a href="https://mozvr.com/#start" target="_blank">VR ready browser</a>.')});var c;if(this._renderer=e,this._gamepadManager=t,this._isPolyfilledXR=i,this._onVrSupportChange=n,this._onHmdUpdate=o,this._onVrSwitching=a,this._onPresentChange=l,(Qe.https||Qe.localhost)&&this._isBrowserXREnabled){const h=()=>{var d;(d=navigator.xr)==null||d.isSessionSupported(this._xrSessionMode).then(u=>{this._deviceAvailable=u,this._onVrSupportChange(u)})};h(),(c=navigator.xr)==null||c.addEventListener("devicechange",h,!1)}else this._onVrSupportChange(!1)}_updateSessionFar(){this._sessionInfo,this._sessionInfo.xrState.depthFar=this._cameraFar,this._sessionInfo.xrSession.updateRenderState(this._sessionInfo.xrState)}setCameraFar(e){var t;this._cameraFar=e,(t=this._sessionInfo)!=null&&t.xrSession&&this._updateSessionFar()}render(e,t){this._sessionInfo,this._currentPose,this._sessionInfo.autoClearAlter.set(!1,!0,!1),this._sessionInfo.eyeCamera.matrixWorld=t;const i=this._sessionInfo.eyeCamera.projectionMatrix,n=this._currentPose.views;for(let o=0;o<n.length;++o){const a=n[o];this._eyeMatrix.fromArray(a.transform.inverse.matrix),i.fromArray(this._currentPose.transform.matrix),this._eyeMatrix.multiply(i),i.fromArray(a.projectionMatrix),i.multiply(this._eyeMatrix),this._renderer.enableScissorTest(!0);const l=this._sessionInfo.xrState.baseLayer.getViewport(a);l&&(this._renderer.setScissor(l.x,l.y,l.width,l.height),this._sessionInfo.xrRenderTarget.x=l.x,this._sessionInfo.xrRenderTarget.y=l.y,this._sessionInfo.xrRenderTarget.width=l.width,this._sessionInfo.xrRenderTarget.height=l.height),this._renderer.render(e,this._sessionInfo.eyeCamera,this._sessionInfo.xrRenderTarget),this._renderer.enableScissorTest(!1)}this._sessionInfo.autoClearAlter.restore()}_requestNecessaryVrPermissions(){const e=DeviceMotionEvent,t=DeviceOrientationEvent;return!Qe.ios||!e||!t||!e.requestPermission||!t.requestPermission?Promise.resolve():new Promise((i,n)=>{Promise.all([e.requestPermission(),t.requestPermission()]).then(o=>{o[0]==="granted"&&o[1]==="granted"?i():n()},()=>{n()})})}disableVr(){var e;(e=this._sessionInfo)==null||e.xrSession.end().then(()=>{Gt.hideInfo()},()=>{Gt.info("Failed to exit VR mode")})}vrEnabled(){var e;return!!((e=this._sessionInfo)!=null&&e.xrReferenceSpace)}requestAnimationFrame(e){const t=(i,n)=>{if(this._currentPose=n.getViewerPose(this._sessionInfo.xrReferenceSpace),this._externalRAFCallback){const o=this._externalRAFCallback;this._externalRAFCallback=void 0,o(i)}};this._externalRAFCallback=e,this._sessionInfo.xrSession.requestAnimationFrame(t)}update(){var i;if(!((i=this._sessionInfo)!=null&&i.xrSession))return;const e=this._currentPose.transform;if(e.orientation===null)return;{this._rotationEuler.setFromQuaternion(this._rotationQuaternion.set(e.orientation.x,e.orientation.y,e.orientation.z,e.orientation.w),On.YXZ);const n=this._rotationEuler.y;this._rotationEuler.y=-this._rotationEuler.z,this._rotationEuler.z=n}const t=e.position;this._onHmdUpdate(this._rotationEuler,t&&this._positionVector.set(t.x,-t.z,t.y))}}const Sn=document.getElementById("walk-canvas"),Ai=M.EDIT_MODE,ib=1/15;let Yt,Oi,Wt,lr,ji,ds,Mt,To,jt,us,Rl,Rh,Jf,Et,qr,rn,Xi,un,Vn,Rs,Bi,Yr,Ih,Is,Qr,qi=null,So=null,cr,Il,Dh,Dl=0,Ll=!1,em=!1,Lh,hr=!0,tm=!1;const wo=new Ms;function nb(s,e){return qr.renderIdle(s,e)}function sb(s,e){ri.beginSection("Integrate simulation"),e&&To.update(),M.DEV_NEW_SCENE&&Et.updateSegments(),Bi.update(s),Il&&Et.minimapConfig.enabled&&Il.update(),hr&&!e&&rn.handleCollisions(s),Vn==null||Vn.handleHover(),Rs.update(s),Mt.update(s),Et.update(),Xi==null||Xi.updateCameraHeight(s),un==null||un.updateCameraHeight(),e&&!Bi.teleportingToPoint&&(Oi.update(),jt.requestFrame()),Yr&&(e&&!To.hasGamepads()?Yr.update(s):Yr.reset());let t=M.BENCHMARK;for(const i of Et.getAnimatedRootNodes())i.update(s,Mt.cameraWorldPosition())&&(t=!0);for(const i of Et.materialManager.getAnimatedMaterials())i.isPlaying&&(i.update(s),t=!0);t&&!M.PUPPETEER_TEST&&jt.requestFrame(),Qr==null||Qr.update(s),ji._update(s),ri.endSection("Integrate simulation")}function ob(s,e){ri.createNewProfileFrame(),ri.beginSection("Tick"),So==null||So.begin(),M.PUPPETEER_TEST&&(s=1/30),s=Math.min(s,ib),sb(s,e),qr.renderToScreen(s,e),So==null||So.end(),ri.endSection("Tick")}function rb(s){s.view&&(Xi==null||Xi.disable(),Vn==null||Vn.disable())}function ab(s){Xi&&!Xi.isEnabled()&&!Oi.vrEnabled()&&Xi.enable(),un&&Oi.vrEnabled()&&un.onTeleportDone(),s.view&&Vn&&Vn.enable(),Oi.vrEnabled()&&Mt.hmdReset()}function lb(){if(Et){if(document.visibilityState==="hidden")for(const s of Et.materialManager.getAnimatedMaterials())s.sleepAnimation();else if(document.visibilityState==="visible"){for(const s of Et.materialManager.getAnimatedMaterials())s.wakeAnimation();jt.requestFrame()}}}function dr(){Qe.ios&&(document.documentElement.style.height=window.innerHeight+"px",document.body.scrollTop!==0&&window.scrollTo(0,0)),qr.resize(Oi.vrEnabled()),jt.requestFrame(),Wt.onResize()}function Fh(){return document.pointerLockElement===Sn||document.mozPointerLockElement===Sn||document.webkitPointerLockElement===Sn}function Oh(){return document.fullscreenElement||document.mozFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement||document.webkitFullscreenElement}function cb(){Fh()&&(document.exitPointerLock=document.exitPointerLock||document.mozExitPointerLock||document.webkitExitPointerLock,document.exitPointerLock&&document.exitPointerLock())}function hb(){Oh()&&(document.exitFullScreen=document.exitFullscreen||document.mozCancelFullScreen||document.msExitFullscreen||document.webkitExitFullscreen,document.exitFullScreen&&document.exitFullScreen())}function Bh(){if(Fh()){Mt.mousePressLook=!1,Wt.onPointerLockChange(!0);const s=M.GAZE_IN_POINTER_LOCK;s?wo.enableMode():wo.disableMode(),ji.anchorsVisible=s}else Mt.mousePressLook=!0,Wt.onPointerLockChange(!1),wo.disableMode(),ji.anchorsVisible=!0}function db(){Sn.requestPointerLock=Sn.requestPointerLock||Sn.mozRequestPointerLock||Sn.webkitRequestPointerLock,Sn.requestPointerLock(),document.addEventListener("pointerlockchange",Bh,!1),document.addEventListener("mozpointerlockchange",Bh,!1),document.addEventListener("webkitpointerlockchange",Bh,!1)}function Fl(){Oh()?(Wt.onFullScreenChange(!0),screen.orientation&&screen.orientation.lock&&screen.orientation.lock("landscape-primary")):Wt.onFullScreenChange(!1)}function ub(){const s=document.body;(s.mozRequestFullScreen||s.webkitRequestFullscreen||s.msRequestFullscreen||s.requestFullscreen).call(s),document.addEventListener("fullscreenchange",Fl,!1),document.addEventListener("mozfullscreenchange",Fl,!1),document.addEventListener("webkitfullscreenchange",Fl,!1),document.addEventListener("MSFullscreenChange",Fl,!1)}function im(s){Yt.uploadNewBuffers(s),jt==null||jt.requestFrame()}function fb(s){Mt=new W_(s,Sn,To,jt),Mt.mousePressLook=!0,M.FLIP_MOUSE&&(Mt.flipMouseLook=!0)}function mb(){Rs=new N_(Et,rn,Mt,Bi);const s=[ji._clickListener.bind(ji)],e=[Rs.onMeshClicked.bind(Rs)];Ai||s.push(Rs.onMeshClicked.bind(Rs)),Vn=new Q_(Rl,rn,()=>jt.requestFrame(),s,e,ji.getHoverListeners(),To,Yr)}function pb(){Oh()?hb():ub()}function _b(){Fh()?cb():db()}function nm(){Xi==null||Xi.disable(),un==null||un.enable(),Mt.mouseControlsPitch=!1,Mt.hmdReset(),Bi.onVrChange(!0),wo.enableMode(),Wt.onVrChange(!0),ji._vrChange(!0),dr()}function gb(){Mt.resetRollAngle(),Mt.resetPitchAngle(),Mt.mouseControlsPitch=!0,console.assert(!Oi.vrEnabled()),un==null||un.disable(),Xi==null||Xi.enable(),Bi.onVrChange(!1),wo.disableMode(),Wt.onVrChange(!1),ji._vrChange(!1),dr(),setTimeout(dr,1e3)}function vb(s){jt.isEnabled()&&(s?nm():gb())}function bb(s){Ai||Qe.mobile&&!M.ALLOW_MOBILE_VR||(Qe.ios||Qe.mobile&&Qe.firefox)&&Qe.inCrossOriginIframe||Wt.setVrSupported(s)}function xb(){Oi.vrEnabled()?Oi.disableVr():(Is.isRunning()&&Is.stop(),Oi.enableVr(Yt.context))}function yb(s,e){un&&e!==null&&un.onHmdPositionUpdate(e),Mt.onHmdUpdate(s,e)}function Ab(s,e){if(s&&Mt.cameraWorldPosition().set(s[0],s[1],s[2]),e){const t=new ui;t.setFromDegTriple(e),Mt.setYawAngle(t.yaw),Mt.setPitchAngle(t.pitch)}}function Eb(s){return s.every(e=>e.lightProbes.length!==0)}function sm(s){for(const e of s)lu(e.geometry)}function Tb(s,e){const t=performance.now();rn=new Hc(s,e);const i=[],n=s.getAnimatedNodeMeshes(),o=new Set(n);if(s.visitAllNodes(a=>{a.mesh&&!o.has(a.mesh)&&i.push(a.mesh)}),rn.addStaticObstacles(i),rn.addDynamicObstacles(n),sm(i),sm(n),M.DEBUG){const a=performance.now()-t;console.log(`Collider construction time: ${a}`)}}function Sb(s){const e=M.urlHashGetArgument("view");let t=null;return e&&(t=s.findViewByName(e)),t||s.allViews()[0]}function om(s){ri.endSection("SceneLoader.load"),ri.beginSection("Scene ready to display"),Et=s,Et.adjustSkiesAndCameraFarToSpanWholeScene(),Et.addEventListener(Yi.eventType.UPDATED,()=>jt.requestFrame()),Et.addEventListener(Yi.eventType.ANY_VIEW_UPDATED,()=>Wt.refresh()),Et.disableLightProbesForMaterials(),Mt.enable(),Et.threeScene.updateMatrixWorld(!0),Oi.setCameraFar(Et.camera.far),Et.camera.current instanceof As&&(Et.camera.current.aspectRatio=window.innerWidth/window.innerHeight),qr=new g1(Yt,Oi,Et,Et.exposureController),Dh=new Mv(Yt,Et),Rl=new J_(Yt.domElement,Ai),(hr||Ai)&&(Tb(Et,Mt),Mt.orbit.collider=rn),Bi=new Mn(Et,Mt,jt,Dh,rn),Bi.addEventListener(Mn.eventType.TELEPORT_STARTED,rb),Bi.addEventListener(Mn.eventType.TELEPORT_DONE,ab),Is=new Fr(Bi),hr&&Et.camera.autoClimb&&(Xi=new ig(rn,Mt,jt)),hr&&(un=new ng(Mt,rn)),Bi.switchToView(Sb(Et),0),Ih=new q_(Et,Bi),cr=new x1(Yt,Et,Mt);function e(){jt.requestFrame()}if(hr&&M.NO_GAZE_TELEPORT!==!0&&(Yr=new X_(Et,Mt,e,wo)),ji._sceneReadyToDisplay(Yt,Et,Mt,Bi,Is,rn,cr,Rh,Oi,wo,Rl,jt,ds),mb(),document.addEventListener("visibilitychange",lb),window.addEventListener("resize",function(){Qe.ios?setTimeout(dr,1e3):dr()},!1),Qe.fullScreenSupported()&&Wt.setFullScreenSupported(),Qe.pointerLockSupported()&&Wt.setPointerLockSupported(),Wt.sceneReadyToDisplay(Et,Bi,Is,cr),dr(),M.DEBUG&&(So=new j1(Yt.context)),xo(),M.DEBUG_SHARED_BUFFERS&&(Et.threeScene.overrideMaterial=new N0),M.DEBUG_GEOMETRY_MERGING&&fx(Et,!1),Et.startAutoTourOnLoad()&&Is.start(),jt.enable(),Oi.vrEnabled()&&nm(),M.PUPPETEER_TEST){const t="display:none;";document.getElementById("cover-image").style.cssText=t,document.getElementById("info-bar").style.cssText=t,document.getElementById("menu-bar").style.cssText=t,document.getElementById("view-list").style.cssText=t,document.getElementById("minimap-wrapper").style.cssText=t,document.getElementById("primary-progress").style.cssText=t,wb()}navigator.xr&&"onsessiongranted"in navigator.xr&&(navigator.xr.onsessiongranted=()=>Dt(this,null,function*(){Oi.vrEnabled()||(Is.isRunning()&&Is.stop(),Oi.enableVr(Yt.context))})),Lh=qi.elapsedLoadTimeSec(),M.DEBUG&&console.log("readyToDisplayTime:",Lh),ri.endSection("Scene ready to display")}function wb(){const s=document.createElement("div");s.style.cssText="display:none;",s.id="loading-finished-marker",document.body.appendChild(s)}function rm(s){!Ai&&!M.urlHashContains("nostats")&&Dl===0&&Wt.cover.sendStats&&Mr("./stats/"+s,null,null)}function Mb(s){let e="";for(const[t,i]of Object.entries(s))if(i!=""){const n=e.length==0?"?":"&";e+=`${n}${t}=${i}`}rm("play"+e)}function Pb(s,e){rm("loaded?readyToDisplayTime="+s.toFixed(1)+"&loadTime="+e.toFixed(1))}function Cb(s,e){const t=new Map;function i(){e.assignLightProbesToObjects()}function n(c){const h=c.target;function d(){t.delete(h),s.findLightProbe(h.id)!==null&&(e.assignLightProbesToObjects(),e.createLightProbeTexture(h,!1),jt.requestFrame())}let u=t.get(h);u===void 0&&(u=new Vu(d,1e3),t.set(h,u)),u.deferRun()}function o(c){const h=c.target;if(e.createLightProbeTexture(h,!0),!h.isBoundingBoxInitialized()){const d=h.boxMin,u=h.boxMax;d.copyFrom(h.position).addScalar(-1),u.copyFrom(h.position).addScalar(1),h.enableBoundingBox()}}function a(c){for(const h of s.materials)h.forceObjectUniformsRefresh()}function l(c){const h=c.lightProbe;e.assignLightProbesToObjects(),e.createLightProbeTexture(h,!0),h.isBoundingBoxInitialized()||h.disableBoundingBox(),h.addEventListener(Mi.eventType.BOUNDS_INIT,o),h.addEventListener(Mi.eventType.POSITION_UPDATED,n),h.addEventListener(Mi.eventType.BOUNDS_UPDATED,a)}s.addEventListener(Yi.eventType.LIGHT_PROBE_ADDED,l),s.addEventListener(Yi.eventType.LIGHT_PROBE_REMOVED,i);for(const c of s.lightProbes)c.addEventListener(Mi.eventType.POSITION_UPDATED,n),c.addEventListener(Mi.eventType.BOUNDS_INIT,o),c.addEventListener(Mi.eventType.BOUNDS_UPDATED,a)}function Rb(s,e,t){const i=new Set;function n(o){if(o===s.length){t();return}const a=s[o],l=a.name;i.has(l)?n(o+1):(i.add(l),e.monoPanoramaToServer(a,()=>n(o+1)))}n(0)}function Ib(s,e){if(s.lightProbes.length===0&&!Ai)return;let t=M.CUBEMAP_FILTER_SHADER_SAMPLES_COUNT;Qe.isLongShaderExecutionProblematicDevice()&&(t=Math.min(t,128));const i=(!Qe.mobile||M.MOBILE_HI||s.lightProbes.length<=4)&&!M.CUSTOM_LIGHT_PROBE_MAX_MIP_SIZE,n=new uh(s,Yt,i,Ai,t);if(s.lightProbes.length===0&&Ai&&s.autoAddLightProbes&&nv(s,n,e),s.lightProbes.length>0){Eb(s.gpuMeshes)||(console.warn("Some objects do not have light probes assigned, this is not optimal."),n.assignLightProbesToObjects());let o=s.allViews().findIndex(a=>a.mode!=="orbit");o===-1&&(o=0),Bi.executeWithViewVisibilitySettings(s.allViews()[o],function(){n.createAllLightProbeTextures()}),s.enableLightProbesForMaterials()}Ai?(s.sharedMaterialState.builtinSkyMesh,n.createSkyLightProbe(s.sharedMaterialState.builtinSkyMesh),Cb(s,n)):n.dispose()}function am(s){ri.beginSection("sceneLoadComplete");const e=M.urlHashContains("headless");if(Ib(s,e),s.hasLightmap()&&qr.enableAutoExposure(),s.exposureController.updateWithoutDelay(),s.exposureController.adaptExposure(!0),Ai){if(Jf=new Xl({scene:s,controls:Mt,rawRenderer:Yt,teleport:Bi,animationController:jt}),Qr=new Pt(Rl,s,rn,jt,Mt,ds),us.sendCoverToServer){const n="SwitchObjects";ds.initExtensionsByType(n);const o=ds.getExtensionsByType(n);o.forEach(a=>a.changeTriggersVisibility(!1)),cr.coverToServer(M.EDITOR_COVER_WIDTH,M.EDITOR_COVER_HEIGHT),o.forEach(a=>a.changeTriggersVisibility(!0)),ds.disposeExtensionsByType(n)}Ab(us.forcedInitialCameraPosition,us.forcedInitialCameraRotation)}Il=new Cl(Dh,s,Bi,ji);const t=new Ah(s.textureManager,lr);function i(){if(us.onSceneLoaded&&(M.EDIT_MODE,us.onSceneLoaded(new fy(s,Wt,Mt,rn,Bi,Qr,ds,cr,jt,Il,Is,Jf,t,new sg(Yt,s)))),Wt.sceneLoadComplete(),!M.PUPPETEER_TEST)for(const n of s.materialManager.getAnimatedMaterials())n.play();ji._sceneLoadComplete(),jt.requestFrame(),Pb(Lh,qi.elapsedLoadTimeSec()),qi=null}Ai&&e?Rb(qi.panoramas,cr,i):i(),ri.endSection("sceneLoadComplete")}function Db(){return M.VR_LO?bl.cardboardConfig.BUFFER_SCALE*=.5:M.VR_HI&&(bl.cardboardConfig.BUFFER_SCALE*=1.5),new WebXRPolyfill(bl)}function Uh(){Ll&&(Ll=!1,qi.load(),Wt.sceneLoadStarted(),M.SHOW_HELP_ON_LOAD&&(Wt.helpVisible=!0),Mb(Qe.getPlatformInfo()))}function Lb(){return`Your ${window.WebGLRenderingContext?"graphics card":"browser"} does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation" target="_blank">WebGL 2</a> or your browser has WebGL 2 disabled.<br/><a href="https://get.webgl.org/webgl2/" target="_blank">Find out how to get it.</a>`}function lm(s){if(Wt.updateCover(s),ds.updateConfig(s.extensions||[]),s.canForceBrotliBuffers===!0&&e0(),s.webwalkLogMode===1?(Me.logInfoMessages(),Me.initLoggingToServer(!0)):s.webwalkLogMode===2&&Me.initLoggingToServer(!1),Ai||ds.initExtensions(),ji._viewerConfigLoaded(s),s.language){const o=Pc[s.language];o?Cd(o):console.log(`Unknown language: ${s.language}`)}Ll=!0;const e=M.DEV_SHADOWMAP?new Yc(Yt):void 0,t=M.DEV_SSAO?new Qc(Yt,Qe):void 0,i=new Yi(Mt.camera(),e,t),n=new G1(M.ASSETS_URL,Yt);i.textureManager=n,Rh=new mg(Yt,i),i.exposureController=new lg(i.camera,Rh),us.assetsUrl!==void 0&&us.assetsUrl!==null&&(M.ASSETS_URL=us.assetsUrl),M.DEV_NEW_SCENE?(qi=new Yb(i,M.ASSETS_URL,Ai,lr,n,Yt),qi.onProgress=Wt.loadProgress,qi.onMeshBuffersLoaded=im,qi.onReadyToDisplay=om,qi.onComplete=am):(qi=new V1(i,M.ASSETS_URL,Ai,lr,n,Yt),qi.onProgress=Wt.loadProgress,qi.onMeshBuffersLoaded=im,qi.onReadyToDisplay=om,qi.onComplete=am),M.AUTO_PLAY||em||Dl>0?Uh():M.HIDE_PLAY||Wt.enablePlayButton(Uh)}function cm(){return!Ai&&qi===null&&Dl<=M.CONTEXT_LOST_RESTORE_LIMIT}function Fb(s){if(s.preventDefault(),Dl+=1,jt.disable(),!cm()){Gt.error("Graphics context lost, reload to retry.");return}ds.disposeExtensions(),ji._contextLost(),Ih.dispose(),Ih=null,Vn.dispose(),Vn=null,Rs&&(Rs.dispose(),Rs=null),Wt.contextLost()}function Ob(s){s.preventDefault(),cm()&&(Gt.info("Graphics context restored, reloading the scene to use the new context.",5e3),Qe.resetGlDetector(Yt.context),Qe.gl.reportToConsole(),Yt.webGLContextRestored(),lm(Wt.cover))}function Bb(){function s(e,t){let i="Failed to initialize the scene.";e==401&&t!==void 0&&(i=t),Gt.error(i)}qa(M.COVER_JSON_URL,!1,lm,s)}function hm(s){if(tm=!0,ft.onAdd=o=>{o instanceof Ye&&Yt.uploadNewBuffers(o)},us=s,hr=us.enableCameraCollisions&&!M.NO_COLLISIONS,Yt=_1(Sn),!Yt){Gt.error(Lb());return}const e=Qe.missingCapabilities();if(e){Gt.errorWithQr(e);return}Sn.addEventListener("webglcontextlost",Fb,!1),Sn.addEventListener("webglcontextrestored",Ob,!1),Wt.init(),ds=new qg;let t=null;try{t=Db()}catch(o){Me.log("Failed to initialize WebXR polyfill")}function i(o){o?jt.disable():jt.enable()}Oi=new tb(Yt,To,t?!t.nativeWebXR:!1,bb,yb,i,vb),jt=new L_(Oi,ob,nb),jt.disable();const n=new gi;fb(n),Mt.disable(),Bb()}To=new z_,Wt=new Pl(Ai,To,xb,pb,_b,!M.PUPPETEER_TEST),lr=new y1,Ai&&lr.setAllMaterialsEditable(),ji=new Zf(Ai,Wt,lr);function Ub(s){const e=document.createElement("base");e.target="_blank",document.head.appendChild(e),Pd(Object.keys(wc),function(){hm(s)})}function Nb(){return tm}function dm(s){Ai||hm(s)}function um(){Ll?Uh():em=!0}function Ui(){return Ke(ji),ji}function fm(){return Ke(rn),rn}let Nh=!1;function kb(){Nh||(Nh=!0,console.log("Reloading shaders..."),ln.reloadShaders(()=>{const s=new Map;let e=0;Et.threeScene.traverse(function(t){const i=t.material;i&&i.generateProgramId!==void 0&&s.set(i.generateProgramId(),i)});for(const t of s.values())t.tryToRefreshShaderCode()&&(Yt.recompileProgram(t),e++);Nh=!1,console.log("Updated "+e+" shaders.")}))}class kh{constructor(e,t,i){r(this,"_config");r(this,"_volumeTrigger");r(this,"_camera");r(this,"_exposureController");this._config=e,this._volumeTrigger=this._constructVolumeTrigger(e),this._camera=t,this._camera.addEventListener(gi.eventType.POSITION_CHANGED,this._volumeTrigger.onCameraPositionUpdated),this._exposureController=i}_constructVolumeTrigger(e){const t=()=>{Ui().onSceneReadyToDisplay(()=>{this._exposureController.addManualExposure(this._config.exposure,this._config.gamma,this._config.id)})},i=()=>{this._exposureController.removeManualExposure(this._config.id)};return new pn([t],[i],e)}setPriority(e){this._exposureController.setPriority(this._config.id,e)}onUpdated(){this._exposureController.updateManualExposure(this._config.exposure,this._config.gamma,this._config.id)}getCameraVolumeTrigger(){return this._volumeTrigger}get id(){return this._config.id}get name(){return this._config.name}set name(e){this._config.name=e}get exposure(){return this._config.exposure}set exposure(e){this._config.exposure=e,this.onUpdated()}get gamma(){return this._config.gamma}set gamma(e){this._config.gamma=e,this.onUpdated()}dispose(){this._camera.removeEventListener(gi.eventType.POSITION_CHANGED,this._volumeTrigger.onCameraPositionUpdated),this._volumeTrigger.dispose()}reinstate(){this._camera.addEventListener(gi.eventType.POSITION_CHANGED,this._volumeTrigger.onCameraPositionUpdated),this._volumeTrigger.reinstate()}serialize(){return Vt(Vt({},this._config),this._volumeTrigger.serialize())}}class zh{constructor(){r(this,"totalResources",0);r(this,"loadedResources",0);r(this,"totalBytes",0);r(this,"loadedBytes",0)}reset(){this.totalResources=this.loadedResources=0,this.totalBytes=this.loadedBytes=0}isFinished(){return this.totalResources==this.loadedResources}progress(){return this.totalBytes==0?0:this.loadedBytes/this.totalBytes}add(e){this.totalResources+=e.totalResources,this.loadedResources+=e.loadedResources,this.totalBytes+=e.totalBytes,this.loadedBytes+=e.loadedBytes}}const mm=(s,e)=>{const t=s%e;return s+(t==0?0:e-t)};class zb{constructor(e,t){r(this,"data");r(this,"byteOffset");this.data=e,this.byteOffset=t}readBlock(e,t){const i=new e(this.data,this.byteOffset,t);return this.byteOffset+=t*e.BYTES_PER_ELEMENT,i}alignOffset(e=4){this.byteOffset=mm(this.byteOffset,e)}}class Vb{constructor(e,t,i,n,o){r(this,"faces");r(this,"vertices");r(this,"normals");r(this,"uvs0");r(this,"uvs1");this.faces=e,this.vertices=t,this.normals=i,this.uvs0=n,this.uvs1=o}numVertices(){return this.vertices.length/3}numFaces(){return this.faces.length}}class Ol{constructor(e,t,i){r(this,"scaleFactor");r(this,"bytesPerEntry");r(this,"isInteger");this.scaleFactor=e,this.bytesPerEntry=t,this.isInteger=i}static parse(e){const t=new Float32Array(e.buffer,e.byteOffset,e.length),i=e.length/2,n=[];for(let o=0;o<i;o++){const a=t[o*2+0],l=e[o*2+1],c=l>0;n.push(new Ol(a,Math.abs(l),c))}return n}}class Gb{constructor(e){r(this,"meshFlags");r(this,"meshIndices");r(this,"meshNumFaces");r(this,"meshNumVertices");r(this,"uvs0QuantInfo");r(this,"vertsQuantInfo");r(this,"quantizedVertices");r(this,"quantizedUvs0");r(this,"normals");r(this,"encodedFaces");r(this,"encodedUvs1");const t=e.readBlock(Uint32Array,7),i=t[0],n=t[1],o=t[2],a=t[3],l=t[4],c=t[5];this.meshFlags=t[6],this.meshIndices=e.readBlock(Uint32Array,i),this.meshNumFaces=e.readBlock(Uint32Array,i),this.meshNumVertices=e.readBlock(Uint32Array,i);const h=ro(this.meshFlags,2);this.uvs0QuantInfo=Ol.parse(e.readBlock(Int32Array,h?i*2:0)),this.vertsQuantInfo=Ol.parse(e.readBlock(Int32Array,i*2)),this.quantizedVertices=e.readBlock(Uint8Array,o),this.quantizedUvs0=e.readBlock(Uint8Array,l),this.normals=e.readBlock(Int8Array,a),this.encodedFaces=e.readBlock(Uint8Array,n),this.encodedUvs1=e.readBlock(Uint8Array,c),e.alignOffset()}numMeshes(){return this.meshIndices.length}numVertices(){return this.meshNumVertices.reduce((e,t)=>e+t,0)}numFaces(){return this.meshNumFaces.reduce((e,t)=>e+t,0)}dequantizeUvs0(e){const t=this.numMeshes(),i=new Float32Array(e*2),n=new Array(t);if(n.fill(!1,0,t),e==0)return[null,n];const o=this.quantizedUvs0,a=new Uint32Array(o.buffer,o.byteOffset,o.byteLength/4),l=new Float32Array(o.buffer,o.byteOffset,o.byteLength/4);let c=0,h=0;for(let d=0;d<t;d++){const u=this.uvs0QuantInfo[d],m=this.meshNumVertices[d];if(u.isInteger){for(let g=0;g<m;g++){const b=a[c+g];i[h+g*2+0]=(b&65535)*u.scaleFactor,i[h+g*2+1]=(b>>16)*u.scaleFactor}c+=m}else{for(let g=0;g<m*2;g++){const b=l[c+g];i[h+g]=b,n[d]=b<0||b>1}c+=m*2}h+=m*2}return[i,n]}dequantizeVertices(e){const t=this.numMeshes(),i=new Float32Array(e*3),n=this.quantizedVertices;let o=0,a=0;for(let l=0;l<t;l++){const c=this.vertsQuantInfo[l],d=this.meshNumVertices[l]*3;if(Pe(c.isInteger),c.bytesPerEntry==1){const u=new Int8Array(n.buffer,n.byteOffset+o,d);for(let m=0;m<d;m++)i[a+m]=u[m]*c.scaleFactor}else if(c.bytesPerEntry==2){const u=new Int16Array(n.buffer,n.byteOffset+o,d);for(let m=0;m<d;m++)i[a+m]=u[m]*c.scaleFactor}else{Pe(c.bytesPerEntry==4);const u=new Int32Array(n.buffer,n.byteOffset+o,d);for(let m=0;m<d;m++)i[a+m]=u[m]*c.scaleFactor}o=mm(o+d*c.bytesPerEntry,4),a+=d}return i}parse(e){const t=this.numVertices(),i=this.numFaces(),n=this.quantizedUvs0.byteLength>0,o=this.encodedUvs1.byteLength>0,a=i*3,l=this.dequantizeVertices(t),c=this.normals,[h]=this.dequantizeUvs0(n?t:0),d=new Uint8Array(o?t*4:0);t>0&&o&&e.decodeVertexBuffer(d,t,4,this.encodedUvs1);const u=d.byteLength/2,m=u==0?null:new Uint16Array(d.buffer,d.byteOffset,u),g=new Uint32Array(a);if(a>0){const b=new Uint8Array(g.buffer,g.byteOffset,g.byteLength);e.decodeIndexBuffer(b,a,4,this.encodedFaces)}return new Vb(g,l,c,h,m)}}class Hb{constructor(e){r(this,"meshInstanceIndices");r(this,"meshIndices");r(this,"nodeIndices");r(this,"materialIndices");r(this,"lightmapIndices");r(this,"uv1Transforms");r(this,"transforms");const i=e.readBlock(Uint32Array,1)[0];this.meshInstanceIndices=e.readBlock(Uint32Array,i),this.meshIndices=e.readBlock(Uint32Array,i),this.nodeIndices=e.readBlock(Uint32Array,i),this.materialIndices=e.readBlock(Uint16Array,i),this.lightmapIndices=e.readBlock(Uint8Array,i),e.alignOffset(),this.uv1Transforms=e.readBlock(Float32Array,i*4),this.transforms=e.readBlock(Float32Array,i*12)}numMeshInstances(){return this.meshInstanceIndices.length}}class Wb{constructor(e){r(this,"numSegments");r(this,"boundingBoxes");r(this,"segmentNumTextureSegments");r(this,"textureIndices");r(this,"initialSegments");const t=e.readBlock(Uint32Array,3);this.numSegments=t[0];const i=t[1],n=t[2];this.boundingBoxes=e.readBlock(Float32Array,this.numSegments*6),this.segmentNumTextureSegments=e.readBlock(Uint16Array,this.numSegments),this.textureIndices=e.readBlock(Uint16Array,n),this.initialSegments=e.readBlock(Uint16Array,i)}parseTexturesMap(){const e=new Array(this.numSegments);let t=0;for(let i=0;i<this.numSegments;i++){const n=this.segmentNumTextureSegments[i],o=new Array(n);for(let a=0;a<n;a++)o[a]=this.textureIndices[t+a];e[i]=o,t+=n}return e}}class jb{constructor(e){r(this,"numTextures");r(this,"numLightmaps");r(this,"textureNameLengths");r(this,"textureNames");const t=e.readBlock(Uint32Array,3);this.numTextures=t[0],this.numLightmaps=t[1];const i=t[2];this.textureNameLengths=e.readBlock(Uint8Array,this.numTextures),this.textureNames=e.readBlock(Uint8Array,i)}parse(){const e=new Array(this.numTextures),t=new TextDecoder;let i=0;for(let n=0;n<this.numTextures;n++){const o=this.textureNameLengths[n],a=this.textureNames.subarray(i,i+o);e[n]=t.decode(a),i+=o}return e}}class Xb{constructor(e){r(this,"data");r(this,"segmentIdx");r(this,"meshesChunks");r(this,"meshInstancesChunks");r(this,"segmentsChunk");r(this,"texturesChunk");const i=new DataView(e,0,16),n=i.getUint32(0,!0),o=i.getUint16(4,!0),a=i.getUint16(6,!0),l=i.getUint32(8,!0);this.segmentIdx=i.getInt32(12,!0),Pe(n==1802528883),Pe(o==1&&a==0),this.data=e,this.meshesChunks=[],this.meshInstancesChunks=[];let c,h;const d={0:E=>this.meshesChunks.push(new Gb(E)),1:E=>this.meshInstancesChunks.push(new Hb(E)),2:E=>{Pe(!c,"Only single SegmentsChunk is allowed in Package"),c=new Wb(E)},3:E=>{Pe(!h,"Only single TexturesChunk is allowed in Package"),h=new jb(E)}},u=new zb(e,16),m=u.readBlock(Uint8Array,l);u.alignOffset();const g=u.readBlock(Uint32Array,l);for(let E=0;E<l;E++){const w=m[E],C=u.byteOffset+g[E];d[w](u),u.byteOffset=C}this.segmentsChunk=c,this.texturesChunk=h;const b=this.meshesChunks.reduce((E,w)=>E+w.meshIndices.length,0),x=this.meshInstancesChunks.reduce((E,w)=>E+w.meshInstanceIndices.length,0),v=this.segmentsChunk?this.segmentsChunk.numSegments:0;console.log(`ScenePackage ${this.segmentIdx}: meshes:${b} instances:${x} segments:${v}`)}}class qb{constructor(e,t){r(this,"_assetsUrl");this._assetsUrl=e,this.load(-1,t)}load(e,t){console.assert(e>=-1);const i=Date.now(),n=c=>{const h=new Xb(c),d=Date.now()-i;console.log(`Loaded segment ${e}: size:${c.byteLength} in: ${d} ms`),t(e,h)},o=()=>{console.log("Failed to load segment: "+e)},a=c=>{},l=this._assetsUrl+(e==-1?"shared.buf":"segment"+e+".buf");uo(M.LOAD_PRIORITY.CORE_RESOURCE,l,!0,n,o,a,!0)}}class Yb{constructor(e,t,i,n,o,a){r(this,"onProgress");r(this,"onMeshBuffersLoaded",null);r(this,"onReadyToDisplay");r(this,"onComplete");r(this,"panoramas");r(this,"_scene");r(this,"_assetsUrl");r(this,"_editMode");r(this,"_mergeConfig");r(this,"_textureManager");r(this,"_segmentManager");r(this,"_rawRenderer");r(this,"_timer",new yo);r(this,"_segmentLoader");r(this,"_initialSegment");r(this,"_readyToDisplayCalled",!1);r(this,"_sceneJson");r(this,"_meshOptCompiled",!1);r(this,"_nextInitStep");r(this,"_timeout");r(this,"updateProgress",()=>{var i,n;this._timeout!==void 0&&clearTimeout(this._timeout);const e=new zh;e.add(this._textureManager.loadingProgress());const t=(i=this._segmentManager)==null?void 0:i.loadingProgress();t&&e.add(t),(n=this.onProgress)==null||n.call(this,e.progress()),this._timeout=setTimeout(this.updateProgress,50)});Pe(M.DEV_NEW_SCENE),this._scene=e,this._assetsUrl=t,this._editMode=i,this._mergeConfig=n,this._textureManager=o,this._rawRenderer=a,this.panoramas=[]}readyToDisplay(){var e;this._readyToDisplayCalled||(this._readyToDisplayCalled=!0,(e=this.onReadyToDisplay)==null||e.call(this,this._scene))}load(){const e=()=>{this._textureManager.loadingProgress().isFinished()&&Ga(()=>{var l;this._textureManager.freeLoadingBuffers(),this._textureManager.onTextureLoaded=void 0,this.readyToDisplay(),(l=this.onComplete)==null||l.call(this,this._scene)})},t=()=>{var d;if(!this._sceneJson)return;this._nextInitStep=i;const l=this._scene,c=new tn(this._sceneJson);l.autoAddLightProbes=c.parseBoolean("autoAddLightProbes",l.autoAddLightProbes),l.interactionPrompt=c.parseBoolean("interactionPrompt",l.interactionPrompt);const h=c.child("autoTour");l.autoTour.disabled=h.parseBoolean("disabled",!1),l.autoTour.startOnLoad=h.parseBoolean("startOnLoad",!1),l.lightManager.load(this._sceneJson),l.camera.setFromJson(c.parseObject("camera")),c.parseObjects("cameraVolumes").forEach(u=>l.addCameraAdjustmentVolume(new kh(u,l.camera,l.exposureController))),c.parseObjects("views").forEach(u=>l.addView(new Hi(u,this._scene.center))),this._scene.createDefaultViews(),l.addNodeConfigsFromJson(this._sceneJson,this._mergeConfig),l.addNodesFromJson(this._sceneJson),(d=this._nextInitStep)==null||d.call(this)},i=()=>{var b;const l=this._sceneJson,c=this._scene;if(!l||!this._meshOptCompiled||!this._segmentLoader||!this._initialSegment)return;const h=new tn(l),d=h.parseObjects("atlases");Pe(d==null||d.length==0),this._textureManager.onTextureLoaded=x=>{var v;return(v=this._nextInitStep)==null?void 0:v.call(this)},new Ah(this._textureManager,this._mergeConfig,!0).load(l,this._scene.materialManager),c.disableLightProbesForMaterials(),c.initSegmentManager(this._segmentLoader,ts,this._initialSegment),this._nextInitStep=e;const m=h.child("camera").parseObject("lutTexture");m&&(c.camera.colorMap=this._textureManager.loadColorMap(m)),c.lightmapLayoutVersion=h.child("lightmap").parseNumber("lightmapLayoutVersion",0),new Vh(this._textureManager).load(l.skies||[],c),c.findSkyMesh(M.EDITOR_CONTROLLED_SKY_NAME)===null&&console.error("A sky with name "+M.EDITOR_CONTROLLED_SKY_NAME+" is missing."),this.panoramas=h.parseObjects("panoramas"),c.minimapConfig=new Wr(l,c.boundingBox),this._sceneJson=void 0,(b=this._nextInitStep)==null||b.call(this)};this._timer.reset(),this._nextInitStep=t;const n=l=>{var c;this._sceneJson=l,(c=this._nextInitStep)==null||c.call(this)},o=()=>Gt.sceneLoadError();uo(M.LOAD_PRIORITY.CORE_RESOURCE,this._assetsUrl+"scene.json",!1,n,o);const a=(l,c)=>{var h;this._initialSegment=c,(h=this._nextInitStep)==null||h.call(this)};if(this._segmentLoader=new qb(this._assetsUrl,a),!M.NO_BRDFLUT&&!Qe.isLongShaderExecutionProblematicDevice()){const l=Qe.ios?512:2048,c=gf(this._rawRenderer,l);this._scene.addBrdfLUT(c)}ts.ready.then(()=>{var l;this._meshOptCompiled=!0,(l=this._nextInitStep)==null||l.call(this)}),this.updateProgress()}elapsedLoadTimeSec(){return this._timer.elapsedSec()}}class Vh{constructor(e){r(this,"_textureManager");this._textureManager=e}loadSkyTexture(e){e.id,this._textureManager.remove(e.id);const t=this._textureManager.load(e,nn.NONE,M.LOAD_PRIORITY.SKY);return t.anisotropy=dt.NO_ANISOTROPY,t}loadSingleSky(e,t){let i;return e.type===Cs.PROCEDURAL||e.type===void 0?i=this._createProceduralSkyMesh(e):e.type===Cs.EQUIRECT?i=this._createEquirectSkyMesh(e):(console.warn("Unknown sky type: ",e.type),i=this._createProceduralSkyMesh(e)),i.fog=t,i}load(e,t){const i=new Ir(e[0].fog);t.addFog(i);const n=this.loadSingleSky({name:M.DEFAULT_SKY_NAME,type:Cs.PROCEDURAL},i);t.addSkyMesh(n),e.forEach(o=>t.addSkyMesh(this.loadSingleSky(o,i)))}_createSphereSkyMesh(e,t,i){const n=nt.createSphere(1,64,64);return new zr(e,n,t,i)}_createProceduralSkyMesh(e){const t=new Nc;return e.proceduralMaterial&&t.loadFromJson(e.proceduralMaterial),this._createSphereSkyMesh(e.name,t,e.center)}_createEquirectSkyMesh(e){const t=new Jd;t.map=e.texture instanceof dt?e.texture:this.loadSkyTexture(e.texture);const i=this._createSphereSkyMesh(e.name,t,e.center);return i.geometry.applyMatrix(new at().makeScale(1,1,-1)),i.rotation.x=Math.PI/2,i.yawRotationDeg=e.yawRotation||0,i}}const pm=function(){function s(e,t){return{formatIdx:e,gpuFormat:t}}return{ETC1:s(0,Be.RGB_ETC1),BC1:s(2,Be.RGB_DXT1),BC3:s(3,Be.RGBA_DXT5),PVRTC1_4_RGB:s(8,Be.RGB_PVRTC_4BPPV1),PVRTC1_4_RGBA:s(9,Be.RGBA_PVRTC_4BPPV1),ASTC_4x4:s(10,Be.RGBA_ASTC_4x4_KHR),RGBA8:s(13,Be.RGBA8)}}();function _m(s,e,t,i,n){s({wasmBinary:e}).then(o=>{o.initializeBasis();function a(c,h,d){const u=h===d,m=Math.log2(h)%1===0&&Math.log2(d)%1===0;return i.dxtTextures?c?t.BC3:t.BC1:i.pvrtcTextures&&u&&m?c?t.PVRTC1_4_RGBA:t.PVRTC1_4_RGB:i.etc1Textures&&!c?t.ETC1:i.astcTextures?t.ASTC_4x4:t.RGBA8}function l(c){const h=new o.BasisFile(new self.Uint8Array(c));function d(){h.close(),h.delete()}const u=(U,z)=>{if(!U)throw d(),"Error in .basis file: "+z},m=h.getHasAlpha(),g=h.getNumImages(),b=h.getNumLevels(0),x=h.getImageWidth(0,0),v=h.getImageHeight(0,0);u(x!==0&&v!==0&&b!==0,"invalid dimensions"),u(g===1,"invalid number of images");const E=0,w=a(m,x,v),C=w.formatIdx;let I=h.startTranscoding();u(I,"startTranscoding failed");const O=[];for(let U=0;U<b;++U){const z=h.getImageWidth(E,U),ie=h.getImageHeight(E,U),J=h.getImageTranscodedSizeInBytes(E,U,C),re=new self.Uint8Array(new self.ArrayBuffer(J));I=h.transcodeImage(re,E,U,C,0,m),u(I,"transcodeImage failed"),O.push({data:re,width:z,height:ie})}return d(),{gpuFormat:w.gpuFormat,mipmaps:O}}n(l)})}function Qb(s,e,t,i){const n=new window.Worker(s);let o=null;const a={processItem:function(h){console.assert(!o),o=h,n.postMessage(h.texBuffer,[h.texBuffer])},terminate:function(){console.assert(!o),n.terminate()}},l=function(h){throw"Worker error @L"+h.lineno+": "+h.message};n.addEventListener("error",l);const c=function(){n.removeEventListener("error",l),n.removeEventListener("message",c),n.addEventListener("error",function(h){const d="Worker error @L"+h.lineno+": "+h.message;o&&(o.onError(d),o=null)}),n.addEventListener("message",function(h){console.assert(o),o.onSuccess(h.data),o=null,i(a)}),t(),i(a)};n.addEventListener("message",c),n.postMessage(e)}function Kb(s,e,t,i){const n=`
self.importScripts(`+JSON.stringify(s)+`);
const initBasis = `+_m.toString()+`;
const basisFormats = `+JSON.stringify(pm)+`;
const glDetector = `+JSON.stringify({astcTextures:e.gl.astcTextures,dxtTextures:e.gl.dxtTextures,etc1Textures:e.gl.etc1Textures,pvrtcTextures:e.gl.pvrtcTextures})+`;

function initHandler(evt) {
  self.removeEventListener('message', initHandler);

  const wasmBinary = evt.data;
  initBasis(BASIS, wasmBinary, basisFormats, glDetector,
            decodeTexBuffer => {
    self.addEventListener('message', function(evt) {
        const texBuffer = evt.data;
        const texDatas = decodeTexBuffer(texBuffer);
        // second argument to transfer ownership to the main thread
        self.postMessage(texDatas, texDatas.mipmaps.map(t => t.data.buffer));
    });
    self.postMessage({}); // communicate end of init
  });
}

self.addEventListener('message', initHandler);
`,o=window.URL.createObjectURL(new window.Blob([n]));let a=!1,l=0;const c=[],h=[],d=new Vu(()=>{for(const m of c)m.terminate();l-=c.length,c.length=0},5e3);function u(){d.deferRun(),h.length!==0&&(c.length>0?(c.pop().processItem(h.pop()),u()):l<i&&!a&&(l++,a=!0,Qb(o,t,()=>{a=!1},b=>{c.push(b),u()})))}return function(g,b,x){h.push({texBuffer:g,onSuccess:b,onError:x}),u()}}function $b(s,e){qa(ii("lib/basis/basis_transcoder.wasm"),!0,function(t){const i=ii("lib/basis/basis_transcoder.js"),n=s.basisDecodeWorkers;if(n<=0){const o=window.document.createElement("script");o.addEventListener("load",function a(){o.removeEventListener("load",a),_m(window.BASIS,t,pm,s.gl,l=>{e(function(c,h,d){try{h(l(c))}catch(u){d(u)}})})}),o.src=i,window.document.head.appendChild(o)}else e(Kb(i,s,t,n))},t=>{throw t})}function Zb(s){if(!(window.WebAssembly&&(s.gl.pvrtcTextures||s.gl.etc1Textures||s.gl.dxtTextures||s.gl.astcTextures)))return;const e=[];let t=(...o)=>{e.push(o)};function i(o){t=o,e.forEach(a=>t(...a)),e.length=0}let n=!1;return{load:function(o,a,l,c){const h=()=>c(o);n||(n=!0,$b(s,i)),a(function(d){t(d,function(u){const m=u.mipmaps;o.format=u.gpuFormat,o.mipmaps=m.map(g=>new fo(g.data,g.width,g.height)),o.width=m[0].width,o.height=m[0].height,o.minFilter=m.length===1?Z.LINEAR:Z.LINEAR_MIPMAP_LINEAR,o.flipY=!1,o.generateMipmaps=!1,o.needsUpdate=!0,l(o)},h)},h)}}}let gm=!1;function Jb(s,e,t,i){function n(a){const l=a.sigBytes,c=a.words,h=new Uint8Array(l);let d=0,u=0;for(;d!==l;){let m=c[u++];if(h[d++]=(m&4278190080)>>>24,d===l||(h[d++]=(m&16711680)>>>16,d===l)||(h[d++]=(m&65280)>>>8,d===l))break;h[d++]=m&255}return h}function o(){gm=!0;const a=CryptoJS.lib.WordArray.create(s),l=a.clone();l.sigBytes=16,l.clamp(),a.words.splice(0,4),a.sigBytes-=16;const c=CryptoJS.enc.Base64.parse(e),h=CryptoJS.AES.decrypt({ciphertext:a},c,{iv:l,mode:CryptoJS.mode.CFB}),d=n(h);t(d.buffer)}gm?o():ho(ii("lib/crypto-js.min.js"),o,()=>Gt.error("Cannot load required library"))}function ex(s){const i=[],n=(v,E)=>{if(!v)throw"Error in .ktx file: "+E},o=new Int32Array(s,0,16);n(o[3]===67305985,"endianness mismatch"),n(o[4]===0&&o[5]===1&&o[6]===0,"invalid header");let a,l;o[7]===35842?(l=6408,a=Be.RGBA_PVRTC_4BPPV1):o[7]===36196?(l=6407,a=Be.RGB_ETC1):o[7]===33776?(l=6407,a=Be.RGB_DXT1):o[7]===33779?(l=6408,a=Be.RGBA_DXT5):n(!1,"unknown internal format: "+o[7]),n(o[8]===l,"invalid base internal format: ",o[8]);const c=o[9],h=o[10];n((c&c-1)===0&&(h&h-1)===0,"non power-of-two size: "+c+" "+h),n(o[11]===0&&o[12]===0&&o[13]===1,"invalid header");const d=o[14],u=o[15];n(u%4===0,"invalid header");let m=4*16+u;const g=new DataView(s,0);let b=c,x=h;for(let v=0;v<d;++v){const E=g.getUint32(m,!0);m+=4;const w=new Uint8Array(s,m,E);i.push({data:w,width:b,height:x});const C=3-(E+3)%4;m+=E+C,b=Math.max(b/2,1),x=Math.max(x/2,1)}return n(m===s.byteLength,"invalid data size"),{format:a,width:c,height:h,mipmapCount:d,mipmaps:i}}function tx(){this.load=function(s,e,t,i,n){const o=[];s.flipY=!1,s.generateMipmaps=!1,s.image=o;function a(l){let c;try{c=ex(l)}catch(h){console.error(h),n(s);return}if(c.isCubemap){const h=c.mipmaps.length/c.mipmapCount;for(let d=0;d<h;d+=1){o[d]={mipmaps:[]};for(let u=0;u<c.mipmapCount;u+=1)o[d].mipmaps.push(c.mipmaps[d*c.mipmapCount+u]),o[d].format=c.format,o[d].width=c.width,o[d].height=c.height}}else s.image.width=c.width,s.image.height=c.height,s.mipmaps=c.mipmaps.map(h=>new fo(h.data,h.width,h.height));c.mipmapCount===1&&(s.minFilter=Z.LINEAR),s.format=c.format,s.width=c.width,s.height=c.height,i&&i(s)}uo(e,t,!0,a,n)}}function Mo(s,e){return s.indexOf(e)>-1}function vm(s,e){return function(t,i){uo(s,e,!0,t,i)}}function bm(s,e,t){return function(i,n){vm(s,e)(function(a){Jb(a,t,i)},n)}}function ix(s,e,t,i,n,o,a){const l=()=>o(s);s.format=i;function c(h){s.image=h,s.width=h.width,s.height=h.height,n(s)}return a!==void 0?bm(e,t,a)(function(d){const u=new Uint8Array(d),m=t.endsWith("png")?"image/png":t.endsWith("webp")?"image/webp":"image/jpeg",g=new Blob([u],{type:m}),x=(window.URL||window.webkitURL).createObjectURL(g),v=new Image;v.onload=function(){c(v)},v.src=x},l):Ld(e,t,c,l),s}function nx(s,e,t,i,n,o){s.format=i;function a(l){s.video=l,s.width=l.videoWidth,s.height=l.videoHeight,n(s),s.pauseWhenLoaded&&(s.pause(),s.rewind())}a0(e,t,a,()=>o(s))}class sx{constructor(e){r(this,"ios");r(this,"mobile");r(this,"pvrtc");r(this,"etc1");r(this,"dxt");this.ios=e.ios,this.mobile=e.mobile,this.pvrtc=e.gl.pvrtcTextures,this.etc1=e.gl.etc1Textures,this.dxt=e.gl.dxtTextures}}class ox{constructor(e,t,i,n,o,a){r(this,"_assetsUrl");r(this,"_onTextureLoaded");r(this,"_onTextureLoadFailed");r(this,"_onTextureLoadFailedSoft");r(this,"_onVideoTextureLoadFailed");r(this,"_basisLoader");r(this,"_ktxLoader");r(this,"_platformInfo");this._ktxLoader=new tx,M.NO_BASIS||(this._basisLoader=Zb(t)),this._onTextureLoaded=i,this._onTextureLoadFailed=n,this._onTextureLoadFailedSoft=o,this._onVideoTextureLoadFailed=a,this._platformInfo=new sx(t),this._assetsUrl=e}getTexturePath(e){const t=e.id,i=e.webFormats;if(Pe(i.length>0,"No web format for texture: "+e.id+"."+e.rawExt),e.url)return e.url;if(e instanceof Yo)return this._assetsUrl+"video/"+i[0]+"/"+t+"."+e.stdExt;const n=this._assetsUrl+"img/",o=this._platformInfo.ios&&e.encoding;if(this._basisLoader&&!o){if(!this._platformInfo.mobile&&Mo(i,"large/basis"))return n+"large/basis/"+t+".basis";if(Mo(i,"small/basis"))return n+"small/basis/"+t+".basis"}if(this._platformInfo.pvrtc&&!o&&Mo(i,"small/pvr"))return n+"small/pvr/"+t+".ktx";if(this._platformInfo.etc1&&Mo(i,"small/etc1"))return n+"small/etc1/"+t+".ktx";if(this._platformInfo.dxt&&Mo(i,"large/dxt"))return n+"large/dxt/"+t+".ktx";const a=Mo(i,"small/std");return Mo(i,"large/std")&&(!this._platformInfo.mobile||!a)?n+"large/std/"+t+"."+e.stdExt:n+"small/std/"+t+"."+e.stdExt}loadIntDataTexture(e,t,i,n,o,a){e.anisotropy=dt.NO_ANISOTROPY;const l=()=>a(e);function c(h){const d=new Uint8Array(h,0,h.byteLength),u=d[0],m=d[1];Pe(e.image instanceof fo),e.image.width=Math.pow(2,u),e.image.height=Math.pow(2,m),e.format=n,e.image.data=d.subarray(2),o&&o(e)}uo(t,i,!0,c,l)}load(e,t,i=!1){Ke(e.loadingStatus==ys.NOT_LOADED||e.loadingStatus==ys.POSTPONED),e.loadingStatus=ys.IN_PROGRESS;const n=e.hasAlpha?Be.RGBA8:Be.RGB8,o=this.getTexturePath(e),a=/\.basis$/.test(o),l=/\.ktx$/.test(o),c=/\.buf$/.test(o),h=e instanceof Yo,d=!(l||c||h),u=b=>{console.error("Error while loading texture: ",o),(i?this._onTextureLoadFailedSoft:this._onTextureLoadFailed)(b)},m=b=>{console.error("Error while loading video texture: ",o),this._onVideoTextureLoadFailed(b)},g=b=>{b.needsUpdate=!0,this._onTextureLoaded(b),b.notifyLoaded()};if(c)this.loadIntDataTexture(e,t,o,n,g,u);else if(a&&this._basisLoader){let b;e.passphrase===void 0?b=vm(t,o):b=bm(t,o,e.passphrase),this._basisLoader.load(e,b,g,u)}else l?this._ktxLoader.load(e,t,o,g,u):d?ix(e,t,o,n,g,u,e.passphrase):(Pe(h),nx(e,M.LOAD_PRIORITY.VIDEO,o,n,g,m))}}class rx{constructor(e,t,i,n){r(this,"numVertices");r(this,"numIndices");r(this,"vertexOffset");r(this,"indexOffset");this.numVertices=e,this.numIndices=t,this.vertexOffset=i,this.indexOffset=n}}class ax{constructor(e,t,i,n){r(this,"boundingBox");r(this,"geometryRange");r(this,"segmentIdx");r(this,"geometryIdx");this.boundingBox=e,this.geometryRange=t,this.segmentIdx=i,this.geometryIdx=n}}class Gh{constructor(e,t,i,n,o,a,l){r(this,"meshIdx");r(this,"nodeIdx");r(this,"materialId");r(this,"lightmapIdx");r(this,"transform");r(this,"uv1Transform");r(this,"boundingBox");this.meshIdx=e,this.nodeIdx=t,this.materialId=i,this.transform=o,this.uv1Transform=a,this.boundingBox=l,this.lightmapIdx=n}}r(Gh,"invalidLightmapIdx",255);class Bl{constructor(e,t,i){r(this,"geometries");r(this,"meshes");r(this,"meshInstances");this.geometries=e,this.meshes=t,this.meshInstances=i}static parse(e,t){const i=Date.now(),n=new Array,o=new Map,a=new Map;for(const c of e.meshesChunks){const h=c.parse(t),d=new Jo;d.vertexCnt=c.numVertices(),d.indexCnt=c.numFaces()*3,d.vertices=h.vertices,d.normals=h.normals,d.index=h.faces,d.indexUint=!0,d.uvs0=h.uvs0,d.uvs1=h.uvs1,d.addCoreAttributes(),d.uvs0!==null&&d.addUv0Attribute(),d.uvs1!==null&&d.addUv1Attribute();const u=n.length;n.push(d);let m=0,g=0;for(let b=0;b<c.numMeshes();b++){const x=new ti,v=c.meshNumVertices[b],E=c.meshNumFaces[b]*3,w=new rx(v,E,m,g);m+=v,g+=E,o.set(c.meshIndices[b],new ax(x,w,e.segmentIdx,u))}}for(const c of e.meshInstancesChunks)for(let h=0;h<c.numMeshInstances();h++)a.set(h,Bl._parseInstance(c,h));const l=Date.now()-i;return console.log(`Parsing SegmentChunk(${e.segmentIdx}): time: ${l} ms`),new Bl(n,o,a)}static _parseInstance(e,t){const i=new ti,n=new Float32Array(16);for(let a=0;a<12;a++)n[a]=e.transforms[t*12+a];n[12]=n[13]=n[14]=0,n[15]=1;const o=new Float32Array(4);for(let a=0;a<4;a++)o[a]=e.uv1Transforms[t*4+(a+2)%4];return new Gh(e.meshIndices[t],e.nodeIndices[t],e.materialIndices[t],e.lightmapIndices[t],n,o,i)}}function lx(s,e,t){const i=[65433,2293759,13395711,16737945,16763904,13395609,13421568],n=Oc();n.baseColor=new be(i[t%i.length]).convertGammaToLinear(),n.setUniforms();const o=new Ye(nt.createBox(1,1,1),n);return o.position.addVectors(e.min,e.max).multiplyScalar(.5),o.scale.subVectors(e.max,e.min).multiplyScalar(1),o.updateMatrixWorld(),s.addAuxiliaryObject(o),o}class cx{constructor(e,t,i){r(this,"meshes",[]);r(this,"bboxMesh");for(const n of e.meshInstances.values()){const o=e.meshes.get(n.meshIdx),a=o.geometryRange,l=e.geometries[o.geometryIdx],c=new cl(a.numIndices,a.numVertices,l),h=n.uv1Transform.slice(),d=65535;h[2]*=1/d,h[3]*=1/d,c.defaultAttributeValues=new zd,c.defaultAttributeValues.uv1Mod=h,c.boundingBox=n.boundingBox,c.boundingSphere=c.boundingBox.getBoundingSphere(),c.vertexAttribOffset=a.vertexOffset,c.indexOffset=a.indexOffset;const u=t.materialManager.getMaterial(n.materialId),m=new Bn(t.findNode(n.nodeIdx),c,u);if(m.matrixWorld=new at,m.matrixWorld.elements=n.transform,m.matrixWorld=m.matrixWorld.transpose(),i.length>0){const g=n.lightmapIdx==Gh.invalidLightmapIdx?0:n.lightmapIdx;Pe(g>=0&&g<i.length),m.lightmap=i[g]}this.meshes.push(m),t.addGpuMesh(m)}}}const xm=2*1024*1024;class hx{constructor(e,t,i,n){r(this,"numSegments");r(this,"_segmentBoundingBoxes",[]);r(this,"_segmentPackages",[]);r(this,"_loadingSegments",[]);r(this,"_segments",[]);r(this,"_segmentRenderables",[]);r(this,"_meshoptDecoder");r(this,"_loader");r(this,"_loadingProgress",new zh);r(this,"_textureManager");r(this,"_textureNames");r(this,"_texturesMap");r(this,"_segmentVisBoxes",new Array);r(this,"_onSegmentLoaded",(e,t)=>{const i=this._loadingSegments.indexOf(e);Pe(i!=-1),this._loadingSegments.splice(i,1),this._segmentPackages[e]=t;const n=Bl.parse(t,this._meshoptDecoder);this._segments[e]=n,this._loadingProgress.loadedBytes+=xm,this._loadingProgress.loadedResources++});var a,l;this._loader=t,this._meshoptDecoder=i,this._textureManager=e,Pe(n.segmentsChunk);const o=n.segmentsChunk;this.numSegments=o.numSegments;for(let c=0;c<this.numSegments;c++){const h=new F(o.boundingBoxes[c*6+0],o.boundingBoxes[c*6+1],o.boundingBoxes[c*6+2]),d=new F(o.boundingBoxes[c*6+3],o.boundingBoxes[c*6+4],o.boundingBoxes[c*6+5]);this._segmentBoundingBoxes.push(new ti(h,d)),this._segmentPackages.push(void 0),this._segments.push(void 0)}this._textureNames=(a=n.texturesChunk)==null?void 0:a.parse(),this._texturesMap=(l=n.segmentsChunk)==null?void 0:l.parseTexturesMap()}visibleSegments(e){const t=[];for(let i=0;i<this.numSegments;i++)e.intersectsBox(this._segmentBoundingBoxes[i])&&t.push(i);return t}isLoaded(e){return console.assert(e>=0&&e<this.numSegments),this._segmentPackages[e]!==void 0}areTexturesLoaded(e){if(!this._texturesMap||!this._textureNames)return!1;const t=i=>{const n=this._textureManager.findTexture(this._textureNames[i]);return n&&n.loaded};return this._texturesMap[e].every(t)}loadSegment(e){if(!(this.isLoaded(e)||this._loadingSegments.includes(e))&&(this._loadingSegments.push(e),this._loader.load(e,this._onSegmentLoaded),this._loadingProgress.totalBytes+=xm,this._loadingProgress.totalResources++,this._texturesMap&&this._textureNames)){const t=this._texturesMap[e].map(i=>this._textureNames[i]);this._textureManager.loadPostponed(t)}}loadVisibleSegments(e){for(const t of this.visibleSegments(e))this.loadSegment(t)}loadAllSegments(){for(let e=0;e<this.numSegments;e++)this.loadSegment(e)}updateRenderables(e,t){for(let i=0;i<this.numSegments;i++){if(this._segments[i]!==void 0&&this._segmentRenderables[i]===void 0){if(!this.areTexturesLoaded(i))continue;const a=new cx(this._segments[i],e,t);this._segmentRenderables[i]=a}const n=!this.isLoaded(i),o=this._segmentVisBoxes[i]!==void 0;n&&!o&&(this._segmentVisBoxes[i]=lx(e,this._segmentBoundingBoxes[i],i)),!n&&o&&(e.removeAuxiliaryObject(this._segmentVisBoxes[i]),this._segmentVisBoxes[i]=void 0)}}updateHelpers(){}loadingProgress(){return this._loadingProgress}}let dx=0;var ym=(s=>(s.UPDATED="sceneUpdated",s.ANY_VIEW_UPDATED="anyViewUpdated",s.VIEW_ADDED="viewAdded",s.VIEW_REMOVED="viewRemoved",s.VIEW_SHIFTED="viewShifted",s.SKY_MESH_ADDED="skyMeshAdded",s.SKY_MESH_REMOVED="skyMeshRemoved",s.LIGHT_PROBE_ADDED="lightProbeAdded",s.LIGHT_PROBE_REMOVED="lightProbeRemoved",s))(ym||{});const Rn=class Rn extends ei{constructor(t,i,n){super();r(this,"id");r(this,"camera");r(this,"threeScene",new nr);r(this,"autoAddLightProbes",!0);r(this,"autoTour",{disabled:!1,startOnLoad:!1});r(this,"disableProgressiveLoader",!1);r(this,"interactionPrompt",!1);r(this,"materialManager");r(this,"nodeConfigs",new Array);r(this,"_nodeConfigsLookup",{});r(this,"nodes",new Array);r(this,"_animatedRootNodes",new Array);r(this,"_nodeLookup",{});r(this,"gpuMeshes",new Array);r(this,"segmentManager");r(this,"segmentLightmaps",new Array);r(this,"textureManager");r(this,"exposureController");r(this,"renderCaches",new Map);r(this,"_animatableAuxiliaryObjects",new Set);r(this,"boundingBox",new ti);r(this,"collisionBoundingBox",new ti);r(this,"_sumLogicalMeshCenter",new F);r(this,"_logicalNonemptyMeshCount",0);r(this,"_center",new F);r(this,"skyMeshes",new Array);r(this,"views",new Array);r(this,"internalViews",new Array);r(this,"lightManager");r(this,"lightProbes",new Array);r(this,"cameraVolumes",new Array);r(this,"lightmapLayoutVersion",0);r(this,"liveLightmap");r(this,"shadowmapGenerator");r(this,"ssaoRenderer");r(this,"minimapConfig",null);r(this,"sharedMaterialState");r(this,"_updated",()=>{this.dispatchEvent({type:Rn.eventType.UPDATED})});r(this,"_anyViewUpdated",()=>{this.dispatchEvent({type:Rn.eventType.ANY_VIEW_UPDATED}),this._updated()});r(this,"_logicalMeshCenter",new F);r(this,"_nodeConfigUpdated",()=>{this._animatedRootNodes.length=0,this.visitAllNodes(t=>{t.isAnimatedRoot&&this._animatedRootNodes.push(t)}),this._updated()});this.id=dx++,this.camera=t,this.liveLightmap=new Qo;const o=()=>{this.liveLightmap.dispatchEvent({type:Qo.eventType.UPDATE_NEEDED})};this.shadowmapGenerator=i,this.ssaoRenderer=n,this.sharedMaterialState=new il(this.camera,this.liveLightmap),this.materialManager=new P_(this.gpuMeshes,this.sharedMaterialState,()=>this.lightProbes.length===0,this._animatableAuxiliaryObjects,this._updated,o),this.lightManager=new mo(this.sharedMaterialState),this.lightManager.addEventListener(mo.eventType.LIGHTING_UPDATED,o),this.lightManager.addEventListener(mo.eventType.LIGHTING_UPDATED,this._updated),this.camera.addEventListener(gi.eventType.UPDATED,this._updated)}canStartAutoTour(){return!this.autoTour.disabled&&this.visibleViews().length>1}startAutoTourOnLoad(){return this.canStartAutoTour()&&this.autoTour.startOnLoad&&!M.EDIT_MODE}initSegmentManager(t,i,n){Pe(this.textureManager),this.segmentManager=new hx(this.textureManager,t,i,n);const o=this.views[0].toCamera(),a=new at;a.multiplyMatrices(o.projectionMatrix,o.matrixWorldInverse);const l=new Ar;l.setFromMatrix(a),this.segmentManager.loadVisibleSegments(l)}updateSegments(){const t=this.camera;t.updateMatrixWorld(!0),t.matrixWorldInverse.getInverse(t.matrixWorld);const i=new at;i.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse);const n=new Ar;n.setFromMatrix(i),this.segmentManager.loadVisibleSegments(n),this.segmentManager.updateRenderables(this,this.segmentLightmaps)}serialize(){const t=i=>i.name!==M.DEFAULT_SKY_NAME;return en(Vt({},this.lightManager.serialize()),{disableProgressiveLoader:this.disableProgressiveLoader,interactionPrompt:this.interactionPrompt,autoTour:this.autoTour,camera:this.camera.serialize(),materials:this.materialManager.serialize(),nodeConfigs:this.nodeConfigs.map(i=>i.serialize()),nodes:this.nodes.map(i=>i.serialize()),lightProbes:this.lightProbes.map(i=>i.serialize()),cameraVolumes:this.cameraVolumes.map(i=>i.serialize()),autoAddLightProbes:!1,views:this.views.map(i=>i.serialize()),skies:this.skyMeshes.filter(t).map(i=>i.serialize()),minimap:this.minimapConfig.serialize()})}get materials(){return this.materialManager.materials}getMaterials(){return this.materials}addNodeConfigsFromJson(t,i){t.nodeConfigs.forEach(n=>{n.editable=i.isNodeTypeEditable(n.name),this.addNodeConfig(new w_(n))})}addNodesFromJson(t){const i=(n,o)=>{o.config;const a=this.findNodeConfig(o.config),l=new au(n,a,o);return o.children&&(l.children=o.children.map(c=>i(l,c))),l};t.nodes.forEach(n=>this._addNode(i(null,n)))}addNodeConfig(t){this.nodeConfigs.push(t),this._nodeConfigsLookup[t.name]=t,t.addEventListener(ru.UPDATED,this._nodeConfigUpdated)}findNodeConfig(t){return Object.prototype.hasOwnProperty.call(this._nodeConfigsLookup,t)?this._nodeConfigsLookup[t]:null}_addNode(t){this.nodes.push(t),t.visitSubtree(i=>{this._nodeLookup[i.id]=i,i.isAnimatedRoot&&this._animatedRootNodes.push(i)})}findNode(t){return this._nodeLookup[t]}visitAllNodes(t){for(const i of this.nodes)i.visitSubtree(t)}visitMeshesWithMaterial(t,i){this.visitAllNodes(n=>{const o=n.mesh;o&&o.material===t&&i(o)})}_updateSceneCenterWithGpuMesh(t){if(t instanceof nl)for(let i=0;i<t.logicalMeshes.length;i+=1){const n=t.logicalMeshes[i].geometry.boundingBox;n.empty()||(n.center(this._logicalMeshCenter),this._sumLogicalMeshCenter.add(this._logicalMeshCenter),++this._logicalNonemptyMeshCount)}else{const i=t.geometry.boundingBox;i.empty()||(i.center(this._logicalMeshCenter),this._sumLogicalMeshCenter.add(this._logicalMeshCenter),++this._logicalNonemptyMeshCount)}this._logicalNonemptyMeshCount&&this._center.copyFrom(this._sumLogicalMeshCenter).divideScalar(this._logicalNonemptyMeshCount)}addGpuMesh(t){this.addAuxiliaryObject(t,!1),this.gpuMeshes.push(t),this.boundingBox.union(t.geometry.boundingBox),(t instanceof nl?t.logicalMeshes:[t]).forEach(n=>{n.node.disableCollisions||this.collisionBoundingBox.union(n.geometry.boundingBox)}),this._updateSceneCenterWithGpuMesh(t)}addAuxiliaryObject(t,i=!1){this.threeScene.add(t),t.traverse(n=>{if(!(n instanceof Ye))return;const o=n.material;o&&o.sharedMaterialState===null&&(o.sharedMaterialState=this.sharedMaterialState)}),i&&this._animatableAuxiliaryObjects.add(t),this._updated()}removeAuxiliaryObject(t){this.threeScene.remove(t),this._animatableAuxiliaryObjects.delete(t),this._updated()}addFog(t){Ke(this.sharedMaterialState.fog===void 0),this.sharedMaterialState.fog=t}addBrdfLUT(t){this.sharedMaterialState.brdfLUT=t}setLightmapEncoding(t){this.sharedMaterialState.lightmapEncoding=t}getLightmapEncoding(){return this.sharedMaterialState.lightmapEncoding}hasLightmap(){return this.sharedMaterialState.lightmapEnabled}addSkyMesh(t){this.skyMeshes.push(t),t.addEventListener(zr.eventType.UPDATED,this._updated),this.dispatchEvent({type:Rn.eventType.SKY_MESH_ADDED,skyMesh:t})}removeSkyMesh(t){zi(t,this.skyMeshes),this.dispatchEvent({type:Rn.eventType.SKY_MESH_REMOVED,skyMesh:t}),t.geometry.dispose(),t.material.dispose()}findSkyMesh(t){return Go(this.skyMeshes,t,"name")}addLight(t){this.lightManager.addLight(t)}removeLight(t){this.lightManager.removeLight(t)}addLightProbe(t){Ke(Ua(this.lightProbes,t.id,"id")),this.lightProbes.push(t),t.addEventListener(Mi.eventType.POSITION_UPDATED,this._updated),t.addEventListener(Mi.eventType.BOUNDS_UPDATED,this._updated),this._updated(),this.dispatchEvent({type:Rn.eventType.LIGHT_PROBE_ADDED,lightProbe:t})}removeLightProbe(t){zi(t,this.lightProbes);for(const i of this.gpuMeshes)Up(t,i.lightProbes);this._updated(),this.dispatchEvent({type:Rn.eventType.LIGHT_PROBE_REMOVED,lightProbe:t}),t.dispose()}findLightProbe(t){return Go(this.lightProbes,t,"id")}findLightProbes(t){const i=new Array;let n;for(const o of t)n=Go(this.lightProbes,o,"id"),n&&i.push(n);return i}closestLightProbe(t){let i=null,n=1/0;for(const o of this.lightProbes){const a=t.distanceTo(o.position);a<n&&(n=a,i=o)}return i}addCameraAdjustmentVolume(t){Ke(Ua(this.cameraVolumes,t.id,"id")),this.cameraVolumes.push(t),t.getCameraVolumeTrigger().addEventListener(pn.eventType.UPDATED,this._updated),this._updated()}removeCameraVolume(t){zi(t,this.cameraVolumes),t.dispose(),this._updated()}findCameraVolume(t){return Go(this.cameraVolumes,t,"id")}shiftCameraVolume(t,i){Ke(this.cameraVolumes.length>0),Ha(this.cameraVolumes,t,i);for(let n=0;n<this.cameraVolumes.length;n+=1)this.cameraVolumes[n].setPriority(n);this.cameraVolumes.at(-1).onUpdated()}allViews(){return this.views.concat(this.internalViews)}findView(t){return Go(this.allViews(),t,"id")}findViewByName(t){return Go(this.allViews(),t,"name")}visibleViews(){return this.allViews().filter(t=>!t.hideFromMenu)}addView(t){Ke(Ua(this.allViews(),t.id,"id")),t.internal?this.internalViews.push(t):this.views.push(t),t.addEventListener(Hi.eventType.UPDATED,this._anyViewUpdated),this._updated(),this.dispatchEvent({type:Rn.eventType.VIEW_ADDED,view:t})}removeView(t){zi(t,t.internal?this.internalViews:this.views),this.nodeConfigs.forEach(i=>i.removeFromHideInViews(t.id)),this._updated(),this.dispatchEvent({type:Rn.eventType.VIEW_REMOVED,view:t})}shiftView(t,i){Ke(t.internal===!1),Ha(this.views,t,i),this.dispatchEvent({type:Rn.eventType.VIEW_SHIFTED,view:t})}createDefaultViews(){if(this.views.length===0){const t=new Hi({id:0,name:"Start place",hideFromMenu:!M.SHOW_INTERNAL_VIEWS,position:this.center.toArray(),rotation:[0,0],internal:!0,sky:M.EDITOR_CONTROLLED_SKY_NAME});this.addView(t)}if(M.SHOW_INTERNAL_VIEWS||M.EDIT_MODE){const t=Math.max(...this.allViews().map(d=>d.id)),i=this.boundingBox.getBoundingSphere().radius,n=this.boundingBox.size(),o=this.boundingBox.center().toArray(),a={hideFromMenu:!M.SHOW_INTERNAL_VIEWS,internal:!0,mode:zn.ORBIT,orthographic:!0,target:o,distance:i,maxDistance:i*2},l=new Hi(en(Vt({},a),{id:t+1,name:jl.TOP,orthoFrustumSize:Math.max(n.x,n.y),rotation:[0,-90]})),c=new Hi(en(Vt({},a),{id:t+2,name:jl.FRONT,orthoFrustumSize:Math.max(n.x,n.z),rotation:[0,0]})),h=new Hi(en(Vt({},a),{id:t+3,name:jl.LEFT,orthoFrustumSize:Math.max(n.y,n.z),rotation:[-90,0]}));this.addView(l),this.addView(c),this.addView(h)}}adjustSkiesAndCameraFarToSpanWholeScene(){const t=(l,c)=>{const h=Math.max(Math.abs(l.min.x-c.x),Math.abs(l.max.x-c.x)),d=Math.max(Math.abs(l.min.y-c.y),Math.abs(l.max.y-c.y)),u=Math.max(Math.abs(l.min.z-c.z),Math.abs(l.max.z-c.z));return Math.sqrt(h*h+d*d+u*u)},i=(l,c)=>{const h=l.maxDistance===void 0?l.distance:l.maxDistance;if(l.target&&h)return l.target.distanceTo(c)+h},n=(l,c)=>{if(l.position)return l.position.distanceTo(c)},o=(l,c)=>{let h=0;return l.forEach(d=>{let u;d.mode===zn.ORBIT?u=i(d,c):d.mode===zn.FPS&&(u=n(d,c)),u&&u>h&&(h=u)}),h};let a=0;for(const l of this.skyMeshes){l.autoPosition&&l.position.copyFrom(this.center);let c;if(this.boundingBox.empty())c=0;else{const h=t(this.boundingBox,l.position),d=o(this.allViews(),l.position);c=Math.max(h,d)}c+=M.SKY_DISTANCE_TO_SCENE,l.radius=c,a=Math.max(a,c)}this.camera.far=Math.max(this.camera.far,2*a),Me.log("Camera far set to "+this.camera.far)}disableLightProbesForMaterials(){for(const t of this.materials)t.disableLightProbe=!0,t.setUniforms()}enableLightProbesForMaterials(){for(const t of this.materials)t.disableLightProbe=!1,t.setUniforms()}getAnimatedNodeMeshes(){const t=new Array;return this._animatedRootNodes.forEach(i=>{i.visitSubtree(n=>{n.mesh&&t.push(n.mesh)})}),t}getAnimatedRootNodes(){return this._animatedRootNodes}get center(){return this._center}update(){var t,i;for(const n of this.skyMeshes)n.update(this);M.DEV_SHADOWMAP&&((t=this.shadowmapGenerator)==null||t.generate(this)),M.DEV_SSAO&&((i=this.ssaoRenderer)==null||i.generate(this))}};r(Rn,"eventType",ym);let Yi=Rn;function ux(s){const e=new Ts(new be(16777215*Math.random())),t=nt.createBox(s.max.x-s.min.x,s.max.y-s.min.y,s.max.z-s.min.z),i=new Ye(t,e);return s.center(i.position),i.updateMatrixWorld(),i}function fx(s,e=!1){for(const t of s.gpuMeshes){if(!(t instanceof Ye)||e&&!t.material.transparent)continue;const i=t.geometry;i.boundingBox||i.computeBoundingBox();const n=ux(i.boundingBox);s.addAuxiliaryObject(n)}}const mx=function(s,e){console.warn("Camera path debug mode");const t=2,i=document.createElement("canvas"),n=i.getContext("2d");i.width=s*t,i.height=e*t,i.style.position="absolute",i.style.left="0",i.style.top="0",i.style.maxWidth="100%",document.body.appendChild(i);const o={};function a(x){return parseFloat(x.toFixed(4))}function l(x,v){return x.reduce((E,w)=>E+w[v],0)}function c(x,v="black",E=1,w=1){const C=x.x*t,I=x.y*t,O=w*t;n.lineWidth=E*t,n.strokeStyle=v,n.beginPath(),n.arc(C,I,O,0,Math.PI*2),n.stroke()}function h(x,v="black",E=1,w=!1){const C=x.x*t-.5*t,I=x.y*t-.5*t,O=t,U=t;n.lineWidth=E*t,n.strokeStyle=v,n.fillStyle=v,n.beginPath(),n.rect(C,I,O,U),n.stroke(),w&&n.fill()}function d(x,v,E="black",w=1){n.lineWidth=w*t,n.strokeStyle=E,n.beginPath(),n.moveTo(x.x*t,x.y*t),n.lineTo(v.x*t,v.y*t),n.stroke()}function u(x){x.forEach(v=>{const E=v.distanceToObstacle*255,w=v.distanceToObstacle===0?"black":"rgb(255,"+E+","+E+")";h(v,w,0,!0)})}function m(x){x.forEach(v=>{const E=new Ce(v.x,v.y);c(E,"green",.5,.5)})}function g(x){x.forEach((v,E)=>{const w=new Ce(v.x,v.y);if(E>0){const C=new Ce(x[E-1].x,x[E-1].y);d(C,w,"blue",1)}c(w,"blue",1,1)})}this.render=function(x,v,E){n.clearRect(0,0,s*t,e*t),u(x),m(v),g(E)};const b=function(x){const v=[];function E(){return v.at(-1)}function w(){return v.at(-1).end-v.at(-1).start}this.start=function(){const C=performance.now(),I={start:C,end:C,delta:0};v.push(I)},this.end=function(){const C=performance.now();E()!==void 0&&(E().end=C,E().delta=w())},this.stats=function(){const C=E().delta,I=v.reduce((ie,J)=>ie.delta<J.delta?ie:J).delta,O=v.reduce((ie,J)=>ie.delta>J.delta?ie:J).delta,z=l(v,"delta")/v.length;return{name:x,last:a(C),best:a(I),worst:a(O),average:a(z)}}};this.timeStart=function(x){o[x]===void 0&&(o[x]=new b(x)),o[x].start()},this.timeEnd=function(x){o[x]!==void 0&&o[x].end()},this.logTime=function(){const x=[];Object.values(o).forEach(E=>{x.push(E.stats())});const v={name:"TOTAL",last:a(l(x,"last")),best:a(l(x,"best")),worst:a(l(x,"worst")),average:a(l(x,"average"))};x.push(v),console.table(x)}};function Ul(s,e){s&&s.timeStart(e)}function Nl(s,e){s&&s.timeEnd(e)}const Am=function(s="score"){const e=[];function t(n){const o=e[n];for(;n>0;){const a=Math.floor((n-1)/2),l=e[a];if(o[s]<=l[s])e[a]=o,e[n]=l,n=a;else break}}function i(n){const o=e[n];for(;;){const a=2*n+1,l=2*n+2;let c,h,d=null;if(a<e.length&&(c=e[a],o[s]>c[s]&&(d=a)),l<e.length&&(h=e[l],(d===null&&o[s]>h[s]||d!==null&&c[s]>h[s])&&(d=l)),d!==null)e[n]=e[d],e[d]=o,n=d;else break}}this.extract=function(){const n=e[0],o=e.pop();return e.length>0&&(e[0]=o,i(0)),n},this.insert=function(n){e.push(n),t(e.length-1)},this.update=function(n){const o=e.indexOf(n);if(o===0)return;const a=Math.floor((o-1)/2);n[s]<e[a]?t(o):i(o)},this.size=function(){return e.length}},Em=function(s,e,t,i){this.id=s,this.x=e,this.y=t,this.distanceToObstacle=i,this.parent=null,this.score=0};Em.prototype={distanceTo:function(s){return Math.sqrt(Math.pow(this.x-s.x,2)+Math.pow(this.y-s.y,2))},distanceMeasured:function(){return this.distanceToObstacle!==void 0},isObstacle:function(){return this.distanceToObstacle===0},visited:function(){return this.parent!==null},visit:function(s,e){this.parent=s,this.score=e}};const px=function(s,e,t,i){const n=[-1,1,-e,e],o=s.canvasRange,a=s.collisionRange,l=[];function c(d){const u=new Am("distanceToObstacle");for(let m=0;m<=d.data.length;m+=4){const g=d.data[m-1]===255,b=Math.floor(m/(e*4)),x=m/4-b*e,v=g?0:void 0,E=new Em(m/4,x,b,v);l.push(E),g&&u.insert(E)}for(;u.size()>0;){const m=u.extract();n.forEach(g=>{const b=m.id+g;m.distanceToObstacle<1&&l[b]!==void 0&&l[b].distanceMeasured()===!1&&(l[b].distanceToObstacle=Math.min(1,m.distanceToObstacle+1/i),u.insert(l[b]))})}}c(s.collisionImageData);function h(d,u){if(d.x!==0&&d.x!==e-1)return!0;const m=d.x+u.x!==1,g=d.x+u.x!==e-2;return!m&&!g}this.forEachNeighbour=function(d,u){const m=d.x+d.y*e;n.forEach(g=>{l[m+g]!==void 0&&h(d,l[m+g])&&u(l[m+g])})},this.hasObstacleAt=function(d,u){const m=Math.round(d)+Math.round(u)*e;return l[m].isObstacle()},this.getNodeAtScenePosition=function(d){const u=Math.round(Di(d.position.x,a.x.min,a.x.max,o.x.min,o.x.max)),m=Math.round(Di(d.position.y,a.y.min,a.y.max,o.y.min,o.y.max)),g=u+m*e;return l[g]},this.getScenePointFromNode=function(d){const u=Di(d.x,o.x.min,o.x.max,a.x.min,a.x.max),m=Di(d.y,o.y.min,o.y.max,a.y.min,a.y.max);return new Ce(u,m)},this.resetNodeMap=function(){l.forEach(d=>{d.parent=null,d.score=0})},this.getNodeMap=function(){return l}};function _x(s,e){let t=null,i=null;const n=200,o=7,{width:a,height:l}=e.calculateRenderSize(n,s.collisionBoundingBox),c=M.DEBUG_CAMERA_PATH?new mx(a,l):null;function h(v){const E=v.position.z.toFixed(4);if(E!==t){const w={outlineThickness:2,outlineColor:new be(0,0,0),slicePlaneHeight:v.position.z},C=e.getCollisionData(w,a,l);i=new px(C,a,l,o),t=E}else i.resetNodeMap()}function d(v,E){const w=i.getNodeAtScenePosition(v),C=i.getNodeAtScenePosition(E);if(!w||!C)return[];const I=new Am;I.insert(w);const O=[];for(;I.size()>0;){const U=I.extract();if(U===C){for(let z=U;z;z=z.parent)z&&O.push(z);O.reverse();break}i.forEachNeighbour(U,z=>{if(z.isObstacle())return;const ie=z.distanceToObstacle?z.distanceToObstacle:1,J=U.score+1/ie,re=z.visited()||z===w;(!re||J<z.score)&&(z.visit(U,J),re?I.update(z):I.insert(z))})}return O}function u(v,E){const w=Math.abs(v.y-E.y)>Math.abs(v.x-E.x),C=v.x<E.x?v:E,I=v.x<E.x?E:v,O=v.y<E.y?v:E,U=v.y<E.y?E:v,z=C.x===I.x?null:(I.y-C.y)/(I.x-C.x),ie=z===null?C.x:C.y-z*C.x;if(w)for(let J=O.y;J<=U.y;J+=.2){const re=z===null?O.x:(J-ie)/z;if(i.hasObstacleAt(re,J))return!0}else for(let J=C.x;J<=I.x;J+=.2){const re=z===null?C.y:z*J+ie;if(i.hasObstacleAt(J,re))return!0}return!1}function m(v,E){for(let w=v+1;w<E.length;w++)if(u(E[v],E[w]))return w;return-1}function g(v,E,w,C){const I=m(v,E);if(I===-1)w.push(E.at(-1));else{const O=I-v,U=O>C?I-C:I-Math.floor(O/2);w.push(E[U]),g(U,E,w,C)}}function b(v){const E=[v[0]];return g(0,v,E,5),E}function x(v,E,w){const C=[];C.push(new Ce(E.position.x,E.position.y));for(let I=1;I<v.length-1;I++)C.push(i.getScenePointFromNode(v[I]));return C.push(new Ce(w.position.x,w.position.y)),C}this.findPath=function(v,E){Ul(c,"Graph"),h(E),Nl(c,"Graph"),Ul(c,"Raw path");const w=d(v,E);Nl(c,"Raw path");const C=[],I=[];return w.length>=2&&(Ul(c,"Refine path"),C.push(...b(w)),Nl(c,"Refine path"),Ul(c,"Calculate points"),I.push(...x(C,v,E)),Nl(c,"Calculate points")),c&&(c.render(i.getNodeMap(),w,C),c.logTime()),I}}const{abs:Kr,cos:Ds,sin:ur,acos:gx,atan2:$r,sqrt:Qs,pow:wn}=Math;function Zr(s){return s<0?-wn(-s,1/3):wn(s,1/3)}const Tm=Math.PI,kl=2*Tm,Ks=Tm/2,vx=1e-6,Hh=Number.MAX_SAFE_INTEGER||9007199254740991,Wh=Number.MIN_SAFE_INTEGER||-9007199254740991,bx={x:0,y:0,z:0},Ee={Tvalues:[-.06405689286260563,.06405689286260563,-.1911188674736163,.1911188674736163,-.3150426796961634,.3150426796961634,-.4337935076260451,.4337935076260451,-.5454214713888396,.5454214713888396,-.6480936519369755,.6480936519369755,-.7401241915785544,.7401241915785544,-.820001985973903,.820001985973903,-.8864155270044011,.8864155270044011,-.9382745520027328,.9382745520027328,-.9747285559713095,.9747285559713095,-.9951872199970213,.9951872199970213],Cvalues:[.12793819534675216,.12793819534675216,.1258374563468283,.1258374563468283,.12167047292780339,.12167047292780339,.1155056680537256,.1155056680537256,.10744427011596563,.10744427011596563,.09761865210411388,.09761865210411388,.08619016153195327,.08619016153195327,.0733464814110803,.0733464814110803,.05929858491543678,.05929858491543678,.04427743881741981,.04427743881741981,.028531388628933663,.028531388628933663,.0123412297999872,.0123412297999872],arcfn:function(s,e){const t=e(s);let i=t.x*t.x+t.y*t.y;return typeof t.z!="undefined"&&(i+=t.z*t.z),Qs(i)},compute:function(s,e,t){if(s===0)return e[0].t=0,e[0];const i=e.length-1;if(s===1)return e[i].t=1,e[i];const n=1-s;let o=e;if(i===0)return e[0].t=s,e[0];if(i===1){const l={x:n*o[0].x+s*o[1].x,y:n*o[0].y+s*o[1].y,t:s};return t&&(l.z=n*o[0].z+s*o[1].z),l}if(i<4){let l=n*n,c=s*s,h,d,u,m=0;i===2?(o=[o[0],o[1],o[2],bx],h=l,d=n*s*2,u=c):i===3&&(h=l*n,d=l*s*3,u=n*c*3,m=s*c);const g={x:h*o[0].x+d*o[1].x+u*o[2].x+m*o[3].x,y:h*o[0].y+d*o[1].y+u*o[2].y+m*o[3].y,t:s};return t&&(g.z=h*o[0].z+d*o[1].z+u*o[2].z+m*o[3].z),g}const a=JSON.parse(JSON.stringify(e));for(;a.length>1;){for(let l=0;l<a.length-1;l++)a[l]={x:a[l].x+(a[l+1].x-a[l].x)*s,y:a[l].y+(a[l+1].y-a[l].y)*s},typeof a[l].z!="undefined"&&(a[l]=a[l].z+(a[l+1].z-a[l].z)*s);a.splice(a.length-1,1)}return a[0].t=s,a[0]},computeWithRatios:function(s,e,t,i){const n=1-s,o=t,a=e;let l=o[0],c=o[1],h=o[2],d=o[3],u;if(l*=n,c*=s,a.length===2)return u=l+c,{x:(l*a[0].x+c*a[1].x)/u,y:(l*a[0].y+c*a[1].y)/u,z:i?(l*a[0].z+c*a[1].z)/u:!1,t:s};if(l*=n,c*=2*n,h*=s*s,a.length===3)return u=l+c+h,{x:(l*a[0].x+c*a[1].x+h*a[2].x)/u,y:(l*a[0].y+c*a[1].y+h*a[2].y)/u,z:i?(l*a[0].z+c*a[1].z+h*a[2].z)/u:!1,t:s};if(l*=n,c*=1.5*n,h*=3*n,d*=s*s*s,a.length===4)return u=l+c+h+d,{x:(l*a[0].x+c*a[1].x+h*a[2].x+d*a[3].x)/u,y:(l*a[0].y+c*a[1].y+h*a[2].y+d*a[3].y)/u,z:i?(l*a[0].z+c*a[1].z+h*a[2].z+d*a[3].z)/u:!1,t:s}},derive:function(s,e){const t=[];for(let i=s,n=i.length,o=n-1;n>1;n--,o--){const a=[];for(let l=0,c;l<o;l++)c={x:o*(i[l+1].x-i[l].x),y:o*(i[l+1].y-i[l].y)},e&&(c.z=o*(i[l+1].z-i[l].z)),a.push(c);t.push(a),i=a}return t},between:function(s,e,t){return e<=s&&s<=t||Ee.approximately(s,e)||Ee.approximately(s,t)},approximately:function(s,e,t){return Kr(s-e)<=(t||vx)},length:function(s){const t=Ee.Tvalues.length;let i=0;for(let n=0,o;n<t;n++)o=.5*Ee.Tvalues[n]+.5,i+=Ee.Cvalues[n]*Ee.arcfn(o,s);return .5*i},map:function(s,e,t,i,n){const o=t-e,a=n-i,l=s-e,c=l/o;return i+a*c},lerp:function(s,e,t){const i={x:e.x+s*(t.x-e.x),y:e.y+s*(t.y-e.y)};return e.z!==void 0&&t.z!==void 0&&(i.z=e.z+s*(t.z-e.z)),i},pointToString:function(s){let e=s.x+"/"+s.y;return typeof s.z!="undefined"&&(e+="/"+s.z),e},pointsToString:function(s){return"["+s.map(Ee.pointToString).join(", ")+"]"},copy:function(s){return JSON.parse(JSON.stringify(s))},angle:function(s,e,t){const i=e.x-s.x,n=e.y-s.y,o=t.x-s.x,a=t.y-s.y,l=i*a-n*o,c=i*o+n*a;return $r(l,c)},round:function(s,e){const t=""+s,i=t.indexOf(".");return parseFloat(t.substring(0,i+1+e))},dist:function(s,e){const t=s.x-e.x,i=s.y-e.y;return Qs(t*t+i*i)},closest:function(s,e){let t=wn(2,63),i,n;return s.forEach(function(o,a){n=Ee.dist(e,o),n<t&&(t=n,i=a)}),{mdist:t,mpos:i}},abcratio:function(s,e){if(e!==2&&e!==3)return!1;if(typeof s=="undefined")s=.5;else if(s===0||s===1)return s;const t=wn(s,e)+wn(1-s,e),i=t-1;return Kr(i/t)},projectionratio:function(s,e){if(e!==2&&e!==3)return!1;if(typeof s=="undefined")s=.5;else if(s===0||s===1)return s;const t=wn(1-s,e),i=wn(s,e)+t;return t/i},lli8:function(s,e,t,i,n,o,a,l){const c=(s*i-e*t)*(n-a)-(s-t)*(n*l-o*a),h=(s*i-e*t)*(o-l)-(e-i)*(n*l-o*a),d=(s-t)*(o-l)-(e-i)*(n-a);return d==0?!1:{x:c/d,y:h/d}},lli4:function(s,e,t,i){const n=s.x,o=s.y,a=e.x,l=e.y,c=t.x,h=t.y,d=i.x,u=i.y;return Ee.lli8(n,o,a,l,c,h,d,u)},lli:function(s,e){return Ee.lli4(s,s.c,e,e.c)},makeline:function(s,e){return new Qt(s.x,s.y,(s.x+e.x)/2,(s.y+e.y)/2,e.x,e.y)},findbbox:function(s){let e=Hh,t=Hh,i=Wh,n=Wh;return s.forEach(function(o){const a=o.bbox();e>a.x.min&&(e=a.x.min),t>a.y.min&&(t=a.y.min),i<a.x.max&&(i=a.x.max),n<a.y.max&&(n=a.y.max)}),{x:{min:e,mid:(e+i)/2,max:i,size:i-e},y:{min:t,mid:(t+n)/2,max:n,size:n-t}}},shapeintersections:function(s,e,t,i,n){if(!Ee.bboxoverlap(e,i))return[];const o=[],a=[s.startcap,s.forward,s.back,s.endcap],l=[t.startcap,t.forward,t.back,t.endcap];return a.forEach(function(c){c.virtual||l.forEach(function(h){if(h.virtual)return;const d=c.intersects(h,n);d.length>0&&(d.c1=c,d.c2=h,d.s1=s,d.s2=t,o.push(d))})}),o},makeshape:function(s,e,t){const i=e.points.length,n=s.points.length,o=Ee.makeline(e.points[i-1],s.points[0]),a=Ee.makeline(s.points[n-1],e.points[0]),l={startcap:o,forward:s,back:e,endcap:a,bbox:Ee.findbbox([o,s,e,a])};return l.intersections=function(c){return Ee.shapeintersections(l,l.bbox,c,c.bbox,t)},l},getminmax:function(s,e,t){if(!t)return{min:0,max:0};let i=Hh,n=Wh,o,a;t.indexOf(0)===-1&&(t=[0].concat(t)),t.indexOf(1)===-1&&t.push(1);for(let l=0,c=t.length;l<c;l++)o=t[l],a=s.get(o),a[e]<i&&(i=a[e]),a[e]>n&&(n=a[e]);return{min:i,mid:(i+n)/2,max:n,size:n-i}},align:function(s,e){const t=e.p1.x,i=e.p1.y,n=-$r(e.p2.y-i,e.p2.x-t),o=function(a){return{x:(a.x-t)*Ds(n)-(a.y-i)*ur(n),y:(a.x-t)*ur(n)+(a.y-i)*Ds(n)}};return s.map(o)},roots:function(s,e){e=e||{p1:{x:0,y:0},p2:{x:1,y:0}};const t=s.length-1,i=Ee.align(s,e),n=function(z){return 0<=z&&z<=1};if(t===2){const z=i[0].y,ie=i[1].y,J=i[2].y,re=z-2*ie+J;if(re!==0){const Oe=-Qs(ie*ie-z*J),We=-z+ie,Ve=-(Oe+We)/re,lt=-(-Oe+We)/re;return[Ve,lt].filter(n)}else if(ie!==J&&re===0)return[(2*ie-J)/(2*ie-2*J)].filter(n);return[]}const o=i[0].y,a=i[1].y,l=i[2].y,c=i[3].y;let h=-o+3*a-3*l+c,d=3*o-6*a+3*l,u=-3*o+3*a,m=o;if(Ee.approximately(h,0)){if(Ee.approximately(d,0))return Ee.approximately(u,0)?[]:[-m/u].filter(n);const z=Qs(u*u-4*d*m),ie=2*d;return[(z-u)/ie,(-u-z)/ie].filter(n)}d/=h,u/=h,m/=h;const g=(3*u-d*d)/3,b=g/3,x=(2*d*d*d-9*d*u+27*m)/27,v=x/2,E=v*v+b*b*b;let w,C,I,O,U;if(E<0){const z=-g/3,ie=z*z*z,J=Qs(ie),re=-x/(2*J),Oe=re<-1?-1:re>1?1:re,We=gx(Oe),Ve=Zr(J),lt=2*Ve;return I=lt*Ds(We/3)-d/3,O=lt*Ds((We+kl)/3)-d/3,U=lt*Ds((We+2*kl)/3)-d/3,[I,O,U].filter(n)}else{if(E===0)return w=v<0?Zr(-v):-Zr(v),I=2*w-d/3,O=-w-d/3,[I,O].filter(n);{const z=Qs(E);return w=Zr(-v+z),C=Zr(v+z),[w-C-d/3].filter(n)}}},droots:function(s){if(s.length===3){const e=s[0],t=s[1],i=s[2],n=e-2*t+i;if(n!==0){const o=-Qs(t*t-e*i),a=-e+t,l=-(o+a)/n,c=-(-o+a)/n;return[l,c]}else if(t!==i&&n===0)return[(2*t-i)/(2*(t-i))];return[]}if(s.length===2){const e=s[0],t=s[1];return e!==t?[e/(e-t)]:[]}return[]},curvature:function(s,e,t,i,n){let o,a,l,c,h=0,d=0;const u=Ee.compute(s,e),m=Ee.compute(s,t),g=u.x*u.x+u.y*u.y;if(i?(o=Qs(wn(u.y*m.z-m.y*u.z,2)+wn(u.z*m.x-m.z*u.x,2)+wn(u.x*m.y-m.x*u.y,2)),a=wn(g+u.z*u.z,3/2)):(o=u.x*m.y-u.y*m.x,a=wn(g,3/2)),o===0||a===0)return{k:0,r:0};if(h=o/a,d=a/o,!n){const b=Ee.curvature(s-.001,e,t,i,!0).k,x=Ee.curvature(s+.001,e,t,i,!0).k;c=(x-h+(h-b))/2,l=(Kr(x-h)+Kr(h-b))/2}return{k:h,r:d,dk:c,adk:l}},inflections:function(s){if(s.length<4)return[];const e=Ee.align(s,{p1:s[0],p2:s.slice(-1)[0]}),t=e[2].x*e[1].y,i=e[3].x*e[1].y,n=e[1].x*e[2].y,o=e[3].x*e[2].y,a=18*(-3*t+2*i+3*n-o),l=18*(3*t-i-3*n),c=18*(n-t);if(Ee.approximately(a,0)){if(!Ee.approximately(l,0)){let m=-c/l;if(0<=m&&m<=1)return[m]}return[]}const h=l*l-4*a*c,d=Math.sqrt(h),u=2*a;return Ee.approximately(u,0)?[]:[(d-l)/u,-(l+d)/u].filter(function(m){return 0<=m&&m<=1})},bboxoverlap:function(s,e){const t=["x","y"],i=t.length;for(let n=0,o,a,l,c;n<i;n++)if(o=t[n],a=s[o].mid,l=e[o].mid,c=(s[o].size+e[o].size)/2,Kr(a-l)>=c)return!1;return!0},expandbox:function(s,e){e.x.min<s.x.min&&(s.x.min=e.x.min),e.y.min<s.y.min&&(s.y.min=e.y.min),e.z&&e.z.min<s.z.min&&(s.z.min=e.z.min),e.x.max>s.x.max&&(s.x.max=e.x.max),e.y.max>s.y.max&&(s.y.max=e.y.max),e.z&&e.z.max>s.z.max&&(s.z.max=e.z.max),s.x.mid=(s.x.min+s.x.max)/2,s.y.mid=(s.y.min+s.y.max)/2,s.z&&(s.z.mid=(s.z.min+s.z.max)/2),s.x.size=s.x.max-s.x.min,s.y.size=s.y.max-s.y.min,s.z&&(s.z.size=s.z.max-s.z.min)},pairiteration:function(s,e,t){const i=s.bbox(),n=e.bbox(),o=1e5,a=t||.5;if(i.x.size+i.y.size<a&&n.x.size+n.y.size<a)return[(o*(s._t1+s._t2)/2|0)/o+"/"+(o*(e._t1+e._t2)/2|0)/o];let l=s.split(.5),c=e.split(.5),h=[{left:l.left,right:c.left},{left:l.left,right:c.right},{left:l.right,right:c.right},{left:l.right,right:c.left}];h=h.filter(function(u){return Ee.bboxoverlap(u.left.bbox(),u.right.bbox())});let d=[];return h.length===0||(h.forEach(function(u){d=d.concat(Ee.pairiteration(u.left,u.right,a))}),d=d.filter(function(u,m){return d.indexOf(u)===m})),d},getccenter:function(s,e,t){const i=e.x-s.x,n=e.y-s.y,o=t.x-e.x,a=t.y-e.y,l=i*Ds(Ks)-n*ur(Ks),c=i*ur(Ks)+n*Ds(Ks),h=o*Ds(Ks)-a*ur(Ks),d=o*ur(Ks)+a*Ds(Ks),u=(s.x+e.x)/2,m=(s.y+e.y)/2,g=(e.x+t.x)/2,b=(e.y+t.y)/2,x=u+l,v=m+c,E=g+h,w=b+d,C=Ee.lli8(u,m,x,v,g,b,E,w),I=Ee.dist(C,s);let O=$r(s.y-C.y,s.x-C.x),U=$r(e.y-C.y,e.x-C.x),z=$r(t.y-C.y,t.x-C.x),ie;return O<z?((O>U||U>z)&&(O+=kl),O>z&&(ie=z,z=O,O=ie)):z<U&&U<O?(ie=z,z=O,O=ie):z+=kl,C.s=O,C.e=z,C.r=I,C},numberSort:function(s,e){return s-e}};class Jr{constructor(e){this.curves=[],this._3d=!1,e&&(this.curves=e,this._3d=this.curves[0]._3d)}valueOf(){return this.toString()}toString(){return"["+this.curves.map(function(e){return Ee.pointsToString(e.points)}).join(", ")+"]"}addCurve(e){this.curves.push(e),this._3d=this._3d||e._3d}length(){return this.curves.map(function(e){return e.length()}).reduce(function(e,t){return e+t})}curve(e){return this.curves[e]}bbox(){const e=this.curves;for(var t=e[0].bbox(),i=1;i<e.length;i++)Ee.expandbox(t,e[i].bbox());return t}offset(e){const t=[];return this.curves.forEach(function(i){t.push(...i.offset(e))}),new Jr(t)}}const{abs:ea,min:Sm,max:wm,cos:xx,sin:yx,acos:Ax,sqrt:ta}=Math,Ex=Math.PI;class Qt{constructor(e){let t=e&&e.forEach?e:Array.from(arguments).slice(),i=!1;if(typeof t[0]=="object"){i=t.length;const g=[];t.forEach(function(b){["x","y","z"].forEach(function(x){typeof b[x]!="undefined"&&g.push(b[x])})}),t=g}let n=!1;const o=t.length;if(i){if(i>4){if(arguments.length!==1)throw new Error("Only new Bezier(point[]) is accepted for 4th and higher order curves");n=!0}}else if(o!==6&&o!==8&&o!==9&&o!==12&&arguments.length!==1)throw new Error("Only new Bezier(point[]) is accepted for 4th and higher order curves");const a=this._3d=!n&&(o===9||o===12)||e&&e[0]&&typeof e[0].z!="undefined",l=this.points=[];for(let g=0,b=a?3:2;g<o;g+=b){var c={x:t[g],y:t[g+1]};a&&(c.z=t[g+2]),l.push(c)}const h=this.order=l.length-1,d=this.dims=["x","y"];a&&d.push("z"),this.dimlen=d.length;const u=Ee.align(l,{p1:l[0],p2:l[h]}),m=Ee.dist(l[0],l[h]);this._linear=u.reduce((g,b)=>g+ea(b.y),0)<m/50,this._lut=[],this._t1=0,this._t2=1,this.update()}static quadraticFromPoints(e,t,i,n){if(typeof n=="undefined"&&(n=.5),n===0)return new Qt(t,t,i);if(n===1)return new Qt(e,t,t);const o=Qt.getABC(2,e,t,i,n);return new Qt(e,o.A,i)}static cubicFromPoints(e,t,i,n,o){typeof n=="undefined"&&(n=.5);const a=Qt.getABC(3,e,t,i,n);typeof o=="undefined"&&(o=Ee.dist(t,a.C));const l=o*(1-n)/n,c=Ee.dist(e,i),h=(i.x-e.x)/c,d=(i.y-e.y)/c,u=o*h,m=o*d,g=l*h,b=l*d,x={x:t.x-u,y:t.y-m},v={x:t.x+g,y:t.y+b},E=a.A,w={x:E.x+(x.x-E.x)/(1-n),y:E.y+(x.y-E.y)/(1-n)},C={x:E.x+(v.x-E.x)/n,y:E.y+(v.y-E.y)/n},I={x:e.x+(w.x-e.x)/n,y:e.y+(w.y-e.y)/n},O={x:i.x+(C.x-i.x)/(1-n),y:i.y+(C.y-i.y)/(1-n)};return new Qt(e,I,O,i)}static getUtils(){return Ee}getUtils(){return Qt.getUtils()}static get PolyBezier(){return Jr}valueOf(){return this.toString()}toString(){return Ee.pointsToString(this.points)}toSVG(){if(this._3d)return!1;const e=this.points,t=e[0].x,i=e[0].y,n=["M",t,i,this.order===2?"Q":"C"];for(let o=1,a=e.length;o<a;o++)n.push(e[o].x),n.push(e[o].y);return n.join(" ")}setRatios(e){if(e.length!==this.points.length)throw new Error("incorrect number of ratio values");this.ratios=e,this._lut=[]}verify(){const e=this.coordDigest();e!==this._print&&(this._print=e,this.update())}coordDigest(){return this.points.map(function(e,t){return""+t+e.x+e.y+(e.z?e.z:0)}).join("")}update(){this._lut=[],this.dpoints=Ee.derive(this.points,this._3d),this.computedirection()}computedirection(){const e=this.points,t=Ee.angle(e[0],e[this.order],e[1]);this.clockwise=t>0}length(){return Ee.length(this.derivative.bind(this))}static getABC(e=2,t,i,n,o=.5){const a=Ee.projectionratio(o,e),l=1-a,c={x:a*t.x+l*n.x,y:a*t.y+l*n.y},h=Ee.abcratio(o,e);return{A:{x:i.x+(i.x-c.x)/h,y:i.y+(i.y-c.y)/h},B:i,C:c,S:t,E:n}}getABC(e,t){t=t||this.get(e);let i=this.points[0],n=this.points[this.order];return Qt.getABC(this.order,i,t,n,e)}getLUT(e){if(this.verify(),e=e||100,this._lut.length===e)return this._lut;this._lut=[],e++,this._lut=[];for(let t=0,i,n;t<e;t++)n=t/(e-1),i=this.compute(n),i.t=n,this._lut.push(i);return this._lut}on(e,t){t=t||5;let i;const n=this.getLUT(),o=[];for(let a=0,l,c=0;a<n.length;a++)l=n[a],Ee.dist(l,e)<t&&(o.push(l),c+=a/n.length);return o.length?i/=o.length:!1}project(e){const t=this.getLUT(),i=t.length-1,n=Ee.closest(t,e),o=n.mpos,a=(o-1)/i,l=(o+1)/i,c=.1/i;let h=n.mdist,d=a,u=d,m;h+=1;for(let g;d<l+c;d+=c)m=this.compute(d),g=Ee.dist(e,m),g<h&&(h=g,u=d);return u=u<0?0:u>1?1:u,m=this.compute(u),m.t=u,m.d=h,m}get(e){return this.compute(e)}point(e){return this.points[e]}compute(e){return this.ratios?Ee.computeWithRatios(e,this.points,this.ratios,this._3d):Ee.compute(e,this.points,this._3d,this.ratios)}raise(){const e=this.points,t=[e[0]],i=e.length;for(let n=1,o,a;n<i;n++)o=e[n],a=e[n-1],t[n]={x:(i-n)/i*o.x+n/i*a.x,y:(i-n)/i*o.y+n/i*a.y};return t[i]=e[i-1],new Qt(t)}derivative(e){return Ee.compute(e,this.dpoints[0],this._3d)}dderivative(e){return Ee.compute(e,this.dpoints[1],this._3d)}align(){let e=this.points;return new Qt(Ee.align(e,{p1:e[0],p2:e[e.length-1]}))}curvature(e){return Ee.curvature(e,this.dpoints[0],this.dpoints[1],this._3d)}inflections(){return Ee.inflections(this.points)}normal(e){return this._3d?this.__normal3(e):this.__normal2(e)}__normal2(e){const t=this.derivative(e),i=ta(t.x*t.x+t.y*t.y);return{x:-t.y/i,y:t.x/i}}__normal3(e){const t=this.derivative(e),i=this.derivative(e+.01),n=ta(t.x*t.x+t.y*t.y+t.z*t.z),o=ta(i.x*i.x+i.y*i.y+i.z*i.z);t.x/=n,t.y/=n,t.z/=n,i.x/=o,i.y/=o,i.z/=o;const a={x:i.y*t.z-i.z*t.y,y:i.z*t.x-i.x*t.z,z:i.x*t.y-i.y*t.x},l=ta(a.x*a.x+a.y*a.y+a.z*a.z);a.x/=l,a.y/=l,a.z/=l;const c=[a.x*a.x,a.x*a.y-a.z,a.x*a.z+a.y,a.x*a.y+a.z,a.y*a.y,a.y*a.z-a.x,a.x*a.z-a.y,a.y*a.z+a.x,a.z*a.z];return{x:c[0]*t.x+c[1]*t.y+c[2]*t.z,y:c[3]*t.x+c[4]*t.y+c[5]*t.z,z:c[6]*t.x+c[7]*t.y+c[8]*t.z}}hull(e){let t=this.points,i=[],n=[],o=0;for(n[o++]=t[0],n[o++]=t[1],n[o++]=t[2],this.order===3&&(n[o++]=t[3]);t.length>1;){i=[];for(let a=0,l,c=t.length-1;a<c;a++)l=Ee.lerp(e,t[a],t[a+1]),n[o++]=l,i.push(l);t=i}return n}split(e,t){if(e===0&&t)return this.split(t).left;if(t===1)return this.split(e).right;const i=this.hull(e),n={left:this.order===2?new Qt([i[0],i[3],i[5]]):new Qt([i[0],i[4],i[7],i[9]]),right:this.order===2?new Qt([i[5],i[4],i[2]]):new Qt([i[9],i[8],i[6],i[3]]),span:i};return n.left._t1=Ee.map(0,0,1,this._t1,this._t2),n.left._t2=Ee.map(e,0,1,this._t1,this._t2),n.right._t1=Ee.map(e,0,1,this._t1,this._t2),n.right._t2=Ee.map(1,0,1,this._t1,this._t2),t?(t=Ee.map(t,e,1,0,1),n.right.split(t).left):n}extrema(){const e={};let t=[];return this.dims.forEach(function(i){let n=function(a){return a[i]},o=this.dpoints[0].map(n);e[i]=Ee.droots(o),this.order===3&&(o=this.dpoints[1].map(n),e[i]=e[i].concat(Ee.droots(o))),e[i]=e[i].filter(function(a){return a>=0&&a<=1}),t=t.concat(e[i].sort(Ee.numberSort))}.bind(this)),e.values=t.sort(Ee.numberSort).filter(function(i,n){return t.indexOf(i)===n}),e}bbox(){const e=this.extrema(),t={};return this.dims.forEach(function(i){t[i]=Ee.getminmax(this,i,e[i])}.bind(this)),t}overlaps(e){const t=this.bbox(),i=e.bbox();return Ee.bboxoverlap(t,i)}offset(e,t){if(typeof t!="undefined"){const i=this.get(e),n=this.normal(e),o={c:i,n,x:i.x+n.x*t,y:i.y+n.y*t};return this._3d&&(o.z=i.z+n.z*t),o}if(this._linear){const i=this.normal(0),n=this.points.map(function(o){const a={x:o.x+e*i.x,y:o.y+e*i.y};return o.z&&i.z&&(a.z=o.z+e*i.z),a});return[new Qt(n)]}return this.reduce().map(function(i){return i._linear?i.offset(e)[0]:i.scale(e)})}simple(){if(this.order===3){const n=Ee.angle(this.points[0],this.points[3],this.points[1]),o=Ee.angle(this.points[0],this.points[3],this.points[2]);if(n>0&&o<0||n<0&&o>0)return!1}const e=this.normal(0),t=this.normal(1);let i=e.x*t.x+e.y*t.y;return this._3d&&(i+=e.z*t.z),ea(Ax(i))<Ex/3}reduce(){let e,t=0,i=0,n=.01,o,a=[],l=[],c=this.extrema().values;for(c.indexOf(0)===-1&&(c=[0].concat(c)),c.indexOf(1)===-1&&c.push(1),t=c[0],e=1;e<c.length;e++)i=c[e],o=this.split(t,i),o._t1=t,o._t2=i,a.push(o),t=i;return a.forEach(function(h){for(t=0,i=0;i<=1;)for(i=t+n;i<=1+n;i+=n)if(o=h.split(t,i),!o.simple()){if(i-=n,ea(t-i)<n)return[];o=h.split(t,i),o._t1=Ee.map(t,0,1,h._t1,h._t2),o._t2=Ee.map(i,0,1,h._t1,h._t2),l.push(o),t=i;break}t<1&&(o=h.split(t,1),o._t1=Ee.map(t,0,1,h._t1,h._t2),o._t2=h._t2,l.push(o))}),l}translate(e,t,i){i=typeof i=="number"?i:t;const n=this.order;let o=this.points.map((a,l)=>(1-l/n)*t+l/n*i);return new Qt(this.points.map((a,l)=>({x:a.x+e.x*o[l],y:a.y+e.y*o[l]})))}scale(e){const t=this.order;let i=!1;if(typeof e=="function"&&(i=e),i&&t===2)return this.raise().scale(i);const n=this.clockwise,o=this.points;if(this._linear)return this.translate(this.normal(0),i?i(0):e,i?i(1):e);const a=i?i(0):e,l=i?i(1):e,c=[this.offset(0,10),this.offset(1,10)],h=[],d=Ee.lli4(c[0],c[0].c,c[1],c[1].c);if(!d)throw new Error("cannot scale this curve. Try reducing it first.");return[0,1].forEach(function(u){const m=h[u*t]=Ee.copy(o[u*t]);m.x+=(u?l:a)*c[u].n.x,m.y+=(u?l:a)*c[u].n.y}),i?([0,1].forEach(function(u){if(!(t===2&&u)){var m=o[u+1],g={x:m.x-d.x,y:m.y-d.y},b=i?i((u+1)/t):e;i&&!n&&(b=-b);var x=ta(g.x*g.x+g.y*g.y);g.x/=x,g.y/=x,h[u+1]={x:m.x+b*g.x,y:m.y+b*g.y}}}),new Qt(h)):([0,1].forEach(u=>{if(t===2&&u)return;const m=h[u*t],g=this.derivative(u),b={x:m.x+g.x,y:m.y+g.y};h[u+1]=Ee.lli4(m,b,d,o[u+1])}),new Qt(h))}outline(e,t,i,n){if(t=t===void 0?e:t,this._linear){const O=this.normal(0),U=this.points[0],z=this.points[this.points.length-1];let ie,J,re;i===void 0&&(i=e,n=t),ie={x:U.x+O.x*e,y:U.y+O.y*e},re={x:z.x+O.x*i,y:z.y+O.y*i},J={x:(ie.x+re.x)/2,y:(ie.y+re.y)/2};const Oe=[ie,J,re];ie={x:U.x-O.x*t,y:U.y-O.y*t},re={x:z.x-O.x*n,y:z.y-O.y*n},J={x:(ie.x+re.x)/2,y:(ie.y+re.y)/2};const We=[re,J,ie],Ve=Ee.makeline(We[2],Oe[0]),lt=Ee.makeline(Oe[2],We[0]),k=[Ve,new Qt(Oe),lt,new Qt(We)];return new Jr(k)}const o=this.reduce(),a=o.length,l=[];let c=[],h,d=0,u=this.length();const m=typeof i!="undefined"&&typeof n!="undefined";function g(O,U,z,ie,J){return function(re){const Oe=ie/z,We=(ie+J)/z,Ve=U-O;return Ee.map(re,0,1,O+Oe*Ve,O+We*Ve)}}o.forEach(function(O){const U=O.length();m?(l.push(O.scale(g(e,i,u,d,U))),c.push(O.scale(g(-t,-n,u,d,U)))):(l.push(O.scale(e)),c.push(O.scale(-t))),d+=U}),c=c.map(function(O){return h=O.points,h[3]?O.points=[h[3],h[2],h[1],h[0]]:O.points=[h[2],h[1],h[0]],O}).reverse();const b=l[0].points[0],x=l[a-1].points[l[a-1].points.length-1],v=c[a-1].points[c[a-1].points.length-1],E=c[0].points[0],w=Ee.makeline(v,b),C=Ee.makeline(x,E),I=[w].concat(l).concat([C]).concat(c);return new Jr(I)}outlineshapes(e,t,i){t=t||e;const n=this.outline(e,t).curves,o=[];for(let a=1,l=n.length;a<l/2;a++){const c=Ee.makeshape(n[a],n[l-a],i);c.startcap.virtual=a>1,c.endcap.virtual=a<l/2-1,o.push(c)}return o}intersects(e,t){return e?e.p1&&e.p2?this.lineIntersects(e):(e instanceof Qt&&(e=e.reduce()),this.curveintersects(this.reduce(),e,t)):this.selfintersects(t)}lineIntersects(e){const t=Sm(e.p1.x,e.p2.x),i=Sm(e.p1.y,e.p2.y),n=wm(e.p1.x,e.p2.x),o=wm(e.p1.y,e.p2.y);return Ee.roots(this.points,e).filter(a=>{var l=this.get(a);return Ee.between(l.x,t,n)&&Ee.between(l.y,i,o)})}selfintersects(e){const t=this.reduce(),i=t.length-2,n=[];for(let o=0,a,l,c;o<i;o++)l=t.slice(o,o+1),c=t.slice(o+2),a=this.curveintersects(l,c,e),n.push(...a);return n}curveintersects(e,t,i){const n=[];e.forEach(function(a){t.forEach(function(l){a.overlaps(l)&&n.push({left:a,right:l})})});let o=[];return n.forEach(function(a){const l=Ee.pairiteration(a.left,a.right,i);l.length>0&&(o=o.concat(l))}),o}arcs(e){return e=e||.5,this._iterate(e,[])}_error(e,t,i,n){const o=(n-i)/4,a=this.get(i+o),l=this.get(n-o),c=Ee.dist(e,t),h=Ee.dist(e,a),d=Ee.dist(e,l);return ea(h-c)+ea(d-c)}_iterate(e,t){let i=0,n=1,o;do{o=0,n=1;let a=this.get(i),l,c,h,d,u=!1,m=!1,g,b=n,x=1;do if(m=u,d=h,b=(i+n)/2,l=this.get(b),c=this.get(n),h=Ee.getccenter(a,l,c),h.interval={start:i,end:n},u=this._error(h,a,i,n)<=e,g=m&&!u,g||(x=n),u){if(n>=1){if(h.interval.end=x=1,d=h,n>1){let E={x:h.x+h.r*xx(h.e),y:h.y+h.r*yx(h.e)};h.e+=Ee.angle({x:h.x,y:h.y},E,this.get(1))}break}n=n+(n-i)/2}else n=b;while(!g&&o++<100);if(o>=100)break;d=d||h,t.push(d),i=x}while(n<1);return t}}const Tx=2,Sx=6,ia=Math.PI/3,wx=1,Mx=2*M.CAMERA_DEFAULT_MOVE_MAX_SPEED,zl=2,Mm=3,jh=5,Xh=5,Pm=.25,Cm=.35,Gn=s=>-(Math.cos(Math.PI*s)-1)/2,Px=s=>Math.sqrt(1-Math.pow(s-1,2)),Cx=s=>Math.pow(s,5),Rx=s=>1-Math.pow(1-s,5);class qh{constructor(e){r(this,"distance");r(this,"velocity");r(this,"time");this.distance=e,this.velocity=0,this.time=0}setVelocityFromCornerAngle(e){this.velocity=Di(Math.max(ia,e),ia,Math.PI,wx,Mx)}}class Rm{constructor(e,t,i){r(this,"_startKnot");r(this,"_endKnot");r(this,"_acceleration");this._startKnot=e,this._endKnot=t,this._acceleration=i}endTime(){return this._endKnot.time}getDistance(e){const t=e-this._startKnot.time,i=this._startKnot.velocity*t,n=.5*this._acceleration*Math.pow(t,2),o=i+n;return this._startKnot.distance+o}isTimeWithinEquation(e){return e>=this._startKnot.time&&e<=this._endKnot.time}}class Ix{constructor(e,t,i,n,o,a){r(this,"_startKnot");r(this,"_endKnot");r(this,"_maxVelocity");r(this,"_accelerationTime");r(this,"_accelerationDistance");r(this,"_acceleration");this._startKnot=e,this._endKnot=t,this._maxVelocity=i,this._accelerationTime=n,this._accelerationDistance=o,this._acceleration=a}endTime(){return this._endKnot.time}getDistance(e){const t=e-this._startKnot.time;if(t<this._accelerationTime){const i=this._startKnot.velocity*t,n=.5*this._acceleration*Math.pow(t,2),o=i+n;return this._startKnot.distance+o}else{const i=this._maxVelocity*(t-this._accelerationTime),n=.5*this._acceleration*Math.pow(t-this._accelerationTime,2),o=i-n;return this._startKnot.distance+this._accelerationDistance+o}}isTimeWithinEquation(e){return e>=this._startKnot.time&&e<=this._endKnot.time}}class Yh{constructor(e,t,i){r(this,"_endDistance");r(this,"_startDistance");r(this,"_bezier");this._startDistance=e,this._endDistance=t,this._bezier=i}getEndDistance(){return this._endDistance}getPoint(e){const t=Di(e,this._startDistance,this._endDistance,0,1);return this._bezier.get(t)}getRotation(e){const t=Di(e,this._startDistance,this._endDistance,0,1),i=this._bezier.normal(t);return Math.atan2(i.y,i.x)-Math.PI}isDistanceWithinCurve(e){return e>=this._startDistance&&e<=this._endDistance}}const Dx=(s,e,t)=>{const i=s.velocity,n=e.velocity,o=e.distance-s.distance,a=Math.sqrt(.5*Math.pow(i,2)+.5*Math.pow(n,2)+o*t);if(a>i&&a>n){const l=.5*(Math.pow(a,2)-Math.pow(i,2))/t,c=.5*(Math.pow(a,2)-Math.pow(n,2))/t;console.assert(Math.abs(o-l-c)<.001);const h=(a-i)/t,d=(a-n)/t;return e.time=s.time+h+d,new Ix(s,e,a,h,l,t)}else if(a<=n){const l=Math.sqrt(Math.pow(i,2)+2*o*t),c=.5*(Math.pow(l,2)-Math.pow(i,2))/t;return console.assert(Math.abs(o-c)<.001),e.time=s.time+(l-i)/t,e.velocity=l,new Rm(s,e,t)}else{const l=2*o/(i+n),c=i*l+.5*(n-i)*l;console.assert(Math.abs(o-c)<.001);const h=(n-i)/l;return e.time=s.time+l,new Rm(s,e,h)}},Lx=function(){const s=new Ce,e=new Ce;return function(t,i,n){return s.subVectors(i,t),e.subVectors(n,i),Math.asin(Ce.crossVectors(s,e)/(s.length()*e.length()))}}();function Fx(s){return Di(Math.max(ia,s),ia,Math.PI,Tx,Sx)}const Qh=s=>new Ce(s.x,s.y),Im=(s,e)=>new Qt([s,s.clone().lerp(e,1/3),s.clone().lerp(e,2/3),e]),Ox=(s,e,t,i)=>{const n=e.distanceTo(s),o=e.distanceTo(t),a=Math.min(o,n),l=a/n,c=a/o,h=i/a<.5?i/a:.5,d=e.clone().lerp(s,h*l),u=e.clone().lerp(s,h/3*l),m=e.clone().lerp(t,h/3*c),g=e.clone().lerp(t,h*c);return new Qt([d,u,m,g])},Bx=(s,e)=>{const t=Nt(e.x-s.x),i=Nt(e.y-s.y),n=Math.max(Math.abs(t),Math.abs(i)),o=Px(n/Math.PI);return Di(o,0,1,0,zl)};class Dm{constructor(e,t,i,n,o){r(this,"_camera");r(this,"_controls");r(this,"_start");r(this,"_destination");r(this,"_transition");r(this,"_time");r(this,"_totalTime");r(this,"_totalDistance");r(this,"_timeMultiplier");r(this,"_currentPlanarCurve");r(this,"_currentPlanarDistanceEquation");r(this,"_getPlanarPosition");r(this,"_getHeight");r(this,"_getYaw");r(this,"_getPitch");r(this,"_getFov");r(this,"_modifyProjectionMatrix");r(this,"_planarCurves");r(this,"_planarDistanceEquations");r(this,"_isPositivePlanarDistance");if(this._camera=e,this._controls=t,this._start=i,this._destination=n,this._transition=o,this._time=0,this._totalTime=Bx(this._start.rotation,this._destination.rotation),this._totalDistance=0,this._timeMultiplier=1,this._currentPlanarCurve=void 0,this._currentPlanarDistanceEquation=void 0,this._getPlanarPosition=void 0,this._getHeight=void 0,this._getYaw=void 0,this._getPitch=void 0,this._getFov=void 0,this._modifyProjectionMatrix=void 0,this._planarCurves=[],this._planarDistanceEquations=[],this._isPositivePlanarDistance=this._nonZeroPlanarDistanceToDestination(),this._isPositivePlanarDistance&&this._initPlanarMovement(),this._transition.usePath&&this._isPositivePlanarDistance?(this._initPathRotation(),this._initPathHeight()):(this._initLinearRotation(),this._destination.height!==void 0&&(!this._isPositivePlanarDistance&&this._nonZeroHeightDistanceToDestination()&&this._adjustTimeForHeightOnlyMovement(),this._initLinearHeight())),this._destination.fov!==void 0&&(this._getFov=function(l){const c=Gn(l/this._totalTime);return Di(c,0,1,this._start.fov,this._destination.fov)}),this._start.projectionMatrix!==void 0&&this._destination.projectionMatrix!==void 0&&this._doMatricesDiffer(this._start.projectionMatrix,this._destination.projectionMatrix)){const c=(()=>this._camera.isOrthographic()&&!this._destination.orthographic?Cx:!this._camera.isOrthographic()&&this._destination.orthographic?Rx:h=>h)();this._modifyProjectionMatrix=function(h){const d=c(h/this._totalTime);for(let u=0;u<16;u++)this._camera.current.projectionMatrix.elements[u]=Di(d,0,1,this._start.projectionMatrix.elements[u],this._destination.projectionMatrix.elements[u])},this._totalTime<zl&&this._adjustTimeForProjectionChange()}}get _startHeight(){return this._start.height||this._controls.cameraWorldPosition().z}get _destinationHeight(){return this._destination.height||this._controls.cameraWorldPosition().z}_clampTotalTime(e){return Math.max(zl,Math.min(e,this._transition.maxTime))}_calculateTimeMultiplier(){const e=this._planarDistanceEquations.at(-1);return e!==void 0?e.endTime()/this._totalTime:1}_calculateTimeForHeightOnlyDistance(e){const t=Math.sqrt(e/this._transition.acceleration);return this._clampTotalTime(t)}_adjustTimeForHeightOnlyMovement(){this._totalDistance=Math.abs(this._destinationHeight-this._startHeight),this._totalTime=this._calculateTimeForHeightOnlyDistance(this._totalDistance)}_getPlanarCurveByDistance(e){return this._planarCurves.find(i=>i.isDistanceWithinCurve(e))}_initPlanarMovement(){const e=[];for(let u=1;u<this._transition.points.length-1;u++){const m=this._transition.points[u-1],g=this._transition.points[u],b=this._transition.points[u+1],x=Lx(m,g,b),v=Fx(x),E=Ox(m,g,b,v);e.push({bezier:E,angle:x})}const t=[];t.push(new qh(0));let i=this._transition.points[0],n=0;for(let u=0;u<e.length;u++){const m=e[u-1],g=e[u],b=e[u+1];m!==void 0&&(i=Qh(m.bezier.points[3]));const x=Qh(g.bezier.points[0]),v=Im(i,x);if(v.length()>0){const U=n,z=n+v.length(),ie=new Yh(U,z,v);this._planarCurves.push(ie),n+=v.length()}const E=g.bezier.length()/2,w=n,C=n+E*2,I=new Yh(w,C,g.bezier);this._planarCurves.push(I),n+=E;const O=Math.abs(g.angle);if(O>ia){const U=new qh(n);U.setVelocityFromCornerAngle(O),t.push(U)}n+=E,b===void 0&&(i=Qh(g.bezier.points[3]))}const o=this._transition.points.at(-1),a=Im(i,o),l=n+a.length(),c=new Yh(n,l,a);this._planarCurves.push(c),n+=a.length(),t.push(new qh(n));for(let u=1;u<t.length;u++){const m=t[u-1],g=t[u],b=Dx(m,g,this._transition.acceleration);this._planarDistanceEquations.push(b)}this._getPlanarPosition=function(u){var m;return(m=this._currentPlanarCurve)==null?void 0:m.getPoint(u)},this._currentPlanarCurve=this._planarCurves[0],this._currentPlanarDistanceEquation=this._planarDistanceEquations[0],this._totalDistance=n;const h=this._planarDistanceEquations.at(-1),d=h!==void 0?h.endTime():0;this._totalTime=this._clampTotalTime(d),this._timeMultiplier=this._calculateTimeMultiplier()}_initPathRotation(){if(this._totalDistance>jh){const e=jh*Pm,t=this._getPlanarCurveByDistance(e),i=Nt(t.getRotation(e)-this._start.rotation.x),n=this._totalDistance-jh*(1-Pm),o=this._getPlanarCurveByDistance(n),a=Nt(this._destination.rotation.x-o.getRotation(n));this._getYaw=function(l){if(l<e){const c=Gn(l/e);return this._start.rotation.x+c*i}else if(l>n){const c=l-n,h=this._totalDistance-n,d=1-Gn(c/h);return this._destination.rotation.x-d*a}else return this._currentPlanarCurve?this._currentPlanarCurve.getRotation(l):0}}else{const e=Nt(this._destination.rotation.x-this._start.rotation.x);this._getYaw=function(t){const i=Gn(t/this._totalDistance);return this._start.rotation.x+i*e}}if(this._totalDistance>Xh){const e=Xh*Cm,t=Nt(0-this._start.rotation.y),i=this._totalDistance-Xh*(1-Cm),n=Nt(this._destination.rotation.y);this._getPitch=function(o){if(o<e){const a=Gn(o/e);return this._start.rotation.y+a*t}else if(o>i){const a=o-i,l=this._totalDistance-i;return Gn(a/l)*n}else return 0}}else{const e=Nt(this._destination.rotation.y-this._start.rotation.y);this._getPitch=function(t){const i=Gn(t/this._totalDistance);return this._start.rotation.y+i*e}}}_initLinearRotation(){const e=Nt(this._destination.rotation.x-this._start.rotation.x);this._getYaw=function(i){return this._start.rotation.x+Gn(i/this._totalTime)*e};const t=Nt(this._destination.rotation.y-this._start.rotation.y);this._getPitch=function(i){return this._start.rotation.y+Gn(i/this._totalTime)*t}}_initPathHeight(){const e=this._totalDistance>Mm?Mm:this._totalDistance;this._getHeight=function(t){if(t<e){const i=Gn(t/e);return Di(i,0,1,this._startHeight,this._destinationHeight)}else return this._destinationHeight}}_initLinearHeight(){this._getHeight=function(e){const t=Gn(e/this._totalTime);return Di(t,0,1,this._startHeight,this._destinationHeight)}}_nonZeroPlanarDistanceToDestination(){const e=this._transition.points[0],t=this._transition.points.at(-1)||e;return e.distanceTo(t)>.001}_nonZeroHeightDistanceToDestination(){return Math.abs(this._destinationHeight-this._startHeight)>.001}_doMatricesDiffer(e,t){return e.elements.some((i,n)=>i!==t.elements[n])}_adjustTimeForProjectionChange(){this._totalTime=zl}_getDistance(){const e=this._time*this._timeMultiplier,t=this._currentPlanarDistanceEquation;if(t===void 0)throw new Error("currentEquation is null");return e>t.endTime()&&(this._currentPlanarDistanceEquation=this._planarDistanceEquations.find(i=>i.isTimeWithinEquation(e))),t.getDistance(e)}_updateCurrentPlanarCurve(e){const t=this._currentPlanarCurve;if(t===void 0)throw new Error("currentPlanarCurve is undefined");e>t.getEndDistance()&&(this._currentPlanarCurve=this._getPlanarCurveByDistance(e))}update(e,t){if(this._time+=e,this._time>=this._totalTime)return!1;let i;if(this._transition.usePath&&this._isPositivePlanarDistance?(i=this._getDistance(),this._updateCurrentPlanarCurve(i)):i=this._time,this._getPlanarPosition){const n=this._getPlanarPosition(this._getDistance());if(n===void 0)throw new Error("planar is undefined");t.setX(n.x),t.setY(n.y)}if(this._getHeight){const n=this._getHeight(i);t.setZ(n)}return this._getFov&&(this._camera.fov=this._getFov(this._time),this._camera.updateProjectionMatrix()),this._modifyProjectionMatrix&&this._modifyProjectionMatrix(this._time),this._getYaw&&this._controls.setYawAngle(this._getYaw(i)),this._getPitch&&this._controls.setPitchAngle(this._getPitch(i)),this._controls.cameraTransformUpdated(),!0}}/*!
 * Copyright (C) 2014-present unreal engine
 */const Kh=1/180;class Ux{constructor(e){r(this,"_scene");r(this,"_activeSkyMesh");this._scene=e,this._activeSkyMesh=void 0}activateSky(e){if(this._activeSkyMesh){if(this._activeSkyMesh.name===e)return;this._scene.removeAuxiliaryObject(this._activeSkyMesh)}const t=this._scene.findSkyMesh(e),i=t.material.map;i&&!i.loaded?(this.activateSky(M.DEFAULT_SKY_NAME),this._activeSkyMesh=t,i.addLoadedListener(()=>{this._activeSkyMesh===t&&(this._scene.addAuxiliaryObject(t),t.updateMatrixWorld(!0))})):(this._scene.addAuxiliaryObject(t),t.updateMatrixWorld(!0),this._activeSkyMesh=t)}activeSkyName(){return this._activeSkyMesh.name}}class Lm{constructor(e,t,i){r(this,"position");r(this,"rotation");r(this,"fov");this.position=e||new F,this.rotation=t||new Ce,this.fov=i||0}}var Fm=(s=>(s.TELEPORT_STARTED="teleportStarted",s.TELEPORT_DONE="teleportDone",s))(Fm||{});const Lo=class Lo extends ei{constructor(t,i,n,o,a){super();r(this,"_scene");r(this,"_controls");r(this,"_animationController");r(this,"_skyControls");r(this,"_cameraPosition");r(this,"_camera");r(this,"_meshesToHide",{});r(this,"_meshesHiddenByTeleport",new Array);r(this,"_cameraPath");r(this,"_teleportMovement");r(this,"_destination",new Lm);r(this,"_destinationTarget",new F);r(this,"_destinationMinDistance");r(this,"_destinationMaxDistance");r(this,"_viewToEnable");r(this,"_vrEnabled",!1);r(this,"teleportingToView",!1);r(this,"teleportingToPoint",!1);r(this,"_instant",!1);r(this,"_useCameraHeightInViews",!1);r(this,"_lastVisibleDestinationView");r(this,"lastDestinationView");r(this,"collider");r(this,"_initMeshesToHide",()=>{this._meshesToHide=[];for(const t of this._scene.views)this._meshesToHide[t.id]=[];for(const t of this._scene.gpuMeshes){const i=t.hideInViews;if(i)for(const n of i)this._meshesToHide[n]?this._meshesToHide[n].push(t):console.warn("Invalid view id in hideInViews list: '"+n+"'")}});r(this,"_skyMeshAdded",t=>{this._skyControls.activateSky(t.skyMesh.name),this._animationController.requestFrame()});r(this,"_skyMeshRemoved",t=>{if(this._skyControls.activeSkyName()===t.skyMesh.name){const i=M.EDIT_MODE&&this._scene.findSkyMesh(M.EDITOR_CONTROLLED_SKY_NAME);this._skyControls.activateSky(i?M.EDITOR_CONTROLLED_SKY_NAME:M.DEFAULT_SKY_NAME),this._animationController.requestFrame()}});this._scene=t,this._controls=i,this.collider=a,this._animationController=n,this._skyControls=new Ux(t),this._cameraPosition=i.cameraWorldPosition(),this._camera=t.camera,this._cameraPath=new _x(t,o),this._initMeshesToHide(),this._scene.addEventListener(Yi.eventType.VIEW_ADDED,this._initMeshesToHide),this._scene.addEventListener(Yi.eventType.VIEW_REMOVED,this._initMeshesToHide),this._scene.addEventListener(Yi.eventType.SKY_MESH_ADDED,this._skyMeshAdded),this._scene.addEventListener(Yi.eventType.SKY_MESH_REMOVED,this._skyMeshRemoved)}_cameraVector(){const t=new Lm(this._controls.cameraWorldPosition());return t.rotation.set(Nt(this._controls.getYawAngle()),Nt(this._controls.getPitchAngle())),t.fov=this._camera.fov,t}teleporting(){return this.teleportingToView||this.teleportingToPoint}_getMeshesToHide(t){return this._meshesToHide[t]||[]}_hideMeshes(t){for(const i of t)i.visible=!1,this._meshesHiddenByTeleport.push(i);this.collider&&this.collider.updateMeshVisibility(t)}_showMeshesHiddenByTeleport(){this._meshesHiddenByTeleport.forEach(t=>t.visible=!0),this.collider&&this.collider.updateMeshVisibility(this._meshesHiddenByTeleport),this._meshesHiddenByTeleport.length=0}_hideOnlyMeshes(t){this._showMeshesHiddenByTeleport(),this._hideMeshes(t)}_placeCameraAtDestination(){this._camera.fov=this._destination.fov,this._cameraPosition.copyFrom(this._destination.position),this._controls.setYawAngle(this._destination.rotation.x),this._controls.setPitchAngle(this._destination.rotation.y),this._controls.cameraTransformUpdated(),this._teleportMovement=void 0}_adjustHeightIfNeeded(t){if((this._useCameraHeightInViews||M.CAMERA_FIXED_HEIGHT!==null||this._camera.autoClimb&&this._camera.fixedHeight!==null)&&this.collider!==void 0){this._viewToEnable;const i=this._meshesHiddenByTeleport.slice();this._hideOnlyMeshes(this._getMeshesToHide(this._viewToEnable.id)),this.collider.adjustPointToMatchCameraHeight(t),this._hideOnlyMeshes(i)}}_planarPointsLinear(){return[new Ce(this._cameraVector().position.x,this._cameraVector().position.y),new Ce(this._destination.position.x,this._destination.position.y)]}_shouldUsePathTransition(t){const i=t.mode!=="orbit",n=this.lastDestinationView?this.lastDestinationView.mode!=="orbit":!0;return this._camera.autoPath&&i&&n}_onReachedToView(){if(this._viewToEnable.mode==="orbit"&&!this._vrEnabled)this._controls.orbit.setPanPrimary(this._viewToEnable.panPrimary||!1),this._controls.orbit.noRotate=this._viewToEnable.noRotate||!1,this._controls.orbit.noPitchRotate=this._viewToEnable.noPitchRotate||!1,this._controls.orbit.getNoPan=()=>this._viewToEnable.noPan,this._controls.orbit.getMinPitchAngle=()=>-this._viewToEnable.maxUpAngle,this._controls.orbit.getMaxPitchAngle=()=>-this._viewToEnable.minUpAngle,this._controls.orbit.getMinYawAngle=()=>this._viewToEnable.minSideAngle,this._controls.orbit.getMaxYawAngle=()=>this._viewToEnable.maxSideAngle,this._controls.orbit.getMinDistance=()=>this._viewToEnable.minDistance,this._controls.orbit.getMaxDistance=()=>this._viewToEnable.maxDistance,this._controls.orbit.target.copyFrom(this._destinationTarget),this._controls.setControlMode(Xc.ORBIT);else{const t=this._controls.camera();t.near=M.CAMERA_WALK_NEAR,this._controls.setControlMode(Xc.WALK)}this._viewToEnable.orthographic?(this._camera.orthoFrustumSize=this._viewToEnable.orthoFrustumSize,this._camera.setOrthographic()):this._camera.setPerspective(),this._skyControls.activateSky(this._viewToEnable.sky),this._hideOnlyMeshes(this._getMeshesToHide(this._viewToEnable.id))}update(t){if(!this.teleporting())return;t=Math.min(t,.067),t=Math.max(t,Kh);let i=!0;this._teleportMovement!==void 0&&(this.teleportingToPoint&&(this._destination.position.z=this._cameraPosition.z),this._teleportMovement.update(t,this._cameraPosition)?i=!1:this._placeCameraAtDestination()),i&&(this.teleportingToView&&this._onReachedToView(),this.teleportingToView=this.teleportingToPoint=!1,this.dispatchEvent({view:this._viewToEnable,type:Lo.eventType.TELEPORT_DONE})),this._animationController.requestFrame()}cancelSwitchToPoint(){this.teleportingToPoint,this.teleportingToPoint=!1,this.dispatchEvent({view:void 0,type:Lo.eventType.TELEPORT_DONE})}_pointEqualsCameraPositionXY(t){return t.x===this._cameraPosition.x&&t.y===this._cameraPosition.y}_rotationEqualsCameraRotation(t){return Nt(t.yaw)===this._cameraVector().rotation.x&&Nt(t.pitch)===this._cameraVector().rotation.y}switchToPoint(t,i){if(!(this._pointEqualsCameraPositionXY(t)&&(i===void 0||this._rotationEqualsCameraRotation(i)))){if(this._viewToEnable=void 0,this.teleportingToPoint=!0,this.teleportingToView=!1,this.dispatchEvent({view:void 0,type:Lo.eventType.TELEPORT_STARTED}),this._instant?this._destination.position.set(t.x,t.y,t.z):this._destination.position.set(t.x,t.y,this._cameraPosition.z),i)this._destination.rotation.set(Nt(i.yaw),Nt(i.pitch));else{const n=Sd(this._cameraPosition,t),o=Nt(n);this._destination.rotation.set(o,0)}if(this._destination.fov=this._camera.defaultFov,this._instant)this._placeCameraAtDestination(),this.update(Kh);else{const n={fov:this._camera.fov,height:this._cameraVector().position.z,rotation:this._cameraVector().rotation},o={fov:this._destination.fov,rotation:this._destination.rotation},a={acceleration:M.TELEPORT_TO_POINT_ACCELERATION,maxTime:M.TELEPORT_TO_POINT_MAX_TIME,points:this._planarPointsLinear(),usePath:!1};this._teleportMovement=new Dm(this._camera,this._controls,n,o,a),this._animationController.requestFrame()}}}switchToView(t,i){const n=this._shouldUsePathTransition(t);t.hideFromMenu||(this._lastVisibleDestinationView=t),this.lastDestinationView=this._viewToEnable=t,this.teleportingToView=!0,this.teleportingToPoint=!1,this.dispatchEvent({view:this._viewToEnable,type:Lo.eventType.TELEPORT_STARTED}),this._controls.disable(),this._controls.resetRollAngle(),this._hideMeshes(this._getMeshesToHide(this._viewToEnable.id));const o=this._camera.current.projectionMatrix.clone(),a=this._camera.createProjectionMatrix(this._viewToEnable.orthographic,this._viewToEnable.orthoFrustumSize);if(this._viewToEnable.rotation!==void 0?this._destination.rotation.set(this._viewToEnable.rotation.yaw,this._viewToEnable.rotation.pitch):this._destination.rotation.set(0,0),this._destination.fov=this._viewToEnable.fov||this._camera.defaultFov,this._viewToEnable.mode==="orbit"){this._viewToEnable.target!==void 0?this._destinationTarget.set(this._viewToEnable.target.x,this._viewToEnable.target.y,this._viewToEnable.target.z):this._destinationTarget.set(0,0,0),this._destinationMinDistance=this._viewToEnable.minDistance,this._destinationMaxDistance=this._viewToEnable.maxDistance;const l=xi(this._viewToEnable.distance||10,this._destinationMinDistance,this._destinationMaxDistance);ir.computeCameraPosition(this._destination.position,this._destinationTarget,this._destination.rotation.x,this._destination.rotation.y,l),this._camera.near=ir.computeCameraNear(l),this._camera.updateProjectionMatrix()}else this._viewToEnable.position!==void 0?(this._destination.position.set(this._viewToEnable.position.x,this._viewToEnable.position.y,this._viewToEnable.position.z),this._adjustHeightIfNeeded(this._destination.position)):this._destination.position.set(0,0,0);if(i===void 0&&M.TELEPORT_TO_VIEW_MAX_TIME===0||i===0||this._instant)this._placeCameraAtDestination(),this.update(Kh);else{this._viewToEnable.sky!==this._skyControls.activeSkyName()&&this._skyControls.activateSky(M.DEFAULT_SKY_NAME);const l=n?this._cameraPath.findPath(this._cameraVector(),this._destination):[],c=l.length>0,h=n&&c,d=h?l:this._planarPointsLinear(),u=h?M.TELEPORT_PATH_ACCELERATION:M.TELEPORT_TO_VIEW_ACCELERATION;if(i===void 0&&(i=h?M.TELEPORT_PATH_MAX_TIME:M.TELEPORT_TO_VIEW_MAX_TIME),this._viewToEnable.rotation===void 0){const x=d.at(-1),v=d.at(-2),E=Sd(v,x),w=Nt(E);this._destination.rotation.set(w,0)}const m={fov:this._camera.fov,height:this._cameraVector().position.z,rotation:this._cameraVector().rotation,projectionMatrix:o},g={fov:this._destination.fov,height:this._destination.position.z,rotation:this._destination.rotation,projectionMatrix:a,orthographic:this._viewToEnable.orthographic},b={acceleration:u,maxTime:i,points:d,usePath:h};this._teleportMovement=new Dm(this._camera,this._controls,m,g,b),this._animationController.requestFrame()}}_switchToAdjacentVisibleView(t,i){const n=this._scene.visibleViews();if(n.length===0)return;if(this._lastVisibleDestinationView===void 0){this.switchToView(n[0],i);return}const o=n.indexOf(this._lastVisibleDestinationView);o===-1&&this.switchToView(n[0],i);const a=(o+n.length+t)%n.length;this.switchToView(n[a],i)}switchToPreviousVisibleView(t){this._switchToAdjacentVisibleView(-1,t)}switchToNextVisibleView(t){this._switchToAdjacentVisibleView(1,t)}updateHiddenMeshes(t){this._initMeshesToHide(),t?this._hideOnlyMeshes(this._getMeshesToHide(t.id)):this._showMeshesHiddenByTeleport(),this._animationController.requestFrame()}activateSky(t){this._skyControls.activateSky(t.sky),this._animationController.requestFrame()}executeWithViewVisibilitySettings(t,i){const n=this._meshesHiddenByTeleport.slice();this._hideOnlyMeshes(this._getMeshesToHide(t.id)),this._skyControls.activateSky(t.sky),i(),this._skyControls.activateSky(this.lastDestinationView.sky),this._hideOnlyMeshes(n)}onVrChange(t){this._vrEnabled=t,this._instant=this._vrEnabled,this._useCameraHeightInViews=this._vrEnabled,this.lastDestinationView&&this.lastDestinationView.mode==="orbit"&&this.switchToView(this.lastDestinationView,0)}};r(Lo,"eventType",Fm);let Mn=Lo;class na{constructor(e,t,i,n,o,a){r(this,"editor");r(this,"controller");r(this,"property");r(this,"elements");r(this,"values");r(this,"unmergable");this.editor=e,this.controller=t,this.property=i,this.elements=n,this.values=o,this.unmergable=a}isMergable(e){return this.unmergable||!(e instanceof na)?!1:(console.assert(e instanceof na),e.property===this.property&&Va(e.elements,this.elements))}apply(){const e=[];for(let i=0;i<this.elements.length;i++){const n=this.elements[i];e.push(this.editor.getElementValue(this.property,n))}const t=[];for(let i=0;i<this.elements.length;i++){const n=this.elements[i],o=this.values[i],a=this.controller.createItemUpdater(n),l=this.editor.setElementValue(n,a,this.property,o);t.push(l)}return new na(this.editor,this.controller,this.property,t,e,this.unmergable)}}class Nx{constructor(){r(this,"_pastEntries",new Array);r(this,"_futureEntries",new Array)}editorHistoryEntry(e,t,i,n,o,a){return new na(e,t,i,n,o,a)}addItem(e){this._futureEntries=[],!(this._pastEntries.length>0&&this._pastEntries.at(-1).isMergable(e))&&this._pastEntries.push(e)}isUndoable(){return this._pastEntries.length>0}undo(){console.assert(this.isUndoable());const e=this._pastEntries.pop();this._futureEntries.push(e.apply())}isRedoable(){return this._futureEntries.length>0}redo(){console.assert(this.isRedoable());const e=this._futureEntries.pop();this._pastEntries.push(e.apply())}}class kx{constructor(e,t){r(this,"_scene");r(this,"_animationController");r(this,"_selectedMesh");r(this,"_selectedMeshDispose");r(this,"_volumeGroup",new ft);r(this,"_material",Zd());r(this,"_hollowMaterial",Oc());this._scene=e,this._animationController=t,this._scene.addAuxiliaryObject(this._volumeGroup),this._volumeGroup.visible=!1}setHighlightedCameraVolumeTrigger(e){var a;(a=this._selectedMeshDispose)==null||a.call(this);const t=new Ye(e.getVolumeGeometry(),this._material),i=new Ye(e.getVolumeGeometry(),this._hollowMaterial);t.add(i),this._volumeGroup.add(t);const n=()=>{t.position.copyFrom(e.position),t.rotation.copyFrom(e.rotation),t.scale.copyFrom(e.scale),t.updateMatrixWorld(),this._animationController.requestFrame()},o=()=>{this.setControlsVisible(!1)};return n(),e.addEventListener(pn.eventType.UPDATED,n),e.addEventListener(pn.eventType.DISPOSED,o),this._selectedMeshDispose=()=>{this._selectedMesh&&this._volumeGroup.remove(this._selectedMesh),e.removeEventListener(pn.eventType.UPDATED,n),e.removeEventListener(pn.eventType.DISPOSED,o)},this._selectedMesh=t,t.material}setControlsVisible(e){this._volumeGroup.visible=e,this._animationController.requestFrame()}}/*!
 * Copyright (C) 2019-present unreal engine
 */function Om(s,e,t){const i=s.findSkyMesh(M.EDITOR_CONTROLLED_SKY_NAME);t.set(0,-i.radius,0),e.applyToVector3(t),t.add(i.position)}function zx(s,e){e.radius=0,s.visitSubtree(function(t){t.mesh&&Fn.union(t.mesh.geometry.boundingSphere,e)})}const Bm=.4,Vx=1.5;function Gx(){const s=new on,e=new Float32Array(8*4*3*3);s.addAttribute("position",new At(e,3));const t=Bm,i=[[[-1,-1,-1],[-1,-1+t,-1],[-1+t,-1,-1]],[[-1,-1,-1],[-1,-1,-1+t],[-1,-1+t,-1]],[[-1,-1,-1],[-1+t,-1,-1],[-1,-1,-1+t]],[[-1+t,-1,-1],[-1,-1+t,-1],[-1,-1,-1+t]],[[-1,-1,1],[-1+t,-1,1],[-1,-1+t,1]],[[-1,-1,1],[-1,-1+t,1],[-1,-1,1-t]],[[-1,-1,1],[-1,-1,1-t],[-1+t,-1,1]],[[-1+t,-1,1],[-1,-1,1-t],[-1,-1+t,1]],[[1,-1,-1],[1-t,-1,-1],[1,-1+t,-1]],[[1,-1,-1],[1,-1+t,-1],[1,-1,-1+t]],[[1,-1,-1],[1,-1,-1+t],[1-t,-1,-1]],[[1-t,-1,-1],[1,-1,-1+t],[1,-1+t,-1]],[[-1,1,-1],[-1+t,1,-1],[-1,1-t,-1]],[[-1,1,-1],[-1,1-t,-1],[-1,1,-1+t]],[[-1,1,-1],[-1,1,-1+t],[-1+t,1,-1]],[[-1+t,1,-1],[-1,1,-1+t],[-1,1-t,-1]],[[1,1,1],[1-t,1,1],[1,1-t,1]],[[1,1,1],[1,1-t,1],[1,1,1-t]],[[1,1,1],[1,1,1-t],[1-t,1,1]],[[1-t,1,1],[1,1,1-t],[1,1-t,1]],[[1,-1,1],[1,-1+t,1],[1-t,-1,1]],[[1,-1,1],[1,-1,1-t],[1,-1+t,1]],[[1,-1,1],[1-t,-1,1],[1,-1,1-t]],[[1-t,-1,1],[1,-1+t,1],[1,-1,1-t]],[[1,1,-1],[1,1-t,-1],[1-t,1,-1]],[[1,1,-1],[1,1,-1+t],[1,1-t,-1]],[[1,1,-1],[1-t,1,-1],[1,1,-1+t]],[[1-t,1,-1],[1,1-t,-1],[1,1,-1+t]],[[-1,1,1],[-1,1-t,1],[-1+t,1,1]],[[-1,1,1],[-1,1,1-t],[-1,1-t,1]],[[-1,1,1],[-1+t,1,1],[-1,1,1-t]],[[-1+t,1,1],[-1,1-t,1],[-1,1,1-t]]];let n=0;return i.forEach(function(o){for(let a=0;a<3;a+=1)for(let l=0;l<3;l+=1)e[n]=o[a][l],n+=1}),s.computeVertexNormals(),s.convertNormalsToSpherical(),s}function Hx(){const s=new gt;return s.lightmapSupported=!1,s.reflective=!1,s.headLight=!0,s.baseColor=M.EDITOR_SELECTION_COLOR,s.setUniforms(),s}const ni=.01,Ie=1-1.24*(Bm/4);function Wx(){const s=new on,e=new Float32Array(12*8*3*3);s.addAttribute("position",new At(e,3));const t=new Array;function i(c,h){t.push([[c.x,c.y,c.z],[h.x,c.y,c.z],[c.x,h.y,c.z]]),t.push([[c.x,h.y,c.z],[h.x,c.y,c.z],[h.x,h.y,c.z]])}function n(c,h){t.push([[c.x,c.y,c.z],[c.x,h.y,c.z],[c.x,c.y,h.z]]),t.push([[c.x,c.y,h.z],[c.x,h.y,c.z],[c.x,h.y,h.z]])}function o(c,h){t.push([[c.x,c.y,c.z],[h.x,c.y,c.z],[c.x,c.y,h.z]]),t.push([[c.x,c.y,h.z],[h.x,c.y,c.z],[h.x,c.y,h.z]])}function a(c,h,d){const u={x:Math.min(c.x,h.x),y:Math.min(c.y,h.y),z:Math.min(c.z,h.z)},m={x:Math.max(c.x,h.x),y:Math.max(c.y,h.y),z:Math.max(c.z,h.z)};d!=="XY"&&(i(new F(m.x,u.y,u.z),new F(u.x,m.y,u.z)),i(new F(u.x,u.y,m.z),new F(m.x,m.y,m.z))),d!=="YZ"&&(n(new F(u.x,m.y,u.z),new F(u.x,u.y,m.z)),n(new F(m.x,u.y,u.z),new F(m.x,m.y,m.z))),d!=="XZ"&&(o(new F(m.x,m.y,u.z),new F(u.x,m.y,m.z)),o(new F(u.x,u.y,u.z),new F(m.x,u.y,m.z)))}a(new F(-Ie,Ie,Ie),new F(Ie,Ie-ni,Ie-ni),"YZ"),a(new F(-Ie,Ie,-Ie+ni),new F(Ie,Ie-ni,-Ie),"YZ"),a(new F(-Ie,-Ie,-Ie),new F(Ie,-Ie+ni,-Ie+ni),"YZ"),a(new F(-Ie,-Ie,Ie),new F(Ie,-Ie+ni,Ie-ni),"YZ"),a(new F(Ie,Ie,Ie),new F(Ie-ni,-Ie,Ie-ni),"XZ"),a(new F(Ie,Ie,-Ie),new F(Ie-ni,-Ie,-Ie+ni),"XZ"),a(new F(-Ie,Ie,-Ie),new F(-Ie+ni,-Ie,-Ie+ni),"XZ"),a(new F(-Ie,Ie,Ie),new F(-Ie+ni,-Ie,Ie-ni),"XZ"),a(new F(Ie,Ie,Ie),new F(Ie-ni,Ie-ni,-Ie),"XY"),a(new F(Ie,-Ie,Ie),new F(Ie-ni,-Ie+ni,-Ie),"XY"),a(new F(-Ie,Ie,Ie),new F(-Ie+ni,Ie-ni,-Ie),"XY"),a(new F(-Ie,-Ie,Ie),new F(-Ie+ni,-Ie+ni,-Ie),"XY");let l=0;return t.forEach(function(c){for(let h=0;h<3;h+=1)for(let d=0;d<3;d+=1)e[l]=c[h][d],l+=1}),s.computeVertexNormals(),s.convertNormalsToSpherical(),s}class jx{constructor(e,t){r(this,"_scene");r(this,"_lightManager");r(this,"_animationController");r(this,"_lightsVisible",!1);r(this,"_geometryRotation",new at);r(this,"_geometryTranslation",new at);r(this,"_geometryTransform",new at);r(this,"_pointLightGeometry");r(this,"_areaLightGeometry");r(this,"_lightSelectionGeometry");r(this,"_lightSubSelectionGeometry");r(this,"_lightSelectionMaterial");r(this,"_lightUpdated");r(this,"_lightInstanceAdded");r(this,"_lightInstanceRemoved");r(this,"_lightAdded");r(this,"_lightRemoved");r(this,"selectedLightInstance");r(this,"subSelectedLightInstances",new Array);r(this,"lightInstanceMeshes",new Array);this._scene=e,this._lightManager=e.lightManager,this._animationController=t,this._pointLightGeometry=nt.createSphere(1,32,16),this._pointLightGeometry.convertNormalsToSpherical(),this._areaLightGeometry=nt.createPlane(1,1),this._geometryRotation.makeRotationX(-Math.PI/2),this._areaLightGeometry.applyMatrix(this._geometryRotation),this._areaLightGeometry.convertNormalsToSpherical(),this._lightSelectionGeometry=Gx(),this._lightSubSelectionGeometry=Wx(),this._lightSelectionMaterial=Hx(),this._lightUpdated=i=>{this._updateLightInstanceMeshes(i.target)},this._lightInstanceAdded=i=>{const n=i.instance,o=n.light;let a;o.instances[0]!==n?a=this._getLightInstanceMesh(o.instances[0]).geometry:a=this._createLightGeometry(o),this._createLightInstanceMesh(o,n,a),this._animationController.requestFrame()},this._lightInstanceRemoved=i=>{this._updateLightInstanceMeshes(i.instance.light),this._animationController.requestFrame()},this._lightAdded=i=>{this._addLight(i.light),this._animationController.requestFrame()},this._lightRemoved=i=>{this._removeLightInstanceMeshes(i.light),this._animationController.requestFrame()},this._lightManager.lights.forEach(i=>this._addLight(i)),this._lightManager.addEventListener(mo.eventType.LIGHT_ADDED,this._lightAdded),this._lightManager.addEventListener(mo.eventType.LIGHT_REMOVED,this._lightRemoved)}_createLightGeometry(e){let t;if(e.type===sn.SPOT){const i=qt(e.angle),n=1,o=Math.cos(i/2)*n,a=Math.sin(i/2)*n;t=nt.createCylinder(0,a,o,32,1),this._geometryTranslation.makeTranslation(0,-o/2,0),this._geometryRotation.makeRotationZ(Math.PI),this._geometryTransform.multiplyMatrices(this._geometryRotation,this._geometryTranslation),t.applyMatrix(this._geometryTransform),t.convertNormalsToSpherical()}else e.type===sn.AREA?t=this._areaLightGeometry:([sn.POINT,sn.SUN].includes(e.type),`${e.type}`,t=this._pointLightGeometry);return t}_createLightInstanceMesh(e,t,i){const n=new Uc(e),o=new Ye(i,n);o.visibilityId=null;const a=new Ye(this._lightSelectionGeometry,this._lightSelectionMaterial);o.add(a);const l=new Ye(this._lightSubSelectionGeometry,this._lightSelectionMaterial);if(t!==this.selectedLightInstance&&!this.subSelectedLightInstances.includes(t)&&(l.visible=!1),o.add(l),e.type!==sn.SUN){const c=t.rotation.toQuaternion().multiply(o.rotation.toQuaternion());if(o.setRotationFromQuaternion(c),o.position.copyFrom(t.position),e.type===sn.AREA){n.side=Fi.DOUBLE,o.scale.set(e.width,1,e.height);const h=Math.max(e.width,e.height)/2;a.scale.set(h/e.width,h,h/e.height),l.scale.set(h/e.width,h,h/e.height)}else o.scale.set(e.size,e.size,e.size)}else{const c=this._scene.findSkyMesh(M.EDITOR_CONTROLLED_SKY_NAME).radius,h=.5*2*Math.PI*c*Vx/360;Om(this._scene,t.rotation,o.position),o.scale.set(h,h,h)}o.userData.lightInstance=t,o.updateMatrixWorld(),this.lightInstanceMeshes.push(o),this._lightsVisible&&this._scene.addAuxiliaryObject(o)}_createLightInstanceMeshes(e){const t=this._createLightGeometry(e);e.forEachLightInstance(i=>this._createLightInstanceMesh(e,i,t))}_getLightInstanceMesh(e){return this.lightInstanceMeshes.find(t=>t.userData.lightInstance===e)}_removeLightInstanceMeshes(e){const t=i=>i.userData.lightInstance.light!==e;for(const i of this.lightInstanceMeshes)t(i)||(this._lightsVisible&&this._scene.removeAuxiliaryObject(i),i.geometry!==this._pointLightGeometry&&i.geometry!==this._areaLightGeometry&&i.geometry.dispose(),i.material.dispose());this.lightInstanceMeshes=this.lightInstanceMeshes.filter(t)}_updateLightInstanceMeshes(e){this._removeLightInstanceMeshes(e),this._createLightInstanceMeshes(e)}_addLight(e){this._createLightInstanceMeshes(e),e.addEventListener(es.eventType.UPDATED,this._lightUpdated),e.addEventListener(es.eventType.INSTANCE_ADDED,this._lightInstanceAdded),e.addEventListener(es.eventType.INSTANCE_REMOVED,this._lightInstanceRemoved)}getLightInstanceMaterial(e){var t;return(t=this._getLightInstanceMesh(e))==null?void 0:t.material}showLights(){this._lightsVisible||(this._lightsVisible=!0,this.lightInstanceMeshes.forEach(e=>this._scene.addAuxiliaryObject(e)))}showSelectionMesh(e,t){this.lightInstanceMeshes.forEach(function(i){i.children[0].visible=i.userData.lightInstance.light===e||t.includes(i.userData.lightInstance.light)})}showInstancesSelectionMesh(e,t){this.selectedLightInstance=e,this.subSelectedLightInstances=t,this.lightInstanceMeshes.forEach(function(i){i.children[1].visible=i.userData.lightInstance===e||t.includes(i.userData.lightInstance)})}hideLights(){this._lightsVisible&&(this._lightsVisible=!1,this.lightInstanceMeshes.forEach(e=>this._scene.removeAuxiliaryObject(e)))}}class Xx{constructor(e,t){r(this,"_scene");r(this,"_animationController");r(this,"_lightProbesVisible",!1);r(this,"_visibleBoxMesh");r(this,"lightProbeMeshes",new Array);r(this,"_lightProbeGeometry",nt.createSphere(.2,32,16));r(this,"_boxMaterial",Zd());r(this,"_boxGeometry",nt.createBox(1,1,1));r(this,"_hollowBoxMaterial",Oc());r(this,"_lightProbeUpdated",e=>{const t=e.target,i=this._findLightProbeMeshIdx(t);if(i===-1)return;const n=this.lightProbeMeshes[i];n.position.copyFrom(t.position);const o=n.children[0];t.isBoundingBoxEnabled()?(this._setLightProbeBoxPosition(t,o),o.visible=!0):o.visible=!1,n.updateMatrixWorld()});r(this,"_lightProbeAdded",e=>{this._createLightProbeMesh(e.lightProbe)});r(this,"_lightProbeRemoved",e=>{this._removeLightProbeMesh(e.lightProbe)});this._scene=e,this._animationController=t,this._lightProbesVisible=!1,this._lightProbeGeometry.convertNormalsToSpherical(),this._boxGeometry.convertNormalsToSpherical(),this._init()}_setLightProbeBoxPosition(e,t){t.position.addVectors(e.boxMin,e.boxMax).multiplyScalar(.5).sub(e.position),t.scale.subVectors(e.boxMax,e.boxMin),t.scale.subScalar(.005)}_constructLightProbeMesh(){const e=new gt;e.lightmapSupported=!1,e.hideFromLightProbes=!0,e.disableLightProbe=!1,e.highlight=M.EDITOR_SELECTION_COLOR,e.metallic=1,e.roughness=0,e.setUniforms();const t=new Ye(this._lightProbeGeometry,e);return t.lightProbes=[],t}_createLightProbeMesh(e){const t=this._constructLightProbeMesh();t.lightProbes.push(e),t.position.copyFrom(e.position);const i=new Ye(this._boxGeometry,this._boxMaterial),n=new Ye(this._boxGeometry,this._hollowBoxMaterial);i.visible=!1,i.add(n),t.add(i),e.isBoundingBoxEnabled()&&this._setLightProbeBoxPosition(e,i),t.updateMatrixWorld(!0),t.visible=this._lightProbesVisible,this.lightProbeMeshes.push(t),this._scene.addAuxiliaryObject(t),e.addEventListener(Mi.eventType.POSITION_UPDATED,this._lightProbeUpdated),e.addEventListener(Mi.eventType.BOUNDS_UPDATED,this._lightProbeUpdated)}_hideVisibleBoxMesh(){this._visibleBoxMesh&&(this._visibleBoxMesh.visible=!1,this._visibleBoxMesh=void 0)}_findLightProbeMeshIdx(e){return this.lightProbeMeshes.findIndex(t=>{for(let i=0;i<M.MAX_BLENDED_REFLECTION_PROBES;i++)if(t.lightProbes[i]===e)return!0;return!1})}_findLightProbeMesh(e){return this.lightProbeMeshes[this._findLightProbeMeshIdx(e)]}_removeLightProbeMesh(e){const t=this._findLightProbeMeshIdx(e),i=this.lightProbeMeshes[t];this._scene.removeAuxiliaryObject(i),i.material.dispose(),this.lightProbeMeshes.splice(t,1)}_init(){this._scene.lightProbes.forEach(e=>this._createLightProbeMesh(e)),this._scene.addEventListener(Yi.eventType.LIGHT_PROBE_ADDED,this._lightProbeAdded),this._scene.addEventListener(Yi.eventType.LIGHT_PROBE_REMOVED,this._lightProbeRemoved)}_changeLightProbesVisibility(e){this._lightProbesVisible!==e&&(this._lightProbesVisible=e,this.lightProbeMeshes.forEach(t=>t.visible=e)),this._animationController.requestFrame()}getLightProbeMaterial(e){const t=this._findLightProbeMesh(e);return t?t.material:void 0}showLightProbeBoundingBox(e){if(this._hideVisibleBoxMesh(),e.isBoundingBoxEnabled()){const t=this._findLightProbeMesh(e).children[0];this._visibleBoxMesh=t,this._visibleBoxMesh.visible=!0}}showLightProbes(){this._changeLightProbesVisibility(!0)}hideLightProbes(){this._changeLightProbesVisibility(!1)}}function Vl(s){return s instanceof pn}function sa(s){return s instanceof pn?!0:s instanceof Mi?!1:[sn.SUN,sn.SPOT,sn.AREA].includes(s.light.type)}class qx{constructor(e,t){r(this,"_target");r(this,"_supportedModes");this._target=e,this._supportedModes=t}offsetPosition(e){const t=this._target.position.clone().add(e);this._target.setPosition(t.x,t.y,t.z)}offsetRotation(e){sa(this._target);const t={x:this._target.rotation.x+e.x,y:this._target.rotation.y+e.y,z:this._target.rotation.z+e.z};this._target.setRotation(t.z,t.x,t.y)}offsetScale(e){Vl(this._target);const t=this._target.scale.clone().add(e);this._target.setScale(t.x,t.y,t.z)}isSupported(e){return this._supportedModes[e]}get target(){return this._target}}var Kt=(s=>(s[s.NONE=0]="NONE",s[s.X=1]="X",s[s.Y=2]="Y",s[s.XY=3]="XY",s[s.Z=4]="Z",s[s.XZ=5]="XZ",s[s.YZ=6]="YZ",s[s.ALL=7]="ALL",s))(Kt||{});const Um=new F(0,0,1),Gl=new F(1,0,0),Hl=new F(0,1,0);function Yx(s){switch(s){case 1:return Gl;case 2:return Hl;case 4:return Um}Zn()}function Qx(s){return[1,2,4].includes(s)}function Kx(s){const e=new ti;return s instanceof ft&&s.traverse(t=>{t instanceof Ye&&(t.geometry.boundingBox||t.geometry.computeBoundingBox(),e.union(t.geometry.boundingBox))}),e}function $x(s,e){const t=Kx(s),i=t.size(),n=nt.createBox(i.x,i.y,i.z),o=t.center(),a=new at;a.makeTranslation(o.x,o.y,o.z),n.applyMatrix(a),n.computeBoundingBox();const l=new Ye(n,e);return l.visible=!1,l.visibilityId=null,l}const Hn=.6;function Wn(s,e){const t=new gt;return t.lightmapSupported=!1,t.hideFromLightProbes=!0,t.baseColor.copyFrom(s),t.reflective=!1,t.headLight=!1,t.depthTest=!1,t.depthWrite=!1,t.opacity=e,t}class $h extends ft{constructor(t,i,n){super();r(this,"material");r(this,"collider");r(this,"defaultOpacity");r(this,"hoveredOpacity",.99);r(this,"notUsedOpacity",.3);r(this,"usedAxes",0);this.add(t).add(i),this.material=n,this.collider=i,this.defaultOpacity=n.opacity}}function Po(...s){console.assert(s.length>0,"Part must have at least one element!");const e=new ft;s.forEach(n=>e.add(n));const t=$x(e,Wn(be.WHITE,Hn)),i=e.children[0].material;return new $h(e,t,i)}class Zx extends ft{constructor(){super();r(this,"axisX");r(this,"axisY");r(this,"axisZ");r(this,"axes");r(this,"_visibility",[!1,!1,!1]);const t=.0075,i=nt.createCylinder(t,t,1e3,4,1,!1);function n(o){const a=Wn(o,Hn);return a.depthTest=!0,new Ye(i,a)}this.axisX=n(be.RED),this.axisX.rotation.set(0,0,Math.PI/2),this.axisY=n(be.GREEN),this.axisZ=n(be.BLUE),this.axisZ.rotation.set(Math.PI/2,0,0),this.axes=[this.axisX,this.axisY,this.axisZ];for(const o of this.axes)this.add(o)}show(t){this._visibility[0]=(1&t)===1,this._visibility[1]=(2&t)===2,this._visibility[2]=(4&t)===4;for(let i=0;i<3;i++)this.axes[i].visible=this._visibility[i]}update(t){const n=new F;n.copyFrom(t),n.sub(this.position),n.normalize(),this.axisX.visible=this._visibility[0]&&Math.abs(Gl.dot(n))<.998,this.axisY.visible=this._visibility[1]&&Math.abs(Hl.dot(n))<.998,this.axisZ.visible=this._visibility[2]&&Math.abs(Um.dot(n))<.998}}class Jx extends ft{constructor(){super();r(this,"markerX");r(this,"markerY");r(this,"markerZ");r(this,"markers");r(this,"_markerGeometry",nt.createSphere(.012,10,10));const t=()=>new Ye(this._markerGeometry,Wn(be.WHITE,.99));this.markerX=t(),this.markerY=t(),this.markerZ=t(),this.markers=[this.markerX,this.markerY,this.markerZ];for(const i of this.markers)this.add(i)}show(t){this.markerX.visible=(1&t)===1,this.markerY.visible=(2&t)===2,this.markerZ.visible=(4&t)===4}update(t){for(const i of[0,1,2]){const n=i;this.markers[i].position.setComponent(n,t.getComponent(n)),this.markers[i].updateMatrixWorld()}}}class ey extends ft{constructor(){super();r(this,"planeXY");r(this,"planeXZ");r(this,"planeYZ");r(this,"localPlanes");r(this,"cameraPlane");const t=nt.createPlane(1e3,1e3,1,1);function i(a,l=0,c=0,h=0){const d=Wn(a,.2);d.depthTest=!0,d.side=Fi.DOUBLE;const u=Po(new Ye(t,d));return u.rotation.set(l,c,h),u}const n=i(be.WHITE),o=new ft;this.add(n).add(o),this.planeXY=i(be.BLUE),this.planeXZ=i(be.GREEN,Math.PI/2,0,0),this.planeYZ=i(be.RED,0,Math.PI/2,0),o.add(this.planeXY).add(this.planeXZ).add(this.planeYZ),this.localPlanes=o,this.cameraPlane=n}setLocalRotation(t){t?this.localPlanes.rotation.copyFrom(t):this.localPlanes.rotation.set(0,0,0)}update(t){this.cameraPlane.rotation.setFromRotationMatrix(t.matrixWorld),this.cameraPlane.updateMatrixWorld()}findPlaneIntersectionPoint(t,i,n,o){const a=new F,l=new F,c=m=>{switch(m){case 1:return this.planeYZ;case 2:return this.planeXZ;case 4:return this.planeXY;case 3:return this.planeXY;case 5:return this.planeXZ;case 6:return this.planeYZ;case 7:return this.cameraPlane}Zn()};function h(m,g){if(Qx(m)){const b=l.dot(l),x=l.dot(g),v=g.dot(g),E=l.dot(a),w=g.dot(a),C=b*v-x*x;return Math.abs(C)<1e-5?1/0:(b*w-x*E)/C}else{const b=l.dot(g);return Math.abs(b)<1e-5?1/0:l.dot(a)/b}}const d=c(t);d.getWorldPosition(a).sub(i),d.getWorldDirection(l);const u=h(t,n);return u===1/0?!1:(o.copyFrom(n).multiplyScalar(u).add(i),!0)}show(t){this.cameraPlane.visible=t===7,this.planeXY.visible=t===3,this.planeXZ.visible=t===5,this.planeYZ.visible=t===6}}function Zh(s,e,t){const i=s.collider,n=s.material;e===i?(n.opacity=s.hoveredOpacity,n.setUniforms()):(t&&e!==null?n.opacity=s.notUsedOpacity:n.opacity=s.defaultOpacity,n.setUniforms())}const Wl=.015;class ty extends ft{constructor(){super();r(this,"parts");r(this,"collidersMap");r(this,"colliders");function t(){const v=new at,E=nt.createSphere(.1,16,16),w=nt.createPlane(.23,.23,1,1);v.makeTranslation(.45,.45,0),w.applyMatrix(v);const C=nt.createCylinder(Wl,Wl,1,4,1,!1);v.makeTranslation(0,.65,0),C.applyMatrix(v);const I=nt.createCylinder(0,.05,.2,10,1,!1);return v.makeTranslation(0,1.25,0),I.applyMatrix(v),{pickerGeometry:E,squareGeometry:w,lineGeometry:C,arrowHeadGeometry:I}}function i(v,E){const w=v*v,C=new Uint8Array(4*w),I=Math.floor(E.r*255),O=Math.floor(E.g*255),U=Math.floor(E.b*255);let z=0;for(let J=0;J<v;J++)for(let re=0;re<v;re++){C[z]=I,C[z+1]=O,C[z+2]=U;const Oe=J===0||re===0||J===v-1||re===v-1;C[z+3]=Oe?220:150,z+=4}const ie=dt.newDataTexture(C,v,v,Be.RGBA8);return ie.hasAlpha=!0,ie.needsUpdate=!0,ie}function n(v){const E=i(32,v),w=new gt;return w.lightmapSupported=!1,w.hideFromLightProbes=!0,w.reflective=!1,w.headLight=!1,w.depthTest=!1,w.depthWrite=!1,w.transparent=!0,w.baseColor=v,w.side=Fi.DOUBLE,w.baseColorTexture=E,w.opacity=Hn,w.configureTransparency(),w.setUniforms(),w}const o=t();function a(){const v=Wn(be.WHITE,Hn);return Po(new Ye(o.pickerGeometry,v))}function l(v){const E=n(v);return Po(new Ye(o.squareGeometry,E))}function c(v){const E=Wn(v,Hn);return Po(new Ye(o.lineGeometry,E),new Ye(o.arrowHeadGeometry,E))}const h=a(),d=c(be.RED);d.rotation.set(0,0,-Math.PI/2);const u=c(be.GREEN),m=c(be.BLUE);m.rotation.set(Math.PI/2,0,0);const g=l(be.BLUE),b=l(be.GREEN);b.rotation.set(Math.PI/2,0,0);const x=l(be.RED);x.rotation.set(0,-Math.PI/2,0),h.usedAxes=7,d.usedAxes=1,u.usedAxes=2,m.usedAxes=4,g.usedAxes=3,b.usedAxes=5,x.usedAxes=6,this.parts=[h,d,u,m,g,b,x],this.parts.forEach(v=>this.add(v)),this.collidersMap=new Map(this.parts.map(v=>[v.collider,v])),this.colliders=[...this.collidersMap.keys()]}highlight(t,i){this.parts.forEach(n=>Zh(n,t,i))}usedAxes(t){return this.collidersMap.get(t).usedAxes}}class iy extends ft{constructor(){super();r(this,"parts");r(this,"collidersMap");r(this,"colliders");r(this,"circleXYZ");r(this,"sphere");function t(m){const g=nt.createTorus(m,.012,6,64),b=nt.createTorus(m,.038,6,64);return{torusGeometry:g,colliderGeometry:b}}function i(m,g){const b=new __(m,Hn),x=new ft().add(new Ye(g.torusGeometry,b)),v=new Ye(g.colliderGeometry,b);return v.visible=!1,v.visibilityId=null,new $h(x,v,b)}function n(m,g){const b=Wn(m,0),x=nt.createSphere(g,32,32),v=new ft().add(new Ye(x,b)),E=new Ye(x,b);E.visible=!1,E.visibilityId=null;const w=new $h(v,E,b);return w.defaultOpacity=0,w.hoveredOpacity=.2,w.notUsedOpacity=0,w}const o=t(.9),a=i(be.RED,o);a.rotation.set(0,Math.PI/2,0);const l=i(be.GREEN,o);l.rotation.set(Math.PI/2,0,0);const c=i(be.BLUE,o),h=t(1.12),d=i(be.WHITE,h),u=n(be.WHITE,.848);this.parts=[a,l,c,d,u],this.parts.forEach(m=>this.add(m)),this.collidersMap=new Map(this.parts.map(m=>[m.collider,m])),this.colliders=[...this.collidersMap.keys()],a.usedAxes=1,l.usedAxes=2,c.usedAxes=4,d.usedAxes=7,this.circleXYZ=d,u.usedAxes=0,this.sphere=u}update(t){this.parts.filter(i=>i!==this.sphere).forEach(i=>{const n=i.material;n.gizmoPosition.copyFrom(this.position),n.sphereRadius=this.scale.x*.86}),this.circleXYZ.rotation.setFromRotationMatrix(t.matrixWorld),this.circleXYZ.updateMatrixWorld()}highlight(t,i){this.parts.forEach(n=>Zh(n,t,i))}usedAxes(t){return this.collidersMap.get(t).usedAxes}}class ny extends ft{constructor(){super();r(this,"parts");r(this,"collidersMap");r(this,"colliders");function t(){const v=new at,E=nt.createBox(.3,.3,.3),w=nt.createPlane(.23,.23,1,1);v.makeTranslation(.45,.45,0),w.applyMatrix(v);const C=nt.createCylinder(Wl,Wl,1,4,1,!1);v.makeTranslation(0,.65,0),C.applyMatrix(v);const I=nt.createBox(.1,.1,.1);return v.makeTranslation(0,1.1,0),I.applyMatrix(v),{pickerGeometry:E,squareGeometry:w,lineGeometry:C,cubeGeometry:I}}function i(v,E){const w=v*v,C=new Uint8Array(4*w),I=Math.floor(E.r*255),O=Math.floor(E.g*255),U=Math.floor(E.b*255);let z=0;for(let J=0;J<v;J++)for(let re=0;re<v;re++){C[z]=I,C[z+1]=O,C[z+2]=U;const Oe=J===0||re===0||J===v-1||re===v-1;C[z+3]=Oe?220:150,z+=4}const ie=dt.newDataTexture(C,v,v,Be.RGBA8);return ie.hasAlpha=!0,ie.needsUpdate=!0,ie}function n(v){const E=i(32,v),w=new gt;return w.lightmapSupported=!1,w.hideFromLightProbes=!0,w.reflective=!1,w.headLight=!1,w.depthTest=!1,w.depthWrite=!1,w.transparent=!0,w.baseColor=v,w.side=Fi.DOUBLE,w.baseColorTexture=E,w.opacity=Hn,w.configureTransparency(),w.setUniforms(),w}const o=t();function a(){const v=Wn(be.WHITE,Hn);return Po(new Ye(o.pickerGeometry,v))}function l(v){const E=n(v);return Po(new Ye(o.squareGeometry,E))}function c(v){const E=Wn(v,Hn);return Po(new Ye(o.lineGeometry,E),new Ye(o.cubeGeometry,E))}const h=a(),d=c(be.RED);d.rotation.set(0,0,-Math.PI/2);const u=c(be.GREEN),m=c(be.BLUE);m.rotation.set(Math.PI/2,0,0);const g=l(be.BLUE),b=l(be.GREEN);b.rotation.set(Math.PI/2,0,0);const x=l(be.RED);x.rotation.set(0,-Math.PI/2,0),h.usedAxes=7,d.usedAxes=1,u.usedAxes=2,m.usedAxes=4,g.usedAxes=3,b.usedAxes=5,x.usedAxes=6,this.parts=[h,d,u,m,g,b,x],this.parts.forEach(v=>this.add(v)),this.collidersMap=new Map(this.parts.map(v=>[v.collider,v])),this.colliders=[...this.collidersMap.keys()]}highlight(t,i){this.parts.forEach(n=>Zh(n,t,i))}usedAxes(t){return this.collidersMap.get(t).usedAxes}}const sy=.01,oy=2;class ry extends ft{constructor(){super();r(this,"currentRotationX",0);r(this,"lineMaterial",Wn(be.WHITE,Hn));r(this,"arrow");r(this,"line");r(this,"arc");r(this,"_arrowMaterial",Wn(be.ORANGE,Hn));r(this,"_radius",sy);r(this,"_size",oy);this.arrow=this._createArrow(),this.line=this._createLine(),this.arc=this._createArc(),this.add(this.arrow).add(this.line).add(this.arc)}_createArrow(){const t=this._radius,i=this._size,n=nt.createCylinder(0,t*6,i*.25,32,1,!1),o=nt.createCylinder(t,t,i*.75,32,1,!1),a=new Ye(n,this._arrowMaterial),l=new Ye(o,this._arrowMaterial);return a.position.y=i*.125*-1,l.position.y=i*.625*-1,new ft().add(a).add(l)}_createLine(){const t=this._radius,i=this._size,n=nt.createCylinder(t,t,i,32,1,!1),o=new Ye(n,this.lineMaterial);return o.position.y=i*.5*-1,new ft().add(o)}_createArcMesh(t){const i=nt.createTorus(this._size*.9,this._radius,6,32,t),n=new Ye(i,this.lineMaterial);return n.rotation.set(0,-Math.PI/2,-Math.PI/2),n}_createArc(){return new ft().add(this._createArcMesh(Math.PI/2))}_updateArcIfNeeded(t){if(t===this.currentRotationX)return;const i=t*-1,n=this.arc.children.pop(),o=this._createArcMesh(i);this.arc.remove(n),this.arc.add(o),n.geometry.dispose(),this.currentRotationX=t}update(t){this.arrow.rotation.copyFrom(t),this.line.rotation.set(0,0,t.z),this.arc.rotation.set(0,0,t.z),this._updateArcIfNeeded(t.x)}}var $t=(s=>(s[s.TRANSLATE=0]="TRANSLATE",s[s.ROTATE=1]="ROTATE",s[s.SCALE=2]="SCALE",s))($t||{});const Nm={ORTHOGRAPHIC:.1,PERSPECTIVE:.002};class ay{constructor(e,t,i,n){r(this,"_scene");r(this,"_collider");r(this,"_cameraWorldPosition");r(this,"_animationController");r(this,"target");r(this,"subTargetsInfo",null);r(this,"subTargetsData",new Array);r(this,"_axes",new Zx);r(this,"_planes",new ey);r(this,"_markers",new Jx);r(this,"_translateGizmo",new ty);r(this,"_rotateGizmo",new iy);r(this,"_scaleGizmo",new ny);r(this,"_sunHelper",new ry);r(this,"_objects3d",[this._axes,this._planes,this._markers,this._translateGizmo,this._rotateGizmo,this._scaleGizmo,this._sunHelper]);r(this,"_transforming",!1);r(this,"_initialPositionOffset",new F(0,0,0));r(this,"_initialRotationOffset",0);r(this,"_initialScaleOffset",new F);r(this,"oldPosition",new F(0,0,0));r(this,"newPosition",new F(0,0,0));r(this,"oldRotation",new ui(0,0,0,On.XYZ));r(this,"newRotation",new ui(0,0,0,On.XYZ));r(this,"oldScale",new F(1,1,1));r(this,"newScale",new F(1,1,1));r(this,"_mode",$t.TRANSLATE);r(this,"_visible",!1);r(this,"_startClip",{x:1/0,y:1/0});r(this,"_markersPosition",new F(0,0,0));r(this,"_currentlyHovered",null);r(this,"_pointerDown",!1);r(this,"_usedAxes",Kt.ALL);r(this,"_toEye",new F);r(this,"rotationSpeed",5);this._scene=e,this._collider=t,this._cameraWorldPosition=i,this._animationController=n,this._axes.show(Kt.ALL),this._planes.show(Kt.NONE),this._markers.show(Kt.NONE),this.mode=$t.TRANSLATE}get transforming(){return this._transforming}get position(){return this._axes.position}get rotation(){return this.oldRotation}get scale(){return this.oldScale}get currentGizmo(){switch(this._mode){case $t.TRANSLATE:return this._translateGizmo;case $t.ROTATE:return this._rotateGizmo;case $t.SCALE:return this._scaleGizmo}}get mode(){return this._mode}set mode(e){this._mode!==e&&(this._mode=e,this._updateControlsVisibility(),this._animationController.requestFrame())}get visible(){return this._visible}set visible(e){this._visible!==e&&(this._visible=e,this._updateControlsVisibility())}_setScale(e){for(const t of this._objects3d)t.scale.set(e,e,e)}_copyPositionFrom(e){this.oldPosition.copyFrom(e),this.newPosition.copyFrom(e);for(const t of this._objects3d)t.position.copyFrom(e)}_copyRotationFrom(e){this.oldRotation.copyFrom(e),this.newRotation.copyFrom(e),this._mode===$t.SCALE?(this._axes.rotation.copyFrom(e),this._planes.setLocalRotation(e),this._scaleGizmo.rotation.copyFrom(this.oldRotation)):(this._axes.rotation.set(0,0,0),this._planes.setLocalRotation(void 0),this._sunHelper.update(e))}_copyScaleFrom(e){this.oldScale.copyFrom(e),this.newScale.copyFrom(e)}_updateControlsVisibility(){if(!this._visible){for(const e of this._objects3d)this._scene.removeAuxiliaryObject(e);return}this._mode===$t.TRANSLATE?(this._scene.addAuxiliaryObject(this._axes),this._scene.addAuxiliaryObject(this._planes),this._scene.addAuxiliaryObject(this._markers),this._scene.addAuxiliaryObject(this._translateGizmo),this._scene.removeAuxiliaryObject(this._rotateGizmo),this._scene.removeAuxiliaryObject(this._scaleGizmo),this._scene.removeAuxiliaryObject(this._sunHelper)):this._mode===$t.ROTATE?(this._scene.addAuxiliaryObject(this._axes),this._scene.removeAuxiliaryObject(this._translateGizmo),this._scene.addAuxiliaryObject(this._rotateGizmo),this._scene.removeAuxiliaryObject(this._scaleGizmo)):(this._scene.addAuxiliaryObject(this._axes),this._scene.addAuxiliaryObject(this._planes),this._scene.removeAuxiliaryObject(this._translateGizmo),this._scene.removeAuxiliaryObject(this._rotateGizmo),this._scene.addAuxiliaryObject(this._scaleGizmo),this._scene.removeAuxiliaryObject(this._sunHelper))}_targetIsSunInstance(){var e,t;return this.target instanceof el&&((e=this.target)==null?void 0:e.light)!==void 0&&((t=this.target)==null?void 0:t.light.type)===sn.SUN}_setupCameraWorldDirection(e,t,i){const n=this._scene.camera.getCurrent();this._scene.camera.isOrthographic()?e.copyFrom(n.getWorldDirection()):(n.unprojectVector(e.set(t,i,1)),e.sub(this._cameraWorldPosition).normalize())}_getCameraRayOrigin(e,t){if(this._scene.camera.isPerspective())return this._cameraWorldPosition.clone();const i=this._scene.camera.getCurrent();Ke(i instanceof Li);const n=this._scene.camera.getWorldQuaternion(new wi),o=e*(i.right-i.left)/2,a=t*(i.top-i.bottom)/2,l=new F(o,a,0);return n.applyToVector3(l),this._cameraWorldPosition.clone().add(l)}_getAxesIntersectionPosition(e,t,i){const n=new F,o=new F,a=new wi;this._setupCameraWorldDirection(n,t,i);const l=this._getCameraRayOrigin(t,i);return this._planes.findPlaneIntersectionPoint(e,l,n,o)?(o.sub(this._axes.position),this._axes.rotation.toQuaternion(a),a.inverse().applyToVector3(o),e&Kt.X||(o.x=0),e&Kt.Y||(o.y=0),e&Kt.Z||(o.z=0),o):null}_getCameraPlaneIntersectionAngle(e,t){var h;const i=new F,n=new F,o=new F,a=this._planes.cameraPlane;i.set(0,0,-1),a.matrixWorld.transformVector3(i),n.set(-1,0,0),a.matrixWorld.transformVector3(n);const l=(h=this._getAxesIntersectionPosition(Kt.ALL,e,t))==null?void 0:h.normalize();return o.copyFrom(n).cross(l),Math.sign(i.dot(o))*Math.acos(n.dot(l))}_getInitialRotationOffset(e,t){return this._getCameraPlaneIntersectionAngle(e,t)}_getNewRotation(e,t){const i=new ui(0,0,0,On.XYZ),n=new wi,o=new wi,a=new Ce(0,0),l=new wi,c=new F,h=new F,d=new F;if(this.oldRotation.toQuaternion(l),l.normalize(),a.set(this._startClip.x-e,this._startClip.y-t),a.multiplyScalar(this.rotationSpeed),this._usedAxes===Kt.NONE){const g=this._planes.cameraPlane;return c.copyFrom(Gl),g.matrixWorld.transformVector3(c),h.set(0,1,0),g.matrixWorld.transformVector3(h),o.setFromAxisAngle(c,a.y),n.setFromAxisAngle(h,-a.x),n.multiply(o),n.multiply(l),n.normalize(),i.setFromQuaternion(n,On.ZXY),i}let u=Hl,m=0;if(this._usedAxes===Kt.ALL){const g=this._planes.cameraPlane;d.set(0,0,-1),g.matrixWorld.transformVector3(d),u=d,m=this._getCameraPlaneIntersectionAngle(e,t),m=m-this._initialRotationOffset}else{if(this._usedAxes!==Kt.Z){const g=this._usedAxes===Kt.X?Hl:Gl,b=this._usedAxes===Kt.X?-1:1;a.multiplyScalar(b*Math.sign(g.dot(this._toEye)))}this._usedAxes===Kt.X||this._usedAxes===Kt.Y||(this._usedAxes,Kt.Z),u=Yx(this._usedAxes),m=this._usedAxes===Kt.Z?-a.x:a.y}return n.setFromAxisAngle(u,m),n.multiply(l),n.normalize(),i.setFromQuaternion(n,On.ZXY),i}_getUsedAxes(e){return this.currentGizmo.usedAxes(e)}_handleHover(e,t,i){const n={hoveredCollider:null,hasAnythingChanged:!1},o=this.currentGizmo,a=this._collider.findMeshFromListAtPosition(o.colliders,e,t,!0);let l=!1;return(a!==this._currentlyHovered||this._pointerDown!==i)&&(this._currentlyHovered=a,o.highlight(a,i),l=!0),n.hoveredCollider=a,n.hasAnythingChanged=l,n}onCanvasPointerMove(e,t){if(!this.transforming)return this._handleHover(e,t,this._pointerDown).hasAnythingChanged&&this._animationController.requestFrame(),!1;if(this._axes.show(this._usedAxes),this.mode===$t.TRANSLATE){const i=this._getAxesIntersectionPosition(this._usedAxes,e,t);i&&this.newPosition.copyFrom(i.sub(this._initialPositionOffset).add(this._axes.position)),this._translateGizmo.position.copyFrom(this.newPosition),this.adjustScaleToGizmoPosition(),this._markersPosition.copyFrom(this.newPosition),this._markersPosition.sub(this._axes.position),this._markersPosition.divide(this._axes.scale),this._markers.update(this._markersPosition),(e!==this._startClip.x||t!==this._startClip.y)&&this._markers.show(this._usedAxes)}else if(this.mode===$t.ROTATE)this.newRotation.copyFrom(this._getNewRotation(e,t)),this._targetIsSunInstance()&&(this.target&&sa(this.target),this._sunHelper.update(this.target.rotation));else{const i=this._getAxesIntersectionPosition(this._usedAxes,e,t);i&&(i.addScalar(1).divide(this._initialScaleOffset),this.newScale.copyFrom(i))}return this._animationController.requestFrame(),!0}onCanvasPointerDown(e,t){const i=this._handleHover(e,t,!0);if(this._pointerDown=!0,i.hoveredCollider!==null){if(this._transforming=!0,this._usedAxes=this._getUsedAxes(i.hoveredCollider),this._startClip.x=e,this._startClip.y=t,this.mode===$t.TRANSLATE){this._planes.show(this._usedAxes),this.newPosition.copyFrom(this.oldPosition);const n=this._getAxesIntersectionPosition(this._usedAxes,e,t);this._initialPositionOffset.copyFrom(n)}else if(this.mode===$t.ROTATE)this._usedAxes===Kt.ALL&&(this.newRotation.copyFrom(this.oldRotation),this._initialRotationOffset=this._getInitialRotationOffset(e,t));else{this._planes.show(this._usedAxes===Kt.ALL?Kt.NONE:this._usedAxes),this.newScale.copyFrom(this.oldScale);const n=this._getAxesIntersectionPosition(this._usedAxes,e,t);this._initialScaleOffset.copyFrom(n).addScalar(1).divide(this.oldScale)}return!0}return this._usedAxes=Kt.ALL,this._transforming=!1,i.hasAnythingChanged&&this._animationController.requestFrame(),!1}onCanvasPointerUp(e,t){this.transforming&&(this._copyPositionFrom(this.newPosition),this._copyRotationFrom(this.newRotation),this._copyScaleFrom(this.newScale),this._planes.show(Kt.NONE),this._markers.show(Kt.NONE),this._usedAxes=Kt.ALL,this._axes.show(this._usedAxes),this.currentGizmo.visible=!0);const i=this.transforming;return this._transforming=!1,this.update(),this._handleHover(e,t,!1).hasAnythingChanged&&this._animationController.requestFrame(),this._pointerDown=!1,i}updateHelpers(){this._targetIsSunInstance()?this._scene.addAuxiliaryObject(this._sunHelper):this._scene.removeAuxiliaryObject(this._sunHelper)}adjustScaleToGizmoPosition(){if(this._scene.camera.isOrthographic())this._setScale(this._scene.camera.orthoFrustumSize*Nm.ORTHOGRAPHIC);else{const e=this.currentGizmo.position.distanceTo(this._cameraWorldPosition);this._setScale(e*this._scene.camera.fov*Nm.PERSPECTIVE)}}update(){var e;this.transforming||(((e=this.target)==null?void 0:e.position)!==void 0&&this._copyPositionFrom(this.target.position),this.target&&sa(this.target)&&this._copyRotationFrom(this.target.rotation),this.target&&Vl(this.target)&&this._copyScaleFrom(this.target.scale)),this._toEye.copyFrom(this._cameraWorldPosition),this._toEye.sub(this._axes.position),this._toEye.normalize(),this.adjustScaleToGizmoPosition(),this._rotateGizmo.update(this._scene.camera),this._planes.update(this._scene.camera),this._axes.update(this._cameraWorldPosition);for(const t of this._objects3d)t.updateMatrixWorld()}}class Jh{constructor(e,t,i,n,o){r(this,"target");r(this,"_update");r(this,"_position",new F);r(this,"_rotation",new ui);r(this,"_scale",new F);r(this,"_oldPosition");r(this,"_oldRotation");r(this,"_oldScale");this._update=e,this.target=t,i&&this._position.copyFrom(i),n&&this._rotation.copyFrom(n),o&&this._scale.copyFrom(o),this._oldPosition=i,this._oldRotation=n,this._oldScale=o}apply(){var t,i,n;const e=new Jh(this._update,this.target,this._oldPosition,this._oldRotation,this._oldScale);return(t=this._oldPosition)==null||t.copyFrom(this._position),(i=this._oldRotation)==null||i.copyFrom(this._rotation),(n=this._oldScale)==null||n.copyFrom(this._scale),this._update(),e}}class oa{constructor(e){r(this,"transforms");this.transforms=e}static fromTargets(e,t){const i=new Array;for(const n of e)i.push(new Jh(t,n,n.position,sa(n)?n.rotation:void 0,Vl(n)?n.scale:void 0));return new oa(i)}apply(){const e=new Array;for(const t of this.transforms)e.push(t.apply());return new oa(e)}isMergable(e){return!(e instanceof oa)||e.transforms.length!==this.transforms.length?!1:e.transforms.every((t,i)=>t.target===this.transforms[i].target)}}class ly{constructor(e,t,i,n,o,a){r(this,"history");r(this,"_controls");r(this,"_enabled",!1);r(this,"_transformGizmo");r(this,"_callbacks",{itemModified:ja});r(this,"_supportedModes",new Array);r(this,"_helper");this._controls=o,this._enabled=!1,this._transformGizmo=new ay(i,n,o.cameraWorldPosition(),t),this._transformGizmo.mode=$t.TRANSLATE,this.history=a,this._helper=new ul(e,M.POINTER_PRIORITY.TRANSFORM_CONTROLS),this._helper.callbacks.onPointerDown=(l,c)=>{const h=this._transformGizmo.onCanvasPointerDown(l,c);return this._setControlsEnabledState(!this._transformGizmo.transforming),h},this._helper.callbacks.onPointerUp=(l,c)=>{const h=this._transformGizmo.onCanvasPointerUp(l,c);return this._setControlsEnabledState(!this._transformGizmo.transforming),h},this._helper.callbacks.onPointerMove=(l,c)=>{const h=this._transformGizmo.onCanvasPointerMove(l,c);if(!this._transformGizmo.transforming)return h;this.target;const d=oa.fromTargets([this.target].concat(this.subTargetsData.map(u=>u.target)),()=>{this.target&&this.target.position,this._callbacks.itemModified(this.target),this.target.setPosition(...this.target.position.toArray())});return this.history.addItem(d),this._transformGizmo.mode===$t.TRANSLATE?this._updateTargetsAfterTranslation():this._transformGizmo.mode===$t.ROTATE?this._updateTargetsAfterRotation():this._updateTargetsAfterScaling(),h},this._helper.disable()}get supportedModes(){return this._supportedModes}get mode(){return this._transformGizmo.mode}get target(){return this._transformGizmo.target}get subTargetsData(){return this._transformGizmo.subTargetsData}setTransformMode(e){this._transformGizmo.mode=e}setItemModifiedCallback(e){console.assert(this._callbacks.itemModified===ja),this._callbacks.itemModified=e}update(){this._enabled&&this._transformGizmo.update()}enable(e,t,i=[]){this._enabled=!0,this._setTarget(e,i),this._supportedModes=t,this._supportedModes.indexOf(this._transformGizmo.mode)===-1&&(this._transformGizmo.mode=t[0]),this._helper.enable()}disable(){this._enabled=!1,this._supportedModes=[],this._transformGizmo.visible=!1,this._helper.disable()}_updateTargetsAfterTranslation(){this.target&&this.target.position&&this.target.setPosition;const e=this._transformGizmo.newPosition,t=e.clone().sub(this.target.position);this.target.setPosition(e.x,e.y,e.z),this._callbacks.itemModified(this.target),this.subTargetsData&&this.subTargetsData.forEach(i=>{i.isSupported(this._transformGizmo.mode)&&(i.offsetPosition(t),this._callbacks.itemModified(i.target))})}_updateTargetsAfterRotation(){this.target&&sa(this.target);const e=this._transformGizmo.newRotation,t=new F(e.x-this.target.rotation.x,e.y-this.target.rotation.y,e.z-this.target.rotation.z),i={x:this.target.rotation.x+t.x,y:this.target.rotation.y+t.y,z:this.target.rotation.z+t.z};this.target.setRotation(i.z,i.x,i.y),this._callbacks.itemModified(this.target),this.subTargetsData&&this.subTargetsData.forEach(n=>{n.isSupported(this._transformGizmo.mode)&&(n.offsetRotation(t),this._callbacks.itemModified(n.target))})}_updateTargetsAfterScaling(){this.target&&Vl(this.target);const e=this._transformGizmo.newScale,t=e.clone().sub(this.target.scale);this.target.setScale(e.x,e.y,e.z),this._callbacks.itemModified(this.target),this.subTargetsData&&this.subTargetsData.forEach(i=>{i.isSupported(this._transformGizmo.mode)&&(i.offsetScale(t),this._callbacks.itemModified(i.target))})}_setControlsEnabledState(e){this._controls.isEnabled()!==e&&(e?this._controls.enable():this._controls.disable())}_setTarget(e,t){this._transformGizmo.target=e,this._transformGizmo.subTargetsData=t,e!==null&&(this._transformGizmo.update(),this._transformGizmo.visible=!0,this._transformGizmo.updateHelpers())}}class cy{constructor(e,t){r(this,"_nodesPrimary");r(this,"_nodesSecondary");this._nodesPrimary=e,this._nodesSecondary=t}set highlightMix(e){this._nodesPrimary.forEach(t=>t.highlightMix=e),this._nodesSecondary.forEach(t=>t.highlightMix=e)}set selected(e){this._nodesPrimary.forEach(t=>t.selected=e),this._nodesSecondary.forEach(t=>t.selectedSecondary=e)}}class Pt{constructor(e,t,i,n,o,a){r(this,"_scene");r(this,"_collider");r(this,"_animationController");r(this,"_lightControls");r(this,"_lightProbeControls");r(this,"transformControls");r(this,"_cameraVolumeTriggerControls");r(this,"_updateSelectionHighlight",!1);r(this,"_selectedItems",[]);r(this,"_selectionTimeLeft",0);r(this,"_selectedNodeGroup");r(this,"_distanceToObject",0);r(this,"_clickIntersection",new ws);r(this,"_selectionTimeSec",1);r(this,"_mode",Pt.SelectionMode.OFF);r(this,"_callbacks",{materialClicked:void 0,lightInstanceClicked:void 0,lightProbeClicked:void 0,nodeClicked:void 0,extensionClicked:void 0,positionClicked:void 0});r(this,"_extensionManager");r(this,"history",new Nx);this._scene=t,this._collider=i,this._animationController=n,this._extensionManager=a,this._lightControls=new jx(t,n),this._lightProbeControls=new Xx(t,n),this._selectionTimeLeft=0,this._distanceToObject=0,this._clickIntersection=new ws,this.transformControls=new ly(e,n,t,i,o,this.history),this._cameraVolumeTriggerControls=new kx(t,n),this._registerPointerEventHandlers(e),this.setSelectionMode(Pt.SelectionMode.OFF,!0)}_removeCurrentSelection(){this._selectedItems.forEach(e=>{e instanceof Uc||(e.selected=!1),e.highlightMix=0}),this._selectedItems.length=0}_updateSelectionIntensity(){this._selectedItems.forEach(e=>{e.highlightMix=.8*Math.pow(this._selectionTimeLeft/this._selectionTimeSec,2)})}_selectItemByMaterial(e){this._removeCurrentSelection(),e instanceof Uc?this._selectedItems.push(e):e instanceof Ht&&this._scene.threeScene.traverse(t=>{t instanceof Bn&&t.material===e&&(t.selected=!0,this._selectedItems.push(t))}),this._updateSelectionHighlight=!0,this._selectionTimeLeft=this._selectionTimeSec,this._updateSelectionIntensity(),this._animationController.requestFrame()}_getSupportedModeForLightInstance(e){return e.light.type==sn.POINT&&!e.light.photometricProfile?[$t.TRANSLATE]:e.light.type==sn.SUN?[$t.ROTATE]:[$t.TRANSLATE,$t.ROTATE]}get selectionMode(){return this._mode}selectMaterial(e){this._selectItemByMaterial(e)}selectLights(e,t){this._lightControls.showSelectionMesh(e,t),this._animationController.requestFrame()}selectLightInstances(e,t,i){this._mode,Pt.SelectionMode.LIGHT;const n=o=>{const a=new Array;for(const l of this._getSupportedModeForLightInstance(e))a[l]=!0;return o.map(l=>new qx(l,a))};if(this._lightControls.showInstancesSelectionMesh(e,t),e){const o=this._getSupportedModeForLightInstance(e);this.transformControls.enable(e,o,n(t))}else this.transformControls.disable();if(i){const o=this._lightControls.getLightInstanceMaterial(i);this._selectItemByMaterial(o)}else this._animationController.requestFrame()}selectLightProbe(e){this._mode,Pt.SelectionMode.LIGHT_PROBE;let t;e?(this._lightProbeControls.showLightProbeBoundingBox(e),t=this._lightProbeControls.getLightProbeMaterial(e),this.transformControls.enable(e,[$t.TRANSLATE])):this.transformControls.disable(),this._selectItemByMaterial(t)}selectCameraVolumeTrigger(e){this._mode,Pt.SelectionMode.CAMERA_VOLUME,e?(this._cameraVolumeTriggerControls.setControlsVisible(!0),this._selectItemByMaterial(this._cameraVolumeTriggerControls.setHighlightedCameraVolumeTrigger(e)),this.transformControls.enable(e,[$t.TRANSLATE,$t.ROTATE,$t.SCALE]),e.addEventListener(pn.eventType.DISPOSED,()=>this.transformControls.disable())):(this._selectItemByMaterial(void 0),this.transformControls.disable())}selectExtension(e){if(this._mode,Pt.SelectionMode.EXTENSION,!e||e.triggers.length===0)return;const t=e.triggers[0];t instanceof Ys&&this._selectItemByMaterial(t.material)}selectNodes(e,t,i,n){if(this._mode,Pt.SelectionMode.NODE,this._selectedNodeGroup&&(this._selectedNodeGroup.selected=!1,this._removeCurrentSelection()),e||t.length){const o=[e].concat(i),a=t.concat(n);this._selectedNodeGroup=new cy(o,a),this._selectedNodeGroup.selected=!0,this._selectedItems.push(this._selectedNodeGroup),this._updateSelectionHighlight=!0,this._selectionTimeLeft=this._selectionTimeSec,this._updateSelectionIntensity()}else this._selectedNodeGroup=void 0;this._animationController.requestFrame()}update(e){this.transformControls.update(),this._updateSelectionHighlight&&(this._selectionTimeLeft>0?(this._selectionTimeLeft-=e,this._updateSelectionIntensity()):(this._selectedItems.forEach(t=>{t.highlightMix=0}),this._updateSelectionHighlight=!1),this._animationController.requestFrame())}_playAnimatedMaterials(){for(const e of this._scene.materialManager.getAnimatedMaterials())e.play()}_pauseAnimatedMaterials(){for(const e of this._scene.materialManager.getAnimatedMaterials())e.pause()}setDistanceToObject(e){this._distanceToObject=e}setSelectionMode(e,t=!1){!t&&e===this._mode||(this._mode===Pt.SelectionMode.CAMERA_VOLUME&&this._cameraVolumeTriggerControls.setControlsVisible(!1),this._removeCurrentSelection(),e==Pt.SelectionMode.LIGHT?this._lightControls.showLights():this._lightControls.hideLights(),e==Pt.SelectionMode.LIGHT_PROBE?this._lightProbeControls.showLightProbes():this._lightProbeControls.hideLightProbes(),this.transformControls.disable(),e===Pt.SelectionMode.MATERIAL||e===Pt.SelectionMode.EXTENSION?this._playAnimatedMaterials():this._pauseAnimatedMaterials(),this._mode=e)}setMaterialClickedCallback(e){this._callbacks.materialClicked,this._callbacks.materialClicked=e}setLightInstanceClickedCallback(e){this._callbacks.lightInstanceClicked,this._callbacks.lightInstanceClicked=e}setLightProbeClickedCallback(e){this._callbacks.lightProbeClicked,this._callbacks.lightProbeClicked=e}setNodeClickedCallback(e){this._callbacks.nodeClicked,this._callbacks.nodeClicked=e}setExtensionClickedCallback(e){this._callbacks.extensionClicked,this._callbacks.extensionClicked=e}setPositionClickedCallback(e){this._callbacks.positionClicked,this._callbacks.positionClicked=e}getMeshAtPosition(e,t){return this._collider.findObstacleMeshAtPosition(e,t,!1)}_findClickedMaterial(e,t){const i=this._collider.findObstacleMeshAtPosition(e,t,!1);return i!==null?i.material:null}_findClickedLightInstance(e,t){const i=this._collider.findMeshFromListAtPosition(this._lightControls.lightInstanceMeshes,e,t);return i!==null?i.userData.lightInstance:null}_findClickedLightProbe(e,t){const i=this._collider.findMeshFromListAtPosition(this._lightProbeControls.lightProbeMeshes,e,t);return i!==null?i.lightProbes[0]:null}_findClickedNode(e,t){const i=this._collider.findObstacleMeshAtPosition(e,t,!1);return i instanceof Bn?i.node:null}_findClickedAnchor(e,t){if(!this._collider.findIntersectionAtPosition(e,t,!1,this._clickIntersection))return;const i=this._clickIntersection.object.anchor;return i!=null?i:void 0}_findClickedPosition(e,t){return!this._collider.findIntersectionAtPosition(e,t,!1,this._clickIntersection)||this._clickIntersection.object.anchor?null:this._collider.movePointTowardsTheCamera(this._clickIntersection.point,this._distanceToObject)}_registerPointerEventHandlers(e){const t=new ul(e,M.POINTER_PRIORITY.EDITOR_SELECTOR);t.callbacks.onClick=(i,n,o)=>{if([Pt.SelectionMode.OFF,Pt.SelectionMode.CAMERA_VOLUME].includes(this._mode))return!1;let a=null,l=!1;switch(this._mode){case Pt.SelectionMode.MATERIAL:a=this._findClickedMaterial(i,n),a!==null&&this._callbacks.materialClicked&&(l=this._callbacks.materialClicked(a,o));break;case Pt.SelectionMode.LIGHT:a=this._findClickedLightInstance(i,n),a!==null&&this._callbacks.lightInstanceClicked&&(l=this._callbacks.lightInstanceClicked(a,o));break;case Pt.SelectionMode.LIGHT_PROBE:a=this._findClickedLightProbe(i,n),a!==null&&this._callbacks.lightProbeClicked&&(l=this._callbacks.lightProbeClicked(a,o));break;case Pt.SelectionMode.NODE:a=this._findClickedNode(i,n),a&&this._callbacks.nodeClicked&&(l=this._callbacks.nodeClicked(a,o));break;case Pt.SelectionMode.EXTENSION:{if(!this._callbacks.extensionClicked)break;if(a=this._findClickedAnchor(i,n),a){const c=this._extensionManager.getExtensionByTrigger(a);l=this._callbacks.extensionClicked(c,a,o)}break}case Pt.SelectionMode.POSITION:a=this._findClickedPosition(i,n),a&&this._callbacks.positionClicked&&(l=this._callbacks.positionClicked(a,o));break}return l},t.callbacks.onDoubleClick=(i,n)=>!1}}(s=>{(e=>{e[e.OFF=0]="OFF",e[e.MATERIAL=1]="MATERIAL",e[e.LIGHT=2]="LIGHT",e[e.LIGHT_PROBE=3]="LIGHT_PROBE",e[e.NODE=4]="NODE",e[e.EXTENSION=6]="EXTENSION",e[e.POSITION=7]="POSITION",e[e.CAMERA_VOLUME=8]="CAMERA_VOLUME"})(s.SelectionMode||(s.SelectionMode={}))})(Pt||(Pt={}));var jl=(s=>(s.TOP="top",s.LEFT="left",s.FRONT="front",s))(jl||{}),km=(s=>(s[s.PERSPECTIVE=0]="PERSPECTIVE",s[s.ORTHOGRAPHIC=1]="ORTHOGRAPHIC",s))(km||{}),zm=(s=>(s[s.NONE=0]="NONE",s[s.WIREFRAME_TRANSPARENT=1]="WIREFRAME_TRANSPARENT",s[s.WIREFRAME_OPAQUE=2]="WIREFRAME_OPAQUE",s))(zm||{});function ed(s){let e,t;if(s instanceof Bn){const o=Mc();s.selected===!0?(t=1.5,e=o.meshSelectedLineColor):s.selectedSecondary===!0&&(t=1.25,e=o.meshSelectedSecondaryLineColor)}return{lineColor:e,lineThickness:t}}var Vm=(s=>(s.VIEW_MODE_CHANGED="viewModeChanged",s))(Vm||{});const lc=class lc extends ei{constructor(t){super();r(this,"_scene");r(this,"_controls");r(this,"_rawRenderer");r(this,"_teleport");r(this,"_animationController");r(this,"_internalViews");r(this,"_wireframeMaterial");r(this,"_autoClearAlter");r(this,"_clearColorAlter");r(this,"_currentMaterialOverride");r(this,"_transparentWireframeMaterial");r(this,"_opaqueWireframeMaterial");r(this,"_onViewModeChanged",t=>{this.dispatchEvent({type:lc.eventType.VIEW_MODE_CHANGED,viewMode:t})});this._scene=t.scene,this._controls=t.controls,this._rawRenderer=t.rawRenderer,this._teleport=t.teleport,this._animationController=t.animationController,this._internalViews=this._scene.internalViews;const i=this._scene.boundingBox.getBoundingSphere().radius*2;this._wireframeMaterial=new Ts(void 0,i,ed),this._transparentWireframeMaterial=new Ts(void 0,i,ed,!0),this._opaqueWireframeMaterial=new Ts(void 0,i,ed,!1),this._autoClearAlter=new is(this._rawRenderer),this._clearColorAlter=new dh(this._rawRenderer),this._currentMaterialOverride=0,this._bindUi()}_bindUi(){const t=document.getElementById("view-mode");if(!t)return;t.style.display="block";const i=(n,o)=>{var a;(a=document.getElementById(n))==null||a.addEventListener("click",o)};i("view-mode-top",()=>this._setViewModeType("top")),i("view-mode-front",()=>this._setViewModeType("front")),i("view-mode-left",()=>this._setViewModeType("left")),i("view-mode-fps",()=>this._switchToFpsView()),i("view-mode-persp",()=>this._setProjectionType(0)),i("view-mode-ortho",()=>this._setProjectionType(1)),i("view-mode-color",()=>this._setMaterialOverride(0)),i("view-mode-wireframe-opaque",()=>this._setMaterialOverride(2)),i("view-mode-wireframe-transparent",()=>this._setMaterialOverride(1))}_switchToFpsView(){const t=this._controls.getYawAngle()/Math.PI*180,i=this._controls.getPitchAngle()/Math.PI*180,n=new Hi({mode:zn.FPS,position:this._controls.cameraWorldPosition().toArray(),rotation:[t,i],fov:this._teleport.lastDestinationView.fov,internal:!0});this._teleport.switchToView(n),this._onViewModeChanged("ViewModeType.FPS")}_setViewModeType(t){const i=this._internalViews.find(n=>n.name===t);i&&(i.orthographic=this._teleport.lastDestinationView.orthographic,this._teleport.switchToView(i),this._onViewModeChanged("ViewModeType."+t.toUpperCase()))}_setProjectionType(t){var l;const i=()=>{const c=this._controls.getYawAngle()/Math.PI*180,h=this._controls.getPitchAngle()/Math.PI*180;return[c,h]},n=t===1?this._scene.boundingBox.getBoundingSphere().radius:this._teleport.lastDestinationView.distance,o=t===1?zn.ORBIT:this._teleport.lastDestinationView.mode,a=this._teleport.teleportingToView?this._teleport.lastDestinationView:new Hi({position:this._controls.cameraWorldPosition().toArray(),rotation:i(),orthoFrustumSize:this._teleport.lastDestinationView.orthoFrustumSize,target:(l=this._teleport.lastDestinationView.target)==null?void 0:l.toArray(),mode:o,distance:n,internal:!0});a.orthographic=t===1,this._teleport.switchToView(a),this._onViewModeChanged("ProjectionType."+km[t])}_setMaterialOverride(t){switch(t){case 0:this._removeMaterialOverride(),this._currentMaterialOverride=0;break;case 2:this._setWireframeMaterial(this._opaqueWireframeMaterial),this._currentMaterialOverride=2;break;case 1:this._setWireframeMaterial(this._transparentWireframeMaterial),this._currentMaterialOverride=1;break}this._onViewModeChanged("MaterialOverride."+zm[t])}_removeMaterialOverride(){this._currentMaterialOverride!==0&&(this._autoClearAlter.restore(),this._clearColorAlter.restore()),this._scene.gpuMeshes.forEach(t=>{t.materialOverride=null}),this._scene.skyMeshes.forEach(t=>{t.visible=!0}),this._animationController.requestFrame()}_setWireframeMaterial(t){this._currentMaterialOverride===0&&(this._autoClearAlter.set(!0,!1,!1),this._clearColorAlter.set(Mc().wireframeModeClearColor)),this._scene.gpuMeshes.forEach(i=>{i.materialOverride=t,this._rawRenderer.uploadNewBuffers(i)}),this._scene.skyMeshes.forEach(i=>{i.visible=!1}),this._animationController.requestFrame()}};r(lc,"eventType",Vm);let Xl=lc;function ra(s){return s.reduce((e,t)=>Math.max(e,t.id),0)+1}function hy(s,e){return s.every(t=>t.name!==e)}function fr(s,e){let t=s;for(let i=2;!hy(e,t);i+=1)t=s+i.toString();return t}function td(s,e,t){e.name="",e.name=fr(s,t)}function dy(s){return s.trim()||"light"}function Gm(s){return s.trim()||"view"}function uy(s){return[mn(Math.atan2(-s.x,s.y)),mn(Math.asin(s.z))]}class fy{constructor(e,t,i,n,o,a,l,c,h,d,u,m,g,b){r(this,"scene");r(this,"menu");r(this,"controls");r(this,"collider");r(this,"teleport");r(this,"editorSelector");r(this,"extensionManager");r(this,"screenshotTaker");r(this,"animationController");r(this,"minimap");r(this,"autoTour");r(this,"sceneStats");r(this,"disableCache");r(this,"pauseLoadedVideoTextures");r(this,"textureManager");r(this,"skyLoader");r(this,"transformControls");r(this,"viewModeControls");r(this,"history");r(this,"materialLoader");r(this,"materialBallRenderer");r(this,"removedViewsToHiddenNodes",new Map);r(this,"_requestLiveLightmapUpdate",()=>{});this.scene=e,this.menu=t,this.controls=i,this.collider=n,this.teleport=o,this.editorSelector=a,this.extensionManager=l,this.screenshotTaker=c,this.animationController=h,this.minimap=d,this.autoTour=u,this.viewModeControls=m,this.materialLoader=g,this.materialBallRenderer=b,this.sceneStats={geometryFacesCnt:this.scene.nodes.reduce((v,E)=>v+E.facesInSubtree(),0),objectsCnt:this._getObjectsCnt(),lightmapsCnt:this._getLightmapsCnt()},this.disableCache=!0,this.pauseLoadedVideoTextures=!1,this.textureManager=e.textureManager,this.skyLoader=new Vh(this.textureManager),this.transformControls=this.editorSelector.transformControls,this.history=this.editorSelector.history;const x=()=>{this._requestLiveLightmapUpdate(),this.scene.liveLightmap.mode===Ja.LIVE&&(this.scene.liveLightmap.mode=Ja.BASIC)};this.scene.camera.addEventListener(gi.eventType.POSITION_CHANGED,x),this.scene.camera.addEventListener(gi.eventType.ROTATION_CHANGED,x),this.scene.camera.addEventListener(gi.eventType.PHYSICAL_DIMENSIONS_CHANGED,x),this.scene.liveLightmap.addEventListener(Qo.eventType.UPDATE_NEEDED,()=>this._requestLiveLightmapUpdate())}setLiveLightmapCallback(e){this._requestLiveLightmapUpdate=e}_getObjectsCnt(){let e=0;return this.scene.visitAllNodes(function(t){t.mesh&&e++}),e}_getLightmapsCnt(){let e=-1;return this.scene.visitAllNodes(function(t){t.mesh&&t.mesh.lightmapIdx>e&&(e=t.mesh.lightmapIdx)}),e+1}get screenAspectRatio(){return this.scene.camera.aspectRatio}setLiveLightmap(e){this.scene.liveLightmap.mode=Ja.LIVE,this.scene.liveLightmap.set(e)}getLightmapLayoutVersion(){return this.scene.lightmapLayoutVersion}getExtensionManager(){return this.extensionManager}getCameraPosition(){const e=this.controls.cameraWorldPosition();return[e.x,e.y,e.z]}getCameraRotation(){return[mn(this.controls.getYawAngle()),mn(this.controls.getPitchAngle())]}getPointInFrontOfTheCamera(e=1){const t=this.collider.distanceToObstacle(e);t<e&&(e=t);const i=this.controls.cameraWorldPosition(),n=this.controls.getYawAngle(),o=this.controls.getPitchAngle(),a=e*Math.cos(o)*Math.sin(n),l=e*Math.cos(o)*Math.cos(n),c=e*Math.sin(o),h=i.x-a,d=i.y+l,u=i.z+c;return[h,d,u]}getCamera(){return this.scene.camera}getSceneStats(){return this.sceneStats}getMaterials(){return this.scene.materialManager.materials.slice(0)}getLights(){return this.scene.lightManager.lights}getLightProbes(){return this.scene.lightProbes}getCameraVolumes(){return this.scene.cameraVolumes}getNodes(){return this.scene.nodes}getNodesForMaterial(e){const t=new Array;return this.scene.visitAllNodes(i=>{var n;((n=i.mesh)==null?void 0:n.material)===e&&t.push(i)}),t}getMinimap(){return this.minimap}getMinimapConfig(){return this.scene.minimapConfig}setLevelSelectedCallback(e){this.minimap.addEventListener(Cl.eventType.LEVEL_SELECTED,t=>{t.level!==null&&e(t.level)})}getBoundingBox(){return this.scene.boundingBox}addLight(e){this.scene.addLight(e)}createLight(e,t,i){const n=new es({name:fr(e,this.getLights()),type:t,doNotImport:!0});return n.addInstance(i),n}removeLight(e){this.scene.removeLight(e)}renameLight(e,t){td(dy(t),e,this.getLights())}createLightInstance(e,t,i=[0,-90,0]){const n=new F().fromArray(t),o=new ui().setFromDegTriple(i);return new el(e,n,o)}addLightInstance(e){console.assert(this.getLights().some(t=>t===e.light)),e.light.addCreatedInstance(e)}cloneLightInstance(e){const t=this.createLightInstance(e.light,[0,0,0]);return this.cloneIntoLightInstance(t,e),t}cloneIntoLightInstance(e,t){e.position.copyFrom(t.position),e.rotation.copyFrom(t.rotation)}removeLightInstance(e,t){e.removeInstance(t)}addLightProbe(e){console.assert(this.scene.lightProbes.every(t=>t.id!==e.id)),this.scene.addLightProbe(e),this.scene.lightProbes.length===1&&this.scene.enableLightProbesForMaterials()}createLightProbe(e){const t=new Mi({id:ra(this.scene.lightProbes),position:e});return t.enableBoundingBox(),t}cloneLightProbe(e){const t=this.createLightProbe([0,0,0]);return this.cloneIntoLightProbe(t,e),t}cloneIntoLightProbe(e,t){const i=t.position.toArray();e.setPosition(...i),e.setBoxMin(...t.boxMin.toArray()),e.setBoxMax(...t.boxMax.toArray()),t.isBoundingBoxEnabled()||e.disableBoundingBox(),e.id=ra(this.scene.lightProbes)}removeLightProbe(e){this.scene.removeLightProbe(e),this.scene.lightProbes.length===0&&this.scene.disableLightProbesForMaterials()}getCameraVolumeTypes(){return Object.values(al)}createCameraVolume(e,t){const i=new F().fromArray(this.getCameraPosition()),n=this.getCameraRotation(),o=new F(0,3,0);new ui(n[0]/180*Math.PI,n[1]/180*Math.PI,0).applyToVector3(o);const l=ra(this.scene.cameraVolumes);return Pe(e===al.CUBE||e===al.SPHERE),new kh({id:l,name:t||e+l,type:e,position:i.add(o).toArray(),rotation:[0,0,0],scale:[1,1,1],exposure:this.scene.camera.defaultExposure,gamma:this.scene.camera.defaultGamma},this.scene.camera,this.scene.exposureController)}addCameraVolume(e){console.assert(this.scene.cameraVolumes.every(t=>t.id!==e.id)),e.name=fr(e.name,this.scene.cameraVolumes),e.reinstate(),this.scene.addCameraAdjustmentVolume(e)}cloneCameraVolume(e){const t=this.createCameraVolume(e.getCameraVolumeTrigger().volumeType);return this.cloneIntoCameraVolume(t,e),t}cloneIntoCameraVolume(e,t){const i=t.getCameraVolumeTrigger(),n=e.getCameraVolumeTrigger();n.position.copyFrom(i.position),n.rotation.copyFrom(i.rotation),n.scale.copyFrom(i.scale),e.exposure=t.exposure,e.gamma=t.gamma}removeCameraVolume(e){this.scene.removeCameraVolume(e)}shiftCameraVolume(e,t){this.scene.shiftCameraVolume(e,t)}getCameraVolumesIndex(e){return this.scene.cameraVolumes.findIndex(t=>t===e)}getViews(){return this.scene.views}markScreenshotArea(e){this.screenshotTaker.markArea(e)}unmarkScreenshotArea(){this.screenshotTaker.unmarkArea()}monoScreenToBuffer(e,t,i){return this.screenshotTaker.monoScreenToBuffer(e,t,i)}stereoPanoramaToBuffer(e,t,i,n){this.screenshotTaker.stereoPanoramaToBuffer(e,t,i,n)}_fillParamsForTopViewType(e){const t=this.controls.orbit,i=this.controls.cameraWorldPosition();e.mode=zn.ORBIT,e.sky=M.DEFAULT_SKY_NAME,e.panPrimary=!0,e.noPitchRotate=!0,Pe(e.rotation),e.rotation[1]=-90,e.minUpAngle=0,e.maxUpAngle=Math.PI/2,t.isEnabled()?(e.target=[t.target.x,t.target.y,this.scene.boundingBox.min.z],e.distance=t.getCameraDistance(),e.minDistance=t.getMinDistance(),e.maxDistance=t.getMaxDistance()):(e.target=[i.x,i.y,this.scene.boundingBox.min.z],e.distance=Math.max(i.z-this.scene.boundingBox.min.z,1))}_fillParamsForOrbitViewType(e){const t=this.controls.orbit,i=this.controls.cameraWorldPosition();if(e.mode=zn.ORBIT,e.sky=M.DEFAULT_SKY_NAME,e.panPrimary=!1,e.noPitchRotate=!1,t.isEnabled())e.target=t.target.toArray(),e.distance=t.getCameraDistance(),e.minDistance=t.getMinDistance(),e.maxDistance=t.getMaxDistance(),e.minUpAngle=-t.getMaxPitchAngle(),e.maxUpAngle=-t.getMinPitchAngle(),e.noPan=t.getNoPan();else{e.minUpAngle=0,e.maxUpAngle=Math.PI/2;const n=this.scene.center.clone();e.target=n.toArray();const o=n;o.sub(i),e.distance=o.length(),o.normalize(),e.rotation=uy(o),e.rotation[1]=xi(e.rotation[1],-e.maxUpAngle,e.minUpAngle)}}createViewFromCamera(e,t){const i=[0,0];i[0]=mn(this.controls.getYawAngle()),i[1]=mn(this.controls.getPitchAngle());const n={id:ra(this.scene.allViews()),name:fr(Gm(e),this.scene.allViews()),rotation:i};if(t==="fps"){const o=this.controls.cameraWorldPosition();n.mode=zn.FPS,n.sky=M.EDITOR_CONTROLLED_SKY_NAME,n.position=o.toArray()}else t==="top"?this._fillParamsForTopViewType(n):this._fillParamsForOrbitViewType(n);return new Hi(n)}addView(e){console.assert(this.scene.allViews().every(i=>i.id!==e.id)),e.name=fr(e.name,this.scene.allViews());const t=this.removedViewsToHiddenNodes.get(e);if(t){for(const i of t)i.isOnHideInViews(e.id)||i.addToHideInViews(e.id);this.removedViewsToHiddenNodes.delete(e)}this.scene.addView(e)}cloneView(e){const t=this.createViewFromCamera("","fps");return this.cloneIntoView(t,e),t}cloneIntoView(e,t){Object.assign(e,new Hi(t.serialize())),e.id=ra(this.scene.allViews()),this.scene.nodeConfigs.forEach(function(i){i.hideInViews&&i.isOnHideInViews(t.id)&&i.addToHideInViews(e.id)})}resetViewFromCamera(e){const t=this.controls.cameraWorldPosition();e.mode===zn.FPS?e.position.copyFrom(t):(e.target.copyFrom(this.controls.orbit.target),e.distance=t.distanceTo(e.target)),(e.mode===zn.FPS||!e.isTop())&&(e.rotation.pitch=this.controls.getPitchAngle()),e.setYaw(this.controls.getYawAngle())}removeView(e){const i=this.scene.nodeConfigs.filter(n=>n.hideInViews&&n.isOnHideInViews(e.id));this.removedViewsToHiddenNodes.set(e,i),this.scene.removeView(e)}shiftView(e,t){this.scene.shiftView(e,t)}getViewsIndex(e){return this.scene.views.findIndex(t=>t===e)}activateSkyForView(e){this.teleport.activateSky(e)}setCameraPosition(e,t,i){this.controls.cameraWorldPosition().set(e,t,i),this.controls.cameraTransformUpdated()}isTeleporting(){return this.teleport.teleportingToView||this.teleport.teleportingToPoint}switchToView(e,t){this.autoTour.isRunning()&&this.autoTour.stop(),this.teleport.switchToView(e,t),xo()}renameView(e,t){td(Gm(t),e,this.scene.allViews())}updateHiddenMeshes(e){this.teleport.updateHiddenMeshes(e)}getSky(){return this.scene.findSkyMesh(M.EDITOR_CONTROLLED_SKY_NAME)}loadSkyTexture(e){return this.skyLoader.loadSkyTexture(e)}loadTexture(e,t){Pe(typeof e.id=="string"),this.textureManager.remove(e.id);const i=this.textureManager.load(e,nn.REPEAT_WRAPPING|nn.GENERATE_MIPS,M.LOAD_PRIORITY.CORE_RESOURCE,!0);return t===Vi.BASE_COLOR&&(i.isCutout=void 0),i}materialTextureUpdated(e,t){const n=new Set;let o="";const a=function(l){const c=l.geometry;if(!(c.vertexCnt===0||c.hasAttribute("uv0"))&&!n.has(l.node.type)){if(n.add(l.node.type),n.size>5)return;o+=o.length>0?", ":"",o+=`'${l.node.type}'`}};return e.textureNeedsUv0(t)&&this.scene.visitMeshesWithMaterial(e,a),n.size===0?!1:`Texture ${t} won't be correctly mapped. The following objects lack base color UV mapping coming from the 3D modeling tool: ${o} `+(n.size>5?` (plus ${n.size-5} more).`:".")}changeSkyTexture(e){const t=this.scene.findSkyMesh(M.EDITOR_CONTROLLED_SKY_NAME),i=this.scene.sharedMaterialState.fog;if(!e&&t.type===Cs.EQUIRECT){this.scene.removeSkyMesh(t);const n={name:M.EDITOR_CONTROLLED_SKY_NAME,type:Cs.PROCEDURAL};this.scene.addSkyMesh(this.skyLoader.loadSingleSky(n,i))}else if(Pe(e),t.type===Cs.PROCEDURAL){this.scene.removeSkyMesh(t);const n={name:M.EDITOR_CONTROLLED_SKY_NAME,type:Cs.EQUIRECT,texture:e};this.scene.addSkyMesh(this.skyLoader.loadSingleSky(n,i))}else t.setTexture(e);this.scene.adjustSkiesAndCameraFarToSpanWholeScene()}getColorMapName(){return this.scene.camera.colorMap?this.scene.camera.colorMap.name:void 0}loadColorMap(e){return this.textureManager.loadColorMap(e)}getSceneJson(){return this.scene.serialize()}getCoverJson(){const e=this.menu.cover;return e.extensions=this.extensionManager.getConfigs(),e}getSelectionMode(){return this.editorSelector.selectionMode}disableSelection(){this.editorSelector.setSelectionMode(Pt.SelectionMode.OFF)}enableMaterialSelection(){this.editorSelector.setSelectionMode(Pt.SelectionMode.MATERIAL)}enableLightSelection(){this.editorSelector.setSelectionMode(Pt.SelectionMode.LIGHT)}enableLightProbeSelection(){this.editorSelector.setSelectionMode(Pt.SelectionMode.LIGHT_PROBE)}enableExtensionSelection(){this.editorSelector.setSelectionMode(Pt.SelectionMode.EXTENSION)}enablePositionSelection(e){this.editorSelector.setDistanceToObject(e),this.editorSelector.setSelectionMode(Pt.SelectionMode.POSITION)}enableNodeSelection(){this.editorSelector.setSelectionMode(Pt.SelectionMode.NODE)}enableCameraVolumeSelection(){this.editorSelector.setSelectionMode(Pt.SelectionMode.CAMERA_VOLUME)}selectMaterial(e){this.editorSelector.selectMaterial(e)}changeMaterialType(e,t){const i=this.scene.materialManager.changeMaterialType(e,t);return i.isAnimated&&i.play(),i}selectLights(e,t){this.editorSelector.selectLights(e,t)}selectLightInstances(e,t,i){this.editorSelector.selectLightInstances(e,t,i)}selectLightProbe(e){this.editorSelector.selectLightProbe(e)}selectCameraVolumeTrigger(e){this.editorSelector.selectCameraVolumeTrigger(e)}selectExtension(e){this.editorSelector.selectExtension(e)}selectNodes(e,t,i,n){this.editorSelector.selectNodes(e,t,i,n)}setMaterialClickedCallback(e){this.editorSelector.setMaterialClickedCallback(e)}setLightInstanceClickedCallback(e){this.editorSelector.setLightInstanceClickedCallback(e)}setLightProbeClickedCallback(e){this.editorSelector.setLightProbeClickedCallback(e)}setNodeClickedCallback(e){this.editorSelector.setNodeClickedCallback(e)}setExtensionClickedCallback(e){this.editorSelector.setExtensionClickedCallback(e)}setPositionClickedCallback(e){this.editorSelector.setPositionClickedCallback(e)}setItemModifiedCallback(e){this.transformControls.setItemModifiedCallback(e)}setViewSelectedCallback(e){this.teleport.addEventListener(Mn.eventType.TELEPORT_STARTED,t=>{t.view&&e(t.view)})}coverModified(e){this.menu.updateCover(e)}autoTourModified(){this.menu.refresh()}hasLightmap(){return this.scene.hasLightmap()}getAutoTour(){return this.scene.autoTour}getDisableProgressiveLoader(){return this.scene.disableProgressiveLoader}setDisableProgressiveLoader(e){this.scene.disableProgressiveLoader=e}getInteractionPrompt(){return this.scene.interactionPrompt}setInteractionPrompt(e){this.scene.interactionPrompt=e}getTransformMode(){return this.transformControls.mode}setTransformMode(e){this.transformControls.setTransformMode(e)}getSupportedTransformModes(){return this.transformControls.supportedModes}seeItem(e){Ui().seeItem(e)}onViewModeChanged(e){this.viewModeControls.addEventListener(Xl.eventType.VIEW_MODE_CHANGED,t=>e(t.viewMode))}getMeshAtPosition(e,t){const i=e/window.innerWidth*2-1,n=-(t/window.innerHeight)*2+1;return this.editorSelector.getMeshAtPosition(i,n)}getMaterialOverriddenNodeConfigs(e){return this.scene.materialManager.getOverriddenConfigs(e)}removeMaterialOverrideForNodeType(e){this.scene.materialManager.removeMaterialOverrideForNodeType(e)}overrideMaterialForNodeType(e,t){this.scene.materialManager.overrideMaterialForNodeType(e,t),this.animationController.requestFrame()}cloneMaterial(e){const t=e.serialize();return t.id=void 0,t.materialLibraryHash=void 0,this.createNewMaterial(t,Es.EDITOR)}replaceMaterialForMaterial(e,t){const i=e.name,n=e.getTextures();for(const o of n.keys())e.setTexture(o,void 0);t.id=void 0,this.materialLoader.setMaterialFromJson(e,t),e.name=i,this.animationController.requestFrame()}addMaterial(e,t){this.scene.materialManager.addMaterial(e,t)}renameMaterial(e,t){e.source,Es.EDITOR,td(t,e,this.scene.materials)}removeMaterial(e){this.scene.materialManager.removeMaterial(e)}createNewMaterial(e,t){[Es.EDITOR,Es.MATERIAL_LIBRARY].includes(t);const i=this.materialLoader.getMaterial(e,t);return e===void 0&&(i.name="Editor Material"),i.name=fr(i.name,this.scene.materials),i}}class Hm{constructor(){r(this,"onSceneLoaded");r(this,"enableCameraCollisions");r(this,"forcedInitialCameraPosition");r(this,"forcedInitialCameraRotation");r(this,"sendCoverToServer");this.onSceneLoaded=void 0,this.enableCameraCollisions=!0,this.forcedInitialCameraPosition=void 0,this.forcedInitialCameraRotation=void 0,this.sendCoverToServer=!1}}class my extends Ht{constructor(){super({vsName:"static_render_vertex.glsl",fsName:"static_render_fragment.glsl"}),this.uniforms={staticRender:{type:"t",value:null,uniformSourceType:le.MATERIAL},sizeInv:{type:"v2",value:new Ce,uniformSourceType:le.GLOBAL}}}}function py(s){const e=uf(s,{antialias:!1});return e.autoClear=!1,e.sortObjects=!1,e}class _y{constructor(e){r(this,"_material",new my);r(this,"_camera",Li.createNDC());r(this,"_scene",new nr);r(this,"_renderer");this._renderer=py(e);const t=new Ye(nt.createPlane(2,2),this._material);this._renderer.uploadNewBuffers(t),this._scene.add(t)}update(e){const t=new Float32Array(e,0,e.byteLength/4),i=t[1],n=t[2],o=t.subarray(3);i*n,o.length/3;const a=dt.newDataTexture(o,i,n,Be.RGB32F);a.minFilter=Z.NEAREST,a.magFilter=Z.NEAREST,a.generateMipmaps=!1,a.flipY=!1,a.needsUpdate=!0,this._material.accessUniform("staticRender").value=a,this._material.accessUniform("sizeInv").value.set(1/i,1/n),this._renderer.setCanvasSize(i,n),this._renderer.render(this._scene,this._camera),a.dispose()}}function gy(){M.Viewer=Zf,M.View=Hi,M.getViewer=Ui,M.getExtraAssetUrl=wr,M.initEditMode=Ub,M.ColorUtils=vs,M.TRANSFORM_MODE=$t,M.STRINGS=Pc,M.ICONS=pl,M.StaticRenderViewer=_y,M.SceneLoadConfig=Hm,M.init=dm,M.updateViewerStrings=Cd,M.getViewerStrings=$p,M.hasShiftKeyModifier=K_,M.hasCtrlEquivalentKeyModifier=$_,M.hasAltEquivalentModifier=Z_,M.StandardMaterial=gt,window.WALK=M,window.WebXRConfig=bl}class vy{constructor(e,t=[],i=[],n=[],o=!1){this.name=e,this.vertices=t,this.normals=i,this.uvs=n,this.hasUvs=o}}class by{constructor(){r(this,"_vA",new F);r(this,"_vB",new F);r(this,"_vC",new F);r(this,"_ab",new F);r(this,"_cb",new F);r(this,"objects",[]);r(this,"_currentObject");r(this,"vertices",[]);r(this,"normals",[]);r(this,"uvs",[])}startObject(e){this._currentObject=new vy(e||""),this.objects.push(this._currentObject)}_transformIndex(e,t,i){return(e>=0?e-1:e+t/i)*i}_addVertexToObject(e,t,i){this._currentObject;const n=this.vertices,o=this._currentObject.vertices;o.push(n[e+0],n[e+1],n[e+2]),o.push(n[t+0],n[t+1],n[t+2]),o.push(n[i+0],n[i+1],n[i+2])}_addNormalToObject(e,t,i){this._currentObject;const n=this.normals,o=this._currentObject.normals;o.push(n[e+0],n[e+1],n[e+2]),o.push(n[t+0],n[t+1],n[t+2]),o.push(n[i+0],n[i+1],n[i+2])}_addFaceNormalToObject(e,t,i){this._currentObject;const n=this.vertices,o=this._currentObject.normals;this._vA.fromArray(n,e),this._vB.fromArray(n,t),this._vC.fromArray(n,i),this._cb.subVectors(this._vC,this._vB),this._ab.subVectors(this._vA,this._vB),this._cb.cross(this._ab),this._cb.normalize(),o.push(this._cb.x,this._cb.y,this._cb.z),o.push(this._cb.x,this._cb.y,this._cb.z),o.push(this._cb.x,this._cb.y,this._cb.z)}_addUVToObject(e,t,i){this._currentObject;const n=this.uvs,o=this._currentObject.uvs;o.push(n[e+0],n[e+1]),o.push(n[t+0],n[t+1]),o.push(n[i+0],n[i+1])}_addDefaultUVToObject(){this._currentObject;const e=this._currentObject.uvs;e.push(0,0),e.push(0,0),e.push(0,0)}addFace(e,t,i,n,o,a,l,c,h){this._currentObject;const d=this.vertices.length,u=this._transformIndex(e,d,3),m=this._transformIndex(t,d,3),g=this._transformIndex(i,d,3);if(this._addVertexToObject(u,m,g),l!==void 0){const b=this.normals.length;this._addNormalToObject(this._transformIndex(l,b,3),this._transformIndex(c,b,3),this._transformIndex(h,b,3))}else this._addFaceNormalToObject(u,m,g);if(n!==void 0){const b=this.uvs.length;this._addUVToObject(this._transformIndex(n,b,2),this._transformIndex(o,b,2),this._transformIndex(a,b,2)),this._currentObject.hasUvs=!0}else this._addDefaultUVToObject()}}function xy(s){return s.indexOf(`\r
`)!==-1&&(s=s.replace(/\r\n/g,`
`)),s.indexOf(`\\
`)!==-1&&(s=s.replace(/\\\n/g,"")),s}function Ls(s){if(!(s===void 0||s===""))return parseInt(s,10)}function yy(s){const e=/^[og]\s*(.+)?/,t=/^mtllib /,i=/^usemtl /,n=/^usemap /,o=new by;s=xy(s);const a=s.split(`
`);let l=null;for(const h of a){if(h.length===0||h==="\0")continue;const d=h.charAt(0);if(d!=="#")if(d==="v"){const u=h.split(/\s+/);switch(u[0]){case"v":o.vertices.push(parseFloat(u[1]),parseFloat(u[2]),parseFloat(u[3])),u.length>=7&&console.assert(!1,"obj with vertex colors is not supported");break;case"vn":o.normals.push(parseFloat(u[1]),parseFloat(u[2]),parseFloat(u[3]));break;case"vt":o.uvs.push(parseFloat(u[1]),parseFloat(u[2]));break}}else if(d==="f"){const m=h.substring(1).trim().split(/\s+/),g=[];for(const x of m)if(x.length>0){const v=x.split("/");g.push(v)}const b=g[0];for(let x=1,v=g.length-1;x<v;x++){const E=g[x],w=g[x+1];o.addFace(Ls(b[0]),Ls(E[0]),Ls(w[0]),Ls(b[1]),Ls(E[1]),Ls(w[1]),Ls(b[2]),Ls(E[2]),Ls(w[2]))}}else if(d==="l")console.assert(!1,"line geometry is not supported");else if(d==="p")console.assert(!1,"obj point geometry not supported");else if((l=e.exec(h))!==null){const u=(" "+l[0].substring(1).trim()).substring(1);o.startObject(u)}else i.test(h)||t.test(h)||n.test(h)||d==="s"||console.warn('OBJLoader: Unexpected line: "'+h+'"')}const c=new Map;for(const h of o.objects){if(h.vertices.length===0)continue;const d=new on;d.addAttribute("position",new At(new Float32Array(h.vertices),3)),h.normals.length>0&&d.addAttribute("normal",new At(new Float32Array(h.normals),3)),h.hasUvs===!0&&d.addAttribute("uv0",new At(new Float32Array(h.uvs),2)),d.convertNormalsToSpherical(),d.computeBoundingBox(),d.computeBoundingSphere(),c.set(h.name,d)}return c}let Ze={};function Ay(s){for(;s.firstChild;)s.removeChild(s.firstChild)}function Ey(s,e){const t=document.getElementById(s);t.onchange=e}function ql(s){s.style.display=""}function Yl(s){s.style.display="none"}function Ty(s,e){e?ql(s):Yl(s)}function Sy(s,e){e?s.classList.add("ext-meeting-button-highlight"):s.classList.remove("ext-meeting-button-highlight")}function wy(s){s.classList.add("ext-meeting-input-missing"),window.setTimeout(()=>{s.classList.remove("ext-meeting-input-missing")},200)}function My(s){s.classList.add("ext-meeting-text-highlighted"),window.setTimeout(()=>{s.classList.remove("ext-meeting-text-highlighted")},200)}function jn(s){let e=null,t=null;this.showDismiss=!0,this.onClose=null,this.onDismiss=null,this.position=jn.DEFAULT,this.foremost=!1,this.modal=!1,this.open=function(){t===null&&(this.modal?(e=document.createElement("div"),e.className="modal-backdrop",document.body.appendChild(e),t=document.createElement("div"),e.appendChild(t)):(t=document.createElement("div"),document.body.appendChild(t)),this.update(s))},this.hide=function(){Yl(e||t)},this.unhide=function(){ql(e||t)},this.update=function(i){const n=this.showDismiss?`<div class="ext-popup-close-button-panel ui-close-hoverable">
           <div class="ext-popup-close-button"></div>
         </div>`:"",a=(()=>{switch(this.position){case jn.TOP:return"ui-top ui-center";case jn.DEFAULT:return"ui-upper-half-center";case jn.CENTER:return"ui-all-center";default:return console.log(`Invalid popup position: ${this.position}`),"ui-all-center"}})(),l=this.foremost?"ui-foremost":"";if(lo(t,`
       <div class="ext-popup ${a} ${l}">
         <div class="ext-popup-content">
           ${i}
         </div>${n}
       </div>`),gl(t),this.showDismiss){const c=t.getElementsByClassName("ext-popup-close-button-panel")[0];kn(c,()=>this.dismiss())}},this.getElementsByClassName=function(i){return t.getElementsByClassName(i)},this.dismiss=function(){t!==null&&(this.close(),this.onDismiss&&this.onDismiss())},this.close=function(){t!==null&&(this.modal?(document.body.removeChild(e),e=null):document.body.removeChild(t),t=null,this.onClose&&this.onClose())}}jn.CENTER="center",jn.DEFAULT="default",jn.TOP="top";function Py(s,e){let t="";e&&(t=`<h3 class="ext-meeting-dialog-title">${e}</h3>`),t+=`
      <div class="ext-meeting-dialog-message">
        ${s}
      </div>
      <div class="ext-meeting-dialog-buttons">
        <button class="ext-meeting-button" data-strings="meetings.close">
        </button>
      </div>
    `;const i=new jn(t);i.showDismiss=!1,i.foremost=!0,i.modal=!0,i.open();const n=i.getElementsByClassName("ext-meeting-button")[0];n.onclick=()=>{i.close()}}function Cy(s,e,t){const i=`
      <div class="ext-meeting-dialog-iframe-container">
        <h3 class="ext-meeting-dialog-title">${s}</h3>
        <iframe src="${e}" class="ext-meeting-dialog-iframe">
        </iframe>
        <div>
          <div class="ext-meeting-dialog-buttons">
            <button class="ext-meeting-button" data-strings="meetings.close">
            </button>
          </div>
        </div>
      <div>
    `,n=new jn(i);n.showDismiss=!1,n.position=jn.CENTER,n.onClose=t,n.open();const o=n.getElementsByClassName("ext-meeting-dialog-iframe")[0];o.style.visibility="hidden",o.onload=()=>{o.style.visibility="visible"};const a=n.getElementsByClassName("ext-meeting-button")[0];a.onclick=()=>n.close()}Ze={removeChildren:Ay,addChangeHandler:Ey,show:ql,hide:Yl,setVisibility:Ty,setButtonHighlight:Sy,highlightInput:wy,highlightText:My,UiPopup:jn,showMessage:Py,showIframePopup:Cy};let aa={},id=null;function nd(){if(id===null){const s=window.AudioContext||window.webkitAudioContext;id=new s}return id}class $s{constructor(e,t,i){this._frequencyDiv=t,this._noSoundThreshold=i,this._minFrequencyIndex=-1,this._maxFrequencyIndex=-1,this._noSoundCalls=0,this._source=null,this._analyser=nd().createAnalyser(),this._analyser.fftSize=this._frequencyDiv*2,this._analyser.smoothingTimeConstant=.5;const n=new MediaStream([e.mediaStreamTrack]);this._source=nd().createMediaStreamSource(n),this._source.connect(this._analyser);const o=nd().sampleRate/this._frequencyDiv;this._minFrequencyIndex=Math.floor($s._minVoiceFrequency/o),this._maxFrequencyIndex=Math.floor($s._maxVoiceFrequency/o),this._dataArray=new Uint8Array(this._maxFrequencyIndex+1)}measureSoundVolume(){const e=this._getOverallSoundVolume();return this._shouldSkipNoSoundNotification(e)?null:e}dispose(){this._source!==null&&(this._source.disconnect(),this._source=null)}_getOverallSoundVolume(){this._analyser.getByteFrequencyData(this._dataArray);let e=0;for(let t=this._minFrequencyIndex;t<=this._maxFrequencyIndex;t++)this._dataArray[t]>e&&(e=this._dataArray[t]);return e}_shouldSkipNoSoundNotification(e){return e<this._noSoundThreshold?(this._noSoundCalls++,this._noSoundCalls<$s._skippedNoSoundCalls):(this._noSoundCalls=0,!1)}}$s._minVoiceFrequency=85,$s._maxVoiceFrequency=350,$s._skippedNoSoundCalls=3;class Xn{constructor(e,t,i,n){this._width=e,this._height=t,this._bottomMargin=n!==void 0?n:0,this._volumeRect=null,this._rectId=Xn._baseRectId+Xn._counter,Xn._counter++,this._noSoundThreshold=i,this._lengthCoef=e/(255-this._noSoundThreshold)}getHTML(){return this._volumeRect=null,`
        <svg style="filter: drop-shadow(0px 0px 1px black);
                    margin-bottom: ${this._bottomMargin.toString()}px;"
             width="${this._width.toString()}px"
             height="${this._height.toString()}px">
          <rect id="${this._rectId}"
                x = "${(this._width/2-1).toString()}" y = "0"
                width="${1 .toString()}"
                height="${this._height.toString()}"
                fill="red"/>
        </svg>
      `}getEmptyHTML(){return`
        <svg width="${this._width.toString()}px"
             height="${this._height.toString()}px">
        </svg>
      `}update(e){if(this._volumeRect===null&&(this._volumeRect=document.getElementById(this._rectId)),console.assert(this._volumeRect!==null,"Volume visualizer HTML not attached to any element"),e===null)return;const t=this._getColor(e),i=Math.max(e,this._noSoundThreshold),n=Math.max(Xn._minimalDisplayedValue,i-this._noSoundThreshold),o=this._width/2-n*this._lengthCoef/2,a=n*this._lengthCoef;this._volumeRect.setAttribute("fill",t),this._volumeRect.setAttribute("x",o.toString()),this._volumeRect.setAttribute("width",a.toString())}_getColor(e){return e<this._noSoundThreshold?"red":e<Xn._lowSoundThreshold?"orange":"green"}}Xn._counter=0,Xn._baseRectId="ext-meeting-mic-bar-",Xn._lowSoundThreshold=180,Xn._minimalDisplayedValue=20,aa={VolumeMeter:$s,VolumeVisualizer:Xn};let Wm;const Ry=2e3,jm={MICROPHONE:"microphone",CAMERA:"camera"},la={name:"mic"},ca={name:"camera",facingMode:"user",width:480,height:360,frameRate:24};function Xm(s,e){return e===void 0?s.type:(s.type,e.type,"microphoneAndCamera")}function qm(s,e){const t=Xm(s,e),i=s.error.name;return console.assert(e===void 0||e.error.name===i),wt(i==="NotFoundError"?`meetings.devicesNotFound.${t}`:i==="NotAllowedError"?`meetings.devicesBlocked.${t}`:i==="Error"?"meetings.error":`meetings.devicesNotAvailable.${t}`)}function Ym(s,e){const t=e!==void 0,i=t?"twoDevices":"oneDevice",n=s.error.name;if(n==="NotFoundError"){const o=Xm(s,e);return wt(`meetings.checkIfDevicesConnected.${o}`)}else if(n==="NotAllowedError")if(Qe.mobile)if(Qe.ios){const o=t?`${s.unblockIcon} ${wt("meetings.and")} ${e.unblockIcon}`:s.unblockIcon;return`<span>
          ${wt(`meetings.unblockDevices.byButtons.${i}.beforeIcons`)}
          ${o}
          ${wt(`meetings.unblockDevices.byButtons.${i}.afterIcons`)}
        </span>`}else return wt(`meetings.unblockDevices.inBrowserSettings.${i}`);else{const o=t?e.unblockIcon:s.unblockIcon;return`<span>
        ${wt(`meetings.unblockDevices.byButtonInAddressBar.${i}.beforeIcon`)}
        ${o}
        ${wt(`meetings.unblockDevices.byButtonInAddressBar.${i}.afterIcon`)}
      </span>`}else return wt(n==="Error"?"meetings.browserDoesNotSupportMeetings":`meetings.ifConnectedCloseAppsAndRefresh.${i}`)}class Iy{constructor(e,t,i,n){this._firstErrorDiv=document.getElementById(e),this._secondErrorDiv=document.getElementById(t),this._devicePreview1=i,this._devicePreview2=n}_reset(){this._devicePreview1.setErrorDiv(null),this._devicePreview2.setErrorDiv(null),Ze.removeChildren(this._firstErrorDiv),Ze.removeChildren(this._secondErrorDiv)}_displayAndLogErrorMessage(e,t,i){function n(c){if(c!==void 0)return c.device}const o=qm(t.device,n(i)),a=Ym(t.device,n(i)),l=`
        <div class="ext-meeting-join-error-title">${o}</div>
        <div class="ext-meeting-join-error-description">${a}</div>
      `;lo(e,l),t.setErrorDiv(e),t.device.logError(),i!==void 0&&(i.setErrorDiv(e),i.device.logError())}update(){this._reset();const e=this._devicePreview1.device.error,t=this._devicePreview2.device.error;e===null&&t===null||(e!==null&&t!==null?e.name===t.name?this._displayAndLogErrorMessage(this._firstErrorDiv,this._devicePreview1,this._devicePreview2):(this._displayAndLogErrorMessage(this._firstErrorDiv,this._devicePreview1),this._displayAndLogErrorMessage(this._secondErrorDiv,this._devicePreview2)):e!==null?this._displayAndLogErrorMessage(this._firstErrorDiv,this._devicePreview1):this._displayAndLogErrorMessage(this._firstErrorDiv,this._devicePreview2))}}class Dy{constructor(e,t){this._type=e,this._active=!1,this._unblockIcon=t,this._trackOptions=null,this._track=null,this._error=null}get type(){return this._type}get track(){return this._track}set track(e){this._track=e}get active(){return this._active}set active(e){this._active=e}get unblockIcon(){return this._unblockIcon}logError(){this._error!==null&&Me.log(`Can't create local ${this.type} track : ${this._error.name}, ${this._error.message}`)}get error(){return this._error}set error(e){this._error=e}get trackOptions(){return this._trackOptions}set trackOptions(e){this._trackOptions=e}_getLabel(){return this._track?this._track.mediaStreamTrack.label:null}getId(){return this._trackOptions&&this._trackOptions.deviceId?this._trackOptions.deviceId.exact:null}getErrorMessageInfo(){if(this._error===null)return null;const e=qm(this),t=Ym(this);return{title:e,description:t}}}class Qm{constructor(e,t,i,n,o,a,l){this._device=new Dy(e,l),this._width=i,this._height=n,this._toggleButton=document.getElementById(o),this._previewContainer=document.getElementById(a),this._errorDiv=null,this._meetingStarter=t,Pi(this._toggleButton.id,this._onToggleButtonClicked.bind(this)),this._onStoppedBound=this._onStopped.bind(this),this._twilioCreateTrackFunction=null}get device(){return this._device}isAvailable(){return this._device.track!==null}dispose(){this._device.track!==null&&this._device.track.removeListener("stopped",this._onStoppedBound),this._close()}_pauseMonitoringTrackBeforeReset(){this._device.track.removeListener("stopped",this._onStoppedBound)}_resumeMonitoringTrackAfterReset(){this._device.track.addListener("stopped",this._onStoppedBound)}setErrorDiv(e){this._errorDiv=e}showInTestNeededMode(){this.setError({name:"Test needed"})}showInPreviewMode(){this.setError({name:"Initializing"}),this.setToggleButtonVisibility(!0)}createTrack(e){return new Promise((t,i)=>{const n=e||this._device.trackOptions;this._twilioCreateTrackFunction(An(n)).then(o=>{this.setTrack(o,n)}).catch(o=>{this.setTrack(null,n,o)}).finally(()=>{this._toggleButton.disabled=!1,t()})})}updateTrackDeviceId(e){const t=(i,n)=>{const o=i.find(a=>a.label===n);return o?o.deviceId:null};if(this._device.track&&!this._device.trackOptions.deviceId){const i=this._device._getLabel(),n=t(e,i);console.assert(n!==null,"deviceId not found"),this._device.trackOptions={name:this._device.trackOptions.name,deviceId:{exact:n}}}}setTrack(e,t,i){t&&(this._device.trackOptions=t),e!==null&&i!==void 0?console.assert("Invalid setTrack parameters : track and error set"):e===null&&i===void 0&&console.assert("Invalid setTrack parameters : track and error not set"),this._disposeTrack(),this._device.track=e,this._device.track!==null?(this._device.track.on("stopped",this._onStoppedBound),this._device.active=!0,this._showTrack(),this.setError(null)):(this._device.active=!1,this._hideTrack(),this.setError(i)),this._meetingStarter.updateErrorMessage(),this._updateToggleButtonState()}setError(e){this._device.error=e}restartTrack(e){this._toggleButton.disabled=!0,this.isAvailable()?(this._pauseMonitoringTrackBeforeReset(),this._device.trackOptions=e,this._device.track.restart(An(e)).then(()=>{this._resumeMonitoringTrackAfterReset(),this._meetingStarter.updateErrorMessage(),this._toggleButton.disabled=!1}).catch(t=>{Me.log(`Second attempt to create track,device: ${this._device.type}`),window.setTimeout(()=>this.createTrack(e),1e3)})):this.createTrack(e)}setToggleButtonVisibility(e){Ze.setVisibility(this._toggleButton,e)}_updateToggleButtonState(){this._device.active?(Ze.setButtonHighlight(this._toggleButton,!1),Ze.setVisibility(this._toggleButton.children[0],!0),Ze.setVisibility(this._toggleButton.children[1],!1)):(Ze.setButtonHighlight(this._toggleButton,!0),Ze.setVisibility(this._toggleButton.children[0],!1),Ze.setVisibility(this._toggleButton.children[1],!0))}_disposeTrack(){if(this._device.track!==null){const e=this._device.track;e.removeListener("stopped",this._onStoppedBound),e.detach(),e.stop()}this._device.track=null}_onStopped(){this._device.track!==null&&this.setTrack(null,null,{name:"NotReadableError",message:"Stopped"})}_close(){Ze.removeChildren(this._previewContainer)}_setPreviewInnerHTML(e){this._close(),this._previewContainer.innerHTML=e,Ze.show(this._previewContainer)}_setPreviewElement(e){this._close(),e!==null&&(e.style.width=this._width.toString()+"px",e.style.height=this._height.toString()+"px",this._previewContainer.appendChild(e),Ze.show(this._previewContainer))}_showTrack(){this._device.active=!0,this._device.track.enable()}_hideTrack(){this._device.active=!1}_onToggleButtonClicked(){if(!this.isAvailable()){this.createTrack().then(()=>{this._device.error&&Ze.highlightText(this._errorDiv)});return}this._device.active?this._onSwitchOff():this._onSwitchOn(),this._updateToggleButtonState()}_onSwitchOff(){this._hideTrack(),this._device.track.disable()}_onSwitchOn(){this._showTrack(),this._device.track.enable()}}class Ly extends Qm{constructor(e,t,i,n,o){super(jm.CAMERA,e,t,i,n,o,'<span class="fa-video-slash"></span>'),this._twilioCreateTrackFunction=Twilio.Video.createLocalVideoTrack,this._device.trackOptions=ca}showInTestNeededMode(){super.showInTestNeededMode(),this._showPlaceholder()}showInPreviewMode(){super.showInPreviewMode(),this._showPlaceholder()}_showPlaceholder(){const e=`
        <div class="ext-meeting-join-camera-preview-placeholder">
          <span class="fa-video absolute-center"></span>
        </div>
      `;this._setPreviewInnerHTML(e)}_hideTrack(){super._hideTrack(),this._showPlaceholder()}_showTrack(){super._showTrack(),this._setPreviewElement(this._device.track.attach())}_onSwitchOff(){super._onSwitchOff(),this.setTrack(null,null,null)}}class Fy extends Qm{constructor(e,t,i,n,o){super(jm.MICROPHONE,e,t,i,n,o,'<span class="fa-microphone-slash"></span>'),this._noSoundThreshold=80,this._volumeVisualizer=new aa.VolumeVisualizer(t,i,this._noSoundThreshold),this._volumeMeter=null,this._measurementIntervalId=null,this._twilioCreateTrackFunction=Twilio.Video.createLocalAudioTrack,this._device.trackOptions=la}showInTestNeededMode(){super.showInTestNeededMode(),this._setPreviewElement(null)}showInPreviewMode(){super.showInPreviewMode(),this._setPreviewElement(null)}dispose(){this._isMeasurementActive()&&this._stopMeasurement(),super.dispose()}_measure(){this._volumeVisualizer.update(this._volumeMeter.measureSoundVolume())}_hideTrack(){super._hideTrack(),this._isMeasurementActive()&&this._stopMeasurement(),this._setPreviewElement(null)}_showTrack(){super._showTrack(),this._setPreviewInnerHTML(this._volumeVisualizer.getHTML()),this._startMeasurement()}_startMeasurement(){this._volumeMeter=new aa.VolumeMeter(this._device.track,512,this._noSoundThreshold),this._measurementIntervalId=setInterval(()=>this._measure())}_stopMeasurement(){clearInterval(this._measurementIntervalId),this._measurementIntervalId=null,this._volumeMeter.dispose(),this._volumeMeter=null}_isMeasurementActive(){return this._measurementIntervalId!==null}_pauseMonitoringTrackBeforeReset(){super._pauseMonitoringTrackBeforeReset(),this._isMeasurementActive()&&this._stopMeasurement()}_resumeMonitoringTrackAfterReset(){super._resumeMonitoringTrackAfterReset(),this._startMeasurement()}_disposeTrack(){this._isMeasurementActive()&&this._stopMeasurement(),super._disposeTrack()}}Wm=class{constructor(s,e){this._onJoinCallback=s,this._joinMode=!1,this._dialog=null,this._preflightTestDone=!1,this._mediaInitialized=!1,this._cameraPreview=null,this._micVolumePreview=null,this._cameraPreviewHeight=198,this._cameraPreviewWidth=264,this._micVolumePreviewHeight=4,this._micVolumePreviewWidth=40,this._onDevicesChangedBound=this._onDevicesChanged.bind(this),this._errorMessageActive=!0,this._runPrefilghtTest(e)}show(){this._blurHelp(),this._createDialog(),this._cameraPreview=new Ly(this,this._cameraPreviewWidth,this._cameraPreviewHeight,"ext-meeting-join-camera-toggle","ext-meeting-join-camera-preview-container"),this._micVolumePreview=new Fy(this,this._micVolumePreviewWidth,this._micVolumePreviewHeight,"ext-meeting-join-mic-toggle","ext-meeting-join-mic-volume-container"),this._errorMessageGenerator=new Iy("ext-meeting-join-first-error","ext-meeting-join-second-error",this._micVolumePreview,this._cameraPreview),this._setupDevicesSelection(),this._checkPermissions().then(()=>{this._runPreviewMode(!1),this._createMediaTracksSeparately(ca,la,()=>this._onMediaInitialized())}).catch(s=>{s!==void 0&&Me.log("Error checking audio/video devices permissions: "+s.name+": "+s.message),this._runTestNeededMode()})}_checkPermissions(){return new Promise((s,e)=>navigator.mediaDevices.enumerateDevices().then(function(t){const i=t.filter(function(o){return o.kind==="audioinput"&&o.deviceId!==""&&o.label!==""}),n=t.filter(function(o){return o.kind==="videoinput"&&o.deviceId!==""&&o.label!==""});i.length>0||n.length>0?s():e()}).catch(function(t){e(t)}))}_setupDevicesSelection(){const s=t=>{this._cameraPreview.restartTrack({name:"camera",deviceId:{exact:t.currentTarget.value}})};Ze.addChangeHandler("ext-meeting-join-select-camera",s);const e=t=>{this._micVolumePreview.restartTrack({name:"mic",deviceId:{exact:t.currentTarget.value}})};Ze.addChangeHandler("ext-meeting-join-select-microphone",e),navigator.mediaDevices.addEventListener("devicechange",this._onDevicesChangedBound)}_onDevicesChanged(){if(!this._joinMode)return;const s=this._cameraPreview.device.error,e=this._micVolumePreview.device.error;s||e?this._createMediaTracksSeparately(s?ca:null,e?la:null):this._fillDevicesSelectControls()}_fillDevicesSelectControls(){navigator.mediaDevices.enumerateDevices().then(s=>{this._cameraPreview.updateTrackDeviceId(s),this._micVolumePreview.updateTrackDeviceId(s);const e=s.filter(function(i){return i.kind==="audioinput"});this._fillDevicesSelectControl(e,"ext-meeting-join-select-microphone-container","ext-meeting-join-select-microphone",this._micVolumePreview.device.getId());const t=s.filter(function(i){return i.kind==="videoinput"});this._fillDevicesSelectControl(t,"ext-meeting-join-select-camera-container","ext-meeting-join-select-camera",this._cameraPreview.device.getId())})}_fillDevicesSelectControl(s,e,t,i){const n=document.getElementById(e),o=document.getElementById(t);Ze.setVisibility(n,s.length>1),Ze.removeChildren(o),s.length>1&&(s.forEach(a=>{const l=document.createElement("option");l.value=`${a.deviceId}`,Wo(l,`${a.label}`),o.appendChild(l)}),o.value=i)}_createDialog(){this._dialog=new Ze.UiPopup(`
        <h3 class="ext-meeting-dialog-title" data-strings="meetings.join3dMeeting"></h3>
        <div class="ext-meeting-join-row">
          <div id="ext-meeting-join-name-label">
            ${wt("meetings.name")}:
          </div>
          <input type="text" id="ext-meeting-join-name"
                 class="ext-meeting-join-input"
                 autocomplete="off">
          </input>
        </div>
        <div class="ext-meeting-join-row">
          <div class="ext-meeting-join-main-container">
            <div id="ext-meeting-join-error-container"
                 class="absolute-vertical-center">
              <div id="ext-meeting-join-first-error"></div>
              <div id="ext-meeting-join-second-error"></div>
            </div>
            <div id="ext-meeting-join-camera-preview-container"></div>
            <div id="ext-meeting-join-mic-volume-container"></div>
            <div id="ext-meeting-join-preview-toggle-container"
                 class="absolute-horizontal-center">
              <button id="ext-meeting-join-mic-toggle" style="display: none"
                      class="ext-meeting-button ext-meeting-button-highlight
                            ext-meeting-join-device-button">
                <span class="fa-microphone" style="display: none"></span>
                <span class="fa-microphone-slash"></span>
              </button>
              <button id="ext-meeting-join-camera-toggle" style="display: none"
                      class="ext-meeting-button ext-meeting-button-highlight
                            ext-meeting-join-device-button">
                <span class="fa-video" style="display: none"></span>
                <span class="fa-video-slash"></span>
              </button>
            </div>
          </div>
        </div>
        <div class="ext-meeting-join-row">
          <div id="ext-meeting-join-select-camera-container"
               style="display: none">
            ${wt("meetings.camera")}:
            <select id="ext-meeting-join-select-camera"
                    class="ext-meeting-join-input">
            </select>
          </div>
          <div id="ext-meeting-join-select-microphone-container"
               style="display: none">
            ${wt("meetings.microphone")}:
            <select id="ext-meeting-join-select-microphone"
                    class="ext-meeting-join-input">
            </select>
          </div>
        </div>
        <div id="ext-meeting-join-network-error-container" style="display: none">
          <div data-strings="meetings.networkIssuesDetected"></div>
          <div>
            <a href="https://networktest.twilio.com/" style="color: white" target="_blank"
               data-strings="meetings.diagnoseConnection">
            </a>
          </div>
        </div>
        <div id="ext-meeting-join-button-container"
             class="ext-meeting-join-row">
          <button id="ext-meeting-join-button"
                  class="ext-meeting-button ext-meeting-dialog-buttons"
                  data-strings="meetings.join">
          </button>
        </div>
        <div class="ext-meeting-join-footer">
          <span data-strings="meetings.byJoiningYouAgreeTo"></span>
          <span id="terms-of-service-link" class="ext-meeting-terms-link">
            <u data-strings="meetings.termsOfService"></u>
          </span>
          ${wt("meetings.and")}
          <span id="privacy-policy-link" class="ext-meeting-terms-link">
            <u data-strings="meetings.privacyPolicy"></u><!-- no whitespace before dot --></span>.
        </div>
      `),this._dialog.showDismiss=!1,this._dialog.foremost=!0,this._dialog.open();const s=document.getElementById("terms-of-service-link");s.onclick=()=>{const t="https://www.unreal engine.com/terms#in-viewer";this._dialog.hide(),Ze.showIframePopup(wt("meetings.infrastructureProvidedUnderTos"),t,()=>this._dialog.unhide())};const e=document.getElementById("privacy-policy-link");e.onclick=()=>{const t="https://www.unreal engine.com/privacy#in-viewer";this._dialog.hide(),Ze.showIframePopup(wt("meetings.infrastructureProvidedUnderPp"),t,()=>this._dialog.unhide())},this._initializeDisplayName()}_createMediaTracksSeparately(s,e,t){const i=()=>{this._fillDevicesSelectControls(),this._errorMessageActive=!0,this.updateErrorMessage(),t&&t()};this._errorMessageActive=!1,s&&e?this._cameraPreview.createTrack(s).then(()=>this._micVolumePreview.createTrack(e)).then(()=>{i()}):s?this._cameraPreview.createTrack(s).then(()=>{i()}):this._micVolumePreview.createTrack(e).then(()=>{i()})}_runTestNeededMode(){this._setTestNeededMode(),this._cameraPreview.showInTestNeededMode(),this._micVolumePreview.showInTestNeededMode()}_runPreviewMode(s){this._setPreviewMode(s),s?(this._cameraPreview.setToggleButtonVisibility(!0),this._micVolumePreview.setToggleButtonVisibility(!0)):(this._cameraPreview.showInPreviewMode(),this._micVolumePreview.showInPreviewMode())}_onCreateMediaTracks(s,e,t){const i=s.filter(o=>o.kind==="audio"),n=s.filter(o=>o.kind==="video");this._errorMessageActive=!1,i.length>0?this._micVolumePreview.setTrack(i[0],e):this._micVolumePreview.setTrack(null,e,{name:"Unknown error",message:""}),n.length>0?this._cameraPreview.setTrack(n[0],t):this._cameraPreview.setTrack(null,t,{name:"Unknown error",message:""}),this._errorMessageActive=!0,this.updateErrorMessage(),this._fillDevicesSelectControls(),this._runPreviewMode(!0)}_testCamera(){const s={audio:An(la),video:An(ca)};Twilio.Video.createLocalTracks(s).then(e=>{this._onCreateMediaTracks(e)}).catch(e=>{this._createMediaTracksSeparately(ca,la,()=>this._runPreviewMode(!0))})}_setTestNeededMode(){this._joinMode=!1;const s=`
        <button class="ext-meeting-button ext-meeting-dialog-buttons"
                id="ext-meeting-test-button" data-strings="meetings.testCamera">
        </button>
      `,e=document.getElementById("ext-meeting-join-button-container");Ze.removeChildren(e),lo(e,s),Pi("ext-meeting-test-button",()=>this._testCamera())}_setPreviewMode(s){if(this._joinMode)return;this._joinMode=!0;const e=`
        <button class="ext-meeting-button ext-meeting-dialog-buttons"
                id="ext-meeting-join-button" data-strings="meetings.join">
        </button>
      `,t=document.getElementById("ext-meeting-join-button-container");Ze.removeChildren(t),lo(t,e),this._mediaInitialized=!0,this._updateJoinButtonState(),Pi("ext-meeting-join-button",()=>this._joinMeeting()),s||this._setMediaInitialized(!1)}_onMediaInitialized(){this._setMediaInitialized(!0)}_updateJoinButtonState(){const s=document.getElementById("ext-meeting-join-button");s&&(s.disabled=!(this._preflightTestDone&&this._mediaInitialized))}_setMediaInitialized(s){this._mediaInitialized=s,this._updateJoinButtonState()}_setPreflightTestDone(){this._preflightTestDone=!0,this._updateJoinButtonState()}_initializeDisplayName(){const s=document.getElementById("ext-meeting-join-name");let e=localStorage.getItem("extMtgDisplayName");e&&(s.value=e),s.focus(),s.select()}_checkDisplayName(){const s=document.getElementById("ext-meeting-join-name"),e=s.value.trim();if(!e){Ze.highlightInput(s);return}return e}_blurHelp(){document.getElementById("help-and-primary-progress").classList.add("ui-blur")}_unblurHelp(){const s=document.getElementById("help-and-primary-progress");s.classList.remove("ui-blur"),s.classList.add("ui-unblur")}_runPrefilghtTest(s){const e=new Promise((i,n)=>{const o="https://pubsub.pubnub.com/time/0",l=new Date().getTime()/1e3;Mr(o,null,null,c=>{const h=c[0]/1e7,d=Math.abs(h-l);console.warn("PubNub test completed, response time:",d.toFixed(4)+"s"),i()},(c,h)=>{console.error("PubNub test error:",c,h),n(new Error("PubNub test failed"))})}),t=new Promise((i,n)=>{const o=Twilio.Video.runPreflight(s,{duration:Ry});o.on("failed",(a,l)=>{console.error("Twilio test error:",a),n(new Error("Twilio test failed"))}),o.on("completed",()=>{i()})});Promise.all([e,t]).then(()=>{this._setPreflightTestDone()}).catch(i=>{console.error(i);const n=document.getElementById("ext-meeting-join-network-error-container");Ze.show(n),this._setPreflightTestDone()})}_joinMeeting(){const s=this._checkDisplayName();if(s===void 0)return;localStorage.setItem("extMtgDisplayName",s);const e=this._micVolumePreview.device,t=this._cameraPreview.device;this._dispose(),this._onJoinCallback(s,e,t)}updateErrorMessage(){this._errorMessageActive&&this._errorMessageGenerator.update()}_dispose(){this._dialog.close(),this._unblurHelp(),navigator.mediaDevices.removeEventListener("devicechange",this._onDevicesChangedBound),this._cameraPreview.dispose(),this._micVolumePreview.dispose(),this._dialog=null,this._cameraPreview=null,this._micVolumePreview=null}};const sd=13,Ql=15,Kl=3,od=2,$l=9,Oy=2;class By{constructor(){this._room=null,this._bars=[],this._crossLines=[],this._crossIsVisible=!1,this._updateBind=this._update.bind(this),this._qualityToBarIndex=[-1,0,0,1,2,2],this._create()}_create(){const e=document.getElementById("ext-meeting-quality-indicator-container");console.assert(e!==null,"Quality indicator container not found");const t=document.createElementNS("http://www.w3.org/2000/svg","svg");t.setAttribute("width",sd),t.setAttribute("height",Ql),e.appendChild(t);const i=Math.floor((sd+od)/Kl)-od,n=i+od,o=Math.floor(Ql/Kl);for(let d=0;d<Kl;d++){const u=d*n,m=(d+1)*o,g=Ql-m;this._addBar(t,u,g,i,m)}const a=(sd-$l)/2,l=(Ql-$l)/2,c=a+$l,h=l+$l;this._addCrossLine(t,a,l,c,h),this._addCrossLine(t,a,h,c,l)}_addBar(e,t,i,n,o){const a=document.createElementNS("http://www.w3.org/2000/svg","rect");a.setAttribute("x",t),a.setAttribute("y",i),a.setAttribute("width",n),a.setAttribute("height",o),a.setAttribute("display","none"),e.appendChild(a),this._bars.push(a)}_addCrossLine(e,t,i,n,o){const a=document.createElementNS("http://www.w3.org/2000/svg","line");a.setAttribute("x1",t),a.setAttribute("y1",i),a.setAttribute("x2",n),a.setAttribute("y2",o),a.setAttribute("stroke","red"),a.setAttribute("stroke-width",Oy),a.setAttribute("display","none"),e.appendChild(a),this._crossLines.push(a)}_hideBars(){this._bars.forEach(e=>{e.setAttribute("display","none")})}_hideCross(){this._crossIsVisible&&(this._crossLines.forEach(e=>{e.setAttribute("display","none")}),this._crossIsVisible=!1)}_showBars(){this._bars.forEach(e=>{e.setAttribute("display","block")})}_showCross(){this._crossIsVisible||(this._crossLines.forEach(e=>{e.setAttribute("display","block")}),this._crossIsVisible=!0)}onConnect(e){console.assert(this._room===null),this._room=e,this._showBars(),this._update(this._room.localParticipant.networkQualityLevel),e.localParticipant.on("networkQualityLevelChanged",this._updateBind)}onDisconnect(){console.assert(this._room),this._room.localParticipant.removeListener("networkQualityLevelChanged",this._updateBind),this._room=null,this._hideBars(),this._hideCross()}_getColor(e,t){return e<=this._qualityToBarIndex[t]?"white":"dimgray"}_update(e){if(e!==null){for(let t=0;t<Kl;t++){const i=this._getColor(t,e);this._bars[t].setAttribute("fill",i),this._bars[t].setAttribute("stroke",i)}e===0?this._showCross():this._hideCross()}}}const Uy=24*60*60*1e3;function Ny(){M.FONT_FAMILIES_TO_LOAD.push("FontAwesomeSolid"),M.FONT_FAMILIES_TO_LOAD.push("FontAwesomeRegular");const s=.1,e="#0775e8",t=new be(0,1,0),i=document.getElementById("walk-canvas"),n=M.urlHashGetArgument("av-region");function o(){return M.DEVEL_MEETING_SCENE_URL||window.location.href}function a(){const k=window.location.hostname;return k.endsWith(".unreal engine.com")?"https://cloud"+k.substr(k.indexOf(".")):k.endsWith(".unreal engine.com.cn")?"https://cloud.unreal engine.com.cn":M.DEVEL_MEETING_CLOUD_URL||"https://cloud.unreal engine.com"}function l(k){const K=new Date(k),de=new Date;return de.getDate()===K.getDate()&&de.getMonth()===K.getMonth()&&de.getFullYear()===K.getFullYear()?K.toLocaleTimeString():K.toLocaleDateString()+" "+K.toLocaleTimeString()}function c(k,K,de,ce){const Te=document.createElement("li");Te.classList.add("ext-meeting-list-entry");const pe=Te.appendChild(document.createElement("span"));if(pe.classList.add("ext-meeting-list-name"),pe.innerText=k,pe.style.color=de,ce&&(kn(Te,ce),Te.style.cursor="pointer"),K){Te.appendChild(document.createElement("br"));const ye=Te.appendChild(document.createElement("small"));ye.innerText=K,ye.style.color="white"}return Te}function h(k,K,de){return{color:e,icon:"edit",opacity:1,position:[k,K,de],radius:.07,type:"sphere"}}function d(k,K,de,ce=!1){const Te=K&&de?`<button class="ext-meeting-dialog-ok ext-meeting-button">
            ${K}
          </button>`:"",ye=`<div>
        <h3>${k}</h3>
      </div>
      <div class ="ext-meeting-dialog-buttons">
        ${Te}
        ${ce?`<button class="ext-meeting-dialog-cancel ext-meeting-button"
             data-strings="meetings.cancel"> </button>`:""}
      </div>`,Re=new Ze.UiPopup(ye);if(Re.showDismiss=!1,Re.open(),ce){const he=Re.getElementsByClassName("ext-meeting-dialog-cancel")[0];he.onclick=()=>Re.dismiss()}if(K&&de){const he=Re.getElementsByClassName("ext-meeting-dialog-ok")[0];he.onclick=()=>{Re.close(),de()}}}function u(k,K){const de=K.attach(),ce=k.createTextureFromHtmlVideo(de);return ce.play(),ce}function m(k){k.detach().forEach(K=>K.remove())}function g(k){return k&&k.isStarted&&k.isEnabled&&!k.isStopped}function b(k,K,de){this._viewer=k,this._uuid=K;const ce=parseInt(K.substring(2));this._color=M.AVATAR_COLORS[ce%M.AVATAR_COLORS.length],this._displayName=null,this._avatar=null,this._twilioParticipant=null,this._lastRenderedPosition=[],this._lastRenderedPositionLength=0,this._dataTrack=null,this._micTrack=null,this._cameraTrack=null,this._screenTrack=null,this._audioTrack=null,this._noSoundThreshold=80,this._soundVolumeUpdatesScheduler=de,this._volumeVisualizer=new aa.VolumeVisualizer(20,3,this._noSoundThreshold,3),this._volumeMeter=null}b.prototype={constructor:b,_setUpAvatar:function(){console.assert(this._displayName,"Display name must be known to set up the avatar"),Me.log("Setting up avatar for %s:%s",this._uuid,this._displayName),this._avatar=this._viewer.addAvatar(this._uuid,{displayName:this._displayName,color:this._color})},get uuid(){return this._uuid},get color(){return this._color},get displayName(){return this._displayName},get hasDisplayName(){return this._displayName!==null},_positionChanged:function(k){if(this._lastRenderedPositionLength!==k.length)return!0;const K=1e-5;for(let de=0;de<k.length;de++)if(Math.abs(this._lastRenderedPosition[de]-k[de])>K)return!0;return!1},_setLastRenderedPosition:function(k){this._lastRenderedPositionLength=k.length;for(let K=0;K<k.length;K++)this._lastRenderedPosition[K]=k[K]},get volumeVisualizer(){return this._volumeVisualizer},updatePosition:function(k){if(!this.hasDisplayName||!this._positionChanged(k))return;this._setLastRenderedPosition(k);const K=this._avatar;K.setPositionFromArray(k),K.rotate(k[3],k[4]),k.length>=6?K.placePointer(k[5],k[6],k[7]):K.hidePointer(),K.visible&&(K.updateMatrixWorld(!0),this._viewer.requestFrame())},updateSoundVolumeVisualization(){console.assert(this._volumeMeter!==null,"this._voulmeMeter not created");const k=this._volumeMeter.measureSoundVolume();this._onSoundVolumeUpdated(k)},_onSoundVolumeUpdated(k){this._volumeVisualizer.update(k)},dispose:function(){this.isSoundMeasurementActive()&&this._stopSoundMeasurement(),this._avatar&&(this._viewer.removeAvatar(this._avatar),this._avatar=null,this._viewer.requestFrame())},_updateSoundMeasurementState:function(){this._micTrack!==null&&this._micTrack.isEnabled?this._startSoundMeasurement():this._stopSoundMeasurement()},isSoundMeasurementActive:function(){return this._volumeMeter!==null},_startSoundMeasurement:function(){this.isSoundMeasurementActive()||(this._volumeMeter=new aa.VolumeMeter(this._micTrack,512,this._noSoundThreshold),this._soundVolumeUpdatesScheduler.registerUser(this))},_stopSoundMeasurement:function(){this.isSoundMeasurementActive()&&(this._soundVolumeUpdatesScheduler.unregisterUser(this),this._volumeMeter.dispose(),this._volumeMeter=null,this._avatar.onSoundSwitchedOff())}},Object.defineProperty(b.prototype,"micTrack",{get:function(){return this._micTrack}}),Object.defineProperty(b.prototype,"cameraTrack",{get:function(){return this._cameraTrack}}),Object.defineProperty(b.prototype,"audioTrack",{get:function(){return this._audioTrack}});function x(k,K,de,ce,Te,pe){b.call(this,k,K,ce,!0),this._displayName=de,this._setUpAvatar(),this._avatar.hideBody(),this._isPublishingTracksDuringConnecting=!1,this._dataTrack=new Twilio.Video.LocalDataTrack({name:"data",maxPacketLifeTime:1e3}),this._isCreatingMicTrack=!1,this._isCreatingCameraTrack=!1,this._micDevice=Te,this._cameraDevice=pe,this._micTrack=this._micDevice.track,this._micTrack!==null&&this._subscribeToMicEvents(),this._updateSoundMeasurementState(),this._cameraTrack=this._cameraDevice.track,this._cameraTrack!==null&&(console.assert(this._cameraDevice.active,"Got inactive camera track from MeetingStarter"),this._subscribeToCameraEvents()),this._lastPosition=null,this._positionMessage=[K,de,null],this._resendInterval=null,this._onMicTrackStateChanged=null,this._onCameraTrackStateChanged=null}x.prototype=Object.create(b.prototype),x.prototype.constructor=x,Object.defineProperty(x.prototype,"dataTrack",{get:function(){return this._dataTrack}}),Object.defineProperty(x.prototype,"screenTrack",{get:function(){return this._screenTrack}}),x.prototype.getAllTracks=function(){const k=[this._dataTrack];return this._micTrack&&k.push(this._micTrack),this._cameraTrack&&k.push(this._cameraTrack),this._screenTrack&&k.push(this._screenTrack),this._audioTrack&&k.push(this._audioTrack),k},x.prototype._sendPosition=function(k){this._positionMessage[2]=k,this._dataTrack.send(JSON.stringify(this._positionMessage))},x.prototype._resendLastPosition=function(){this._lastPosition!==null&&this._sendPosition(this._lastPosition)},x.prototype.startedConnectingToTwilio=function(){this._isPublishingTracksDuringConnecting=!0},x.prototype.failedToConnectToTwilio=function(){this._isPublishingTracksDuringConnecting=!1},x.prototype.connectedToTwilio=function(k){this._twilioParticipant=k,k.publishTracks(this.getAllTracks()).finally(()=>{this._isPublishingTracksDuringConnecting=!1}),this._resendLastPosition();const K=1e3;this._resendInterval=setInterval(()=>this._resendLastPosition(),K)},x.prototype.disconnectedFromTwilio=function(){this._twilioParticipant=null,clearInterval(this._resendInterval),this._resendInterval=null},Object.defineProperty(x.prototype,"isConnectedToTwilio",{get:function(){return this._twilioParticipant!==null}}),x.prototype.updatePosition=function(k){b.prototype.updatePosition.call(this,k),this._lastPosition=k,this.isConnectedToTwilio&&this._sendPosition(k)},x.prototype.setAvTracksStateHandlers=function(k,K){this._onMicTrackStateChanged=k,this._onCameraTrackStateChanged=K},x.prototype._removeStoppedMicTrack=function(){console.assert(this._micTrack&&this._micTrack.isStopped),Me.log("Removing stopped local mic track"),this._twilioParticipant&&(Me.log("Unpublishing stopped local mic track"),this._twilioParticipant.unpublishTrack(this._micTrack)),this._micTrack=null},x.prototype._subscribeToMicEvents=function(){const k=()=>{this._updateSoundMeasurementState(),this._onMicTrackStateChanged&&this._onMicTrackStateChanged(this._micTrack)},K=()=>{k(),this._removeStoppedMicTrack()};this._micTrack.on("started",k),this._micTrack.on("enabled",k),this._micTrack.on("disabled",k),this._micTrack.on("stopped",K)},x.prototype._createMicTrack=function(){if(Me.log("Creating local mic track"),this._isCreatingMicTrack){Me.log("Local mic track is already being created");return}this._isCreatingMicTrack=!0;let k=null;Twilio.Video.createLocalAudioTrack(this._micDevice.trackOptions).then(K=>{if(k=K,this.isConnectedToTwilio)return Me.log("Publishing local mic track"),this._twilioParticipant.publishTrack(k)}).then(K=>{K?Me.log("Local mic track created and published"):Me.log("Local mic track created but not yet published"),this._micTrack=k,this._subscribeToMicEvents(),this._onMicTrackStateChanged&&this._onMicTrackStateChanged(this._micTrack),this._isCreatingMicTrack=!1}).catch(K=>{k&&k.stop(),this._micDevice.error=K,this._showCreateTrackError(this._micDevice),this._isCreatingMicTrack=!1})},x.prototype.toggleMic=function(){this._micTrack?this._micTrack.isEnabled?(Me.log("Disabling local mic track"),this._micTrack.disable()):(Me.log("Enabling local mic track"),this._micTrack.enable()):this._createMicTrack()},x.prototype._removeStoppedCameraTrack=function(){console.assert(this._cameraTrack&&this._cameraTrack.isStopped),Me.log("Removing stopped local camera track"),this._twilioParticipant&&(Me.log("Unpublishing stopped local camera track"),this._twilioParticipant.unpublishTrack(this._cameraTrack)),this._cameraTrack=null},x.prototype._subscribeToCameraEvents=function(){const k=()=>{this._onCameraTrackStateChanged&&this._onCameraTrackStateChanged(this._cameraTrack)},K=()=>{k(),this._removeStoppedCameraTrack()};this._cameraTrack.on("started",k),this._cameraTrack.on("enabled",k),this._cameraTrack.on("disabled",k),this._cameraTrack.on("stopped",K)},x.prototype._createCameraTrack=function(){if(Me.log("Creating local camera track"),this._isCreatingCameraTrack){Me.log("Local camera track is already being created");return}this._isCreatingCameraTrack=!0;let k=null;Twilio.Video.createLocalVideoTrack(this._cameraDevice.trackOptions).then(K=>{if(k=K,this.isConnectedToTwilio)return Me.log("Publishing local camera track"),this._twilioParticipant.publishTrack(k)}).then(K=>{K?Me.log("Local camera track created and published"):Me.log("Local camera track created but not yet published"),this._cameraTrack=k,this._subscribeToCameraEvents(),this._onCameraTrackStateChanged&&this._onCameraTrackStateChanged(this._cameraTrack),this._isCreatingCameraTrack=!1}).catch(K=>{k&&k.stop(),this._cameraDevice.error=K,this._showCreateTrackError(this._cameraDevice),this._isCreatingCameraTrack=!1})},x.prototype._showCreateTrackError=function(k){const K=k.getErrorMessageInfo();Ze.showMessage(K.description,K.title)},x.prototype.toggleCamera=function(){if(this._cameraTrack){if(this._isPublishingTracksDuringConnecting){Me.log("Cannot disable the camera track during connection process");return}this._cameraTrack.stop()}else this._createCameraTrack()},x.prototype.startShareScreen=function(k,K,de,ce){if(this._screenTrack!==null){k();return}Me.log("Share screen start"),navigator.mediaDevices.getDisplayMedia({video:!0,audio:!0}).then(Te=>{Me.log("share screen - stream:",Te);const pe=new Twilio.Video.LocalVideoTrack(Te.getVideoTracks()[0],{name:"screen"});this._screenTrack=pe;const ye=Te.getAudioTracks();let Re=null;ye.length>0?(Re=new Twilio.Video.LocalAudioTrack(ye[0],{name:"audio"}),this._audioTrack=Re,ce()):console.log("Audio track not available for sharing");const he=u(this._viewer,pe);this._avatar.setVideoTexture1(he),this._viewer.requestFrame(),this.isConnectedToTwilio&&(this._twilioParticipant.publishTrack(pe),Re&&this._twilioParticipant.publishTrack(Re)),k(),pe.once("stopped",()=>{Me.log("Screen track stopped"),this.isConnectedToTwilio&&(this._twilioParticipant.unpublishTrack(pe),Re!==null&&this._twilioParticipant.unpublishTrack(Re)),this._avatar.setVideoTexture1(null),m(pe),Re!==null&&m(Re),this._screenTrack=null,this._audioTrack&&(this._audioTrack=null,ce()),this._viewer.requestFrame(),K()})}).catch(Te=>{de()})},x.prototype.stopShareScreen=function(){this._screenTrack!==null&&(Me.log("Share screen stop"),this._screenTrack.stop())},x.prototype.dispose=function(){this._micTrack&&this._micTrack.stop(),this._cameraTrack&&this._cameraTrack.stop(),this._screenTrack&&this._screenTrack.stop(),b.prototype.dispose.call(this)};function v(k,K,de,ce){b.call(this,k,K,de,!1),this._onUiRefreshNeeded=ce,this._micTrackStateChangedBound=null,this._cameraTrackEnabledBound=null,this._cameraTrackDisabledBound=null,this._trackSubscribedBound=this._trackSubscribed.bind(this),this._trackUnsubscribedBound=this._trackUnsubscribed.bind(this),this._disposed=!1}v.prototype=Object.create(b.prototype),v.prototype.constructor=v,v.prototype._refreshUi=function(){this._onUiRefreshNeeded&&this._onUiRefreshNeeded(this)},v.prototype._setUpMicTrack=function(){Me.log("Setting up remote mic track for %s:%s",this._uuid,this._displayName),this._micTrackStateChangedBound=()=>{this._updateSoundMeasurementState(),this._refreshUi()},this._micTrack.on("enabled",this._micTrackStateChangedBound),this._micTrack.on("disabled",this._micTrackStateChangedBound),this._updateSoundMeasurementState(),this._micTrack.attach()},v.prototype._tearDownMicTrack=function(){Me.log("Tearing down remote mic track for %s:%s",this._uuid,this._displayName),m(this._micTrack),this._micTrack.removeListener("enabled",this._micTrackStateChangedBound),this._micTrack.removeListener("disabled",this._micTrackStateChangedBound),this._micTrackStateChangedBound=null},v.prototype._setUpAudioTrack=function(){Me.log("Setting up remote audio track for %s:%s",this._uuid,this._displayName),this._audioTrack.attach()},v.prototype._tearDownAudioTrack=function(){Me.log("Tearing down remote audio track for %s:%s",this._uuid,this._displayName),m(this._audioTrack)},v.prototype._setUpCameraTrack=function(){Me.log("Setting up remote camera track for %s:%s",this._uuid,this._displayName);const k=u(this._viewer,this._cameraTrack);this._cameraTrackEnabledBound=()=>{this._avatar.setVideoTexture0(k)},this._cameraTrackDisabledBound=()=>{this._avatar.setVideoTexture0(null)},this._cameraTrack.on("enabled",this._cameraTrackEnabledBound),this._cameraTrack.on("disabled",this._cameraTrackDisabledBound),this._avatar.setVideoTexture0(k)},v.prototype._tearDownCameraTrack=function(){Me.log("Tearing down remote camera track for %s:%s",this._uuid,this._displayName),this._avatar.setVideoTexture0(null),m(this._cameraTrack),this._cameraTrack.removeListener("enabled",this._cameraTrackEnabledBound),this._cameraTrack.removeListener("disabled",this._cameraTrackDisabledBound),this._cameraTrackEnabledBound=null,this._cameraTrackDisabledBound=null},v.prototype._setUpScreenTrack=function(){Me.log("Setting up remote screen track for %s:%s",this._uuid,this._displayName);const k=u(this._viewer,this._screenTrack);this._avatar.setVideoTexture1(k)},v.prototype._tearDownScreenTrack=function(){Me.log("Tearing down remote screen track for %s:%s",this._uuid,this._displayName),this._avatar.setVideoTexture1(null),m(this._screenTrack)},v.prototype._setDisplayName=function(k){Me.log("Remote display name known for %s:%s",this._uuid,k),this._displayName=k,this._setUpAvatar(),this._micTrack&&this._setUpMicTrack(),this._cameraTrack&&this._setUpCameraTrack(),this._screenTrack&&this._setUpScreenTrack(),this._audioTrack&&this._setUpAudioTrack(),this._refreshUi()},v.prototype._trackSubscribed=function(k){if(Me.log("Remote %s:%s track subscribed for %s:%s",k.kind,k.name,this._uuid,this._displayName),!this._disposed){if(k.kind==="data"&&k.name==="data"){if(this._dataTrack){Me.log("Ignoring duplicate data track");return}this._dataTrack=k,k.on("message",K=>{K=JSON.parse(K);const de=K[1],ce=K[2];this.hasDisplayName||this._setDisplayName(de),this.updatePosition(ce)})}else if(k.kind==="audio"&&k.name==="mic"){if(this._micTrack){Me.log("Ignoring duplicate mic track");return}this._micTrack=k,this.hasDisplayName&&(this._setUpMicTrack(),this._refreshUi())}else if(k.kind==="video"){if(k.name==="camera"){if(this._cameraTrack){Me.log("Ignoring duplicate camera track");return}this._cameraTrack=k,this._avatar&&(this._setUpCameraTrack(),this._viewer.requestFrame())}else if(k.name==="screen"){if(this._screenTrack){Me.log("Ignoring duplicate screen track");return}this._screenTrack=k,this._avatar&&(this._setUpScreenTrack(),this._viewer.requestFrame())}}else if(k.kind==="audio"&&k.name==="audio"){if(this._audioTrack){Me.log("Ignoring duplicate audio track");return}this._audioTrack=k,this.hasDisplayName&&(this._setUpAudioTrack(),this._refreshUi())}}},v.prototype._trackUnsubscribed=function(k){Me.log("Remote %s:%s track unsubscribed for %s:%s",k.kind,k.name,this._uuid,this._displayName),!this._disposed&&(k===this._dataTrack?this._dataTrack=null:k===this._micTrack?(this.hasDisplayName&&this._tearDownMicTrack(),this._micTrack=null,this._refreshUi()):k===this._cameraTrack?(this._avatar&&(this._tearDownCameraTrack(),this._viewer.requestFrame()),this._cameraTrack=null):k===this._screenTrack?(this._avatar&&(this._tearDownScreenTrack(),this._viewer.requestFrame()),this._screenTrack=null):k===this._audioTrack&&(this.hasDisplayName&&this._tearDownAudioTrack(),this._audioTrack=null,this._refreshUi()))},v.prototype.connectedToTwilio=function(k){this._twilioParticipant=k,k.on("trackSubscribed",this._trackSubscribedBound),k.on("trackUnsubscribed",this._trackUnsubscribedBound),k.tracks.forEach(K=>{K.isSubscribed&&this._trackSubscribed(K.track)})},v.prototype.seeAvatar=function(){this._avatar&&this._viewer.seeItem(this._avatar)},v.prototype._onSoundVolumeUpdated=function(k){b.prototype._onSoundVolumeUpdated.call(this,k),this._avatar.onSoundVolumeUpdated(k)},v.prototype.dispose=function(){this._onUiRefreshNeeded=null,this._micTrack&&this._trackUnsubscribed(this._micTrack),this._cameraTrack&&this._trackUnsubscribed(this._cameraTrack),this._screenTrack&&this._trackUnsubscribed(this._screenTrack),this._audioTrack&&this._trackUnsubscribed(this._audioTrack),this.isConnectedToTwilio&&(this._twilioParticipant.removeListener("trackSubscribed",this._trackSubscribedBound),this._twilioParticipant.removeListener("trackUnsubscribed",this._trackUnsubscribedBound),this._twilioParticipant=null),b.prototype.dispose.call(this),this._disposed=!0};function E(k,K,de,ce,Te,pe){const ye=new PubNub({publishKey:K.publishKey,subscribeKey:K.subscribeKey,authKey:K.authKey,uuid:k.uuid,ssl:!0}),Re=K.channel;ye.subscribe({channels:[Re],withPresence:!0}),ye.addListener({message:function(he){Me.log("listener received message",he),he.message.type==="SceneState"&&Te(he.message.state)},presence:function(he){he.uuid!==k.uuid&&(Me.log("listener presence event",he),he.action==="join"?de(he.uuid):he.action==="leave"&&ce(he.uuid))},status:function(he){(he.category==="PNAccessDeniedCategory"||he.category==="PNNetworkIssuesCategory"||he.category==="PNNetworkDownCategory"||he.category==="PNTimeoutCategory")&&pe(he.category)}}),ye.hereNow({channels:[Re],includeUUIDs:!0,includeState:!0},(he,je)=>{Me.log("herenow",he,je),je.channels[Re].occupants.forEach(function(Xe){Xe.uuid!==k.uuid&&de(Xe.uuid)})}),this.dispose=function(){ye.unsubscribeAll()}}function w(k,K,de,ce,Te,pe,ye,Re,he,je){const Xe=["NotAllowedError","NotFoundError","NotReadableError","OverconstrainedError","TypeError"];let B=null,N=!1,H=0;const X=M.urlHashContains("av-turn");function ve(ne){const ue=ne.identity.match(/^u-\d+/),Ue=ue&&ue[0];return Ue||(M.warn("Unknown participant",ne.identity),null)}function we(ne){Me.log('Participant "%s" connected',ne.identity);const ue=ve(ne);ue&&de(ue,ne)}function ze(ne){Me.log('Participant "%s" disconnected',ne.identity);const ue=ve(ne);ue&&ce(ue,ne)}function Le(ne){const ue=ne!==null?ve(ne):null;je(ue)}function _e(ne){Xe.includes(ne.name)?Te(ne):pe("T"+ne.code)}this.isConnectingOrConnected=function(){return N};function Ge(ne){N&&(N=!1,B.participants.forEach(ze),B=null,k.disconnectedFromTwilio(),he(),H>0?pe("TReconnectionDisconnected"+(ne.code?" "+ne.code:"")):ye())}this.disconnect=function(){N&&(N=!1,B&&(B.disconnect(),B.participants.forEach(ze),B=null,k.disconnectedFromTwilio(),he()))},this.dispose=function(){this.disconnect()},this.connect=function(ne){console.assert(!N),N=!0,k.startedConnectingToTwilio(),Me.log('Connecting to room "%s"',K),Twilio.Video.connect(ne,{name:K,tracks:k.getAllTracks(),preferredVideoCodecs:"auto",iceTransportPolicy:X?"relay":"all",region:n||"gll",networkQuality:{local:1,remote:1},dominantSpeaker:!0}).then(ue=>{B=ue,Me.log("Connected to room"),B.participants.forEach(we),B.on("participantConnected",we),B.on("participantDisconnected",ze),B.on("dominantSpeakerChanged",Le),B.on("reconnecting",Ue=>{H+=1}),B.on("reconnected",Ue=>{H=0}),B.once("disconnected",Ge),k.connectedToTwilio(B.localParticipant),Re(B)}).catch(ue=>{k.failedToConnectToTwilio(),_e(ue)})}}class C{constructor(){this._users=new Set,this._maxIntervalBetweenUpdates=100,this._idleCallback=new Qg(()=>this._execute(),this._maxIntervalBetweenUpdates),Ui().onBeforeRender(()=>this._onBeforeRender())}registerUser(K){this._users.add(K)}unregisterUser(K){this._users.delete(K)}dispose(){this._users.clear()}_onBeforeRender(){this._execute(),this._idleCallback.deferRun()}_execute(){this._users.forEach(K=>K.updateSoundVolumeVisualization())}}function I(k,K){const pe=document.getElementById("ext-meeting-who-list-folder"),ye=document.getElementById("ext-meeting-status");gl(ye);const Re=document.getElementById("ext-meeting-who-list"),he=new ah(1e3),je=new ah(3e3),Xe=new ah(1e3,()=>{Re.style.overflowY="auto"});Re.addEventListener("scroll",ne=>{he.isRunning()||je.start()});let B=!0;function N(){Xe.isRunning()||(B?(B=!1,Re.style.maxHeight=0,Re.style.margin=0,Re.style.overflowY="hidden",pe.children[0].style.transform="rotate(180deg)"):(pe.children[0].style.transform="",Re.style.maxHeight="",Re.style.margin="",Xe.start(),B=!0))}kn(pe,N),Qe.firefox&&(Re.style.paddingRight="16px");let H=null;const X=new Map;function ve(ne,ue,Ue){const et=document.createElement("span");if(et.classList.add("ext-meeting-who-list-name"),ne){const ot=document.createElement("span");ot.innerText=ue;const Tt=document.createElement("span");lo(Tt,` (${wt("meetings.me")})`),et.appendChild(ot),et.appendChild(Tt)}else et.innerText=ue;return et.style.color=Ue,et}function we(ne){const ue=document.createElement("span");return ue.classList.add("ext-meeting-who-list-mic-indicator"),ne?ue.classList.add("fa-microphone"):ue.classList.add("fa-microphone-slash"),ue}function ze(){const ne=document.createElement("span");return ne.classList.add("ext-meeting-who-list-mic-indicator"),ne.classList.add("fa-file-audio-o"),ne}function Le(ne){console.assert(ne.volumeVisualizer!==null,"volumeVisualizer not initialized");const ue=document.createElement("span");return ne.isSoundMeasurementActive()?ue.innerHTML=ne.volumeVisualizer.getHTML():ue.innerHTML=ne.volumeVisualizer.getEmptyHTML(),ue}function _e(){const ne=document.createElement("li");ne.classList.add("ext-meeting-who-list-entry"),ne.appendChild(Le(k)),ne.appendChild(ve(!0,k.displayName,k.color));const ue=g(k.micTrack);return ne.appendChild(we(ue)),k.audioTrack&&ne.appendChild(ze()),ne}function Ge(ne){const ue=document.createElement("li");ue.classList.add("ext-meeting-who-list-entry"),ue.appendChild(Le(ne));const Ue=ve(!1,ne.displayName,ne.color);Ue.style.cursor="pointer",ue.appendChild(Ue);const et=ne.micTrack&&ne.micTrack.isEnabled;return ue.appendChild(we(et)),ne.audioTrack&&ue.appendChild(ze()),kn(Ue,ne.seeAvatar.bind(ne)),ue}this.onDominantSpeakerChanged=function(ne){if(H&&ne!==H&&(H=null),je.isRunning()||ne===null)return;const ue=X.get(ne);ue?(ue.scrollIntoView({behavior:"smooth",block:"nearest"}),he.start()):H=ne},this.update=function(ne){X.clear(),Ze.removeChildren(Re),Re.appendChild(_e());for(const ue of Object.values(ne))if(ue.hasDisplayName){const Ue=Ge(ue);Re.appendChild(Ue),X.set(ue,Ue)}H&&X.has(H)&&(this.onDominantSpeakerChanged(H),H=null)},this.show=function(){Ze.show(ye)},this.hide=function(){Ze.hide(ye)},this.update([]),this.show()}function O(k){return`
      <div>
        <textarea id="ext-meeting-note-text"
          class="ext-meeeting-note-edit"
          placeholder="${k}"></textarea>
      </div>
      <button id="ext-meeting-note-publish"
        class="ext-meeting-button ext-meeting-dialog-buttons">
        Publish
      </button>
    `}function U(k,K){const de="extMtg:"+k+":"+K+":";function ce(Te){let pe=de;return Te.location!==null&&(pe+=":"+Te.location.join(":")),pe}this.getTimeStampOfLastReadNoteAtLocation=function(Te){return localStorage.getItem(ce(Te))||-1},this.isNoteRead=function(Te){return Te.ts<=this.getTimeStampOfLastReadNoteAtLocation(Te)||Te.author===K},this.markAllNotesAtLocationAsRead=function(Te){localStorage.setItem(ce(Te),Te.ts)}}function z(k,K,de,ce,Te,pe){const ye="MeetingNotes",Re=[];let he=[],je=!1;const Xe=new Ze.UiPopup(`
      <h2>
        Click a place to leave a note there.
      </h2>`);Xe.position=Ze.UiPopup.TOP;const B=new Ze.UiPopup(O("Type your note"));B.position=Ze.UiPopup.TOP;let N,H=null,X=null;function ve(Ue){if(Ue===K.displayName)return K.color;for(const et of Object.values(de))if(et.displayName===Ue)return et.color;return"#ffffff"}function we(){je=!1,ce.show(),i.style.cursor="default",Xe.dismiss(),B.close()}function ze(){je=!0,ce.hide(),i.style.cursor="pointer",H&&H.close(),k.onNodeTypeClicked(N),Xe.onDismiss=()=>{k.removeOnNodeTypeClicked(N),we()},Xe.open()}function Le(Ue,et){return Ue===null||et===null?!1:Sr(Ue,et)}Pi("ext-meeting-add-note",ze);const _e=new F;N=function(Ue,et,ot){i.style.cursor="default",_e.copyFrom(et),cu(_e,k.getCameraPosition(),s),k.removeOnNodeTypeClicked(N);const Tt=k.addAnchor(h(_e.x,_e.y,_e.z));return Tt.material.highlight=t,Tt.material.setUniforms(),Tt.material.highlightMix=.7,Xe.close(),B.onClose=()=>{k.removeAnchor(Tt),we()},B.open(),Pi("ext-meeting-note-publish",()=>{const ct=document.getElementById("ext-meeting-note-text"),L=ct.value.trim();if(!L){Ze.highlightInput(ct);return}pe(L,[_e.x,_e.y,_e.z])}),!0};function Ge(Ue){return he.filter(et=>Le(et.location,Ue.location))}function ne(Ue,et){let ot;function Tt(Fe,xt){if(je)return;ot.classList.remove("ext-meeting-note-list-unread"),ot.classList.add("ext-meeting-note-list-selected"),xt&&ot.scrollIntoView(),Fe.material.highlightMix=.7,k.requestFrame();let Ut="";const pt=new Map,Ri=Te.getTimeStampOfLastReadNoteAtLocation(Ue);let mi=null;for(const vt of Ge(Ue)){const R="ext-meeting-note-text"+vt.id,G="ext-meeting-note-author"+vt.id;let q="ext-meeting-note-entry";vt.ts>Ri&&vt.author!==K.displayName&&(q+=" ext-meeting-note-unread"),Ut+=`<div class="${q}">
               <strong id="${G}"
                   style="color: ${ve(vt.author)}">
               </strong> <span>${l(vt.ts)}</span>
               <div id="${R}">
               </div>
             </div>`,pt.set(R,vt.text),pt.set(G,vt.author),mi=vt}const si=Ut+O("Type your response");H?H.update(si):(H=new Ze.UiPopup(si),H.position=Ze.UiPopup.TOP,H.onClose=()=>{ot.classList.remove("ext-meeting-note-list-selected"),Fe.material.highlightMix=0,k.requestFrame(),H=null}),Te.markAllNotesAtLocationAsRead(mi),X=Ue.location,H.open(),pt.forEach((vt,R)=>{document.getElementById(R).innerText=vt}),Pi("ext-meeting-note-publish",()=>{const vt=document.getElementById("ext-meeting-note-text"),R=vt.value.trim();if(!R){Ze.highlightInput(vt);return}const G=Fe.position;pe(R,[G.x,G.y,G.z]),vt.value=""})}const ct=k.addAnchor(h(Ue.location[0],Ue.location[1],Ue.location[2]),Fe=>Tt(Fe,!0));ct.material.highlight=t,ct.material.setUniforms(),Re.push(ct);const L=Ue,te=L.author;ot=c(te,l(L.ts),ve(te),()=>{k.seeItem(ct),Tt(ct,!1)}),Te.isNoteRead(Ue)||ot.classList.add("ext-meeting-note-list-unread"),et.appendChild(ot),H!==null&&Sr(X,Ue.location)&&Tt(ct,!0)}function ue(Ue,et){console.assert(Ue===ye),he=et.sort((ct,L)=>{const te=Te.isNoteRead(ct),Fe=Te.isNoteRead(L);return te!==Fe?te?-1:1:ct.ts-L.ts}),we();for(const ct of Re)k.removeAnchor(ct);Re.length=0;const ot=document.getElementById("ext-meeting-note-list");Ze.removeChildren(ot);const Tt=new Map;for(let ct=he.length-1;ct>=0;ct--){const L=he[ct];if(L.location!==null){const te=L.location.join("/");Tt.has(te)||(Tt.set(te,ct),ne(L,ot),ot.lastChild.scrollIntoView())}}}k.onApiUserStateChanged(ye,ue)}function ie(k,K){const de=this;let ce=null,Te=null;const pe=new Ze.UiPopup(`
      <h2 data-strings="meetings.pointPlace">
      </h2>`);pe.position=Ze.UiPopup.TOP;const ye=k._createPointerEventHelper(0);ye.disable(),this.pointerX=null,this.pointerY=null,this.pointerZ=null,this.isEnabled=function(){return ye.isEnabled()},this.showPointer=function(){return this.pointerX!==null};function Re(){return ce!==null}k.onBeforeRender(()=>{if(!Re())return;const Xe=k._findIntersectionAtPosition(ce,Te);Xe.distance!==1/0&&(this.pointerX=Xe.point.x,this.pointerY=Xe.point.y,this.pointerZ=Xe.point.z)});function he(){ce=null,Te=null,de.pointerX=null,de.pointerY=null,de.pointerZ=null,k._enableControls()}ye.callbacks.onPointerDown=function(Xe,B){return ce=Xe,Te=B,k._disableControls(),k.requestFrame(),!0},ye.callbacks.onPointerMove=function(Xe,B){return Re()?(ce=Xe,Te=B,k.requestFrame(),!0):!1},ye.callbacks.onPointerUp=function(){return he(),k.requestFrame(),!0};function je(){de.isEnabled()?(i.style.cursor="default",he(),ye.disable(),pe.close(),K.show()):(i.style.cursor="pointer",pe.open(),ye.enable(),pe.onDismiss=je,K.hide())}Pi("ext-meeting-pointer",function(){je()})}function J(){const k=[0,0,0,0,0],K=[0,0,0,0,0,0,0,0];let de=null,ce=!1;this.newUpdateWithPointer=function(){ce=!1,de!==K&&(ce=!0,de=K)},this.newUpdateNoPointer=function(){ce=!1,de!==k&&(ce=!0,de=k)},this.set=function(Te,pe){de[Te]!==pe&&(de[Te]=pe,ce=!0)},this.getFilledArray=function(){return ce?de:null}}function re(){const k=document.getElementById("ext-meeting-mic-toggle"),K=document.getElementById("ext-meeting-camera-toggle"),de=document.getElementById("ext-meeting-camera-preview");gl(de);let ce=null;this.showCameraPreview=!0;function Te(ye){Ze.setVisibility(ye.children[0],!0),Ze.setVisibility(ye.children[1],!1)}function pe(ye){Ze.setVisibility(ye.children[0],!1),Ze.setVisibility(ye.children[1],!0)}this.refreshMicControls=function(ye){g(ye)?(Ze.setButtonHighlight(k,!1),Te(k)):(Ze.setButtonHighlight(k,!0),pe(k))},this.refreshCameraControls=function(ye){let Re=!1;g(ye)?(ce||(ce=ye.attach(),de.appendChild(ce)),Re=this.showCameraPreview,Ze.setButtonHighlight(K,!1),Te(K)):(ce&&(ye.detach(),ce.remove(),ce=null),Ze.setButtonHighlight(K,!0),pe(K)),Re?Ze.show(de):Ze.hide(de)},this.setToggleButtonHandlers=function(ye,Re){kn(k,ye),kn(K,Re)}}function Oe(k,K,de,ce){function Te(q){Gt.info("Failed to acquire media.<br/>"+q.message,6e3)}const pe=Ui(),ye=new J,Re=new C;this.myUuid=ce.uuid;const he=new x(pe,this.myUuid,k,Re,K,de),je={},Xe=new I(he),B=new re,N=ce.id,H=ce.meetingKey;let X=ce.avToken,ve,we,ze;function Le(){he.dispose(),we.dispose(),ve.dispose();for(const q of Object.values(je))q.dispose();Re.dispose()}function _e(q){try{const $=JSON.parse(atob(q.split(".")[1]));return $.exp?$.exp*1e3:null}catch($){return null}}function Ge(){return new Promise((q,$)=>{const xe=_e(X);if(xe&&Date.now()+Uy/2<xe){q();return}Pr(a()+"/meetings/"+N+"/av-token",{meetingKey:H,token:ce.token},Ne=>{Ne&&Ne.avToken?(X=Ne.avToken,Me.log("AV token refreshed"),q()):(Me.log("Failed to refresh AV token: no token in response"),$())},()=>{Me.log("Failed to refresh AV token"),$()})})}function ne(q,$){Le(),document.body.innerHTML='<div id="cover-image"></div>',d(q,$,$?()=>location.reload():void 0)}function ue(q){ne(`${wt("meetings.connectionLost")}</br>(${wt("meetings.code")}: ${q}).`,wt("meetings.joinAgain"))}function Ue(){ne(wt("meetings.meetingEnded"))}function et(){he.toggleMic()}function ot(){he.toggleCamera()}B.setToggleButtonHandlers(et,ot),he.setAvTracksStateHandlers(function(q){B.refreshMicControls(q),Xe.update(je)},function(q){B.refreshCameraControls(q)}),B.refreshMicControls(he.micTrack),B.refreshCameraControls(he.cameraTrack);function Tt(q,$){Pr(a()+"/meetings/"+N+"/notes",{meetingKey:H,author:k,text:q,location:$},()=>Me.log("Note added."),()=>Me.log("Failed to add note"))}const ct=new ie(pe,Xe);M.urlHashContains("meeting-notes")&&(Ze.show(document.getElementById("ext-meeting-notes-preview")),z(pe,he,je,Xe,new U(N,k),Tt));function L(q){Xe.update(je)}function te(q){let $=je[q];return $||($=new v(pe,q,Re,L),je[q]=$),$}function Fe(q){te(q),we.isConnectingOrConnected()||Ge().finally(()=>{we.isConnectingOrConnected()||we.connect(X)})}function xt(q){q in je&&(je[q].dispose(),delete je[q],Xe.update(je),we.isConnectingOrConnected()&&Object.keys(je).length===0&&we.disconnect())}function Ut(q,$){te(q).connectedToTwilio($)}function pt(q,$){xt(q)}function Ri(q){const $=q in je?je[q]:null;Xe.onDominantSpeakerChanged($)}function mi(q){ze=q;for(const $ of Object.keys(q))pe.apiUserChangeState($,q[$])}ce.sceneState!==null&&mi(ce.sceneState),ve=new E(he,ce,Fe,xt,mi,ue);const si=new By;we=new w(he,ce.channel,Ut,pt,Te,ue,Ue,si.onConnect.bind(si),si.onDisconnect.bind(si),Ri),Pi("ext-meeting-leave",()=>{d(wt("meetings.doYouWantToLeaveMeeting"),wt("meetings.leaveMeeting"),()=>{ne(wt("meetings.youHaveLeftMeeting"),wt("meetings.joinAgain"))},!0)});function vt(q){ct.showPointer()?(ye.newUpdateWithPointer(),ye.set(5,Ln(ct.pointerX,3)),ye.set(6,Ln(ct.pointerY,3)),ye.set(7,Ln(ct.pointerZ,3))):ye.newUpdateNoPointer();const $=pe.getCameraPosition(),xe=pe.getCameraRotation();ye.set(0,Ln($.x,3)),ye.set(1,Ln($.y,3)),ye.set(2,Ln($.z,3)),ye.set(3,Ln(xe.yaw,1)),ye.set(4,Ln(xe.pitch,1));const Ne=ye.getFilledArray();Ne&&he.updatePosition(Ne)}function R(q,$){ze&&Sr($,ze[q])||Pr(a()+"/meetings/"+N+"/scene-state",{meetingKey:H,key:q,state:$},()=>Me.log("State updated."),()=>Me.log("Failed to update state."))}function G(){ne(wt("meetings.meetingEndedMaximumDurationReached"))}pe.onBeforeRender(vt),vt(),pe.onApiUserStateChanged(R),this.startShareScreen=function(q,$,xe){Me.log("Screen share start requested"),he.startShareScreen(q,$,xe,()=>Xe.update(je))},this.stopShareScreen=function(){Me.log("Screen share stop requested"),he.stopShareScreen()},this.setCameraPreviewVisibility=function(q){B.showCameraPreview=q,B.refreshCameraControls(he.cameraTrack)},ce.remainingTimeSeconds!==null&&setTimeout(G,(ce.remainingTimeSeconds+5)*1e3)}function We(k){const K=(ce,Te,pe)=>{const ye=new Oe(ce,Te,pe,k);Ui()._meetingJoined(ye)};new Wm(K,k.avToken).show()}function Ve(k,K){const de=(pe,ye)=>{fetch(pe+ye.model).then(Re=>Re.text()).then(Re=>{const he=yy(Re);jg(pe,ye,he),K()}).catch(()=>Gt.error(wt("meetings.failedToLoadMeeting")))},ce=()=>{k=ii("3dassets/avatar.json")},Te=pe=>Dt(this,null,function*(){if(pe===void 0)return;const ye=pe.split("/").slice(0,-1).join("/")+"/";try{const he=yield(yield fetch(pe)).json();return de(ye,he),!0}catch(Re){return!1}});Ui().onSceneLoadComplete(()=>Dt(this,null,function*(){(yield Te(k))||(ce(),M.AVATAR_JSON_URL_OVERRIDE&&(k=M.AVATAR_JSON_URL_OVERRIDE),yield Te(k))||Gt.error(wt("meetings.failedToLoadMeeting"))}))}function lt(){const k=M.urlHashGetArgument("meeting"),K=M.urlHashGetArgument("meeting-key"),de=M.urlHashGetArgument("av-mode"),ce={url:o()};k&&(ce.meetingName=k),K&&(ce.meetingKey=K),de&&(ce.avMode=de),n&&(ce.avRegion=n),Pr(a()+"/meetings/join",ce,Te=>Ve(Te.avatarJsonUrl,()=>We(Te)),(Te,pe)=>{pe!==void 0?Gt.error(pe):Gt.error(wt("meetings.failedToJoinMeeting"))})}l0([ii("lib/pubnub.min.js"),ii("lib/twilio-video.min.js")],lt,()=>Gt.error("Cannot load required library")),um()}gy(),Ui()._isMeeting()&&Ny(),window.addEventListener("load",function(){return Dt(this,null,function*(){if(yield h0(),Nb())return;const s=new Hm;dm(s)})})})();
